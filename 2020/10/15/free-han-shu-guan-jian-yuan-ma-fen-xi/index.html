<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="free函数关键源码分析, Matrix">
    <meta name="description" content="因为free源代码和malloc源码都是在malloc.c定义的，所以用到的宏几乎差不多这里就不列出来了，详情见上一篇文章：malloc关键源码分析
__libc_free同malloc一样我们使用的free函数也是封装过的
void
__">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>free函数关键源码分析 | Matrix</title>
    <link rel="icon" type="image/jpeg" href="/medias/matrix.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/matrix.jpg" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">Matrix</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/matrix.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Matrix</div>
        <div class="logo-desc">
            
            Fight Against Your Fate!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/19.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        free函数关键源码分析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                                <span class="chip bg-color">原理学习</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                CTF-PWN
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-10-15
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        10 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><strong>因为free源代码和malloc源码都是在malloc.c定义的，所以用到的宏几乎差不多这里就不列出来了，详情见上一篇文章：malloc关键源码分析</strong></p>
<h2 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>同malloc一样我们使用的free函数也是封装过的</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  mchunkptr p<span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">/* chunk corresponding to mem */</span>

  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//检查钩子函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//free(0) 直接退出函数                        </span><span class="token comment" spellcheck="true">/* free(0) has no effect */</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//转换为对应chunk指针</span>
  <span class="token comment" spellcheck="true">/*如果该chunk是mmaped，那么将会使用munmap(p)方案*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment" spellcheck="true">/* release mmapped memory. */</span>
    <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/* see if the dynamic brk/mmap threshold needs adjusting */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mp_<span class="token punctuation">.</span>no_dyn_threshold
          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">></span> mp_<span class="token punctuation">.</span>mmap_threshold
          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">&lt;=</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          mp_<span class="token punctuation">.</span>mmap_threshold <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mp_<span class="token punctuation">.</span>trim_threshold <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">;</span>
          <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_mallopt_free_dyn_thresholds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
                      mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//释放</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>如果不是mmaped_chunk则：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  mchunkptr p<span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">/* chunk corresponding to mem */</span>

  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//检查钩子函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">//free(0) 直接退出函数                        </span><span class="token comment" spellcheck="true">/* free(0) has no effect */</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//转换为对应chunk指针</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment" spellcheck="true">/* release mmapped memory. */</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

  ar_ptr <span class="token operator">=</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//获取对应arena指针</span>
  <span class="token function">_int_free</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//执行真正的释放函数</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>所以libc_free 检查了：</strong></p>
<ul>
<li>钩子函数</li>
<li>mmaped</li>
</ul>
<h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><h3 id="数据声明"><a href="#数据声明" class="headerlink" title="数据声明"></a>数据声明</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_int_free</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    INTERNAL_SIZE_T size<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* its size */</span>
    mfastbinptr <span class="token operator">*</span>   fb<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* associated fastbin */</span>
    mchunkptr       nextchunk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* next contiguous chunk */</span>
    INTERNAL_SIZE_T nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* its size */</span>
    <span class="token keyword">int</span>             nextinuse<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* true if nextchunk is used */</span>
    INTERNAL_SIZE_T prevsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* size of previous contiguous chunk */</span>
    mchunkptr       bck<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* misc temp for linking */</span>
    mchunkptr       fwd<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* misc temp for linking */</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>         locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//获取chunk p的size</span></code></pre>
<h3 id="检查chunk是否合理"><a href="#检查chunk是否合理" class="headerlink" title="检查chunk是否合理"></a>检查chunk是否合理</h3><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/* Little security check which won't hurt performance: the
     allocator never wrapps around at the end of the address space.
     Therefore we can exclude some size values which might appear
     here by accident or by "design" from some intruder.  */</span>
     <span class="token comment" spellcheck="true">/*typedef unsigned long int    uintptr_t;适配*/</span>
  <span class="token comment" spellcheck="true">/*1：p指向合法。2：p的大小对齐*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> p <span class="token operator">></span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> <span class="token operator">-</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">misaligned_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//-size进行unsigned long int强制转换后是一个0xffff开头的数，如在64位下-0x90=====>0xffffffffffffff70</span>
    <span class="token punctuation">{</span>                                                  <span class="token comment" spellcheck="true">//0x602000这是其chunk的地址</span>
      errstr <span class="token operator">=</span> <span class="token string">"free(): invalid pointer"</span><span class="token punctuation">;</span>
    errout<span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock <span class="token operator">&amp;&amp;</span> locked<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">/* We know that each chunk is at least MINSIZE bytes in size or a
     multiple of MALLOC_ALIGNMENT.  */</span>
     <span class="token comment" spellcheck="true">/*1：其size至少大于最小size 2：对齐*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MINSIZE <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      errstr <span class="token operator">=</span> <span class="token string">"free(): invalid size"</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>p指向地址合法</li>
<li>size对齐且大于MINSIZE </li>
</ul>
<h3 id="看是否可以放入fastbins"><a href="#看是否可以放入fastbins" class="headerlink" title="看是否可以放入fastbins"></a>看是否可以放入fastbins</h3><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*
    If eligible, place chunk on a fastbin so it can be found
    and used quickly in malloc.
  */</span>
   <span class="token comment" spellcheck="true">/*如果size小于等于最大fastbins，则可以进行下面的操作*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//默认 #define TRIM_FASTBINS 0，因此默认情况下下面的语句不会执行</span>
<span class="token macro property">#<span class="token directive keyword">if</span> TRIM_FASTBINS</span>
      <span class="token comment" spellcheck="true">/*
    If TRIM_FASTBINS set, don't place chunks
    bordering top into fastbins
      */</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre>
<h3 id="放入fastbins"><a href="#放入fastbins" class="headerlink" title="放入fastbins"></a>放入fastbins</h3><h4 id="物理相邻下一个chunk进行大小检查"><a href="#物理相邻下一个chunk进行大小检查" class="headerlink" title="物理相邻下一个chunk进行大小检查"></a>物理相邻下一个chunk进行大小检查</h4><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*1：物理相邻下一个chunk不能过小，小于等于2 * SIZE_SZ 2：以及不能过大，大于system_mem*/</span>  <span class="token comment" spellcheck="true">//否则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* We might not have a lock at this point and concurrent modifications
       of system_mem might have let to a false positive.  Redo the test
       after getting the lock.  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock
        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">assert</span> <span class="token punctuation">(</span>locked <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ
            <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (fast)"</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></code></pre>
<p>检查：</p>
<ul>
<li>物理相邻下一个chunk &gt;= MINSIZE  ,且 &lt;= av-&gt;system_mem</li>
</ul>
<h4 id="插入对应链表"><a href="#插入对应链表" class="headerlink" title="插入对应链表"></a>插入对应链表</h4><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*调用perturb_byte来将data区的数据覆盖，但得看perturb_byte，一般是0，也就是不会进行memest*/</span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment" spellcheck="true">/*
    static int perturb_byte;
    ....
    ...
    static void
    free_perturb (char *p, size_t n)
    {
      if (__glibc_unlikely (perturb_byte))
        memset (p, perturb_byte, n);
    }
*/</span>

    <span class="token function">set_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*mfastbinptr *fb 是一个二级指针*/</span>
    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取对应下标表头地址</span>

    <span class="token comment" spellcheck="true">/* Atomically link P to its fastbin: P->FD = *FB; *FB = P;  */</span>
    <span class="token comment" spellcheck="true">/*P->FD = *FB; *FB = P看这里就行下面两句看不懂 这里链接仅仅用了fd字段*/</span>
    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> old_idx <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
      <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* Check that the top of the bin is not the record we are going to add
       (i.e., double free).  */</span>
    <span class="token comment" spellcheck="true">/*原来表头fd所放的就是old，这里是防止连续两次free同一个chunk*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (fasttop)"</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/* Check that size of fastbin chunk at the top is the same as
       size of the chunk that we are adding.  We can dereference OLD
       only if we have the lock, otherwise it might have already been
       deallocated.  See use of OLD_IDX below for the actual check.  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
      old_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-></span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
    errstr <span class="token operator">=</span> <span class="token string">"invalid fastbin entry (free)"</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>要点：</p>
<ul>
<li>插入链表时，仅用fd构成单向链表</li>
<li>检查最新插入的chunk与old_chunk是不是同一个</li>
</ul>
<h3 id="不能放入fastbins就进行合并操作"><a href="#不能放入fastbins就进行合并操作" class="headerlink" title="不能放入fastbins就进行合并操作"></a>不能放入fastbins就进行合并操作</h3><h4 id="如果是mmaped-chunk"><a href="#如果是mmaped-chunk" class="headerlink" title="如果是mmaped chunk"></a>如果是mmaped chunk</h4><pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*
    Consolidate other non-mmapped chunks as they arrive 不能放入fastbins就进行合并操作.
  */</span>

  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment" spellcheck="true">/*
    If the chunk was allocated via mmap, release via munmap().
  */</span>

  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//直接用munmap 释放</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    </code></pre>
<h4 id="常规chunk，进行合并"><a href="#常规chunk，进行合并" class="headerlink" title="常规chunk，进行合并"></a>常规chunk，进行合并</h4><pre class=" language-c"><code class="language-c">    nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取p 物理相邻下一个chunk地址</span>

    <span class="token comment" spellcheck="true">/* Lightweight tests: check whether the block is already the
       top block. 轻量级检查是不是top chunk */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
            errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (top)"</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/* Or whether the next chunk is beyond the boundaries of the arena.  nextchunk不能超过arena区域*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span>
              <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> nextchunk
              <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> av<span class="token operator">-></span>top <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//这里通过top计算出了heap的最高地址</span>
      <span class="token punctuation">{</span>
    errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (out)"</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/* Or whether the block is actually not marked used. 检查nextchunk的inuse位 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
    errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (!prev)"</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    nextsize <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment" spellcheck="true">/*1：下一个chunksize要大于2*SIZE_SZ 2：但不能大于av->system_mem*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextchunk<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextsize <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (normal)"</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/*数据清理，但一般不会执行*/</span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* consolidate backward 低地址合并 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prevsize <span class="token operator">=</span> p<span class="token operator">-></span>prev_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//物理相邻前一个chunk 大小</span>
      size <span class="token operator">+</span><span class="token operator">=</span> prevsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//计算合并后的总size</span>
      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//更新chunk 指针为低地址chunk的指针</span>
      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//对低地址chunk执行unlink</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/*下一个chunk不是top*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/* get and clear inuse bit */</span>
      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取nextchunk的物理相邻下一个chunk的inuse位</span>

      <span class="token comment" spellcheck="true">/* consolidate forward 如果nextchunk也是freed 进行向后合并，注意这里没更新指针p*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//对nextchunk进行unlink</span>
    size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//更新size</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token comment" spellcheck="true">/*否则：*/</span>
            <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将nextchun的inuse位置零</span>

      <span class="token comment" spellcheck="true">/*
    Place the chunk in unsorted chunk list. Chunks are
    not placed into regular bins until after they have
    been given one chance to be used in malloc.
    处理完后，被放入unsortedbin
      */</span>

      bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>
      fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取unsortedbin的第一个chunk</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>
      errstr <span class="token operator">=</span> <span class="token string">"free(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/*进行插入操作，插入作为第一个chunk*/</span>
      p<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  
      p<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 如果是 large chunk，那就设置nextsize指针字段为NULL。</span>
    <span class="token punctuation">{</span>
      p<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      p<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      bck<span class="token operator">-></span>fd <span class="token operator">=</span> p<span class="token punctuation">;</span>
      fwd<span class="token operator">-></span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*设置head，以及foot信息*/</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">check_free_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
      If the chunk borders the current high end of memory,
      consolidate into top
    */</span>
    <span class="token comment" spellcheck="true">/*如果nextchunk是top则直接与top合并*/</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//设置inuse位</span>
      av<span class="token operator">-></span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//p视为新top</span>
      <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
      If freeing a large space, consolidate possibly-surrounding
      chunks. Then, if the total unused topmost memory exceeds trim
      threshold, ask malloc_trim to reduce top.

      Unless max_fast is 0, we don't know if there are fastbins
      bordering top, so we cannot tell for sure whether threshold
      has been reached unless fastbins are consolidated.  But we
      don't want to consolidate on each free.  As a compromise,
      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD
      is reached.
    */</span>
    <span class="token comment" spellcheck="true">/*当合并后的size大于FASTBIN_CONSOLIDATION_THRESHOLD，就会将heap向系统返还*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 如果有 fast chunk 就进行合并</span>
            <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MORECORE_CANNOT_TRIM</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span>
        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// top chunk 大于当前的收缩阙值</span>
        <span class="token function">systrim</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* Always try heap_trim(), even if the top chunk is not
       large, because the corresponding heap might go away.  */</span>
    heap_info <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token function">heap_for_ptr</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>ar_ptr <span class="token operator">==</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">heap_trim</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>要点：</p>
<ul>
<li>nextchunk不能超过arena区域</li>
<li>检查nextchunk的inuse位</li>
<li>nextchunk要大于2*SIZE_SZ 2：但不能大于av-&gt;system_mem</li>
<li>低地址合并</li>
<li>高地址合并(nextchunk不是top)</li>
<li>nextchunk是top直接与top合并</li>
<li>合并后插入unsortedbin</li>
<li>并设置head  foot</li>
<li>如果合并后size大于FASTBIN_CONSOLIDATION_THRESHOLD则返还系统</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>__libc_free<ul>
<li>检查hook，mmaped</li>
</ul>
</li>
<li>_int_free<ul>
<li>物理相邻下一个chunk &gt;= MINSIZE  ,且 &lt;= av-&gt;system_mem  ，那么插入fastbins<ul>
<li>插入链表时，仅用fd构成单向链表</li>
<li>检查最新插入的chunk与old_chunk是不是同一个</li>
</ul>
</li>
<li>不能放入fastbins，就合并<ul>
<li>检查nextchunk</li>
<li>低地址合并，高地址合并</li>
<li>插入unsortedbin</li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/1.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/2.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://squarepants0.github.io" class="b-link-green">Matrix</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2020/10/15/free-han-shu-guan-jian-yuan-ma-fen-xi/" class="b-link-green">free函数关键源码分析</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'aa0bf75cc88de6c0258a',
        clientSecret: '8ddc9bf71af314ac63d189a5ecb132fac7c0687d',
        repo: 'Gitalks.github.io',
        owner: 'squarepants0',
        admin: "squarepants0",
        id: '2020-10-15T09-27-56',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/10/18/unlink-li-yong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Unlink利用">
                        
                        <span class="card-title">Unlink利用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">Unlink源码/* Take a chunk off a bin list. Unlink操作 They are all free chunk*/
/*
1：检查两个记录chunk p size的字段是否相等
2：检查fd，bk是否回指c</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-10-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/10/13/malloc-guan-jian-yuan-ma-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="malloc关键源码分析">
                        
                        <span class="card-title">malloc关键源码分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">常用的宏定义关于程序移植性所定义的固定大小#define INTERNAL_SIZE_T size_t  为4或8
#define SIZE_SZ (sizeof(INTERNAL_SIZE_T)）4或8
#define MALLOC_AL</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-10-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('10')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Matrix<br />'
            + '作者: IT YUAN<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者Matrix所有，任何形式的转载都请注明出处：https://squarepants0.github.io/。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">103.9k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/fireworks.js"></script>

</body>
</html>