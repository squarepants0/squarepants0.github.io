<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="malloc关键源码分析, Squarer">
    <meta name="description" content="常用的宏定义关于程序移植性所定义的固定大小#define INTERNAL_SIZE_T size_t  为4或8
#define SIZE_SZ (sizeof(INTERNAL_SIZE_T)）4或8
#define MALLOC_AL">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>malloc关键源码分析 | Squarer</title>
    <link rel="icon" type="image/jpeg" href="/medias/matrix.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/matrix.jpg" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">Squarer</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/matrix.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Squarer</div>
        <div class="logo-desc">
            
            Fight Against Your Fate!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        malloc关键源码分析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                                <span class="chip bg-color">原理学习</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                CTF-PWN
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-10-13
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        9.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        45 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="常用的宏定义"><a href="#常用的宏定义" class="headerlink" title="常用的宏定义"></a>常用的宏定义</h2><h3 id="关于程序移植性所定义的固定大小"><a href="#关于程序移植性所定义的固定大小" class="headerlink" title="关于程序移植性所定义的固定大小"></a>关于程序移植性所定义的固定大小</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> INTERNAL_SIZE_T size_t  为4或8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SIZE_SZ (sizeof(INTERNAL_SIZE_T)）4或8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MALLOC_ALIGNMENT (2 * SIZE_SZ)  8或16</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)  7或15</span></code></pre>
<h3 id="关于fastbins"><a href="#关于fastbins" class="headerlink" title="关于fastbins"></a>关于fastbins</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> M_MXFAST</span>
<span class="token macro property">#<span class="token directive keyword">define</span> M_MXFAST            1</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> DEFAULT_MXFAST</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DEFAULT_MXFAST     (64 * SIZE_SZ / 4) </span><span class="token comment" spellcheck="true">//64位下为 64*8/4 == 0x80 即最大fastbin chunk</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span></code></pre>
<h3 id="关于指针转换"><a href="#关于指针转换" class="headerlink" title="关于指针转换"></a>关于指针转换</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* conversion from malloc headers to user pointers, and back */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))  </span><span class="token comment" spellcheck="true">//由mchunkptr转换为memptr </span>
<span class="token macro property">#<span class="token directive keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))   </span><span class="token comment" spellcheck="true">//由memptr转换为mchunkptr</span></code></pre>
<h3 id="关于最小chunk"><a href="#关于最小chunk" class="headerlink" title="关于最小chunk"></a>关于最小chunk</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* The smallest possible chunk 可以存在最小chunk*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>offsetof宏：获取结构体中某个元素的偏移<span class="token punctuation">,</span>此处fd_nextsize的偏移为：<span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunk_prev_size<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunk_size<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>bk<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x20</span>  <span class="token number">64</span>位
<span class="token comment" spellcheck="true">/* The smallest size we can malloc is an aligned minimal chunk 使用malloc能分配的最小chunk*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MINSIZE  \
  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))  </span><span class="token comment" spellcheck="true">//0x20+0xf &amp; ~0xf == 0x20   64位</span></code></pre>
<h3 id="关于chunk大小检查"><a href="#关于chunk大小检查" class="headerlink" title="关于chunk大小检查"></a>关于chunk大小检查</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Same, except also perform an argument and result check.  First, we check
   that the padding done by request2size didn't result in an integer
   overflow.  Then we check (using REQUEST_OUT_OF_RANGE) that the resulting
   size isn't so large that a later alignment would lead to another integer
   overflow. 赋值后确保对齐后的大小没有越界，过大 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> checked_request2size(req, sz) \
({                                    \
  (sz) = request2size (req);            \
  if (((sz) &lt; (req))                    \
      || REQUEST_OUT_OF_RANGE (sz)) \
    {                                    \
      __set_errno (ENOMEM);            \
      return 0;                            \
    }                                    \
})</span></code></pre>
<h3 id="关于对齐操作"><a href="#关于对齐操作" class="headerlink" title="关于对齐操作"></a>关于对齐操作</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Check if m has acceptable alignment 检查空间是否对齐*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)  </span><span class="token comment" spellcheck="true">//对空间大小检查是不是16字节对齐，是则返回1</span>
<span class="token comment" spellcheck="true">/*请求字节数判断*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> misaligned_chunk(p) \
  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \
   &amp; MALLOC_ALIGN_MASK)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \
  ((unsigned long) (req) >=                                                      \
   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span>

<span class="token comment" spellcheck="true">/* pad request bytes into a usable size -- internal version 如果申请的req大小如果太小就返回MINSIZE，否则就将用户请求内存大小转为实际分配内存大小*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> request2size(req)                                         \
  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \
   MINSIZE :                                                      \
   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></code></pre>
<h3 id="关于对实际chunk的操作"><a href="#关于对实际chunk的操作" class="headerlink" title="关于对实际chunk的操作"></a>关于对实际chunk的操作</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
   --------------- Physical chunk operations ---------------
 */</span>
<span class="token comment" spellcheck="true">/* size field is or'ed with PREV_INUSE when previous adjacent chunk in use */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PREV_INUSE 0x1</span>

<span class="token comment" spellcheck="true">/* extract inuse bit of previous chunk 获取PREV_INUSE位*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> prev_inuse(p)       ((p)->mchunk_size &amp; PREV_INUSE)</span>

<span class="token comment" spellcheck="true">/* size field is or'ed with IS_MMAPPED if the chunk was obtained with mmap() */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> IS_MMAPPED 0x2</span>

<span class="token comment" spellcheck="true">/* check for mmap()'ed chunk 获取IS_MMAPPED位*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunk_is_mmapped(p) ((p)->mchunk_size &amp; IS_MMAPPED)</span>

<span class="token comment" spellcheck="true">/* size field is or'ed with NON_MAIN_ARENA if the chunk was obtained
   from a non-main arena.  This is only set immediately before handing
   the chunk to the user, if necessary.  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NON_MAIN_ARENA 0x4</span>

<span class="token comment" spellcheck="true">/* Check for chunk from main arena. 如果来自main_arena则返回值为1 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunk_main_arena(p) (((p)->mchunk_size &amp; NON_MAIN_ARENA) == 0)</span>

<span class="token comment" spellcheck="true">/* Mark a chunk as not being on the main arena. 将size的NON_MAIN_ARENA位置1 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_non_main_arena(p) ((p)->mchunk_size |= NON_MAIN_ARENA) </span>


<span class="token comment" spellcheck="true">/*
   Bits to mask off when extracting size
   Note: IS_MMAPPED is intentionally not masked off from size field in
   macros for which mmapped chunks should never be seen. This should
   cause helpful core dumps to occur if it is tried by accident by
   people extending or adapting this malloc.设置标志位 
    */</span>


<span class="token macro property">#<span class="token directive keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span>
<span class="token comment" spellcheck="true">/* Get size, ignoring use bits 获取chunk_size并将mchunk_size的后三bits置零*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span>
<span class="token comment" spellcheck="true">/* Like chunksize, but do not mask SIZE_BITS. p指向malloc_chunk  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunksize_nomask(p)         ((p)->mchunk_size)</span>

<span class="token comment" spellcheck="true">/* Ptr to next physical malloc_chunk. 本chunk的指针+自己的大小就是下一个物理相邻chunk的地址*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span>

<span class="token comment" spellcheck="true">/* Size of the chunk below P.  Only valid if !prev_inuse (P).获取benchunk p物理相邻的前一个chunk的大小 只有p的PREV_INUSE位为0才有效 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> prev_size(p) ((p)->mchunk_prev_size)</span>

<span class="token comment" spellcheck="true">/* Set the size of the chunk below P.  Only valid if !prev_inuse (P). 设置mchunk_prev_size为sz，当p的prev_inuse位是0的时候 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_prev_size(p, sz) ((p)->mchunk_prev_size = (sz))</span>

<span class="token comment" spellcheck="true">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P). 自身的chunk地址减去前一个物理相邻的free chunk大小即可获得他的地址 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span>

<span class="token comment" spellcheck="true">/* Treat space at ptr + offset as a chunk 把从p开始以s为偏移的地址当作chunk指针*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span>

<span class="token comment" spellcheck="true">/* extract p's inuse bit 为了获得当前chunk p的使用状态，提取物理相邻的下一个chunk的PREV_INUSE位*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> inuse(p)                                                              \
  ((((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size) &amp; PREV_INUSE)</span>

<span class="token comment" spellcheck="true">/* set/clear chunk as being inuse without otherwise disturbing 为了置当前chunk p的使用状态，提取并设置物理相邻的下一个chunk的PREV_INUSE位为1或0*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_inuse(p)                                                              \
  ((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size |= PREV_INUSE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> clear_inuse(p)                                                              \
  ((mchunkptr) (((char *) (p)) + chunksize (p)))->mchunk_size &amp;= ~(PREV_INUSE) </span>

<span class="token comment" spellcheck="true">/* check/set/clear inuse bits in known places 功能和上面一样只不过通过给定的偏移s来确定unkown chunk的位置*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> inuse_bit_at_offset(p, s)                                              \
  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size &amp; PREV_INUSE)  </span><span class="token comment" spellcheck="true">//获取</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_inuse_bit_at_offset(p, s)                                              \
  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size |= PREV_INUSE)  </span><span class="token comment" spellcheck="true">//设置</span>
<span class="token macro property">#<span class="token directive keyword">define</span> clear_inuse_bit_at_offset(p, s)                                              \
  (((mchunkptr) (((char *) (p)) + (s)))->mchunk_size &amp;= ~(PREV_INUSE))  </span><span class="token comment" spellcheck="true">//设置</span>

  <span class="token comment" spellcheck="true">/* Set size at head, without disturbing its use bit 设置chunk p的size大小而不改变SIZE_BITS位*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_head_size(p, s)  ((p)->mchunk_size = (((p)->mchunk_size &amp; SIZE_BITS) | (s)))</span>

<span class="token comment" spellcheck="true">/* Set size/use field 这里直接把chunk p的mchunk_size赋值为s*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_head(p, s)       ((p)->mchunk_size = (s))</span>

<span class="token comment" spellcheck="true">/* Set size at footer (only when chunk is not in use) 根据偏移s设置prev_size为s*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))->mchunk_prev_size = (s))</span></code></pre>
<h3 id="关于mallc-state的数据结构"><a href="#关于mallc-state的数据结构" class="headerlink" title="关于mallc_state的数据结构"></a>关于mallc_state的数据结构</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
   -------------------- Internal data structures --------------------
*/</span>
<span class="token comment" spellcheck="true">/* addressing -- note that bin_at(0) does not exist 
 bin_at(m, i) 通过 bin index 获得 bin 的链表头，m 指的是分配区，i 是索引

*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> bin_at(m, i) \
  (mbinptr) (((char *) &amp;((m)->bins[((i) - 1) * 2]))                              \  </span><span class="token comment" spellcheck="true">//这个*2就说明了bins下标都是偶数</span>
             <span class="token operator">-</span> <span class="token function">offsetof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> malloc_chunk<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/* analog of ++bin 获取下一个bin的地址*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span>

<span class="token comment" spellcheck="true">/* Reminders about list directionality within bins */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> first(b)     ((b)->fd)   </span><span class="token comment" spellcheck="true">//获取 bin 的位于链表头的 chunk</span>
<span class="token macro property">#<span class="token directive keyword">define</span> last(b)      ((b)->bk)   </span><span class="token comment" spellcheck="true">//获取 bin 的位于链表尾的 chunk</span>

<span class="token macro property">#<span class="token directive keyword">define</span> NBINS             128</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NSMALLBINS         64</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT   </span><span class="token comment" spellcheck="true">//16 64位</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > 2 * SIZE_SZ)  </span><span class="token comment" spellcheck="true">//bool值为0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)    </span><span class="token comment" spellcheck="true">//(64-0)*16 == 1024</span>

<span class="token macro property">#<span class="token directive keyword">define</span> in_smallbin_range(sz)  \
  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)  </span><span class="token comment" spellcheck="true">//bool值，判断sz在smallbins中</span>

<span class="token comment" spellcheck="true">/*获取size对应的smallbin index*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> smallbin_index(sz) \
  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
   + SMALLBIN_CORRECTION)  </span><span class="token comment" spellcheck="true">//如 size==0x100, (0x100 >> 4 + 0) == 0x10</span>
<span class="token comment" spellcheck="true">/*获取size对应的largebin index 32位下*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_32(sz)                                                \
  (((((unsigned long) (sz)) >> 6) &lt;= 38) ?  56 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)   </span><span class="token comment" spellcheck="true">//可以看出这里是进行范围归类</span>

<span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_32_big(sz)                                            \
  (((((unsigned long) (sz)) >> 6) &lt;= 45) ?  49 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> largebin_index_64(sz)                                                \
  (((((unsigned long) (sz)) >> 6) &lt;= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
   ((((unsigned long) (sz)) >> 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
   ((((unsigned long) (sz)) >> 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
   ((((unsigned long) (sz)) >> 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
   ((((unsigned long) (sz)) >> 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
   126)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> largebin_index(sz) \
  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
   : largebin_index_32 (sz))</span>

<span class="token comment" spellcheck="true">/*获取size对应的bins index，不是small bins 就是large bins*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> bin_index(sz) \
  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span></code></pre>
<h3 id="关于unsorted-bin在bins中的位置"><a href="#关于unsorted-bin在bins中的位置" class="headerlink" title="关于unsorted bin在bins中的位置"></a>关于unsorted bin在bins中的位置</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. 前面提到的无序bin即bin[1]就是这个unsortedbin*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1)) </span><span class="token comment" spellcheck="true">//M 即main_arena</span></code></pre>
<h2 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h2><p>该结构用于管理堆，记录每个 arena 当前申请的内存的具体状态，比如说是否有空闲 chunk，有什么大小的空闲 chunk 等等。无论是 thread arena 还是 main arena，它们都只有一个 malloc state 结构。由于 thread 的 arena 可能有多个，malloc state 结构会在最新申请的 arena 中。<br><strong>注意malloc_state在libc.so中作为一个全局变量，存在于libc.so的数据段</strong></p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*sourcecode980行包含头文件*/</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span> </span>
<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token keyword">struct</span> malloc_state<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>mstate<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//定义mastate指针，指向malloc_state结构体</span>
<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span><span class="token keyword">struct</span> malloc_state  
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* Serialize access. 该变量用于控制程序串行访问同一个分配区，当一个线程获取了分配区之后，其它线程要想访问该分配区，就必须等待该线程分配完成后才能够使用。 */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Flags (formerly in max_fast). flags 记录了分配区的一些标志 */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Set if the fastbin chunks contain recently inserted free blocks. 如果 fastbins包含free chunk 就被置1 */</span>
  <span class="token comment" spellcheck="true">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Fastbins 存放每个 fast chunk 链表头部的指针*/</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//64位下 size_t==8 可以算出NFASTBINS==9</span>
  <span class="token comment" spellcheck="true">/* Base of the topmost chunk -- not otherwise kept in a bin top chunk的地址*/</span>
  mchunkptr top<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* The remainder from the most recent split of a small request 最后一次响应一个小的chunk被切出，所剩的chunk*/</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Normal bins packed as described above */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//128*2-2==254</span>
  <span class="token comment" spellcheck="true">/* Bitmap of bins ptmalloc 用一个 bit 来标识某一个 bin 中是否包含空闲 chunk*/</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//128/(1&lt;&lt;5) == 4</span>
  <span class="token comment" spellcheck="true">/* Linked list */</span>
  <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token keyword">struct</span> malloc_state <span class="token operator">*</span>next_free<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Memory allocated from the system in this arena. 当前arena从系统中分配的内存 */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3 id="fastbins"><a href="#fastbins" class="headerlink" title="fastbins"></a>fastbins</h3><blockquote>
<p>大多数程序经常会申请以及释放一些比较小的内存块。如果将一些较小的 chunk 释放之后发现存在与之相邻的空闲的 chunk 并将它们进行合并，那么当下一次再次申请相应大小的 chunk 时，就需要对 chunk 进行分割，这样就大大降低了堆的利用效率。因为我们把大部分时间花在了合并、分割以及中间检查的过程中。因此，ptmalloc 中专门设计了 fast bin，对应的变量就是 malloc state 中的 fastbinsY—-ctf_wiki</p>
</blockquote>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> malloc_chunk <span class="token operator">*</span>mfastbinptr<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
    This is in malloc_state.
    /* Fastbins */</span>
    mfastbinptr fastbinsY<span class="token punctuation">[</span> NFASTBINS <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">/</span></code></pre>
<p>并且每个 <strong>bin 采取 LIFO 策略</strong>,ptmalloc 会首先判断 fastbin 中相应的 bin 中是否有对应大小的空闲块，如果有的话，就会直接从这个 bin 中获取 chunk这是在引入tcache之前的情况<br><strong>需要特别注意的是，fastbin 范围的 chunk 的 inuse 始终被置为 1。因此它们不会和其它被释放的 chunk 合并</strong>。但是当释放的 chunk 与该 chunk 相邻的空闲 chunk 合并后的大小大于 FASTBIN_CONSOLIDATION_THRESHOLD 时，内存碎片可能比较多了，我们就需要把 fast bins 中的 chunk 都进行合并，以减少内存碎片对系统的影响</p>
<h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><p>small bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size = 2 * SIZE_SZ <em>index，具体如下<br><img src="https://s1.ax1x.com/2020/10/13/0hO2Ps.png" alt=""><br>small bins 中一共有 62 个循环双向链表，每个链表中存储的 chunk 大小都一致。比如对于 32 位系统来说，下标 2 对应的双向链表中存储的 chunk 大小为均为 16 字节。每个链表都有链表头结点，这样可以方便对于链表内部结点的管理。此外，*</em>small bins 中每个 bin 对应的链表采用 FIFO 的规则，所以同一个链表中先被释放的 chunk 会先被分配出去。**</p>
<p>largebins<br>arge bins 中一共包括 63 个 bin，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内。此外，这 63 个 bin 被分成了 6 组，每组 bin 中的 chunk 大小之间的公差一致，具体如下：<br><img src="https://s1.ax1x.com/2020/10/13/0hOc5j.png" alt=""><br>这里我们以 32 位平台的 large bin 为例，第一个 large bin 的起始 chunk 大小为 512 字节，位于第一组，所以该 bin 可以存储的 chunk 的大小范围为 [512,512+64)。</p>
<h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><pre class=" language-c"><code class="language-c"><span class="token operator">*</span>
   Unsorted chunks
    All remainders from chunk <span class="token function">splits</span><span class="token punctuation">(</span>分割chunk后的剩余块<span class="token punctuation">)</span><span class="token punctuation">,</span> as well as all returned <span class="token function">chunks</span><span class="token punctuation">(</span>所有被free的 chunk<span class="token punctuation">)</span><span class="token punctuation">,</span>
    are first placed in the <span class="token string">"unsorted"</span> bin<span class="token punctuation">.</span> They are then placed
    in regular bins after malloc gives them ONE chance to be used before
    <span class="token function">binning</span><span class="token punctuation">(</span>之后他们都有机会进入属于他们的常规bins<span class="token punctuation">)</span><span class="token punctuation">.</span> So<span class="token punctuation">,</span> basically<span class="token punctuation">,</span> the unsorted_chunks list acts as a queue<span class="token punctuation">,</span>
    with chunks being placed on it in <span class="token function">free</span> <span class="token punctuation">(</span>and malloc_consolidate<span class="token punctuation">)</span><span class="token punctuation">,</span>
    and taken <span class="token function">off</span> <span class="token punctuation">(</span>to be either used or placed in bins<span class="token punctuation">)</span> in malloc<span class="token punctuation">.</span>
    The NON_MAIN_ARENA flag is never set <span class="token keyword">for</span> unsorted chunks<span class="token punctuation">,</span> so it
    does not have to be taken into account in size <span class="token function">comparisons</span><span class="token punctuation">(</span>不会考虑他们的大小顺序<span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token operator">*</span><span class="token operator">/</span></code></pre>
<p><strong>就是把unsorted bin作为其他bins的缓冲区</strong><br>注意bins和fastbins是区分开的</p>
<p>举一例子：</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*void* p1 = malloc(0x90);
    void* p2 = malloc(0x90);
    void* p3 = malloc(0x90);
    void* p4 = malloc(0x90);
    void* p5 = malloc(0x100);
    */</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>在执行第一个free后：</p>
<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> parseheap 
addr                prev                size                 status              fd                bk                
<span class="token number">0x602000</span>            <span class="token number">0x0</span>                 <span class="token number">0x90</span>                 Freed     <span class="token number">0x7ffff7dd1b78</span>    <span class="token number">0x7ffff7dd1b78</span>
<span class="token number">0x602090</span>            <span class="token number">0x90</span>                <span class="token number">0x90</span>                 Used                None              None
<span class="token number">0x602120</span>            <span class="token number">0x0</span>                 <span class="token number">0xa0</span>                 Used                None              None
pwndbg<span class="token operator">></span> bins
fastbins
<span class="token number">0x20</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x30</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x40</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x50</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x60</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x70</span><span class="token operator">:</span> <span class="token number">0x0</span>
<span class="token number">0x80</span><span class="token operator">:</span> <span class="token number">0x0</span>
unsortedbin
all<span class="token operator">:</span> <span class="token number">0x0</span>
smallbins
empty
largebins
empty
pwndbg<span class="token operator">></span> </code></pre>
<p>按照规则，p应该会被放到unsorted bin，但是在parseheap中却没看到，我们可以看一下main_arena:</p>
<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena
<span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000100000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00000000006021c0</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>top chunk
<span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000602000</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>unsorted bin
<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000602000</span>    <span class="token number">0x00007ffff7dd1b88</span>
<span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b88</span>    <span class="token number">0x00007ffff7dd1b98</span>
<span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b98</span>    <span class="token number">0x00007ffff7dd1ba8</span>
<span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1ba8</span>    <span class="token number">0x00007ffff7dd1bb8</span>
<span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bb8</span>    <span class="token number">0x00007ffff7dd1bc8</span>
<span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bc8</span>    <span class="token number">0x00007ffff7dd1bd8</span>
<span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bd8</span>    <span class="token number">0x00007ffff7dd1be8</span>
<span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1be8</span>    <span class="token number">0x00007ffff7dd1bf8</span>
<span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bf8</span>    <span class="token number">0x00007ffff7dd1c08</span></code></pre>
<p>可以看到p chunk已经被放到了unsorted bin的链表中，只是插件没显示出来，很常见</p>
<h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><p>unlink 用来将一个双向链表（只存储空闲的 chunk）中的一个元素取出来，可能在以下地方使用</p>
<ul>
<li>malloc<ul>
<li>从恰好大小合适的 large bin 中获取 chunk。<ul>
<li>这里需要注意的是 fastbin 与 small bin 就没有使用 unlink，这就是为什么漏洞会经常出现在它们这里的原因。</li>
<li>依次遍历处理 unsorted bin 时也没有使用 unlink 。</li>
</ul>
</li>
<li>从比请求的 chunk 所在的 bin 大的 bin 中取 chunk。</li>
</ul>
</li>
<li>free<ul>
<li>后向合并，合并物理相邻低地址空闲 chunk。    </li>
<li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
<li>malloc_consolidate<ul>
<li>后向合并，合并物理相邻低地址空闲 chunk。</li>
<li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
<li>realloc<ul>
<li>前向扩展，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
</ul>
<p>unlink在libc中直接被定义成了一个宏</p>
<pre class=" language-c"><code class="language-c">\<span class="token operator">/</span><span class="token operator">*</span> Take a chunk off a bin list<span class="token punctuation">.</span> Unlink操作 They are all free chunk<span class="token operator">*</span><span class="token operator">/</span>
<span class="token comment" spellcheck="true">/*
1：检查两个记录chunk p size的字段是否相等
2：检查fd，bk是否回指chunk p
3：进行unlink
4：如果size属于smallbins范围内则结束该函数
*/</span>
<span class="token comment" spellcheck="true">/* Take a chunk off a bin list av==arena P==目标 FD==下一个 BK==前一个*/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> unlink(AV, P, BK, FD) {                                            \
    </span><span class="token comment" spellcheck="true">/*由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      \
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               \
    <span class="token comment" spellcheck="true">/*获取寻找其他两个chunk*/</span>
    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>                                      \
    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>                                      \
    <span class="token comment" spellcheck="true">/*检查：要求fd->bk=p,以及bk->fd=p,两边指中间*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              \
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \
    <span class="token keyword">else</span> <span class="token punctuation">{</span>                                      \
        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>                                  \
        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>                                  \
        <span class="token comment" spellcheck="true">/*检查：如果size范围在smallbins中则完成unlink，否则对largebin进行操作*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>size<span class="token punctuation">)</span>                      \
            <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              \
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>          \
        <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    \
          <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span>                      \
                   <span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">,</span>    \
                   P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>                          \
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      \
                <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span>                      \
                  FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>              \
                <span class="token keyword">else</span> <span class="token punctuation">{</span>                                  \
                    FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>                  \
                    FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                  \
                    P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                  \
                    P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                  \
                  <span class="token punctuation">}</span>                                  \
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                  \
                P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>              \
                P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>              \
              <span class="token punctuation">}</span>                                      \
          <span class="token punctuation">}</span>                                      \
      <span class="token punctuation">}</span>                                         \
<span class="token punctuation">}</span></code></pre>
<p>以smallbins中的unlink为例：<br><img src="https://s1.ax1x.com/2020/10/13/0hORGn.png" alt=""></p>
<h2 id="malloc-init-state–malloc-state初始化"><a href="#malloc-init-state–malloc-state初始化" class="headerlink" title="malloc_init_state–malloc_state初始化"></a>malloc_init_state–malloc_state初始化</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">malloc_init_state</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>     i<span class="token punctuation">;</span>
    mbinptr bin<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Establish circular links for normal bins 从bins[1]开始为其初始化fd,bk指针*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NBINS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//每次初始化两个bins数组，这里只是都指向自己地址-0x10</span>
        bin     <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bin<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token operator">-></span>bk <span class="token operator">=</span> bin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">if</span> MORECORE_CONTIGUOUS</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token function">set_noncontiguous</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_max_fast</span><span class="token punctuation">(</span>DEFAULT_MXFAST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 设置 flags 标记目前没有fast chunk</span>
    av<span class="token operator">-></span>flags <span class="token operator">|</span><span class="token operator">=</span> FASTCHUNKS_BIT<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 就是 unsorted bin</span>
    av<span class="token operator">-></span>top <span class="token operator">=</span> <span class="token function">initial_top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>我们对第一次malloc来跟踪一下：</p>
<pre class=" language-c"><code class="language-c"> ► <span class="token number">0x7ffff7aae550</span> <span class="token operator">&lt;</span>malloc<span class="token operator">></span>                            push   rbp
   <span class="token number">0x7ffff7aae551</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">></span>                          push   rbx
   <span class="token number">0x7ffff7aae552</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">2</span><span class="token operator">></span>                          sub    rsp<span class="token punctuation">,</span> <span class="token number">8</span>
   <span class="token number">0x7ffff7aae556</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">6</span><span class="token operator">></span>                          mov    rax<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rip <span class="token operator">+</span> <span class="token number">0x322993</span><span class="token punctuation">]</span>
   <span class="token number">0x7ffff7aae55d</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">13</span><span class="token operator">></span>                         mov    rax<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>
   <span class="token number">0x7ffff7aae560</span> <span class="token operator">&lt;</span>malloc<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>                         test   rax<span class="token punctuation">,</span> rax
──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────
In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c
   <span class="token number">2898</span> 
   <span class="token number">2899</span> <span class="token comment" spellcheck="true">/*------------------------ Public wrappers. --------------------------------*/</span>
   <span class="token number">2900</span> 
   <span class="token number">2901</span> <span class="token keyword">void</span> <span class="token operator">*</span>
   <span class="token number">2902</span> <span class="token function">__libc_malloc</span> <span class="token punctuation">(</span>size_t bytes<span class="token punctuation">)</span>
 ► <span class="token number">2903</span> <span class="token punctuation">{</span>
   <span class="token number">2904</span>   mstate ar_ptr<span class="token punctuation">;</span>
   <span class="token number">2905</span>   <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>
   <span class="token number">2906</span> 
   <span class="token number">2907</span>   <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
   <span class="token number">2908</span>     <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这个时候main_arena应该都是0：</p>
<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena 
<span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
pwndbg<span class="token operator">></span> </code></pre>
<p>继续在将会执行malloc_consolidate：</p>
<pre class=" language-c"><code class="language-c">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────
In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c
   <span class="token number">3446</span> 
   <span class="token number">3447</span>   <span class="token keyword">else</span>
   <span class="token number">3448</span>     <span class="token punctuation">{</span>
   <span class="token number">3449</span>       idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">3450</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
 ► <span class="token number">3451</span>         <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">3452</span>     <span class="token punctuation">}</span>
   <span class="token number">3453</span> 
   <span class="token number">3454</span>   <span class="token operator">/</span><span class="token operator">*</span>
   <span class="token number">3455</span>      Process recently freed or remaindered chunks<span class="token punctuation">,</span> taking one only <span class="token keyword">if</span>
   <span class="token number">3456</span>      it is exact fit<span class="token punctuation">,</span> or<span class="token punctuation">,</span> <span class="token keyword">if</span> this a small request<span class="token punctuation">,</span> the chunk is remainder from</code></pre>
<p>最后会到：</p>
<pre class=" language-c"><code class="language-c">──────────────────────────────────────────────────────────────<span class="token punctuation">[</span> <span class="token function">SOURCE</span> <span class="token punctuation">(</span>CODE<span class="token punctuation">)</span> <span class="token punctuation">]</span>──────────────────────────────────────────────────────────────
In file<span class="token punctuation">:</span> <span class="token operator">/</span>glibc<span class="token operator">/</span>source<span class="token operator">/</span>glibc<span class="token number">-2.23</span><span class="token operator">/</span>malloc<span class="token operator">/</span>malloc<span class="token punctuation">.</span>c
   <span class="token number">4210</span> 
   <span class="token number">4211</span>       <span class="token punctuation">}</span>
   <span class="token number">4212</span>     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>fb<span class="token operator">++</span> <span class="token operator">!=</span> maxfb<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4213</span>   <span class="token punctuation">}</span>
   <span class="token number">4214</span>   <span class="token keyword">else</span> <span class="token punctuation">{</span>
 ► <span class="token number">4215</span>     <span class="token function">malloc_init_state</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4216</span>     <span class="token function">check_malloc_state</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4217</span>   <span class="token punctuation">}</span>
   <span class="token number">4218</span> <span class="token punctuation">}</span>
   <span class="token number">4219</span> 
   <span class="token number">4220</span> 
   pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena 
<span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token punctuation">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span></code></pre>
<p>执行完malloc_consolidate 后就会将bins初始化为指向自己地址-0x10，并且可以看到malloc_init_state中这样的定义：mbinptr bin;说明这里在对bins进行复制操作时把他们看作了chunk，利用其fd，和bk成员。所以其实这些bins就可以看作是一个chunk，不完整的chunk有效部分只有fd，和bk段作为双向链表的表头。当malloc_init_state执行完后：</p>
<pre class=" language-java"><code class="language-java">pwndbg<span class="token operator">></span> x<span class="token operator">/</span>32gx <span class="token operator">&amp;</span>main_arena 
<span class="token number">0x7ffff7dd1b20</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000001</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b30</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b50</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b60</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b70</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">80</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x0000000000000000</span>
<span class="token number">0x7ffff7dd1b80</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x0000000000000000</span>    <span class="token number">0x00007ffff7dd1b78</span>   <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>注意他们的值与自己地址的关系
<span class="token number">0x7ffff7dd1b90</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">112</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b78</span>    <span class="token number">0x00007ffff7dd1b88</span>
<span class="token number">0x7ffff7dd1ba0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">128</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b88</span>    <span class="token number">0x00007ffff7dd1b98</span>
<span class="token number">0x7ffff7dd1bb0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">144</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1b98</span>    <span class="token number">0x00007ffff7dd1ba8</span>
<span class="token number">0x7ffff7dd1bc0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">160</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1ba8</span>    <span class="token number">0x00007ffff7dd1bb8</span>
<span class="token number">0x7ffff7dd1bd0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bb8</span>    <span class="token number">0x00007ffff7dd1bc8</span>
<span class="token number">0x7ffff7dd1be0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bc8</span>    <span class="token number">0x00007ffff7dd1bd8</span>
<span class="token number">0x7ffff7dd1bf0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">208</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bd8</span>    <span class="token number">0x00007ffff7dd1be8</span>
<span class="token number">0x7ffff7dd1c00</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">224</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1be8</span>    <span class="token number">0x00007ffff7dd1bf8</span>
<span class="token number">0x7ffff7dd1c10</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">240</span><span class="token operator">></span><span class="token operator">:</span>    <span class="token number">0x00007ffff7dd1bf8</span>    <span class="token number">0x00007ffff7dd1c08</span>
pwndbg<span class="token operator">></span> </code></pre>
<h2 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h2><p>该函数主要有两个功能</p>
<ul>
<li><p>若 fastbin 未初始化，即 global_max_fast 为 0，那就初始化 malloc_state。</p>
</li>
<li><p>如果已经初始化的话，就合并 fastbin 中的 chunk。</p>
<pre class=" language-c"><code class="language-c">  <span class="token comment" spellcheck="true">/*
    If max_fast is 0, we know that av hasn't
    yet been initialized, in which case do so below
  */</span>
  <span class="token comment" spellcheck="true">// 说明 fastbin 已经初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 清空 fastbin 标记</span>
      <span class="token comment" spellcheck="true">// 因为要合并 fastbin 中的 chunk 了。</span>
      <span class="token function">clear_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//</span>
      unsorted_bin <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">/*
        Remove each chunk from fast bin and consolidate it, placing it
        then in unsorted bin. Among other reasons for doing this,
        placing in unsorted bin avoids needing to calculate actual bins
        until malloc is sure that chunks aren't immediately going to be
        reused anyway.
      */</span>
      <span class="token comment" spellcheck="true">// 按照 fd 顺序遍历 fastbin 的每一个 bin，将 bin 中的每一个 chunk 合并掉。</span>
      maxfb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> NFASTBINS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fb    <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">do</span> <span class="token punctuation">{</span>
          p <span class="token operator">=</span> <span class="token function">atomic_exchange_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">do</span> <span class="token punctuation">{</span>
                  <span class="token function">check_inuse_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  nextp <span class="token operator">=</span> p<span class="token operator">-></span>fd<span class="token punctuation">;</span>

                  <span class="token comment" spellcheck="true">/* Slightly streamlined version of consolidation code in
                   * free() */</span>
                  size      <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  nextsize  <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      prevsize <span class="token operator">=</span> <span class="token function">prev_size</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      size <span class="token operator">+</span><span class="token operator">=</span> prevsize<span class="token punctuation">;</span>
                      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token comment" spellcheck="true">// 判断 nextchunk 是否是空闲的。</span>
                      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>
                          <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span> <span class="token keyword">else</span>
                       <span class="token comment" spellcheck="true">// 设置 nextchunk 的 prev inuse 为0，以表明可以合并当前 fast chunk。</span>
                          <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                      first_unsorted     <span class="token operator">=</span> unsorted_bin<span class="token operator">-></span>fd<span class="token punctuation">;</span>
                      unsorted_bin<span class="token operator">-></span>fd   <span class="token operator">=</span> p<span class="token punctuation">;</span>
                      first_unsorted<span class="token operator">-></span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>

                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          p<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                          p<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>

                      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      p<span class="token operator">-></span>bk <span class="token operator">=</span> unsorted_bin<span class="token punctuation">;</span>
                      p<span class="token operator">-></span>fd <span class="token operator">=</span> first_unsorted<span class="token punctuation">;</span>
                      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">else</span> <span class="token punctuation">{</span>
                      size <span class="token operator">+</span><span class="token operator">=</span> nextsize<span class="token punctuation">;</span>
                      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      av<span class="token operator">-></span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

              <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> nextp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>fb<span class="token operator">++</span> <span class="token operator">!=</span> maxfb<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</li>
</ul>
<h2 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><blockquote>
<p>一般我们会使用 malloc 函数来申请内存块，可是当仔细看 glibc 的源码实现时，其实并没有 malloc 函数。其实该函数真正调用的是 <strong>libc_malloc 函数。为什么不直接写个 malloc 函数呢，因为有时候我们可能需要不同的名称。此外，</strong>libc_malloc 函数只是用来简单封装 _int_malloc 函数。_int_malloc 才是申请内存块的核心，注意：用户申请的字节一旦进入申请内存函数中就变成了无符号整数。</p>
</blockquote>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">__libc_malloc</span> <span class="token punctuation">(</span>size_t bytes<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//检查钩子函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//如果hook != Null则执行hook中的函数</span>

  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//寻找对应arena</span>

  victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//_int_malloc 函数去申请对应的内存</span>
  <span class="token comment" spellcheck="true">/* Retry with another arena only if we were able to find a usable arena
     before.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">&amp;&amp;</span> ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//如果分配失败的话，ptmalloc 会尝试再去寻找一个可用的 arena，并分配内存</span>
    <span class="token punctuation">{</span>
      <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_malloc_retry<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ar_ptr <span class="token operator">=</span> <span class="token function">arena_get_retry</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          ar_ptr <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> victim<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//返回内存</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__libc_malloc<span class="token punctuation">)</span></code></pre>
<h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><blockquote>
<p>_int_malloc 是内存分配的核心函数，其核心思路有如下<br>1：它根据用户申请的内存块大小以及相应大小 chunk 通常使用的频度（fastbin chunk, small chunk, large chunk），依次实现了不同的分配方法。<br>2：它由小到大依次检查不同的 bin 中是否有相应的空闲块可以满足用户请求的内存。<br>3：当所有的空闲 chunk 都无法满足时，它会考虑 top chunk。<br>4：当 top chunk 也无法满足时，堆分配器才会进行内存块申请。<br>在进入该函数后，函数立马定义了一系列自己需要的变量，并将用户申请的内存大小转换为内部的 chunk 大小。</p>
</blockquote>
<h3 id="初始数据"><a href="#初始数据" class="headerlink" title="初始数据"></a>初始数据</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_int_malloc</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> size_t bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//bytes是用户所申请的大小 </span>
    INTERNAL_SIZE_T nb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* normalized request size */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    idx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* associated bin index */</span>
    mbinptr         bin<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* associated bin */</span>

    mchunkptr       victim<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* inspected/selected chunk */</span>
    INTERNAL_SIZE_T size<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* its size */</span>
    <span class="token keyword">int</span>             victim_index<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* its bin index */</span>

    mchunkptr     remainder<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* remainder from a split */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* its size */</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> block<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* bit map traverser */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bit<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* bit map traverser */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> map<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* current word of binmap */</span>

    mchunkptr fwd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* misc temp for linking */</span>
    mchunkptr bck<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* misc temp for linking */</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
       Convert request size to internal form by adding SIZE_SZ bytes
       overhead plus possibly more to obtain necessary alignment and/or
       to obtain a size of at least MINSIZE, the smallest allocatable
       size. Also, checked_request2size traps (returning 0) request sizes
       that are so large that they wrap around zero when padded and
       aligned.
     */</span>

    <span class="token function">checked_request2size</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//将bytes规范对齐，并赋值给nb</span></code></pre>
<h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from mmap. 如果没有可用的arena那么将会调用sysmalloc来获得chunk */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span><span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h3 id="fastbins-1"><a href="#fastbins-1" class="headerlink" title="fastbins"></a>fastbins</h3><blockquote>
<p>如果申请的 chunk 的大小位于 fastbin 范围内，需要注意的是这里比较的是无符号整数。此外，是从 fastbin 的头结点开始取 chunk。</p>
</blockquote>
<pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*
       If the size qualifies as a fastbin, first check corresponding bin.
       This code is safe to execute even if av is not yet initialized, so we
       can try it without checking, which saves some time on this fast path.
     */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//由nb获取对应fastbins的index</span>
        idx             <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//可以看出这是exact fit</span>
        <span class="token comment" spellcheck="true">//fastbinsY中获取对应index的free chunk</span>
        mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mchunkptr    pp <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//fb中存放&amp;fastbinsY[index]，mchunkptr存放fastbinsY[index]的free chunk地址</span>
        <span class="token comment" spellcheck="true">// 利用fd遍历对应的bin内是否有空闲的chunk块，</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span>
                                                            victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 存在可以利用的chunk</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span>
            <span class="token comment" spellcheck="true">// 根据取得的 victim ，利用 chunksize 计算其大小。</span>
            <span class="token comment" spellcheck="true">// 利用fastbin_index 计算 chunk 的索引。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>
            errout<span class="token punctuation">:</span>
                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 细致的检查。。只有在 DEBUG 的时候有用</span>
            <span class="token function">check_remalloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将获取的到chunk转换为mem模式</span>
            <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
            <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//返回mem地址</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<h3 id="smallbins-1"><a href="#smallbins-1" class="headerlink" title="smallbins"></a>smallbins</h3><pre class=" language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/*
       If a small request, check regular bin.  Since these "smallbins"
       hold one size each, no searching within bins is necessary.
       (For a large request, we need to wait until unsorted chunks are
       processed to find best fit. But for small ones, fits are exact
       anyway, so we can check now, which is faster.)
     */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取 small bin 的索引</span>
        idx <span class="token operator">=</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取对应 small bin 中的 chunk 指针</span>
        bin <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//可以看出这是exact fit</span>
        <span class="token comment" spellcheck="true">// 先执行 victim = last(bin)，获取 small bin 的最后一个 chunk</span>
        <span class="token comment" spellcheck="true">// 如果 victim = bin ，那说明该 bin 为空。</span>
        <span class="token comment" spellcheck="true">// 如果不相等，那么会有两种情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//如果这里对应的bin没有插入freechunk 则last (bin) == bin</span>
            <span class="token comment" spellcheck="true">// 第一种情况，small bin 还没有初始化。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* initialization check */</span>
                <span class="token comment" spellcheck="true">// 执行初始化，将 fast bins 中的 chunk 进行合并，并给bins初始化</span>
                <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 第二种情况，small bin 中存在空闲的 chunk</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取 small bin 中倒数第二个 chunk 。</span>
                bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 检查 bck->fd 是不是 victim，防止伪造</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//如果victim->bk还指向这一个free chunk 那么该free chunk的fd是要回指victim的</span>
                    errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//设置物理相邻的下一个chunk的inuse位为1，因为本chunk已经是要被使用了</span>
                <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 修改 small bin 链表，将 small bin 的最后一个 chunk 取出来，FIFO</span>
                bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//恢复链表</span>
                bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果不是 main_arena，设置对应的标志</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 细致的检查，非调试状态没有作用</span>
                <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 将申请到的 chunk 转化为对应的 mem 状态</span>
                <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果设置了 perturb_type , 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
                <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<h3 id="放入largebins"><a href="#放入largebins" class="headerlink" title="放入largebins"></a>放入largebins</h3><blockquote>
<p>当 fast bin、small bin 中的 chunk 都不能满足用户请求 chunk 大小时，就会考虑是不是 large bin。但是，其实在 large bin 中并没有直接去扫描对应 bin 中的 chunk，而是先利用 malloc_consolidate（参见 malloc_state 相关函数） 函数处理 fast bin 中的 chunk，将有可能能够合并的 chunk 先进行合并后放到 unsorted bin 中，不能够合并的就直接放到 unsorted bin 中，然后再在下面的大循环中进行相应的处理。为什么不直接从相应的 bin 中取出 large chunk 呢？这是 ptmalloc 的机制，它会在分配 large chunk 之前对堆中碎片 chunk 进行合并，以便减少堆中的碎片。</p>
</blockquote>
<pre class=" language-c"><code class="language-c">_int_malloc<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取large bin的下标。</span>
        idx <span class="token operator">=</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果存在fastbin的话，会处理 fastbin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h4 id="遍历-unsorted-bin"><a href="#遍历-unsorted-bin" class="headerlink" title="遍历 unsorted bin"></a>遍历 unsorted bin</h4><p>如果在之前的遍历中(smallbins fastbins)无法满足best fit则遍历 unsorted bin<br>在接下来的这个循环中，主要做了以下的操作</p>
<ul>
<li>按照 FIFO 的方式逐个将 unsorted bin 中的 chunk 取出来<ul>
<li>如果是 small request，则考虑是不是恰好满足，是的话，直接返回。</li>
<li>如果不是的话，放到对应的 bin 中。</li>
</ul>
</li>
<li>尝试从 large bin 中分配用户所需的内存</li>
</ul>
<p>先考虑 unsorted bin，再考虑 last remainder 但是对于 small bin chunk 的请求会有所例外 （SMALL REQUEST）：</p>
<pre class=" language-c"><code class="language-c">        <span class="token comment" spellcheck="true">// 如果 unsorted bin 不为空</span>
        <span class="token comment" spellcheck="true">// First In First Out</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// victim 为 unsorted bin 的最后一个 chunk</span>
            <span class="token comment" spellcheck="true">// bck 为 unsorted bin 的倒数第二个 chunk</span>
            bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 判断得到的 chunk 是否满足要求，不能过小，也不能过大</span>
            <span class="token comment" spellcheck="true">// 一般 system_mem 的大小为132K</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>
                                <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 得到victim对应的chunk大小。</span>
            size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>如果用户的请求为 small bin chunk，那么我们首先考虑 last remainder，如果 last remainder 是 unsorted bin 中的唯一一块的话， 并且 last remainder 的大小分割后还可以作为一个 chunk </p>
<pre class=" language-c"><code class="language-c">            <span class="token comment" spellcheck="true">/*
               If a small request, try to use last remainder if it is the
               only chunk in unsorted bin.  This helps promote locality for
               runs of consecutive small requests. This is the only
               exception to best-fit, and applies only when there is
               no exact fit for a small chunk.
             */</span>
              <span class="token comment" spellcheck="true">/*1处于smallbinsfanwei 2存在last_remainder   3 size大于nb + MINSIZE，保证可以进行切割   */</span>     
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/* split and reattach remainder */</span>
                <span class="token comment" spellcheck="true">// 获取新的 remainder 的大小</span>
                remainder_size          <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取新的 remainder 的位置</span>
                remainder               <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新 unsorted bin 的情况</span>
                <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新 av 中记录的 last_remainder</span>
                av<span class="token operator">-></span>last_remainder                                <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新last remainder的指针</span>
                remainder<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 设置victim的头部，</span>
                <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                                     <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 设置 remainder 的头部</span>
                <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 设置记录 remainder 大小的 prev_size 字段，因为此时 remainder 处于空闲状态。</span>
                <span class="token function">set_foot</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 细致的检查，非调试状态下没有作用</span>
                <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 将 victim 从 chunk 模式转化为mem模式</span>
                <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
                <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p>这部分代码的整体意思就是遍历<code>unsortedbin</code>，从中查找是否有符合用户要求大小的chunk并返回。<br>第一个<code>while</code>循环从尾到头依次取出<code>unsortedbin</code>中的所有<code>chunk</code>，将该chunk对应的前一个chunk保存在<code>bck</code>中，并将大小保存在<code>size</code>中。<br>如果用户需要分配的内存大小对应的chunk属于<code>smallbin</code>，<code>unsortedbin</code>中只有这一个chunk，并且该chunk属于<code>last remainder chunk</code>且其大小大于用户需要分配内存大小对应的chunk大小加上最小的chunk大小（保证可以拆开成两个chunk），就将该chunk拆开成两个chunk，分别为<code>victim</code>和<code>remainder</code>，进行相应的设置后，将用户需要的<code>victim</code>返回。<br>如果不能拆开，就从<code>unsortedbin</code>中取出该<code>chunk（victim）</code>。<br>再下来，如果刚刚从unsortedbin中取出的<code>victim</code>正好是用户需要的大小<code>nb</code>，就设置相应的标志位，直接返回该<code>victim</code><br>取出：</p>
<pre class=" language-c"><code class="language-c">            <span class="token comment" spellcheck="true">/* remove from unsorted list 最后的chunk解除链接 */</span>
            <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
            bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>如果从 unsorted bin 中取出来的 chunk 大小正好合适，就直接使用。</p>
<pre class=" language-c"><code class="language-c"> <span class="token comment" spellcheck="true">/* Take now instead of binning if exact fit */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//设置物理相邻的下一个chunk的inuse位为1</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p><strong>如果不适合那就看其大小，来放到smallbins或者largebins中</strong><br>smallbins:</p>
<pre><code>            /* place chunk in bin */

            if (in_smallbin_range(size)) {
                victim_index = smallbin_index(size);  //获取下标
                bck          = bin_at(av, victim_index);  //获取表头
                fwd          = bck-&gt;fd;  //获取第一个chunk
            ......
            ....
            ...
            /*
          mark_bin (av, victim_index);   //标记
          victim-&gt;bk = bck;   //vim的前一个chunk指针，指向表头
          victim-&gt;fd = fwd;   //vim的下一个chunk指针，指向原来的第一个chunk   （FIFO，chunk是从队列的尾部提取的）
          fwd-&gt;bk = victim;   //bk指针恢复
          bck-&gt;fd = victim;   //fd指针恢复</code></pre><h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><h4 id="如果largebins中没有chunk"><a href="#如果largebins中没有chunk" class="headerlink" title="如果largebins中没有chunk"></a>如果largebins中没有chunk</h4><pre class=" language-c"><code class="language-c">              victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//下标</span>
              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取第一个chunk</span>

              <span class="token comment" spellcheck="true">/* maintain large bins in sorted order */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//检查是否空闲</span>
                <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">/* Or with inuse bit to speed comparisons */</span>
                  size <span class="token operator">|</span><span class="token operator">=</span> PREV_INUSE<span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/* if smaller than smallest, bypass loop below */</span>
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//是否属于main_arena</span>
                  <span class="token punctuation">}</span>  
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token keyword">else</span>
                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//如果largebins没有chunk，则fd_nextsize和bk_nextsize都指向自己</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          <span class="token comment" spellcheck="true">/*插入对应largebins，并作为第一个*/</span>
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span></code></pre>
<h4 id="如果有chunk，且victim是最小的"><a href="#如果有chunk，且victim是最小的" class="headerlink" title="如果有chunk，且victim是最小的"></a>如果有chunk，且victim是最小的</h4><pre class=" language-c"><code class="language-c">              <span class="token comment" spellcheck="true">/* maintain large bins in sorted order */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//存在chunk</span>
                <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">/* Or with inuse bit to speed comparisons */</span>
                  size <span class="token operator">|</span><span class="token operator">=</span> PREV_INUSE<span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/* if smaller than smallest, bypass loop below */</span>
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//属于main_arena</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//bck->bk bin中最后一个chunk也是largbin中最小的chunk</span>
                    <span class="token punctuation">{</span>
                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//表头</span>
                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//指向最min_chunk</span>

                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//victim->fd_nextsize指向bin中第一个chunk</span>
                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//victim->bk_nextsize指向原min_chunk</span>
                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//原max_chunk的bk_nextsize 指向victim</span>
                    <span class="token punctuation">}</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment" spellcheck="true">/*插入最后的位置，恢复链接*/</span>   
          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//victim->bk指向原min</span>
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//fd指向表头</span>
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>                                  </code></pre>
<h4 id="有chunk，但victim不是最小的"><a href="#有chunk，但victim不是最小的" class="headerlink" title="有chunk，但victim不是最小的"></a>有chunk，但victim不是最小的</h4><pre class=" language-c"><code class="language-c">                    <span class="token punctuation">{</span>
                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment" spellcheck="true">/*循环寻找size的合使位置*/</span>
                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//更新下一个fwd</span>
                          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//属于main_arena</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">/*如果能有幸找到完全一样的size，直接插入该chunk后*/</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">/* Always insert in the second position.  */</span>
                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/*没一样的size就建立nextsize链接*/</span>
                      <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">/*其实是一个宏观的双向链表插入操作*/</span>
                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//前一个chunk</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token comment" spellcheck="true">/*双向链表插入操作  */</span>    
          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>                   </code></pre>
<p>这个从unsortedbin中提取chunk的操作会最多循环1000次</p>
<h2 id="再次进行chunk提取"><a href="#再次进行chunk提取" class="headerlink" title="再次进行chunk提取"></a>再次进行chunk提取</h2><h3 id="先尝试largebin提取"><a href="#先尝试largebin提取" class="headerlink" title="先尝试largebin提取"></a>先尝试largebin提取</h3><pre class=" language-c"><code class="language-c">      <span class="token comment" spellcheck="true">/*在largebins中提取*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取表头</span>

          <span class="token comment" spellcheck="true">/* skip scan if empty or largest chunk is too small */</span>
          <span class="token comment" spellcheck="true">/*bin有chunk，并且有足够大chunk*/</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span>
              <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//first(bin)->size是最大的</span>
              victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//反向遍历，从最小开始</span>
              <span class="token comment" spellcheck="true">/*遍历寻找第一个足够大的chunk*/</span>
              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>
                      <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//指针更新</span>

              <span class="token comment" spellcheck="true">/* Avoid removing the first entry for a size so that the skip
                 list does not have to be rerouted.  */</span>
                 <span class="token comment" spellcheck="true">/*1取到的chunk不是bin中的最后一个chunk 2该chunk与下一个chunk大小相等*/</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> victim<span class="token operator">-></span>size <span class="token operator">==</span> victim<span class="token operator">-></span>fd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                victim <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//取该nextsize的下一个chunk，因为第一个chunk存放了nextsize，取出比较麻烦</span>

              remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//计算切割后的size，即lastremainder</span>
              <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//unlink操作</span>

              <span class="token comment" spellcheck="true">/* Exhaust */</span>
              <span class="token comment" spellcheck="true">/*如果remainder不能单独成chunk*/</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                  <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//置1物理相邻下一个chunk的inuse位物理相邻下一个chunk的inuse位</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                    victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                  remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//截取剩下的部分，视为remainder</span>
                  <span class="token comment" spellcheck="true">/* We cannot assume the unsorted list is empty and therefore
                     have to perform a complete insert here.  */</span>
                  bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取unsortedbin表头</span>
                  fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//第一个chunk</span>
                   <span class="token comment" spellcheck="true">/*判断unsortedbin是否被破坏*/</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                    <span class="token punctuation">{</span>
                      errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>
                      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*双向链表插入unsortedbin*/</span>
                  remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
                  remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                  bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                  fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/*如果不处于smallbins范围*/</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                      remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                      remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*设置victim的size字段*/</span>
                  <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                            <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/*设置remainder的size字段*/</span>
                  <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/*设置remainder物理相邻的下一个chunk的prev_size为remainder_size*/</span>
                  <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//指针转换</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//用户地址返回</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<h3 id="如果还没找到"><a href="#如果还没找到" class="headerlink" title="如果还没找到"></a>如果还没找到</h3><pre class=" language-c"><code class="language-c">      <span class="token operator">++</span>idx<span class="token punctuation">;</span>
      bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      block <span class="token operator">=</span> <span class="token function">idx2block</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>
      bit <span class="token operator">=</span> <span class="token function">idx2bit</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">/* Skip rest of block if there are no more set bits in this block.  */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>bit <span class="token operator">></span> map <span class="token operator">||</span> bit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              <span class="token keyword">do</span>
                <span class="token punctuation">{</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>block <span class="token operator">>=</span> BINMAPSIZE<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* out of bins */</span>
                    <span class="token keyword">goto</span> use_top<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">/* Advance to bin with set bit. There must be one. */</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> map<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
              <span class="token function">assert</span> <span class="token punctuation">(</span>bit <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">/* Inspect the bin. It is likely to be non-empty */</span>
          victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment" spellcheck="true">/*  If a false alarm (empty bin), clear the bit. */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> bin<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span> <span class="token operator">=</span> map <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>bit<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Write through */</span>
              bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
              size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment" spellcheck="true">/*  We know the first chunk in this bin is big enough to use. */</span>
              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>

              <span class="token comment" spellcheck="true">/* unlink */</span>
              <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment" spellcheck="true">/* Exhaust */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                  <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                    victim<span class="token operator">-></span>size <span class="token operator">|</span><span class="token operator">=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

              <span class="token comment" spellcheck="true">/* Split */</span>
              <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                  remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>

                  <span class="token comment" spellcheck="true">/* We cannot assume the unsorted list is empty and therefore
                     have to perform a complete insert here.  */</span>
                  bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                      errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks 2"</span><span class="token punctuation">;</span>
                      <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                  remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
                  remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                  bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                  fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>

                  <span class="token comment" spellcheck="true">/* advertise as last remainder */</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                      remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                      remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                  <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                            <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<blockquote>
<p>这一部分的整体意思是，前面在<code>largebin</code>中寻找特定大小的空闲<code>chunk</code>，如果没找到，这里就要遍历<code>largebin</code>中的其他更大的<code>chunk</code>双向链表，继续寻找。<br>开头的<code>++idx</code>就表示，这里要从<code>largebin</code>中下一个更大的<code>chunk</code>双向链表开始遍历。<code>ptmalloc</code>中用一个<code>bit</code>表示<code>malloc_state</code>的<code>bins</code>数组中对应的位置上是否有空闲<code>chunk</code>，<code>bit</code>为1表示有，为0则没有。<code>ptmalloc</code>通过4个<code>block</code>（一个<code>block</code> 4字节）一共<code>128</code>个<code>bit</code>管理<code>bins</code>数组。因此，代码中计算的<code>block</code>表示对应的<code>idx</code>属于哪一个<code>block</code>，<code>map</code>就表是<code>block</code>对应的<code>bit</code>组成的二进制数字。<br>接下来进入<code>for</code>循环，如果<code>bit &gt; map</code>，表示该<code>map</code>对应的整个<code>block</code>里都没有大于<code>bit</code>位置的空闲的<code>chunk</code>，因此就要找下一个<code>block</code>。因为后面的<code>block</code>只要不等于0，就肯定有空闲<code>chunk</code>，并且其大小大于bit位置对应的chunk，下面就根据<code>block</code>，取出<code>block</code>对应的第一个双向链表的头指针。这里也可以看出，设置map和block也是为了加快查找的速度。如果遍历完所有<code>block</code>都没有空闲<code>chunk</code>，这时只能从<code>top chunk</code>里分配chunk了，因此跳转到<code>use_top</code>。<br>如果有空闲<code>chunk</code>，接下来就通过一个while循环依次比较找出到底在哪个双向链表里存在空闲<code>chunk</code>，最后获得空闲chunk所在的双向链表的头指针bin和位置bit。<br>接下来，如果找到的双向链表又为空，则继续前面的遍历，找到空闲<code>chunk</code>所在的双向链表的头指针<code>bin</code>和位置<code>bit</code>。如果找到的双向链表不为空，就和上面一部分再largebin中找到空闲chunk的操作一样了</p>
</blockquote>
<h3 id="Top"><a href="#Top" class="headerlink" title="Top"></a>Top</h3><pre class=" language-c"><code class="language-c">    use_top<span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true">/*
         If large enough, split off the chunk bordering the end of memory
         (held in av->top). Note that this is in accord with the best-fit
         search rule.  In effect, av->top is treated as larger (and thus
         less well fitting) than any other available chunk since it can
         be extended to be as large as necessary (up to system
         limitations).

         We require that av->top always exists (i.e., has size >=
         MINSIZE) after initialization, so if it would otherwise be
         exhausted by current request, it is replenished. (The main
         reason for ensuring it exists is that we may need MINSIZE space
         to put in fenceposts in sysmalloc.)
       */</span>

      victim <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取top</span>
      size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//获取top size</span>
        <span class="token comment" spellcheck="true">/*1top_size够大  2切割后的remainder能成chunk  那么直接切割*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>  
          remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          av<span class="token operator">-></span>top <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">/*设置标记字段*/</span>
          <span class="token comment" spellcheck="true">// 这里设置 PREV_INUSE 是因为 top chunk 前面的 chunk 如果不是 fastbin，就必然会和</span>
          <span class="token comment" spellcheck="true">// top chunk 合并，所以这里设置了 PREV_INUSE。</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                    <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">/* When we are using atomic ops to free fast chunks we can get
         here for all block sizes.  */</span>
      <span class="token comment" spellcheck="true">/*如果上述条件不满足 判断是否有fast chunk*/</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*用于fastbins chunk 合并*/</span>
          <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">/* restore original bin index */</span>
          <span class="token comment" spellcheck="true">/*计算索引*/</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            idx <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">/*
         Otherwise, relay to handle system-dependent cases
       */</span>
       <span class="token comment" spellcheck="true">/*最后的方法就是系统调用sysmalloc了*/</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span> <span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一步：如果进程没有关联的分配区，就通过sysmalloc从操作系统分配内存。<br>第二步：从fastbin查找对应大小的chunk并返回，如果失败进入第三步。<br>第三步：从smallbin查找对应大小的chunk并返回，或者将fastbin中的空闲chunk合并放入unsortedbin中，如果失败进入第四步。<br>第四步：遍历unsortedbin，从unsortedbin中查找对应大小的chunk并返回，根据大小将unsortedbin中的空闲chunk插入smallbin或者largebin中。进入第五步。<br>第五步：从largebin指定位置查找对应大小的chunk并返回，如果失败进入第六步。<br>第六步：从largebin中大于指定位置的双向链表中查找对应大小的chunk并返回，如果失败进入第七步。<br>第七步：从topchunk中分配对应大小的chunk并返回，topchunk中没有足够的空间，就查找fastbin中是否有空闲chunk，如果有，就合并fastbin中的chunk并加入到unsortedbin中，然后跳回第四步。如果fastbin中没有空闲chunk，就通过sysmalloc从操作系统分配内存。</p>
<blockquote>
<p>参考：<a href="https://elixir.bootlin.com/glibc/glibc-2.23.90/source/malloc/malloc.c" target="_blank" rel="noopener">https://elixir.bootlin.com/glibc/glibc-2.23.90/source/malloc/malloc.c</a><br><a href="https://blog.csdn.net/conansonic/article/details/50241523" target="_blank" rel="noopener">https://blog.csdn.net/conansonic/article/details/50241523</a><br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/implementation/malloc-zh/</a></p>
</blockquote>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/1.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/2.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://squarepants0.github.io" class="b-link-green">Squarer</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2020/10/13/malloc-guan-jian-yuan-ma-fen-xi/" class="b-link-green">malloc关键源码分析</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'aa0bf75cc88de6c0258a',
        clientSecret: '8ddc9bf71af314ac63d189a5ecb132fac7c0687d',
        repo: 'Gitalks.github.io',
        owner: 'squarepants0',
        admin: "squarepants0",
        id: '2020-10-13T21-01-08',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/10/15/free-han-shu-guan-jian-yuan-ma-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="free函数关键源码分析">
                        
                        <span class="card-title">free函数关键源码分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">因为free源代码和malloc源码都是在malloc.c定义的，所以用到的宏几乎差不多这里就不列出来了，详情见上一篇文章：malloc关键源码分析
__libc_free同malloc一样我们使用的free函数也是封装过的
void
__</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-10-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/09/30/ciscn-2019-es-7-srop/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="ciscn_2019_es_7--SROP">
                        
                        <span class="card-title">ciscn_2019_es_7--SROP</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">checksecmatrix@ubuntu:~/PWN/BUU$ checksec ciscn_2019_es_7
[*] '/home/matrix/PWN/BUU/ciscn_2019_es_7'
    Arch:     amd64</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-09-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF-PWN/" class="post-category" target="_blank">
                                    CTF-PWN
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/" target="_blank">
                        <span class="chip bg-color">原理学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('10')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Squarer<br />'
            + '作者: Squarer<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者Matrix所有，任何形式的转载都请注明出处：https://squarepants0.github.io/。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">136.6k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:2337463603@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2334763603" target="_blank" rel="noopener" class="tooltipped" data-tooltip="QQ联系我: 2334763603" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/fireworks.js"></script>

</body>
</html>